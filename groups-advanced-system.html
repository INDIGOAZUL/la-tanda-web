<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grupos & Tandas | La Tanda</title>
    <meta name="description" content="Administra tus grupos de ahorro, invita miembros y gestiona contribuciones.">
    <meta name="theme-color" content="#0f172a">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha384-iw3OoTErCYJJB9mCa8LNS2hbsQ7M3C0EpIsO/H5+EGAkPGc6rk+V8i04oW/K5xq0" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&family=Exo+2:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/header.css?v=24.5">
    <link rel="stylesheet" href="css/onboarding.css?v=1.0">
    <link rel="stylesheet" href="css/dashboard-layout.css?v=7800">
    <link rel="stylesheet" href="css/mobile-drawer.css?v=1769558147">
    <link rel="stylesheet" href="css/edge-swipe.css?v=1769558147">
    <link rel="stylesheet" href="css/dashboard-polish.css?v=1.0">
    <link rel="stylesheet" href="css/hub/contextual-widgets.css?v=1770560001">
    <link rel="stylesheet" href="css/hub/user-mini-profile.css?v=2.0">
    <link rel="stylesheet" href="css/components/notification-center.css">
    <link rel="stylesheet" href="css/components/wallet-dropdown.css">
    <link rel="stylesheet" href="css/mobile-touch-fixes.css">
    <link rel="stylesheet" href="css/mobile-notification-fix.css">
    <link rel="stylesheet" href="css/mobile-network-switcher-fix.css">
    <link rel="stylesheet" href="css/mobile-wallet-connect-fix.css">
    <link rel="stylesheet" href="css/transaction-modal.css">
    <link rel="stylesheet" href="css/groups-page.css?v=2.5">
    <link rel="stylesheet" href="shared-components.css">
    <link rel="stylesheet" href="notification-system.css">
    <link rel="stylesheet" href="loading-styles.css">
    <link rel="stylesheet" href="group-duplication.css">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://latanda.online/groups-advanced-system.html">
    <meta property="og:title" content="Grupos | La Tanda">
    <meta property="og:description" content="Administra tus grupos de ahorro, invita miembros y gestiona contribuciones.">
    <meta property="og:image" content="https://latanda.online/assets/og-image.png">
    <meta property="og:site_name" content="La Tanda">
    <meta property="og:locale" content="es_HN">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Grupos | La Tanda">
    <meta name="twitter:description" content="Administra tus grupos de ahorro, invita miembros y gestiona contribuciones.">
    <meta name="twitter:image" content="https://latanda.online/assets/og-image.png">
    <script src="registerSW.js" defer></script>
</head>
<body data-sidebar="true">
    <!-- Global Header Component -->
    <div id="global-header"></div>
    <div class="bg-effects">
        <div class="gradient-orb gradient-orb-1"></div>
        <div class="gradient-orb gradient-orb-2"></div>
        <div class="gradient-orb gradient-orb-3"></div>
    </div>

    <!-- 3-COLUMN HUB LAYOUT -->
    <div class="dashboard-3col">

        <!-- LEFT SIDEBAR -->
        <aside class="left-sidebar" id="leftSidebar">
            <nav class="nav-menu">
                <a href="/home-dashboard.html" class="nav-menu-item"><i class="fas fa-home"></i><span>Inicio</span></a>
                <a href="/explorar.html" class="nav-menu-item"><i class="fas fa-hashtag"></i><span>Explorar</span></a>
                <a href="/trabajo.html" class="nav-menu-item"><i class="fas fa-briefcase"></i><span>Trabajo</span></a>
                <a href="/creator-hub.html" class="nav-menu-item"><i class="fas fa-palette"></i><span>Creator Hub</span></a>
                <a href="/guardados.html" class="nav-menu-item"><i class="fas fa-bookmark"></i><span>Guardados</span></a>
                <a href="/mensajes.html" class="nav-menu-item"><i class="fas fa-envelope"></i><span>Mensajes</span></a>
                <a href="/mineria.html" class="nav-menu-item"><i class="fas fa-hammer"></i><span>Mineria</span></a>
                <a href="mi-perfil.html" class="nav-menu-item"><i class="fas fa-bars"></i><span>Menu</span></a>
            </nav>
            <div class="nav-section-divider"></div>
            <div class="nav-section-label">Accesos Rapidos</div>
            <nav class="nav-menu">
                <a href="my-wallet.html" class="nav-menu-item"><i class="fas fa-wallet"></i><span>Mi Wallet</span></a>
                <a href="/groups-advanced-system.html" class="nav-menu-item active"><i class="fas fa-users"></i><span>Mis Tandas</span></a>
                <a href="/marketplace-social.html" class="nav-menu-item"><i class="fas fa-store"></i><span>Marketplace</span></a>
                <a href="/lottery-predictor.html" class="nav-menu-item"><i class="fas fa-ticket-alt"></i><span>Loteria</span></a>
            </nav>
        </aside>

        <!-- MAIN FEED -->
        <main class="main-feed" id="mainFeed">
            <div class="main-feed-header">
                <h1 class="main-feed-title" style="font-size:1.5rem;font-weight:700;">
                    <i class="fas fa-users" style="color:#00FFFF;margin-right:10px;"></i>Grupos &amp; Tandas
                </h1>
            </div>

            <!-- Navigation Tabs -->
            <nav class="groups-page-tabs" role="tablist">
                <button class="groups-tab active" data-action="switch-groups-tab" data-tab="groups" role="tab" aria-selected="true">
                    <i class="fas fa-users"></i> Mis Grupos
                </button>
                <button class="groups-tab" data-action="switch-groups-tab" data-tab="tandas" role="tab" aria-selected="false">
                    <i class="fas fa-coins"></i> Mis Tandas
                </button>
                <button class="groups-tab" data-action="switch-groups-tab" data-tab="create" role="tab" aria-selected="false">
                    <i class="fas fa-plus-circle"></i> Crear Grupo
                </button>
            </nav>

            <!-- ===== MIS GRUPOS ===== -->
            <section id="groups" class="content-section active">

        <!-- Filter Bar (compact) -->
        <div class="filter-bar">
            <select id="filterRole">
                <option value="all">Rol: Todos</option>
                <option value="creator">Creador</option>
                <option value="coordinator">Coordinador</option>
                <option value="member">Miembro</option>
            </select>
            <select id="filterPayment">
                <option value="all">Pago: Todos</option>
                <option value="up_to_date">Al dia</option>
                <option value="pending">Pendiente</option>
                <option value="late">Atrasado</option>
            </select>
            <input type="text" id="searchGroups" placeholder="Buscar grupo...">
        </div>

        <!-- Groups Grid -->
        <div id="groupsContainer">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Cargando tus grupos...</p>
            </div>

            <script>

    // XSS prevention helper (v3.99.0)
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = String(text != null ? text : '');
        return div.innerHTML.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }
// ===== CONFIGURATION =====
        const API_BASE = 'https://latanda.online';
        // ===== GLOBAL AUTH HELPER =====
        // Auth headers - Local definition for immediate use (shared-components.js overrides when loaded)
        window.getAuthHeaders = function() {
            const token = localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token') || '';
            return token ? { 'Authorization': 'Bearer ' + token } : {};
        }


        function getCurrentUserId() {
            try {
                // 1. Variables globales (si existen)
                if (typeof currentUser !== "undefined" && currentUser && currentUser.id) {
                    return String(currentUser.id);
                }
                if (typeof userData !== "undefined" && userData && userData.id) {
                    return String(userData.id);
                }

                // 2. latanda_user (fuente principal)
                const latandaUser = localStorage.getItem("latanda_user") ||
                                   sessionStorage.getItem("latanda_user");
                if (latandaUser) {
                    const parsed = JSON.parse(latandaUser);
                    if (parsed.id) return String(parsed.id);
                    if (parsed.user_id) return String(parsed.user_id);
                }

                // 3. Fallbacks de compatibilidad
                const fallbackId = localStorage.getItem("latanda_user_id") ||
                                  sessionStorage.getItem("latanda_user_id") ||
                                  localStorage.getItem("userId") ||
                                  localStorage.getItem("user_id");
                if (fallbackId) return String(fallbackId);

                // 4. No autenticado
                return null;

            } catch (error) {
                return null;
            }
        }


        const USER_ID = getCurrentUserId();

        // ===== STATE =====
        let allGroups = [];
        let filteredGroups = [];

        // ===== ROLE & STATUS LABELS =====
        const roleLabels = {
            creator: 'Creador',
            coordinator: 'Coordinador',
            member: 'Miembro'
        };

        const paymentStatusLabels = {
            up_to_date: 'Al día',
            pending: 'Pendiente',
            late: 'Atrasado',
            suspension_recommended: 'Muy atrasado',
            suspended: 'Suspendido — Paga para reactivar'
        };

        const alertIcons = {
            success: '✓',
            warning: '⚠',
            danger: '✕',
            info: 'ℹ'
        };

        // ===== POSTGRESQL DATA ADAPTER =====
        // Adapts PostgreSQL data structure to expected frontend format
        function adaptPostgreSQLGroup(pgGroup) {
            return {
                // IDs - handle both naming conventions
                id: pgGroup.group_id || pgGroup.id,
                group_id: pgGroup.group_id || pgGroup.id,
                
                // Basic data (exists in PostgreSQL)
                name: pgGroup.name || 'Sin nombre',
                description: pgGroup.description || '',
                category: pgGroup.category || 'general',
                location: pgGroup.location || '',
                contribution_amount: parseFloat(pgGroup.contribution_amount || 0),
                frequency: pgGroup.frequency || 'monthly',
                max_members: pgGroup.max_members || 0,
                status: pgGroup.status || 'active',
                start_date: pgGroup.start_date,
                lottery_scheduled_at: pgGroup.lottery_scheduled_at,
                lottery_executed_at: pgGroup.lottery_executed_at,
                lottery_executed: pgGroup.lottery_executed,
                created_at: pgGroup.created_at,
                total_amount_collected: parseFloat(pgGroup.total_amount_collected || 0),
                admin_id: pgGroup.admin_id,
                
                // Field with different name
                members_count: pgGroup.member_count || 0,
                total_positions: pgGroup.total_positions || pgGroup.member_count || 0,
                commission_rate: pgGroup.commission_rate !== undefined ? pgGroup.commission_rate : null,
                
                // Default values for missing fields (to prevent errors)
                my_role: pgGroup.my_role || 'creator',  // Assume creator for now (user is admin_id)
                my_payment_status: pgGroup.my_payment_status || 'up_to_date',  // Default status
                my_days_late: pgGroup.my_days_late || 0,
                my_next_payment_due: pgGroup.my_next_payment_due,
                my_total_paid: parseFloat(pgGroup.my_total_paid || 0),
                my_turn_number: pgGroup.my_turn_number,
                turns_until_mine: pgGroup.turns_until_mine,
                my_alerts: pgGroup.my_alerts || [],  // Empty array to prevent .length error
                has_active_tanda: pgGroup.has_active_tanda || false,
                current_cycle: parseInt(pgGroup.current_cycle) || 0,
                current_turn_number: null,
                current_turn_recipient: null,
                tanda_status: pgGroup.tanda_status || null,
                tanda_id: pgGroup.tanda_id || null
            };
        }

        // ===== FETCH GROUPS =====
        async function fetchMyGroups() {
            try {
                // Read token directly — do NOT require latanda_user (it may not exist)
                const authToken = localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token') || '';

                // Guard: skip API call if not authenticated (prevents 401 cascade)
                if (!authToken || !USER_ID) {
                    var gc = document.getElementById('groupsContainer');
                    if (gc) gc.innerHTML = '<div style="text-align:center;padding:60px 20px;"><i class="fas fa-lock" style="font-size:3rem;color:rgba(0,255,255,0.3);margin-bottom:12px;display:block;"></i><h3 style="color:#e2e8f0;margin-bottom:8px;">Inicia sesion para ver tus tandas</h3><p style="color:#94a3b8;margin-bottom:20px;">Necesitas una cuenta para crear y gestionar grupos de ahorro</p><a href="/auth-enhanced.html" style="display:inline-flex;align-items:center;gap:8px;text-decoration:none;padding:10px 20px;background:linear-gradient(135deg,#00FFFF,#00cccc);color:#0f172a;border-radius:10px;font-weight:600;"><i class="fas fa-sign-in-alt"></i> Iniciar Sesion</a></div>';
                    return;
                }

                const response = await fetch(`${API_BASE}/api/groups/my-groups-pg`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + authToken
                    }
                });
                const data = await response.json();

                if (data.success) {
                    allGroups = data.data.groups.map(adaptPostgreSQLGroup);
                    window.currentGroupsData = allGroups;  // Exponer para modal Administrar
                    filteredGroups = [...allGroups];
                    updateStats();
                    renderGroups();

                    // Also refresh tandas tab to sync turn positions
                    if (typeof refreshTandas === 'function') {
                        refreshTandas();
                    }

                    // ✅ Check if there's a newly created group to highlight
                    const newlyCreatedId = sessionStorage.getItem('newly_created_group_id');
                    if (newlyCreatedId) {
                        highlightNewGroup(newlyCreatedId);
                        sessionStorage.removeItem('newly_created_group_id');
                    }
                } else {
                    showError('Error al cargar grupos');
                }
            } catch (error) {
                showError('Error de conexión');
            }
        }

// ===== UPDATE STATS =====
        function updateStats() {
            // Calculate real stats from allGroups data

            const activeGroups = allGroups.filter(g => g.status === 'active');

            // Count pending payments (groups where my_payment_status is pending, late, or suspension_recommended)
            const pendingCount = allGroups.filter(g =>
                g.my_payment_status === 'pending' || g.my_payment_status === 'late' || g.my_payment_status === 'suspension_recommended'
            ).length;

            // Sum total paid across all groups
            const totalPaidSum = allGroups.reduce((sum, g) => sum + (g.my_total_paid || 0), 0);

            // Count total alerts
            const alertsCount = allGroups.reduce((sum, g) => sum + (g.my_alerts?.length || 0), 0);

            // Total amount owed (contribution_amount for groups with pending/late status)
            const totalOwed = allGroups.reduce(function(sum, g) {
                if (g.my_payment_status === 'pending' || g.my_payment_status === 'late' || g.my_payment_status === 'suspension_recommended') {
                    return sum + (parseFloat(g.contribution_amount) || 0);
                }
                return sum;
            }, 0);

            // Max current_cycle across active groups
            var maxCycle = 0;
            activeGroups.forEach(function(g) {
                var c = parseInt(g.current_cycle) || 0;
                if (c > maxCycle) maxCycle = c;
            });

            // Role breakdown
            var roleCreator = 0, roleCoord = 0, roleMember = 0;
            allGroups.forEach(function(g) {
                if (g.my_role === 'creator') roleCreator++;
                else if (g.my_role === 'coordinator') roleCoord++;
                else roleMember++;
            });

            var el;
            // 2x2 grid
            el = document.getElementById('totalGroups'); if (el) el.textContent = allGroups.length;
            el = document.getElementById('activeGroups'); if (el) el.textContent = activeGroups.length;
            el = document.getElementById('pendingPayments'); if (el) el.textContent = pendingCount;
            el = document.getElementById('totalAlerts'); if (el) el.textContent = alertsCount;

            // Detail rows
            el = document.getElementById('grpTotalPaid'); if (el) el.textContent = 'L. ' + totalPaidSum.toLocaleString('es-HN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            el = document.getElementById('grpTotalOwed'); if (el) {
                el.textContent = 'L. ' + totalOwed.toLocaleString('es-HN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                // Hide row if nothing owed
                var owedRow = el.closest('.gs-row');
                if (owedRow) owedRow.style.display = totalOwed > 0 ? 'flex' : 'none';
            }
            el = document.getElementById('grpCurrentCycle'); if (el) el.textContent = maxCycle > 0 ? 'Ciclo ' + maxCycle : '--';

            // Roles
            el = document.getElementById('grpRoleCreator'); if (el) el.textContent = roleCreator;
            el = document.getElementById('grpRoleCoord'); if (el) el.textContent = roleCoord;

            // v4.10.8: Tanda balance now shown via updateSidebarHubCards (below Mi Wallet)
            // This secondary path is disabled to avoid duplicates
            (async function() {
                return; // disabled — single source: updateSidebarHubCards
                try {
                    var token = localStorage.getItem('auth_token') || localStorage.getItem('authToken');
                    if (!token) return;
                    var tandaGroups = allGroups.filter(function(g) { return g.tanda_status === 'active'; });
                    if (tandaGroups.length === 0) return;
                    var pg = tandaGroups[0];
                    var tbResp = await fetch('/api/groups/' + encodeURIComponent(pg.group_id) + '/tanda-balances', {
                        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }
                    });
                    if (!tbResp.ok) return;
                    var tbData = await tbResp.json();
                    if (!tbData.success || !tbData.data || !tbData.data.members) return;
                    var uid = USER_ID || localStorage.getItem('latanda_user_id') || localStorage.getItem('user_id');
                    var me = tbData.data.members.find(function(m) { return m.user_id === uid; });
                    if (!me) return;
                    var tb = me.tanda_balance;
                    var sign = tb >= 0 ? '+' : '';
                    var color = tb >= 0 ? '#34d399' : '#f87171';
                    // Update inline row in Resumen
                    var inlineRow = document.getElementById('grpTandaRow');
                    var inlineVal = document.getElementById('grpTandaInline');
                    if (inlineRow && inlineVal) {
                        inlineRow.style.display = 'flex';
                        inlineVal.textContent = sign + 'L. ' + Math.abs(tb).toLocaleString('es-HN', {minimumFractionDigits:2, maximumFractionDigits:2});
                        inlineVal.style.color = color;
                    }
                    // Also update separate card if visible
                    var card = document.getElementById('grpTandaBalanceCard');
                    if (card) {
                        card.style.display = '';
                        var label = tb >= 0 ? 'Ahorro acumulado' : 'Prestamo pendiente';
                        var balEl = document.getElementById('grpTandaBalance');
                        if (balEl) { balEl.textContent = sign + 'L. ' + Math.abs(tb).toLocaleString('es-HN', {minimumFractionDigits:2, maximumFractionDigits:2}); balEl.style.color = color; }
                        var lblEl = document.getElementById('grpTandaLabel');
                        if (lblEl) { lblEl.textContent = label; lblEl.style.color = color; }
                        var turnoEl = document.getElementById('grpTandaTurno');
                        if (turnoEl) turnoEl.textContent = 'Turno #' + (me.turn_position || '--');
                        var pagosEl = document.getElementById('grpTandaPagos');
                        if (pagosEl) pagosEl.textContent = (me.payments_count || 0) + ' pagos';
                        var grpEl = document.getElementById('grpTandaGroup');
                        if (grpEl) grpEl.textContent = pg.name || '--';
                    }
                    var distEl = document.getElementById('grpTandaDist');
                    if (distEl) distEl.textContent = (tbData.data.distributions_completed || 0) + ' dist.';
                } catch(e) { /* tanda balance is non-blocking */ }
            })();
            el = document.getElementById('grpRoleMember'); if (el) el.textContent = roleMember;

            // Next payment due
            updateNextPaymentCard();
        }

        function updateNextPaymentCard() {
            var card = document.getElementById('grpSidebarNextPayment');
            if (!card) return;

            // Find the group with the earliest next payment due among pending/upcoming
            var now = new Date();
            var nextGroup = null;
            var nextDate = null;

            allGroups.forEach(function(g) {
                if (g.status !== 'active') return;
                if (!g.my_next_payment_due) return;
                var d = new Date(g.my_next_payment_due.split('T')[0] + 'T12:00:00');
                if (!nextDate || d < nextDate) {
                    nextDate = d;
                    nextGroup = g;
                }
            });

            if (!nextGroup || !nextDate) {
                card.style.display = 'none';
                return;
            }

            card.style.display = 'block';
            var nameEl = document.getElementById('grpNextPayGroup');
            var amountEl = document.getElementById('grpNextPayAmount');
            var dateEl = document.getElementById('grpNextPayDate');
            var countdownEl = document.getElementById('grpNextPayCountdown');

            if (nameEl) nameEl.textContent = nextGroup.name || 'Grupo';
            if (amountEl) amountEl.textContent = 'L. ' + (parseFloat(nextGroup.contribution_amount) || 0).toLocaleString('es-HN', {minimumFractionDigits: 2, maximumFractionDigits: 2});

            var dateStr = nextDate.toLocaleDateString('es-HN', { day: '2-digit', month: 'short' });
            if (dateEl) dateEl.textContent = dateStr;

            // Countdown
            var diffMs = nextDate - now;
            var diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));

            if (countdownEl) {
                if (diffDays < 0) {
                    var absDays = Math.abs(diffDays);
                    countdownEl.textContent = 'Vencido hace ' + absDays + ' dia' + (absDays !== 1 ? 's' : '');
                    countdownEl.className = 'gs-next-countdown gs-countdown-late';
                } else if (diffDays === 0) {
                    countdownEl.textContent = 'Vence hoy';
                    countdownEl.className = 'gs-next-countdown gs-countdown-soon';
                } else if (diffDays <= 3) {
                    countdownEl.textContent = 'En ' + diffDays + ' dia' + (diffDays !== 1 ? 's' : '');
                    countdownEl.className = 'gs-next-countdown gs-countdown-soon';
                } else {
                    countdownEl.textContent = 'En ' + diffDays + ' dias';
                    countdownEl.className = 'gs-next-countdown gs-countdown-ok';
                }
            }
        }

        // ===== RENDER GROUPS =====
        function renderGroups() {
            const container = document.getElementById('groupsContainer');

            if (allGroups.length === 0) {
                container.innerHTML = '<div class="empty-state">' +
                    '<div class="empty-state-icon"><i class="fas fa-users" style="font-size:3rem;color:#00FFFF;"></i></div>' +
                    '<h3>Comienza tu primera tanda</h3>' +
                    '<p>Crea un grupo de ahorro con amigos, familia o companeros de trabajo.</p>' +
                    '<div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:16px;">' +
                        '<button class="btn btn-primary" data-action="switch-groups-tab" data-tab="create"><i class="fas fa-plus-circle"></i> Crear Grupo</button>' +
                    '</div>' +
                '</div>';
                return;
            }

            if (filteredGroups.length === 0) {
                container.innerHTML = '<div class="empty-state">' +
                    '<div class="empty-state-icon" style="font-size:3rem;">&#x1F50D;</div>' +
                    '<h3>Sin resultados</h3>' +
                    '<p>No se encontraron grupos con estos filtros.</p>' +
                    '<button class="btn btn-secondary" data-action="grp-reset-filters">Limpiar Filtros</button>' +
                '</div>';
                return;
            }

            const html = `
                <div class="groups-grid">
                    ${filteredGroups.map(group => renderGroupCard(group)).join('')}
                </div>
            `;

            container.innerHTML = html;
            
            // Dispatch event for position requests to load
            setTimeout(() => {
                window.dispatchEvent(new CustomEvent('groupsRendered'));
            }, 100);
        }

        // ===== CALCULO DE COMISION DE PLATAFORMA =====
        // Comision variable: <L.50k=3%, L.50k-100k=2%, >L.100k=1%
        function calculatePlatformFee(totalPool) {
            if (totalPool < 50000) return totalPool * 0.03;      // 3%
            if (totalPool <= 100000) return totalPool * 0.02;   // 2%
            return totalPool * 0.01;                             // 1%
        }
        
        function getCommissionRate(totalPool) {
            if (totalPool < 50000) return 3;
            if (totalPool <= 100000) return 2;
            return 1;
        }
        
        function calculatePayoutBreakdown(contributionAmount, memberCount, customRate) {
            const totalPool = contributionAmount * memberCount;
            var commissionRate;
            if (customRate !== null && customRate !== undefined) {
                commissionRate = customRate;
            } else {
                commissionRate = getCommissionRate(totalPool);
            }
            var platformFee = totalPool * (commissionRate / 100);
            var coordPlatformFee = platformFee * 0.10;
            var userReceives = totalPool - platformFee;

            return {
                contribution_amount: contributionAmount,
                member_count: memberCount,
                total_pool: totalPool,
                platform_fee: platformFee,
                coordinator_fee: platformFee - coordPlatformFee,
                platform_share: coordPlatformFee,
                commission_rate: commissionRate,
                user_receives: userReceives
            };
        }

        // v4.10.4: Commission live calculator for create form
        function updateCommissionCalc() {
            var calcBody = document.getElementById('commission-calc-body');
            if (!calcBody) return;
            var contribInput = document.getElementById('contribution');
            var membersInput = document.getElementById('max-participants');
            var contribution = parseFloat(contribInput ? contribInput.value : 0) || 0;
            var members = parseInt(membersInput ? membersInput.value : 0) || 0;
            if (contribution <= 0 || members <= 0) {
                calcBody.innerHTML = '<span style="color:#64748b;">Ingresa contribucion y miembros para ver el calculo</span>';
                return;
            }
            var commType = document.querySelector('input[name="commission-type"]:checked');
            var typeVal = commType ? commType.value : 'default';
            var customRate = null;
            if (typeVal === 'none') {
                customRate = 0;
            } else if (typeVal === 'custom') {
                var rateInput = document.getElementById('custom-commission-rate');
                customRate = parseFloat(rateInput ? rateInput.value : 2) || 2;
            }
            var breakdown = calculatePayoutBreakdown(contribution, members, customRate);
            var fmtL = function(n) { return 'L. ' + n.toLocaleString('es-HN', {minimumFractionDigits:2, maximumFractionDigits:2}); };
            calcBody.innerHTML =
                '<div>Fondo total (' + members + ' x ' + fmtL(contribution) + '): <strong style="color:#00FFFF;">' + fmtL(breakdown.total_pool) + '</strong></div>' +
                '<div>Comision coordinador (' + breakdown.commission_rate.toFixed(1) + '%): <strong>' + fmtL(breakdown.coordinator_fee) + '</strong></div>' +
                '<div>Comision plataforma (10% de coordinador): <strong>' + fmtL(breakdown.platform_share) + '</strong></div>' +
                '<div style="margin-top:6px;padding-top:6px;border-top:1px solid rgba(255,255,255,0.1);">El beneficiario recibe: <strong style="color:#22c55e;font-size:1rem;">' + fmtL(breakdown.user_receives) + '</strong></div>';
        }

        // Wire up commission radio buttons and inputs
        (function setupCommissionUI() {
            document.addEventListener('change', function(e) {
                if (e.target.name === 'commission-type') {
                    var customGroup = document.getElementById('custom-commission-group');
                    if (customGroup) customGroup.style.display = e.target.value === 'custom' ? 'block' : 'none';
                    updateCommissionCalc();
                }
                if (e.target.id === 'custom-commission-rate' || e.target.id === 'contribution' || e.target.id === 'max-participants') {
                    updateCommissionCalc();
                }
            });
            document.addEventListener('input', function(e) {
                if (e.target.id === 'custom-commission-rate' || e.target.id === 'contribution' || e.target.id === 'max-participants') {
                    updateCommissionCalc();
                }
            });
            // Initial calc when step 3 loads
            setTimeout(updateCommissionCalc, 500);
        })();

        // Calcular fecha limite de payout
        function calculatePayoutDeadline(startDate, frequency, turnNumber, gracePeriod) {
            const intervals = { weekly: 7, biweekly: 14, monthly: 30 };
            const daysInterval = intervals[frequency] || 30;
            
            const deadline = new Date(startDate);
            deadline.setDate(deadline.getDate() + (turnNumber * daysInterval) + gracePeriod);
            return deadline;
        }
        
        // Verificar si se puede procesar el payout
        function canProcessPayout(group, currentTurn) {
            const totalExpected = (group.contribution_amount || 0) * (group.member_count || group.max_members || 1);
            const totalCollected = group.current_cycle_collected || group.total_amount_collected || 0;
            
            // Condicion 1: Todo recaudado
            if (totalCollected >= totalExpected) return {
                        can: true, reason: "all_paid" };
            
            // Condicion 2: Periodo de gracia cumplido
            if (group.start_date) {
                const deadline = calculatePayoutDeadline(
                    group.start_date,
                    group.frequency,
                    currentTurn || 1,
                    group.grace_period || 3
                );
                if (new Date() >= deadline) return {
                        can: true, reason: "deadline_passed" };
            }
            
            return {
                        can: false, reason: "waiting" };
        }

        // ===== RENDER GROUP CARD =====
        // ===== RENDER GROUP CARD (v4.10.2 REDESIGN) =====
        function _gcFmtL(val) {
            var n = parseFloat(val);
            return isNaN(n) || n === 0 ? '--' : 'L. ' + n.toLocaleString('es-HN');
        }

        function renderGroupCard(group) {
            const statusLabels = {
                'active': 'Activo', 'pending': 'Pendiente', 'completed': 'Completado',
                'cancelled': 'Cancelado', 'paused': 'Pausado'
            };
            const frequencyLabels = {
                'weekly': 'Semanal', 'biweekly': 'Quincenal', 'monthly': 'Mensual'
            };
            const roleLabels = {
                'creator': 'Creador', 'coordinator': 'Coordinador', 'member': 'Miembro'
            };
            const alertIcons = {
                'success': '&#10003;', 'warning': '&#9888;', 'danger': '&#10007;', 'info': '&#8505;'
            };

            // Status color mapping
            var st = group.status || 'active';
            var statusColor = ({ active: '#00FFFF', completed: '#22c55e', pending: '#f59e0b', paused: '#f59e0b', suspended: '#ef4444', cancelled: '#64748b' })[st] || '#00FFFF';

            // Effective payment status (timezone fix)
            let effectivePaymentStatus = group.my_payment_status;
            if (group.my_payment_status === 'pending' && group.my_next_payment_due) {
                const dueDate = new Date(group.my_next_payment_due.split('T')[0] + 'T23:59:59');
                if (dueDate > new Date()) effectivePaymentStatus = 'up_to_date';
            }
            // Override card border for late/suspended/suspension_recommended payment
            if (effectivePaymentStatus === 'late' || effectivePaymentStatus === 'suspended' || effectivePaymentStatus === 'suspension_recommended') {
                statusColor = '#ef4444';
            }

            // Payout calculation (v4.10.4: use per-group commission_rate)
            const memberCount = group.max_members || group.members_count || 1;
            var groupCustomRate = (group.commission_rate !== null && group.commission_rate !== undefined) ? parseFloat(group.commission_rate) : null;
            const payout = calculatePayoutBreakdown(parseFloat(group.contribution_amount) || 0, memberCount, groupCustomRate);

            // Commission label for card
            var commLabel;
            if (groupCustomRate === null) commLabel = 'Estandar';
            else if (groupCustomRate === 0) commLabel = 'Sin comision';
            else commLabel = groupCustomRate + '%';

            // Avatar letter
            var avatarLetter = escapeHtml((group.name || '?').charAt(0).toUpperCase());

            // Frequency label
            var freqLabel = frequencyLabels[group.frequency] || group.frequency || '--';

            // Members display
            var membersDisplay = (group.total_positions || group.members_count || 0) + '/' + (group.max_members || '?');

            // Role pill colors
            var roleClass = group.my_role === 'creator' ? 'gc-role-creator' : group.my_role === 'coordinator' ? 'gc-role-coord' : 'gc-role-member';

            // Category + location subtitle
            var subParts = [];
            if (group.category) subParts.push(escapeHtml(group.category));
            if (group.location) subParts.push('&#x1F4CD; ' + escapeHtml(group.location));
            var subtitle = subParts.join(' &middot; ');

            // Alerts HTML
            var alertsHtml = '';
            if (group.my_alerts && group.my_alerts.length > 0) {
                alertsHtml = group.my_alerts.map(function(alert) {
                    var sevClass = ({ success: 'gc-alert-success', warning: 'gc-alert-warning', danger: 'gc-alert-danger', info: 'gc-alert-info' })[alert.severity] || 'gc-alert-info';
                    return '<div class="gc-alert ' + sevClass + '">' +
                        '<span class="gc-alert-icon">' + (alertIcons[alert.severity] || '&#8505;') + '</span>' +
                        '<span class="gc-alert-msg">' + escapeHtml(alert.message) + '</span>' +
                        '</div>';
                }).join('');
            }

            // Action buttons (contextual by role)
            var isAdmin = ['creator', 'coordinator', 'admin'].includes(group.my_role);
            var actionsHtml = '<button class="btn btn-primary" style="background:linear-gradient(135deg,#00FFFF,#00B8D4);color:#0f172a" data-action="grp-view-group" data-group-id="' + escapeHtml(group.id) + '">Ver Detalles</button>';
            if (isAdmin) {
                actionsHtml += '<button class="btn btn-secondary" data-action="grp-manage-group" data-group-id="' + escapeHtml(group.id) + '">Administrar</button>';
                actionsHtml += '<button class="btn btn-icon" data-action="grp-manage-members" data-group-id="' + escapeHtml(group.id) + '" data-group-name="' + escapeHtml(group.name) + '" title="Gestionar miembros">&#x1F465; <span class="btn-icon-label">Miembros</span></button>';
            } else {
                actionsHtml += '<button class="btn btn-secondary" data-action="grp-view-group" data-group-id="' + escapeHtml(group.id) + '">Ver Grupo</button>';
            }

            // v4.11.0: Solicitar Prórroga button for members with pending/late payments
            if (!isAdmin && (effectivePaymentStatus === 'pending' || effectivePaymentStatus === 'late' || effectivePaymentStatus === 'suspension_recommended')) {
                actionsHtml += '<button class="btn pr-request-btn" data-action="grp-request-extension" data-group-id="' + escapeHtml(group.id) + '">Solicitar Prorroga</button>';
            }

            return '<div class="group-card" data-group-id="' + escapeHtml(group.id) + '" data-status="' + escapeHtml(st) + '" style="border-color:' + statusColor + '">' +
                '<div class="gc-header">' +
                    '<div class="gc-avatar" style="background:' + statusColor + ';color:' + (st === 'suspended' || st === 'cancelled' ? '#fff' : '#0f172a') + '">' + avatarLetter + '</div>' +
                    '<div class="gc-name">' +
                        '<h3>' + escapeHtml(group.name) + '</h3>' +
                        (subtitle ? '<div class="gc-sub">' + subtitle + '</div>' : '') +
                    '</div>' +
                    '<span class="gc-role ' + roleClass + '">' + (roleLabels[group.my_role] || group.my_role) + '</span>' +
                '</div>' +
                (group.description ? '<div class="gc-desc">' + escapeHtml(group.description) + '</div>' : '') +
                '<div class="gc-stats">' +
                    '<div class="gc-stat">' +
                        '<div class="gc-stat-val cyan">' + _gcFmtL(group.contribution_amount) + '</div>' +
                        '<div class="gc-stat-label">Aporte ' + escapeHtml(freqLabel) + '</div>' +
                    '</div>' +
                    '<div class="gc-stat">' +
                        '<div class="gc-stat-val cyan">' + _gcFmtL(payout.user_receives) + '</div>' +
                        '<div class="gc-stat-label">Recibes</div>' +
                    '</div>' +
                    '<div class="gc-stat">' +
                        '<div class="gc-stat-val">' + escapeHtml(membersDisplay) + '</div>' +
                        '<div class="gc-stat-label">Miembros</div>' +
                    '</div>' +
                    '<div class="gc-stat">' +
                        '<div class="gc-stat-val">' + escapeHtml(commLabel) + '</div>' +
                        '<div class="gc-stat-label">Comision</div>' +
                    '</div>' +
                '</div>' +
                alertsHtml +
                '<div class="gc-actions">' + actionsHtml + '</div>' +
            '</div>';
        }

        // ===== FILTERS (SIMPLIFIED) =====
        function applyFilters() {
            const roleFilter = document.getElementById('filterRole') ? document.getElementById('filterRole').value : 'all';
            const paymentFilter = document.getElementById('filterPayment') ? document.getElementById('filterPayment').value : 'all';
            const searchTerm = document.getElementById('searchGroups') ? document.getElementById('searchGroups').value.toLowerCase() : '';

            filteredGroups = allGroups.filter(group => {
                const matchesRole = roleFilter === 'all' || (group.my_role && group.my_role === roleFilter);
                const matchesPayment = paymentFilter === 'all' || (group.my_payment_status && group.my_payment_status === paymentFilter);
                const matchesSearch = !searchTerm || (group.name && group.name.toLowerCase().includes(searchTerm));

                return matchesRole && matchesPayment && matchesSearch;
            });

            renderGroups();

                    // Also refresh tandas tab to sync turn positions
                    if (typeof refreshTandas === 'function') {
                        refreshTandas();
                    }
        }

        function resetFilters() {
            document.getElementById('filterRole').value = 'all';
            document.getElementById('filterPayment').value = 'all';
            document.getElementById('searchGroups').value = '';
            filteredGroups = [...allGroups];
            renderGroups();

                    // Also refresh tandas tab to sync turn positions
                    if (typeof refreshTandas === 'function') {
                        refreshTandas();
                    }
        }

        // ===== ACTIONS =====
        function viewGroup(groupId) {

            // Store selected group ID for detail view
            sessionStorage.setItem('selected_group_id', groupId);

            // Switch to tandas tab (group details)
            switchTab('tandas');

            // Trigger event for other sections to load group details
            window.dispatchEvent(new CustomEvent('groupSelected', {
                detail: { groupId: groupId }
            }));
        }

        function registerPayment(groupId) {

            // Check if payment integration manager exists
            if (window.paymentIntegrationManager) {
                const group = allGroups.find(g => g.id === groupId);
                if (group) {
                    // Open payment modal with group context
                    window.paymentIntegrationManager.openPaymentModal({
                        groupId: groupId,
                        amount: group.contribution_amount,
                        currency: 'HNL',
                        description: `Pago para ${escapeHtml(group.name)}`,
                        metadata: {
                            group_name: group.name,
                            payment_type: 'contribution'
                        }
                    });
                } else {
                    showError('Grupo no encontrado');
                }
            } else {
                // Fallback: navigate to payment page with group ID
                window.location.href = `/payment.html?group_id=${groupId}`;
            }
        }

        function handleAlertAction(groupId, actionUrl, alertType) {

            // Handle different action types
            switch (alertType) {
                case 'payment_due':
                case 'payment_overdue':
                    // Open payment registration
                    registerPayment(groupId);
                    break;

                case 'turn_upcoming':
                case 'your_turn_now':
                case 'can_advance_turn':
                    // Navigate to group details to see turn calendar
                    viewGroup(groupId);
                    break;

                case 'pending_approvals':
                    // Navigate to group admin section
                    viewGroup(groupId);
                    setTimeout(() => {
                        window.dispatchEvent(new CustomEvent('showAdminPanel', {
                            detail: { groupId: groupId }
                        }));
                    }, 500);
                    break;

                case 'late_members':
                    // Navigate to group details to see member list
                    viewGroup(groupId);
                    setTimeout(() => {
                        window.dispatchEvent(new CustomEvent('showMembersList', {
                            detail: { groupId: groupId, filter: 'late' }
                        }));
                    }, 500);
                    break;

                default:
                    // Generic navigation to action URL
                    if (actionUrl) {
                        if (actionUrl.startsWith('/') || actionUrl.startsWith('http')) {
                            window.location.href = actionUrl;
                        } else {
                            viewGroup(groupId);
                        }
                    }
            }
        }

        function getActionLabel(alertType) {
            const labels = {
                'payment_due': 'Pagar',
                'payment_overdue': 'Pagar Ahora',
                'turn_upcoming': 'Ver Calendario',
                'your_turn_now': 'Ver Estado',
                'pending_approvals': 'Aprobar',
                'can_advance_turn': 'Avanzar',
                'late_members': 'Ver Lista'
            };
            return labels[alertType] || 'Acción';
        }

        // ===== HIGHLIGHTING DE GRUPO RECIÉN CREADO =====
        function highlightNewGroup(groupId) {

            setTimeout(() => {
                // Find the group card by data attribute
                const groupCard = document.querySelector(`[data-group-id="${groupId}"]`);

                if (groupCard) {
                    // Add highlight class
                    groupCard.classList.add('newly-created');

                    // Scroll into view
                    groupCard.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });


                    // Remove highlight after 4 seconds
                    setTimeout(() => {
                        groupCard.classList.remove('newly-created');
                    }, 4000);
                } else {
                }
            }, 800); // Delay to ensure cards are rendered
        }

        // ===== UTILITIES =====
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-HN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        // ============================================
        // DATE HELPERS - Parse dates safely
        // ============================================
        
        // Parse date safely, avoiding timezone issues with DATE-only strings
        function parseDateLocal(dateString) {
            if (!dateString) return null;
            // If it is a DATE string (YYYY-MM-DD without time), add T00:00:00 to parse as local
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                return new Date(dateString + "T00:00:00");
            }
            // Otherwise parse normally (includes timestamp)
            return new Date(dateString);
        }

        function formatDateLocal(dateString) {
            var date = parseDateLocal(dateString);
            if (!date || isNaN(date)) return "";
            return date.toLocaleDateString("es-HN", {
                year: "numeric",
                month: "short",
                day: "numeric"
            });
        }



        // =====================================================================
        // POSITION ASSIGNMENT COMPONENT
        // =====================================================================
// =====================================================================
// POSITION ASSIGNMENT COMPONENT FOR COORDINATORS
// To be integrated into groups-advanced-system.html
// =====================================================================

// ===== POSITION ASSIGNMENT RENDERING =====

/**
 * Renders the position assignment section for a group in awaiting_positions status
 * This appears inside the group card for coordinators
 */
function renderPositionAssignmentSection(group) {
    if (group.status !== 'awaiting_positions') {
        return ''; // Only show for groups in position assignment phase
    }

    // Only show for creators/coordinators
    if (group.my_role !== 'creator' && group.my_role !== 'coordinator') {
        return '';
    }

    const positions = group.positions || [];
    const positionRequests = group.position_requests || [];
    const pendingRequests = positionRequests.filter(r => r.status === 'pending');
    const assignedCount = positions.filter(p => p.status === 'confirmed').length;
    const totalPositions = group.participant_count || group.max_members;
    const isComplete = assignedCount === totalPositions;

    return `
        <div class="position-assignment-section">
            <div class="position-header">
                <h4>📍 Asignación de Posiciones</h4>
                <div class="position-progress">
                    <span class="progress-text">${assignedCount}/${totalPositions} asignadas</span>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${(assignedCount / totalPositions) * 100}%"></div>
                    </div>
                </div>
            </div>



            <div class="positions-grid-section">
                <h5>🎯 Estado de Posiciones</h5>
                <div class="positions-grid">
                    ${Array.from({ length: totalPositions }, (_, i) => {
                        const posNum = i + 1;
                        const pos = positions.find(p => p.position === posNum);
                        return renderPositionCell(posNum, pos, group.id);
                    }).join('')}
                </div>
            </div>

            <div class="position-actions">
                ${!isComplete ? `
                    <button class="btn btn-secondary btn-sm" data-action="grp-auto-assign-random" data-group-id="${group.id}">
                        🎲 Asignar Aleatorio
                    </button>
                    <button class="btn btn-secondary btn-sm" data-action="grp-auto-assign-order" data-group-id="${group.id}">
                        📋 Asignar por Orden
                    </button>
                ` : ''}

                ${isComplete ? `
                    <button class="btn btn-primary" data-action="grp-activate-tanda" data-group-id="${group.id}">
                        ✅ Activar Grupo
                    </button>
                ` : `
                    <button class="btn btn-disabled" disabled>
                        🔒 Completa asignaciones para activar
                    </button>
                `}
            </div>
        </div>
    `;
}

/**
 * Renders individual request card with approve/reject actions
 */
function renderRequestCard(request, groupId) {
    return `
        <div class="request-card" data-request-id="${request.id}">
            <div class="request-info">
                <div class="request-user">
                    <strong>${escapeHtml(request.user_name || request.user_id)}</strong>
                    <span class="request-position-badge">Posición #${request.requested_position}</span>
                </div>
                ${request.reason ? `
                    <div class="request-reason">
                        <em>"${escapeHtml(request.reason)}"</em>
                    </div>
                ` : ''}
                <div class="request-date">
                    ${formatRequestDate(request.created_at)}
                </div>
            </div>
            <div class="request-actions">
                <button class="btn btn-success btn-sm" data-action="grp-approve-position" data-group-id="${groupId}" data-request-id="${request.id}">
                    ✓ Aprobar
                </button>
                <button class="btn btn-danger btn-sm" data-action="grp-reject-position" data-group-id="${groupId}" data-request-id="${request.id}">
                    ✕ Rechazar
                </button>
            </div>
        </div>
    `;
}

/**
 * Renders individual position cell in the grid
 */
function renderPositionCell(positionNumber, positionData, groupId) {
    if (!positionData || positionData.status !== 'confirmed') {
        // Available position
        return `
            <div class="position-cell available" data-action="grp-open-manual-assign" data-group-id="${groupId}" data-position="${positionNumber}">
                <div class="position-number">${positionNumber}</div>
                <div class="position-status">Disponible</div>
            </div>
        `;
    }

    // Assigned position
    const assignmentTypeLabel = {
        'approved': '✓ Aprobada',
        'manual': '✍ Manual',
        'random': '🎲 Aleatoria',
        'auto': '⚡ Auto'
    }[positionData.assignment_type] || 'Asignada';

    return `
        <div class="position-cell assigned ${positionData.assignment_type}">
            <div class="position-number">${positionNumber}</div>
            <div class="position-user">${escapeHtml(positionData.user_name || positionData.user_id)}</div>
            <div class="position-type">${assignmentTypeLabel}</div>
        </div>
    `;
}

// ===== API INTERACTION FUNCTIONS =====

/**
 * Approve a position request
 */
async function approvePositionRequest(groupId, requestId) {
    try {
        showLoading('Aprobando solicitud...');

        const response = await fetch(`${API_BASE}/api/groups/approve-position-request`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                ...getAuthHeaders()
            },
            body: JSON.stringify({
                request_id: requestId,
                group_id: groupId,
                // approved_by removed (server uses JWT)
            })
        });

        const data = await response.json();
        hideLoading();

        if (data.success) {
            showNotification('✅ Solicitud aprobada exitosamente', 'success');
            await fetchMyGroups(); // Reload groups to show updated state
        } else {
            showNotification('No se pudo aprobar la solicitud', 'error');
        }
    } catch (error) {
        hideLoading();
        showNotification('❌ Error de conexión', 'error');
    }
}

/**
 * Open modal to reject request with reason
 */
function openRejectModal(groupId, requestId) {
    const modal = document.getElementById('rejectModal') || createRejectModal();
    modal.dataset.groupId = groupId;
    modal.dataset.requestId = requestId;
    modal.style.display = 'flex'; modal.classList.add('active');
}

/**
 * Reject a position request with reason
 */
async function rejectPositionRequest(groupId, requestId, reason) {
    try {
        showLoading('Rechazando solicitud...');

        const response = await fetch(`${API_BASE}/api/groups/reject-position-request`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                ...getAuthHeaders()
            },
            body: JSON.stringify({
                request_id: requestId,
                group_id: groupId,
                // rejected_by removed (server uses JWT)
                reason: reason
            })
        });

        const data = await response.json();
        hideLoading();

        if (data.success) {
            showNotification('✅ Solicitud rechazada', 'success');
            closeRejectModal();
            await fetchMyGroups();
        } else {
            showNotification('No se pudo rechazar la solicitud', 'error');
        }
    } catch (error) {
        hideLoading();
        showNotification('❌ Error de conexión', 'error');
    }
}

/**
 * Open modal to manually assign position to a user
 */
function openManualAssignModal(groupId, positionNumber) {
    const modal = document.getElementById('manualAssignModal') || createManualAssignModal();
    modal.dataset.groupId = groupId;
    modal.dataset.positionNumber = positionNumber;
    modal.style.display = 'flex'; modal.classList.add('active');

    // Load users without positions for this group
    loadUsersWithoutPositions(groupId);
}

/**
 * Manually assign position to user
 */
async function assignPositionManually(groupId, positionNumber, userId, userName) {
    try {
        showLoading('Asignando posición...');

        const response = await fetch(`${API_BASE}/api/groups/assign-position-manually`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                ...getAuthHeaders()
            },
            body: JSON.stringify({
                group_id: groupId,
                user_id: userId,
                user_name: userName,
                position: positionNumber
            })
        });

        const data = await response.json();
        hideLoading();

        if (data.success) {
            showNotification('✅ Posición asignada exitosamente', 'success');
            closeManualAssignModal();
            await fetchMyGroups();
        } else {
            showNotification('No se pudo asignar la posicion', 'error');
        }
    } catch (error) {
        hideLoading();
        showNotification('❌ Error de conexión', 'error');
    }
}

/**
 * Auto-assign all remaining positions
 */
async function autoAssignPositions(groupId, method = 'random') {
    showConfirm('Asignar automaticamente las posiciones restantes por metodo ' + (method === 'random' ? 'aleatorio' : 'de orden de ingreso') + '?', async function() {
    try {
        showLoading('Asignando posiciones automáticamente...');

        const response = await fetch(`${API_BASE}/api/groups/auto-assign-positions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                ...getAuthHeaders()
            },
            body: JSON.stringify({
                group_id: groupId,
                method: method,
                // assigned_by removed (server uses JWT)
            })
        });

        const data = await response.json();
        hideLoading();

        if (data.success) {
            showNotification(`✅ ${data.data.assigned_count} posiciones asignadas`, 'success');
            await fetchMyGroups();
        } else {
            showNotification('No se pudo auto-asignar las posiciones', 'error');
        }
    } catch (error) {
        hideLoading();
        showNotification('Error de conexion', 'error');
    }
    }); // end showConfirm
}

/**
 * Activate tanda after all positions assigned
 */
async function activateTanda(groupId) {
    // Check if lottery was executed
    const group = window.currentGroupsData ? window.currentGroupsData.find(g => g.id === groupId || g.group_id === groupId) : null;
    const lotteryExecuted = group ? group.lottery_executed : false;

    let confirmMessage = '¿Activar este grupo? Se generará el calendario de pagos y comenzará el ciclo.';

    if (!lotteryExecuted) {
        confirmMessage = '⚠️ ADVERTENCIA: La tómbola NO se ha ejecutado.\n\n' +
            'Las posiciones actuales de turno serán usadas tal como están.\n\n' +
            '¿Deseas continuar sin sortear las posiciones?';
    }

    showConfirm(confirmMessage, async function() {
    try {
        showLoading('Activando grupo...');

        const response = await fetch(`${API_BASE}/api/groups/activate-tanda`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                ...getAuthHeaders()
            },
            body: JSON.stringify({
                group_id: groupId,
                // activated_by removed (server uses JWT)
            })
        });

        const data = await response.json();
        hideLoading();

        if (data.success) {
            showNotification('✅ ¡Grupo activado exitosamente! El ciclo ha comenzado.', 'success');
            await fetchMyGroups();
        } else {
            showNotification('No se pudo activar el grupo', 'error');
        }
    } catch (error) {
        hideLoading();
        showNotification('Error de conexion', 'error');
    }
    }); // end showConfirm
}

// ===== HELPER FUNCTIONS =====

function formatRequestDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Hace un momento';
    if (diffMins < 60) return `Hace ${diffMins} min`;
    if (diffHours < 24) return `Hace ${diffHours}h`;
    if (diffDays < 7) return `Hace ${diffDays}d`;

    return date.toLocaleDateString();
}

function showLoading(message = 'Cargando...') {
    let loader = document.getElementById('globalLoader');
    if (!loader) {
        loader = document.createElement('div');
        loader.id = 'globalLoader';
        loader.className = 'global-loader';
        loader.innerHTML = `
            <div class="loader-content">
                <div class="loader-spinner"></div>
                <p class="loader-message">${message}</p>
            </div>
        `;
        document.body.appendChild(loader);
    } else {
        loader.querySelector('.loader-message').textContent = message;
    }
    loader.style.display = 'flex';
}

function hideLoading() {
    const loader = document.getElementById('globalLoader');
    if (loader) {
        loader.style.display = 'none';
    }
}

// v4.10.3: Toggle collapsible sections in Create Group Step 3
function toggleCollapsible(btn) {
    var header = btn.closest('.collapsible-header') || btn;
    var section = header.closest('.collapsible-section');
    if (!section) return;
    var content = section.querySelector('.collapsible-content');
    var icon = header.querySelector('.collapsible-icon');
    if (!content) return;
    var isExpanded = content.classList.contains('expanded');
    if (isExpanded) {
        content.classList.remove('expanded');
        content.style.maxHeight = '0';
        if (icon) icon.style.transform = 'rotate(0deg)';
    } else {
        content.classList.add('expanded');
        content.style.maxHeight = content.scrollHeight + 'px';
        if (icon) icon.style.transform = 'rotate(180deg)';
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.classList.add('show');
    }, 10);

    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// ===== MODAL CREATION FUNCTIONS =====

function createRejectModal() {
    const modal = document.createElement('div');
    modal.id = 'rejectModal';
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Rechazar Solicitud</h3>
                <button class="modal-close" data-action="grp-close-reject">×</button>
            </div>
            <div class="modal-body">
                <label for="rejectReason">Razón del rechazo (opcional):</label>
                <textarea id="rejectReason" rows="3" placeholder="Explica por qué se rechaza esta solicitud..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-action="grp-close-reject">Cancelar</button>
                <button class="btn btn-danger" data-action="grp-confirm-reject">Rechazar Solicitud</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    return modal;
}

function closeRejectModal() {
    const modal = document.getElementById('rejectModal');
    if (modal) {
        modal.style.display = 'none'; modal.classList.remove('active');
        document.getElementById('rejectReason').value = '';
    }
}

function confirmReject() {
    const modal = document.getElementById('rejectModal');
    const groupId = modal.dataset.groupId;
    const requestId = modal.dataset.requestId;
    const reason = document.getElementById('rejectReason').value.trim();

    rejectPositionRequest(groupId, requestId, reason);
}

function createManualAssignModal() {
    const modal = document.createElement('div');
    modal.id = 'manualAssignModal';
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Asignar Posición Manualmente</h3>
                <button class="modal-close" data-action="grp-close-manual-assign">×</button>
            </div>
            <div class="modal-body">
                <p>Posición: <strong id="assignPositionNumber">-</strong></p>
                <label for="assignUserId">Seleccionar usuario:</label>
                <select id="assignUserId">
                    <option value="">Cargando usuarios...</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-action="grp-close-manual-assign">Cancelar</button>
                <button class="btn btn-primary" data-action="grp-confirm-manual-assign">Asignar</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    return modal;
}

function closeManualAssignModal() {
    const modal = document.getElementById('manualAssignModal');
    if (modal) {
        modal.style.display = 'none'; modal.classList.remove('active');
    }
}

function confirmManualAssign() {
    const modal = document.getElementById('manualAssignModal');
    const groupId = modal.dataset.groupId;
    const positionNumber = parseInt(modal.dataset.positionNumber);
    const select = document.getElementById('assignUserId');
    const userId = select.value;
    const userName = select.options[select.selectedIndex].text;

    if (!userId) {
        showWarning('Por favor selecciona un usuario');
        return;
    }

    assignPositionManually(groupId, positionNumber, userId, userName);
}

async function loadUsersWithoutPositions(groupId) {
    try {
        // Get group details from current state
        const group = allGroups.find(g => g.id === groupId);
        if (!group) return;

        // Find members without confirmed positions
        const assignedUserIds = (group.positions || [])
            .filter(p => p.status === 'confirmed')
            .map(p => p.user_id);

        // Get all members (this would need to come from API in real implementation)
        const response = await fetch(`${API_BASE}/api/groups/${groupId}/members`, {
            headers: { 'Content-Type': 'application/json', ...getAuthHeaders() }
        });

        const data = await response.json();

        if (data.success && data.data && data.data.members) {
            const availableUsers = data.data.members.filter(m => !assignedUserIds.includes(m.user_id));

            const select = document.getElementById('assignUserId');
            select.innerHTML = availableUsers.length > 0
                ? availableUsers.map(u => `<option value="${u.user_id}">${u.name || u.user_id}</option>`).join('')
                : '<option value="">No hay usuarios disponibles</option>';

            document.getElementById('assignPositionNumber').textContent = `#${document.getElementById('manualAssignModal').dataset.positionNumber}`;
        }
    } catch (error) {
        document.getElementById('assignUserId').innerHTML = '<option value="">Error cargando usuarios</option>';
    }
}

        function showError(message) {
        message = escapeHtml(message);
            document.getElementById('groupsContainer').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">⚠️</div>
                    <h3>Error</h3>
                    <p>${message}</p>
                    <button class="btn btn-primary" data-action="grp-retry-load">Reintentar</button>
                </div>
            `;
        }

        // ===== WEBSOCKET INTEGRATION =====
        function initWebSocketListeners() {
            // Check if WebSocket manager is available
            if (window.wsManager) {

                // Listen for group updates
                window.wsManager.on('group_update', (data) => {

                    // If the updated group is in our list, refresh
                    if (data.groupId && allGroups.some(g => g.id === data.groupId)) {
                        fetchMyGroups();
                    }
                });

                // Listen for payment confirmations
                window.wsManager.on('payment_confirmed', (data) => {

                    // If payment is for a group in our list, refresh
                    if (data.groupId && allGroups.some(g => g.id === data.groupId)) {
                        fetchMyGroups();
                    }
                });

                // Listen for general notifications that might affect groups
                window.wsManager.on('notification', (data) => {
                    if (data.type && data.type.includes('group')) {
                        // Optionally refresh groups on relevant notifications
                        fetchMyGroups();
                    }
                });

            } else {
                // Fallback: poll for updates every 60 seconds
                if (window._groupsPollInterval) clearInterval(window._groupsPollInterval);
                window._groupsPollInterval = setInterval(function() {
                    fetchMyGroups();
                }, 60000);
            }
        }

        // ===== EVENT LISTENERS =====
        document.getElementById('filterRole').addEventListener('change', applyFilters);
        document.getElementById('filterPayment').addEventListener('change', applyFilters);
        var _searchDebounce;
        document.getElementById('searchGroups').addEventListener('input', function() {
            clearTimeout(_searchDebounce);
            _searchDebounce = setTimeout(applyFilters, 300);
        });

        // ===== INITIALIZE =====
        fetchMyGroups();

        // Initialize WebSocket listeners after a brief delay to ensure wsManager is loaded
        setTimeout(initWebSocketListeners, 1000);
            </script>
            </section>

            <!-- ===== CREAR GRUPO ===== -->
        <section id="create" class="content-section">
            <div class="section-header">
                <div>
                    <h2><i class="fas fa-plus-circle"></i> <span data-translate="groups.create_new_group">Crear Nuevo Grupo</span></h2>
                    <p class="section-description" data-translate="groups.create_description">Configura un nuevo grupo cooperativo con funciones avanzadas</p>
                </div>
            </div>
            <div class="create-group-form">
                <!-- Progress Bar -->
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 0%;"></div>
                    <div class="step active" data-step="1">
                        <div class="step-number">1</div>
                        <div class="step-title" data-translate="create.step_basic">Básico</div>
                    </div>
                    <div class="step" data-step="2">
                        <div class="step-number">2</div>
                        <div class="step-title" data-translate="create.step_config">Configuración</div>
                    </div>
                    <div class="step" data-step="3">
                        <div class="step-number">3</div>
                        <div class="step-title" data-translate="create.step_advanced">Avanzado</div>
                    </div>
                    <div class="step" data-step="4">
                        <div class="step-number">4</div>
                        <div class="step-title" data-translate="create.step_confirmation">Confirmación</div>
                    </div>
                </div>

                <!-- Multi-Step Form -->
                <form id="create-group-form" class="multi-step-form">
                    <!-- Step 1: Basic Information -->
                    <div class="step-container active" data-step="1">
                        <div class="form-card">
                            <h3><i class="fas fa-info-circle"></i> Información Básica</h3>
                            <p class="step-description">Define los aspectos fundamentales de tu grupo cooperativo</p>
                            
                            <div class="form-group">
                                <label for="group-name">Nombre del Grupo <span class="required">*</span></label>
                                <input type="text" id="group-name" placeholder="Ej: Cooperativa Familiar Norte" required>
                                <div class="help-text">Escoge un nombre descriptivo y fácil de recordar</div>
                                <div class="error-message" id="group-name-error"></div>
                            </div>

                            <div class="form-group">
                                <label for="group-description">Descripción del Grupo <span class="required">*</span></label>
                                <textarea id="group-description" placeholder="Describe el propósito y objetivos del grupo..." maxlength="250" required></textarea>
                                <div class="char-counter"><span id="desc-count">0</span>/250 caracteres</div>
                                <div class="error-message" id="group-description-error"></div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="group-type">Tipo de Grupo <span class="required">*</span></label>
                                    <select id="group-type" required>
                                        <option value="">Seleccionar tipo...</option>
                                        <option value="familiar">Familiar</option>
                                        <option value="laboral">Laboral</option>
                                        <option value="comunitario">Comunitario</option>
                                        <option value="comercial">Comercial</option>
                                    </select>
                                    <div class="error-message" id="group-type-error"></div>
                                </div>

                                <div class="form-group">
                                    <label for="location">Ubicación <span class="required">*</span></label>
                                    <input type="text" id="location" placeholder="Ej: Tegucigalpa, Comayagüela" required>
                                    <div class="error-message" id="location-error"></div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">¿Permites reuniones virtuales?</label>
                                <div class="radio-group">
                                    <label class="radio-option">
                                        <input type="radio" name="virtual-meetings" value="yes" checked>
                                        <span class="radio-custom"></span>
                                        <span>Sí, permitir reuniones online</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="virtual-meetings" value="no">
                                        <span class="radio-custom"></span>
                                        <span>Solo reuniones presenciales</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Financial Configuration -->
                    <div class="step-container" data-step="2">
                        <div class="form-card">
                            <h3><i class="fas fa-dollar-sign"></i> Configuración Financiera</h3>
                            <p class="step-description">Define los aspectos económicos y de participación</p>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="contribution">Contribución Base (L.) <span class="required">*</span></label>
                                    <input type="number" id="contribution" value="1500" min="100" max="50000" required>
                                    <div class="help-text">Monto que cada miembro aporta por ciclo</div>
                                    <div class="error-message" id="contribution-error"></div>
                                </div>

                                <div class="form-group">
                                    <label for="max-participants">Máximo Participantes <span class="required">*</span></label>
                                    <input type="number" id="max-participants" value="12" min="2" max="50" required>
                                    <div class="help-text">Número máximo de miembros en el grupo</div>
                                    <div class="error-message" id="max-participants-error"></div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="payment-frequency">Frecuencia de Pago <span class="required">*</span></label>
                                    <select id="payment-frequency" required>
                                        <option value="">Seleccionar frecuencia...</option>
                                        <option value="weekly">Semanal</option>
                                        <option value="biweekly">Quincenal</option>
                                        <option value="monthly">Mensual</option>
                                    </select>
                                    <div class="error-message" id="payment-frequency-error"></div>
                                </div>

                                <div class="form-group">
                                    <label for="start-date">Fecha de Inicio</label>
                                    <input type="date" id="start-date">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Opciones Adicionales</label>
                                <div class="checkbox-group">
                                    <label class="checkbox-option">
                                        <input type="checkbox" id="early-withdrawals">
                                        <span class="checkbox-custom"></span>
                                        <span>Permitir retiros anticipados (con penalización)</span>
                                    </label>
                                    <label class="checkbox-option">
                                        <input type="checkbox" id="insurance-required">
                                        <span class="checkbox-custom"></span>
                                        <span>Requerir seguro de participación</span>
                                    </label>
                                    <label class="checkbox-option">
                                        <input type="checkbox" id="late-penalties" checked>
                                        <span class="checkbox-custom"></span>
                                        <span>Aplicar multas por pagos tardíos</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Advanced Configuration -->
                    <div class="step-container" data-step="3">
                        <div class="form-card">
                            <h3><i class="fas fa-shield-alt"></i> Configuración Avanzada</h3>
                            <p class="step-description">Establece reglas y políticas del grupo con opciones avanzadas</p>
                            
                            <!-- Collapsible Section: Requisitos de Ingreso -->
                            <div class="collapsible-section">
                                <div class="collapsible-header" data-action="grp-toggle-collapsible">
                                    <span>
                                        <i class="fas fa-user-check"></i>
                                        <strong>Requisitos de Ingreso</strong>
                                        <span class="section-description">Define quién puede unirse al grupo</span>
                                    </span>
                                    <i class="fas fa-chevron-down collapsible-icon"></i>
                                </div>
                                <div class="collapsible-content expanded">
                                    <div class="collapsible-inner">
                                        <div class="checkbox-group">
                                            <label class="checkbox-option">
                                                <input type="checkbox" id="require-id" checked>
                                                <span class="checkbox-custom"></span>
                                                <span>Verificación de identidad obligatoria</span>
                                            </label>
                                            <label class="checkbox-option">
                                                <input type="checkbox" id="require-income">
                                                <span class="checkbox-custom"></span>
                                                <span>Comprobante de ingresos</span>
                                            </label>
                                            <label class="checkbox-option">
                                                <input type="checkbox" id="require-references">
                                                <span class="checkbox-custom"></span>
                                                <span>Referencias personales (mín. 2)</span>
                                            </label>
                                            <label class="checkbox-option">
                                                <input type="checkbox" id="require-min-trust-score">
                                                <span class="checkbox-custom"></span>
                                                <span>Puntaje mínimo de confianza: 70%</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Collapsible Section: Reglas y Políticas -->
                            <div class="collapsible-section">
                                <div class="collapsible-header" data-action="grp-toggle-collapsible">
                                    <span>
                                        <i class="fas fa-gavel"></i>
                                        <strong>Reglas y Políticas</strong>
                                        <span class="section-description">Establece las normas del grupo</span>
                                    </span>
                                    <i class="fas fa-chevron-down collapsible-icon"></i>
                                </div>
                                <div class="collapsible-content expanded">
                                    <div class="collapsible-inner">
                                        <div class="form-group">
                                            <label for="group-rules">Reglas del Grupo</label>
                                            <textarea id="group-rules" placeholder="Define las reglas específicas del grupo..." rows="4">• Puntualidad en pagos es obligatoria
• Participación en reuniones mensuales  
• Respeto mutuo entre miembros
• Comunicación transparente sobre dificultades financieras</textarea>
                                            <div class="help-text">Estas reglas serán visibles para todos los miembros</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Collapsible Section: Multas y Penalizaciones -->
                            <div class="collapsible-section">
                                <div class="collapsible-header" data-action="grp-toggle-collapsible">
                                    <span>
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <strong>Multas y Penalizaciones</strong>
                                        <span class="section-description">Configura sanciones por incumplimiento</span>
                                    </span>
                                    <i class="fas fa-chevron-down collapsible-icon"></i>
                                </div>
                                <div class="collapsible-content">
                                    <div class="collapsible-inner">
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="penalty-amount">Multa por Retraso (L.)</label>
                                                <input type="number" id="penalty-amount" placeholder="50" min="0" max="500" step="25">
                                                <div class="help-text">Multa aplicada por pagos tardíos</div>
                                                <div class="error-message" id="penalty-amount-error"></div>
                                            </div>
                                            <div class="form-group">
                                                <label for="grace-period">Período de Gracia (días)</label>
                                                <input type="number" id="grace-period" placeholder="3" min="0" max="15">
                                                <div class="help-text">Días adicionales sin multa</div>
                                                <div class="error-message" id="grace-period-error"></div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Acciones por Incumplimiento</label>
                                            <div class="checkbox-group">
                                                <label class="checkbox-option">
                                                    <input type="checkbox" id="auto-suspend" checked>
                                                    <span class="checkbox-custom"></span>
                                                    <span>Suspender automáticamente tras 3 faltas</span>
                                                </label>
                                                <label class="checkbox-option">
                                                    <input type="checkbox" id="require-guarantor">
                                                    <span class="checkbox-custom"></span>
                                                    <span>Requerir garante para reincorporación</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Collapsible Section: Comision del Coordinador (v4.10.4) -->
                            <div class="collapsible-section">
                                <div class="collapsible-header" data-action="grp-toggle-collapsible">
                                    <span>
                                        <i class="fas fa-percentage"></i>
                                        <strong>Comision del Coordinador</strong>
                                        <span class="section-description">Define la comision que se aplica a cada pago</span>
                                    </span>
                                    <i class="fas fa-chevron-down collapsible-icon"></i>
                                </div>
                                <div class="collapsible-content expanded">
                                    <div class="collapsible-inner">
                                        <div class="form-group">
                                            <label class="form-label">Tipo de Comision</label>
                                            <div class="radio-group">
                                                <label class="radio-option">
                                                    <input type="radio" name="commission-type" value="default" checked>
                                                    <span class="radio-custom"></span>
                                                    <span>Estandar de plataforma (3%-1% segun monto)</span>
                                                </label>
                                                <label class="radio-option">
                                                    <input type="radio" name="commission-type" value="custom">
                                                    <span class="radio-custom"></span>
                                                    <span>Personalizada</span>
                                                </label>
                                                <label class="radio-option">
                                                    <input type="radio" name="commission-type" value="none">
                                                    <span class="radio-custom"></span>
                                                    <span>Sin comision (0%)</span>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="form-group" id="custom-commission-group" style="display:none;">
                                            <label for="custom-commission-rate">Porcentaje de Comision (%)</label>
                                            <input type="number" id="custom-commission-rate" min="0.5" max="5" step="0.5" value="2" style="max-width:120px;">
                                            <div class="help-text">Entre 0.5% y 5%. Los miembros deciden individualmente si aceptan.</div>
                                        </div>
                                        <div id="commission-live-calc" class="commission-calc-panel" style="margin-top:12px;padding:14px;background:rgba(0,255,255,0.06);border:1px solid rgba(0,255,255,0.15);border-radius:10px;">
                                            <div style="font-size:0.82rem;color:#94a3b8;margin-bottom:8px;font-weight:600;">Vista previa de comision</div>
                                            <div id="commission-calc-body" style="font-size:0.85rem;color:#e2e8f0;line-height:1.7;"></div>
                                        </div>
                                        <div style="margin-top:10px;padding:10px;background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);border-radius:8px;font-size:0.8rem;color:#f59e0b;">
                                            <strong>Democratico:</strong> Cada miembro decide si acepta la comision. Solo se cobra a quienes acepten.
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Collapsible Section: Notificaciones -->
                            <div class="collapsible-section">
                                <div class="collapsible-header" data-action="grp-toggle-collapsible">
                                    <span>
                                        <i class="fas fa-bell"></i>
                                        <strong>Notificaciones Automáticas</strong>
                                        <span class="section-description">Configura recordatorios y alertas</span>
                                    </span>
                                    <i class="fas fa-chevron-down collapsible-icon"></i>
                                </div>
                                <div class="collapsible-content">
                                    <div class="collapsible-inner">
                                        <div class="checkbox-group">
                                            <label class="checkbox-option">
                                                <input type="checkbox" id="notify-payment-reminder" checked>
                                                <span class="checkbox-custom"></span>
                                                <span>Recordatorio de pagos (3 días antes)</span>
                                            </label>
                                            <label class="checkbox-option">
                                                <input type="checkbox" id="notify-meeting-reminder" checked>
                                                <span class="checkbox-custom"></span>
                                                <span>Recordatorio de reuniones</span>
                                            </label>
                                            <label class="checkbox-option">
                                                <input type="checkbox" id="notify-turn-update" checked>
                                                <span class="checkbox-custom"></span>
                                                <span>Actualización de turnos de cobro</span>
                                            </label>
                                            <label class="checkbox-option">
                                                <input type="checkbox" id="notify-new-members">
                                                <span class="checkbox-custom"></span>
                                                <span>Notificar nuevos miembros</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Confirmation -->
                    <div class="step-container" data-step="4">
                        <div class="form-card">
                            <h3><i class="fas fa-check-circle"></i> Confirmación y Resumen</h3>
                            <p class="step-description">Revisa todos los detalles antes de crear el grupo</p>
                            
                            <div class="confirmation-summary" id="confirmationSummary">
                                <!-- Summary will be generated dynamically -->
                            </div>

                            <div class="form-group">
                                <label class="checkbox-option">
                                    <input type="checkbox" id="accept-terms" required>
                                    <span class="checkbox-custom"></span>
                                    <span>Acepto los términos y condiciones de La Tanda</span>
                                </label>
                                <div class="error-message" id="accept-terms-error"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Form Navigation -->
                    <div class="form-navigation">
                        <button type="button" class="btn btn-secondary" id="previous-step" style="display: none;">
                            <i class="fas fa-arrow-left"></i>
                            <span>Anterior</span>
                        </button>
                        <button type="button" class="btn btn-primary" id="next-step">
                            <span>Continuar</span>
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </form>

            <!-- ===== TEMPLATE SELECTOR MODAL ===== -->
            <div id="template-modal" class="modal-overlay" style="display: none;">
                <div class="modal-content template-selector-modal">
                    <div class="modal-header-templates">
                        <h3>🎯 Elige una Plantilla para tu Grupo</h3>
                        <p>Selecciona el tipo de grupo que más se ajuste a tus necesidades. Puedes modificar todos los valores después.</p>
                        <button class="modal-close-templates">&times;</button>
                    </div>
                    <div class="modal-body-templates">
                        <div class="template-grid">

                            <!-- Template Card 1: Familiar Pequeño -->
                            <div class="template-card" data-template="familiar-small">
                                <div class="template-icon">👨‍👩‍👧‍👦</div>
                                <h4>Grupo Familiar Pequeño</h4>
                                <p>Ideal para 6-8 familiares cercanos</p>
                                <div class="template-specs">
                                    <span>💰 L. 1,500/mes</span>
                                    <span>👥 8 miembros</span>
                                </div>
                                <button class="select-template-btn" data-action="grp-select-template" data-template="familiar-small">Seleccionar</button>
                            </div>

                            <!-- Template Card 2: Laboral -->
                            <div class="template-card" data-template="laboral">
                                <div class="template-icon">💼</div>
                                <h4>Grupo Laboral</h4>
                                <p>Para compañeros de trabajo</p>
                                <div class="template-specs">
                                    <span>💰 L. 2,000/quincenal</span>
                                    <span>👥 12 miembros</span>
                                </div>
                                <button class="select-template-btn" data-action="grp-select-template" data-template="laboral">Seleccionar</button>
                            </div>

                            <!-- Template Card 3: Comunitario -->
                            <div class="template-card" data-template="comunitario">
                                <div class="template-icon">🏘️</div>
                                <h4>Grupo Comunitario</h4>
                                <p>Vecinos y comunidad local</p>
                                <div class="template-specs">
                                    <span>💰 L. 500/mes</span>
                                    <span>👥 30 miembros</span>
                                </div>
                                <button class="select-template-btn" data-action="grp-select-template" data-template="comunitario">Seleccionar</button>
                            </div>

                            <!-- Template Card 4: Comercial -->
                            <div class="template-card" data-template="comercial">
                                <div class="template-icon">🏪</div>
                                <h4>Grupo Comercial</h4>
                                <p>Emprendedores y negocios</p>
                                <div class="template-specs">
                                    <span>💰 L. 5,000/quincenal</span>
                                    <span>👥 15 miembros</span>
                                </div>
                                <button class="select-template-btn" data-action="grp-select-template" data-template="comercial">Seleccionar</button>
                            </div>

                            <!-- Template Card 5: Tanda Rápida -->
                            <div class="template-card" data-template="tanda-rapida">
                                <div class="template-icon">⚡</div>
                                <h4>Tanda Rápida Semanal</h4>
                                <p>Ciclo corto, ahorro rápido</p>
                                <div class="template-specs">
                                    <span>💰 L. 500/semana</span>
                                    <span>👥 10 miembros</span>
                                </div>
                                <button class="select-template-btn" data-action="grp-select-template" data-template="tanda-rapida">Seleccionar</button>
                            </div>

                            <!-- Template Card 6: Custom -->
                            <div class="template-card custom-template" data-template="custom">
                                <div class="template-icon">✏️</div>
                                <h4>Custom (Desde Cero)</h4>
                                <p>Configura todo manualmente</p>
                                <div class="template-specs">
                                    <span>🎨 Personalizado 100%</span>
                                </div>
                                <button class="select-template-btn" data-action="grp-select-template" data-template="custom">Empezar</button>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
            <!-- ===== END TEMPLATE SELECTOR MODAL ===== -->

            </div>
        </section>

            <!-- ===== MIS TANDAS ===== -->
        <section id="tandas" class="content-section">
            <div class="section-header">
                <div>
                    <h2><i class="fas fa-coins"></i> Mis Tandas</h2>
                    <p class="section-description">Tu centro de pagos y cobros</p>
                </div>
                <div class="section-actions">
                    <button class="btn btn-outline" data-action="grp-refresh-tandas">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                    <button class="btn btn-primary" data-action="grp-show-tanda-history">
                        <i class="fas fa-history"></i> Historial
                    </button>
                </div>
            </div>

            <!-- Filter Bar (matches Mis Grupos pattern) -->
            <div class="filter-bar" id="tandasFilterBar">
                <select id="tandasStatusFilter">
                    <option value="all">Estado: Todas</option>
                    <option value="active">Activas</option>
                    <option value="recruiting">Reclutando</option>
                    <option value="completed">Completadas</option>
                    <option value="paused">Pausadas</option>
                </select>
                <select id="tandasSortOrder">
                    <option value="next-payment">Próximo pago</option>
                    <option value="amount">Monto</option>
                    <option value="turn-position">Mi turno</option>
                </select>
                <input type="text" id="searchTandas" placeholder="Buscar tanda...">
            </div>

            <!-- Tanda Cards Container -->
            <div id="tandasList" class="tandas-grid">
                <div class="loading-state" id="tandasLoading">
                    <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div>
                    <p class="loading-text">Cargando tus tandas...</p>
                </div>
            </div>

            
    
            <!-- Payout containers (preserved for payout-frontend.js) -->
            <div id="collectTandaContainer"></div>
            <div id="payoutMethodsContainer"></div>
        </section>

        </main>

        <!-- RIGHT SIDEBAR -->
<aside class="right-sidebar" id="rightSidebar">
            <div class="right-sidebar-sticky">
                <div class="sidebar-hub-cards" id="sidebarHubCards"></div>

                <!-- Resumen Stats Card -->
                <div class="grp-sidebar-stats" id="grpSidebarStats">
                    <h4 class="grp-sidebar-stats-title">Resumen</h4>

                    <!-- Top 2x2 grid -->
                    <div class="gs-grid">
                        <div class="gs-cell">
                            <span class="gs-cell-val" id="totalGroups">0</span>
                            <span class="gs-cell-label">Grupos</span>
                        </div>
                        <div class="gs-cell">
                            <span class="gs-cell-val gs-cyan" id="activeGroups">0</span>
                            <span class="gs-cell-label">Activos</span>
                        </div>
                        <div class="gs-cell">
                            <span class="gs-cell-val gs-amber" id="pendingPayments">0</span>
                            <span class="gs-cell-label">Pendientes</span>
                        </div>
                        <div class="gs-cell">
                            <span class="gs-cell-val gs-red" id="totalAlerts">0</span>
                            <span class="gs-cell-label">Alertas</span>
                        </div>
                    </div>

                    <!-- Detail rows -->
                    <div class="gs-rows">
                        <div class="gs-row">
                            <span class="gs-row-icon" style="color:#00FFFF;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                            </span>
                            <span class="gs-row-label">Total pagado</span>
                            <span class="gs-row-val gs-cyan" id="grpTotalPaid">L. 0</span>
                        </div>
                        <div class="gs-row">
                            <span class="gs-row-icon" style="color:#ef4444;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                            </span>
                            <span class="gs-row-label">Total pendiente</span>
                            <span class="gs-row-val gs-red" id="grpTotalOwed">L. 0</span>
                        </div>
                        <div class="gs-row">
                            <span class="gs-row-icon" style="color:#22c55e;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/></svg>
                            </span>
                            <span class="gs-row-label">Ciclo actual</span>
                            <span class="gs-row-val gs-cyan" id="grpCurrentCycle">--</span>
                        </div>
                        <div class="gs-row" id="grpTandaRow" style="display:none">
                            <span class="gs-row-icon" style="color:#00FFFF;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                            </span>
                            <span class="gs-row-label">Saldo Tanda</span>
                            <span class="gs-row-val" id="grpTandaInline" style="color:#34d399">--</span>
                        </div>
                    </div>
                </div>

                <!-- Mi Saldo Tanda Card -->
                <div class="grp-sidebar-stats" id="grpTandaBalanceCard" style="display:none">
                    <h4 class="grp-sidebar-stats-title">Mi Tanda</h4>
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                        <div style="width:32px;height:32px;background:rgba(0,255,255,0.1);border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#00FFFF" stroke-width="2"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                        </div>
                        <div>
                            <div id="grpTandaBalance" style="font-size:1.2rem;font-weight:700;color:#34d399">--</div>
                            <div id="grpTandaLabel" style="font-size:0.72rem;color:#64748b">Cargando...</div>
                        </div>
                    </div>
                    <div class="gs-rows">
                        <div class="gs-row">
                            <span class="gs-row-icon" style="color:#00FFFF;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l2 2"/></svg>
                            </span>
                            <span class="gs-row-label" id="grpTandaTurno">Turno --</span>
                            <span class="gs-row-val" id="grpTandaPagos" style="color:#888">--</span>
                        </div>
                        <div class="gs-row">
                            <span class="gs-row-icon" style="color:#f59e0b;">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
                            </span>
                            <span class="gs-row-label" id="grpTandaGroup">--</span>
                            <span class="gs-row-val" id="grpTandaDist" style="color:#888">--</span>
                        </div>
                    </div>
                </div>

                <!-- Roles Card -->
                
                <!-- Tandas Tab Sidebar Cards -->
                <div id="tandasSidebarCards" style="display:none;">
                    <!-- Próximo Pago card -->
                    <div class="grp-sidebar-stats" id="tscNextPayment">
                        <h4 class="grp-sidebar-stats-title">Próximo Pago</h4>
                        <div id="tscNextPaymentContent">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                                <div style="width:32px;height:32px;background:rgba(239,68,68,0.15);border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0">
                                    <i class="fas fa-exclamation-circle" style="color:#ef4444;font-size:14px;"></i>
                                </div>
                                <div>
                                    <div id="tscPaymentAmount" style="font-size:1.1rem;font-weight:700;color:#f8fafc">--</div>
                                    <div id="tscPaymentDue" style="font-size:0.72rem;color:#94a3b8">Sin pagos pendientes</div>
                                </div>
                            </div>
                            <div id="tscPaymentGroup" style="font-size:0.75rem;color:#64748b;padding-top:4px;border-top:1px solid rgba(255,255,255,0.06)"></div>
                        </div>
                    </div>
                    <!-- Mi Próximo Cobro card -->
                    <div class="grp-sidebar-stats" id="tscMyCollection">
                        <h4 class="grp-sidebar-stats-title">Mi Próximo Cobro</h4>
                        <div id="tscMyCollectionContent">
                            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                                <div style="width:32px;height:32px;background:rgba(16,185,129,0.15);border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0">
                                    <i class="fas fa-hand-holding-usd" style="color:#10b981;font-size:14px;"></i>
                                </div>
                                <div>
                                    <div id="tscCollectionAmount" style="font-size:1.1rem;font-weight:700;color:#f8fafc">--</div>
                                    <div id="tscCollectionInfo" style="font-size:0.72rem;color:#94a3b8">Sin tandas</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Resumen card -->
                    <div class="grp-sidebar-stats" id="tscSummary">
                        <h4 class="grp-sidebar-stats-title">Resumen Tandas</h4>
                        <div id="tscSummaryContent">
                            <div class="gs-grid">
                                <div class="gs-cell">
                                    <span class="gs-cell-val" id="tscTotalTandas">0</span>
                                    <span class="gs-cell-label">Tandas</span>
                                </div>
                                <div class="gs-cell">
                                    <span class="gs-cell-val gs-cyan" id="tscActiveTandas">0</span>
                                    <span class="gs-cell-label">Activas</span>
                                </div>
                                <div class="gs-cell">
                                    <span class="gs-cell-val" style="color:#10b981" id="tscPaidCycles">0</span>
                                    <span class="gs-cell-label">Pagados</span>
                                </div>
                                <div class="gs-cell">
                                    <span class="gs-cell-val gs-amber" id="tscPendingCycles">0</span>
                                    <span class="gs-cell-label">Pendientes</span>
                                </div>
                            </div>
                            <div class="gs-rows" style="margin-top:8px">
                                <div class="gs-row">
                                    <span class="gs-row-icon" style="color:#00FFFF;">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                                    </span>
                                    <span class="gs-row-label">Total pagado</span>
                                    <span class="gs-row-val gs-cyan" id="tscTotalPaid">L. 0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grp-sidebar-stats" id="grpSidebarRoles">
                    <h4 class="grp-sidebar-stats-title">Mis Roles</h4>
                    <div class="gs-roles">
                        <div class="gs-role-pill gs-role-creator">
                            <span class="gs-role-count" id="grpRoleCreator">0</span>
                            <span class="gs-role-label">Creador</span>
                        </div>
                        <div class="gs-role-pill gs-role-coord">
                            <span class="gs-role-count" id="grpRoleCoord">0</span>
                            <span class="gs-role-label">Coord.</span>
                        </div>
                        <div class="gs-role-pill gs-role-member">
                            <span class="gs-role-count" id="grpRoleMember">0</span>
                            <span class="gs-role-label">Miembro</span>
                        </div>
                    </div>
                </div>

                <!-- Next Payment Card -->
                <div class="grp-sidebar-stats" id="grpSidebarNextPayment" style="display:none;">
                    <h4 class="grp-sidebar-stats-title">Proximo Pago</h4>
                    <div class="gs-next-payment">
                        <div class="gs-next-group" id="grpNextPayGroup">--</div>
                        <div class="gs-next-details">
                            <div class="gs-next-amount" id="grpNextPayAmount">L. 0</div>
                            <div class="gs-next-date" id="grpNextPayDate">--</div>
                        </div>
                        <div class="gs-next-countdown" id="grpNextPayCountdown"></div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="grp-sidebar-stats" id="grpSidebarActions">
                    <h4 class="grp-sidebar-stats-title">Acciones</h4>
                    <div class="gs-actions">
                        <button class="gs-action-btn" data-action="switch-groups-tab" data-tab="create">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                            Crear Grupo
                        </button>
                        <button class="gs-action-btn gs-action-secondary" data-action="gs-view-invitations">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                            Ver Invitaciones
                        </button>
                    </div>
                </div>
            </div>
        </aside>

    </div> <!-- /dashboard-3col -->

    <!-- Core Scripts -->
    <script src="notification-system.js"></script>
    <script src="loading-manager.js"></script>
    <script src="error-handler.js"></script>
    <script src="create-group-form-handler-v2.js?v=20260221001"></script>
    <script src="group-duplication-system.js"></script>

    <!-- Group Templates System -->
    <script>
        // Plantillas de grupos precreadas
        const groupTemplates = {
            'familiar-small': {
                name: "Grupo Familiar ",
                description: "Grupo cooperativo entre familiares para ahorros y apoyo mutuo",
                type: "familiar",
                contribution: 1500,
                frequency: "monthly",
                maxParticipants: 8,
                location: "",
                virtualMeetings: true
            },
            'laboral': {
                name: "Tanda de Oficina ",
                description: "Grupo cooperativo entre compañeros de trabajo",
                type: "laboral",
                contribution: 2000,
                frequency: "biweekly",
                maxParticipants: 12,
                location: "",
                virtualMeetings: true
            },
            'comunitario': {
                name: "Tanda Comunitaria ",
                description: "Grupo cooperativo de vecinos para proyectos comunitarios",
                type: "comunitario",
                contribution: 500,
                frequency: "monthly",
                maxParticipants: 30,
                location: "",
                virtualMeetings: false
            },
            'comercial': {
                name: "Red de Emprendedores ",
                description: "Grupo cooperativo de pequeños negocios para financiamiento mutuo",
                type: "comercial",
                contribution: 5000,
                frequency: "biweekly",
                maxParticipants: 15,
                location: "",
                virtualMeetings: true
            },
            'tanda-rapida': {
                name: "Tanda Rápida Semanal",
                description: "Ciclo corto de ahorro semanal para necesidades inmediatas",
                type: "familiar",
                contribution: 500,
                frequency: "weekly",
                maxParticipants: 10,
                location: "",
                virtualMeetings: true
            }
        };

        // Función para mostrar el modal de plantillas
        function showTemplateModal() {
            const modal = document.getElementById('template-modal');
            if (modal) {
                modal.style.display = 'flex'; modal.classList.add('active');
                setTimeout(() => {
                    modal.classList.add('active');
                }, 10);
            }
        }

        // Función para cerrar el modal de plantillas
        function closeTemplateModal() {
            const modal = document.getElementById('template-modal');
            if (modal) {
                modal.classList.remove('active');
                setTimeout(() => {
                    modal.style.display = 'none'; modal.classList.remove('active');
                }, 300);
            }
        }

        // Función para seleccionar una plantilla
        function selectGroupTemplate(templateId) {

            if (templateId === 'custom') {
                // Usuario quiere empezar desde cero
                closeTemplateModal();
                return;
            }

            const template = groupTemplates[templateId];
            if (!template) {
                return;
            }

            // Pre-llenar formulario con datos de la plantilla
            const groupNameInput = document.getElementById('group-name');
            const groupDescInput = document.getElementById('group-description');
            const groupTypeSelect = document.getElementById('group-type');
            const contributionInput = document.getElementById('contribution');
            const frequencySelect = document.getElementById('payment-frequency');
            const maxParticipantsInput = document.getElementById('max-participants');

            if (groupNameInput) groupNameInput.value = template.name;
            if (groupDescInput) {
                groupDescInput.value = template.description;
                // Actualizar contador de caracteres
                const charCounter = document.getElementById('desc-count');
                if (charCounter) charCounter.textContent = template.description.length;
            }
            if (groupTypeSelect) groupTypeSelect.value = template.type;
            if (contributionInput) contributionInput.value = template.contribution;
            if (frequencySelect) frequencySelect.value = template.frequency;
            if (maxParticipantsInput) maxParticipantsInput.value = template.maxParticipants;

            // Seleccionar reuniones virtuales
            const virtualMeetingValue = template.virtualMeetings ? 'yes' : 'no';
            const virtualMeetingRadio = document.querySelector(`input[name="virtual-meetings"][value="${virtualMeetingValue}"]`);
            if (virtualMeetingRadio) virtualMeetingRadio.checked = true;


            // Cerrar modal
            closeTemplateModal();

            // Mostrar notificación
            if (typeof showToast === 'function') {
                showToast('Plantilla cargada. Puedes modificar todos los valores.', 'success');
            }
        }

        // Event listener para cerrar modal con botón X
        document.addEventListener('DOMContentLoaded', function() {
            const closeBtn = document.querySelector('.modal-close-templates');
            if (closeBtn) {
                closeBtn.addEventListener('click', closeTemplateModal);
            }

            // Cerrar modal al hacer clic fuera del contenido
            const modalOverlay = document.getElementById('template-modal');
            if (modalOverlay) {
                modalOverlay.addEventListener('click', function(e) {
                    if (e.target === modalOverlay) {
                        closeTemplateModal();
                    }
                });
            }
        });

        // Mostrar modal automáticamente cuando se entra al tab "Create Group"
        // Esta función se llama desde el sistema de navegación de tabs
        function onCreateGroupTabActivated() {
            // Solo mostrar modal si no hay datos en el formulario
            const groupNameInput = document.getElementById('group-name');
            if (groupNameInput && !groupNameInput.value) {
                showTemplateModal();
            }
        }

        // Hook para interceptar cambio de tab a "Create Group"
        const originalSwitchTab = typeof switchTab !== 'undefined' ? switchTab : null;
        if (originalSwitchTab) {
            window.switchTab = function(tabName) {
                originalSwitchTab(tabName);
                if (tabName === 'create') {
                    setTimeout(onCreateGroupTabActivated, 300);
                }
            };
        }

    </script>


    <script>
// Load position requests for awaiting_positions groups
(function() {

    async function loadPositionRequestsForGroup(groupId) {
        try {
            const authToken = localStorage.getItem("auth_token") || '';

            const response = await fetch(`/api/groups/position-requests?group_id=${groupId}`, {
                headers: { ...getAuthHeaders(),
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                }
            });

            const data = await response.json();

            if (data.success && data.data && data.data.requests) {
                const requests = data.data.requests;
                const pendingRequests = requests.filter(r => r.status === 'pending');

                updatePendingRequestsDisplay(groupId, pendingRequests);

                return pendingRequests;
            } else {
                updatePendingRequestsDisplay(groupId, []);
                return [];
            }
        } catch (error) {
            updatePendingRequestsDisplay(groupId, []);
            return [];
        }
    }

    function updatePendingRequestsDisplay(groupId, pendingRequests) {
        const groupCard = document.querySelector(`[data-group-id="${groupId}"]`);
        if (!groupCard) {
            return;
        }

        const positionSection = groupCard.querySelector('.position-assignment-section');
        if (!positionSection) {
            return;
        }

        let container = positionSection.querySelector('.pending-requests-list');
        if (!container) {
            const header = positionSection.querySelector('.position-header');
            if (header) {
                container = document.createElement('div');
                container.className = 'pending-requests-list';
                header.insertAdjacentElement('afterend', container);
            } else {
                return;
            }
        }

        if (pendingRequests.length > 0) {
            const requestsHTML = pendingRequests.map(request => `
                <div class="request-card" data-request-id="${request.id}">
                    <div class="request-header">
                        <div class="request-user">
                            <div class="request-avatar">${(request.user_name || 'User').charAt(0).toUpperCase()}</div>
                            <div class="request-info">
                                <div class="request-name">${escapeHtml(request.user_name || request.user_id)}</div>
                                <div class="request-position-badge">Posición #${request.requested_position}</div>
                            </div>
                        </div>
                        <div class="request-actions">
                            <button class="btn-approve" data-action="grp-approve-position" data-group-id="${groupId}" data-request-id="${request.id}">✓</button>
                            <button class="btn-reject" data-action="grp-reject-position" data-group-id="${groupId}" data-request-id="${request.id}">✕</button>
                        </div>
                    </div>
                    ${request.reason ? `<div class="request-reason">"${escapeHtml(request.reason)}"</div>` : ''}
                    <div class="request-timestamp">${formatRequestDate ? formatRequestDate(request.created_at) : new Date(request.created_at).toLocaleDateString()}</div>
                </div>
            `).join('');

            container.innerHTML = requestsHTML;
        } else {
            container.innerHTML = '<div class="no-requests">✅ No hay solicitudes pendientes</div>';
        }
    }

    function initializePositionRequests() {
        const positionSections = document.querySelectorAll('.position-assignment-section');

        positionSections.forEach(section => {
            const groupCard = section.closest('[data-group-id]');
            if (groupCard) {
                const groupId = groupCard.getAttribute('data-group-id');
                loadPositionRequestsForGroup(groupId);
            }
        });
    }

    // Re-init position requests when groups re-render
    window.addEventListener('groupsRendered', () => {
        setTimeout(initializePositionRequests, 500);
    });

})();

    

// ========================================
// Create advancedGroupsSystem object if it doesn not exist
if (typeof advancedGroupsSystem === 'undefined') {
    if (typeof window.advancedGroupsSystem === "undefined") {
        window.advancedGroupsSystem = {};
    }
}

// TANDAS TAB FUNCTIONALITY
// ========================================

// Global state for tandas

// ========== DASHBOARD UPDATE FUNCTION ==========
// [REMOVED] updateTandasDashboard + payNextDue — replaced by updateTandasSidebar



// ===== FASE 3: LISTA DE PAGOS URGENTES =====
// [REMOVED] renderUrgentPayments — info now in tanda card alerts
// [REMOVED] renderCurrentCollectors — info now in tanda card stats
// ===== FIN FASE 3 & 4 =====

// ===== FASE 5: MODAL DE PAGO RAPIDO =====
let currentPaymentTanda = null;
let userWalletBalance = 0;

async function quickPay(tandaId) {
    
    const tanda = window.tandasData ? window.tandasData.find(t => t.tanda_id === tandaId) : null;
    
    if (!tanda) {
        showToast("No se encontró la tanda: " + tandaId, "error");
        return;
    }
    
    currentPaymentTanda = tanda;
    
    // Fetch wallet balance
    let walletBalance = 0;
    try {
        const response = await fetch("/api/wallet/balance", {
            headers: { ...getAuthHeaders()
            }
        });
        if (response.ok) {
            const data = await response.json();
            walletBalance = parseFloat(data.balance || data.available || 0);
        }
    } catch (e) {
    }
    
    userWalletBalance = walletBalance;
    const amount = parseFloat(tanda.contribution_amount || tanda.amount || 0);
    const collector = tanda.current_collector || tanda.collecting_member;
    const beneficiaryName = collector ? (collector.name || collector.full_name || "Participante") : "Por definir";
    const dueDate = tanda.next_payment_date 
        ? new Date(tanda.next_payment_date.split("T")[0] + "T12:00:00").toLocaleDateString("es-HN", { day: "numeric", month: "long", year: "numeric" })
        : "Sin fecha";
    
    const insufficientFunds = walletBalance < amount;
    
    const content = `
        <div class="payment-summary" style="background: rgba(0,255,255,0.05); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <div class="summary-row" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <span style="color: #888;">Tanda:</span>
                <strong style="color: #fff;">${escapeHtml(tanda.name || tanda.group_name || '')}</strong>
            </div>
            <div class="summary-row" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <span style="color: #888;">Monto:</span>
                <strong style="color: #00ffff;">L. ${amount.toLocaleString("es-HN", { minimumFractionDigits: 2 })}</strong>
            </div>
            <div class="summary-row" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <span style="color: #888;">Beneficiario:</span>
                <strong style="color: #fff;">${escapeHtml(beneficiaryName)}</strong>
            </div>
            <div class="summary-row" style="display: flex; justify-content: space-between; padding: 10px 0;">
                <span style="color: #888;">Vencimiento:</span>
                <strong style="color: #fff;">${dueDate}</strong>
            </div>
        </div>
        
        <div class="wallet-info" style="background: rgba(0,255,255,0.1); border-radius: 8px; padding: 15px; margin-bottom: 20px; text-align: center;">
            <span style="color: #00ffff;">💰 Saldo disponible: L. ${walletBalance.toLocaleString("es-HN", { minimumFractionDigits: 2 })}</span>
            ${insufficientFunds ? '<div style="color: #ff6b6b; margin-top: 10px;">⚠️ Fondos insuficientes para pago con billetera</div>' : ''}
        </div>
        
        <div class="payment-methods" style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 10px; cursor: pointer;">
                <input type="radio" name="modalPaymentMethod" value="wallet" ${insufficientFunds ? '' : 'checked'} style="margin-right: 10px;">
                <span>💳 Billetera La Tanda</span>
            </label>
            <label style="display: flex; align-items: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; cursor: pointer;">
                <input type="radio" name="modalPaymentMethod" value="transfer" ${insufficientFunds ? 'checked' : ''} style="margin-right: 10px;">
                <span>🏦 Transferencia Bancaria</span>
            </label>
        </div>
    `;
    
    window.advancedGroupsSystem.showModal({
        title: '💳 Realizar Pago',
        content: content,
        size: 'medium',
        buttons: [
            { text: 'Cancelar', class: 'btn-secondary', action: 'grp-hide-modal' },
            { text: 'Pagar Ahora', class: 'btn-primary', action: 'modal-process-payment' }
        ]
    });
}

async function processModalPayment() {
    if (!currentPaymentTanda) {
        showToast("Error: No hay tanda seleccionada", "error");
        return;
    }
    
    const selectedMethod = document.querySelector("input[name='modalPaymentMethod']:checked");
    if (!selectedMethod) {
        showToast("Selecciona un método de pago", "warning");
        return;
    }
    
    const amount = parseFloat(currentPaymentTanda.contribution_amount || currentPaymentTanda.amount || 0);
    const tandaId = currentPaymentTanda.tanda_id || currentPaymentTanda.id || currentPaymentTanda.group_id;
    
    // Show loading in modal
    const modalContent = document.querySelector('.modal-content');
    if (modalContent) {
        modalContent.innerHTML = '<div style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin" style="font-size: 40px; color: #00ffff;"></i><p style="margin-top: 20px;">Procesando pago...</p></div>';
    }
    
    try {
        const payload = {
            tanda_id: tandaId,
            amount: amount,
            payment_method: selectedMethod.value
        };
        
        const response = await fetch("/api/tandas/pay", {
            method: "POST",
            headers: { ...getAuthHeaders(),
                "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            window.advancedGroupsSystem.hideModal();
            showToast("¡Pago realizado exitosamente!", "success");
            currentPaymentTanda = null;
            if (typeof refreshTandas === "function") {
                refreshTandas();
            }
        } else {
            throw new Error("Error al procesar el pago");
        }
    } catch (error) {
        showToast("Error al procesar el pago", "error");
        window.advancedGroupsSystem.hideModal();
    }
}



// ===== FASE 6: HISTORIAL PERSONAL =====
let historyData = { payments: [], collections: [] };
let currentHistoryTab = "payments";

async function openHistoryModal() {
    
    // Show loading modal first
    window.advancedGroupsSystem.showModal({
        title: '📜 Historial de Pagos',
        content: '<div style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin" style="font-size: 40px; color: #00ffff;"></i><p style="margin-top: 20px;">Cargando historial...</p></div>',
        size: 'large'
    });
    
    let payments = [];
    let collections = [];
    
    try {
        // Fetch payments sent
        const paymentsResponse = await fetch("/api/payments/history?type=sent", {
            headers: { ...getAuthHeaders()
            }
        });
        if (paymentsResponse.ok) {
            const data = await paymentsResponse.json();
            payments = data.payments || (data.data && data.data.payments) || [];
        }
        
        // Fetch collections received
        const collectionsResponse = await fetch("/api/payments/history?type=received", {
            headers: { ...getAuthHeaders()
            }
        });
        if (collectionsResponse.ok) {
            const data = await collectionsResponse.json();
            collections = data.payments || (data.data && data.data.payments) || [];
        }
    } catch (error) {
    }
    
    // Store for tab switching
    window.historyModalData = { payments, collections };
    
    const content = `
        <div class="history-tabs" style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button class="history-tab active" data-action="grp-switch-history-tab" data-htab="payments" id="tab-payments" 
                style="flex: 1; padding: 12px; background: #00ffff; color: #000; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                📤 Pagos Enviados (${payments.length})
            </button>
            <button class="history-tab" data-action="grp-switch-history-tab" data-htab="collections" id="tab-collections"
                style="flex: 1; padding: 12px; background: rgba(255,255,255,0.1); color: #fff; border: none; border-radius: 8px; cursor: pointer;">
                📥 Cobros Recibidos (${collections.length})
            </button>
        </div>
        
        <div id="history-payments" class="history-list" style="max-height: 400px; overflow-y: auto;">
            ${payments.length ? payments.map(p => `
                <div class="history-item" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 10px;">
                    <div style="flex: 1;">
                        <div style="color: #fff; font-weight: bold;">${escapeHtml(p.tanda_name || p.group_name || 'Tanda')}</div>
                        <div style="color: #888; font-size: 12px;">${escapeHtml(p.recipient || 'Participante')}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: #ff6b6b; font-weight: bold;">-L. ${parseFloat(p.amount || 0).toLocaleString('es-HN', {minimumFractionDigits: 2})}</div>
                        <div style="color: #888; font-size: 12px;">${p.date ? new Date(p.date).toLocaleDateString('es-HN') : ''}</div>
                    </div>
                </div>
            `).join('') : '<div style="text-align: center; padding: 40px; color: #888;"><i class="fas fa-inbox" style="font-size: 40px; margin-bottom: 10px;"></i><p>No hay pagos enviados</p></div>'}
        </div>
        
        <div id="history-collections" class="history-list" style="max-height: 400px; overflow-y: auto; display: none;">
            ${collections.length ? collections.map(c => `
                <div class="history-item" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 10px;">
                    <div style="flex: 1;">
                        <div style="color: #fff; font-weight: bold;">${escapeHtml(c.tanda_name || c.group_name || 'Tanda')}</div>
                        <div style="color: #888; font-size: 12px;">${escapeHtml(c.sender || 'Participante')}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: #00ff88; font-weight: bold;">+L. ${parseFloat(c.amount || 0).toLocaleString('es-HN', {minimumFractionDigits: 2})}</div>
                        <div style="color: #888; font-size: 12px;">${c.date ? new Date(c.date).toLocaleDateString('es-HN') : ''}</div>
                    </div>
                </div>
            `).join('') : '<div style="text-align: center; padding: 40px; color: #888;"><i class="fas fa-inbox" style="font-size: 40px; margin-bottom: 10px;"></i><p>No hay cobros recibidos</p></div>'}
        </div>
    `;
    
    window.advancedGroupsSystem.showModal({
        title: '📜 Historial de Pagos',
        content: content,
        size: 'large',
        buttons: [
            { text: 'Cerrar', class: 'btn-secondary', action: 'grp-hide-modal' }
        ]
    });
}

window.tandasData = [];
window.filteredTandas = [];

// 1. REFRESH TANDAS (Main loader)
// ===== mergeTandaWithGroup helper =====
function mergeTandaWithGroup(tanda) {
    var group = (window.currentGroupsData || []).find(function(g) { return g.id === tanda.group_id; });
    if (!group) return tanda;
    return Object.assign({}, tanda, {
        role: group.my_role || tanda.role || 'member',
        // Tanda API is authoritative for payment data (uses centralized helper + correct grace period)
        payment_status: tanda.payment_status || group.my_payment_status || 'unknown',
        // Let renderTandaCard generate alerts from correct tanda data
        alerts: [],
        commission_rate_custom: group.commission_rate,
        next_payment_grace_deadline: tanda.next_payment_grace_deadline || group.my_next_payment_grace_deadline || null,
        category: group.category || tanda.category,
        location: group.location || tanda.location,
        frequency_label: group.frequency || tanda.frequency,
        max_members: group.max_members || tanda.max_members,
        group_status: group.status || tanda.group_status
    });
}

// ===== updateTandasSidebar =====
function updateTandasSidebar(tandas) {
    var recruitingTandas = tandas.filter(function(t) { return t.status === 'recruiting' || t.status === 'pending' || t.status === 'scheduled'; });
    var activeTandas = tandas.filter(function(t) { return t.status === 'active' || t.status === 'waiting-turn' || t.status === 'collecting' || t.status === 'paused'; });

    // === Próximo Pago ===
    var payAmountEl = document.getElementById('tscPaymentAmount');
    var payDueEl = document.getElementById('tscPaymentDue');
    var payGroupEl = document.getElementById('tscPaymentGroup');
    var payCard = document.getElementById('tscNextPayment');

    var pendingPayments = activeTandas.filter(function(t) { return t.next_payment_date; }).sort(function(a, b) { return new Date(a.next_payment_date) - new Date(b.next_payment_date); });

    if (pendingPayments.length > 0) {
        var next = pendingPayments[0];
        var dateStr = next.next_payment_date;
        var dueDate = new Date(typeof dateStr === 'string' && dateStr.length === 10 ? dateStr + 'T12:00:00' : dateStr);
        var todayNoon = new Date(); todayNoon.setHours(12, 0, 0, 0);
        var daysLeft = Math.round((dueDate - todayNoon) / 86400000);
        if (payAmountEl) payAmountEl.textContent = 'L. ' + (next.contribution_amount || 0).toLocaleString('es-HN');
        if (payDueEl) {
            if (daysLeft <= 0) {
                var graceDeadline = next.next_payment_grace_deadline || next.my_next_payment_grace_deadline;
                if (graceDeadline) {
                    var graceDaysLeft = Math.ceil((new Date(graceDeadline + 'T23:59:59') - new Date()) / 86400000);
                    if (graceDaysLeft > 0) {
                        payDueEl.textContent = 'Vencido. Gracia: ' + graceDaysLeft + 'd';
                        payDueEl.style.color = '#f59e0b';
                    } else {
                        payDueEl.textContent = 'Atrasado';
                        payDueEl.style.color = '#ef4444';
                    }
                } else {
                    payDueEl.textContent = 'Vencido';
                    payDueEl.style.color = '#ef4444';
                }
            } else {
                payDueEl.textContent = 'Vence en ' + daysLeft + ' d\u00eda' + (daysLeft !== 1 ? 's' : '');
                payDueEl.style.color = daysLeft <= 3 ? '#ef4444' : daysLeft <= 7 ? '#f59e0b' : '#94a3b8';
            }
        }
        if (payGroupEl) payGroupEl.textContent = next.group_name || '';
    } else if (recruitingTandas.length > 0) {
        if (payAmountEl) payAmountEl.textContent = 'Pendiente';
        if (payDueEl) { payDueEl.textContent = 'Esperando inicio'; payDueEl.style.color = '#94a3b8'; }
        if (payGroupEl) payGroupEl.textContent = '';
    } else {
        if (payAmountEl) payAmountEl.textContent = '--';
        if (payDueEl) { payDueEl.textContent = 'Sin pagos pendientes'; payDueEl.style.color = '#94a3b8'; }
        if (payGroupEl) payGroupEl.textContent = '';
    }

    // === Mi Próximo Cobro ===
    var collAmountEl = document.getElementById('tscCollectionAmount');
    var collInfoEl = document.getElementById('tscCollectionInfo');

    var myCollection = activeTandas.find(function(t) { return t.is_my_turn || t.isMyTurn; });
    if (myCollection) {
        var total = (myCollection.contribution_amount || 0) * (myCollection.total_participants || 1);
        if (collAmountEl) collAmountEl.textContent = 'L. ' + total.toLocaleString('es-HN');
        if (collInfoEl) collInfoEl.textContent = '¡Te toca cobrar!';
    } else if (activeTandas.length > 0) {
        var turnsAway = activeTandas
            .map(function(t) { return { turns: Math.max(0, (t.my_turn_position || 1) - (t.current_turn || 1)), amount: (t.contribution_amount || 0) * (t.total_participants || 1) }; })
            .filter(function(t) { return t.turns > 0; })
            .sort(function(a, b) { return a.turns - b.turns; })[0];
        if (turnsAway) {
            if (collAmountEl) collAmountEl.textContent = 'En ' + turnsAway.turns + ' turno' + (turnsAway.turns > 1 ? 's' : '');
            if (collInfoEl) collInfoEl.textContent = '~L. ' + turnsAway.amount.toLocaleString('es-HN');
        } else {
            if (collAmountEl) collAmountEl.textContent = '--';
            if (collInfoEl) collInfoEl.textContent = 'Ciclo completado';
        }
    } else {
        if (collAmountEl) collAmountEl.textContent = '--';
        if (collInfoEl) collInfoEl.textContent = 'Sin tandas';
    }

    // === Resumen ===
    var totalEl = document.getElementById('tscTotalTandas');
    var activeEl = document.getElementById('tscActiveTandas');
    var paidEl = document.getElementById('tscPaidCycles');
    var pendEl = document.getElementById('tscPendingCycles');
    var totalPaidEl = document.getElementById('tscTotalPaid');

    var paidCount = tandas.reduce(function(s, t) { return s + (t.my_contributions_paid || 0); }, 0);
    var totalCount = tandas.reduce(function(s, t) { return s + (t.my_contributions_total || t.total_participants || 0); }, 0);
    var totalPaid = tandas.reduce(function(s, t) { return s + ((t.my_contributions_paid || 0) * (t.contribution_amount || 0)); }, 0);

    if (totalEl) totalEl.textContent = tandas.length;
    if (activeEl) activeEl.textContent = activeTandas.length;
    if (paidEl) paidEl.textContent = paidCount;
    if (pendEl) pendEl.textContent = Math.max(0, totalCount - paidCount);
    if (totalPaidEl) totalPaidEl.textContent = 'L. ' + totalPaid.toLocaleString('es-HN');
}

// ===== refreshTandas (rewritten with merge + sidebar) =====
async function refreshTandas() {
    try {
        var container = document.getElementById('tandasList');
        if (!container) return;

        container.innerHTML = '<div class="loading-state"><div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div><p class="loading-text">Cargando tus tandas...</p></div>';

        var allTandas = [];
        try {
            var response = await fetch('/api/tandas/my-tandas', { headers: Object.assign({}, getAuthHeaders()) });
            if (response.ok) {
                var data = await response.json();
                if (data.success && (data.tandas || (data.data && data.data.tandas))) {
                    allTandas = data.tandas || data.data.tandas || [];
                }
            }
        } catch(apiError) { /* network error */ }

        // Merge with group data
        allTandas = allTandas.map(mergeTandaWithGroup);

        window.tandasData = allTandas;
        window.filteredTandas = allTandas.slice();

        if (window.tandasData.length === 0) {
            var userGroupCount = window.currentGroupsData ? window.currentGroupsData.length : 0;
            if (userGroupCount === 0) {
                showTandasEmptyState('NO_GROUPS');
            } else {
                showTandasEmptyState('NO_TANDAS', userGroupCount);
            }
            updateTandasSidebar([]);
            return;
        }

        updateTandasSidebar(window.tandasData);
        renderTandas();
        startTandaLotteryCountdowns();

    } catch (error) {
        showTandasEmptyState('Error al cargar tandas. Intenta de nuevo.');
    }
}

// 2. RENDER TANDAS
function renderTandas() {
    var container = document.getElementById('tandasList');
    if (!container) return;

    if (!window.filteredTandas || window.filteredTandas.length === 0) {
        // Check if there are tandas but filtered to 0
        if (window.tandasData && window.tandasData.length > 0) {
            container.innerHTML = '<div class="tandas-empty-state"><div class="empty-icon" style="font-size:3rem;margin-bottom:16px;">🔍</div><h3 style="color:#f8fafc;margin-bottom:8px;">Sin resultados</h3><p style="color:#94a3b8;margin-bottom:16px;">Ninguna tanda coincide con tus filtros.</p><button class="btn btn-outline" data-action="grp-clear-tanda-filters"><i class="fas fa-times"></i> Limpiar Filtros</button></div>';
        } else {
            showTandasEmptyState('No tienes tandas activas.');
        }
        return;
    }

    var htmlParts = [];
    for (var i = 0; i < window.filteredTandas.length; i++) {
        htmlParts.push(renderTandaCard(window.filteredTandas[i]));
    }
    container.innerHTML = htmlParts.join('');
}

// 3. RENDER TANDA CARD
// Get lottery status badge for tanda card
function getLotteryBadge(tanda) {
    if (!tanda) return "";

    // Only show for recruiting/pending status
    if (tanda.status !== "recruiting" && tanda.status !== "pending") {
        return "";
    }

    if (tanda.lottery_executed) {
        return '<span style="background: rgba(16,185,129,0.2); color: #10b981; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; display: inline-flex; align-items: center; gap: 4px;"><i class="fas fa-check-circle"></i> Posiciones asignadas</span>';
    }

    if (tanda.lottery_scheduled_at) {
        return '<span style="background: rgba(245,158,11,0.2); color: #f59e0b; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; display: inline-flex; align-items: center; gap: 4px;" data-countdown="' + tanda.lottery_scheduled_at + '" data-tanda-id="' + tanda.tanda_id + '"><i class="fas fa-dice"></i> <span class="countdown-timer">Cargando...</span></span>';
    }

    return '<span style="background: rgba(107,114,128,0.2); color: #9ca3af; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; display: inline-flex; align-items: center; gap: 4px;"><i class="fas fa-clock"></i> Tómbola pendiente</span>';
}


// Get goal reached badge for tanda card
function getGoalBadge(tanda) {
    if (!tanda) return "";
    
    // Check if recruiting and members_joined >= members_needed
    const membersJoined = tanda.members_joined || 0;
    const membersNeeded = tanda.members_needed || tanda.total_participants || 999;
    
    if ((tanda.status === "recruiting" || tanda.status === "pending") && membersJoined >= membersNeeded) {
        return '<span class="badge badge-goal-reached" style="margin-left: 4px;">🎯 Meta alcanzada</span>';
    }
    
    return "";
}

function renderTandaCard(tanda) {
    var statusLabels = {
        'active': 'Activa', 'waiting-turn': 'Esperando Turno', 'collecting': 'Cobrando',
        'completed': 'Completada', 'recruiting': 'Reclutando', 'pending': 'Pendiente',
        'scheduled': 'Programada', 'paused': 'Pausada'
    };
    var statusColors = {
        'active': '#00FFFF', 'waiting-turn': '#f59e0b', 'collecting': '#10b981',
        'completed': '#22c55e', 'recruiting': '#f59e0b', 'pending': '#f59e0b',
        'scheduled': '#f59e0b', 'paused': '#94a3b8'
    };
    var roleLabels = { 'creator': 'Creador', 'coordinator': 'Coordinador', 'member': 'Miembro' };
    var roleClasses = { 'creator': 'gc-role-creator', 'coordinator': 'gc-role-coord', 'member': 'gc-role-member' };

    var statusLabel = statusLabels[tanda.status] || tanda.status;
    var statusColor = statusColors[tanda.status] || '#94a3b8';
    var isRecruiting = tanda.status === 'recruiting' || tanda.status === 'pending' || tanda.status === 'scheduled';
    var isCoordinator = tanda.is_coordinator === true;

    // Role from merged group data or fallback
    var role = tanda.role || (isCoordinator ? 'coordinator' : 'member');
    var roleLabel = roleLabels[role] || 'Miembro';
    var roleClass = roleClasses[role] || 'gc-role-member';

    // Avatar
    var groupName = tanda.group_name || 'T';
    var avatarLetter = groupName.charAt(0).toUpperCase();
    var avatarBg = statusColor;

    // Payout breakdown
    var effectiveCommRate = tanda.commission_rate != null ? tanda.commission_rate : (tanda.commission_rate_custom != null ? tanda.commission_rate_custom : null);
    var tandaPayout = calculatePayoutBreakdown(tanda.contribution_amount || 0, tanda.max_members || tanda.total_participants || 1, effectiveCommRate);

    // Progress
    var membersJoined = tanda.members_joined || 1;
    var membersNeeded = tanda.members_needed || tanda.total_participants || 1;
    var progressText, progressPercent;
    if (isRecruiting) {
        progressText = 'Miembros ' + membersJoined + '/' + membersNeeded;
        progressPercent = Math.round((membersJoined / membersNeeded) * 100);
    } else {
        progressText = 'Ciclo ' + (tanda.current_cycle || tanda.current_turn || 1) + '/' + (tanda.total_participants || 1);
        progressPercent = tanda.progress_percentage || 0;
    }

    // Collecting member name (fix raw JSON)
    var collectingMember = isRecruiting ? '—' : (tanda.collecting_member || '—');

    // Stats
    var paidCount = tanda.my_contributions_paid || 0;
    var totalCount = tanda.my_contributions_total || tanda.total_participants || 0;
    var nextPaymentFormatted = isRecruiting ? 'Pendiente' : formatTandaDate(tanda.next_payment_date);

    // Stat 1 + 2 (top row)
    var stat1Label, stat1Val, stat2Label, stat2Val;
    if (isRecruiting) {
        stat1Label = 'Aporte'; stat1Val = _gcFmtL(tanda.contribution_amount);
        stat2Label = 'Turnos Asignados'; stat2Val = (tanda.turns_assigned || 0) + '/' + membersNeeded;
    } else {
        stat1Label = 'Aporte'; stat1Val = _gcFmtL(tanda.contribution_amount);
        stat2Label = 'Mi Turno'; stat2Val = tanda.has_turn_assigned ? 'Pos #' + tanda.my_turn_position : 'Pendiente';
    }
    // Stat 3 + 4 (bottom row)
    var stat3Label, stat3Val, stat4Label, stat4Val;
    if (isRecruiting) {
        stat3Label = 'Frecuencia'; stat3Val = escapeHtml(tanda.frequency_label || tanda.frequency || '--');
        stat4Label = 'Estado'; stat4Val = statusLabel;
    } else {
        stat3Label = 'Pagado'; stat3Val = paidCount + '/' + totalCount;
        stat4Label = 'Prox. Pago'; stat4Val = nextPaymentFormatted;
    }

    // Alert banners — API alerts cover the full cycle, no frontend duplication needed
    var alertsHtml = '';
    var alerts = tanda.alerts || [];
    // Only add frontend-generated alerts if API didn't already provide them
    if (!isRecruiting && alerts.length === 0) {
        if (tanda.payment_status === 'late' || tanda.payment_status === 'suspension_recommended') {
            alerts = [{ severity: 'danger', message: 'Pago atrasado' }];
        } else if (tanda.payment_status === 'pending') {
            // In grace period — due date passed but grace deadline hasn't
            var graceDeadline = tanda.next_payment_grace_deadline || tanda.my_next_payment_grace_deadline;
            if (graceDeadline) {
                var graceDaysLeft = Math.ceil((new Date(graceDeadline + 'T23:59:59') - new Date()) / 86400000);
                if (graceDaysLeft > 0) {
                    alerts = [{ severity: 'warning', message: 'Pago vencido. ' + graceDaysLeft + ' d\u00eda' + (graceDaysLeft !== 1 ? 's' : '') + ' de gracia restantes' }];
                } else {
                    alerts = [{ severity: 'danger', message: 'Pago atrasado. Periodo de gracia vencido' }];
                }
            }
        } else if (tanda.payment_status === 'up_to_date') {
            var dueDate = tanda.next_payment_date;
            if (dueDate) {
                var todayNoon = new Date(); todayNoon.setHours(12, 0, 0, 0);
                var daysUntil = Math.round((new Date(dueDate.length === 10 ? dueDate + 'T12:00:00' : dueDate) - todayNoon) / 86400000);
                if (daysUntil <= 5 && daysUntil > 0) {
                    var sev = daysUntil <= 2 ? 'warning' : 'info';
                    alerts = [{ severity: sev, message: 'Tu pago vence en ' + daysUntil + ' d\u00eda' + (daysUntil !== 1 ? 's' : '') }];
                }
            }
        }
    }
    alerts.forEach(function(a) {
        var sevClass = a.severity === 'danger' ? 'gc-alert-danger' : a.severity === 'warning' ? 'gc-alert-warning' : a.severity === 'success' ? 'gc-alert-success' : 'gc-alert-info';
        var icon = a.severity === 'danger' ? '&#9888;' : a.severity === 'warning' ? '&#9888;' : a.severity === 'success' ? '&#10003;' : '&#8505;';
        alertsHtml += '<div class="gc-alert ' + sevClass + '">' + icon + ' ' + escapeHtml(a.message || '') + '</div>';
    });

    // Action buttons
    var actionsHtml = '';
    if (isRecruiting && isCoordinator) {
        actionsHtml = '<button class="btn btn-sm btn-success" data-action="grp-start-tanda" data-tanda-id="' + escapeHtml(String(tanda.tanda_id || '')) + '"><i class="fas fa-play"></i> Iniciar</button>' +
            '<button class="btn btn-sm btn-outline" data-action="grp-invite-to-tanda" data-tanda-id="' + escapeHtml(String(tanda.tanda_id || '')) + '"><i class="fas fa-user-plus"></i> Invitar</button>';
    } else if (isRecruiting) {
        actionsHtml = '<button class="btn btn-sm btn-outline" data-action="grp-view-tanda-details" data-tanda-id="' + escapeHtml(String(tanda.tanda_id || '')) + '"><i class="fas fa-eye"></i> Ver Detalles</button>' +
            '<span class="tc-waiting"><i class="fas fa-clock"></i> ' + (tanda.has_turn_assigned ? 'Esperando inicio' : 'Sin turno') + '</span>';
    } else {
        actionsHtml = '<button class="btn btn-sm btn-secondary" data-action="grp-open-history"><i class="fas fa-history"></i> Historial</button>' +
            '<button class="btn btn-sm btn-outline" data-action="grp-view-tanda-details" data-tanda-id="' + escapeHtml(String(tanda.tanda_id || '')) + '"><i class="fas fa-eye"></i> Detalles</button>' +
            '<button class="btn btn-sm btn-primary" data-action="grp-make-tanda-payment" data-tanda-id="' + escapeHtml(String(tanda.tanda_id || '')) + '"><i class="fas fa-money-bill-wave"></i> Pagar</button>';
    }

    // Lottery/goal badges
    var badgesHtml = getLotteryBadge(tanda) + getGoalBadge(tanda);

    return '<div class="group-card" style="border-left:4px solid ' + statusColor + ';" data-tanda-id="' + escapeHtml(String(tanda.tanda_id || '')) + '">' +
        // Header: Avatar + Name + Role
        '<div class="gc-header">' +
            '<div class="gc-avatar" style="background:' + avatarBg + ';color:#000;">' + avatarLetter + '</div>' +
            '<div class="gc-header-text">' +
                '<h3 class="gc-name">' + escapeHtml(groupName) + '</h3>' +
                '<div class="gc-sub">' + escapeHtml(({'weekly':'Semanal','biweekly':'Quincenal','monthly':'Mensual','daily':'Diario'})[((tanda.frequency_label || tanda.frequency || '')).toLowerCase()] || tanda.frequency_label || tanda.frequency || '') + (statusLabel ? ' &middot; ' + statusLabel : '') + '</div>' +
            '</div>' +
            '<span class="gc-role ' + roleClass + '">' + roleLabel + '</span>' +
        '</div>' +
        // Payout bar (tc-specific)
        '<div class="tc-payout">' +
            '<span class="tc-payout-label">Recibes (' + (tandaPayout.commission_rate > 0 ? '-' + parseFloat(tandaPayout.commission_rate.toFixed(1)) + '% comisión' : 'sin comisión') + ')</span>' +
            '<span class="tc-payout-amount">L. ' + formatTandaNumber(tandaPayout.user_receives) + '</span>' +
        '</div>' +
        // Progress bar
        '<div class="tc-progress">' +
            '<div class="tc-progress-info"><span>' + progressText + '</span><span>' + progressPercent + '%</span></div>' +
            '<div class="tc-progress-bar"><div class="tc-progress-fill" style="width:' + progressPercent + '%;"></div></div>' +
        '</div>' +
        // Badges (lottery/goal) - only for recruiting
        (badgesHtml ? '<div style="padding:0 16px 4px;display:flex;gap:6px;flex-wrap:wrap;">' + badgesHtml + '</div>' : '') +
        // Stats grid 2x2
        '<div class="gc-stats">' +
            '<div class="gc-stat"><span class="gc-stat-val">' + stat1Val + '</span><span class="gc-stat-label">' + stat1Label + '</span></div>' +
            '<div class="gc-stat"><span class="gc-stat-val">' + stat2Val + '</span><span class="gc-stat-label">' + stat2Label + '</span></div>' +
            '<div class="gc-stat"><span class="gc-stat-val">' + stat3Val + '</span><span class="gc-stat-label">' + stat3Label + '</span></div>' +
            '<div class="gc-stat"><span class="gc-stat-val">' + stat4Val + '</span><span class="gc-stat-label">' + stat4Label + '</span></div>' +
        '</div>' +
        // Alerts
        alertsHtml +
        // Actions
        '<div class="gc-actions">' + actionsHtml + '</div>' +
    '</div>';
}

function filterAndSortTandas() {
    if (!window.tandasData) return;

    var statusFilter = document.getElementById('tandasStatusFilter');
    var sortOrder = document.getElementById('tandasSortOrder');
    var searchInput = document.getElementById('searchTandas');

    var statusVal = statusFilter ? statusFilter.value : 'all';
    var sortVal = sortOrder ? sortOrder.value : 'next-payment';
    var searchQuery = (searchInput ? searchInput.value : '').toLowerCase().trim();

    var filtered = window.tandasData.slice();

    // Status filter
    if (statusVal !== 'all') {
        filtered = filtered.filter(function(t) {
            if (statusVal === 'recruiting') return t.status === 'recruiting' || t.status === 'pending' || t.status === 'scheduled';
            return t.status === statusVal;
        });
    }

    // Search filter
    if (searchQuery) {
        filtered = filtered.filter(function(t) {
            return (t.group_name || '').toLowerCase().indexOf(searchQuery) !== -1;
        });
    }

    // Sort
    switch(sortVal) {
        case 'next-payment':
            filtered.sort(function(a, b) { return new Date(a.next_payment_date || '9999') - new Date(b.next_payment_date || '9999'); });
            break;
        case 'amount':
            filtered.sort(function(a, b) { return (b.contribution_amount || 0) - (a.contribution_amount || 0); });
            break;
        case 'turn-position':
            filtered.sort(function(a, b) { return (a.my_turn_position || 999) - (b.my_turn_position || 999); });
            break;
    }

    window.filteredTandas = filtered;
    renderTandas();
}

// Keep legacy names for compatibility
function filterTandas() { filterAndSortTandas(); }
function sortTandas() { filterAndSortTandas(); }

// 6. SHOW TANDA HISTORY
function showTandaHistory() {
    openHistoryModal();
}

// 7. VIEW TANDA DETAILS

// START TANDA (coordinator only)
// Store current tanda info for modal
let currentStartTandaId = null;
let currentStartGroupId = null;

async function startTanda(tandaId) {
    // Get tanda info to find group_id
    const tanda = (window.tandasData || []).find(t => t.tanda_id === tandaId);
    if (!tanda) {
        showError("No se encontro la tanda");
        return;
    }
    
    currentStartTandaId = tandaId;
    currentStartGroupId = tanda.group_id;
    
    // Show modal and load summary
    await openStartTandaModal(tandaId, tanda.group_id);
}

async function openStartTandaModal(tandaId, groupId) {
    try {
        const token = localStorage.getItem("auth_token") || sessionStorage.getItem("auth_token") || "";
        const response = await fetch("/api/groups/" + groupId + "/start-summary", {
            headers: { "Authorization": "Bearer " + token }
        });
        
        const result = await response.json();
        if (!result.success) {
            showError("Error al cargar la informacion del grupo");
            return;
        }
        
        const data = result.data;
        
        // Populate modal
        document.getElementById("stm-group-name").textContent = data.group_name || "Sin nombre";
        document.getElementById("stm-members").textContent = data.member_count + "/" + data.max_members;
        document.getElementById("stm-amount").textContent = "L " + (data.contribution_amount || 0) + " " + (data.frequency || "semanal");
        document.getElementById("stm-duration").textContent = data.total_duration || "N/A";
        
        // Lottery warning
        const warningBox = document.getElementById("stm-lottery-warning");
        warningBox.style.display = data.lottery_executed ? "none" : "flex";
        
        // Turns list
        const turnsList = document.getElementById("stm-turns-list");
        turnsList.innerHTML = "";
        (data.members_with_positions || []).forEach((m, idx) => {
            const li = document.createElement("li");
            li.textContent = m.name;
            turnsList.appendChild(li);
        });
        
        // Set min datetime for scheduler (now + 5 minutes)
        const minDate = new Date(Date.now() + 5 * 60000);
        document.getElementById("stm-start-datetime").min = minDate.toISOString().slice(0, 16);
        
        // Show modal
        document.getElementById("startTandaModalOverlay").classList.add("active");
        
    } catch (error) {
        showError("Error de conexion:  Intenta de nuevo.");
    }
}

function closeStartTandaModal() {
    document.getElementById("startTandaModalOverlay").classList.remove("active");
    document.getElementById("stm-schedule-section").classList.remove("show");
    currentStartTandaId = null;
    currentStartGroupId = null;
}

function toggleScheduleSection() {
    document.getElementById("stm-schedule-section").classList.toggle("show");
}

async function confirmStartTandaNow() {
    if (!currentStartTandaId) return;
    
    try {
        const userId = getCurrentUserId();
        const response = await fetch("/api/tandas/start", {
            method: "POST",
            headers: { ...getAuthHeaders(),
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                tanda_id: currentStartTandaId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            closeStartTandaModal();
            showSuccess("Tanda iniciada exitosamente! El primer turno ha comenzado.");
            refreshTandas();
        } else {
            showError("No se pudo iniciar la tanda");
        }
    } catch (error) {
        showError("Error de conexion:  Intenta de nuevo.");
    }
}

async function confirmScheduleTandaStart() {
    if (!currentStartTandaId) return;
    
    const dateInput = document.getElementById("stm-start-datetime").value;
    if (!dateInput) {
        showWarning("Por favor selecciona una fecha y hora");
        return;
    }
    
    try {
        const userId = getCurrentUserId();
        const response = await fetch("/api/tandas/" + currentStartTandaId + "/schedule-start", {
            method: "POST",
            headers: { ...getAuthHeaders(),
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                start_at: new Date(dateInput).toISOString()
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            closeStartTandaModal();
            showSuccess("Tanda programada! Iniciara el " + new Date(dateInput).toLocaleString("es-ES"));
            refreshTandas();
        } else {
            showError("No se pudo programar la tanda");
        }
    } catch (error) {
        showError("Error de conexion:  Intenta de nuevo.");
    }
}

// Tombola countdown animation
function startLotteryCountdown() {
    if (!currentStartGroupId) {
        showError("No se ha seleccionado un grupo");
        return;
    }

    // Create overlay for animation
    const overlay = document.createElement("div");
    overlay.id = "tombola-overlay";
    overlay.style.cssText = "position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center;";

    const counter = document.createElement("div");
    counter.style.cssText = "font-size: 120px; color: #f59e0b; font-weight: bold; text-shadow: 0 0 30px rgba(245,158,11,0.5);";
    counter.textContent = "3";

    const message = document.createElement("div");
    message.style.cssText = "font-size: 24px; color: white; margin-top: 20px;";
    message.textContent = "Mezclando turnos...";

    const dice = document.createElement("div");
    dice.style.cssText = "font-size: 80px; margin-top: 30px; animation: spin 0.5s linear infinite;";
    dice.textContent = "🎲";

    // Add spin animation
    const style = document.createElement("style");
    style.textContent = "@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }";
    document.head.appendChild(style);

    overlay.appendChild(counter);
    overlay.appendChild(message);
    overlay.appendChild(dice);
    document.body.appendChild(overlay);

    let count = 3;
    const interval = setInterval(function() {
        count--;
        if (count > 0) {
            counter.textContent = count.toString();
        } else if (count === 0) {
            counter.textContent = "🎲";
            message.textContent = "Ejecutando tombola...";
        } else {
            clearInterval(interval);
            // Execute the lottery
            executeLotteryFromModal().then(function() {
                // Remove overlay after small delay
                setTimeout(function() {
                    if (overlay.parentNode) {
                        overlay.parentNode.removeChild(overlay);
                    }
                    style.remove();
                }, 500);
            }).catch(function(err) {
                if (overlay.parentNode) {
                    overlay.parentNode.removeChild(overlay);
                }
                style.remove();
                showError("Error en tombola:  Intenta de nuevo.");
            });
        }
    }, 1000);
}


async function executeLotteryFromModal() {
    if (!currentStartGroupId) return;
    
    try {
        const userId = getCurrentUserId();
        const response = await fetch("/api/groups/" + currentStartGroupId + "/lottery-assign", {
            method: "POST",
            headers: { ...getAuthHeaders(),
                "Content-Type": "application/json"
            },
            body: JSON.stringify({})
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess("Tombola ejecutada! Los turnos han sido asignados.");
            // Reload modal with updated data
            await openStartTandaModal(currentStartTandaId, currentStartGroupId);

            // Refresh tandas and groups to sync everywhere
            if (typeof refreshTandas === 'function') {
                refreshTandas();
            }
            if (typeof fetchMyGroups === 'function') {
                fetchMyGroups().then(() => {
                    if (typeof renderGroups === 'function') renderGroups();
                }).catch(function() {});
            }
        } else {
            showError("Error al ejecutar la tombola");
        }
    } catch (error) {
        showError("Error de conexion:  Intenta de nuevo.");
    }
}

// INVITE TO TANDA
function inviteToTanda(tandaId) {
    const tanda = (window.tandasData || []).find(t => t.tanda_id === tandaId);
    if (!tanda) return;
    
    showInviteModal(tanda.group_id);
}

function viewTandaDetails(tandaId) {
    const tanda = (window.tandasData || tandasData).find(t => t.tanda_id === tandaId);
    if (!tanda) {
        return;
    }

    showNotification("Detalles de tanda en desarrollo", "info");
}

// 8. MAKE TANDA PAYMENT
function makeTandaPayment(tandaId) {
    const tanda = (window.tandasData || tandasData).find(t => t.tanda_id === tandaId);
    if (!tanda) {
        return;
    }

    quickPay(tandaId);
}

// HELPER FUNCTIONS
function showTandasEmptyState(stateOrMessage, groupCount) {
    const container = document.getElementById("tandasList");
    if (!container) return;

    let html = "";

    if (stateOrMessage === "NO_GROUPS") {
        html = `
            <div class="tandas-empty-state">
                <div class="empty-icon" style="font-size: 4rem; margin-bottom: 20px;">👥</div>
                <h3 style="color: #f8fafc; margin-bottom: 12px;">Aún no perteneces a ningún grupo</h3>
                <p style="color: #9ca3af; margin-bottom: 24px;">Únete a un grupo existente o crea uno nuevo para comenzar tu primera tanda.</p>
                <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-primary" data-action="grp-switch-tab" data-tab="groups" style="padding: 12px 24px;">
                        <i class="fas fa-search"></i> Explorar Grupos
                    </button>
                    <button class="btn btn-outline" data-action="grp-switch-tab" data-tab="create" style="padding: 12px 24px;">
                        <i class="fas fa-plus"></i> Crear Grupo
                    </button>
                </div>
            </div>
        `;
    } else if (stateOrMessage === "NO_TANDAS") {
        html = `
            <div class="tandas-empty-state">
                <div class="empty-icon" style="font-size: 4rem; margin-bottom: 20px;">⏳</div>
                <h3 style="color: #f8fafc; margin-bottom: 12px;">Tus grupos aún no tienen tandas activas</h3>
                <p style="color: #9ca3af; margin-bottom: 24px;">Estás en ${groupCount || 1} grupo(s). El coordinador debe activar la tanda para comenzar.</p>
                <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-primary" data-action="grp-switch-tab" data-tab="my-groups" style="padding: 12px 24px;">
                        <i class="fas fa-users"></i> Ver Mis Grupos
                    </button>
                </div>
            </div>
        `;
    } else {
        // Default/error state - use message
        html = `
            <div class="tandas-empty-state">
                <div class="empty-icon" style="font-size: 4rem; margin-bottom: 20px;">💰</div>
                <h3 style="color: #f8fafc; margin-bottom: 12px;">No hay tandas</h3>
                <p style="color: #9ca3af; margin-bottom: 24px;">${escapeHtml(stateOrMessage)}</p>
                <button class="btn btn-primary" data-action="grp-switch-tab" data-tab="groups" style="padding: 12px 24px;">
                    <i class="fas fa-search"></i> Explorar Grupos
                </button>
            </div>
        `;
    }

    container.innerHTML = html;
}

function formatTandaDate(dateString) {
    if (!dateString || dateString === "null") return "Pendiente";
    try {
        // Handle YYYY-MM-DD (no timezone shift) and ISO strings
        var date;
        if (typeof dateString === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
            // Pure date string — parse at noon to avoid timezone shift
            date = new Date(dateString + 'T12:00:00');
        } else {
            date = new Date(dateString);
        }
        return date.toLocaleDateString("es-HN", {
            day: "numeric",
            month: "short",
            year: "numeric"
        });
    } catch (e) {
        return dateString;
    }
}

function formatTandaNumber(num) {
    try {
        return new Intl.NumberFormat("es-HN").format(num);
    } catch (e) {
        return num;
    }
}

// Add tandas functions to global scope for onclick handlers
// Add tandas functions to global scope - DEFERRED until system ready

// Lottery countdown functionality for tanda cards

// =============================================
// LOTTERY LIVE ANIMATION SYSTEM
// =============================================

// Show lottery animation overlay
function // Show animation with updated data structure
                    showLotteryAnimation(groupName, members, results, myTurn) {
    // Remove existing overlay if any
    const existingOverlay = document.querySelector('.lottery-animation-overlay');
    if (existingOverlay) existingOverlay.remove();

    // Create overlay
    const overlay = document.createElement('div');
    overlay.className = 'lottery-animation-overlay';

    // Build members HTML
    const membersHtml = members.map((member, idx) => {
        const result = results.find(r => r.member_id === member.id);
        const turnNum = result ? result.turn_number : '?';
        return '<div class="lottery-member" data-member-id="' + member.id + '">' +
               '<span class="member-name">' + escapeHtml(member.name) + '</span>' +
               '<span class="turn-number">#' + escapeHtml(String(turnNum)) + '</span>' +
               '</div>';
    }).join('');

    overlay.innerHTML =
        '<div class="lottery-container">' +
            '<h2 class="lottery-title"><i class="fas fa-dice"></i> TOMBOLA EN VIVO</h2>' +
            '<p style="color: #9ca3af; margin-bottom: 1rem;">' + escapeHtml(groupName) + '</p>' +
            '<div class="lottery-wheel">' +
                '<div class="lottery-pointer"></div>' +
                '<div class="lottery-wheel-inner">' +
                    '<div class="lottery-wheel-center"><i class="fas fa-dice"></i></div>' +
                '</div>' +
            '</div>' +
            '<div class="lottery-members">' + membersHtml + '</div>' +
            '<div class="lottery-results">' +
                '<h4><i class="fas fa-check-circle"></i> Posiciones Asignadas</h4>' +
                (myTurn ?
                    '<div class="lottery-your-turn">' +
                        '<p style="margin: 0 0 0.5rem 0; opacity: 0.8;">Tu turno asignado:</p>' +
                        '<h3><i class="fas fa-trophy"></i> #' + myTurn + '</h3>' +
                    '</div>'
                : '') +
                '<button class="lottery-close-btn" data-action="grp-close-lottery"><i class="fas fa-check"></i> Continuar</button>' +
            '</div>' +
        '</div>';

    document.body.appendChild(overlay);

    // Activate overlay
    setTimeout(() => overlay.classList.add('active'), 100);

    // Animate members one by one
    const memberElements = overlay.querySelectorAll('.lottery-member');
    results.forEach((result, idx) => {
        setTimeout(() => {
            const memberEl = overlay.querySelector('[data-member-id="' + result.member_id + '"]');
            if (memberEl) {
                memberEl.classList.add('assigned');
                // Play sound if available
                playLotterySound();
            }
        }, 3000 + (idx * 500)); // Start after wheel spin (3s) + stagger
    });

    // Show results after all animations
    setTimeout(() => {
        const resultsEl = overlay.querySelector('.lottery-results');
        if (resultsEl) resultsEl.classList.add('show');
    }, 3000 + (results.length * 500) + 500);
}

function closeLotteryAnimation() {
    const overlay = document.querySelector('.lottery-animation-overlay');
    if (overlay) {
        overlay.classList.remove('active');
        setTimeout(() => overlay.remove(), 500);
    }
    // Refresh tandas to show updated data
    if (typeof refreshTandas === 'function') {
        refreshTandas();
    }
}

function playLotterySound() {
    try {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + 0.2);
    } catch (e) {
        // Audio not supported, ignore
    }
}

// Poll for lottery execution (when countdown reaches zero)
function pollForLotteryExecution(tandaId, groupId) {
    let pollCount = 0;
    const maxPolls = 30; // Poll for 30 seconds max

    const pollInterval = setInterval(async () => {
        pollCount++;

        if (pollCount > maxPolls) {
            clearInterval(pollInterval);
            refreshTandas();
            return;
        }

        try {
            const token = localStorage.getItem('auth_token') || localStorage.getItem('authToken');
            const response = await fetch('/api/groups/' + groupId + '/lottery-results', {
                headers: { 'Authorization': 'Bearer ' + token }
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success && data.data?.executed && data.data?.results) {
                    clearInterval(pollInterval);

                    // Get current user's turn
                    const userId = getCurrentUserId();
                    const myResult = data.data.results.find(r => r.user_id === userId);
                    const myTurn = myResult ? myResult.turn_number : null;

                    // Show animation
                    showLotteryAnimation(
                        data.data?.tanda_name || 'Tanda',
                        data.data?.results?.map(r => ({id: r.user_id, name: r.name})) || [],
                        data.data.results.map(r => ({member_id: r.user_id, turn_number: r.position})),
                        myTurn
                    );
                }
            }
        } catch (error) {
        }
    }, 1000);
}
// getCurrentUserId() - Now provided by LaTandaAuth in shared-components.js (removed duplicate)

function startTandaLotteryCountdowns() {
    if (window._countdownIntervals) {
        window._countdownIntervals.forEach(function(id) { clearInterval(id); });
    }
    window._countdownIntervals = [];
    const countdownElements = document.querySelectorAll('[data-countdown]');

    countdownElements.forEach(el => {
        const scheduledAt = new Date(el.dataset.countdown);
        const timerSpan = el.querySelector('.countdown-timer');

        if (!timerSpan) return;

        function updateCountdown() {
            const now = new Date();
            const diff = scheduledAt - now;

            if (diff <= 0) {
                timerSpan.textContent = 'Iniciando...';
                // Start polling for lottery results
                const tandaId = el.dataset.tandaId;
                if (tandaId) {
                    const groupId = el.closest('.tanda-card')?.dataset?.groupId;
                    if (groupId) pollForLotteryExecution(tandaId, groupId);
                }
                // Refresh tandas after a short delay
                setTimeout(() => {
                    if (typeof refreshTandas === 'function') {
                        refreshTandas();
                    }
                }, 2000);
                return;
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const secs = Math.floor((diff % (1000 * 60)) / 1000);

            if (days > 0) {
                timerSpan.textContent = days + 'd ' + hours + 'h';
            } else if (hours > 0) {
                timerSpan.textContent = hours + 'h ' + mins + 'm';
            } else {
                timerSpan.textContent = mins + ':' + (secs < 10 ? '0' : '') + secs;
            }
        }

        updateCountdown();
        window._countdownIntervals.push(setInterval(updateCountdown, 1000));
    });
}

// Call after rendering tandas
window.startTandaLotteryCountdowns = startTandaLotteryCountdowns;

function attachTandasFunctions() {
    // Ensure window.advancedGroupsSystem exists
    if (!window.advancedGroupsSystem) {
        window.advancedGroupsSystem = {};
    }
    
    // Assign all tandas functions
    window.advancedGroupsSystem.refreshTandas = refreshTandas;
    window.refreshTandas = refreshTandas;
    window.filterTandas = filterTandas;
    window.sortTandas = sortTandas;
    window.advancedGroupsSystem.filterTandas = filterTandas;
    window.advancedGroupsSystem.sortTandas = sortTandas;
    window.advancedGroupsSystem.showTandaHistory = showTandaHistory;
    window.viewTandaDetails = viewTandaDetails;
    window.advancedGroupsSystem.viewTandaDetails = viewTandaDetails;
    window.makeTandaPayment = makeTandaPayment;
    window.quickPay = quickPay;
    window.openHistoryModal = openHistoryModal;
    window.advancedGroupsSystem.makeTandaPayment = makeTandaPayment;

    // ========== SHOWMODAL / HIDEMODAL ==========
    if (!window.advancedGroupsSystem.showModal) {
        window.advancedGroupsSystem.showModal = function(options) {
            var title = options.title || "Modal";
            var content = options.content || "";
            var size = options.size || "large";
            var buttons = options.buttons || [];
            
            var existing = document.getElementById("modalOverlay");
            if (existing) existing.remove();

            var maxWidth = size === "large" ? "800px" : size === "medium" ? "600px" : "400px";
            
            var buttonsHtml = "";
            if (buttons.length > 0) {
                buttonsHtml = "<div class=\"modal-footer\" style=\"padding:20px;border-top:1px solid rgba(255,255,255,0.1);display:flex;gap:10px;justify-content:flex-end;\">";
                buttons.forEach(function(btn) {
                    var btnStyle = btn.class === "btn-primary" 
                        ? "background:linear-gradient(135deg,#00ffff,#00d4aa);color:#000;" 
                        : "background:rgba(255,255,255,0.1);color:#fff;";
                    buttonsHtml += "<button class=\"" + (btn.class || "btn-secondary") + "\" data-action=\"" + (btn.action || "grp-hide-modal") + "\" style=\"padding:12px 24px;border-radius:8px;border:none;cursor:pointer;font-weight:500;" + btnStyle + "\">" + escapeHtml(btn.text || '') + "</button>";
                });
                buttonsHtml += "</div>";
            }
            
            var modalHTML = "<div class=\"modal-overlay active\" id=\"modalOverlay\" style=\"visibility:visible;opacity:1;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:99999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);\">" +
                "<div class=\"modal-container " + size + "\" id=\"modalContainer\" style=\"background:rgba(15,23,42,0.98);border:1px solid rgba(0,255,255,0.3);border-radius:16px;max-width:" + maxWidth + ";width:90%;max-height:90vh;overflow-y:auto;box-shadow:0 25px 50px rgba(0,0,0,0.5);\">" +
                    "<div class=\"modal-header\" style=\"padding:20px;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;justify-content:space-between;align-items:center;\">" +
                        "<h3 style=\"color:#fff;margin:0;font-size:1.25rem;\">" + escapeHtml(title || '') + "</h3>" +
                        "<button data-action=\"grp-hide-modal\" style=\"background:none;border:none;color:#888;font-size:28px;cursor:pointer;line-height:1;\">&times;</button>" +
                    "</div>" +
                    "<div class=\"modal-content\" style=\"padding:20px;color:#fff;\">" + content + "</div>" +
                    buttonsHtml +
                "</div>" +
            "</div>";
            
            document.body.insertAdjacentHTML("beforeend", modalHTML);
        };
    }

    if (!window.advancedGroupsSystem.hideModal) {
        window.advancedGroupsSystem.hideModal = function() {
            var modal = document.getElementById("modalOverlay");
            if (modal) {
                modal.style.opacity = "0";
                setTimeout(function() { modal.remove(); }, 200);
            }
        };
    }
    // ========== END SHOWMODAL / HIDEMODAL ==========

    // ========== MISSING METHODS FIX - Added 2026-01-17 ==========
    
    // closeModal - Close a specific modal by ID
    if (!window.advancedGroupsSystem.closeModal) {
        window.advancedGroupsSystem.closeModal = function(modalId) {
            var modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = "none";
                modal.classList.remove("active");
            }
        };
    }
    
    // switchSettingsTab - Switch between settings tabs
    if (!window.advancedGroupsSystem.switchSettingsTab) {
        window.advancedGroupsSystem.switchSettingsTab = function(tabName) {
            // Map tab names to IDs
            var tabIds = {
                "general": "generalSettings",
                "notifications": "notificationSettings", 
                "privacy": "privacySettings",
                "appearance": "appearanceSettings",
                "language": "languageSettings"
            };
            
            // Hide all settings tabs
            document.querySelectorAll(".settings-tab").forEach(function(tab) {
                tab.style.display = "none";
            });
            
            // Remove active from all nav buttons
            document.querySelectorAll(".settings-nav-btn").forEach(function(btn) {
                btn.classList.remove("active");
            });
            
            // Show selected tab
            var targetId = tabIds[tabName] || (tabName + "Settings");
            var targetTab = document.getElementById(targetId);
            if (targetTab) {
                targetTab.style.display = "block";
            }
            
            // Activate the clicked button
            event.target.classList.add("active");
        };
    }
    
    // switchWalletTab - Switch between wallet tabs
    if (!window.advancedGroupsSystem.switchWalletTab) {
        window.advancedGroupsSystem.switchWalletTab = function(tabName) {
            // Map tab names to IDs
            var tabIds = {
                "transactions": "walletTransactions",
                "methods": "walletMethods",
                "security": "walletSecurity"
            };
            
            // Hide all wallet tabs
            document.querySelectorAll("#myWalletModal .tab-content").forEach(function(tab) {
                tab.style.display = "none";
            });
            
            // Remove active from all tab buttons
            document.querySelectorAll("#myWalletModal .tab-btn").forEach(function(btn) {
                btn.classList.remove("active");
            });
            
            // Show selected tab
            var targetId = tabIds[tabName] || ("wallet" + tabName.charAt(0).toUpperCase() + tabName.slice(1));
            var targetTab = document.getElementById(targetId);
            if (targetTab) {
                targetTab.style.display = "block";
            }
            
            // Activate clicked button
            if (event && event.target) {
                event.target.classList.add("active");
            }
        };
    }
    
    // quickSearchAction - Handle quick search suggestions
    if (!window.advancedGroupsSystem.quickSearchAction) {
        window.advancedGroupsSystem.quickSearchAction = function(action) {
            advancedGroupsSystem.closeQuickSearch();
            
            switch(action) {
                case "groups-active":
                    if (typeof switchTab === "function") switchTab("mis-grupos");
                    break;
                case "tandas-pending":
                    if (typeof switchTab === "function") switchTab("tandas");
                    break;
                case "payments-due":
                    if (typeof switchTab === "function") switchTab("tandas");
                    break;
                default:
            }
        };
    }
    
    // showHelpCategory - Show a specific help category
    if (!window.advancedGroupsSystem.showHelpCategory) {
        window.advancedGroupsSystem.showHelpCategory = function(category) {
            // Could expand a section or filter FAQs
            var helpContent = document.querySelector(".help-content");
            if (helpContent) {
                var sections = helpContent.querySelectorAll(".faq-section");
                sections.forEach(function(section) {
                    var sectionCategory = section.getAttribute("data-category");
                    if (sectionCategory === category || !sectionCategory) {
                        section.style.display = "block";
                    }
                });
            }
        };
    }
    
    // toggleFAQ - Toggle FAQ accordion item
    if (!window.advancedGroupsSystem.toggleFAQ) {
        window.advancedGroupsSystem.toggleFAQ = function(index) {
            var faqItems = document.querySelectorAll(".faq-item");
            if (faqItems[index]) {
                faqItems[index].classList.toggle("active");
                var answer = faqItems[index].querySelector(".faq-answer");
                if (answer) {
                    answer.style.display = answer.style.display === "none" ? "block" : "none";
                }
            }
        };
    }
    
    // closeUserMenu - Close the user menu panel
    if (!window.advancedGroupsSystem.closeUserMenu) {
        window.advancedGroupsSystem.closeUserMenu = function() {
            var userMenu = document.querySelector(".user-menu-panel");
            if (userMenu) {
                userMenu.classList.remove("active");
                userMenu.style.display = "none";
            }
            var overlay = document.querySelector(".menu-overlay");
            if (overlay) overlay.remove();
        };
    }
    
    // closeNotifications - Close notifications panel
    if (!window.advancedGroupsSystem.closeNotifications) {
        window.advancedGroupsSystem.closeNotifications = function() {
            var panel = document.getElementById("notificationsPanel");
            if (panel) {
                panel.style.display = "none";
                panel.classList.remove("active");
            }
        };
    }
    
    // closeQuickSearch - Close quick search panel  
    if (!window.advancedGroupsSystem.closeQuickSearch) {
        window.advancedGroupsSystem.closeQuickSearch = function() {
            var searchPanel = document.querySelector(".quick-search-panel");
            if (searchPanel) {
                searchPanel.classList.remove("active");
                searchPanel.style.display = "none";
            }
            var searchInput = document.getElementById("quickSearchInput");
            if (searchInput) searchInput.value = "";
        };
    }
    
    // openProfile - Open edit profile modal
    if (!window.advancedGroupsSystem.openProfile) {
        window.advancedGroupsSystem.openProfile = function() {
            advancedGroupsSystem.closeUserMenu();
            var modal = document.getElementById("editProfileModal");
            if (modal) {
                modal.style.display = "flex";
                modal.classList.add("active");
            }
        };
    }
    
    // openHelp - Open help/support modal
    if (!window.advancedGroupsSystem.openHelp) {
        window.advancedGroupsSystem.openHelp = function() {
            advancedGroupsSystem.closeUserMenu();
            var modal = document.getElementById("helpModal");
            if (modal) {
                modal.style.display = "flex";
                modal.classList.add("active");
            } else {
                // Fallback: show help via showModal
                advancedGroupsSystem.showModal({
                    title: "Centro de Ayuda",
                    content: "<p>¿Necesitas ayuda? Contactanos:</p><ul><li>Email: soporte@latanda.online</li><li>WhatsApp: +504 XXXX-XXXX</li></ul>",
                    size: "medium"
                });
            }
        };
    }
    
    // openWalletSettings - Open wallet in settings mode
    if (!window.advancedGroupsSystem.openWalletSettings) {
        window.advancedGroupsSystem.openWalletSettings = function() {
            advancedGroupsSystem.closeUserMenu();
            var modal = document.getElementById("myWalletModal");
            if (modal) {
                modal.style.display = "flex";
                modal.classList.add("active");
            }
        };
    }
    
    // openSecuritySettings - Open security settings
    if (!window.advancedGroupsSystem.openSecuritySettings) {
        window.advancedGroupsSystem.openSecuritySettings = function() {
            advancedGroupsSystem.closeUserMenu();
            var modal = document.getElementById("settingsModal");
            if (modal) {
                modal.style.display = "flex";
                advancedGroupsSystem.switchSettingsTab("privacy");
            }
        };
    }
    
    // openNotificationSettings - Open notification settings
    if (!window.advancedGroupsSystem.openNotificationSettings) {
        window.advancedGroupsSystem.openNotificationSettings = function() {
            advancedGroupsSystem.closeUserMenu();
            var modal = document.getElementById("settingsModal");
            if (modal) {
                modal.style.display = "flex";
                advancedGroupsSystem.switchSettingsTab("notifications");
            }
        };
    }
    
    // openPrivacySettings - Open privacy settings
    if (!window.advancedGroupsSystem.openPrivacySettings) {
        window.advancedGroupsSystem.openPrivacySettings = function() {
            advancedGroupsSystem.closeUserMenu();
            var modal = document.getElementById("settingsModal");
            if (modal) {
                modal.style.display = "flex";
                advancedGroupsSystem.switchSettingsTab("privacy");
            }
        };
    }
    
    // openVerification - Open KYC verification modal
    if (!window.advancedGroupsSystem.openVerification) {
        window.advancedGroupsSystem.openVerification = function() {
            advancedGroupsSystem.closeUserMenu();
            var modal = document.getElementById("kycVerificationModal");
            if (modal) {
                modal.style.display = "flex";
                modal.classList.add("active");
            }
        };
    }
    
    // openFeedback / openFeedbackModal - Open feedback form
    if (!window.advancedGroupsSystem.openFeedback) {
        window.advancedGroupsSystem.openFeedback = function() {
            advancedGroupsSystem.closeUserMenu();
            advancedGroupsSystem.showModal({
                title: "Enviar Feedback",
                content: "<textarea id=\"feedbackText\" placeholder=\"Tu opinión nos ayuda a mejorar...\" style=\"width:100%;height:150px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:#fff;padding:12px;resize:none;\"></textarea>",
                size: "medium",
                buttons: [
                    { text: "Cancelar", class: "btn-secondary", action: "grp-hide-modal" },
                    { text: "Enviar", class: "btn-primary", action: "modal-submit-feedback" }
                ]
            });
        };
        window.advancedGroupsSystem.openFeedbackModal = window.advancedGroupsSystem.openFeedback;
    }
    
    // submitFeedback - Submit feedback form
    if (!window.advancedGroupsSystem.submitFeedback) {
        window.advancedGroupsSystem.submitFeedback = function() {
            var feedback = document.getElementById("feedbackText");
            if (feedback && feedback.value.trim()) {
                advancedGroupsSystem.hideModal();
                // Show success notification
                if (typeof showNotification === "function") {
                    showNotification("¡Gracias por tu feedback!", "success");
                }
            }
        };
    }
    
    // saveSettings - Save settings form
    if (!window.advancedGroupsSystem.saveSettings) {
        window.advancedGroupsSystem.saveSettings = function() {
            // Collect settings from form
            advancedGroupsSystem.closeModal("settingsModal");
            if (typeof showNotification === "function") {
                showNotification("Configuración guardada", "success");
            }
        };
    }
    
    // markAllAsRead - Mark all notifications as read
    if (!window.advancedGroupsSystem.markAllAsRead) {
        window.advancedGroupsSystem.markAllAsRead = function() {
            var notifications = document.querySelectorAll(".notification-item.unread");
            notifications.forEach(function(notif) {
                notif.classList.remove("unread");
            });
            // Update badge
            var badge = document.querySelector(".notification-badge");
            if (badge) badge.style.display = "none";
        };
    }
    
    // startChat - Start chat with support
    if (!window.advancedGroupsSystem.startChat) {
        window.advancedGroupsSystem.startChat = function() {
            window.open("https://wa.me/50412345678?text=Hola, necesito ayuda con La Tanda", "_blank");
        };
    }
    
    // logout - Logout user
    if (!window.advancedGroupsSystem.logout) {
        window.advancedGroupsSystem.logout = function() {
            showConfirm("Estas seguro que deseas cerrar sesion?", function() {
                localStorage.removeItem("auth_token");
                localStorage.removeItem("latanda_user");
                window.location.href = "/auth-enhanced.html";
            });
        };
    }
    
    // ========== END MISSING METHODS FIX ==========

}

// Attach immediately AND on DOM load (defensive)
attachTandasFunctions();

// === Phase 4: Delegated event listeners for converted inline handlers ===
(function() {
    // Form submits
    var editForm = document.getElementById('editGroupForm');
    if (editForm) editForm.addEventListener('submit', function(e) { submitGroupEdit(e); });

    var inviteForm = document.getElementById('inviteForm');
    if (inviteForm) inviteForm.addEventListener('submit', function(e) { submitSimpleInvitation(e); });

    // User search with debounce
    var userSearchInput = document.getElementById('userSearchInput');
    if (userSearchInput) {
        var _userSearchTimer = null;
        userSearchInput.addEventListener('input', function() {
            clearTimeout(_userSearchTimer);
            var val = this.value;
            _userSearchTimer = setTimeout(function() { searchUsersToInvite(val); }, 300);
        });
    }

    // Proof file upload
    var proofFileInput = document.getElementById('proofFileInput');
    if (proofFileInput) proofFileInput.addEventListener('change', function(e) { handleProofUpload(e); });

    // Tanda filters
    var tandasStatusFilter = document.getElementById('tandasStatusFilter');
    if (tandasStatusFilter) tandasStatusFilter.addEventListener('change', function() { if (window.advancedGroupsSystem && typeof window.advancedGroupsSystem.filterTandas === 'function') window.advancedGroupsSystem.filterTandas(); });

    var tandasSortOrder = document.getElementById('tandasSortOrder');
    if (tandasSortOrder) tandasSortOrder.addEventListener('change', function() { if (window.advancedGroupsSystem && typeof window.advancedGroupsSystem.sortTandas === 'function') window.advancedGroupsSystem.sortTandas(); });

    // History filters
    var historyTandaFilter = document.getElementById('historyTandaFilter');
    if (historyTandaFilter) historyTandaFilter.addEventListener('change', function() { if (typeof filterHistory === 'function') filterHistory(); });

    var historyPeriodFilter = document.getElementById('historyPeriodFilter');
    if (historyPeriodFilter) historyPeriodFilter.addEventListener('change', function() { if (typeof filterHistory === 'function') filterHistory(); });
})();
if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", attachTandasFunctions);
} else {
    // DOM already loaded, attach again after a short delay to ensure system is ready
    setTimeout(attachTandasFunctions, 500);
}

    </script>

    <!-- Enhanced Toast Notification System -->
    <div id="toastContainer" style="position: fixed; top: 20px; right: 20px; z-index: 99999; display: flex; flex-direction: column; gap: 10px;"></div>

    <style>
        /* Toast Animations */
        @keyframes toastSlideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes toastSlideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .toast-notification {
            min-width: 300px;
            max-width: 400px;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: toastSlideIn 0.3s ease-out;
            background: #1e293b;
        }

        .toast-notification.removing {
            animation: toastSlideOut 0.3s ease-in forwards;
        }

        .toast-notification.success {
            border-left: 4px solid #10b981;
        }

        .toast-notification.error {
            border-left: 4px solid #ef4444;
        }

        .toast-notification.info {
            border-left: 4px solid #3b82f6;
        }

        .toast-notification.warning {
            border-left: 4px solid #f59e0b;
        }

        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .toast-notification.success .toast-icon {
            background: rgba(16,185,129,0.15);
            color: #10b981;
        }

        .toast-notification.error .toast-icon {
            background: rgba(239,68,68,0.15);
            color: #ef4444;
        }

        .toast-notification.info .toast-icon {
            background: rgba(59,130,246,0.15);
            color: #3b82f6;
        }

        .toast-notification.warning .toast-icon {
            background: rgba(245,158,11,0.15);
            color: #f59e0b;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            color: #f8fafc;
            font-size: 0.9375rem;
            margin-bottom: 2px;
        }

        .toast-message {
            color: #94a3b8;
            font-size: 0.8125rem;
        }

        .toast-close {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 4px;
            margin: -4px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .toast-close:hover {
            background: rgba(255,255,255,0.1);
            color: #e2e8f0;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15,23,42,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99998;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #334155;
            border-top-color: #00FFFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: 16px;
            color: #94a3b8;
            font-size: 0.9375rem;
        }

        /* Button Loading State */
        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-left: 8px;
        }

        /* Smooth transitions for modals */
        .modal-overlay {
            transition: opacity 0.3s ease-out;
        }

        .modal-overlay .modal-content {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }

        /* Ripple effect for buttons */
        .btn-ripple {
            position: relative;
            overflow: hidden;
        }

        .btn-ripple::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
        }

        .btn-ripple:active::before {
            width: 200%;
            height: 200%;
        }

        /* Skeleton loading */
        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
            background-size: 200% 100%;
            animation: skeletonLoading 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes skeletonLoading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Improved form feedback */
        input:invalid:not(:placeholder-shown),
        select:invalid:not(:placeholder-shown) {
            border-color: #ef4444;
        }

        input:valid:not(:placeholder-shown) {
            border-color: #10b981;
        }
    </style>

    <script>
        // Enhanced Toast System
        window.showToast = function(message, type = 'info', duration = 4000) {
            var container = document.getElementById('toastContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toastContainer';
                container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 99999; display: flex; flex-direction: column; gap: 10px;';
                document.body.appendChild(container);
            }

            var icons = {
                success: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>',
                error: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
                info: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>',
                warning: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'
            };

            var titles = {
                success: 'Exito',
                error: 'Error',
                info: 'Informacion',
                warning: 'Advertencia'
            };

            var toast = document.createElement('div');
            toast.className = 'toast-notification ' + type;
            toast.innerHTML = '<div class="toast-icon">' + icons[type] + '</div>' +
                '<div class="toast-content">' +
                '<div class="toast-title">' + titles[type] + '</div>' +
                '<div class="toast-message">' + escapeHtml(message) + '</div>' +
                '</div>' +
                '<button class="toast-close" data-action="grp-toast-close">' +
                '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>' +
                '</button>';

            container.appendChild(toast);

            // Auto remove
            setTimeout(function() {
                if (toast.parentElement) {
                    toast.classList.add('removing');
                    setTimeout(function() {
                        toast.remove();
                    }, 300);
                }
            }, duration);
        };

        // Override existing functions
        window.showSuccess = function(message) {
            window.showToast(message, 'success');
        };

        window.showError = function(message) {
            window.showToast(message, 'error');
        };

        window.showInfo = function(message) {
            window.showToast(message, 'info');
        };

        window.showWarning = function(message) {
            window.showToast(message, 'warning');
        };

        // Loading overlay
        window.showLoadingOverlay = function(text) {
            var overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.className = 'loading-overlay';
            overlay.innerHTML = '<div class="loading-spinner"></div><div class="loading-text">' + escapeHtml(text || 'Cargando...') + '</div>';
            document.body.appendChild(overlay);
        };

        window.hideLoadingOverlay = function() {
            var overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.remove();
        };

        // Confirmation dialog
        window.showConfirm = function(message, onConfirm, onCancel) {
            var overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); justify-content: center; align-items: center; z-index: 100000;';
            overlay.innerHTML = '<div style="background: #0f172a; border: 1px solid rgba(0,255,255,0.2); border-radius: 16px; padding: 24px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.5);">' +
                '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="1.5" style="margin-bottom: 16px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>' +
                '<h3 style="margin: 0 0 8px; color: #f8fafc;">Confirmar Accion</h3>' +
                '<p style="margin: 0 0 24px; color: #94a3b8; white-space: pre-line;">' + escapeHtml(message) + '</p>' +
                '<div style="display: flex; gap: 12px; justify-content: center;">' +
                '<button data-action="grp-confirm-cancel" style="padding: 10px 24px; background: rgba(255,255,255,0.1); color: #e2e8f0; border: none; border-radius: 8px; cursor: pointer;">Cancelar</button>' +
                '<button data-action="grp-confirm-action" style="padding: 10px 24px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer;">Confirmar</button>' +
                '</div></div>';

            window.confirmAction = onConfirm || function(){};
            window.confirmCancel = onCancel || function(){};

            document.body.appendChild(overlay);

            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    overlay.remove();
                    if (onCancel) onCancel();
                }
            });
        };

    </script>


    <!-- Edit Group Modal -->
    <div id="editGroupModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 550px; max-height: 85vh; overflow: hidden;">
            <div class="modal-header" style="background: linear-gradient(135deg, rgba(0,255,255,0.2), rgba(0,255,255,0.05)); color: white; padding: 20px; border-radius: 16px 16px 0 0; position: relative;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 12px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                    </div>
                    <div>
                        <h3 id="editGroupModalTitle" style="margin: 0; font-size: 1.25rem; font-weight: 600;">Editar Grupo</h3>
                        <p style="margin: 4px 0 0; font-size: 0.875rem; opacity: 0.9;">Actualizar informacion del grupo</p>
                    </div>
                </div>
                <button data-action="grp-close-edit" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>

            <form id="editGroupForm">
                <div class="modal-body" style="padding: 24px; max-height: calc(85vh - 180px); overflow-y: auto;">
                    <!-- Loading -->
                    <div id="editGroupLoading" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px;">
                        <div class="spinner" style="width: 40px; height: 40px; border: 3px solid #334155; border-top-color: #00FFFF; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <p style="margin-top: 16px; color: #94a3b8;">Cargando datos...</p>
                    </div>

                    <!-- Success Message -->
                    <div id="editGroupSuccess" style="display: none; text-align: center; padding: 20px;">
                        <div style="width: 60px; height: 60px; background: rgba(0,255,255,0.15); border-radius: 50%; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center;">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#00FFFF" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </div>
                        <h4 style="margin: 0 0 8px; color: #f8fafc;">Grupo Actualizado!</h4>
                        <p style="margin: 0; color: #94a3b8; font-size: 0.875rem;">Los cambios han sido guardados exitosamente.</p>
                    </div>

                    <!-- Form Fields -->
                    <div id="editGroupFormFields" style="display: none;">
                        <!-- Group Name -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; color: #e2e8f0; margin-bottom: 6px; font-size: 0.875rem;">Nombre del Grupo *</label>
                            <input type="text" id="editGroupName" required placeholder="Ej: Tanda Familiar" style="width: 100%; padding: 12px; border: 1px solid #334155; border-radius: 8px; font-size: 0.9375rem; box-sizing: border-box; background: #1e293b; color: #f8fafc;">
                        </div>

                        <!-- Description -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; color: #e2e8f0; margin-bottom: 6px; font-size: 0.875rem;">Descripcion</label>
                            <textarea id="editGroupDescription" rows="3" placeholder="Descripcion del grupo..." style="width: 100%; padding: 12px; border: 1px solid #334155; border-radius: 8px; font-size: 0.9375rem; resize: vertical; box-sizing: border-box; background: #1e293b; color: #f8fafc;"></textarea>
                        </div>

                        <!-- Contribution Amount & Frequency Row -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                            <div>
                                <label style="display: block; font-weight: 500; color: #e2e8f0; margin-bottom: 6px; font-size: 0.875rem;">Contribucion (L.)</label>
                                <input type="number" id="editGroupAmount" min="1" step="0.01" placeholder="200.00" style="width: 100%; padding: 12px; border: 1px solid #334155; border-radius: 8px; font-size: 0.9375rem; box-sizing: border-box; background: #1e293b; color: #f8fafc;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; color: #e2e8f0; margin-bottom: 6px; font-size: 0.875rem;">Frecuencia</label>
                                <select id="editGroupFrequency" style="width: 100%; padding: 12px; border: 1px solid #334155; border-radius: 8px; font-size: 0.9375rem; box-sizing: border-box; background: #1e293b; color: #f8fafc;">
                                    <option value="weekly">Semanal</option>
                                    <option value="biweekly">Quincenal</option>
                                    <option value="monthly">Mensual</option>
                                </select>
                            </div>
                        </div>

                        <!-- Max Members & Location Row -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                            <div>
                                <label style="display: block; font-weight: 500; color: #e2e8f0; margin-bottom: 6px; font-size: 0.875rem;">Max Miembros</label>
                                <input type="number" id="editGroupMaxMembers" min="2" max="50" placeholder="12" style="width: 100%; padding: 12px; border: 1px solid #334155; border-radius: 8px; font-size: 0.9375rem; box-sizing: border-box; background: #1e293b; color: #f8fafc;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; color: #e2e8f0; margin-bottom: 6px; font-size: 0.875rem;">Ubicacion</label>
                                <input type="text" id="editGroupLocation" placeholder="Tegucigalpa" style="width: 100%; padding: 12px; border: 1px solid #334155; border-radius: 8px; font-size: 0.9375rem; box-sizing: border-box; background: #1e293b; color: #f8fafc;">
                            </div>
                        </div>

                        <!-- Fecha de Inicio -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; color: #e2e8f0; margin-bottom: 6px; font-size: 0.875rem;">Fecha de Inicio</label>
                            <input type="date" id="editGroupStartDate" style="width: 100%; padding: 12px; border: 1px solid #334155; border-radius: 8px; font-size: 0.9375rem; box-sizing: border-box; background: #1e293b; color: #f8fafc;">
                            <p style="margin: 4px 0 0; font-size: 0.75rem; color: #64748b;">Fecha en que inicia el ciclo de la tanda</p>
                        </div>

                        <!-- Status -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; color: #e2e8f0; margin-bottom: 6px; font-size: 0.875rem;">Estado del Grupo</label>
                            <select id="editGroupStatus" style="width: 100%; padding: 12px; border: 1px solid #334155; border-radius: 8px; font-size: 0.9375rem; box-sizing: border-box; background: #1e293b; color: #f8fafc;">
                                <option value="active">Activo</option>
                                <option value="paused">Pausado</option>
                                <option value="completed">Completado</option>
                            </select>
                        </div>


                        <!-- v4.11.0: Advance Threshold -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; color: #e2e8f0; margin-bottom: 6px; font-size: 0.875rem;">Umbral de Avance (%)</label>
                            <input type="number" id="editGroupThreshold" min="50" max="100" value="80" placeholder="80" style="width: 100%; padding: 12px; border: 1px solid #334155; border-radius: 8px; font-size: 0.9375rem; box-sizing: border-box; background: #1e293b; color: #f8fafc;">
                            <p style="margin: 4px 0 0; font-size: 0.75rem; color: #64748b;">El ciclo avanza cuando este porcentaje de miembros ha pagado (50-100)</p>
                        </div>

                        <div id="editGroupError" style="display: none; padding: 12px; background: rgba(239,68,68,0.15); color: #fca5a5; border-radius: 8px; font-size: 0.875rem;"></div>
                    </div>
                </div>

                <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid rgba(255,255,255,0.1); background: rgba(15,23,42,0.95); border-radius: 0 0 16px 16px; display: flex; gap: 12px; justify-content: flex-end;" id="editGroupFormFooter">
                    <button type="button" data-action="grp-close-edit" style="padding: 10px 20px; background: rgba(255,255,255,0.1); color: #e2e8f0; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">Cancelar</button>
                    <button type="submit" id="editGroupSubmitBtn" style="padding: 10px 24px; background: linear-gradient(135deg, #00ffff, #00d4aa); color: #000; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <style>
        #editGroupModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        #editGroupModal .modal-content {
            background: #0f172a;
            border: 1px solid rgba(0,255,255,0.15);
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
            width: 90%;
            animation: modalSlideIn 0.3s ease-out;
        }

        #editGroupModal input:focus,
        #editGroupModal select:focus,
        #editGroupModal textarea:focus {
            outline: none;
            border-color: #00FFFF;
            box-shadow: 0 0 0 3px rgba(0, 255, 255, 0.15);
        }

        #editGroupSubmitBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>



    <!-- ===== DELETE GROUP CONFIRMATION MODAL ===== -->
    <div id="deleteGroupModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 99999; justify-content: center; align-items: center;">
        <div class="modal-content" style="max-width: 450px; background: #1a2332; border-radius: 16px; overflow: hidden; margin: 20px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); color: white; padding: 20px; position: relative;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 12px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            <line x1="10" y1="11" x2="10" y2="17"/>
                            <line x1="14" y1="11" x2="14" y2="17"/>
                        </svg>
                    </div>
                    <div>
                        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">Eliminar Grupo</h3>
                        <p style="margin: 4px 0 0; font-size: 0.875rem; opacity: 0.9;">Esta accion es irreversible</p>
                    </div>
                </div>
                <button data-action="grp-close-delete" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            
            <div class="modal-body" style="padding: 24px;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="width: 64px; height: 64px; background: rgba(220,38,38,0.15); border-radius: 50%; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center;">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                    </div>
                    <h4 style="margin: 0 0 8px; color: #f8fafc; font-size: 1.1rem;">¿Estas seguro?</h4>
                    <p style="margin: 0; color: #9ca3af; font-size: 0.9rem;">Vas a eliminar el grupo:</p>
                    <p id="deleteGroupName" style="margin: 8px 0 0; color: #f97316; font-weight: 600; font-size: 1rem;">Nombre del Grupo</p>
                </div>
                
                <div style="background: rgba(245,158,11,0.1); border: 1px solid rgba(251,191,36,0.3); border-radius: 10px; padding: 12px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#d97706" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                            <line x1="12" y1="9" x2="12" y2="13"/>
                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                        <div style="color: #fbbf24; font-size: 0.85rem;">
                            <strong>Nota:</strong> No se puede eliminar grupos con contribuciones registradas. Los grupos activos con dinero deben completar su ciclo.
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px;">
                    <button data-action="grp-close-delete" style="flex: 1; padding: 14px; background: #374151; border: none; border-radius: 10px; color: white; font-size: 0.9375rem; font-weight: 500; cursor: pointer;">
                        Cancelar
                    </button>
                    <button id="confirmDeleteBtn" data-action="grp-confirm-delete" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #dc2626, #991b1b); border: none; border-radius: 10px; color: white; font-size: 0.9375rem; font-weight: 500; cursor: pointer;">
                        Si, Eliminar Grupo
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- ===== END DELETE GROUP MODAL ===== -->

    <!-- ===== MANAGE TURNS MODAL ===== -->
    <div id="manageTurnsModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 99999; justify-content: center; align-items: center;">
        <div class="modal-content" style="max-width: 500px; background: #1a2332; border-radius: 16px; overflow: hidden; margin: 20px; max-height: 80vh;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 20px; position: relative;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 12px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M8 12l2 2 4-4"/>
                        </svg>
                    </div>
                    <div>
                        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">Gestionar Turnos</h3>
                        <p style="margin: 4px 0 0; font-size: 0.875rem; opacity: 0.9;">Arrastra para reordenar</p>
                    </div>
                </div>
                <button data-action="grp-close-manage-turns" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            
            <div class="modal-body" style="padding: 20px; max-height: calc(80vh - 180px); overflow-y: auto;">
                <!-- Loading -->
                <div id="turnsLoading" style="display: none; text-align: center; padding: 40px;">
                    <div class="spinner" style="width: 40px; height: 40px; border: 3px solid #374151; border-top-color: #f59e0b; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                    <p style="margin-top: 16px; color: #9ca3af;">Cargando miembros...</p>
                </div>
                
                <!-- Error -->
                <div id="turnsError" style="display: none; padding: 16px; background: rgba(239,68,68,0.15); border: 1px solid rgba(239,68,68,0.3); border-radius: 10px; color: #fca5a5; text-align: center;"></div>
                
                <!-- Turns List -->
                <div id="turnsContent" style="display: none;"></div>
                
                <!-- Instructions -->
                <div style="margin-top: 16px; padding: 12px; background: #1e293b; border-radius: 10px;">
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#60a5fa" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="16" x2="12" y2="12"/>
                            <line x1="12" y1="8" x2="12.01" y2="8"/>
                        </svg>
                        <div style="color: #9ca3af; font-size: 0.8rem;">
                            Usa las flechas o arrastra los miembros para cambiar el orden de turnos. El numero indica el orden en que recibiran el pago.
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer" style="padding: 16px 20px; border-top: 1px solid #334155; display: flex; gap: 12px;">
                <button data-action="grp-close-manage-turns" style="flex: 1; padding: 12px; background: #374151; border: none; border-radius: 10px; color: white; font-size: 0.9375rem; cursor: pointer;">
                    Cancelar
                </button>
                <button id="saveTurnsBtn" data-action="grp-save-turns" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #f59e0b, #d97706); border: none; border-radius: 10px; color: white; font-size: 0.9375rem; font-weight: 500; cursor: pointer;">
                    Guardar Cambios
                </button>
            </div>
        </div>
    </div>
    <!-- ===== END MANAGE TURNS MODAL ===== -->
    <!-- Register Payment Modal -->
    <div id="registerPaymentModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 520px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden;">
            <div class="modal-header" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; padding: 20px; border-radius: 16px 16px 0 0; position: relative;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 12px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                        </svg>
                    </div>
                    <div>
                        <h3 id="registerPaymentModalTitle" style="margin: 0; font-size: 1.25rem; font-weight: 600;">Registrar Pago</h3>
                        <p id="registerPaymentModalSubtitle" style="margin: 4px 0 0; font-size: 0.875rem; opacity: 0.9;">Contribucion al grupo</p>
                    </div>
                </div>
                <button data-action="grp-close-register-payment" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>

            <!-- Step Indicator -->
            <div id="paymentStepIndicator" style="display: flex; justify-content: center; gap: 8px; padding: 16px; background: rgba(15,23,42,0.95); border-bottom: 1px solid rgba(255,255,255,0.1);">
                <div class="step-dot active" data-step="1" style="width: 10px; height: 10px; border-radius: 50%; background: #059669;"></div>
                <div class="step-dot" data-step="2" style="width: 10px; height: 10px; border-radius: 50%; background: #334155;"></div>
                <div class="step-dot" data-step="3" style="width: 10px; height: 10px; border-radius: 50%; background: #334155;"></div>
            </div>

            <div class="modal-body" style="padding: 24px; flex: 1; overflow-y: auto;">
                
                <!-- STEP 1: Select Method and Amount -->
                <div id="paymentStep1" class="payment-step">
                    <h4 style="margin: 0 0 16px; color: #f8fafc; font-size: 1rem;">Paso 1: Selecciona metodo y monto</h4>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 500; color: #e2e8f0; margin-bottom: 6px; font-size: 0.875rem;">Monto de Contribucion (L.) *</label>
                        <input type="number" id="paymentAmount" required min="1" step="0.01" placeholder="0.00" style="width: 100%; padding: 12px; border: 1px solid #334155; border-radius: 8px; font-size: 1rem; box-sizing: border-box; background: #1e293b; color: #f8fafc;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 500; color: #e2e8f0; margin-bottom: 6px; font-size: 0.875rem;">Metodo de Pago *</label>
                        <div id="paymentMethodCards" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <div class="payment-method-card" data-method="bank_transfer" data-action="grp-select-payment-method" style="border: 2px solid #334155; border-radius: 12px; padding: 16px; cursor: pointer; text-align: center; transition: background 0.2s, border-color 0.2s;">
                                <div style="font-size: 24px; margin-bottom: 8px;">🏦</div>
                                <div style="font-weight: 500; color: #e2e8f0; font-size: 0.875rem;">Transferencia</div>
                            </div>
                            <div class="payment-method-card" data-method="mobile_money" data-action="grp-select-payment-method" style="border: 2px solid #334155; border-radius: 12px; padding: 16px; cursor: pointer; text-align: center; transition: background 0.2s, border-color 0.2s;">
                                <div style="font-size: 24px; margin-bottom: 8px;">📱</div>
                                <div style="font-weight: 500; color: #e2e8f0; font-size: 0.875rem;">Tigo Money</div>
                            </div>
                            <div class="payment-method-card" data-method="cash" data-action="grp-select-payment-method" style="border: 2px solid #334155; border-radius: 12px; padding: 16px; cursor: pointer; text-align: center; transition: background 0.2s, border-color 0.2s;">
                                <div style="font-size: 24px; margin-bottom: 8px;">💵</div>
                                <div style="font-weight: 500; color: #e2e8f0; font-size: 0.875rem;">Efectivo</div>
                            </div>
                            <div class="payment-method-card" data-method="crypto" data-action="grp-select-payment-method" style="border: 2px solid #334155; border-radius: 12px; padding: 16px; cursor: pointer; text-align: center; transition: background 0.2s, border-color 0.2s;">
                                <div style="font-size: 24px; margin-bottom: 8px;">₿</div>
                                <div style="font-weight: 500; color: #e2e8f0; font-size: 0.875rem;">Crypto</div>
                            </div>
                        </div>
                        <input type="hidden" id="paymentMethod" value="">
                    </div>

                    <div id="paymentStep1Error" style="display: none; padding: 12px; background: rgba(239,68,68,0.15); color: #fca5a5; border-radius: 8px; margin-bottom: 16px; font-size: 0.875rem;"></div>
                </div>

                <!-- STEP 2: Instructions -->
                <div id="paymentStep2" class="payment-step" style="display: none;">
                    <h4 style="margin: 0 0 16px; color: #f8fafc; font-size: 1rem;">Paso 2: Realiza el pago</h4>
                    
                    <!-- Reference Code Box -->
                    <div id="referenceCodeBox" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); border-radius: 12px; padding: 16px; margin-bottom: 20px; color: white; text-align: center;">
                        <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 4px;">TU CODIGO DE REFERENCIA</div>
                        <div id="referenceCodeDisplay" style="font-size: 1.1rem; font-weight: 700; font-family: monospace; letter-spacing: 1px;">LT-CNT-XXXX-XXXX</div>
                        <button type="button" data-action="grp-copy-reference" style="margin-top: 10px; background: rgba(255,255,255,0.2); border: none; padding: 6px 12px; border-radius: 6px; color: white; cursor: pointer; font-size: 0.75rem;">
                            📋 Copiar Codigo
                        </button>
                    </div>

                    <!-- Instructions List -->
                    <div id="paymentInstructionsList" style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 16px;">
                        <div style="font-weight: 600; color: #e2e8f0; margin-bottom: 12px;" id="instructionsTitle">Instrucciones</div>
                        <ol id="instructionsSteps" style="margin: 0; padding-left: 20px; color: #94a3b8; font-size: 0.875rem; line-height: 1.8;"></ol>
                    </div>

                    <!-- Bank Details (for transfers) -->
                    <div id="bankDetailsBox" style="display: none; background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3); border-radius: 12px; padding: 16px; margin-top: 16px;">
                        <div style="font-weight: 600; color: #60a5fa; margin-bottom: 12px;">📋 Datos Bancarios</div>
                        <div id="bankDetailsContent" style="font-size: 0.875rem; color: #93c5fd;"></div>
                    </div>

                    <!-- Time indicator -->
                    <div id="verificationTimeBox" style="display: flex; align-items: center; gap: 8px; margin-top: 16px; padding: 12px; background: rgba(245,158,11,0.1); border-radius: 8px;">
                        <span style="font-size: 1.2rem;">⏱️</span>
                        <span id="verificationTimeText" style="font-size: 0.875rem; color: #fbbf24;"></span>
                    </div>
                </div>

                <!-- STEP 3: Upload Proof -->
                <div id="paymentStep3" class="payment-step" style="display: none;">
                    <h4 style="margin: 0 0 16px; color: #f8fafc; font-size: 1rem;">Paso 3: Sube tu comprobante</h4>
                    
                    <div id="proofUploadArea" style="border: 2px dashed #334155; border-radius: 12px; padding: 32px; text-align: center; cursor: pointer; transition: border-color 0.2s, background-color 0.2s;" data-action="grp-upload-proof">
                        <div id="proofPreview" style="display: none;">
                            <img id="proofPreviewImage" style="max-width: 100%; max-height: 200px; border-radius: 8px; margin-bottom: 12px;" alt="">
                        </div>
                        <div id="proofUploadPrompt">
                            <div style="font-size: 48px; margin-bottom: 12px;">📷</div>
                            <div style="font-weight: 500; color: #e2e8f0; margin-bottom: 4px;">Subir comprobante</div>
                            <div style="font-size: 0.875rem; color: #64748b;">Toca para seleccionar imagen</div>
                        </div>
                        <input type="file" id="proofFileInput" accept="image/*" style="display: none;" >
                    </div>

                    <div id="paymentStep3Error" style="display: none; padding: 12px; background: rgba(239,68,68,0.15); color: #fca5a5; border-radius: 8px; margin-top: 16px; font-size: 0.875rem;"></div>

                    <div style="margin-top: 16px; padding: 12px; background: rgba(0,255,255,0.05); border-radius: 8px; font-size: 0.875rem; color: #94a3b8;">
                        <strong>Importante:</strong> El comprobante es obligatorio para verificar tu pago.
                    </div>
                </div>

                <!-- SUCCESS State -->
                <div id="paymentSuccess" class="payment-step" style="display: none; text-align: center; padding: 20px;">
                    <div style="width: 70px; height: 70px; background: rgba(0,255,255,0.15); border-radius: 50%; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center;">
                        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#059669" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <h4 style="margin: 0 0 8px; color: #f8fafc; font-size: 1.25rem;">Pago Registrado!</h4>
                    <p id="paymentSuccessMessage" style="margin: 0 0 8px; color: #94a3b8; font-size: 0.875rem;">Tu pago ha sido registrado exitosamente.</p>
                    <div id="paymentSuccessCode" style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin: 16px 0; font-family: monospace; font-size: 0.875rem; color: #f8fafc;"></div>
                    <p style="margin: 0 0 20px; color: #94a3b8; font-size: 0.8rem;" id="paymentSuccessStatus">Estado: Esperando verificacion</p>
                </div>

            </div>

            <!-- Footer with navigation buttons -->
            <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid rgba(255,255,255,0.1); background: rgba(15,23,42,0.95); border-radius: 0 0 16px 16px; display: flex; gap: 12px; justify-content: space-between;" id="paymentFormFooter">
                <button type="button" id="paymentBackBtn" data-action="grp-payment-prev" style="display: none; padding: 10px 20px; background: rgba(255,255,255,0.1); color: #e2e8f0; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                    ← Atras
                </button>
                <div style="flex: 1;"></div>
                <button type="button" id="paymentCancelBtn" data-action="grp-close-register-payment" style="padding: 10px 20px; background: rgba(255,255,255,0.1); color: #e2e8f0; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">Cancelar</button>
                <button type="button" id="paymentNextBtn" data-action="grp-payment-next" style="padding: 10px 24px; background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                    Continuar →
                </button>
                <button type="button" id="paymentDoneBtn" data-action="grp-close-register-payment" style="display: none; padding: 10px 24px; background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <style>
        .payment-method-card:hover { border-color: #00FFFF !important; background: rgba(0,255,255,0.05); }
        .payment-method-card.selected { border-color: #00FFFF !important; background: rgba(0,255,255,0.1); }
        #proofUploadArea:hover { border-color: #00FFFF; background: rgba(0,255,255,0.05); }
        .step-dot.active { background: #059669 !important; }
        .step-dot.completed { background: #059669 !important; }
        #registerPaymentModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        #registerPaymentModal .modal-content {
            background: #0f172a;
            border: 1px solid rgba(0,255,255,0.15);
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            animation: modalSlideIn 0.3s ease-out;
        }

        #registerPaymentModal .modal-body {
            flex: 1;
            overflow-y: auto;
        }

        #registerPaymentModal .modal-footer {
            flex-shrink: 0;
        }

        #registerPaymentModal input:focus,
        #registerPaymentModal select:focus,
        #registerPaymentModal textarea:focus {
            outline: none;
            border-color: #00FFFF;
            box-shadow: 0 0 0 3px rgba(0, 255, 255, 0.15);
        }

        #paymentSubmitBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>


    <!-- View Members Modal -->
    <div id="groupMembersModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 600px; max-height: 85vh; overflow: hidden;">
            <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 20px; border-radius: 16px 16px 0 0; position: relative;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 12px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                    </div>
                    <div>
                        <h3 id="membersModalTitle" style="margin: 0; font-size: 1.25rem; font-weight: 600;">Miembros del Grupo</h3>
                        <p id="membersModalSubtitle" style="margin: 4px 0 0; font-size: 0.875rem; opacity: 0.9;">Lista de participantes</p>
                    </div>
                </div>
                <button data-action="grp-close-members" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>

            <div class="modal-body" style="padding: 20px; max-height: calc(85vh - 140px); overflow-y: auto;">
                <!-- Loading -->
                <div id="membersLoading" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px;">
                    <div class="spinner" style="width: 40px; height: 40px; border: 3px solid #334155; border-top-color: #8b5cf6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="margin-top: 16px; color: #94a3b8;">Cargando miembros...</p>
                </div>

                <!-- Members List -->
                <div id="membersList" style="display: none;"></div>

                <!-- Empty State -->
                <div id="membersEmpty" style="display: none; text-align: center; padding: 40px;">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="1.5" style="margin-bottom: 16px;">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                    </svg>
                    <p style="color: #94a3b8; margin: 0;">No hay miembros en este grupo</p>
                </div>
            </div>
        </div>
    </div>

    <style>
        #groupMembersModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        #groupMembersModal .modal-content {
            background: #0f172a;
            border: 1px solid rgba(0,255,255,0.15);
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            width: 90%;
            animation: modalSlideIn 0.3s ease-out;
        }

        .member-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            margin-bottom: 8px;
        }

        .member-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.125rem;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-weight: 500;
            color: #f8fafc;
            margin-bottom: 2px;
        }

        .member-role {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 9999px;
            display: inline-block;
        }

        .member-role.creator { background: rgba(217,119,6,0.15); color: #fbbf24; }
        .member-role.coordinator { background: rgba(37,99,235,0.15); color: #60a5fa; }
        .member-role.member { background: rgba(255,255,255,0.1); color: #94a3b8; }

        .member-position {
            font-size: 0.8125rem;
            color: #94a3b8;
        }

        /* Current user highlight */
        .member-card.current-user {
            background: linear-gradient(135deg, rgba(139,92,246,0.15), rgba(139,92,246,0.05));
            border: 2px solid #8b5cf6;
        }

        .member-avatar.anonymous {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }

        /* Member action buttons */
        .member-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 0 0 12px 12px;
            margin-top: -8px;
            margin-bottom: 8px;
            border-top: 1px dashed rgba(255,255,255,0.1);
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            font-size: 0.8125rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .action-btn.anonymous-btn {
            background: rgba(217,119,6,0.15);
            color: #fbbf24;
        }
        .action-btn.anonymous-btn:hover {
            background: rgba(217,119,6,0.25);
        }

        .action-btn.role-btn {
            background: rgba(37,99,235,0.15);
            color: #60a5fa;
        }
        .action-btn.role-btn:hover {
            background: rgba(37,99,235,0.25);
        }

        .action-btn.leave-btn {
            background: rgba(220,38,38,0.15);
            color: #f87171;
        }
        .action-btn.leave-btn:hover {
            background: rgba(220,38,38,0.25);
        }

        .action-btn.leave-btn.warning {
            background: rgba(234,88,12,0.15);
            color: #fb923c;
        }
        .action-btn.leave-btn.warning:hover {
            background: rgba(234,88,12,0.25);
        }

        .member-position {
            font-size: 0.8125rem;
            color: #94a3b8;
        }
    </style>


    <!-- View Payments Modal -->

    <!-- Leave Group Confirmation Modal -->
    <div id="leaveGroupConfirmModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100001; justify-content: center; align-items: center;">
        <div class="modal-content" style="max-width: 400px; background: #1a2332; border-radius: 16px; overflow: hidden; margin: 20px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #dc2626, #991b1b); color: white; padding: 20px; position: relative;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 12px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                            <polyline points="16 17 21 12 16 7"/>
                            <line x1="21" y1="12" x2="9" y2="12"/>
                        </svg>
                    </div>
                    <div>
                        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">Salir del Grupo</h3>
                        <p style="margin: 4px 0 0; font-size: 0.875rem; opacity: 0.9;">Esta accion no se puede deshacer</p>
                    </div>
                </div>
                <button data-action="grp-close-leave-confirm" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; color: white; cursor: pointer;">X</button>
            </div>
            <div style="padding: 24px; text-align: center;">
                <p style="color: #e5e7eb; margin-bottom: 24px;">Estas seguro que deseas salir de este grupo? Perderas tu posicion y no podras volver a unirte automaticamente.</p>
                <div style="display: flex; gap: 12px;">
                    <button data-action="grp-close-leave-confirm" style="flex: 1; padding: 12px; background: #374151; border: none; border-radius: 10px; color: white; cursor: pointer;">Cancelar</button>
                    <button id="confirmLeaveBtn" data-action="grp-execute-leave" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #dc2626, #991b1b); border: none; border-radius: 10px; color: white; cursor: pointer;">Si, Salir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Role Modal -->
    <div id="requestRoleModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100001; justify-content: center; align-items: center;">
        <div class="modal-content" style="max-width: 420px; background: #1a2332; border-radius: 16px; overflow: hidden; margin: 20px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; padding: 20px; position: relative;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 12px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="8.5" cy="7" r="4"/>
                            <line x1="20" y1="8" x2="20" y2="14"/>
                            <line x1="23" y1="11" x2="17" y2="11"/>
                        </svg>
                    </div>
                    <div>
                        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">Solicitar Rol</h3>
                        <p style="margin: 4px 0 0; font-size: 0.875rem; opacity: 0.9;">El admin revisara tu solicitud</p>
                    </div>
                </div>
                <button data-action="grp-close-request-role" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; color: white; cursor: pointer;">X</button>
            </div>
            <div style="padding: 24px;">
                <div id="roleOptionsContainer" style="margin-bottom: 16px;"></div>
                <style>
                    .role-option {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 12px;
                        background: #243447;
                        border-radius: 10px;
                        margin-bottom: 8px;
                        cursor: pointer;
                        color: #e5e7eb;
                    }
                    .role-option:hover { background: #2d4156; }
                    .role-option input { width: 18px; height: 18px; }
                    .role-option span { font-weight: 500; }
                    .role-option small { display: block; font-size: 0.75rem; color: #9ca3af; margin-top: 2px; }
                </style>
                <textarea id="roleRequestReason" placeholder="Razon de la solicitud (opcional)..." style="width: 100%; padding: 12px; background: #243447; border: 1px solid #374151; border-radius: 10px; color: #e5e7eb; resize: none; height: 80px; margin-bottom: 16px;"></textarea>
                <div style="display: flex; gap: 12px;">
                    <button data-action="grp-close-request-role" style="flex: 1; padding: 12px; background: #374151; border: none; border-radius: 10px; color: white; cursor: pointer;">Cancelar</button>
                    <button id="submitRoleRequestBtn" data-action="grp-submit-role-request" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #2563eb, #1d4ed8); border: none; border-radius: 10px; color: white; cursor: pointer;">Enviar Solicitud</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Transfer Ownership Modal -->
    <div id="transferOwnershipModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100001; justify-content: center; align-items: center;">
        <div class="modal-content" style="max-width: 420px; background: #1a2332; border-radius: 16px; overflow: hidden; margin: 20px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #ea580c, #c2410c); color: white; padding: 20px; position: relative;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 12px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 1l4 4-4 4"/>
                            <path d="M3 11V9a4 4 0 0 1 4-4h14"/>
                            <path d="M7 23l-4-4 4-4"/>
                            <path d="M21 13v2a4 4 0 0 1-4 4H3"/>
                        </svg>
                    </div>
                    <div>
                        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">Transferir Propiedad</h3>
                        <p style="margin: 4px 0 0; font-size: 0.875rem; opacity: 0.9;">Selecciona el nuevo propietario</p>
                    </div>
                </div>
                <button data-action="grp-close-transfer-ownership" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; color: white; cursor: pointer;">X</button>
            </div>
            <div style="padding: 24px;">
                <p style="color: #fbbf24; background: rgba(251,191,36,0.1); padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 0.875rem;">
                    <strong>Importante:</strong> Al transferir la propiedad, perderas todos los permisos de administrador y el nuevo propietario tendra control total del grupo.
                </p>
                <select id="newOwnerSelect" style="width: 100%; padding: 12px; background: #243447; border: 1px solid #374151; border-radius: 10px; color: #e5e7eb; margin-bottom: 16px;">
                    <option value="">Cargando miembros...</option>
                </select>
                <div style="display: flex; gap: 12px;">
                    <button data-action="grp-close-transfer-ownership" style="flex: 1; padding: 12px; background: #374151; border: none; border-radius: 10px; color: white; cursor: pointer;">Cancelar</button>
                    <button id="confirmTransferBtn" data-action="grp-execute-transfer" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #ea580c, #c2410c); border: none; border-radius: 10px; color: white; cursor: pointer;">Transferir y Continuar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="groupPaymentsModal" class="ph-overlay" style="display: none;">
        <div class="ph-modal">
            <div class="ph-header">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="ph-header-icon">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                        </svg>
                    </div>
                    <div>
                        <h3 id="paymentsModalTitle" class="ph-title">Historial de Pagos</h3>
                        <p id="paymentsModalSubtitle" class="ph-subtitle">Contribuciones del grupo</p>
                    </div>
                </div>
                <button data-action="grp-close-payments" class="ph-close-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>

            <!-- Tabs -->
            <div class="ph-tabs">
                <button class="ph-tab ph-tab-active" data-action="ph-tab-resumen">Resumen</button>
                <button class="ph-tab" data-action="ph-tab-historial">Historial</button>
                <div class="ph-cycle-filter">
                    <select id="phCycleFilter" class="ph-cycle-select">
                        <option value="0">Todos los ciclos</option>
                    </select>
                </div>
            </div>

            <!-- Stats Summary Bar -->
            <div id="phStatsBar" class="ph-stats-bar" style="display: none;">
                <div class="ph-stat"><span id="phStatAlDia" class="ph-stat-val ph-stat-ok">0</span><span class="ph-stat-label">Al dia</span></div>
                <div class="ph-stat"><span id="phStatPendientes" class="ph-stat-val ph-stat-warn">0</span><span class="ph-stat-label">Pendientes</span></div>
                <div class="ph-stat"><span id="phStatAtrasados" class="ph-stat-val ph-stat-danger">0</span><span class="ph-stat-label">Atrasados</span></div>
            </div>

            <div class="ph-body">
                <!-- Loading -->
                <div id="phLoading" class="ph-loading">
                    <div class="ph-spinner"></div>
                    <p>Cargando...</p>
                </div>

                <!-- Resumen Tab Content -->
                <div id="phResumenContent" style="display: none;"></div>

                <!-- Historial Tab Content -->
                <div id="phHistorialContent" style="display: none;"></div>

                <!-- Empty State -->
                <div id="phEmpty" class="ph-empty" style="display: none;">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#475569" stroke-width="1.5" style="margin-bottom: 12px;">
                        <path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                    </svg>
                    <p>No hay pagos registrados</p>
                </div>
            </div>
        </div>
    </div>


    <style>
        /* Payment History Modal (ph-) */
        .ph-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        .ph-modal {
            background: #0f172a;
            border-radius: 16px;
            box-shadow: 0 25px 60px rgba(0,0,0,0.5);
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: modalSlideIn 0.3s ease-out;
        }
        .ph-header {
            background: linear-gradient(135deg, #0e2a47 0%, #0f172a 100%);
            color: #e2e8f0;
            padding: 18px 20px;
            border-bottom: 1px solid rgba(0,255,255,0.15);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }
        .ph-header-icon {
            background: rgba(0,255,255,0.12);
            padding: 9px;
            border-radius: 10px;
            color: #00FFFF;
        }
        .ph-title { margin: 0; font-size: 1.15rem; font-weight: 600; color: #f1f5f9; }
        .ph-subtitle { margin: 3px 0 0; font-size: 0.8rem; color: #64748b; }
        .ph-close-btn {
            background: rgba(255,255,255,0.08);
            border: none;
            width: 32px; height: 32px;
            border-radius: 8px;
            color: #94a3b8;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, color 0.2s;
        }
        .ph-close-btn:hover { background: rgba(255,255,255,0.15); color: #e2e8f0; }

        /* Tabs */
        .ph-tabs {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 10px 20px;
            background: #0f172a;
            border-bottom: 1px solid #1e293b;
        }
        .ph-tab {
            padding: 7px 16px;
            background: transparent;
            border: 1px solid #334155;
            border-radius: 8px;
            color: #94a3b8;
            font-size: 0.82rem;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, border-color 0.2s;
        }
        .ph-tab:hover { background: #1e293b; color: #e2e8f0; }
        .ph-tab-active { background: rgba(0,255,255,0.1); border-color: #00FFFF; color: #00FFFF; }
        .ph-cycle-filter { margin-left: auto; }
        .ph-cycle-select {
            background: #1e293b;
            border: 1px solid #334155;
            color: #e2e8f0;
            border-radius: 6px;
            padding: 5px 8px;
            font-size: 0.78rem;
            cursor: pointer;
        }
        .ph-cycle-select:focus { outline: 1px solid #00FFFF; border-color: #00FFFF; }

        /* Stats Bar */
        .ph-stats-bar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 10px 20px;
            background: #0f172a;
            border-bottom: 1px solid #1e293b;
        }
        .ph-stat {
            text-align: center;
            padding: 6px 0;
            background: rgba(30,41,59,0.5);
            border-radius: 8px;
        }
        .ph-stat-val { display: block; font-size: 1.2rem; font-weight: 700; }
        .ph-stat-label { font-size: 0.7rem; color: #64748b; }
        .ph-stat-ok { color: #00FFFF; }
        .ph-stat-warn { color: #f59e0b; }
        .ph-stat-danger { color: #ef4444; }

        /* Body */
        .ph-body {
            padding: 16px 20px;
            overflow-y: auto;
            flex: 1;
            max-height: calc(85vh - 200px);
        }
        .ph-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #64748b;
        }
        .ph-spinner {
            width: 36px; height: 36px;
            border: 3px solid #1e293b;
            border-top-color: #00FFFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
        }
        .ph-empty { text-align: center; padding: 40px; color: #475569; }

        /* Resumen tab: member rows */
        .ph-member-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: #1e293b;
            border-radius: 10px;
            margin-bottom: 6px;
            border: 1px solid #334155;
        }
        .ph-avatar {
            width: 36px; height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85rem;
            flex-shrink: 0;
        }
        .ph-member-info { flex: 1; min-width: 0; }
        .ph-member-name {
            font-weight: 500;
            font-size: 0.88rem;
            color: #e2e8f0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .ph-member-meta { font-size: 0.72rem; color: #64748b; margin-top: 2px; }
        .ph-member-right { text-align: right; flex-shrink: 0; }
        .ph-member-progress { font-size: 0.78rem; color: #94a3b8; }
        .ph-member-debt { font-size: 0.75rem; color: #ef4444; margin-top: 2px; }
        .ph-pill {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.68rem;
            font-weight: 600;
        }
        .ph-pill-paid { background: rgba(0,255,255,0.12); color: #00FFFF; }
        .ph-pill-pending { background: rgba(245,158,11,0.15); color: #f59e0b; }
        .ph-pill-late { background: rgba(239,68,68,0.15); color: #ef4444; }
        .ph-pill-suspended { background: rgba(239,68,68,0.2); color: #fca5a5; }
        .ph-pill-ahead { background: rgba(34,197,94,0.15); color: #22c55e; }
        .ph-pill-numpos { background: rgba(0,255,255,0.1); color: #67e8f9; font-size: 0.65rem; margin-left: 4px; }

        /* Historial tab: contribution cards */
        .ph-cycle-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 14px 0 8px;
            color: #64748b;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .ph-cycle-header:first-child { margin-top: 0; }
        .ph-cycle-header::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #334155;
        }
        .ph-cycle-badge-hdr {
            background: rgba(0,255,255,0.1);
            color: #00FFFF;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
        }
        .ph-contrib-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: #1e293b;
            border-radius: 10px;
            margin-bottom: 6px;
            border: 1px solid #334155;
        }
        .ph-contrib-icon {
            width: 32px; height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            flex-shrink: 0;
        }
        .ph-contrib-icon.completed { background: rgba(0,255,255,0.12); color: #00FFFF; }
        .ph-contrib-icon.pending { background: rgba(245,158,11,0.15); color: #f59e0b; }
        .ph-contrib-info { flex: 1; min-width: 0; }
        .ph-contrib-name {
            font-weight: 500;
            font-size: 0.85rem;
            color: #e2e8f0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .ph-contrib-detail { font-size: 0.72rem; color: #64748b; margin-top: 2px; }
        .ph-contrib-right { text-align: right; flex-shrink: 0; }
        .ph-contrib-amount { font-weight: 600; font-size: 0.92rem; color: #00FFFF; }
        .ph-contrib-date { font-size: 0.7rem; color: #475569; margin-top: 2px; }
        .ph-method-pill {
            display: inline-block;
            padding: 1px 6px;
            border-radius: 4px;
            font-size: 0.62rem;
            background: rgba(100,116,139,0.2);
            color: #94a3b8;
            margin-left: 4px;
        }
        .ph-verified-line { font-size: 0.68rem; color: #475569; margin-top: 3px; }
        .ph-verified-badge {
            display: inline-block;
            padding: 1px 5px;
            border-radius: 3px;
            font-size: 0.6rem;
            background: rgba(0,255,255,0.08);
            color: #67e8f9;
            margin-left: 3px;
        }

        @media (max-width: 480px) {
            .ph-modal { width: 96%; max-height: 92vh; border-radius: 12px; }
            .ph-header { padding: 14px 16px; }
            .ph-tabs { padding: 8px 12px; flex-wrap: wrap; gap: 6px; }
            .ph-cycle-filter { margin-left: 0; width: 100%; }
            .ph-cycle-select { width: 100%; }
            .ph-stats-bar { padding: 8px 12px; gap: 6px; }
            .ph-body { padding: 12px; }
            .ph-member-row, .ph-contrib-card { padding: 8px 10px; gap: 8px; }
            .ph-member-name, .ph-contrib-name { font-size: 0.82rem; }
        }

    </style>



    <!-- Invite Members Modal -->
    <div id="inviteMembersModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px; max-height: 85vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 20px; border-radius: 16px 16px 0 0; position: relative;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 12px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="8.5" cy="7" r="4"/>
                            <line x1="20" y1="8" x2="20" y2="14"/>
                            <line x1="23" y1="11" x2="17" y2="11"/>
                        </svg>
                    </div>
                    <div>
                        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">Invitar Miembros</h3>
                        <p id="inviteModalSubtitle" style="margin: 4px 0 0; font-size: 0.875rem; opacity: 0.9;">Genera un link de invitacion</p>
                    </div>
                </div>
                <button data-action="grp-close-invite" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>

            <form id="inviteForm" style="display: flex; flex-direction: column; flex: 1; min-height: 0; overflow: hidden;">
                <div class="modal-body" style="padding: 24px; flex: 1; overflow-y: auto; min-height: 0;">
                    <!-- Success Message -->
                    <!-- Success Message with Link -->
                    <div id="inviteSuccess" style="display: none; text-align: center; padding: 20px;">
                        <div style="width: 60px; height: 60px; background: rgba(0,255,255,0.15); border-radius: 50%; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center;">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#059669" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </div>
                        <h4 style="margin: 0 0 8px; color: #f8fafc;">Invitacion Creada!</h4>
                        <p style="margin: 0 0 16px; color: #94a3b8; font-size: 0.875rem;">Comparte el siguiente link con el invitado:</p>
                        
                        <!-- Invite Link Display -->
                        <div style="background: rgba(255,255,255,0.05); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                            <input type="text" id="generatedInviteLink" readonly style="width: 100%; background: transparent; border: none; text-align: center; color: #f8fafc; font-size: 0.8125rem; font-family: monospace;">
                        </div>
                        
                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin-bottom: 16px;">
                            <button type="button" data-action="grp-copy-invite-link" style="display: flex; align-items: center; gap: 6px; padding: 10px 16px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                                Copiar Link
                            </button>
                            <button type="button" data-action="grp-share-whatsapp" style="display: flex; align-items: center; gap: 6px; padding: 10px 16px; background: #25D366; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                                WhatsApp
                            </button>
                            <button type="button" data-action="grp-share-email" style="display: flex; align-items: center; gap: 6px; padding: 10px 16px; background: #EA4335; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                                Email
                            </button>
                        </div>
                        
                        <p id="inviteLinkCopied" style="display: none; color: #00FFFF; font-size: 0.8125rem; margin-bottom: 12px;">Link copiado al portapapeles!</p>
                        
                        <button type="button" data-action="grp-reset-invite" style="padding: 10px 20px; background: rgba(255,255,255,0.1); color: #e2e8f0; border: none; border-radius: 8px; cursor: pointer;">Enviar Otra Invitacion</button>
                    </div>


                    <!-- User Search Section -->
                    <div id="userSearchSection" style="margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <label style="display: block; font-weight: 600; color: #e2e8f0; margin-bottom: 8px; font-size: 0.9375rem;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                            Buscar usuario registrado
                        </label>
                        <div style="position: relative;">
                            <input type="text" id="userSearchInput" placeholder="Buscar por nombre o email..."
                                   style="width: 100%; padding: 12px 12px 12px 40px; border: 1px solid #334155; border-radius: 8px; font-size: 0.9375rem; box-sizing: border-box; background: #1e293b; color: #f8fafc;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2"
                                 style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%);">
                                <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                            </svg>
                        </div>
                        <div id="userSearchResults" style="margin-top: 8px; max-height: 200px; overflow-y: auto;"></div>
                        <div id="selectedUserDisplay" style="display: none; margin-top: 12px; padding: 12px; background: rgba(0,255,255,0.05); border: 1px solid rgba(0,255,255,0.2); border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span style="font-weight: 500; color: #00FFFF;" id="selectedUserName"></span>
                                    <span style="font-size: 0.8125rem; color: #94a3b8; margin-left: 8px;" id="selectedUserEmail"></span>
                                </div>
                                <button type="button" data-action="grp-clear-selected-user" style="background: none; border: none; color: #dc2626; cursor: pointer; font-size: 1.25rem;">&times;</button>
                            </div>
                            <input type="hidden" id="selectedUserId">
                        </div>
                        <p style="font-size: 0.75rem; color: #9ca3af; margin-top: 8px;">Busca usuarios existentes o usa el formulario abajo para invitar por link</p>
                    </div>

                    <!-- Simplified Form Fields -->
                    <div id="inviteFormFields">
                        <!-- Name (Optional) -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; color: #e2e8f0; margin-bottom: 6px; font-size: 0.875rem;">Nombre del Invitado <span style="color: #9ca3af; font-weight: 400;">(opcional)</span></label>
                            <input type="text" id="inviteeName" placeholder="Ej: Juan Perez" style="width: 100%; padding: 12px; border: 1px solid #334155; border-radius: 8px; font-size: 0.9375rem; box-sizing: border-box; background: #1e293b; color: #f8fafc;">
                        </div>

                        <!-- Message (Optional) -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; color: #e2e8f0; margin-bottom: 6px; font-size: 0.875rem;">Mensaje Personal <span style="color: #9ca3af; font-weight: 400;">(opcional)</span></label>
                            <textarea id="inviteMessage" rows="3" placeholder="Te invito a unirte a nuestra tanda..." style="width: 100%; padding: 12px; border: 1px solid #334155; border-radius: 8px; font-size: 0.9375rem; resize: vertical; box-sizing: border-box; background: #1e293b; color: #f8fafc;"></textarea>
                        </div>

                        <div id="inviteError" style="display: none; padding: 12px; background: rgba(239,68,68,0.15); color: #fca5a5; border-radius: 8px; margin-bottom: 16px; font-size: 0.875rem;"></div>
                    </div>
                    <!-- Pending Invitations Section -->
                    <div id="pendingInvitationsSection" style="margin-top: 24px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <h4 style="margin: 0 0 12px; font-size: 0.9375rem; font-weight: 600; color: #e2e8f0; display: flex; align-items: center; gap: 8px;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            Invitaciones Pendientes
                        </h4>
                        <div id="pendingInvitationsList">
                            <p style="font-size: 0.875rem; color: #9ca3af; text-align: center; padding: 1rem;">Cargando...</p>
                        </div>
                    </div>

                </div>

                <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid rgba(255,255,255,0.1); background: rgba(15,23,42,0.95); border-radius: 0 0 16px 16px; display: flex; gap: 12px; justify-content: flex-end; flex-shrink: 0;" id="inviteFormFooter">
                    <button type="button" data-action="grp-close-invite" style="padding: 10px 20px; background: rgba(255,255,255,0.1); color: #e2e8f0; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">Cancelar</button>
                    <button type="submit" id="inviteSubmitBtn" style="padding: 10px 24px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">Generar Link</button>
                </div>
            </form>
        </div>
    </div>

    <style>
        #inviteMembersModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        #inviteMembersModal .modal-content {
            background: #0f172a;
            border: 1px solid rgba(0,255,255,0.15);
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            width: 90%;
            animation: modalSlideIn 0.3s ease-out;
        }

        /* Mobile fixes for invite modal */
        @media (max-width: 480px) {
            #inviteMembersModal .modal-content {
                max-height: 95vh !important;
                margin: 10px;
                border-radius: 12px;
            }
            #inviteMembersModal .modal-header {
                padding: 16px !important;
            }
            #inviteMembersModal .modal-body {
                padding: 16px !important;
            }
            #inviteMembersModal .modal-footer {
                padding: 12px 16px !important;
                flex-wrap: wrap;
            }
            #inviteMembersModal .modal-footer button {
                flex: 1;
                min-width: 120px;
            }
        }

        #inviteMembersModal input:focus,
        #inviteMembersModal textarea:focus {
            outline: none;
            border-color: #00FFFF;
            box-shadow: 0 0 0 3px rgba(0, 255, 255, 0.15);
        }

        .invite-method-btn.active {
            border-color: #f59e0b !important;
            background: rgba(245,158,11,0.1) !important;
            color: #d97706 !important;
        }

        #inviteSubmitBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>


    <script>
        // ============================================
        // MODAL SYSTEM - JavaScript Functions
        // ============================================

        // Global variables for modals
        var currentMembersGroupId = null;
        var currentPaymentsGroupId = null;
        var currentInviteGroupId = null;
        var currentInviteMethod = 'email';

        // ============================================
        // VIEW MEMBERS MODAL
        // ============================================
        function viewGroupMembers(groupId) {
            closeModal(); // Close admin modal first
            setTimeout(function() {
                showMembersModal(groupId);
            }, 100);
        }
        window.viewGroupMembers = viewGroupMembers;

        async function showMembersModal(groupId) {
            currentMembersGroupId = groupId;
            var modal = document.getElementById('groupMembersModal');
            var loading = document.getElementById('membersLoading');
            var list = document.getElementById('membersList');
            var empty = document.getElementById('membersEmpty');
            var currentUserId = getCurrentUserId();

            // Reset state
            loading.style.display = 'flex';
            list.style.display = 'none';
            empty.style.display = 'none';
            list.innerHTML = '';

            // Show modal
            modal.style.display = 'flex'; modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Load members
            try {
                var apiBase = window.API_BASE_URL || 'https://latanda.online';
                var response = await fetch(apiBase + '/api/groups/' + groupId + '/members', { headers: getAuthHeaders() });
                var data = await response.json();

                loading.style.display = 'none';

                if (data.success && data.data.members && data.data.members.length > 0) {
                    var members = data.data.members;
                    var expandedOrder = data.data.expanded_order || data.expanded_order || [];
                    var html = '';
                    var currentUserRole = null;
                    
                    // Build position map from expanded_order (user_id -> [positions])
                    var userPositions = {};
                    expandedOrder.forEach(function(pos, index) {
                        var uid = pos.user_id || pos;
                        if (!userPositions[uid]) userPositions[uid] = [];
                        userPositions[uid].push(index + 1);
                    });
                    
                    // Find current user's role
                    var currentMember = members.find(function(m) { return m.user_id === currentUserId; });
                    if (currentMember) currentUserRole = currentMember.role;

                    members.forEach(function(member) {
                        var isCurrentUser = member.user_id === currentUserId;
                        var initials = (member.name || 'U').charAt(0).toUpperCase();
                        var roleClass = member.role || 'member';
                        var roleText = member.role === 'creator' ? 'Creador' :
                                       member.role === 'coordinator' ? 'Coordinador' : 
                                       member.role === 'admin' ? 'Admin' : 'Miembro';
                        
                        // Display name logic (anonymous)
                        var displayName = member.name || 'Usuario';
                        var isAnonymous = member.is_anonymous;
                        if (isAnonymous && !isCurrentUser && currentUserRole !== 'creator' && currentUserRole !== 'admin') {
                            displayName = 'Miembro Anonimo';
                            initials = '?';
                        }
                        
                        // Anonymous indicator for admin/creator
                        var anonymousIndicator = '';
                        if (isAnonymous && (currentUserRole === 'creator' || currentUserRole === 'admin')) {
                            anonymousIndicator = ' <span style="font-size:0.7rem;color:#f59e0b;">(Anonimo)</span>';
                        }

                        html += '<div class="member-card' + (isCurrentUser ? ' current-user' : '') + '" data-user-id="' + member.user_id + '">' +
                            '<div class="member-avatar' + (isAnonymous ? ' anonymous' : '') + '">' + initials + '</div>' +
                            '<div class="member-info">' +
                                '<div class="member-name">' + escapeHtml(displayName) + anonymousIndicator + (isCurrentUser ? ' <span style="color:#8b5cf6;font-size:0.75rem;">(Tu)</span>' : '') + '</div>' +
                                '<span class="member-role ' + roleClass + '">' + roleText + '</span>' +
                            '</div>' +
                            '<div class="member-position">' + (function() { var pos = userPositions[member.user_id] || (member.turn_position ? [member.turn_position] : []); if (pos.length === 0) return 'Sin turno'; if (pos.length === 1) return 'Turno #' + pos[0]; return 'Turnos #' + pos.join(', #'); })() + '</div>' +
                        '</div>';
                        
                        // Add action buttons for current user
                        if (isCurrentUser) {
                            html += '<div class="member-actions">';
                            
                            // Toggle Anonymous button
                            html += '<button data-action="grp-toggle-anonymous" data-group-id="' + groupId + '" data-user-id="' + member.user_id + '" data-value="' + !isAnonymous + '" class="action-btn anonymous-btn">' +
                                '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>' +
                                (isAnonymous ? ' Mostrar Nombre' : ' Ocultar Nombre') +
                            '</button>';
                            
                            // Request Role button (only for members and coordinators)
                            if (member.role === 'member' || member.role === 'coordinator') {
                                html += '<button data-action="grp-request-role" data-group-id="' + groupId + '" data-current-role="' + member.role + '" class="action-btn role-btn">' +
                                    '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>' +
                                    ' Solicitar Rol' +
                                '</button>';
                            }
                            
                            // Leave Group button
                            if (member.role === 'creator') {
                                html += '<button data-action="grp-transfer-ownership" data-group-id="' + groupId + '" class="action-btn leave-btn warning">' +
                                    '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>' +
                                    ' Transferir y Salir' +
                                '</button>';
                            } else {
                                html += '<button data-action="grp-leave-group" data-group-id="' + groupId + '" class="action-btn leave-btn">' +
                                    '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>' +
                                    ' Salir del Grupo' +
                                '</button>';
                            }
                            
                            html += '</div>';
                        // Admin action buttons (remove member) for admins/coordinators
                        } else if (!isCurrentUser && (currentUserRole === "creator" || currentUserRole === "coordinator" || currentUserRole === "admin")) {
                            // Cannot remove creator
                            if (member.role !== "creator") {
                                // safeName removed — using data-attributes with escapeHtml
                                html += "<div class=\"member-actions\">";
                                html += "<button data-action=\"grp-remove-member\" data-group-id=\"" + groupId + "\" data-user-id=\"" + member.user_id + "\" data-user-name=\"" + escapeHtml(displayName) + "\" class=\"action-btn leave-btn\" style=\"background: rgba(239, 68, 68, 0.1); color: #ef4444;\">" +
                                    "<svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><path d=\"M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2\"/><circle cx=\"8.5\" cy=\"7\" r=\"4\"/><line x1=\"18\" y1=\"8\" x2=\"23\" y2=\"13\"/><line x1=\"23\" y1=\"8\" x2=\"18\" y2=\"13\"/></svg>" +
                                    " Remover" +
                                "</button>";
                                html += "</div>";
                            }

                        }
                    });

                    list.innerHTML = html;
                    list.style.display = 'block';
                    document.getElementById('membersModalSubtitle').textContent = members.length + ' miembros' + (expandedOrder.length > members.length ? ' (' + expandedOrder.length + ' turnos)' : '');
                } else {
                    empty.style.display = 'block';
                }
            } catch (err) {
                loading.innerHTML = '<p style="color: #ef4444;">Error al cargar miembros</p>';
            }
        }

        // ============================================
        // MEMBER ACTION FUNCTIONS
        // ============================================
        
        // Toggle anonymous mode for member
        async function toggleMemberAnonymous(groupId, userId, makeAnonymous) {
            try {
                var apiBase = window.API_BASE_URL || 'https://latanda.online';
                var response = await fetch(apiBase + '/api/groups/' + groupId + '/members/' + userId + '/anonymous', {
                    method: 'PUT',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_anonymous: makeAnonymous })
                });
                var result = await response.json();
                
                if (result.success) {
                    showNotification(makeAnonymous ? 'Tu nombre ahora esta oculto' : 'Tu nombre ahora es visible', 'success');
                    // Reload members list
                    showMembersModal(groupId);
                } else {
                    showNotification('Error al cambiar modo anonimo', 'error');
                }
            } catch (err) {
                showNotification('Error de conexion', 'error');
            }
        }
        window.toggleMemberAnonymous = toggleMemberAnonymous;
        
        // Confirm leave group
        var pendingLeaveGroupId = null;
        
        async function confirmLeaveGroup(groupId) {
            pendingLeaveGroupId = groupId;
            
            try {
                var apiBase = window.API_BASE_URL || 'https://latanda.online';
                var userId = getCurrentUserId();
                
                var url = apiBase + '/api/groups/' + groupId + '/members/' + userId + '/can-leave';
                
                var response = await fetch(url, { headers: getAuthHeaders() });
                
                var result = await response.json();
                
                var canLeave = (result.data && result.data.can_leave) || result.can_leave;
                
                if (!result.success || !canLeave) {
                    var reason = (result.data && result.data.reason) || result.reason || 'Tienes pagos pendientes';
                    showNotification('No puedes salir: ' + reason, 'error');
                    return;
                }
                
                var modal = document.getElementById('leaveGroupConfirmModal');
                if (modal) {
                    modal.style.display = 'flex'; modal.classList.add('active');
                } else {
                }
            } catch (err) {
                // Show confirmation anyway on error
                var modal = document.getElementById('leaveGroupConfirmModal');
                if (modal) {
                    modal.style.display = 'flex'; modal.classList.add('active');
                }
            }
        }
        window.confirmLeaveGroup = confirmLeaveGroup;
        
        function closeLeaveConfirmModal() {
            var modal = document.getElementById('leaveGroupConfirmModal');
            if (modal) modal.style.display = 'none'; modal.classList.remove('active');
            pendingLeaveGroupId = null;
        }
        window.closeLeaveConfirmModal = closeLeaveConfirmModal;
        
        async function executeLeaveGroup() {
            if (!pendingLeaveGroupId) return;
            
            var btn = document.getElementById('confirmLeaveBtn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-small"></span> Saliendo...';
            }
            
            try {
                var apiBase = window.API_BASE_URL || 'https://latanda.online';
                var userId = getCurrentUserId();
                var response = await fetch(apiBase + '/api/groups/' + pendingLeaveGroupId + '/members/' + userId, {
                    method: 'DELETE',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' }
                });
                var result = await response.json();
                
                if (result.success) {
                    showNotification('Has salido del grupo exitosamente', 'success');
                    closeLeaveConfirmModal();
                    closeMembersModal();
                    // Reload groups and tandas
                    if (typeof fetchMyGroups === 'function') {
                        fetchMyGroups().then(() => {
                            if (typeof renderGroups === 'function') renderGroups();
                        }).catch(function() {});
                    }
                    if (typeof refreshTandas === 'function') {
                        refreshTandas();
                    }
                } else {
                    showNotification('No se pudo salir del grupo', 'error');
                }
            } catch (err) {
                showNotification('Error de conexion', 'error');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = 'Si, Salir';
                }
            }
        }
        window.executeLeaveGroup = executeLeaveGroup;
        
        // Show request role modal
        var pendingRoleRequest = { groupId: null, currentRole: null };
        
        function showRequestRoleModal(groupId, currentRole) {
            pendingRoleRequest.groupId = groupId;
            pendingRoleRequest.currentRole = currentRole;
            
            var modal = document.getElementById('requestRoleModal');
            var roleOptions = document.getElementById('roleOptionsContainer');
            
            if (modal && roleOptions) {
                // Build role options based on current role
                var html = '';
                if (currentRole === 'member') {
                    html += '<label class="role-option"><input type="radio" name="requestedRole" value="coordinator"> <span>Coordinador</span> <small>Ayuda a gestionar el grupo</small></label>';
                }
                html += '<label class="role-option"><input type="radio" name="requestedRole" value="admin"> <span>Administrador</span> <small>Permisos completos de gestion</small></label>';
                
                roleOptions.innerHTML = html;
                modal.style.display = 'flex'; modal.classList.add('active');
            }
        }
        window.showRequestRoleModal = showRequestRoleModal;
        
        function closeRequestRoleModal() {
            var modal = document.getElementById('requestRoleModal');
            if (modal) modal.style.display = 'none'; modal.classList.remove('active');
            pendingRoleRequest = { groupId: null, currentRole: null };
        }
        window.closeRequestRoleModal = closeRequestRoleModal;
        
        async function submitRoleRequest() {
            var selectedRole = document.querySelector('input[name="requestedRole"]:checked');
            var reason = document.getElementById('roleRequestReason')?.value || '';
            
            if (!selectedRole) {
                showNotification('Selecciona un rol', 'error');
                return;
            }
            
            var btn = document.getElementById('submitRoleRequestBtn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-small"></span> Enviando...';
            }
            
            try {
                var apiBase = window.API_BASE_URL || 'https://latanda.online';
                var userId = getCurrentUserId();
                var response = await fetch(apiBase + '/api/groups/' + pendingRoleRequest.groupId + '/role-requests', {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        requested_role: selectedRole.value,
                        reason: reason
                    })
                });
                var result = await response.json();
                
                if (result.success) {
                    showNotification('Solicitud enviada. El administrador la revisara pronto.', 'success');
                    closeRequestRoleModal();
                } else {
                    showNotification('Error al enviar solicitud', 'error');
                }
            } catch (err) {
                showNotification('Error de conexion', 'error');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = 'Enviar Solicitud';
                }
            }
        }
        window.submitRoleRequest = submitRoleRequest;
        
        // Transfer ownership modal
        var pendingTransferGroupId = null;
        
        async function showTransferOwnershipModal(groupId) {
            pendingTransferGroupId = groupId;
            
            var modal = document.getElementById('transferOwnershipModal');
            var memberSelect = document.getElementById('newOwnerSelect');
            
            if (!modal || !memberSelect) return;
            
            // Load members for selection
            try {
                var apiBase = window.API_BASE_URL || 'https://latanda.online';
                var response = await fetch(apiBase + '/api/groups/' + groupId + '/members', { headers: getAuthHeaders() });
                var result = await response.json();
                
                if (result.success && result.data.members) {
                    var currentUserId = getCurrentUserId();
                    var html = '<option value="">Selecciona un miembro...</option>';
                    
                    result.data.members.forEach(function(m) {
                        if (m.user_id !== currentUserId) {
                            html += '<option value="' + m.user_id + '">' + (m.name || m.user_id) + ' (' + m.role + ')</option>';
                        }
                    });
                    
                    memberSelect.innerHTML = html;
                    modal.style.display = 'flex'; modal.classList.add('active');
                }
            } catch (err) {
                showNotification('Error al cargar miembros', 'error');
            }
        }
        window.showTransferOwnershipModal = showTransferOwnershipModal;
        
        function closeTransferOwnershipModal() {
            var modal = document.getElementById('transferOwnershipModal');
            if (modal) modal.style.display = 'none'; modal.classList.remove('active');
            pendingTransferGroupId = null;
        }
        window.closeTransferOwnershipModal = closeTransferOwnershipModal;
        
        async function executeTransferOwnership() {
            var newOwnerId = document.getElementById('newOwnerSelect')?.value;
            
            if (!newOwnerId) {
                showNotification('Selecciona un miembro para transferir', 'error');
                return;
            }
            
            var btn = document.getElementById('confirmTransferBtn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-small"></span> Transfiriendo...';
            }
            
            try {
                var apiBase = window.API_BASE_URL || 'https://latanda.online';
                var response = await fetch(apiBase + '/api/groups/' + pendingTransferGroupId + '/transfer-ownership', {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_owner_id: newOwnerId })
                });
                var result = await response.json();
                
                if (result.success) {
                    showNotification('Propiedad transferida exitosamente', 'success');
                    closeTransferOwnershipModal();
                    closeMembersModal();
                    // Now can leave group
                    confirmLeaveGroup(pendingTransferGroupId);
                } else {
                    showNotification('Error al transferir propiedad', 'error');
                }
            } catch (err) {
                showNotification('Error de conexion', 'error');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = 'Transferir y Continuar';
                }
            }
        }
        window.executeTransferOwnership = executeTransferOwnership;

        function closeMembersModal() {
            var modal = document.getElementById('groupMembersModal');
            if (modal) {
                modal.style.display = 'none'; modal.classList.remove('active');
                document.body.style.overflow = '';
            }
            currentMembersGroupId = null;
        }

        // Close on overlay click
        document.addEventListener('DOMContentLoaded', function() {
            var modal = document.getElementById('groupMembersModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) closeMembersModal();
                });
            }
        });

        // ============================================
        // VIEW PAYMENTS MODAL (Redesigned v4.10.7)
        // ============================================
        var phCurrentGroupId = null;
        var phCurrentTab = 'resumen';
        var phResumenData = null;
        var phHistorialData = null;

        function viewGroupPayments(groupId) {
            closeModal(); // Close admin modal first
            setTimeout(function() {
                showPaymentsModal(groupId);
            }, 100);
        }
        window.viewGroupPayments = viewGroupPayments;

        var phMethodLabels = {
            'cash': 'Efectivo',
            'bank_transfer': 'Transferencia',
            'mobile_money': 'Tigo Money',
            'card': 'Tarjeta',
            'crypto': 'Crypto',
            'coordinator_manual': 'Manual',
            'coordinator_bulk': 'Masivo'
        };

        function phFormatAmount(amount) {
            var n = parseFloat(amount) || 0;
            return 'L. ' + n.toLocaleString('es-HN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        function phFormatDate(dateStr) {
            if (!dateStr) return '';
            try {
                return new Date(dateStr).toLocaleDateString('es-HN', { day: '2-digit', month: 'short', year: 'numeric' });
            } catch(e) { return ''; }
        }

        function phGetStatusPill(paymentStatus, cyclesPaid, currentCycle) {
            if (cyclesPaid > currentCycle) return '<span class="ph-pill ph-pill-ahead">Adelantado</span>';
            switch(paymentStatus) {
                case 'paid': return '<span class="ph-pill ph-pill-paid">Al dia</span>';
                case 'pending': return '<span class="ph-pill ph-pill-pending">Pendiente</span>';
                case 'late': return '<span class="ph-pill ph-pill-late">Atrasado</span>';
                case 'suspended': return '<span class="ph-pill ph-pill-suspended">Suspendido</span>';
                default: return '<span class="ph-pill ph-pill-pending">Pendiente</span>';
            }
        }

        function phGetAvatarColor(status) {
            switch(status) {
                case 'paid': return 'background:rgba(0,255,255,0.15);color:#00FFFF;';
                case 'late': return 'background:rgba(239,68,68,0.15);color:#ef4444;';
                case 'suspended': return 'background:rgba(239,68,68,0.2);color:#fca5a5;';
                default: return 'background:rgba(245,158,11,0.15);color:#f59e0b;';
            }
        }

        function phGetVerificationLabel(method) {
            if (method === 'coordinator_bulk') return 'Masivo';
            if (method === 'coordinator_manual') return 'Manual';
            if (method === 'ocr_auto') return 'OCR';
            return 'Verificado';
        }

        async function showPaymentsModal(groupId) {
            phCurrentGroupId = groupId;
            currentPaymentsGroupId = groupId;
            phCurrentTab = 'resumen';
            phResumenData = null;
            phHistorialData = null;

            var modal = document.getElementById('groupPaymentsModal');
            var loading = document.getElementById('phLoading');
            var resumenDiv = document.getElementById('phResumenContent');
            var historialDiv = document.getElementById('phHistorialContent');
            var emptyDiv = document.getElementById('phEmpty');
            var statsBar = document.getElementById('phStatsBar');

            // Reset
            loading.style.display = 'flex';
            resumenDiv.style.display = 'none';
            historialDiv.style.display = 'none';
            emptyDiv.style.display = 'none';
            statsBar.style.display = 'none';
            resumenDiv.innerHTML = '';
            historialDiv.innerHTML = '';

            // Reset tabs
            var tabs = modal.querySelectorAll('.ph-tab');
            tabs.forEach(function(t) { t.classList.remove('ph-tab-active'); });
            var resumenTab = modal.querySelector('[data-action="ph-tab-resumen"]');
            if (resumenTab) resumenTab.classList.add('ph-tab-active');

            // Show modal
            modal.style.display = 'flex';
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Load both datasets in parallel
            try {
                var apiBase = window.API_BASE_URL || 'https://latanda.online';
                var headers = getAuthHeaders();

                var results = await Promise.allSettled([
                    fetch(apiBase + '/api/groups/' + encodeURIComponent(groupId) + '/members/payment-status', { headers: headers }).then(function(r) { return r.json(); }),
                    fetch(apiBase + '/api/groups/' + encodeURIComponent(groupId) + '/contributions?limit=100', { headers: headers }).then(function(r) { return r.json(); })
                ]);

                loading.style.display = 'none';

                // Process resumen data
                if (results[0].status === 'fulfilled' && results[0].value.success) {
                    phResumenData = results[0].value.data;
                }

                // Process historial data
                if (results[1].status === 'fulfilled' && results[1].value.success) {
                    phHistorialData = results[1].value.data;
                }

                // Populate cycle filter
                phPopulateCycleFilter();

                // Render default tab
                phRenderResumen();

            } catch (err) {
                loading.innerHTML = '<p style="color: #ef4444;">Error al cargar datos de pagos</p>';
            }
        }

        function phPopulateCycleFilter() {
            var select = document.getElementById('phCycleFilter');
            if (!select) return;
            select.innerHTML = '<option value="0">Todos los ciclos</option>';
            var maxCycle = 1;
            if (phResumenData && phResumenData.cycle_number) {
                maxCycle = phResumenData.cycle_number;
            }
            if (phHistorialData && phHistorialData.contributions) {
                phHistorialData.contributions.forEach(function(c) {
                    if (c.cycle_number && c.cycle_number > maxCycle) maxCycle = c.cycle_number;
                });
            }
            for (var i = 1; i <= maxCycle; i++) {
                var opt = document.createElement('option');
                opt.value = String(i);
                opt.textContent = 'Ciclo ' + i;
                select.appendChild(opt);
            }
        }

        function phRenderResumen(cycleFilter) {
            var container = document.getElementById('phResumenContent');
            var historialDiv = document.getElementById('phHistorialContent');
            var emptyDiv = document.getElementById('phEmpty');
            var statsBar = document.getElementById('phStatsBar');

            historialDiv.style.display = 'none';

            if (!phResumenData || !phResumenData.members || phResumenData.members.length === 0) {
                container.style.display = 'none';
                emptyDiv.style.display = 'block';
                statsBar.style.display = 'none';
                return;
            }

            var members = phResumenData.members;
            var currentCycle = phResumenData.cycle_number || 1;
            var alDia = 0, pendientes = 0, atrasados = 0;

            var html = '';
            members.forEach(function(m) {
                var name = escapeHtml(m.name || 'Usuario');
                var initial = name.charAt(0).toUpperCase();
                var positions = parseInt(m.num_positions) || 1;
                var cyclesPaid = parseInt(m.cycles_paid) || 0;
                var status = m.payment_status;

                // Adelantos detection
                var isAhead = cyclesPaid > currentCycle;
                if (isAhead) status = 'ahead';

                // Count stats
                if (status === 'paid' || status === 'ahead') alDia++;
                else if (status === 'late' || status === 'suspended') atrasados++;
                else pendientes++;

                var avatarStyle = isAhead ? 'background:rgba(34,197,94,0.15);color:#22c55e;' : phGetAvatarColor(m.payment_status);
                var statusPill = phGetStatusPill(m.payment_status, cyclesPaid, currentCycle);
                var turnLabel = m.turn_position ? 'Turno ' + escapeHtml(String(m.turn_position)) : '';
                var numPosBadge = positions > 1 ? ' <span class="ph-pill ph-pill-numpos">' + positions + ' num.</span>' : '';
                var progress = cyclesPaid + '/' + currentCycle + ' ciclos';
                var amountPending = parseFloat(m.amount_pending) || 0;
                var debtLine = amountPending > 0 ? '<div class="ph-member-debt">Debe: ' + phFormatAmount(amountPending) + '</div>' : '';

                html += '<div class="ph-member-row">' +
                    '<div class="ph-avatar" style="' + avatarStyle + '">' + escapeHtml(initial) + '</div>' +
                    '<div class="ph-member-info">' +
                        '<div class="ph-member-name">' + name + numPosBadge + '</div>' +
                        '<div class="ph-member-meta">' + turnLabel + (turnLabel ? ' &middot; ' : '') + statusPill + '</div>' +
                    '</div>' +
                    '<div class="ph-member-right">' +
                        '<div class="ph-member-progress">' + escapeHtml(progress) + '</div>' +
                        debtLine +
                    '</div>' +
                '</div>';
            });

            container.innerHTML = html;
            container.style.display = 'block';
            emptyDiv.style.display = 'none';

            // Update stats bar
            document.getElementById('phStatAlDia').textContent = alDia;
            document.getElementById('phStatPendientes').textContent = pendientes;
            document.getElementById('phStatAtrasados').textContent = atrasados;
            statsBar.style.display = 'grid';
        }

        function phRenderHistorial(cycleFilter) {
            var container = document.getElementById('phHistorialContent');
            var resumenDiv = document.getElementById('phResumenContent');
            var emptyDiv = document.getElementById('phEmpty');
            var statsBar = document.getElementById('phStatsBar');

            resumenDiv.style.display = 'none';
            statsBar.style.display = 'none';

            if (!phHistorialData || !phHistorialData.contributions || phHistorialData.contributions.length === 0) {
                container.style.display = 'none';
                emptyDiv.style.display = 'block';
                return;
            }

            var contributions = phHistorialData.contributions;
            var filterCycle = parseInt(cycleFilter) || 0;

            // Filter by cycle if selected
            if (filterCycle > 0) {
                contributions = contributions.filter(function(c) { return c.cycle_number === filterCycle; });
            }

            if (contributions.length === 0) {
                container.innerHTML = '<div class="ph-empty"><p>No hay pagos en este ciclo</p></div>';
                container.style.display = 'block';
                emptyDiv.style.display = 'none';
                return;
            }

            // Group by cycle (sort by cycle desc, then date desc)
            var sorted = contributions.slice().sort(function(a, b) {
                var ca = (a.cycle_number || 0);
                var cb = (b.cycle_number || 0);
                if (cb !== ca) return cb - ca;
                return new Date(b.created_at || 0) - new Date(a.created_at || 0);
            });

            var html = '';
            var lastCycle = null;

            sorted.forEach(function(c) {
                var cycle = c.cycle_number || 0;

                // Cycle header separator
                if (cycle !== lastCycle && filterCycle === 0) {
                    html += '<div class="ph-cycle-header"><span class="ph-cycle-badge-hdr">Ciclo ' + cycle + '</span></div>';
                    lastCycle = cycle;
                }

                var statusClass = (c.status === 'completed' || c.status === 'coordinator_approved') ? 'completed' : 'pending';
                var statusIcon = statusClass === 'completed' ?
                    '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>' :
                    '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>';

                var name = escapeHtml(c.user_name || 'Usuario');
                var initial = name.charAt(0).toUpperCase();
                var amount = phFormatAmount(c.amount);
                var dateStr = phFormatDate(c.created_at);
                var methodKey = c.payment_method || '';
                var methodLabel = escapeHtml(phMethodLabels[methodKey] || methodKey || 'N/A');

                // Verification line
                var verifiedLine = '';
                if (c.verified_by_name) {
                    var verifierName = escapeHtml(c.verified_by_name);
                    var vmLabel = phGetVerificationLabel(c.verification_method);
                    verifiedLine = '<div class="ph-verified-line">Registrado por ' + verifierName + '<span class="ph-verified-badge">' + escapeHtml(vmLabel) + '</span></div>';
                }

                html += '<div class="ph-contrib-card">' +
                    '<div class="ph-contrib-icon ' + statusClass + '">' + statusIcon + '</div>' +
                    '<div class="ph-contrib-info">' +
                        '<div class="ph-contrib-name">' + escapeHtml(initial) + ' &middot; ' + name + '</div>' +
                        '<div class="ph-contrib-detail">' + methodLabel + '<span class="ph-method-pill">Ciclo ' + cycle + '</span></div>' +
                        verifiedLine +
                    '</div>' +
                    '<div class="ph-contrib-right">' +
                        '<div class="ph-contrib-amount">' + amount + '</div>' +
                        '<div class="ph-contrib-date">' + escapeHtml(dateStr) + '</div>' +
                    '</div>' +
                '</div>';
            });

            // Totals summary at bottom
            if (phHistorialData.totals) {
                var t = phHistorialData.totals;
                html += '<div style="margin-top:12px;padding:10px 12px;background:#0f172a;border-radius:8px;border:1px solid #334155;display:flex;justify-content:space-between;font-size:0.78rem;">' +
                    '<span style="color:#64748b;">Total: <strong style="color:#e2e8f0;">' + (parseInt(t.total_count) || 0) + ' pagos</strong></span>' +
                    '<span style="color:#64748b;">Completado: <strong style="color:#00FFFF;">' + phFormatAmount(t.total_completed) + '</strong></span>' +
                '</div>';
            }

            container.innerHTML = html;
            container.style.display = 'block';
            emptyDiv.style.display = 'none';
        }

        function phSwitchTab(tab) {
            phCurrentTab = tab;
            var modal = document.getElementById('groupPaymentsModal');
            var tabs = modal.querySelectorAll('.ph-tab');
            tabs.forEach(function(t) { t.classList.remove('ph-tab-active'); });
            var activeTab = modal.querySelector('[data-action="ph-tab-' + tab + '"]');
            if (activeTab) activeTab.classList.add('ph-tab-active');

            var cycleFilter = document.getElementById('phCycleFilter');
            var cycleVal = cycleFilter ? cycleFilter.value : '0';

            if (tab === 'resumen') {
                phRenderResumen(cycleVal);
            } else {
                phRenderHistorial(cycleVal);
            }
        }

        function closePaymentsModal() {
            var modal = document.getElementById('groupPaymentsModal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
            phCurrentGroupId = null;
            currentPaymentsGroupId = null;
            phResumenData = null;
            phHistorialData = null;
        }

        // Close on overlay click
        document.addEventListener('DOMContentLoaded', function() {
            var modal = document.getElementById('groupPaymentsModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) closePaymentsModal();
                });
            }
            // Cycle filter change
            var cycleSelect = document.getElementById('phCycleFilter');
            if (cycleSelect) {
                cycleSelect.addEventListener('change', function() {
                    if (phCurrentTab === 'resumen') {
                        phRenderResumen(this.value);
                    } else {
                        phRenderHistorial(this.value);
                    }
                });
            }
        });



        // ============================================
        // INVITE MEMBERS MODAL
        // ============================================
        function inviteToGroup(groupId) {
            closeModal(); // Close admin modal first
            setTimeout(function() {
                showInviteModal(groupId);
            }, 100);
        }
        window.inviteToGroup = inviteToGroup;

        function showInviteModal(groupId) {
            currentInviteGroupId = groupId;
            var modal = document.getElementById('inviteMembersModal');
            if (!modal) return;

            // Reset form
            resetInviteForm();

            // Show modal
            modal.style.display = 'flex';
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function setInviteMethod(method) {
            currentInviteMethod = method;
            var emailBtn = document.getElementById('inviteMethodEmail');
            var phoneBtn = document.getElementById('inviteMethodPhone');
            var emailField = document.getElementById('inviteEmailField');
            var phoneField = document.getElementById('invitePhoneField');
            var emailInput = document.getElementById('inviteeEmail');
            var phoneInput = document.getElementById('inviteePhone');

            if (method === 'email') {
                emailBtn.classList.add('active');
                phoneBtn.classList.remove('active');
                emailField.style.display = 'block';
                phoneField.style.display = 'none';
                emailInput.required = true;
                phoneInput.required = false;
            } else {
                phoneBtn.classList.add('active');
                emailBtn.classList.remove('active');
                emailField.style.display = 'none';
                phoneField.style.display = 'block';
                emailInput.required = false;
                phoneInput.required = true;
            }
        }

        
        // Store the generated invite link
        var lastGeneratedInviteLink = '';
        
        // Copy invite link to clipboard
        function copyInviteLink() {
            var linkInput = document.getElementById('generatedInviteLink');
            if (linkInput && linkInput.value) {
                navigator.clipboard.writeText(linkInput.value).then(function() {
                    document.getElementById('inviteLinkCopied').style.display = 'block';
                    setTimeout(function() {
                        document.getElementById('inviteLinkCopied').style.display = 'none';
                    }, 3000);
                }).catch(function(err) {
                    // Fallback for older browsers
                    linkInput.select();
                    document.execCommand('copy');
                    document.getElementById('inviteLinkCopied').style.display = 'block';
                    setTimeout(function() {
                        document.getElementById('inviteLinkCopied').style.display = 'none';
                    }, 3000);
                });
            }
        }
        window.copyInviteLink = copyInviteLink;
        
        // Share via WhatsApp
        function shareViaWhatsApp() {
            var linkInput = document.getElementById('generatedInviteLink');
            if (linkInput && linkInput.value) {
                var inviteeName = document.getElementById('inviteeName').value.trim() || 'Amigo';
                var text = 'Hola ' + inviteeName + '! Te invito a unirte a mi grupo de ahorro en La Tanda. Usa este link: ' + linkInput.value;
                var whatsappUrl = 'https://wa.me/?text=' + encodeURIComponent(text);
                window.open(whatsappUrl, '_blank');
            }
        }
        window.shareViaWhatsApp = shareViaWhatsApp;

        // Share via Email
        function shareViaEmail() {
            var linkInput = document.getElementById('generatedInviteLink');
            if (linkInput && linkInput.value) {
                var inviteeName = document.getElementById('inviteeName').value.trim() || 'Amigo';
                var subject = encodeURIComponent('Invitacion a La Tanda - Grupo de Ahorro');
                var body = encodeURIComponent('Hola ' + inviteeName + '!\n\nTe invito a unirte a mi grupo de ahorro en La Tanda.\n\nUsa este link para unirte:\n' + linkInput.value + '\n\nSaludos!');
                var mailtoUrl = 'mailto:?subject=' + subject + '&body=' + body;
                window.location.href = mailtoUrl;
            }
        }
        window.shareViaEmail = shareViaEmail;

        // Simplified invitation - just generates a link
        async function submitSimpleInvitation(event) {
            event.preventDefault();

            var name = document.getElementById('inviteeName').value.trim();
            var message = document.getElementById('inviteMessage').value.trim();
            var errorDiv = document.getElementById('inviteError');
            var submitBtn = document.getElementById('inviteSubmitBtn');

            errorDiv.style.display = 'none';
            submitBtn.disabled = true;
            submitBtn.textContent = 'Generando...';

            try {
                var apiBase = window.API_BASE_URL || 'https://latanda.online';
                var userId = getCurrentUserId();

                // Check if a registered user was selected
                var selectedUserId = document.getElementById('selectedUserId') ? document.getElementById('selectedUserId').value : null;

                var inviteData = {
                    inviter_id: userId,
                    invitee_name: name || null,
                    message: message || null,
                    user_id: selectedUserId || null  // Include user_id if inviting existing user
                };

                var response = await fetch(apiBase + '/api/groups/' + currentInviteGroupId + '/members/invite', {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(inviteData)
                });

                var data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error('Error al crear invitacion');
                }

                // Get invitation token from response
                var inviteData = data.data || data;
                var token = inviteData.token || inviteData.invitation_token;
                
                if (!token) {
                    throw new Error('No se pudo obtener el token de invitacion');
                }

                // Store the invite link for sharing
                var inviteLink = 'https://latanda.online/invitaciones.html?token=' + token;
                window.currentInviteLink = inviteLink;
                
                // Set the link in the input field
                document.getElementById('generatedInviteLink').value = inviteLink;

                // Show success with link
                document.getElementById('inviteFormFields').style.display = 'none';
                document.getElementById('inviteFormFooter').style.display = 'none';
                document.getElementById('inviteSuccess').style.display = 'block';

                // Clear selected user after successful invitation
                if (typeof clearSelectedUser === 'function') {
                    clearSelectedUser();
                }

                if (typeof window.showSuccess === 'function') {
                    window.showSuccess(selectedUserId ? 'Invitacion enviada al usuario' : 'Link de invitacion generado');
                }

            } catch (err) {
                errorDiv.textContent = 'Error al crear la invitacion';
                errorDiv.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Generar Link';
            }
        }
        window.submitSimpleInvitation = submitSimpleInvitation;


        function resetInviteForm() {
            document.getElementById('inviteForm').reset();
            document.getElementById('inviteFormFields').style.display = 'block';
            document.getElementById('inviteFormFooter').style.display = 'flex';
            document.getElementById('inviteSuccess').style.display = 'none';
            document.getElementById('inviteError').style.display = 'none';
            document.getElementById('inviteSubmitBtn').disabled = false;
            // setInviteMethod removed - simplified form
        }

        async function submitInvitation(event) {
            event.preventDefault();

            var name = document.getElementById('inviteeName').value.trim();
            var email = document.getElementById('inviteeEmail').value.trim();
            var phone = document.getElementById('inviteePhone').value.trim();
            var message = document.getElementById('inviteMessage').value.trim();
            var errorDiv = document.getElementById('inviteError');
            var submitBtn = document.getElementById('inviteSubmitBtn');

            // Validation
            if (currentInviteMethod === 'email' && !email) {
                errorDiv.textContent = 'Por favor ingresa un email';
                errorDiv.style.display = 'block';
                return;
            }
            if (currentInviteMethod === 'phone' && !phone) {
                errorDiv.textContent = 'Por favor ingresa un telefono';
                errorDiv.style.display = 'block';
                return;
            }

            errorDiv.style.display = 'none';
            submitBtn.disabled = true;
            submitBtn.textContent = 'Enviando...';

            try {
                var apiBase = window.API_BASE_URL || 'https://latanda.online';
                var userId = getCurrentUserId();

                var inviteData = {
                    inviter_id: userId,
                    invitee_name: name || null,
                    message: message || null
                };

                if (currentInviteMethod === 'email') {
                    inviteData.invitee_email = email;
                } else {
                    inviteData.invitee_phone = phone;
                }

                var response = await fetch(apiBase + '/api/groups/' + currentInviteGroupId + '/members/invite', {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(inviteData)
                });

                var data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.data?.error?.message || 'Error al enviar invitacion');
                }

                // Show success
                document.getElementById('inviteFormFields').style.display = 'none';
                document.getElementById('inviteFormFooter').style.display = 'none';
                document.getElementById('inviteSuccess').style.display = 'block';

                if (typeof window.showSuccess === 'function') {
                    window.showSuccess('Invitacion enviada exitosamente');
                    // Refresh groups to show updated member count
                    if (typeof fetchMyGroups === 'function') fetchMyGroups();
                }

            } catch (err) {
                errorDiv.textContent = 'Error al enviar la invitacion';
                errorDiv.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Enviar Invitacion';
            }
        }

        function closeInviteModal() {
            var modal = document.getElementById('inviteMembersModal');
            if (modal) {
                modal.style.display = 'none'; modal.classList.remove('active');
                document.body.style.overflow = '';
            }
            currentInviteGroupId = null;
        }

        // Close on overlay click
        document.addEventListener('DOMContentLoaded', function() {
            var modal = document.getElementById('inviteMembersModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) closeInviteModal();
                });
            }
        });


        // ============================================
        // PENDING INVITATIONS & REMINDERS
        // ============================================
        
        async function loadPendingInvitations(groupId) {
            try {
                var apiBase = window.API_BASE_URL || "https://latanda.online";
                var userId = getCurrentUserId();
                var response = await fetch(apiBase + "/api/invitations/sent/" + userId, { headers: getAuthHeaders() });
                var data = await response.json();
                
                if (data.success && data.data && data.data.invitations) {
                    var groupInvitations = data.data.invitations.filter(function(inv) {
                        return inv.group_id === groupId && inv.status === "pending";
                    });
                    
                    var container = document.getElementById("pendingInvitationsList");
                    if (!container) return;
                    
                    if (groupInvitations.length === 0) {
                        container.innerHTML = "<p style=\"font-size: 0.875rem; color: #9ca3af; text-align: center; padding: 1rem;\">No hay invitaciones pendientes</p>";
                        return;
                    }
                    
                    var html = "";
                    groupInvitations.forEach(function(inv) {
                        var name = inv.invitee_name || inv.invitee_email || inv.invitee_phone || "Invitado";
                        var safeName = name.replace(/\x27/g, "\\\x27");
                        var contact = inv.invitee_email || inv.invitee_phone || "";
                        var expiresDate = new Date(inv.expires_at);
                        var isExpired = expiresDate < new Date();
                        var reminderCount = inv.reminder_count || 0;
                        var lastReminded = inv.last_reminded_at ? new Date(inv.last_reminded_at) : null;
                        var canRemind = true;
                        
                        if (lastReminded) {
                            var hoursSince = (Date.now() - lastReminded.getTime()) / (1000 * 60 * 60);
                            canRemind = hoursSince >= 24;
                        }
                        
                        html += "<div class=\"invitation-card\" style=\"background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 0.75rem 1rem; margin-bottom: 0.5rem; display: flex; align-items: center; justify-content: space-between;\">";
                        html += "<div style=\"flex: 1;\">";
                        html += "<div style=\"font-weight: 500; font-size: 0.875rem; color: #e2e8f0;\">" + escapeHtml(name) + "</div>";
                        if (contact) {
                            html += "<div style=\"font-size: 0.75rem; color: #94a3b8;\">" + escapeHtml(contact) + "</div>";
                        }
                        if (reminderCount > 0) {
                            html += "<div style=\"font-size: 0.7rem; color: #9ca3af; margin-top: 0.25rem;\">Recordatorios enviados: " + reminderCount + "</div>";
                        }
                        html += "</div>";
                        
                        if (!isExpired && canRemind) {
                            html += "<button type=\"button\" data-action=\"grp-send-reminder\" data-group-id=\"" + groupId + "\" data-invitation-id=\"" + inv.id + "\" data-invitee-name=\"" + escapeHtml(safeName) + "\" class=\"action-btn\" style=\"background: rgba(139, 92, 246, 0.1); color: #8b5cf6; font-size: 0.8rem; padding: 0.5rem 0.75rem;\">";
                            html += "<svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><path d=\"M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z\"/></svg>";
                            html += " Recordar";
                            html += "</button>";
                        } else if (!canRemind) {
                            html += "<span style=\"font-size: 0.7rem; color: #9ca3af;\">Espera 24h</span>";
                        } else if (isExpired) {
                            html += "<span style=\"font-size: 0.7rem; color: #ef4444;\">Expirado</span>";
                        }

                        // Delete button - always show for pending invitations
                        html += "<button type=\"button\" data-action=\"grp-delete-invitation\" data-group-id=\"" + groupId + "\" data-invitation-id=\"" + inv.id + "\" data-invitee-name=\"" + escapeHtml(safeName) + "\" style=\"background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 6px 8px; border: none; border-radius: 6px; cursor: pointer; margin-left: 8px; display: inline-flex; align-items: center;\" title=\"Eliminar\">";                        html += "<svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><polyline points=\"3 6 5 6 21 6\"/><path d=\"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2\"/></svg>";                        html += "</button>";
                        
                        html += "</div>";
                    });
                    
                    container.innerHTML = html;
                }
            } catch (err) {
            }
        }
        window.loadPendingInvitations = loadPendingInvitations;

        // Delete pending invitation
        async function deleteInvitation(groupId, invitationId, inviteeName) {
            showConfirm("Eliminar la invitacion para " + escapeHtml(inviteeName) + "? Esta accion no se puede deshacer.", async function() {
            try {
                var apiBase = window.API_BASE_URL || "https://latanda.online";
                var response = await fetch(apiBase + "/api/groups/" + groupId + "/invitations/" + invitationId, {
                    method: "DELETE",
                    headers: getAuthHeaders()
                });
                var result = await response.json();

                if (result.success) {
                    showNotification("Invitación eliminada", "success");
                    loadPendingInvitations(groupId);
                } else {
                    showNotification("Error al eliminar la invitacion", "error");
                }
            } catch (err) {
                showNotification("Error al eliminar invitacion", "error");
            }
            }); // end showConfirm
        }
        window.deleteInvitation = deleteInvitation;
        
        // Send invitation reminder with promotional card
        async function sendInvitationReminder(groupId, invitationId, inviteeName) {
            try {
                var apiBase = window.API_BASE_URL || "https://latanda.online";
                var response = await fetch(apiBase + "/api/groups/" + groupId + "/invitations/" + invitationId + "/remind", {
                    method: "POST",
                    headers: Object.assign({}, getAuthHeaders(), {"Content-Type": "application/json"})
                });
                var result = await response.json();
                
                if (result.success) {
                    var data = result.data || result;
                    showNotification("Recordatorio registrado para " + inviteeName, "success");
                    
                    var groupData = null;
                    if (window.myGroupsCache) {
                        groupData = window.myGroupsCache.find(function(g) { return g.group_id === groupId; });
                    }
                    if (!groupData && window.currentGroupsData) {
                        groupData = window.currentGroupsData.find(function(g) { return g.group_id === groupId; });
                    }
                    
                    if (data.invite_link) {
                        if (!window.InvitationCardGenerator && window.LaTandaComponentLoader) {
                            await LaTandaComponentLoader.loadInvitationCards();
                        }
                        
                        if (window.InvitationCardGenerator) {
                            var currentUser = JSON.parse(localStorage.getItem("latanda_user") || "{}");
                            var inviterName = currentUser.name || currentUser.email || "Tu amigo";
                            
                            InvitationCardGenerator.show({
                                groupName: groupData ? groupData.name : "Grupo de Ahorro",
                                groupDesc: groupData ? (groupData.description || "Únete a nuestra tanda") : "Únete a nuestra tanda",
                                contribution: groupData ? parseFloat(groupData.contribution_amount) : 0,
                                frequency: groupData ? groupData.frequency : "monthly",
                                members: groupData ? parseInt(groupData.members_count || groupData.member_count || 0) : 0,
                                maxMembers: groupData ? parseInt(groupData.max_members) : 10,
                                inviteLink: data.invite_link,
                                inviterName: inviterName,
                                theme: "purple"
                            });
                        } else {
                            showConfirm("Compartir el link de invitacion por WhatsApp?", function() {
                                var text = "Hola " + inviteeName + "! Te recuerdo que tienes una invitacion pendiente. Usa este link: " + data.invite_link;
                                var whatsappUrl = "https://wa.me/?text=" + encodeURIComponent(text);
                                window.open(whatsappUrl, "_blank");
                            });
                        }
                    }
                    
                    loadPendingInvitations(groupId);
                } else {
                    showNotification("Error al enviar recordatorio", "error");
                }
            } catch (err) {
                showNotification("Error de conexion", "error");
            }
        }
        window.sendInvitationReminder = sendInvitationReminder;

        // ============================================
        // USER SEARCH FOR INVITATIONS
        // ============================================
        var userSearchTimeout = null;
        var selectedInviteUser = null;

        async function searchUsersToInvite(query) {
            clearTimeout(userSearchTimeout);
            var resultsDiv = document.getElementById('userSearchResults');

            if (!query || query.length < 2) {
                resultsDiv.innerHTML = '';
                return;
            }

            userSearchTimeout = setTimeout(async function() {
                try {
                    resultsDiv.innerHTML = '<p style="font-size: 0.8125rem; color: #94a3b8; padding: 8px;">Buscando...</p>';

                    var apiBase = window.API_BASE_URL || 'https://latanda.online';
                    var groupId = currentInviteGroupId || '';
                    var response = await fetch(apiBase + '/api/users/search-to-invite?q=' + encodeURIComponent(query) + '&group_id=' + groupId, {
                        headers: getAuthHeaders()
                    });
                    var result = await response.json();

                    if (result.success && result.data.users.length > 0) {
                        var html = '';
                        result.data.users.forEach(function(user) {
                            html += '<div data-action="grp-select-invite-user" data-user-id="' + escapeHtml(user.user_id) + '" data-user-name="' + escapeHtml(user.name) + '" data-user-email="' + escapeHtml(user.email_masked) + '" ';
                            html += 'class="grp-search-result-item" style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.06); display: flex; justify-content: space-between; align-items: center;">';
                            html += '<div>';
                            html += '<div style="font-weight: 500; color: #f8fafc;">' + escapeHtml(user.name) + '</div>';
                            html += '<div style="font-size: 0.75rem; color: #94a3b8;">' + escapeHtml(user.email_masked) + '</div>';
                            html += '</div>';
                            html += '<span style="font-size: 0.6875rem; padding: 2px 6px; border-radius: 4px; ' + (user.status === 'verified' ? 'background: rgba(16,185,129,0.15); color: #10b981;' : 'background: rgba(245,158,11,0.15); color: #f59e0b;') + '">' + (user.status === 'verified' ? 'Verificado' : 'Sin verificar') + '</span>';
                            html += '</div>';
                        });
                        resultsDiv.innerHTML = html;
                    } else {
                        resultsDiv.innerHTML = '<p style="font-size: 0.8125rem; color: #9ca3af; padding: 8px; text-align: center;">No se encontraron usuarios</p>';
                    }
                } catch (err) {
                    resultsDiv.innerHTML = '<p style="font-size: 0.8125rem; color: #dc2626; padding: 8px;">Error al buscar</p>';
                }
            }, 300);
        }

        function selectUserToInvite(userId, userName, userEmail) {
            selectedInviteUser = { user_id: userId, name: userName, email: userEmail };

            document.getElementById('userSearchResults').innerHTML = '';
            document.getElementById('userSearchInput').value = '';

            document.getElementById('selectedUserId').value = userId;
            document.getElementById('selectedUserName').textContent = userName;
            document.getElementById('selectedUserEmail').textContent = userEmail;
            document.getElementById('selectedUserDisplay').style.display = 'block';

            // Update the invitee name field
            document.getElementById('inviteeName').value = userName;
        }

        function clearSelectedUser() {
            selectedInviteUser = null;
            document.getElementById('selectedUserId').value = '';
            document.getElementById('selectedUserDisplay').style.display = 'none';
            document.getElementById('inviteeName').value = '';
        }

        window.searchUsersToInvite = searchUsersToInvite;
        window.selectUserToInvite = selectUserToInvite;
        window.clearSelectedUser = clearSelectedUser;



        // ============================================
        // REMOVE MEMBER FUNCTIONALITY
        // ============================================
        var pendingRemoveMember = { groupId: null, userId: null, userName: null };
        
        async function confirmRemoveMember(groupId, userId, userName) {
            pendingRemoveMember = { groupId: groupId, userId: userId, userName: userName };
            showConfirm("Estas seguro de que deseas remover a " + escapeHtml(userName) + " del grupo?\n\nEsta accion no se puede deshacer.", async function() {
                await executeRemoveMember();
            });
        }
        window.confirmRemoveMember = confirmRemoveMember;
        
        async function executeRemoveMember() {
            if (!pendingRemoveMember.groupId || !pendingRemoveMember.userId) return;
            
            try {
                var apiBase = window.API_BASE_URL || "https://latanda.online";
                var response = await fetch(apiBase + "/api/groups/" + pendingRemoveMember.groupId + "/members/" + pendingRemoveMember.userId, {
                    method: "DELETE",
                    headers: Object.assign({}, getAuthHeaders(), {"Content-Type": "application/json"}),
                    body: JSON.stringify({ action: "remove" })
                });
                var result = await response.json();
                
                if (result.success) {
                    showNotification(pendingRemoveMember.userName + " ha sido removido del grupo", "success");
                    showMembersModal(pendingRemoveMember.groupId);
                    pendingRemoveMember = { groupId: null, userId: null, userName: null };
                } else {
                    showNotification("No se pudo remover al miembro", "error");
                }
            } catch (err) {
                showNotification("Error de conexion", "error");
            }
        }
        window.executeRemoveMember = executeRemoveMember;




    </script>


    <script>
        // ============================================
        // EDIT GROUP MODAL FUNCTIONS
        // ============================================
        var currentEditGroupId = null;

        function editGroup(groupId) {
            closeModal(); // Close admin modal first
            setTimeout(function() {
                showEditGroupModal(groupId);
            }, 100);
        }
        window.editGroup = editGroup;

        async function showEditGroupModal(groupId) {
            currentEditGroupId = groupId;
            var modal = document.getElementById('editGroupModal');
            var loading = document.getElementById('editGroupLoading');
            var formFields = document.getElementById('editGroupFormFields');
            var success = document.getElementById('editGroupSuccess');

            // Reset state
            if (loading) loading.style.display = 'flex';
            if (formFields) formFields.style.display = 'none';
            if (success) success.style.display = 'none';

            var errorDiv = document.getElementById('editGroupError');
            if (errorDiv) errorDiv.style.display = 'none';

            var submitBtn = document.getElementById('editGroupSubmitBtn');
            if (submitBtn) submitBtn.disabled = false;

            var footer = document.getElementById('editGroupFormFooter');
            if (footer) footer.style.display = 'flex';

            // Show modal
            modal.style.display = 'flex'; modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Load group data
            try {
                var apiBase = window.API_BASE_URL || 'https://latanda.online';
                var response = await fetch(apiBase + '/api/groups/' + groupId, { headers: getAuthHeaders() });
                var data = await response.json();

                if (!data.success) {
                    throw new Error('Error al cargar datos del grupo');
                }

                var group = data.data.data || data.data;

                // Populate form
                document.getElementById('editGroupName').value = group.name || '';
                document.getElementById('editGroupDescription').value = group.description || '';
                document.getElementById('editGroupAmount').value = group.contribution_amount || '';
                document.getElementById('editGroupFrequency').value = group.frequency || 'weekly';
                document.getElementById('editGroupMaxMembers').value = group.max_members || '';
                document.getElementById('editGroupLocation').value = group.location || '';
                document.getElementById('editGroupStartDate').value = group.start_date ? group.start_date.split('T')[0] : '';
                document.getElementById('editGroupStatus').value = group.status || 'active';

                var thresholdField = document.getElementById('editGroupThreshold');
                if (thresholdField) thresholdField.value = group.advance_threshold || 80;

                if (loading) loading.style.display = 'none';
                if (formFields) formFields.style.display = 'block';

            } catch (err) {
                if (loading) {
                    loading.innerHTML = '<p style="color: #ef4444;">Error al cargar datos</p><button type="button" data-action="grp-retry-edit-load" style="margin-top: 16px; padding: 10px 20px; background: rgba(0,255,255,0.2); color: #00FFFF; border: 1px solid rgba(0,255,255,0.3); border-radius: 8px; cursor: pointer;">Reintentar</button>';
                }
            }
        }

        function closeEditGroupModal() {
            var modal = document.getElementById('editGroupModal');
            if (modal) {
                modal.style.display = 'none'; modal.classList.remove('active');
                document.body.style.overflow = '';
            }
            currentEditGroupId = null;
        }

        // ===== DELETE GROUP FUNCTIONALITY =====
        var deleteGroupId = null;
        
        function confirmDeleteGroup(groupId) {
            deleteGroupId = groupId;
            
            // Find the group to show its name
            var group = (window.currentGroupsData || []).find(function(g) { return g.group_id == groupId || g.id == groupId; });
            var groupName = group ? group.name : 'este grupo';
            
            // Update modal content
            document.getElementById('deleteGroupName').textContent = groupName;
            
            // Show modal
            var modal = document.getElementById('deleteGroupModal');
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
            
            // Close admin modal if open
            var adminModal = document.getElementById('groupManageModal');
            if (adminModal) {
                adminModal.style.display = 'none';
            }
        }
        window.confirmDeleteGroup = confirmDeleteGroup;
        
        function closeDeleteGroupModal() {
            var modal = document.getElementById('deleteGroupModal');
            if (modal) {
                modal.style.display = 'none'; modal.classList.remove('active');
                document.body.style.overflow = '';
            }
            deleteGroupId = null;
        }
        
        async function executeDeleteGroup() {
            if (!deleteGroupId) {
                showNotification('Error: No se seleccionó ningún grupo', 'error');
                return;
            }
            
            var deleteBtn = document.getElementById('confirmDeleteBtn');
            if (deleteBtn) {
                deleteBtn.disabled = true;
                deleteBtn.innerHTML = '<span class="spinner-small"></span> Eliminando...';
            }
            
            try {
                var response = await fetch((window.API_BASE_URL || 'https://latanda.online') + '/api/groups/' + deleteGroupId, {
                    method: 'DELETE',
                    headers: { ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    }
                });
                
                var result = await response.json();
                
                if (response.ok && result.success) {
                    showNotification('Grupo eliminado exitosamente', 'success');
                    closeDeleteGroupModal();
                    
                    // Refresh groups list
                    await fetchMyGroups();
                    renderGroups();

                    // Also refresh tandas tab to sync turn positions
                    if (typeof refreshTandas === 'function') {
                        refreshTandas();
                    }
                } else {
                    var errorMsg = 'No se pudo eliminar el grupo';
                    
                    // Special handling for groups with contributions
                    if (errorMsg.includes('contribuciones') || errorMsg.includes('contributions')) {
                        showNotification('No se puede eliminar: el grupo tiene contribuciones registradas. Debe completar el ciclo.', 'error');
                    } else {
                        showNotification(errorMsg, 'error');
                    }
                }
            } catch (error) {
                showNotification('Error de conexión al eliminar grupo', 'error');
            } finally {
                if (deleteBtn) {
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML = 'Sí, Eliminar Grupo';
                }
            }
        }
        // Expose delete functions to window
        window.confirmDeleteGroup = confirmDeleteGroup;
        window.closeDeleteGroupModal = closeDeleteGroupModal;
        window.executeDeleteGroup = executeDeleteGroup;
        // ===== END DELETE GROUP FUNCTIONALITY =====

        // ===== MANAGE TURNS FUNCTIONALITY =====
        var manageTurnsGroupId = null;
        var turnsMembers = [];
        
        async function manageTurns(groupId) {
            manageTurnsGroupId = groupId;
            
            // Close admin modal if open
            var adminModal = document.getElementById('groupManageModal');
            if (adminModal) {
                adminModal.style.display = 'none';
            }
            
            // Show loading in modal
            var modal = document.getElementById('manageTurnsModal');
            if (modal) {
                modal.style.display = 'flex';
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
            
            // Load members with their turn positions
            // Load expanded turns system if not loaded
            try { if (!window.expandMembersToPositions && window.LaTandaComponentLoader) {
                await LaTandaComponentLoader.loadExpandedTurns(); } } catch(e) { /* expanded turns optional — fails silently if not available */ }
            
            await loadTurnsMembers(groupId);
        }
        
        async function loadTurnsMembers(groupId) {
            var loadingDiv = document.getElementById('turnsLoading');
            var contentDiv = document.getElementById('turnsContent');
            var errorDiv = document.getElementById('turnsError');
            
            if (loadingDiv) loadingDiv.style.display = 'block';
            if (contentDiv) contentDiv.style.display = 'none';
            if (errorDiv) errorDiv.style.display = 'none';
            
            try {
                var response = await fetch((window.API_BASE_URL || 'https://latanda.online') + '/api/groups/' + groupId + '/members', { headers: getAuthHeaders() });
                var result = await response.json();
                
                if (result.success && (result.members || result.data?.members)) {
                    turnsMembers = (result.members || result.data?.members || []).map(function(m) {
                        m.turn_locked = m.turn_locked || false;
                        m.num_positions = parseInt(m.num_positions) || 1;
                        return m;
                    }).sort(function(a, b) {
                        return (a.turn_position || 999) - (b.turn_position || 999);
                    });
                    // Use expanded_order from API if available, otherwise expand from members
                    var expandedOrder = result.expanded_order || result.data?.expanded_order;
                    if (expandedOrder && expandedOrder.length > 0) {
                        // Reconstruct expandedTurns from server's expanded_order
                        var memberMap = {};
                        turnsMembers.forEach(function(m) { memberMap[m.user_id] = m; });
                        
                        window.expandedTurns = expandedOrder.map(function(pos) {
                            var member = memberMap[pos.user_id];
                            var posLocks = member ? (member.position_locks || []) : [];
                            var lockInfo = posLocks[pos.slot] || {};
                            return {
                                user_id: pos.user_id,
                                name: member ? member.name : 'Usuario',
                                role: member ? member.role : 'member',
                                slot_index: pos.slot || 0,
                                total_slots: member ? member.num_positions : 1,
                                turn_locked: lockInfo.locked === true,
                                original_member: member
                            };
                        });
                    } else if (window.expandMembersToPositions) {
                        // Fallback: expand from members (positions will be consecutive)
                        window.expandedTurns = window.expandMembersToPositions(turnsMembers);
                    }
                    renderTurnsList();
                } else {
                    showTurnsError('No se pudieron cargar los miembros');
                }
            } catch (error) {
            } finally {
                if (loadingDiv) loadingDiv.style.display = 'none';
            }
        }
        
function renderTurnsList() {
            var contentDiv = document.getElementById('turnsContent');
            if (!contentDiv) return;
            
            // Use expanded turns if available, otherwise fall back to turnsMembers
            var displayList = window.expandedTurns || turnsMembers.map(function(m, i) {
                return { user_id: m.user_id, name: m.name || m.full_name, role: m.role, slot_index: 0, total_slots: 1, turn_locked: m.turn_locked };
            });
            
            // Lottery action bar
            var actionsHtml = '<div style="display: flex; gap: 10px; margin-bottom: 16px; padding: 12px; background: rgba(245,158,11,0.1); border-radius: 10px; border: 1px solid rgba(245,158,11,0.3); flex-wrap: wrap;">' +
                '<button data-action="grp-start-lottery-countdown" style="flex: 1; min-width: 140px; padding: 10px 16px; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;"><span style="font-size: 1.2rem;">🎲</span> Iniciar Ahora</button>' +
                '<button data-action="grp-open-schedule-lottery" style="flex: 1; min-width: 140px; padding: 10px 16px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;"><span style="font-size: 1.2rem;">📅</span> Programar</button>' +
            '</div>';
            
            var html = actionsHtml + '<div id="turnsList" style="display: flex; flex-direction: column; gap: 8px;">';
            
            displayList.forEach(function(pos, index) {
                var position = index + 1;
                var isLocked = pos.turn_locked === true;
                var lockIcon = isLocked ? '🔒' : '🔓';
                var lockBg = isLocked ? '#059669' : '#374151';
                var itemBg = isLocked ? '#1e3a3a' : '#1e293b';
                var itemBorder = isLocked ? '#059669' : '#334155';
                
                // Show name with position indicator if member has multiple slots
                var displayName = pos.name || 'Usuario';
                if (pos.total_slots > 1) {
                    displayName += ' ' + (pos.slot_index + 1) + '/' + pos.total_slots;
                }
                
                var roleText = (pos.role === 'creator' || pos.role === 'admin') ? 'Administrador' : 'Miembro';
                if (isLocked) roleText += ' • Anclado';
                
                html += '<div class="turn-item' + (isLocked ? ' turn-locked' : '') + '" ' + 
                    (!isLocked ? 'draggable="true"' : '') + 
                    ' data-user-id="' + pos.user_id + '" data-index="' + index + '" data-slot="' + pos.slot_index + '" data-locked="' + isLocked + '" ' +
                    'style="display: flex; align-items: center; gap: 12px; padding: 12px; background: ' + itemBg + '; border: 1px solid ' + itemBorder + '; border-radius: 10px; cursor: ' + (!isLocked ? 'grab' : 'default') + ';">' +
                    '<div style="width: 32px; height: 32px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; color: white; font-size: 0.875rem;">' + position + '</div>' +
                    '<div style="flex: 1;">' +
                        '<div style="font-weight: 500; color: #f8fafc;">' + displayName + '</div>' +
                        '<div style="font-size: 0.75rem; color: #9ca3af;">' + roleText + '</div>' +
                    '</div>' +
                    '<button data-action="grp-toggle-lock" data-index="' + index + '" style="width: 32px; height: 32px; background: ' + lockBg + '; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem;" title="' + (isLocked ? 'Desbloquear' : 'Anclar posicion') + '">' + lockIcon + '</button>' +
                    '<div style="display: flex; align-items: center; gap: 3px; background: #374151; padding: 4px 6px; border-radius: 6px;" title="Posiciones">' +
                        '<button data-action="grp-remove-position" data-user-id="' + pos.user_id + '" data-slot="' + pos.slot_index + '" style="width: 22px; height: 22px; background: ' + (pos.total_slots > 1 ? '#dc2626' : '#4b5563') + '; border: none; border-radius: 4px; color: white; cursor: ' + (pos.total_slots > 1 ? 'pointer' : 'not-allowed') + '; font-size: 1rem; opacity: ' + (pos.total_slots > 1 ? '1' : '0.4') + ';" ' + (pos.total_slots > 1 ? '' : 'disabled') + '>-</button>' +
                        '<span style="min-width: 20px; text-align: center; color: #f59e0b; font-weight: 600; font-size: 0.85rem;">' + pos.total_slots + '</span>' +
                        '<button data-action="grp-add-position" data-user-id="' + pos.user_id + '" style="width: 22px; height: 22px; background: #059669; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 1rem;">+</button>' +
                    '</div>' +
                    '<div style="display: flex; gap: 4px;">' +
                        '<button data-action="grp-move-up" data-index="' + index + '" style="width: 28px; height: 28px; background: #374151; border: none; border-radius: 6px; color: ' + (isLocked ? '#4b5563' : '#9ca3af') + '; cursor: ' + (isLocked || index === 0 ? 'not-allowed' : 'pointer') + '; display: flex; align-items: center; justify-content: center; opacity: ' + (isLocked || index === 0 ? '0.3' : '1') + ';" ' + (isLocked || index === 0 ? 'disabled' : '') + '>' +
                            '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 15l-6-6-6 6"/></svg>' +
                        '</button>' +
                        '<button data-action="grp-move-down" data-index="' + index + '" style="width: 28px; height: 28px; background: #374151; border: none; border-radius: 6px; color: ' + (isLocked ? '#4b5563' : '#9ca3af') + '; cursor: ' + (isLocked || index === displayList.length - 1 ? 'not-allowed' : 'pointer') + '; display: flex; align-items: center; justify-content: center; opacity: ' + (isLocked || index === displayList.length - 1 ? '0.3' : '1') + ';" ' + (isLocked || index === displayList.length - 1 ? 'disabled' : '') + '>' +
                            '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>' +
                        '</button>' +
                    '</div>' +
                    (pos.slot_index === 0 ? '<button data-action="grp-remove-from-turns" data-user-id="' + pos.user_id + '" style="width: 28px; height: 28px; background: #dc2626; border: none; border-radius: 6px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 700; margin-left: 2px;" title="Eliminar del turno">&#x2715;</button>' : '') +
                '</div>';
            });
            
            html += '</div>';
            contentDiv.innerHTML = html;
            contentDiv.style.display = 'block';
            
            // Enable drag and drop (only for unlocked items)
            initExpandedDragAndDrop();
        }
        
        // Move position up in expanded list
        function moveExpandedUp(index) {
            if (!window.expandedTurns || index <= 0) return;
            if (window.expandedTurns[index].turn_locked) return;
            // Also check if destination is locked
            if (window.expandedTurns[index - 1].turn_locked) return;
            var temp = window.expandedTurns[index];
            window.expandedTurns[index] = window.expandedTurns[index - 1];
            window.expandedTurns[index - 1] = temp;
            renderTurnsList();
        }
        
        // Move position down in expanded list
        function moveExpandedDown(index) {
            if (!window.expandedTurns) return;
            if (window.expandedTurns[index].turn_locked) return;
            if (index >= window.expandedTurns.length - 1) return;
            // Also check if destination is locked
            if (window.expandedTurns[index + 1].turn_locked) return;
            var temp = window.expandedTurns[index];
            window.expandedTurns[index] = window.expandedTurns[index + 1];
            window.expandedTurns[index + 1] = temp;
            renderTurnsList();
        }
        
        // Toggle lock on expanded position
        function toggleExpandedLock(index) {
            if (!window.expandedTurns || index < 0 || index >= window.expandedTurns.length) return;
            window.expandedTurns[index].turn_locked = !window.expandedTurns[index].turn_locked;
            renderTurnsList();
        }
        
        // Drag and drop for expanded turns
        function initExpandedDragAndDrop() {
            var items = document.querySelectorAll('.turn-item');
            var draggedItem = null;
            
            items.forEach(function(item) {
                item.addEventListener('dragstart', function(e) {
                    if (this.dataset.locked === 'true') {
                        e.preventDefault();
                        return;
                    }
                    draggedItem = this;
                    this.style.opacity = '0.5';
                });
                
                item.addEventListener('dragend', function(e) {
                    this.style.opacity = '1';
                    draggedItem = null;
                });
                
                item.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    if (this.dataset.locked !== 'true') {
                        this.style.borderColor = '#f59e0b';
                    }
                });
                
                item.addEventListener('dragleave', function(e) {
                    this.style.borderColor = this.dataset.locked === 'true' ? '#059669' : '#334155';
                });
                
                item.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.style.borderColor = this.dataset.locked === 'true' ? '#059669' : '#334155';
                    
                    if (draggedItem && draggedItem !== this && window.expandedTurns) {
                        var fromIndex = parseInt(draggedItem.dataset.index);
                        var toIndex = parseInt(this.dataset.index);
                        
                        // Check if either position is locked
                        if (window.expandedTurns[fromIndex].turn_locked || window.expandedTurns[toIndex].turn_locked) {
                            return;
                        }
                        
                        // Reorder array
                        var item = window.expandedTurns.splice(fromIndex, 1)[0];
                        window.expandedTurns.splice(toIndex, 0, item);
                        renderTurnsList();
                    }
                });
            });
        }
        
        // Expose new functions to window
        window.moveExpandedUp = moveExpandedUp;
        window.moveExpandedDown = moveExpandedDown;
        window.toggleExpandedLock = toggleExpandedLock;

        // Add position for a member
        function addExpandedPosition(userId) {
            if (window.addPositionForMember) {
                window.addPositionForMember(userId);
            } else {
            }
        }
        window.addExpandedPosition = addExpandedPosition;

        // Remove position for a member
        function removeExpandedPosition(userId, slotIndex) {
            if (window.removePositionForMember) {
                window.removePositionForMember(userId, slotIndex);
            } else {
            }
        }
        window.removeExpandedPosition = removeExpandedPosition;

        function showTurnsError(message) {
            var errorDiv = document.getElementById('turnsError');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }
        
        function closeManageTurnsModal() {
            var modal = document.getElementById('manageTurnsModal');
            if (modal) {
                modal.style.display = 'none'; modal.classList.remove('active');
                document.body.style.overflow = '';
            }
            manageTurnsGroupId = null;
            turnsMembers = [];
        }
        
        async function saveTurnsOrder() {
            var saveBtn = document.getElementById('saveTurnsBtn');
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<span class="spinner-small"></span> Guardando...';
            }
            
            try {
                // Collapse expanded positions back to member format
                var collapsedMembers = window.collapsePositionsToMembers && window.expandedTurns ? window.collapsePositionsToMembers(window.expandedTurns) : turnsMembers;
                
                var memberTurns = collapsedMembers.map(function(member, index) {
                    return {
                        user_id: member.user_id,
                        new_position: index + 1,
                        turn_locked: member.turn_locked || false,
                        num_positions: member.num_positions || 1,
                        position_locks: member.position_locks || []
                    };
                });
                
                var response = await fetch((window.API_BASE_URL || 'https://latanda.online') + '/api/groups/' + manageTurnsGroupId + '/reorder-turns', {
                    method: 'PUT',
                    headers: { ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ member_turns: memberTurns, expanded_turns: window.expandedTurns })
                });
                
                var result = await response.json();
                
                if (response.ok && result.success) {
                    showNotification('Turnos actualizados exitosamente', 'success');
                    closeManageTurnsModal();
                    
                    // Refresh groups
                    await fetchMyGroups();
                    renderGroups();

                    // Also refresh tandas tab to sync turn positions
                    if (typeof refreshTandas === 'function') {
                        refreshTandas();
                    }
                } else {
                    showNotification('Error al guardar turnos', 'error');
                }
            } catch (error) {
                showNotification('Error de conexion al guardar', 'error');
            } finally {
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = 'Guardar Cambios';
                }
            }
        }
        // Expose functions to window for onclick
        window.manageTurns = manageTurns;

        // Toggle tanda pause status
        async function toggleTandaPause(groupId) {
            if (!groupId) {
                showNotification("Error: ID de grupo no especificado", "error");
                return;
            }
            
            try {
                var apiBase = window.API_BASE_URL || "https://latanda.online";
                var response = await fetch(apiBase + "/api/groups/" + groupId + "/toggle-pause", {
                    method: "POST",
                    headers: getAuthHeaders(),
                    body: JSON.stringify({})
                });
                
                var data = await response.json();
                
                if (data.success) {
                    var newStatus = data.data.new_status;
                    var message = newStatus === "paused" ? "Tanda pausada exitosamente" : "Tanda reanudada exitosamente";
                    showNotification(message, "success");
                    closeModal();
                    // Refresh the groups list
                    if (typeof fetchMyGroups === "function") fetchMyGroups();
                } else {
                    showNotification("Error al cambiar estado de la tanda", "error");
                }
            } catch (error) {
                showNotification("Error de conexion", "error");
            }
        }
        window.toggleTandaPause = toggleTandaPause;
        window.closeManageTurnsModal = closeManageTurnsModal;

        // =============================================
        // SCHEDULE LOTTERY FUNCTIONALITY
        // =============================================
        
        // Variable to store existing lottery data
        var scheduleLotteryExistingData = null;
        
        async function openScheduleLotteryModal() {
            // Get group ID from manage turns context
            var groupId = manageTurnsGroupId || currentStartGroupId;
            if (!groupId) {
                showNotification("Error: No se ha seleccionado un grupo", "error");
                return;
            }
            
            // FIX 2025-12-31: Load existing lottery schedule
            try {
                var response = await fetch((window.API_BASE_URL || "https://latanda.online") + "/api/groups/" + groupId + "/lottery-status", {
                    headers: getAuthHeaders()
                });
                var result = await response.json();
                if (result.success && result.data) {
                    scheduleLotteryExistingData = {
                        scheduled_at: result.data.scheduled_at,
                        countdown_seconds: result.data.countdown_seconds
                    };
                } else {
                    scheduleLotteryExistingData = null;
                }
            } catch (e) {
                scheduleLotteryExistingData = null;
            }
            
            // Create modal HTML
            var modalHtml = 
                "<div id=\"scheduleLotteryModal\" style=\"position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10001; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px);\">" +
                    "<div style=\"background: linear-gradient(135deg, #1e293b, #0f172a); border-radius: 16px; max-width: 420px; width: 90%; max-height: 90vh; overflow: hidden; border: 1px solid rgba(59,130,246,0.3);\">" +
                        "<div style=\"background: linear-gradient(135deg, #3b82f6, #1d4ed8); padding: 20px; position: relative;\">" +
                            "<div style=\"display: flex; align-items: center; gap: 12px;\">" +
                                "<div style=\"width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;\">" +
                                    "<span style=\"font-size: 1.5rem;\">📅</span>" +
                                "</div>" +
                                "<div>" +
                                    "<h3 style=\"margin: 0; font-size: 1.25rem; font-weight: 600; color: white;\">Programar Tombola</h3>" +
                                    "<p style=\"margin: 4px 0 0; font-size: 0.875rem; opacity: 0.9; color: white;\">Los miembros seran notificados</p>" +
                                "</div>" +
                            "</div>" +
                            "<button data-action=\"grp-close-schedule-lottery\" style=\"position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; color: white; cursor: pointer;\">✕</button>" +
                        "</div>" +
                        "<div style=\"padding: 24px;\">" +
                            "<div style=\"margin-bottom: 20px;\">" +
                                "<label style=\"display: block; font-weight: 500; color: #e5e7eb; margin-bottom: 8px;\">Fecha y Hora</label>" +
                                "<input type=\"datetime-local\" id=\"scheduleLotteryDateTime\" style=\"width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #1e293b; color: white; font-size: 1rem; box-sizing: border-box;\">" +
                            "</div>" +
                            "<div style=\"margin-bottom: 20px;\">" +
                                "<label style=\"display: block; font-weight: 500; color: #e5e7eb; margin-bottom: 8px;\">Tiempo de Conteo (segundos)</label>" +
                                "<select id=\"scheduleLotteryCountdown\" style=\"width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #1e293b; color: white; font-size: 1rem;\">" +
                                    "<option value=\"5\">5 segundos</option>" +
                                    "<option value=\"10\" selected>10 segundos</option>" +
                                    "<option value=\"15\">15 segundos</option>" +
                                    "<option value=\"30\">30 segundos</option>" +
                                    "<option value=\"60\">1 minuto</option>" +
                                "</select>" +
                            "</div>" +
                            "<div style=\"background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3); border-radius: 8px; padding: 12px; margin-bottom: 20px;\">" +
                                "<p style=\"margin: 0; color: #93c5fd; font-size: 0.875rem;\">💡 Todos los miembros del grupo recibiran una notificacion cuando programes la tombola.</p>" +
                            "</div>" +
                            "<div id=\"scheduleLotteryError\" style=\"display: none; padding: 12px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); border-radius: 8px; color: #fca5a5; margin-bottom: 16px;\"></div>" +
                            "<div style=\"display: flex; gap: 12px;\">" +
                                "<button data-action=\"grp-close-schedule-lottery\" style=\"flex: 1; padding: 12px; background: #374151; border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 500;\">Cancelar</button>" +
                                "<button data-action=\"grp-submit-schedule-lottery\" id=\"scheduleLotteryBtn\" style=\"flex: 1; padding: 12px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600;\">Programar</button>" +
                            "</div>" +
                        "</div>" +
                    "</div>" +
                "</div>";
            
            document.body.insertAdjacentHTML("beforeend", modalHtml);
            
            // Set minimum datetime to now + 5 minutes
            var now = new Date();
            now.setMinutes(now.getMinutes() + 5);
            var minDateTime = now.toISOString().slice(0, 16);
            document.getElementById("scheduleLotteryDateTime").min = minDateTime;
            
            // FIX 2025-12-31: Load existing scheduled date if available
            var existingDate = scheduleLotteryExistingData?.scheduled_at;
            var existingCountdown = scheduleLotteryExistingData?.countdown_seconds;
            
            if (existingDate) {
                var existingDateTime = new Date(existingDate).toISOString().slice(0, 16);
                document.getElementById("scheduleLotteryDateTime").value = existingDateTime;
            } else {
                document.getElementById("scheduleLotteryDateTime").value = minDateTime;
            }
            
            if (existingCountdown) {
                document.getElementById("scheduleLotteryCountdown").value = existingCountdown.toString();
            }
        }
        
        function closeScheduleLotteryModal() {
            var modal = document.getElementById("scheduleLotteryModal");
            if (modal) modal.remove();
        }
        
        async function submitScheduleLottery() {
            var groupId = manageTurnsGroupId || currentStartGroupId;
            var dateTimeInput = document.getElementById("scheduleLotteryDateTime");
            var countdownSelect = document.getElementById("scheduleLotteryCountdown");
            var errorDiv = document.getElementById("scheduleLotteryError");
            var submitBtn = document.getElementById("scheduleLotteryBtn");
            
            if (!dateTimeInput.value) {
                errorDiv.textContent = "Por favor selecciona una fecha y hora";
                errorDiv.style.display = "block";
                return;
            }
            
            var scheduledAt = new Date(dateTimeInput.value);
            if (scheduledAt <= new Date()) {
                errorDiv.textContent = "La fecha debe ser en el futuro";
                errorDiv.style.display = "block";
                return;
            }
            
            errorDiv.style.display = "none";
            submitBtn.disabled = true;
            submitBtn.textContent = "Programando...";
            
            try {
                var response = await fetch((window.API_BASE_URL || "https://latanda.online") + "/api/groups/" + groupId + "/lottery-schedule", {
                    method: "POST",
                    headers: {
                        ...getAuthHeaders(),
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        scheduled_at: scheduledAt.toISOString(),
                        countdown_seconds: parseInt(countdownSelect.value)
                    })
                });
                
                var result = await response.json();
                
                if (result.success) {
                    closeScheduleLotteryModal();
                    closeManageTurnsModal();
                    showNotification("Tombola programada! " + result.data.members_notified + " miembros notificados", "success");
                    
                    // Refresh data
                    if (typeof refreshTandas === "function") refreshTandas();
                    if (typeof fetchMyGroups === "function") {
                        fetchMyGroups().then(function() {
                            if (typeof renderGroups === "function") renderGroups();
                        }).catch(function() {});
                    }
                } else {
                    errorDiv.textContent = "Error al programar la loteria";
                    errorDiv.style.display = "block";
                }
            } catch (error) {
                errorDiv.textContent = "Error de conexion";
                errorDiv.style.display = "block";
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = "Programar";
            }
        }
        
        // Expose functions to global scope
        window.openScheduleLotteryModal = openScheduleLotteryModal;
        window.closeScheduleLotteryModal = closeScheduleLotteryModal;
        window.submitScheduleLottery = submitScheduleLottery;

        window.saveTurnsOrder = saveTurnsOrder;
        window.loadTurnsMembers = loadTurnsMembers;
        window.moveExpandedUp = moveExpandedUp;
        window.moveExpandedDown = moveExpandedDown;
        // increasePositions/decreasePositions removed (undefined)
        window.toggleTurnLock = toggleExpandedLock;
        window.renderTurnsList = renderTurnsList;
        // ===== END MANAGE TURNS FUNCTIONALITY =====



        async function submitGroupEdit(event) {
            event.preventDefault();

            var name = document.getElementById('editGroupName').value.trim();
            var description = document.getElementById('editGroupDescription').value.trim();
            var amount = document.getElementById('editGroupAmount').value;
            var frequency = document.getElementById('editGroupFrequency').value;
            var maxMembers = document.getElementById('editGroupMaxMembers').value;
            var location = document.getElementById('editGroupLocation').value.trim();
            var status = document.getElementById('editGroupStatus').value;
            var start_date = document.getElementById('editGroupStartDate').value;
            var errorDiv = document.getElementById('editGroupError');
            var submitBtn = document.getElementById('editGroupSubmitBtn');

            if (!name) {
                if (errorDiv) {
                    errorDiv.textContent = 'El nombre del grupo es requerido';
                    errorDiv.style.display = 'block';
                }
                return;
            }

            if (errorDiv) errorDiv.style.display = 'none';
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Guardando...';
            }

            try {
                var apiBase = window.API_BASE_URL || 'https://latanda.online';
                var userId = getCurrentUserId();

                var updateData = {
                    name: name,
                    description: description || null,
                    status: status
                };

                if (amount) updateData.contribution_amount = parseFloat(amount);
                if (frequency) updateData.frequency = frequency;
                if (maxMembers) updateData.max_members = parseInt(maxMembers);
                if (start_date) updateData.start_date = start_date;
                if (location) updateData.location = location;

                var thresholdVal = document.getElementById('editGroupThreshold') ? document.getElementById('editGroupThreshold').value : null;
                if (thresholdVal) updateData.advanceThreshold = parseInt(thresholdVal);
                // updated_by removed (server uses JWT identity)

                var response = await fetch(apiBase + '/api/groups/' + currentEditGroupId + '/update', {
                    method: 'PATCH',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });

                var data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error('Error al actualizar el grupo');
                }

                // Show success
                document.getElementById('editGroupFormFields').style.display = 'none';
                document.getElementById('editGroupFormFooter').style.display = 'none';
                document.getElementById('editGroupSuccess').style.display = 'block';

                if (typeof window.showSuccess === 'function') {
                    window.showSuccess('Grupo actualizado exitosamente');
                }

                // Refresh groups list after 1.5 seconds
                setTimeout(function() {
                    closeEditGroupModal();
                    if (typeof fetchMyGroups === "function") {
                        fetchMyGroups();
                    }
                }, 1500);

            } catch (err) {
                if (errorDiv) {
                    errorDiv.textContent = 'Error al actualizar el grupo';
                    errorDiv.style.display = 'block';
                }
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Guardar Cambios';
                }
            }
        }

        // Close edit group modal on overlay click
        document.addEventListener('DOMContentLoaded', function() {
            var modal = document.getElementById('editGroupModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) closeEditGroupModal();
                });
            }
        });

        // ============================================
        // REGISTER PAYMENT MODAL FUNCTIONS
        // ============================================
        var currentPaymentGroupId = null;


        // ========== PAYMENT MODAL - Step-based Flow ==========
        var currentPaymentStep = 1;
        var currentPaymentData = null;
        var selectedPaymentMethod = null;
        var proofFile = null;

        function registerGroupPayment(groupId) {
            closeModal();
            setTimeout(function() {
                var groupData = window.currentGroupsData ? window.currentGroupsData.find(function(g) { return g.id === groupId || g.group_id === groupId; }) : null;
                var role = groupData ? (groupData.my_role || "member") : "member";
                if (role === "creator" || role === "coordinator") {
                    showCoordinatorPaymentView(groupId, groupData);
                } else {
                    showRegisterPaymentModal(groupId);
                }
            }, 100);
        }
        window.registerGroupPayment = registerGroupPayment;

        // v4.10.5: Coordinator Payment Management — Individual + Bulk
        function showCoordinatorPaymentView(groupId, groupData) {
            var existingModal = document.getElementById('cpPaymentModal');
            if (existingModal) existingModal.remove();

            var groupName = groupData ? escapeHtml(groupData.name || 'Grupo') : 'Grupo';
            var dark = 'rgba(15,23,42,0.98)';
            var darkBorder = 'rgba(100,116,139,0.2)';

            var modalHtml =
                '<div id="cpPaymentModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10001;backdrop-filter:blur(4px);padding:16px;">' +
                '<div style="background:' + dark + ';border:1px solid ' + darkBorder + ';border-radius:16px;width:100%;max-width:560px;max-height:90vh;display:flex;flex-direction:column;overflow:hidden;">' +
                    '<div style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid ' + darkBorder + ';">' +
                        '<div>' +
                            '<h3 style="margin:0;font-size:1.15rem;font-weight:600;color:#f8fafc;">Registrar Pagos</h3>' +
                            '<div id="cpThresholdBar" style="margin-top:8px;"></div>' +
                            '<p style="margin:4px 0 0;font-size:0.8rem;color:#64748b;">' + groupName + '</p>' +
                        '</div>' +
                        '<button data-action="cp-close" style="background:none;border:none;color:#94a3b8;font-size:1.5rem;cursor:pointer;padding:4px 8px;line-height:1;">&times;</button>' +
                    '</div>' +
                    '<div style="display:flex;border-bottom:1px solid ' + darkBorder + ';padding:0 20px;">' +
                        '<button data-action="cp-tab-individual" class="cp-tab cp-tab-active" style="flex:1;">Individual</button>' +
                        '<button data-action="cp-tab-masivo" class="cp-tab" style="flex:1;">Masivo</button>' +
                    '</div>' +
                    '<div id="cpSummaryBar" style="padding:12px 20px;background:rgba(0,255,255,0.05);border-bottom:1px solid ' + darkBorder + ';font-size:0.85rem;color:#94a3b8;">Cargando...</div>' +
                    '<div id="cpTabContent" style="flex:1;overflow-y:auto;padding:12px 20px;">' +
                        '<div style="text-align:center;padding:40px 0;color:#64748b;"><div class="cp-spinner"></div>Cargando miembros...</div>' +
                    '</div>' +
                '</div>' +
                '</div>';

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            document.body.style.overflow = 'hidden';

            var modal = document.getElementById('cpPaymentModal');
            var cpState = {
                groupId: groupId,
                groupData: groupData,
                members: [],
                cycleNumber: 1,
                contributionAmount: 0,
                paidCount: 0,
                pendingCount: 0,
                activeTab: 'individual',
                selectedMembers: {},
                bulkMethod: 'cash',
                bulkAmount: 0,
                loadingInline: null
            };

            function cpClose() {
                modal.remove();
                document.body.style.overflow = '';
            }

            async function cpLoadData() {
                try {
                    var resp = await fetch('/api/groups/' + encodeURIComponent(groupId) + '/members/payment-status', {
                        headers: { 'Content-Type': 'application/json', ...getAuthHeaders() }
                    });
                    var json = await resp.json();
                    if (!json.success || !json.data) {
                        document.getElementById('cpTabContent').innerHTML = '<div style="text-align:center;padding:40px 0;color:#ef4444;">Error al cargar datos</div>';
                        return;
                    }
                    cpState.members = json.data.members || [];
                    cpState.cycleNumber = json.data.cycle_number || 1;
                    cpState.contributionAmount = json.data.group_contribution_amount || 0;
                    cpState.paidCount = json.data.paid_count || 0;
                    cpState.pendingCount = json.data.pending_count || 0;
                    cpState.bulkAmount = cpState.contributionAmount;
                    cpState.selectedMembers = {};
                    cpUpdateSummary();
                    cpRenderTab();
                    cpRenderThresholdBar();
                } catch (err) {
                    document.getElementById('cpTabContent').innerHTML = '<div style="text-align:center;padding:40px 0;color:#ef4444;">Error de conexion</div>';
                }
            }

            function cpUpdateSummary() {
                var bar = document.getElementById('cpSummaryBar');
                if (!bar) return;
                var total = cpState.members.length;
                var pct = total > 0 ? Math.round((cpState.paidCount / total) * 100) : 0;
                bar.innerHTML =
                    '<div style="display:flex;align-items:center;justify-content:space-between;">' +
                        '<span><strong style="color:#00FFFF;">' + cpState.paidCount + '</strong>/' + total + ' miembros pagados — Ciclo ' + escapeHtml(String(cpState.cycleNumber)) + '</span>' +
                        '<span style="font-weight:600;color:' + (pct === 100 ? '#22c55e' : '#f59e0b') + ';">' + pct + '%</span>' +
                    '</div>' +
                    '<div style="margin-top:6px;height:4px;background:rgba(100,116,139,0.2);border-radius:2px;overflow:hidden;">' +
                        '<div style="height:100%;width:' + pct + '%;background:' + (pct === 100 ? '#22c55e' : '#00FFFF') + ';border-radius:2px;transition:width 0.3s;"></div>' +
                    '</div>';
            }

            function cpRenderTab() {
                if (cpState.activeTab === 'individual') {
                    cpRenderIndividual();
                } else {
                    cpRenderBulk();
                }
            }

            function cpGetStatusPill(status) {
                var map = {
                    'paid': { label: 'Pagado', bg: 'rgba(34,197,94,0.15)', color: '#22c55e' },
                    'pending': { label: 'Pendiente', bg: 'rgba(245,158,11,0.15)', color: '#f59e0b' },
                    'late': { label: 'Atrasado', bg: 'rgba(239,68,68,0.15)', color: '#ef4444' },
                    'suspended': { label: 'Suspendido', bg: 'rgba(100,116,139,0.15)', color: '#94a3b8' }
                };
                var s = map[status] || map['pending'];
                return '<span style="display:inline-block;padding:2px 10px;border-radius:20px;font-size:0.72rem;font-weight:600;background:' + s.bg + ';color:' + s.color + ';">' + s.label + '</span>';
            }

            function cpGetAvatar(member) {
                if (member.avatar) {
                    return '<img src="' + escapeHtml(member.avatar) + '" style="width:36px;height:36px;border-radius:50%;object-fit:cover;" alt="">';
                }
                var initial = member.name ? escapeHtml(member.name.charAt(0).toUpperCase()) : '?';
                return '<div style="width:36px;height:36px;border-radius:50%;background:rgba(0,255,255,0.15);color:#00FFFF;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:0.9rem;">' + initial + '</div>';
            }

            function cpMethodOptions(selected) {
                var methods = [
                    { value: 'cash', label: 'Efectivo' },
                    { value: 'bank_transfer', label: 'Transferencia' },
                    { value: 'mobile_money', label: 'Tigo Money' },
                    { value: 'card', label: 'Tarjeta' },
                    { value: 'crypto', label: 'Crypto' },
                    { value: 'wallet', label: 'Billetera' }
                ];
                return methods.map(function(m) {
                    return '<option value="' + m.value + '"' + (m.value === selected ? ' selected' : '') + '>' + m.label + '</option>';
                }).join('');
            }

            function cpRenderIndividual() {
                var html = '';
                if (cpState.members.length === 0) {
                    html = '<div style="text-align:center;padding:40px 0;color:#64748b;">No hay miembros en este grupo</div>';
                } else {
                    cpState.members.forEach(function(m) {
                        var canPay = m.payment_status !== 'paid';
                        var amtPending = m.amount_pending != null ? m.amount_pending : cpState.contributionAmount;
                        var amountDisplay = 'L. ' + (amtPending > 0 ? amtPending.toLocaleString('es-HN', { minimumFractionDigits: 2 }) : '0.00');
                        var posLabel = (m.num_positions && m.num_positions > 1) ? '<div style="font-size:0.65rem;color:#00FFFF;margin-top:1px;">' + m.num_positions + ' numeros</div>' : '';
                        var cuotasLabel = m.cycles_pending > 1 ? '<div style="font-size:0.68rem;color:#f59e0b;margin-top:1px;">Debe ' + m.cycles_pending + ' cuotas</div>' : '';
                        html += '<div class="cp-member-row" id="cp-row-' + escapeHtml(m.user_id) + '">' +
                            '<div style="display:flex;align-items:center;gap:10px;flex:1;min-width:0;">' +
                                cpGetAvatar(m) +
                                '<div style="flex:1;min-width:0;">' +
                                    '<div style="font-size:0.88rem;font-weight:500;color:#f8fafc;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + escapeHtml(m.name || 'Usuario') + '</div>' +
                                    '<div style="display:flex;align-items:center;gap:6px;margin-top:2px;">' +
                                        (m.turn_position ? '<span style="font-size:0.7rem;color:#64748b;">Turno #' + escapeHtml(String(m.turn_position)) + '</span>' : '') +
                                        (m.member_role && m.member_role !== 'member' ? '<span style="font-size:0.65rem;padding:1px 6px;border-radius:8px;background:rgba(139,92,246,0.15);color:#a78bfa;">' + escapeHtml(m.member_role) + '</span>' : '') +
                                    '</div>' +
                                '</div>' +
                            '</div>' +
                            '<div style="display:flex;align-items:center;gap:8px;">' +
                                '<div style="text-align:right;">' +
                                    '<div style="font-size:0.8rem;font-weight:600;color:#cbd5e1;">' + amountDisplay + '</div>' +
                                    cpGetStatusPill(m.payment_status) + posLabel + cuotasLabel +
                                '</div>' +
                                (canPay ? '<button data-action="cp-register-single" data-uid="' + escapeHtml(m.user_id) + '" style="padding:6px 12px;border-radius:8px;border:1px solid rgba(0,255,255,0.3);background:rgba(0,255,255,0.1);color:#00FFFF;font-size:0.78rem;font-weight:500;cursor:pointer;white-space:nowrap;">Registrar</button>' +
                                '<button data-action="cp-mark-mora" data-uid="' + escapeHtml(m.user_id) + '" data-name="' + escapeHtml(m.name || 'Usuario') + '" style="padding:6px 8px;border-radius:8px;border:1px solid rgba(239,68,68,0.3);background:rgba(239,68,68,0.1);color:#f87171;font-size:0.72rem;font-weight:500;cursor:pointer;white-space:nowrap;">Mora</button>' : '') +
                            '</div>' +
                        '</div>' +
                        '<div id="cp-form-' + escapeHtml(m.user_id) + '" style="display:none;"></div>';
                    });
                }
                document.getElementById('cpTabContent').innerHTML = html;
            }

            function cpShowInlineForm(userId) {
                // Close any other open form
                if (cpState.loadingInline && cpState.loadingInline !== userId) {
                    var prev = document.getElementById('cp-form-' + cpState.loadingInline);
                    if (prev) prev.style.display = 'none';
                }
                cpState.loadingInline = userId;

                var formEl = document.getElementById('cp-form-' + userId);
                if (!formEl) return;

                formEl.style.display = 'block';
                formEl.innerHTML =
                    '<div class="cp-inline-form">' +
                        '<div style="display:flex;gap:8px;flex-wrap:wrap;">' +
                            '<div style="flex:1;min-width:100px;">' +
                                '<label style="font-size:0.72rem;color:#64748b;display:block;margin-bottom:3px;">Monto</label>' +
                                '<input type="number" id="cp-amount-' + escapeHtml(userId) + '" value="' + cpState.contributionAmount + '" step="0.01" min="0.01" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(100,116,139,0.3);background:rgba(30,41,59,0.8);color:#f8fafc;font-size:0.85rem;">' +
                            '</div>' +
                            '<div style="flex:1;min-width:120px;">' +
                                '<label style="font-size:0.72rem;color:#64748b;display:block;margin-bottom:3px;">Metodo</label>' +
                                '<select id="cp-method-' + escapeHtml(userId) + '" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(100,116,139,0.3);background:rgba(30,41,59,0.8);color:#f8fafc;font-size:0.85rem;">' +
                                    cpMethodOptions('cash') +
                                '</select>' +
                            '</div>' +
                        '</div>' +
                        '<div style="margin-top:8px;">' +
                            '<label style="font-size:0.72rem;color:#64748b;display:block;margin-bottom:3px;">Notas (opcional)</label>' +
                            '<input type="text" id="cp-notes-' + escapeHtml(userId) + '" placeholder="Ej: Pago en efectivo" maxlength="500" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(100,116,139,0.3);background:rgba(30,41,59,0.8);color:#f8fafc;font-size:0.85rem;">' +
                        '</div>' +
                        '<div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end;">' +
                            '<button data-action="cp-cancel-single" data-uid="' + escapeHtml(userId) + '" style="padding:7px 16px;border-radius:8px;border:1px solid rgba(100,116,139,0.3);background:transparent;color:#94a3b8;font-size:0.8rem;cursor:pointer;">Cancelar</button>' +
                            '<button data-action="cp-confirm-single" data-uid="' + escapeHtml(userId) + '" style="padding:7px 16px;border-radius:8px;border:none;background:#00FFFF;color:#0f172a;font-size:0.8rem;font-weight:600;cursor:pointer;">Confirmar</button>' +
                        '</div>' +
                    '</div>';
            }

            async function cpConfirmSingle(userId) {
                var amountEl = document.getElementById('cp-amount-' + userId);
                var methodEl = document.getElementById('cp-method-' + userId);
                var notesEl = document.getElementById('cp-notes-' + userId);
                if (!amountEl || !methodEl) return;

                var amount = parseFloat(amountEl.value);
                if (!Number.isFinite(amount) || amount <= 0) {
                    showNotification('Monto invalido', 'error');
                    return;
                }

                var btn = modal.querySelector('[data-action="cp-confirm-single"][data-uid="' + userId + '"]');
                if (btn) { btn.disabled = true; btn.textContent = 'Guardando...'; }

                try {
                    var resp = await fetch('/api/groups/' + encodeURIComponent(cpState.groupId) + '/contributions/record-for-member', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
                        body: JSON.stringify({
                            member_user_id: userId,
                            amount: amount,
                            payment_method: methodEl.value,
                            notes: notesEl ? notesEl.value : ''
                        })
                    });
                    var json = await resp.json();
                    if (json.success) {
                        // Update local state
                        // Reload data to get accurate state (handles num_positions)
                        await cpLoadData();
                        cpUpdateSummary();
                        cpRenderTab();
                    } else {
                        showNotification('No se pudo registrar el pago', 'error');
                    }
                } catch (err) {
                    showNotification('Error de conexion', 'error');
                } finally {
                    if (btn) { btn.disabled = false; btn.textContent = 'Confirmar'; }
                }
            }

            // === BULK TAB ===

            function cpRenderBulk() {
                var pendingMembers = cpState.members.filter(function(m) { return m.payment_status !== 'paid'; });
                var selectedCount = Object.keys(cpState.selectedMembers).filter(function(k) { return cpState.selectedMembers[k]; }).length;

                var html = '';
                if (pendingMembers.length === 0 && cpState.members.length > 0) {
                    html = '<div style="text-align:center;padding:40px 0;color:#22c55e;">&#10003; Todos los miembros han pagado este ciclo</div>';
                } else if (cpState.members.length === 0) {
                    html = '<div style="text-align:center;padding:40px 0;color:#64748b;">No hay miembros en este grupo</div>';
                } else {
                    // Bulk controls
                    html += '<div class="cp-bulk-bar">' +
                        '<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">' +
                            '<label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:0.82rem;color:#cbd5e1;">' +
                                '<input type="checkbox" id="cpSelectAll" data-action="cp-select-all-pending" ' + (selectedCount === pendingMembers.length && pendingMembers.length > 0 ? 'checked' : '') + ' style="width:16px;height:16px;accent-color:#00FFFF;">' +
                                'Seleccionar todos pendientes (' + pendingMembers.length + ')' +
                            '</label>' +
                        '</div>' +
                        '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;">' +
                            '<div style="flex:1;min-width:100px;">' +
                                '<label style="font-size:0.72rem;color:#64748b;display:block;margin-bottom:3px;">Monto global</label>' +
                                '<input type="number" id="cpBulkAmount" value="' + cpState.bulkAmount + '" step="0.01" min="0.01" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(100,116,139,0.3);background:rgba(30,41,59,0.8);color:#f8fafc;font-size:0.85rem;">' +
                            '</div>' +
                            '<div style="flex:1;min-width:120px;">' +
                                '<label style="font-size:0.72rem;color:#64748b;display:block;margin-bottom:3px;">Metodo de pago</label>' +
                                '<select id="cpBulkMethod" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(100,116,139,0.3);background:rgba(30,41,59,0.8);color:#f8fafc;font-size:0.85rem;">' +
                                    cpMethodOptions(cpState.bulkMethod) +
                                '</select>' +
                            '</div>' +
                        '</div>' +
                        '<div style="font-size:0.72rem;color:#94a3b8;margin-top:6px;font-style:italic;">Cada registro aplica 1 cuota por miembro (al ciclo mas antiguo impago)</div>' +
                    '</div>';

                    // Member checkboxes
                    cpState.members.forEach(function(m) {
                        var isPaid = m.payment_status === 'paid';
                        var isChecked = !isPaid && cpState.selectedMembers[m.user_id];
                        html += '<div class="cp-member-row" style="' + (isPaid ? 'opacity:0.5;' : '') + '">' +
                            '<div style="display:flex;align-items:center;gap:10px;flex:1;min-width:0;">' +
                                (!isPaid ? '<input type="checkbox" data-action="cp-toggle-select" data-uid="' + escapeHtml(m.user_id) + '" ' + (isChecked ? 'checked' : '') + ' style="width:16px;height:16px;accent-color:#00FFFF;flex-shrink:0;">' : '<div style="width:16px;flex-shrink:0;"></div>') +
                                cpGetAvatar(m) +
                                '<div style="flex:1;min-width:0;">' +
                                    '<div style="font-size:0.88rem;font-weight:500;color:#f8fafc;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + escapeHtml(m.name || 'Usuario') + '</div>' +
                                    '<div style="font-size:0.72rem;color:#64748b;">' +
                                        (m.turn_position ? 'Turno #' + escapeHtml(String(m.turn_position)) : '') +
                                    '</div>' +
                                '</div>' +
                            '</div>' +
                            '<div style="text-align:right;">' +
                                '<div style="font-size:0.75rem;font-weight:600;color:#cbd5e1;">L. ' + (m.amount_pending > 0 ? m.amount_pending.toLocaleString('es-HN', { minimumFractionDigits: 2 }) : '0.00') + '</div>' +
                                cpGetStatusPill(m.payment_status) +
                                ((m.num_positions && m.num_positions > 1) ? '<div style="font-size:0.62rem;color:#00FFFF;">' + m.num_positions + ' num.</div>' : '') +
                                (m.cycles_pending > 1 ? '<div style="font-size:0.65rem;color:#f59e0b;">' + m.cycles_pending + ' cuotas</div>' : '') +
                            '</div>' +
                        '</div>';
                    });

                    // Submit button
                    html += '<div style="padding:16px 0 4px;text-align:center;">' +
                        '<button data-action="cp-submit-bulk" id="cpBulkSubmitBtn" style="width:100%;padding:12px;border-radius:10px;border:none;background:' + (selectedCount > 0 ? '#00FFFF' : 'rgba(100,116,139,0.3)') + ';color:' + (selectedCount > 0 ? '#0f172a' : '#64748b') + ';font-size:0.9rem;font-weight:600;cursor:' + (selectedCount > 0 ? 'pointer' : 'default') + ';"' + (selectedCount === 0 ? ' disabled' : '') + '>' +
                            'Registrar ' + selectedCount + ' pago' + (selectedCount !== 1 ? 's' : '') +
                        '</button>' +
                    '</div>';
                }
                document.getElementById('cpTabContent').innerHTML = html;
            }

            function cpToggleSelect(userId) {
                cpState.selectedMembers[userId] = !cpState.selectedMembers[userId];
                cpRenderBulk();
            }

            function cpSelectAllPending() {
                var allChecked = document.getElementById('cpSelectAll')?.checked;
                cpState.members.forEach(function(m) {
                    if (m.payment_status !== 'paid') {
                        cpState.selectedMembers[m.user_id] = allChecked;
                    }
                });
                cpRenderBulk();
            }

            async function cpSubmitBulk() {
                var selected = Object.keys(cpState.selectedMembers).filter(function(k) { return cpState.selectedMembers[k]; });
                if (selected.length === 0) return;

                var amountEl = document.getElementById('cpBulkAmount');
                var methodEl = document.getElementById('cpBulkMethod');
                var amount = parseFloat(amountEl ? amountEl.value : cpState.bulkAmount);
                var method = methodEl ? methodEl.value : cpState.bulkMethod;

                if (!Number.isFinite(amount) || amount <= 0) {
                    showNotification('Monto invalido', 'error');
                    return;
                }

                var btn = document.getElementById('cpBulkSubmitBtn');
                if (btn) { btn.disabled = true; btn.textContent = 'Registrando...'; btn.style.background = 'rgba(0,255,255,0.5)'; }

                var membersPayload = selected.map(function(uid) {
                    return { member_user_id: uid, amount: amount };
                });

                try {
                    var resp = await fetch('/api/groups/' + encodeURIComponent(cpState.groupId) + '/contributions/record-bulk', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
                        body: JSON.stringify({
                            members: membersPayload,
                            payment_method: method
                        })
                    });
                    var json = await resp.json();
                    if (json.success) {
                        var d = json.data;
                        showNotification(d.recorded + ' pago(s) registrados' + (d.failed > 0 ? ', ' + d.failed + ' fallido(s)' : ''), 'success');
                        // Reload data
                        cpState.selectedMembers = {};
                        await cpLoadData();
                    } else {
                        showNotification('No se pudieron registrar los pagos', 'error');
                    }
                } catch (err) {
                    showNotification('Error de conexion', 'error');
                } finally {
                    if (btn) { btn.disabled = false; btn.textContent = 'Registrar ' + selected.length + ' pagos'; btn.style.background = '#00FFFF'; }
                }
            }

            // === DELEGATED EVENT HANDLER ===
            modal.addEventListener('click', function(e) {
                if (e.target === modal) { cpClose(); return; }
                var btn = e.target.closest('[data-action]');
                if (!btn) {
                    // Handle checkbox changes
                    if (e.target.type === 'checkbox' && e.target.dataset.action) {
                        // handled below
                    } else {
                        return;
                    }
                }
                var target = btn || e.target;
                var action = target.getAttribute('data-action');
                var uid = target.getAttribute('data-uid');

                switch (action) {
                    case 'cp-close':
                        cpClose();
                        break;
                    case 'cp-tab-individual':
                        cpState.activeTab = 'individual';
                        modal.querySelectorAll('.cp-tab').forEach(function(t) { t.classList.remove('cp-tab-active'); });
                        target.classList.add('cp-tab-active');
                        cpRenderTab();
                        break;
                    case 'cp-tab-masivo':
                        cpState.activeTab = 'masivo';
                        modal.querySelectorAll('.cp-tab').forEach(function(t) { t.classList.remove('cp-tab-active'); });
                        target.classList.add('cp-tab-active');
                        cpRenderTab();
                        break;
                    case 'cp-register-single':
                        cpShowInlineForm(uid);
                        break;
                    case 'cp-confirm-single':
                        cpConfirmSingle(uid);
                        break;
                    case 'cp-mark-mora':
                        var moraName = btn.getAttribute('data-name') || 'este miembro';
                        showConfirm('Marcar a ' + escapeHtml(moraName) + ' en mora para este ciclo?', function() {
                            cpMarkMora(uid);
                        });
                        break;
                    case 'cp-cancel-single':
                        var formEl = document.getElementById('cp-form-' + uid);
                        if (formEl) formEl.style.display = 'none';
                        cpState.loadingInline = null;
                        break;
                    case 'cp-toggle-select':
                        cpToggleSelect(uid);
                        break;
                    case 'cp-select-all-pending':
                        cpSelectAllPending();
                        break;
                    case 'cp-submit-bulk':
                        cpSubmitBulk();
                        break;
                }
            });

            // Handle checkbox change events (for select-all)
            modal.addEventListener('change', function(e) {
                if (e.target.id === 'cpSelectAll') {
                    cpSelectAllPending();
                } else if (e.target.dataset.action === 'cp-toggle-select') {
                    cpToggleSelect(e.target.dataset.uid);
                }
            });

            // Load data
            cpLoadData();

            // =============================================
            // v4.11.0: COORDINATOR MARK MORA
            // =============================================
            async function cpMarkMora(userId) {
                try {
                    var apiBase = window.API_BASE_URL || 'https://latanda.online';
                    var resp = await fetch(apiBase + '/api/groups/' + encodeURIComponent(cpState.groupId) + '/members/' + encodeURIComponent(userId) + '/mark-mora', {
                        method: 'POST',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify({})
                    });
                    var data = await resp.json();
                    if (!resp.ok || !data.success) throw new Error('Error');
                    if (typeof window.showSuccess === 'function') window.showSuccess('Mora registrada');
                    await cpLoadData();
                    cpRenderTab();
                } catch (e) {
                    if (typeof window.showError === 'function') window.showError('Error al registrar mora');
                }
            }

            // =============================================
            // v4.11.0: THRESHOLD PROGRESS BAR IN COORDINATOR VIEW
            // =============================================
            function cpRenderThresholdBar() {
                var bar = document.getElementById('cpThresholdBar');
                if (!bar || !cpState.members) return;
                var total = 0, paid = 0;
                cpState.members.forEach(function(m) {
                    var pos = m.num_positions || 1;
                    total += pos;
                    if (m.payment_status === 'paid') paid += pos;
                });
                var threshold = cpState.threshold || 80;
                var pct = total > 0 ? Math.round(paid / total * 100) : 0;
                var needed = Math.ceil(total * threshold / 100);
                var color = pct >= threshold ? '#22c55e' : '#f59e0b';
                bar.innerHTML = '<div style="display:flex;align-items:center;gap:8px;font-size:0.75rem;color:#94a3b8;">' +
                    '<div style="flex:1;height:6px;border-radius:3px;background:rgba(100,116,139,0.2);overflow:hidden;">' +
                        '<div style="width:' + Math.min(pct, 100) + '%;height:100%;background:' + color + ';border-radius:3px;transition:width 0.3s;"></div>' +
                    '</div>' +
                    '<span>Pagos: ' + paid + '/' + total + ' (' + pct + '%) — Umbral: ' + threshold + '% (' + needed + ' necesarios)</span>' +
                '</div>';
            }

        }
        window.showCoordinatorPaymentView = showCoordinatorPaymentView;



        // =============================================
        // v4.11.0: EXTENSION REQUEST MODAL (pr- prefix)
        // =============================================
        async function showExtensionRequestModal(groupId) {
            // Fetch group info
            var apiBase = window.API_BASE_URL || 'https://latanda.online';
            var groupData = null;
            try {
                var resp = await fetch(apiBase + '/api/groups/' + encodeURIComponent(groupId), { headers: getAuthHeaders() });
                var d = await resp.json();
                groupData = d.data?.data || d.data;
            } catch (e) { /* group data parse failure handled by null check below */ }

            var groupName = groupData ? escapeHtml(groupData.name || 'Grupo') : 'Grupo';
            var cycle = groupData ? (groupData.current_cycle || 1) : '?';
            var amount = groupData ? parseFloat(groupData.contribution_amount || 0).toLocaleString('es-HN', {minimumFractionDigits:2}) : '0.00';

            // Calculate next quincena
            var now = new Date();
            var quinDay = now.getDate() < 15 ? 15 : new Date(now.getFullYear(), now.getMonth() + 1, 15).getDate();
            var quinMonth = now.getDate() < 15 ? now.getMonth() : now.getMonth() + 1;
            var quinDate = new Date(now.getFullYear(), quinMonth, 15);
            var quinLabel = quinDate.toLocaleDateString('es-HN', { day: 'numeric', month: 'long', year: 'numeric' });

            var overlay = document.createElement('div');
            overlay.id = 'prOverlay';
            overlay.className = 'pr-overlay';
            overlay.innerHTML =
                '<div class="pr-modal">' +
                    '<div class="pr-header">' +
                        '<h3>Solicitar Prorroga</h3>' +
                        '<button data-action="pr-close" class="pr-close-btn">&times;</button>' +
                    '</div>' +
                    '<div class="pr-body">' +
                        '<div class="pr-info">' +
                            '<div class="pr-info-row"><span>' + groupName + '</span><span>Ciclo ' + escapeHtml(String(cycle)) + '</span></div>' +
                            '<div class="pr-info-row"><span>Monto pendiente:</span><span style="color:#f59e0b;font-weight:600;">L. ' + amount + '</span></div>' +
                        '</div>' +
                        '<div class="pr-section">' +
                            '<label class="pr-label">Cuando podras pagar?</label>' +
                            '<label class="pr-radio-label"><input type="radio" name="prDateType" value="quincena" checked> Proxima Quincena: ' + escapeHtml(quinLabel) + '</label>' +
                            '<label class="pr-radio-label"><input type="radio" name="prDateType" value="custom"> Otra fecha:</label>' +
                            '<input type="date" id="prCustomDate" class="pr-input" style="display:none;" min="' + now.toISOString().split('T')[0] + '">' +
                        '</div>' +
                        '<div class="pr-section">' +
                            '<label class="pr-label">Motivo (requerido):</label>' +
                            '<textarea id="prReason" class="pr-textarea" maxlength="500" placeholder="Explica brevemente por que necesitas la prorroga..."></textarea>' +
                            '<div class="pr-char-count"><span id="prCharCount">0</span>/500</div>' +
                        '</div>' +
                        '<div id="prError" class="pr-error" style="display:none;"></div>' +
                    '</div>' +
                    '<div class="pr-footer">' +
                        '<button data-action="pr-close" class="pr-btn-cancel">Cancelar</button>' +
                        '<button data-action="pr-submit" class="pr-btn-submit" data-group-id="' + escapeHtml(groupId) + '">Enviar Solicitud</button>' +
                    '</div>' +
                '</div>';

            document.body.appendChild(overlay);
            document.body.style.overflow = 'hidden';
            requestAnimationFrame(function() { overlay.classList.add('active'); });

            // Toggle custom date visibility
            overlay.addEventListener('change', function(e) {
                if (e.target.name === 'prDateType') {
                    document.getElementById('prCustomDate').style.display = e.target.value === 'custom' ? 'block' : 'none';
                }
            });

            // Char counter
            var ta = document.getElementById('prReason');
            if (ta) ta.addEventListener('input', function() {
                document.getElementById('prCharCount').textContent = ta.value.length;
            });
        }

        async function prSubmitRequest(groupId) {
            var errDiv = document.getElementById('prError');
            var submitBtn = document.querySelector('[data-action="pr-submit"]');
            var reason = (document.getElementById('prReason') || {}).value || '';
            if (reason.trim().length < 1) {
                if (errDiv) { errDiv.textContent = 'El motivo es requerido'; errDiv.style.display = 'block'; }
                return;
            }

            var dateType = document.querySelector('input[name="prDateType"]:checked');
            var bodyData = { reason: reason.trim() };
            if (dateType && dateType.value === 'quincena') {
                bodyData.next_quincena = true;
            } else {
                var customDate = (document.getElementById('prCustomDate') || {}).value;
                if (customDate) bodyData.proposed_date = customDate;
            }

            if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Enviando...'; }
            if (errDiv) errDiv.style.display = 'none';

            try {
                var apiBase = window.API_BASE_URL || 'https://latanda.online';
                var resp = await fetch(apiBase + '/api/groups/' + encodeURIComponent(groupId) + '/extensions/request', {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(bodyData)
                });
                var data = await resp.json();
                if (!resp.ok || !data.success) throw new Error(data?.data?.error?.message || 'Error');

                // Success
                prClose();
                if (typeof window.showSuccess === 'function') window.showSuccess('Solicitud de prorroga enviada');
            } catch (e) {
                if (errDiv) { errDiv.textContent = 'Error al enviar solicitud'; errDiv.style.display = 'block'; }
                if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Enviar Solicitud'; }
            }
        }

        function prClose() {
            var overlay = document.getElementById('prOverlay');
            if (overlay) {
                overlay.classList.remove('active');
                setTimeout(function() { overlay.remove(); document.body.style.overflow = ''; }, 300);
            }
        }

        // =============================================
        // v4.11.0: EXTENSION MANAGER PANEL (ext- prefix)
        // =============================================
        async function showExtensionManager(groupId) {
            var apiBase = window.API_BASE_URL || 'https://latanda.online';
            var overlay = document.createElement('div');
            overlay.id = 'extOverlay';
            overlay.className = 'ext-overlay';
            overlay.innerHTML =
                '<div class="ext-modal">' +
                    '<div class="ext-header">' +
                        '<h3>Prorrogas y Moras</h3>' +
                        '<button data-action="ext-close" class="ext-close-btn">&times;</button>' +
                    '</div>' +
                    '<div class="ext-tabs">' +
                        '<button class="ext-tab active" data-action="ext-filter" data-filter="active">Pendientes</button>' +
                        '<button class="ext-tab" data-action="ext-filter" data-filter="approved">Aprobadas</button>' +
                        '<button class="ext-tab" data-action="ext-filter" data-filter="all">Todas</button>' +
                    '</div>' +
                    '<div id="extContent" class="ext-content"><div class="ext-loading">Cargando...</div></div>' +
                    '<div id="extSummary" class="ext-summary"></div>' +
                '</div>';

            document.body.appendChild(overlay);
            document.body.style.overflow = 'hidden';
            requestAnimationFrame(function() { overlay.classList.add('active'); });

            overlay.setAttribute('data-group-id', groupId);

            // Load data
            await extLoadData(groupId, 'active');

            // Delegated events
            overlay.addEventListener('click', async function(e) {
                var btn = e.target.closest('[data-action]');
                if (!btn) return;
                var action = btn.getAttribute('data-action');
                if (action === 'ext-close') {
                    extClose();
                } else if (action === 'ext-filter') {
                    overlay.querySelectorAll('.ext-tab').forEach(function(t) { t.classList.remove('active'); });
                    btn.classList.add('active');
                    await extLoadData(groupId, btn.getAttribute('data-filter'));
                } else if (action === 'ext-approve' || action === 'ext-reject') {
                    var defId = btn.getAttribute('data-id');
                    var act = action === 'ext-approve' ? 'approve' : 'reject';
                    btn.disabled = true;
                    try {
                        var resp = await fetch(apiBase + '/api/groups/' + encodeURIComponent(groupId) + '/extensions/' + encodeURIComponent(defId), {
                            method: 'PATCH',
                            headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action: act })
                        });
                        var data = await resp.json();
                        if (!resp.ok || !data.success) throw new Error('Error');
                        if (typeof window.showSuccess === 'function') window.showSuccess(act === 'approve' ? 'Prorroga aprobada' : 'Prorroga rechazada');
                        var filter = overlay.querySelector('.ext-tab.active');
                        await extLoadData(groupId, filter ? filter.getAttribute('data-filter') : 'active');
                    } catch (err) {
                        btn.disabled = false;
                        if (typeof window.showError === 'function') window.showError('Error al procesar');
                    }
                }
            });
        }

        async function extLoadData(groupId, status) {
            var apiBase = window.API_BASE_URL || 'https://latanda.online';
            var contentEl = document.getElementById('extContent');
            var summaryEl = document.getElementById('extSummary');
            if (!contentEl) return;
            contentEl.innerHTML = '<div class="ext-loading">Cargando...</div>';

            try {
                var url = apiBase + '/api/groups/' + encodeURIComponent(groupId) + '/extensions?status=' + (status || 'active');
                var resp = await fetch(url, { headers: getAuthHeaders() });
                var data = await resp.json();
                if (!resp.ok || !data.success) throw new Error('Error');

                var deferrals = data.data?.deferrals || [];
                var summary = data.data?.summary || {};

                // Render summary
                if (summaryEl) {
                    summaryEl.innerHTML = '<span>' + (summary.active_moras || 0) + ' moras activas</span> · <span>' + (summary.pending_extensions || 0) + ' prorrogas pendientes</span> · <span>' + (summary.approved_extensions || 0) + ' aprobadas</span>';
                }

                if (deferrals.length === 0) {
                    contentEl.innerHTML = '<div style="text-align:center;padding:40px;color:#64748b;">Sin registros</div>';
                    return;
                }

                var html = '';
                deferrals.forEach(function(d) {
                    var isMora = d.type === 'mora';
                    var icon = isMora ? '<span style="color:#ef4444;">&#x1F534;</span>' : '<span style="color:#f59e0b;">&#x1F536;</span>';
                    var typeLabel = isMora ? 'MORA' : 'PRORROGA';
                    var name = escapeHtml(d.user_name || 'Usuario');
                    var amount = d.amount_owed ? 'L. ' + parseFloat(d.amount_owed).toLocaleString('es-HN', {minimumFractionDigits:2}) : '';
                    var dateStr = '';
                    if (d.proposed_date) {
                        dateStr = 'Fecha: ' + new Date(d.proposed_date).toLocaleDateString('es-HN');
                    } else if (d.mora_method) {
                        dateStr = d.mora_method === 'auto_threshold' ? 'Auto (umbral)' : 'Manual';
                    }

                    html += '<div class="ext-item ext-item-' + d.type + '">' +
                        '<div class="ext-item-header">' +
                            icon + ' <strong>' + typeLabel + '</strong> — ' + name +
                        '</div>' +
                        '<div class="ext-item-meta">Ciclo ' + escapeHtml(String(d.cycle_number)) + ' | ' + amount + (dateStr ? ' | ' + escapeHtml(dateStr) : '') + '</div>' +
                        (d.reason ? '<div class="ext-item-reason">"' + escapeHtml(d.reason) + '"</div>' : '') +
                        '<div class="ext-item-status">Estado: <span class="ext-status-' + d.status + '">' + escapeHtml(d.status) + '</span></div>';

                    // Action buttons for active extensions
                    if (!isMora && d.status === 'active') {
                        html += '<div class="ext-item-actions">' +
                            '<button data-action="ext-approve" data-id="' + escapeHtml(d.id) + '" class="ext-btn-approve">Aprobar</button>' +
                            '<button data-action="ext-reject" data-id="' + escapeHtml(d.id) + '" class="ext-btn-reject">Rechazar</button>' +
                        '</div>';
                    }
                    html += '</div>';
                });

                contentEl.innerHTML = html;
            } catch (e) {
                contentEl.innerHTML = '<div style="text-align:center;padding:40px;color:#ef4444;">Error al cargar datos</div>';
            }
        }

        function extClose() {
            var overlay = document.getElementById('extOverlay');
            if (overlay) {
                overlay.classList.remove('active');
                setTimeout(function() { overlay.remove(); document.body.style.overflow = ''; }, 300);
            }
        }

        // Delegated handlers for pr- and ext- actions
        document.addEventListener('click', function(e) {
            var btn = e.target.closest('[data-action]');
            if (!btn) return;
            var action = btn.getAttribute('data-action');
            if (action === 'pr-close') prClose();
            else if (action === 'pr-submit') {
                var gid = btn.getAttribute('data-group-id');
                if (gid) prSubmitRequest(gid);
            }
        });

        async function showRegisterPaymentModal(groupId) {
            currentPaymentGroupId = groupId;
            currentPaymentStep = 1;
            currentPaymentData = null;
            selectedPaymentMethod = null;
            proofFile = null;
            
            var modal = document.getElementById('registerPaymentModal');
            
            // Reset to step 1
            resetPaymentModal();
            
            // Show modal
            modal.style.display = 'flex'; modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function resetPaymentModal() {
            currentPaymentStep = 1;
            selectedPaymentMethod = null;
            proofFile = null;
            
            // Reset form fields
            var amountInput = document.getElementById('paymentAmount');
            if (amountInput) amountInput.value = '';
            
            // Reset method selection
            document.querySelectorAll('.payment-method-card').forEach(function(card) {
                card.classList.remove('selected');
            });
            var methodInput = document.getElementById('paymentMethod');
            if (methodInput) methodInput.value = '';
            
            // Reset proof upload
            var proofPreview = document.getElementById('proofPreview');
            var proofPrompt = document.getElementById('proofUploadPrompt');
            if (proofPreview) proofPreview.style.display = 'none';
            if (proofPrompt) proofPrompt.style.display = 'block';
            
            // Show step 1, hide others
            showPaymentStep(1);
            updateStepIndicator(1);
            updatePaymentButtons();
        }

        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            document.getElementById('paymentMethod').value = method;
            
            // Update visual selection
            document.querySelectorAll('.payment-method-card').forEach(function(card) {
                card.classList.remove('selected');
            });
            document.querySelector('.payment-method-card[data-method="' + method + '"]').classList.add('selected');
        }

        function showPaymentStep(step) {
            document.querySelectorAll('.payment-step').forEach(function(s) {
                s.style.display = 'none';
            });
            
            var stepEl = document.getElementById('paymentStep' + step);
            if (stepEl) stepEl.style.display = 'block';
            
            // Special handling for success
            if (step === 'success') {
                document.getElementById('paymentSuccess').style.display = 'block';
            }
        }

        function updateStepIndicator(step) {
            document.querySelectorAll('.step-dot').forEach(function(dot, index) {
                dot.classList.remove('active', 'completed');
                if (index + 1 < step) {
                    dot.classList.add('completed');
                } else if (index + 1 === step) {
                    dot.classList.add('active');
                }
            });
        }

        function updatePaymentButtons() {
            var backBtn = document.getElementById('paymentBackBtn');
            var nextBtn = document.getElementById('paymentNextBtn');
            var cancelBtn = document.getElementById('paymentCancelBtn');
            var doneBtn = document.getElementById('paymentDoneBtn');
            var stepIndicator = document.getElementById('paymentStepIndicator');
            
            if (currentPaymentStep === 1) {
                backBtn.style.display = 'none';
                nextBtn.style.display = 'block';
                cancelBtn.style.display = 'block';
                doneBtn.style.display = 'none';
                stepIndicator.style.display = 'flex';
                nextBtn.textContent = 'Continuar →';
            } else if (currentPaymentStep === 2) {
                backBtn.style.display = 'block';
                nextBtn.style.display = 'block';
                cancelBtn.style.display = 'none';
                doneBtn.style.display = 'none';
                stepIndicator.style.display = 'flex';
                nextBtn.textContent = 'Ya realice el pago →';
            } else if (currentPaymentStep === 3) {
                backBtn.style.display = 'block';
                nextBtn.style.display = 'block';
                cancelBtn.style.display = 'none';
                doneBtn.style.display = 'none';
                stepIndicator.style.display = 'flex';
                nextBtn.textContent = 'Enviar Comprobante';
            } else if (currentPaymentStep === 4) {
                // Success state
                backBtn.style.display = 'none';
                nextBtn.style.display = 'none';
                cancelBtn.style.display = 'none';
                doneBtn.style.display = 'block';
                stepIndicator.style.display = 'none';
            }
        }

        async function paymentNextStep() {
            if (currentPaymentStep === 1) {
                // Validate step 1
                var amount = parseFloat(document.getElementById('paymentAmount').value);
                var method = document.getElementById('paymentMethod').value;
                var errorDiv = document.getElementById('paymentStep1Error');
                
                if (!amount || amount <= 0) {
                    errorDiv.textContent = 'Por favor ingresa un monto valido';
                    errorDiv.style.display = 'block';
                    return;
                }
                if (!method) {
                    errorDiv.textContent = 'Por favor selecciona un metodo de pago';
                    errorDiv.style.display = 'block';
                    return;
                }
                errorDiv.style.display = 'none';
                
                // Request payment code from API
                var nextBtn = document.getElementById('paymentNextBtn');
                nextBtn.disabled = true;
                nextBtn.textContent = 'Generando codigo...';
                
                try {
                    var userId = (function() {
                        // Try multiple sources for user ID
                        var latandaUser = localStorage.getItem('latanda_user');
                        if (latandaUser) {
                            try {
                                var userData = JSON.parse(latandaUser);
                                if (userData.user_id) return userData.user_id;
                                if (userData.id) return userData.id;
                            } catch(e) { /* localStorage parse may fail in private browsing */ }
                        }
                        return localStorage.getItem('latanda_user_id') || 
                               sessionStorage.getItem('latanda_user_id') ||
                               localStorage.getItem('userId') ||
                               window.currentUserId ||
                               'user_unknown';
                    })();
                    var apiBase = window.API_BASE_URL || 'https://latanda.online';
                    
                    var response = await fetch(apiBase + '/api/contributions/request', {
                        method: 'POST',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            group_id: currentPaymentGroupId,
                            amount: amount,
                            payment_method: method
                        })
                    });
                    
                    var result = await response.json();
                    
                    if (!result.success || !result.data) {
                        throw new Error(result.data?.error?.message || 'Error al generar codigo');
                    }
                    
                    currentPaymentData = result.data;
                    
                    // Display instructions
                    displayPaymentInstructions(currentPaymentData);
                    
                    // Move to step 2
                    currentPaymentStep = 2;
                    showPaymentStep(2);
                    updateStepIndicator(2);
                    updatePaymentButtons();
                    
                } catch (err) {
                    errorDiv.textContent = 'Error al generar codigo de pago';
                    errorDiv.style.display = 'block';
                } finally {
                    nextBtn.disabled = false;
                    nextBtn.textContent = 'Continuar →';
                }
                
            } else if (currentPaymentStep === 2) {
                // Move to step 3 (upload proof)
                currentPaymentStep = 3;
                showPaymentStep(3);
                updateStepIndicator(3);
                updatePaymentButtons();
                
            } else if (currentPaymentStep === 3) {
                // Submit proof and complete
                await submitPaymentWithProof();
            }
        }

        function paymentPrevStep() {
            if (currentPaymentStep > 1) {
                currentPaymentStep--;
                showPaymentStep(currentPaymentStep);
                updateStepIndicator(currentPaymentStep);
                updatePaymentButtons();
            }
        }

        function displayPaymentInstructions(data) {
            // Reference code
            document.getElementById('referenceCodeDisplay').textContent = data.reference_code;
            
            // Instructions title
            document.getElementById('instructionsTitle').textContent = data.instructions.title;
            
            // Instructions steps
            var stepsList = document.getElementById('instructionsSteps');
            stepsList.innerHTML = '';
            data.instructions.steps.forEach(function(step) {
                var li = document.createElement('li');
                li.textContent = step;
                li.style.marginBottom = '8px';
                stepsList.appendChild(li);
            });
            
            // Bank details (if applicable)
            var bankBox = document.getElementById('bankDetailsBox');
            if (data.instructions.bank_details) {
                bankBox.style.display = 'block';
                var bankContent = document.getElementById('bankDetailsContent');
                var bd = data.instructions.bank_details;
                var _piEsc = typeof escapeHtml === 'function' ? escapeHtml : function(s) {
                    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
                };
                bankContent.innerHTML =
                    '<div style="margin-bottom: 6px;"><strong>Banco:</strong> ' + _piEsc(bd.bank_name || '') + '</div>' +
                    '<div style="margin-bottom: 6px;"><strong>Cuenta:</strong> ' + _piEsc(bd.account_number || '') + '</div>' +
                    '<div style="margin-bottom: 6px;"><strong>Titular:</strong> ' + _piEsc(bd.account_holder || '') + '</div>' +
                    '<div><strong>Tipo:</strong> ' + _piEsc(bd.account_type || '') + '</div>';
            } else {
                bankBox.style.display = 'none';
            }
            
            // Verification time
            document.getElementById('verificationTimeText').textContent = 
                'Tiempo de verificacion: ' + data.instructions.verification_time;
        }

        function copyReferenceCode() {
            var code = document.getElementById('referenceCodeDisplay').textContent;
            navigator.clipboard.writeText(code).then(function() {
                if (typeof window.showSuccess === 'function') {
                    window.showSuccess('Codigo copiado!');
                } else {
                    showSuccess('Codigo copiado!');
                }
            }).catch(function() { /* clipboard API may not be available */ });
        }

        function handleProofUpload(event) {
            var file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                var errorDiv = document.getElementById('paymentStep3Error');
                errorDiv.textContent = 'Por favor selecciona una imagen';
                errorDiv.style.display = 'block';
                return;
            }
            
            proofFile = file;
            
            // Show preview
            var reader = new FileReader();
            reader.onload = function(e) {
                var previewImg = document.getElementById('proofPreviewImage');
                previewImg.src = e.target.result;
                document.getElementById('proofPreview').style.display = 'block';
                document.getElementById('proofUploadPrompt').style.display = 'none';
            };
            reader.readAsDataURL(file);
            
            document.getElementById('paymentStep3Error').style.display = 'none';
        }

        async function submitPaymentWithProof() {
            var errorDiv = document.getElementById('paymentStep3Error');
            var nextBtn = document.getElementById('paymentNextBtn');

            // Validate proof file
            if (!proofFile) {
                errorDiv.textContent = 'Por favor sube un comprobante';
                errorDiv.style.display = 'block';
                return;
            }

            // Validate we have contribution data
            if (!currentPaymentData || !currentPaymentData.contribution_id) {
                errorDiv.textContent = 'Error: datos de contribucion no encontrados';
                errorDiv.style.display = 'block';
                return;
            }

            nextBtn.disabled = true;
            nextBtn.textContent = 'Enviando...';
            errorDiv.style.display = 'none';

            try {
                var apiBase = window.API_BASE_URL || 'https://latanda.online';

                // Create FormData for file upload
                var formData = new FormData();
                formData.append('proof', proofFile);

                // Upload proof to backend
                var response = await fetch(apiBase + '/api/contributions/' + currentPaymentData.contribution_id + '/upload-proof', {
                    method: 'POST',
                    headers: { ...getAuthHeaders() },
                    body: formData
                });

                var result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error('Error al subir comprobante');
                }

                // Show success
                currentPaymentStep = 4;
                showPaymentStep('success');

                document.getElementById('paymentSuccessMessage').textContent =
                    'Pago de L. ' + currentPaymentData.amount.toLocaleString('es-HN', {minimumFractionDigits: 2}) + ' registrado';
                document.getElementById('paymentSuccessCode').textContent =
                    'Codigo: ' + currentPaymentData.reference_code;
                document.getElementById('paymentSuccessStatus').textContent =
                    'Estado: Esperando verificacion';

                updatePaymentButtons();

                if (typeof window.showSuccess === 'function') {
                    window.showSuccess('Comprobante enviado exitosamente');
                }

                // Refresh the page data after a short delay
                setTimeout(function() {
                    if (typeof loadGroupsData === 'function') {
                        loadGroupsData();
                    }
                }, 2000);

            } catch (err) {
                errorDiv.textContent = 'Error al enviar comprobante';
                errorDiv.style.display = 'block';
            } finally {
                nextBtn.disabled = false;
                nextBtn.textContent = 'Enviar Comprobante';
            }
        }

        function closeRegisterPaymentModal() {
            var modal = document.getElementById('registerPaymentModal');
            if (modal) {
                modal.style.display = 'none'; modal.classList.remove('active');
                document.body.style.overflow = '';
            }
            currentPaymentGroupId = null;
            currentPaymentData = null;
            proofFile = null;
        }

        // Keep legacy functions for backwards compatibility
        function resetPaymentForm() {
            resetPaymentModal();
        }

        async function loadMembersForPayment(groupId) {
            // Legacy function - no longer needed in new flow
            return;
        }

        async function submitPayment(event) {
            // Legacy function - redirects to new flow
            if (event) event.preventDefault();
            paymentNextStep();
        }
        // ========== END PAYMENT MODAL ==========

        // Close register payment modal on overlay click
        document.addEventListener('DOMContentLoaded', function() {
            var modal = document.getElementById('registerPaymentModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) closeRegisterPaymentModal();
                });
            }
        });

    </script>


    <script>
        // ============================================
        // GROUP MANAGEMENT MODAL (Dark theme + delegated)
        // ============================================
        var currentManagedGroupId = null;

        window.closeModal = function() {
            var modal = document.getElementById('groupManageModal');
            if (modal) {
                modal.style.display = 'none'; modal.classList.remove('active');
                document.body.style.overflow = '';
            }
            currentManagedGroupId = null;
        };

        window.manageGroup = function(groupId) {
            currentManagedGroupId = groupId;
            var modal = document.getElementById('groupManageModal');
            if (modal) { modal.remove(); }
            var groupData = window.currentGroupsData?.find(function(g) { return g.id === groupId; });
            var userRole = groupData?.my_role || "member";
            createGroupManageModal(userRole);
            modal = document.getElementById('groupManageModal');

            var titleEl = document.getElementById('manageModalGroupName');
            if (titleEl) {
                titleEl.textContent = groupData?.name || 'Grupo';
            }

            modal.style.display = 'flex'; modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        };

        function _gmIcon(paths, color) {
            return '<div style="width: 40px; height: 40px; background: ' + color + '; border-radius: 10px; display: flex; align-items: center; justify-content: center;">' + paths + '</div>';
        }
        function _gmBtn(action, iconSvg, iconBg, title, subtitle, titleColor, subtitleColor, bg, border) {
            return '<button data-action="' + action + '" class="admin-option-btn" style="display: flex; align-items: center; gap: 12px; width: 100%; padding: 14px 16px; background: ' + bg + '; border: 1px solid ' + border + '; border-radius: 12px; cursor: pointer; transition: background 0.2s, transform 0.2s;">' +
                _gmIcon(iconSvg, iconBg) +
                '<div style="text-align: left;"><div style="font-weight: 500; color: ' + titleColor + ';">' + title + '</div><div style="font-size: 0.75rem; color: ' + subtitleColor + ';">' + subtitle + '</div></div></button>';
        }

        function createGroupManageModal(userRole) {
            var canManage = (userRole === "creator" || userRole === "coordinator");
            var canEdit = canManage;
            var canDelete = (userRole === "creator");

            var svgMembers = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#a78bfa" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>';
            var svgPayments = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#34d399" stroke-width="2"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>';
            var svgInvite = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>';
            var svgRegPay = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#60a5fa" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>';
            var svgVerify = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>';
            var svgDistribute = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#34d399" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>';
            var svgTurns = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 12l2 2 4-4"/></svg>';
            var svgPause = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f87171" stroke-width="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>';
            var svgEdit = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#818cf8" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>';
            var svgDelete = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f87171" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>';

            var dark = 'rgba(255,255,255,0.05)';
            var darkBorder = 'rgba(255,255,255,0.1)';
            var warnBg = 'rgba(251,191,36,0.1)';
            var warnBorder = 'rgba(251,191,36,0.2)';
            var greenBg = 'rgba(52,211,153,0.1)';
            var greenBorder = 'rgba(52,211,153,0.2)';
            var redBg = 'rgba(248,113,113,0.1)';
            var redBorder = 'rgba(248,113,113,0.2)';

            var buttons = '';
            buttons += _gmBtn('gm-view-members', svgMembers, 'rgba(124,58,237,0.2)', 'Ver Miembros', 'Lista de participantes', '#e2e8f0', '#94a3b8', dark, darkBorder);
            buttons += _gmBtn('gm-view-payments', svgPayments, 'rgba(52,211,153,0.2)', 'Ver Pagos', 'Historial de contribuciones', '#e2e8f0', '#94a3b8', dark, darkBorder);
            buttons += _gmBtn('gm-invite', svgInvite, 'rgba(251,191,36,0.2)', 'Invitar Miembros', 'Enviar invitaciones', '#e2e8f0', '#94a3b8', dark, darkBorder);
            buttons += _gmBtn('gm-register-payment', svgRegPay, 'rgba(96,165,250,0.2)', 'Registrar Pago', 'Agregar contribucion', '#e2e8f0', '#94a3b8', dark, darkBorder);
            if (canManage) {
                buttons += _gmBtn('gm-verify-payments', svgVerify, warnBg, 'Verificar Pagos', 'Aprobar pagos pendientes', '#fbbf24', '#d97706', warnBg, warnBorder);
                buttons += _gmBtn('gm-distribute', svgDistribute, greenBg, 'Distribuir Ciclo', 'Repartir fondos del ciclo', '#34d399', '#059669', greenBg, greenBorder);
                buttons += _gmBtn('gm-manage-turns', svgTurns, warnBg, 'Gestionar Turnos', 'Reordenar posiciones', '#fbbf24', '#d97706', warnBg, warnBorder);
                buttons += _gmBtn('gm-show-balances', '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#00FFFF" stroke-width="2"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>', 'rgba(0,255,255,0.1)', 'Saldos de Tanda', 'Balance por miembro', '#00FFFF', '#00B8D4', dark, darkBorder);
                buttons += _gmBtn('gm-show-extensions', '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2"><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="10"/></svg>', 'rgba(245,158,11,0.1)', 'Gestionar Prorrogas', 'Moras y solicitudes', '#f59e0b', '#d97706', 'rgba(245,158,11,0.1)', 'rgba(245,158,11,0.3)');
                buttons += _gmBtn('gm-toggle-pause', svgPause, redBg, 'Pausar/Reanudar', 'Detener temporalmente la tanda', '#f87171', '#ef4444', redBg, redBorder);
            }
            if (canManage) {
                buttons += _gmBtn('gm-commission-manager', '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>', 'rgba(0,255,255,0.1)', 'Gestor de Comisiones', 'Ver estado y gestionar comisiones', '#00FFFF', '#00B8D4', dark, darkBorder);
            }
            if (canEdit) {
                buttons += _gmBtn('gm-edit-group', svgEdit, 'rgba(129,140,248,0.2)', 'Editar Grupo', 'Modificar configuracion', '#e2e8f0', '#94a3b8', dark, darkBorder);
            }
            if (canDelete) {
                buttons += _gmBtn('gm-delete-group', svgDelete, redBg, 'Eliminar Grupo', 'Esta accion es irreversible', '#f87171', '#ef4444', redBg, redBorder);
            }

            var modalHtml = '<div id="groupManageModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); justify-content: center; align-items: center; z-index: 10000;">' +
                '<div class="modal-content" style="background: #0f172a; border: 1px solid rgba(0,255,255,0.15); border-radius: 16px; max-width: 400px; width: 90%; max-height: 85vh; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);">' +
                    '<div class="modal-header" style="background: linear-gradient(135deg, rgba(0,255,255,0.15) 0%, rgba(0,255,255,0.05) 100%); color: #f8fafc; padding: 20px; border-bottom: 1px solid rgba(0,255,255,0.1); position: relative;">' +
                        '<div style="display: flex; align-items: center; gap: 12px;">' +
                            '<div style="background: rgba(0,255,255,0.15); padding: 10px; border-radius: 12px;"><i class="fas fa-cog" style="font-size: 20px; color: #00FFFF;"></i></div>' +
                            '<div><h3 style="margin: 0; font-size: 1.25rem; font-weight: 600; color: #f8fafc;">Administrar Grupo</h3>' +
                            '<p id="manageModalGroupName" style="margin: 4px 0 0; font-size: 0.875rem; color: #94a3b8;">Grupo</p></div>' +
                        '</div>' +
                        '<button data-action="gm-close" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.1); border: none; width: 32px; height: 32px; border-radius: 8px; color: #94a3b8; cursor: pointer; display: flex; align-items: center; justify-content: center;"><i class="fas fa-times"></i></button>' +
                    '</div>' +
                    '<div class="modal-body" style="padding: 16px; max-height: 65vh; overflow-y: auto;">' +
                        '<div style="display: flex; flex-direction: column; gap: 8px;">' + buttons + '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';

            document.body.insertAdjacentHTML('beforeend', modalHtml);

            var modal = document.getElementById('groupManageModal');
            modal.addEventListener('click', function(e) {
                if (e.target === modal) { closeModal(); return; }
                var btn = e.target.closest('[data-action]');
                if (!btn) return;
                var gid = currentManagedGroupId;
                switch (btn.getAttribute('data-action')) {
                    case 'gm-close': closeModal(); break;
                    case 'gm-view-members': if (typeof viewGroupMembers === 'function') viewGroupMembers(gid); break;
                    case 'gm-view-payments': if (typeof viewGroupPayments === 'function') viewGroupPayments(gid); break;
                    case 'gm-invite': if (typeof inviteToGroup === 'function') inviteToGroup(gid); break;
                    case 'gm-register-payment': if (typeof registerGroupPayment === 'function') registerGroupPayment(gid); break;
                    case 'gm-verify-payments': if (typeof verifyPendingPayments === 'function') verifyPendingPayments(gid); break;
                    case 'gm-distribute': if (typeof showDistributionPreview === 'function') showDistributionPreview(gid); break;
                    case 'gm-manage-turns': if (typeof manageTurns === 'function') manageTurns(gid); break;
                    case 'gm-toggle-pause': if (typeof toggleTandaPause === 'function') toggleTandaPause(gid); break;
                    case 'gm-show-balances': if (typeof showTandaBalances === 'function') showTandaBalances(gid); break;
                    case 'gm-show-extensions': if (typeof showExtensionManager === 'function') showExtensionManager(gid); break;
                    case 'gm-commission-manager': showCommissionManager(gid); closeModal(); break;
                    case 'gm-edit-group': if (typeof editGroup === 'function') editGroup(gid); break;
                    case 'gm-delete-group': if (typeof confirmDeleteGroup === 'function') confirmDeleteGroup(gid); break;
                }
            });
        }

        // Hover effect for dark theme
        var styleEl = document.createElement('style');
        styleEl.textContent = '.admin-option-btn:hover { background: rgba(0,255,255,0.08) !important; border-color: rgba(0,255,255,0.2) !important; transform: translateX(4px); }';
        document.head.appendChild(styleEl);
        // v4.10.7: Commission Manager Panel
        var cmState = { groupId: null, rate: null, type: null, members: [], summary: {} };

        async function showCommissionManager(groupId) {
            cmState.groupId = groupId;
            var overlay = document.createElement('div');
            overlay.className = 'cm-overlay';
            overlay.id = 'cm-overlay';
            overlay.innerHTML = '<div class="cm-modal" id="cm-modal"><div class="cm-header"><div><h3>Gestor de Comisiones</h3><div class="cm-header-sub" id="cm-group-name"></div></div><button class="cm-close" data-action="cm-close">&times;</button></div><div class="cm-body"><div class="cm-spinner" id="cm-loading"></div><div id="cm-content" style="display:none"><div id="cm-rate-badge"></div><div class="cm-stats" id="cm-stats"></div><div class="cm-actions"><button class="cm-action-btn" data-action="cm-change-rate">Cambiar Tasa</button><button class="cm-action-btn cm-action-btn-primary" data-action="cm-notify" id="cm-notify-btn">Notificar Pendientes</button></div><div class="cm-inline-form" id="cm-rate-form"><label>Tipo de comision</label><select id="cm-rate-type"><option value="platform_default">Estandar (1-3% segun monto)</option><option value="custom">Personalizada</option><option value="none">Sin comision (0%)</option></select><div id="cm-custom-wrap" style="display:none"><label>Porcentaje personalizado</label><input type="number" id="cm-custom-rate" min="0.01" max="5" step="0.01" placeholder="Ej: 2.5"></div><div class="cm-form-row"><button class="cm-action-btn cm-action-btn-primary" data-action="cm-save-rate">Guardar</button><button class="cm-action-btn" data-action="cm-cancel-rate">Cancelar</button></div></div><div class="cm-member-list" id="cm-member-list"><h4>Miembros</h4><div id="cm-members"></div></div></div></div></div>';
            document.body.appendChild(overlay);

            overlay.addEventListener('click', function(e) {
                var action = e.target.closest('[data-action]');
                if (!action) {
                    if (e.target === overlay) { cmClose(); }
                    return;
                }
                var act = action.getAttribute('data-action');
                if (act === 'cm-close') cmClose();
                else if (act === 'cm-change-rate') cmToggleForm();
                else if (act === 'cm-save-rate') cmSaveRate();
                else if (act === 'cm-cancel-rate') cmCancelForm();
                else if (act === 'cm-notify') cmNotify();
            });

            var typeSelect = document.getElementById('cm-rate-type');
            if (typeSelect) {
                typeSelect.addEventListener('change', function() {
                    var wrap = document.getElementById('cm-custom-wrap');
                    if (wrap) wrap.style.display = this.value === 'custom' ? 'block' : 'none';
                });
            }

            await cmLoadData();
        }

        function cmClose() {
            var overlay = document.getElementById('cm-overlay');
            if (overlay) overlay.remove();
            cmState = { groupId: null, rate: null, type: null, members: [], summary: {} };
        }

        async function cmLoadData() {
            var token = localStorage.getItem('auth_token') || localStorage.getItem('authToken');
            if (!token) { showError('Sesion expirada'); cmClose(); return; }
            var loading = document.getElementById('cm-loading');
            var content = document.getElementById('cm-content');
            if (loading) loading.style.display = 'flex';
            if (content) content.style.display = 'none';
            try {
                var resp = await fetch('/api/groups/' + encodeURIComponent(cmState.groupId) + '/commission/members', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                var data = await resp.json();
                if (!data.success) { showError('Error al cargar datos'); cmClose(); return; }
                var d = data.data;
                cmState.rate = d.commission_rate;
                cmState.type = d.commission_type;
                cmState.members = d.members || [];
                cmState.summary = d.summary || {};
                var gn = document.getElementById('cm-group-name');
                if (gn) gn.textContent = d.group_name || '';
                cmRenderBadge();
                cmRenderStats();
                cmRenderMembers();
                if (loading) loading.style.display = 'none';
                if (content) content.style.display = 'block';
            } catch (e) {
                showError('Error de conexion');
                cmClose();
            }
        }

        function cmRenderBadge() {
            var el = document.getElementById('cm-rate-badge');
            if (!el) return;
            var cls, text;
            if (cmState.type === 'none') { cls = 'cm-rate-none'; text = 'Sin Comision (0%)'; }
            else if (cmState.type === 'custom') { cls = 'cm-rate-custom'; text = cmState.rate + '%'; }
            else { cls = 'cm-rate-default'; text = 'Estandar (1-3%)'; }
            el.className = 'cm-rate-badge ' + cls;
            el.textContent = text;
        }

        function cmRenderStats() {
            var el = document.getElementById('cm-stats');
            if (!el) return;
            var s = cmState.summary;
            el.innerHTML = '<div class="cm-stat"><strong>' + (s.accepted || 0) + '</strong>Aceptaron</div>' +
                '<div class="cm-stat"><strong>' + (s.declined || 0) + '</strong>Rechazaron</div>' +
                '<div class="cm-stat"><strong>' + (s.undecided || 0) + '</strong>Sin decidir</div>';
            var btn = document.getElementById('cm-notify-btn');
            if (btn) btn.disabled = (s.undecided || 0) === 0;
        }

        function cmRenderMembers() {
            var el = document.getElementById('cm-members');
            if (!el) return;
            if (cmState.members.length === 0) { el.innerHTML = '<div class="cm-empty">No hay miembros activos</div>'; return; }
            var html = '';
            for (var i = 0; i < cmState.members.length; i++) {
                var m = cmState.members[i];
                var name = escapeHtml(m.user_name || '');
                var initial = name.charAt(0).toUpperCase();
                var avatarHtml;
                if (m.avatar_url && m.avatar_url !== '/uploads/avatars/default.jpg') {
                    avatarHtml = '<img src="' + escapeHtml(m.avatar_url) + '" alt="">';
                } else {
                    avatarHtml = initial;
                }
                var roleCls = m.role === 'creator' ? 'cm-role-creator' : (m.role === 'coordinator' ? 'cm-role-coordinator' : 'cm-role-member');
                var roleLabel = m.role === 'creator' ? 'Creador' : (m.role === 'coordinator' ? 'Coordinador' : 'Miembro');
                var badgeCls, badgeText;
                if (m.commission_accepted === true) { badgeCls = 'cm-badge-accepted'; badgeText = 'Aceptada'; }
                else if (m.commission_accepted === false) { badgeCls = 'cm-badge-declined'; badgeText = 'Rechazada'; }
                else { badgeCls = 'cm-badge-undecided'; badgeText = 'Sin decidir'; }
                html += '<div class="cm-member-row">' +
                    '<div class="cm-member-avatar">' + avatarHtml + '</div>' +
                    '<div class="cm-member-info"><div class="cm-member-name">' + name + '</div><span class="cm-member-role ' + roleCls + '">' + roleLabel + '</span></div>' +
                    '<span class="' + badgeCls + '">' + badgeText + '</span></div>';
            }
            el.innerHTML = html;
        }

        function cmToggleForm() {
            var form = document.getElementById('cm-rate-form');
            if (!form) return;
            form.classList.toggle('cm-visible');
            if (form.classList.contains('cm-visible')) {
                var sel = document.getElementById('cm-rate-type');
                var inp = document.getElementById('cm-custom-rate');
                var wrap = document.getElementById('cm-custom-wrap');
                if (cmState.type === 'none') { if (sel) sel.value = 'none'; if (wrap) wrap.style.display = 'none'; }
                else if (cmState.type === 'custom') { if (sel) sel.value = 'custom'; if (wrap) wrap.style.display = 'block'; if (inp) inp.value = cmState.rate; }
                else { if (sel) sel.value = 'platform_default'; if (wrap) wrap.style.display = 'none'; }
            }
        }

        function cmCancelForm() {
            var form = document.getElementById('cm-rate-form');
            if (form) form.classList.remove('cm-visible');
        }

        async function cmSaveRate() {
            var token = localStorage.getItem('auth_token') || localStorage.getItem('authToken');
            if (!token) { showError('Sesion expirada'); return; }
            var sel = document.getElementById('cm-rate-type');
            if (!sel) return;
            var rateValue = null;
            if (sel.value === 'none') { rateValue = 0; }
            else if (sel.value === 'custom') {
                var inp = document.getElementById('cm-custom-rate');
                if (!inp || !inp.value) { showError('Ingresa un porcentaje'); return; }
                var parsed = parseFloat(inp.value);
                if (isNaN(parsed) || parsed < 0.01 || parsed > 5) { showError('El porcentaje debe ser entre 0.01% y 5%'); return; }
                rateValue = parsed;
            }
            try {
                var resp = await fetch('/api/groups/' + encodeURIComponent(cmState.groupId) + '/commission/rate', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({ commission_rate: rateValue, auto_notify: true })
                });
                var data = await resp.json();
                if (data.success) {
                    showSuccess(data.data.message || 'Comision actualizada');
                    cmCancelForm();
                    await cmLoadData();
                } else {
                    showError('Error al cambiar comision');
                }
            } catch (e) {
                showError('Error de conexion');
            }
        }

        async function cmNotify() {
            var token = localStorage.getItem('auth_token') || localStorage.getItem('authToken');
            if (!token) { showError('Sesion expirada'); return; }
            var btn = document.getElementById('cm-notify-btn');
            if (btn) btn.disabled = true;
            try {
                var resp = await fetch('/api/groups/' + encodeURIComponent(cmState.groupId) + '/commission/notify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }
                });
                var data = await resp.json();
                if (data.success) {
                    showSuccess('Notificaciones enviadas a ' + (data.data.notified || 0) + ' miembros');
                } else {
                    showError('Error al enviar notificaciones');
                }
            } catch (e) {
                showError('Error de conexion');
            }
            if (btn) btn.disabled = false;
        }
    </script>

<!-- FASE 2: Group Notification Helpers (Toast-based) - Added 2025-11-27 -->
<script>
(function() {
    'use strict';
    
    // Helper functions for group notifications using existing toast system
    window.notifyMemberAdded = function(groupName, memberName) {
        if (window.showToast) {
            window.showToast(memberName + ' se unio a ' + groupName, 'success');
        }
    };
    
    window.notifyPaymentRegistered = function(groupName, amount) {
        if (window.showToast) {
            window.showToast('Pago de $' + amount + ' registrado en ' + groupName, 'success');
        }
    };
    
    window.notifyInvitationSent = function(groupName, email) {
        if (window.showToast) {
            window.showToast('Invitacion enviada a ' + email, 'success');
        }
    };
    
    window.notifyGroupUpdated = function(groupName) {
        if (window.showToast) {
            window.showToast('Grupo ' + groupName + ' actualizado', 'success');
        }
    };
    
    window.notifyGroupCreated = function(groupName) {
        if (window.showToast) {
            window.showToast('Grupo ' + groupName + ' creado exitosamente', 'success');
        }
    };
    
    window.notifyExportStarted = function(format) {
        if (window.showToast) {
            window.showToast('Exportando datos en formato ' + format.toUpperCase() + '...', 'info');
        }
    };
    
    window.notifyError = function(message) {
        if (window.showToast) {
            window.showToast(message, 'error');
        }
    };
    
})();
</script>

<!-- FASE 1: Export Functions - Added 2025-11-27 -->
<script>
(function() {
    'use strict';
    window.exportGroupMembers = function(groupId, format) {
        if (!groupId) groupId = window.currentMembersGroupId || window.currentManagedGroupId;
        if (!groupId) { showError('No se pudo determinar el grupo'); return; }
        var apiBase = window.API_BASE_URL || 'https://latanda.online';
        if (window.notifyExportStarted) window.notifyExportStarted(format); window.open(apiBase + '/api/groups/' + groupId + '/export/members?format=' + format, '_blank');
    };
    window.exportGroupPayments = function(groupId, format) {
        if (!groupId) groupId = window.currentPaymentsGroupId || window.currentManagedGroupId;
        if (!groupId) { showError('No se pudo determinar el grupo'); return; }
        var apiBase = window.API_BASE_URL || 'https://latanda.online';
        if (window.notifyExportStarted) window.notifyExportStarted(format); window.open(apiBase + '/api/groups/' + groupId + '/export/payments?format=' + format, '_blank');
    };
})();
</script>

<!-- FASE 1: Export Buttons for Admin Modal - Added 2025-11-27 -->
<script>
(function() {
    'use strict';
    
    // Override manageGroup to add export buttons after modal is shown
    var originalManageGroup = window.manageGroup;
    window.manageGroup = function(groupId) {
        originalManageGroup(groupId);
        
        // Add export buttons after a short delay to ensure modal is rendered
        setTimeout(function() {
            var modal = document.getElementById('groupManageModal');
            if (!modal) return;
            
            var modalBody = modal.querySelector('.modal-body > div');
            if (!modalBody) return;
            
            // Check if export section already exists
            if (modal.querySelector('.export-section')) return;
            
            // Create export section
            var exportSection = document.createElement('div');
            exportSection.className = 'export-section';
            exportSection.style.cssText = 'margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);';
            exportSection.innerHTML = 
                '<div style="padding: 8px 0; color: #94a3b8; font-size: 0.75rem; font-weight: 500; text-transform: uppercase;">Exportar Datos</div>' +
                '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">' +
                    '<button id="export-members-pdf" style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; cursor: pointer; font-size: 0.875rem; color: #e2e8f0;"><span>📄</span> Miembros PDF</button>' +
                    '<button id="export-members-csv" style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; cursor: pointer; font-size: 0.875rem; color: #e2e8f0;"><span>📊</span> Miembros CSV</button>' +
                    '<button id="export-payments-pdf" style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; cursor: pointer; font-size: 0.875rem; color: #e2e8f0;"><span>📄</span> Pagos PDF</button>' +
                    '<button id="export-payments-csv" style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; cursor: pointer; font-size: 0.875rem; color: #e2e8f0;"><span>📊</span> Pagos CSV</button>' +
                '</div>';
            
            modalBody.appendChild(exportSection);
            
            // Add click handlers
            exportSection.querySelector('#export-members-pdf').onclick = function() { window.exportGroupMembers(window.currentManagedGroupId, 'pdf'); };
            exportSection.querySelector('#export-members-csv').onclick = function() { window.exportGroupMembers(window.currentManagedGroupId, 'csv'); };
            exportSection.querySelector('#export-payments-pdf').onclick = function() { window.exportGroupPayments(window.currentManagedGroupId, 'pdf'); };
            exportSection.querySelector('#export-payments-csv').onclick = function() { window.exportGroupPayments(window.currentManagedGroupId, 'csv'); };
            
        }, 50);
    };
    
})();
</script>



<!-- PAYMENT VERIFICATION MODAL - Redesigned v4.10.7 dark theme -->
<div id="verifyPaymentsModal" class="vp-overlay" style="display: none;">
    <div class="vp-modal">
        <div class="vp-header">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div class="vp-header-icon">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                    </svg>
                </div>
                <div>
                    <h3 class="vp-title">Verificar Pagos</h3>
                    <p id="verifyModalGroupName" class="vp-subtitle">Pagos pendientes de aprobacion</p>
                </div>
            </div>
            <button data-action="grp-close-verify-payments" class="vp-close-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <!-- Summary bar -->
        <div id="vpStatsBar" class="vp-stats-bar" style="display: none;">
            <div class="vp-stat"><span id="vpStatTotal" class="vp-stat-val" style="color:#f59e0b;">0</span><span class="vp-stat-label">Pendientes</span></div>
            <div class="vp-stat"><span id="vpStatVerif" class="vp-stat-val" style="color:#00FFFF;">0</span><span class="vp-stat-label">Por verificar</span></div>
            <div class="vp-stat"><span id="vpStatAwait" class="vp-stat-val" style="color:#64748b;">0</span><span class="vp-stat-label">Sin comprobante</span></div>
        </div>
        <div id="verifyPaymentsContent" class="vp-body">
            <div class="vp-loading">
                <div class="vp-spinner"></div>
                <p>Cargando pagos pendientes...</p>
            </div>
        </div>
    </div>
</div>

<style>
    /* Verify Payments Modal (vp-) */
    .vp-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.7);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        justify-content: center;
        align-items: center;
        z-index: 10001;
    }
    .vp-modal {
        background: #0f172a;
        border-radius: 16px;
        box-shadow: 0 25px 60px rgba(0,0,0,0.5);
        width: 95%;
        max-width: 620px;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        animation: modalSlideIn 0.3s ease-out;
    }
    .vp-header {
        background: linear-gradient(135deg, #0e2a47 0%, #0f172a 100%);
        color: #e2e8f0;
        padding: 18px 20px;
        border-bottom: 1px solid rgba(245,158,11,0.2);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .vp-header-icon {
        background: rgba(245,158,11,0.15);
        padding: 9px;
        border-radius: 10px;
        color: #f59e0b;
    }
    .vp-title { margin: 0; font-size: 1.15rem; font-weight: 600; color: #f1f5f9; }
    .vp-subtitle { margin: 3px 0 0; font-size: 0.8rem; color: #64748b; }
    .vp-close-btn {
        background: rgba(255,255,255,0.08);
        border: none;
        width: 32px; height: 32px;
        border-radius: 8px;
        color: #94a3b8;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s, color 0.2s;
    }
    .vp-close-btn:hover { background: rgba(255,255,255,0.15); color: #e2e8f0; }
    .vp-stats-bar {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        padding: 10px 20px;
        background: #0f172a;
        border-bottom: 1px solid #1e293b;
    }
    .vp-stat {
        text-align: center;
        padding: 6px 0;
        background: rgba(30,41,59,0.5);
        border-radius: 8px;
    }
    .vp-stat-val { display: block; font-size: 1.2rem; font-weight: 700; }
    .vp-stat-label { font-size: 0.7rem; color: #64748b; }
    .vp-body {
        padding: 16px 20px;
        overflow-y: auto;
        flex: 1;
        max-height: calc(90vh - 160px);
    }
    .vp-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px;
        color: #64748b;
    }
    .vp-spinner {
        width: 36px; height: 36px;
        border: 3px solid #1e293b;
        border-top-color: #f59e0b;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 12px;
    }
    .vp-card {
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 12px;
        padding: 14px;
        margin-bottom: 10px;
        transition: border-color 0.2s;
    }
    .vp-card:hover { border-color: #475569; }
    .vp-card-top {
        display: flex;
        gap: 12px;
        align-items: flex-start;
    }
    .vp-card-avatar {
        width: 40px; height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.9rem;
        background: rgba(245,158,11,0.15);
        color: #f59e0b;
        flex-shrink: 0;
    }
    .vp-card-body { flex: 1; min-width: 0; }
    .vp-card-name {
        font-weight: 500;
        font-size: 0.9rem;
        color: #e2e8f0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .vp-card-contact { font-size: 0.72rem; color: #64748b; margin-top: 1px; }
    .vp-card-right { text-align: right; flex-shrink: 0; }
    .vp-card-amount { font-weight: 600; font-size: 1rem; color: #f59e0b; }
    .vp-card-date { font-size: 0.7rem; color: #475569; margin-top: 2px; }
    .vp-card-details {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid rgba(51,65,85,0.5);
    }
    .vp-detail {
        font-size: 0.72rem;
        color: #94a3b8;
    }
    .vp-detail strong { color: #cbd5e1; font-weight: 500; }
    .vp-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 6px;
        font-size: 0.68rem;
        font-weight: 600;
    }
    .vp-badge-pending { background: rgba(245,158,11,0.15); color: #f59e0b; }
    .vp-badge-awaiting { background: rgba(100,116,139,0.2); color: #94a3b8; }
    .vp-badge-cycle { background: rgba(0,255,255,0.1); color: #67e8f9; }
    .vp-badge-method { background: rgba(100,116,139,0.15); color: #94a3b8; }
    .vp-proof-thumb {
        width: 56px; height: 56px;
        object-fit: cover;
        border-radius: 8px;
        cursor: pointer;
        border: 2px solid #334155;
        flex-shrink: 0;
        transition: border-color 0.2s;
    }
    .vp-proof-thumb:hover { border-color: #f59e0b; }
    .vp-proof-placeholder {
        width: 56px; height: 56px;
        background: rgba(30,41,59,0.8);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #475569;
        font-size: 0.65rem;
        text-align: center;
        flex-shrink: 0;
        line-height: 1.2;
    }
    .vp-actions {
        display: flex;
        gap: 8px;
        margin-top: 10px;
    }
    .vp-btn {
        padding: 7px 14px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: 500;
        font-size: 0.82rem;
        transition: opacity 0.2s;
    }
    .vp-btn:hover { opacity: 0.85; }
    .vp-btn-approve { background: rgba(0,255,255,0.15); color: #00FFFF; }
    .vp-btn-reject { background: rgba(239,68,68,0.15); color: #ef4444; }
    .vp-verified-line { font-size: 0.68rem; color: #475569; margin-top: 6px; }
    .vp-verified-badge {
        display: inline-block;
        padding: 1px 5px;
        border-radius: 3px;
        font-size: 0.6rem;
        background: rgba(0,255,255,0.08);
        color: #67e8f9;
        margin-left: 3px;
    }
    .vp-empty {
        text-align: center;
        padding: 40px;
        color: #64748b;
    }
    .vp-empty-icon { font-size: 2.5rem; margin-bottom: 12px; opacity: 0.7; }
    .vp-awaiting-note {
        font-size: 0.78rem;
        color: #64748b;
        font-style: italic;
        margin-top: 8px;
        padding: 8px 12px;
        background: rgba(30,41,59,0.5);
        border-radius: 8px;
    }

    @media (max-width: 480px) {
        .vp-modal { width: 98%; max-height: 94vh; border-radius: 12px; }
        .vp-header { padding: 14px 16px; }
        .vp-stats-bar { padding: 8px 12px; gap: 6px; }
        .vp-body { padding: 12px; }
        .vp-card { padding: 12px; }
        .vp-card-name { font-size: 0.84rem; }
        .vp-card-details { gap: 6px; }
    }
</style>

<script>
(function() {
    'use strict';

    var currentVerifyGroupId = null;
    var vpClickHandler = null;

    var vpMethodLabels = {
        'cash': 'Efectivo',
        'bank_transfer': 'Transferencia',
        'mobile_money': 'Tigo Money',
        'card': 'Tarjeta',
        'crypto': 'Crypto',
        'wallet': 'Billetera'
    };

    var vpMethodIcons = {
        'cash': '\uD83D\uDCB5',
        'bank_transfer': '\uD83C\uDFE6',
        'mobile_money': '\uD83D\uDCF1',
        'card': '\uD83D\uDCB3',
        'crypto': '\u20BF',
        'wallet': '\uD83D\uDC5B'
    };

    function vpEsc(text) {
        return typeof escapeHtml === 'function' ? escapeHtml(String(text || '')) : String(text || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }

    function vpFormatAmount(amount) {
        var n = parseFloat(amount) || 0;
        return 'L. ' + n.toLocaleString('es-HN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    function vpFormatDate(dateStr) {
        if (!dateStr) return '';
        try { return new Date(dateStr).toLocaleDateString('es-HN', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }); }
        catch(e) { return ''; }
    }

    function vpGetVerifLabel(method) {
        if (method === 'coordinator_bulk') return 'Masivo';
        if (method === 'coordinator_manual') return 'Manual';
        if (method === 'ocr_auto') return 'OCR';
        return 'Verificado';
    }

    window.verifyPendingPayments = async function(groupId) {
        currentVerifyGroupId = groupId;
        closeModal(); // Close admin modal

        setTimeout(async function() {
            var modal = document.getElementById('verifyPaymentsModal');
            if (!modal) return;
            modal.style.display = 'flex';
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            await loadPendingPayments(groupId);
        }, 100);
    };

    async function loadPendingPayments(groupId) {
        var contentDiv = document.getElementById('verifyPaymentsContent');

        // Show loading
        contentDiv.innerHTML = '<div class="vp-loading"><div class="vp-spinner"></div><p>Cargando pagos pendientes...</p></div>';

        try {
            var apiBase = window.API_BASE_URL || 'https://latanda.online';
            var response = await fetch(apiBase + '/api/groups/' + encodeURIComponent(groupId) + '/contributions/pending', { headers: getAuthHeaders() });
            var result = await response.json();

            if (!result.success) {
                throw new Error('Error al cargar pagos');
            }

            var contributions = result.data.contributions || [];

            if (contributions.length === 0) {
                contentDiv.innerHTML =
                    '<div class="vp-empty">' +
                        '<div class="vp-empty-icon">\u2705</div>' +
                        '<h4 style="margin: 0 0 8px; color: #e2e8f0;">No hay pagos pendientes</h4>' +
                        '<p style="margin: 0;">Todos los pagos han sido verificados</p>' +
                    '</div>';
                document.getElementById('vpStatsBar').style.display = 'none';
                return;
            }

            // Stats
            var pendingVerif = 0, awaiting = 0;
            contributions.forEach(function(c) {
                if (c.status === 'pending_verification') pendingVerif++;
                else awaiting++;
            });

            document.getElementById('vpStatTotal').textContent = contributions.length;
            document.getElementById('vpStatVerif').textContent = pendingVerif;
            document.getElementById('vpStatAwait').textContent = awaiting;
            document.getElementById('vpStatsBar').style.display = 'grid';

            var html = '';

            contributions.forEach(function(c) {
                var safeId = vpEsc(c.id);
                var safeName = vpEsc(c.user_name || 'Usuario');
                var initial = safeName.charAt(0).toUpperCase();
                var safeContact = vpEsc(c.user_email || c.user_phone || '');
                var safeRef = vpEsc(c.reference_code || 'N/A');
                var methodKey = c.payment_method || '';
                var methodLabel = vpEsc(vpMethodLabels[methodKey] || methodKey || 'N/A');
                var methodIcon = vpMethodIcons[methodKey] || '\uD83D\uDCB0';
                var amount = vpFormatAmount(c.amount);
                var dateStr = vpFormatDate(c.created_at);
                var cycle = c.cycle_number || 0;

                var statusBadge = c.status === 'pending_verification'
                    ? '<span class="vp-badge vp-badge-pending">Por verificar</span>'
                    : '<span class="vp-badge vp-badge-awaiting">Sin comprobante</span>';

                // Proof thumbnail
                var safeProofUrl = c.proof_url ? vpEsc(c.proof_url) : '';
                var proofHtml = c.proof_url
                    ? '<img loading="lazy" src="' + vpEsc((window.API_BASE_URL || 'https://latanda.online')) + safeProofUrl + '" class="vp-proof-thumb" data-action="vp-show-proof" data-proof-url="' + safeProofUrl + '" alt="Comprobante">'
                    : '<div class="vp-proof-placeholder">Sin<br>prueba</div>';

                // Verification line
                var verifiedLine = '';
                if (c.verified_by_name && c.verified_by) {
                    verifiedLine = '<div class="vp-verified-line">Registrado por ' + vpEsc(c.verified_by_name) + '<span class="vp-verified-badge">' + vpEsc(vpGetVerifLabel(c.verification_method)) + '</span></div>';
                }

                html += '<div class="vp-card" data-contribution-id="' + safeId + '">' +
                    '<div class="vp-card-top">' +
                        proofHtml +
                        '<div class="vp-card-body">' +
                            '<div style="display:flex;justify-content:space-between;align-items:flex-start;">' +
                                '<div>' +
                                    '<div class="vp-card-name">' + safeName + '</div>' +
                                    '<div class="vp-card-contact">' + safeContact + '</div>' +
                                '</div>' +
                                '<div class="vp-card-right">' +
                                    '<div class="vp-card-amount">' + amount + '</div>' +
                                    '<div class="vp-card-date">' + vpEsc(dateStr) + '</div>' +
                                '</div>' +
                            '</div>' +
                            '<div class="vp-card-details">' +
                                statusBadge +
                                (cycle > 0 ? '<span class="vp-badge vp-badge-cycle">Ciclo ' + cycle + '</span>' : '') +
                                '<span class="vp-badge vp-badge-method">' + methodIcon + ' ' + methodLabel + '</span>' +
                                '<span class="vp-detail">Ref: <strong>' + safeRef + '</strong></span>' +
                            '</div>' +
                            verifiedLine +
                        '</div>' +
                    '</div>' +

                    (c.status === 'pending_verification' ?
                    '<div class="vp-actions">' +
                        '<button class="vp-btn vp-btn-approve" data-action="vp-approve" data-contribution-id="' + safeId + '">\u2713 Aprobar</button>' +
                        '<button class="vp-btn vp-btn-reject" data-action="vp-reject" data-contribution-id="' + safeId + '">\u2717 Rechazar</button>' +
                    '</div>' :
                    '<div class="vp-awaiting-note">Esperando que el miembro suba comprobante de pago</div>') +

                '</div>';
            });

            contentDiv.innerHTML = html;

            // Remove old delegated handler to prevent stacking
            if (vpClickHandler) {
                contentDiv.removeEventListener('click', vpClickHandler);
            }
            vpClickHandler = function(e) {
                var el = e.target.closest('[data-action]');
                if (!el) return;
                var action = el.getAttribute('data-action');
                var cid = el.getAttribute('data-contribution-id');
                if (action === 'vp-approve' && cid) {
                    window.approvePayment(cid);
                } else if (action === 'vp-reject' && cid) {
                    window.rejectPayment(cid);
                } else if (action === 'vp-show-proof') {
                    var url = el.getAttribute('data-proof-url');
                    if (url && typeof window.showProofFullscreen === 'function') window.showProofFullscreen(url);
                }
            };
            contentDiv.addEventListener('click', vpClickHandler);

        } catch (err) {
            contentDiv.innerHTML =
                '<div class="vp-empty">' +
                    '<div class="vp-empty-icon" style="opacity:0.5;">\u274C</div>' +
                    '<h4 style="margin: 0 0 8px; color: #ef4444;">Error al cargar</h4>' +
                    '<p style="margin: 0;">Intenta de nuevo</p>' +
                '</div>';
        }
    }

    function formatPaymentMethod(method) {
        return vpMethodLabels[method] || method;
    }

    window.approvePayment = async function(contributionId) {
        showConfirm('Confirmas que este pago es valido?', async function() {
        try {
            var apiBase = window.API_BASE_URL || 'https://latanda.online';
            var response = await fetch(apiBase + '/api/contributions/' + encodeURIComponent(contributionId) + '/verify', {
                method: 'POST',
                headers: Object.assign({}, getAuthHeaders(), { 'Content-Type': 'application/json' }),
                body: JSON.stringify({ action: 'approve' })
            });

            var result = await response.json();
            if (!result.success) throw new Error('Error al aprobar pago');

            if (window.showSuccess) window.showSuccess('Pago aprobado exitosamente');
            await loadPendingPayments(currentVerifyGroupId);
        } catch (err) {
            if (typeof showError === 'function') showError('No se pudo aprobar el pago');
        }
        }); // end showConfirm
    };

    window.rejectPayment = async function(contributionId) {
        var reason = prompt('Motivo del rechazo (opcional):');
        if (reason === null) return;

        try {
            var apiBase = window.API_BASE_URL || 'https://latanda.online';
            var response = await fetch(apiBase + '/api/contributions/' + encodeURIComponent(contributionId) + '/verify', {
                method: 'POST',
                headers: Object.assign({}, getAuthHeaders(), { 'Content-Type': 'application/json' }),
                body: JSON.stringify({ action: 'reject', rejection_reason: reason || 'Rechazado por coordinador' })
            });

            var result = await response.json();
            if (!result.success) throw new Error('Error al rechazar pago');

            if (window.showSuccess) window.showSuccess('Pago rechazado');
            await loadPendingPayments(currentVerifyGroupId);
        } catch (err) {
            if (typeof showError === 'function') showError('No se pudo rechazar el pago');
        }
    };

    window.showProofFullscreen = function(proofUrl) {
        var fullUrl = vpEsc((window.API_BASE_URL || 'https://latanda.online') + proofUrl);
        var overlay = document.createElement('div');
        overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.92);z-index:100000;display:flex;align-items:center;justify-content:center;cursor:pointer;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);';
        overlay.addEventListener('click', function() { overlay.remove(); });

        var img = document.createElement('img');
        img.src = fullUrl;
        img.style.cssText = 'max-width:90%;max-height:90%;object-fit:contain;border-radius:8px;';

        overlay.appendChild(img);
        document.body.appendChild(overlay);
    };

    // Close on overlay click
    var vpModal = document.getElementById('verifyPaymentsModal');
    if (vpModal) {
        vpModal.addEventListener('click', function(e) {
            if (e.target === vpModal) window.closeVerifyPaymentsModal();
        });
    }

    window.closeVerifyPaymentsModal = function() {
        var modal = document.getElementById('verifyPaymentsModal');
        if (modal) {
            modal.style.display = 'none';
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }
        currentVerifyGroupId = null;
        // Cleanup listener
        if (vpClickHandler) {
            var contentDiv = document.getElementById('verifyPaymentsContent');
            if (contentDiv) contentDiv.removeEventListener('click', vpClickHandler);
            vpClickHandler = null;
        }
    };

})();
</script>




<!-- CYCLE DISTRIBUTION MODAL - v4.10.8 Dark theme with target_total -->
<div id="distributionModal" class="dist-overlay" style="display: none;">
    <div class="dist-modal">
        <div class="dist-header">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="background: rgba(0,255,255,0.15); padding: 10px; border-radius: 12px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#00FFFF" stroke-width="2">
                        <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                    </svg>
                </div>
                <div>
                    <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600; color: #f8fafc;">Distribucion de Ciclo</h3>
                    <p id="distributionGroupName" style="margin: 4px 0 0; font-size: 0.875rem; color: #94a3b8;">Resumen de distribucion</p>
                </div>
            </div>
            <button data-action="grp-close-distribution" class="dist-close-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div id="distributionContent" style="padding: 20px; flex: 1; overflow-y: auto;">
            <div style="text-align: center; padding: 40px;">
                <div class="dist-spinner"></div>
                <p style="margin-top: 16px; color: #64748b;">Calculando distribucion...</p>
            </div>
        </div>
        <div id="distributionFooter" class="dist-footer" style="display: none;">
            <button data-action="grp-close-distribution" class="dist-btn-cancel">Cancelar</button>
            <button id="executeDistributionBtn" data-action="grp-execute-distribution" class="dist-btn-execute">
                Ejecutar Distribucion
            </button>
        </div>
    </div>
</div>

<!-- TANDA BALANCES MODAL - v4.10.8 -->
<div id="tandaBalancesModal" class="tb-overlay" style="display: none;">
    <div class="tb-modal">
        <div class="tb-header">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="background: rgba(0,255,255,0.15); padding: 10px; border-radius: 12px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#00FFFF" stroke-width="2">
                        <path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                    </svg>
                </div>
                <div>
                    <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600; color: #f8fafc;">Saldos de Tanda</h3>
                    <p id="tbGroupName" style="margin: 4px 0 0; font-size: 0.875rem; color: #94a3b8;">Cargando...</p>
                </div>
            </div>
            <button data-action="grp-close-balances" class="tb-close-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div id="tbContent" style="padding: 20px; flex: 1; overflow-y: auto;">
            <div class="tb-spinner-wrap"><div class="dist-spinner"></div></div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';

    var currentDistributionGroupId = null;
    var currentDistributionData = null;

    function _distFmt(n) {
        return (parseFloat(n) || 0).toLocaleString('es-HN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    window.showDistributionPreview = async function(groupId) {
        currentDistributionGroupId = groupId;
        closeModal(); // Close admin modal

        setTimeout(async function() {
            var modal = document.getElementById('distributionModal');
            modal.style.display = 'flex'; modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            await loadDistributionPreview(groupId);
        }, 100);
    };

    async function loadDistributionPreview(groupId) {
        var contentDiv = document.getElementById('distributionContent');
        var footerDiv = document.getElementById('distributionFooter');

        try {
            var apiBase = window.API_BASE_URL || 'https://latanda.online';
            var response = await fetch(apiBase + '/api/groups/' + encodeURIComponent(groupId) + '/distribution/preview', { headers: getAuthHeaders() });
            var result = await response.json();

            if (!result.success) {
                throw new Error('Error al calcular distribucion');
            }

            currentDistributionData = result.data;
            var d = result.data;

            // Update header
            document.getElementById('distributionGroupName').textContent =
                escapeHtml(d.group_name) + ' \u2014 Ciclo ' + d.next_distribution_cycle + ' de distribucion';

            var html = '';

            // v4.10.8: Target total section with progress bar
            var pct = Math.min(d.collection_percentage, 100);
            var offlineAmount = Math.max(d.target_total - d.actual_collected, 0);

            html += '<div class="dist-section">' +
                '<div class="dist-section-title">Meta del Ciclo</div>' +
                '<div class="dist-target-amount">L. ' + _distFmt(d.target_total) + '</div>' +
                '<div style="font-size: 0.78rem; color: #94a3b8; margin-bottom: 10px;">' +
                    escapeHtml(String(d.positions_total)) + ' posiciones &times; L. ' + _distFmt(d.target_total / d.positions_total) +
                '</div>' +
                '<div class="dist-progress-bar"><div class="dist-progress-fill" style="width: ' + Math.min(pct, 100) + '%;"></div></div>' +
                '<div style="display: flex; justify-content: space-between; font-size: 0.78rem; margin-top: 6px;">' +
                    '<span style="color: #94a3b8;">' + pct.toFixed(1) + '% recaudado</span>' +
                    '<span style="color: #64748b;">' + escapeHtml(String(d.positions_filled)) + '/' + escapeHtml(String(d.positions_total)) + ' posiciones</span>' +
                '</div>' +
                '<div style="display: flex; justify-content: space-between; font-size: 0.82rem; margin-top: 8px;">' +
                    '<span style="color: #34d399;">Recaudado: L. ' + _distFmt(d.actual_collected) + '</span>' +
                    (offlineAmount > 0 ? '<span style="color: #fbbf24;">Offline: L. ' + _distFmt(offlineAmount) + '</span>' : '') +
                '</div>' +
            '</div>';

            // Fees section
            var isCoordTurn = d.fees.is_coordinator_turn;
            var feeRate = d.fees.coordinator_rate;
            if (feeRate > 0 || !isCoordTurn) {
                html += '<div class="dist-section" style="border-color: rgba(251,191,36,0.15);">' +
                    '<div class="dist-section-title" style="color: #fbbf24;">Comisiones</div>';
                if (!isCoordTurn && feeRate > 0) {
                    html += '<div class="dist-fee-row">' +
                        '<span>Coordinador (' + feeRate + '%)</span>' +
                        '<span style="font-weight: 600;">L. ' + _distFmt(d.fees.coordinator_fee) + '</span>' +
                    '</div>' +
                    '<div class="dist-fee-row">' +
                        '<span>Plataforma (10% de comision)</span>' +
                        '<span style="font-weight: 600;">L. ' + _distFmt(d.fees.platform_fee) + '</span>' +
                    '</div>' +
                    '<div class="dist-fee-row" style="border-top: 1px solid rgba(255,255,255,0.06); padding-top: 8px; margin-top: 4px;">' +
                        '<span>Neto coordinador</span>' +
                        '<span style="font-weight: 600; color: #34d399;">L. ' + _distFmt(d.fees.coordinator_net) + '</span>' +
                    '</div>';
                } else if (isCoordTurn) {
                    html += '<div style="font-size: 0.82rem; color: #94a3b8;">Es turno del coordinador. Solo aplica comision de plataforma: L. ' + _distFmt(d.fees.platform_fee) + '</div>';
                }
                html += '</div>';
            }

            // Distribution section
            html += '<div class="dist-section" style="border-color: rgba(0,255,255,0.15);">' +
                '<div class="dist-section-title" style="color: #00FFFF;">Distribucion</div>' +
                '<div class="dist-beneficiary-card">' +
                    '<div class="dist-beneficiary-avatar">' + escapeHtml((d.distribution.beneficiary_receives.user_name || '?').charAt(0)) + '</div>' +
                    '<div style="flex: 1;">' +
                        '<div style="font-weight: 600; color: #f8fafc;">' +
                            escapeHtml(d.distribution.beneficiary_receives.user_name || 'Beneficiario') +
                            (isCoordTurn ? ' <span style="font-size: 0.7rem; color: #a78bfa;">(Coordinador)</span>' : '') +
                        '</div>' +
                        '<div style="font-size: 0.75rem; color: #94a3b8;">Turno #' + escapeHtml(String(d.distribution.beneficiary_receives.turn_number || '?')) + '</div>' +
                    '</div>' +
                    '<div style="text-align: right;">' +
                        '<div style="font-size: 1.25rem; font-weight: 700; color: #00FFFF;">L. ' + _distFmt(d.distribution.beneficiary_receives.amount) + '</div>' +
                    '</div>' +
                '</div>' +
                '<div class="dist-admin-note">' +
                    '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#34d399" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>' +
                    '<span>Al distribuir, el saldo de tanda del beneficiario se vuelve negativo (prestamo). Los demas miembros acumulan ahorro positivo.</span>' +
                '</div>' +
            '</div>';

            // Status
            if (!d.can_distribute) {
                html += '<div class="dist-status dist-status-warning">' +
                    '<strong>No se puede distribuir</strong><br>' +
                    '<span style="font-size: 0.82rem;">Faltan contribuciones por completar (' + escapeHtml(String(d.collection.total_contributions)) + '/' + escapeHtml(String(d.collection.expected_contributions)) + ')</span>' +
                '</div>';
                footerDiv.style.display = 'none';
            } else {
                html += '<div class="dist-status dist-status-ok">' +
                    'Todas las contribuciones completadas. Listo para distribuir.' +
                '</div>';
                footerDiv.style.display = 'flex';
            }

            contentDiv.innerHTML = html;

        } catch (err) {
            contentDiv.innerHTML =
                '<div style="text-align: center; padding: 40px;">' +
                    '<div style="font-size: 48px; margin-bottom: 16px;">&#10060;</div>' +
                    '<h4 style="margin: 0 0 8px; color: #f87171;">Error al cargar</h4>' +
                    '<p style="color: #64748b; margin: 0;">Error al cargar la vista previa. Intenta de nuevo.</p>' +
                '</div>';
            footerDiv.style.display = 'none';
        }
    }

    window.executeDistribution = async function() {
        if (!currentDistributionData || !currentDistributionData.can_distribute) {
            showWarning('No se puede ejecutar la distribucion');
            return;
        }

        var d = currentDistributionData;
        var isCoordTurn = d.fees.is_coordinator_turn;
        var confirmMsg = 'Confirmas la distribucion del Ciclo ' + d.next_distribution_cycle + '?\n\n';
        if (!isCoordTurn && d.fees.coordinator_net > 0) {
            confirmMsg += 'Coordinador recibe: L. ' + _distFmt(d.distribution.coordinator_receives.net_commission) + '\n';
        }
        confirmMsg += (escapeHtml(d.distribution.beneficiary_receives.user_name) || 'Beneficiario') + ' recibe: L. ' + _distFmt(d.distribution.beneficiary_receives.amount) + '\n\nEsta accion no se puede deshacer.';

        showConfirm(confirmMsg, async function() {
        var btn = document.getElementById('executeDistributionBtn');
        btn.disabled = true;
        btn.textContent = 'Ejecutando...';

        try {
            var apiBase = window.API_BASE_URL || 'https://latanda.online';

            var response = await fetch(apiBase + '/api/groups/' + encodeURIComponent(currentDistributionGroupId) + '/distribution/execute', {
                method: 'POST',
                headers: Object.assign({}, getAuthHeaders(), { 'Content-Type': 'application/json' }),
                body: JSON.stringify({})
            });

            var result = await response.json();

            if (!result.success) {
                throw new Error('Error al ejecutar distribucion');
            }

            // Show success
            var contentDiv = document.getElementById('distributionContent');
            contentDiv.innerHTML =
                '<div style="text-align: center; padding: 40px;">' +
                    '<div style="width: 70px; height: 70px; background: rgba(0,255,255,0.1); border-radius: 50%; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center;">' +
                        '<svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#00FFFF" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>' +
                    '</div>' +
                    '<h4 style="margin: 0 0 8px; color: #f8fafc; font-size: 1.25rem;">Distribucion Exitosa</h4>' +
                    '<p style="margin: 0 0 16px; color: #94a3b8;">Ciclo ' + escapeHtml(String(result.data.cycle_number)) + ' completado</p>' +
                    '<div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 12px; font-size: 0.88rem; text-align: left; border: 1px solid rgba(255,255,255,0.06);">' +
                        '<div style="display: flex; justify-content: space-between; margin-bottom: 8px;">' +
                            '<span style="color: #94a3b8;">Meta del ciclo</span>' +
                            '<span style="color: #f8fafc; font-weight: 600;">L. ' + _distFmt(result.data.target_total) + '</span>' +
                        '</div>' +
                        '<div style="display: flex; justify-content: space-between; margin-bottom: 8px;">' +
                            '<span style="color: #94a3b8;">Recaudado</span>' +
                            '<span style="color: #34d399; font-weight: 600;">L. ' + _distFmt(result.data.total_collected) + '</span>' +
                        '</div>' +
                        '<div style="display: flex; justify-content: space-between; margin-bottom: 8px;">' +
                            '<span style="color: #94a3b8;">Coordinador</span>' +
                            '<span style="color: #f8fafc; font-weight: 600;">L. ' + _distFmt(result.data.coordinator_net) + '</span>' +
                        '</div>' +
                        '<div style="display: flex; justify-content: space-between;">' +
                            '<span style="color: #94a3b8;">Beneficiario</span>' +
                            '<span style="color: #00FFFF; font-weight: 600;">L. ' + _distFmt(result.data.beneficiary_net) + '</span>' +
                        '</div>' +
                    '</div>' +
                    '<p style="margin: 16px 0 0; color: #64748b; font-size: 0.82rem;">Siguiente distribucion: Ciclo ' + escapeHtml(String(result.data.next_distribution_cycle)) + '</p>' +
                '</div>';

            var footerDiv = document.getElementById('distributionFooter');
            footerDiv.innerHTML = '<button data-action="grp-close-distribution" class="dist-btn-execute" style="width: 100%;">Cerrar</button>';

            if (window.showSuccess) window.showSuccess('Distribucion ejecutada exitosamente');

            // Refresh data
            setTimeout(function() {
                if (typeof loadGroupsData === 'function') loadGroupsData();
            }, 2000);

        } catch (err) {
            showError('No se pudo ejecutar la distribucion');
            btn.disabled = false;
            btn.textContent = 'Ejecutar Distribucion';
        }
        }); // end showConfirm
    };

    window.closeDistributionModal = function() {
        var modal = document.getElementById('distributionModal');
        if (modal) {
            modal.style.display = 'none'; modal.classList.remove('active');
            document.body.style.overflow = '';
        }
        currentDistributionGroupId = null;
        currentDistributionData = null;
    };

    // === TANDA BALANCES MODAL ===

    var currentBalancesGroupId = null;

    window.showTandaBalances = async function(groupId) {
        currentBalancesGroupId = groupId;
        closeModal(); // Close manage modal

        setTimeout(async function() {
            var modal = document.getElementById('tandaBalancesModal');
            modal.style.display = 'flex'; modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            await loadTandaBalances(groupId);
        }, 100);
    };

    async function loadTandaBalances(groupId) {
        var contentDiv = document.getElementById('tbContent');
        contentDiv.innerHTML = '<div class="tb-spinner-wrap"><div class="dist-spinner"></div></div>';

        try {
            var apiBase = window.API_BASE_URL || 'https://latanda.online';
            var response = await fetch(apiBase + '/api/groups/' + encodeURIComponent(groupId) + '/tanda-balances', { headers: getAuthHeaders() });
            var result = await response.json();

            if (!result.success) throw new Error('Error');

            var d = result.data;
            document.getElementById('tbGroupName').textContent = escapeHtml(d.group_name);

            var html = '';

            // Summary stats
            html += '<div class="tb-stats">' +
                '<div class="tb-stat"><div class="tb-stat-value">L. ' + _distFmt(d.target_per_cycle) + '</div><div class="tb-stat-label">Meta/ciclo</div></div>' +
                '<div class="tb-stat"><div class="tb-stat-value">' + escapeHtml(String(d.distributions_completed)) + '</div><div class="tb-stat-label">Distribuciones</div></div>' +
                '<div class="tb-stat"><div class="tb-stat-value">' + escapeHtml(String(d.summary.positions_filled)) + '/' + escapeHtml(String(d.summary.positions_total)) + '</div><div class="tb-stat-label">Posiciones</div></div>' +
            '</div>';

            // Members table
            html += '<div class="tb-table-header">' +
                '<span class="tb-col-num">#</span>' +
                '<span class="tb-col-name">Miembro</span>' +
                '<span class="tb-col-amount">Contribuido</span>' +
                '<span class="tb-col-balance">Saldo</span>' +
            '</div>';

            for (var i = 0; i < d.members.length; i++) {
                var m = d.members[i];
                var balanceClass = m.tanda_balance > 0 ? 'tb-balance-positive' : m.tanda_balance < 0 ? 'tb-balance-negative' : 'tb-balance-zero';
                var balancePrefix = m.tanda_balance > 0 ? '+' : '';
                var initial = (m.name || '?').charAt(0).toUpperCase();
                var posLabel = m.num_positions > 1 ? ' <span class="tb-multi-pos">x' + escapeHtml(String(m.num_positions)) + '</span>' : '';

                html += '<div class="tb-member-row">' +
                    '<span class="tb-col-num">' + escapeHtml(String(m.turn_position || '-')) + '</span>' +
                    '<div class="tb-col-name">' +
                        '<div class="tb-member-avatar">' + escapeHtml(initial) + '</div>' +
                        '<div class="tb-member-info">' +
                            '<div class="tb-member-name">' + escapeHtml(m.name || 'Desconocido') + posLabel + '</div>' +
                            (m.has_received ? '<div class="tb-received-tag">Recibio L. ' + _distFmt(m.total_received) + '</div>' : '') +
                        '</div>' +
                    '</div>' +
                    '<span class="tb-col-amount">L. ' + _distFmt(m.total_contributed) + '</span>' +
                    '<span class="tb-col-balance ' + balanceClass + '">' + balancePrefix + _distFmt(m.tanda_balance) + '</span>' +
                '</div>';
            }

            // Empty positions indicator
            var emptyPositions = d.summary.positions_total - d.summary.positions_filled;
            if (emptyPositions > 0) {
                html += '<div class="tb-empty-positions">' +
                    escapeHtml(String(emptyPositions)) + ' posiciones vacias' +
                '</div>';
            }

            // Summary footer
            html += '<div class="tb-summary">' +
                '<div class="tb-summary-row">' +
                    '<span>Total contribuido</span>' +
                    '<span style="color: #34d399; font-weight: 600;">L. ' + _distFmt(d.summary.total_contributed_all) + '</span>' +
                '</div>' +
                '<div class="tb-summary-row">' +
                    '<span>Total distribuido</span>' +
                    '<span style="color: #00FFFF; font-weight: 600;">L. ' + _distFmt(d.summary.total_distributed_all) + '</span>' +
                '</div>' +
                '<div class="tb-admin-note">' +
                    '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>' +
                    '<span>Positivo = ahorro acumulado &middot; Negativo = prestamo pendiente</span>' +
                '</div>' +
            '</div>';

            contentDiv.innerHTML = html;

        } catch (err) {
            contentDiv.innerHTML =
                '<div style="text-align: center; padding: 40px;">' +
                    '<div style="font-size: 48px; margin-bottom: 16px;">&#10060;</div>' +
                    '<h4 style="margin: 0 0 8px; color: #f87171;">Error al cargar saldos</h4>' +
                    '<p style="color: #64748b; margin: 0;">Intenta de nuevo.</p>' +
                '</div>';
        }
    }

    window.closeTandaBalancesModal = function() {
        var modal = document.getElementById('tandaBalancesModal');
        if (modal) {
            modal.style.display = 'none'; modal.classList.remove('active');
            document.body.style.overflow = '';
        }
        currentBalancesGroupId = null;
    };

})();
</script>


<script src="member-management-frontend.js?v=12.1"></script>
<script src="coordinator-panel.js?v=1771545601"></script>
<script src="lottery-functions.js?v=1765255172"></script>
<script src="disputes-frontend.js?v=1.1"></script>
<script src="coordinator-payouts-view.js"></script>

    <!-- START TANDA MODAL -->
    <div id="startTandaModalOverlay" class="start-tanda-modal-overlay" data-action="grp-close-start-tanda-overlay">
        <div class="start-tanda-modal">
            <h2><i class="fas fa-play-circle"></i> Iniciar Tanda</h2>
            
            <div class="start-tanda-summary">
                <div class="summary-row">
                    <span>Grupo:</span>
                    <span id="stm-group-name">-</span>
                </div>
                <div class="summary-row">
                    <span>Participantes:</span>
                    <span id="stm-members">-</span>
                </div>
                <div class="summary-row">
                    <span>Aporte:</span>
                    <span id="stm-amount">-</span>
                </div>
                <div class="summary-row">
                    <span>Duracion:</span>
                    <span id="stm-duration">-</span>
                </div>
            </div>

            <div id="stm-lottery-warning" class="lottery-warning-box" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                    <p><strong>La tombola no ha sido ejecutada.</strong> Se usaran las posiciones actuales de los miembros.</p>
                    <button data-action="grp-execute-lottery"><i class="fas fa-dice"></i> Ejecutar Tombola</button>
                </div>
            </div>

            <div class="turns-preview">
                <h4><i class="fas fa-list-ol"></i> Orden de Turnos</h4>
                <ol id="stm-turns-list" class="turns-list"></ol>
            </div>

            <div class="start-options">
                <button class="btn-start-now" data-action="grp-confirm-start-tanda">
                    <i class="fas fa-play"></i> Iniciar Ahora
                </button>
                <button class="btn-schedule" data-action="grp-toggle-schedule">
                    <i class="fas fa-calendar-alt"></i> Programar
                </button>
            </div>

            <div id="stm-schedule-section" class="schedule-section">
                <input type="datetime-local" id="stm-start-datetime">
                <button data-action="grp-confirm-schedule"><i class="fas fa-check"></i> Confirmar Fecha</button>
            </div>

            <button class="btn-cancel-modal" data-action="grp-close-start-tanda">Cancelar</button>
        </div>
    </div>


    <!-- Calendar Modal System -->
<!-- FASE 4: Calendar Modal System - Added 2025-11-27 -->
<script>
(function() {
    'use strict';
    
    // Add Calendar button to admin modal
    var originalManageGroup = window.manageGroup;
    var calendarButtonAdded = {};
    
    window.manageGroup = function(groupId) {
        originalManageGroup(groupId);
        
        setTimeout(function() {
            var modal = document.getElementById('groupManageModal');
            if (!modal) return;
            
            // Check if calendar button already exists
            if (calendarButtonAdded[groupId]) return;
            
            var exportSection = modal.querySelector('.export-section');
            if (!exportSection) return;
            
            // Create calendar button before export section
            var calendarBtn = document.createElement('button');
            calendarBtn.className = 'admin-option-btn';
            calendarBtn.style.cssText = 'display: flex; align-items: center; gap: 12px; width: 100%; padding: 14px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; cursor: pointer; transition: background 0.2s; margin-bottom: 8px;';
            calendarBtn.innerHTML = '<div style="width: 40px; height: 40px; background: rgba(217,119,6,0.15); border-radius: 10px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-calendar-alt" style="color: #d97706; font-size: 18px;"></i></div><div style="text-align: left;"><div style="font-weight: 500; color: #f8fafc;">Calendario de Pagos</div><div style="font-size: 0.75rem; color: #94a3b8;">Ver proximas fechas y turnos</div></div>';
            
            calendarBtn.onclick = function() {
                showCalendarModal(window.currentManagedGroupId);
            };
            
            // Insert before export section
            exportSection.parentNode.insertBefore(calendarBtn, exportSection);
            calendarButtonAdded[groupId] = true;
            
        }, 100);
    };
    
    window.showCalendarModal = async function(groupId) {
        // Close admin modal first
        closeModal();
        
        // Create or get calendar modal
        var modal = document.getElementById('calendarModal');
        if (!modal) {
            modal = createCalendarModal();
        }
        
        // Show loading state
        document.getElementById('calendarContent').innerHTML = '<div style="text-align: center; padding: 60px;"><div class="spinner" style="width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: #00FFFF; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div><p style="margin-top: 16px; color: #94a3b8;">Cargando calendario...</p></div>';
        
        // Show modal
        modal.style.display = 'flex'; modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // Load calendar data
        try {
            var apiBase = window.API_BASE_URL || 'https://latanda.online';
            var response = await fetch(apiBase + '/api/groups/' + groupId + '/calendar', { headers: getAuthHeaders() });
            var data = await response.json();
            
            if (!data.success) {
                throw new Error(data.data?.error?.message || 'Error al cargar calendario');
            }
            
            document.getElementById('calendarModalTitle').textContent = data.data.group?.name || 'Calendario';
            document.getElementById('calendarContent').innerHTML = renderCalendar(data.data);
            
        } catch (err) {
            document.getElementById('calendarContent').innerHTML = '<div style="padding: 24px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); border-radius: 10px; color: #f87171; text-align: center;"><i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 12px;"></i><p>No se pudo cargar el calendario</p></div>';
        }
    };
    function createCalendarModal() {
        var modal = document.createElement('div');
        modal.id = 'calendarModal';
        modal.className = 'modal-overlay';
        modal.style.cssText = 'display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); justify-content: center; align-items: center; z-index: 10000;';
        modal.innerHTML = '<div style="background: #1e293b; border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; max-width: 600px; width: 90%; max-height: 85vh; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);">' +
            '<div style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border-bottom: 1px solid rgba(0,255,255,0.2); color: #f8fafc; padding: 20px; border-radius: 16px 16px 0 0; position: relative;">' +
            '<div style="display: flex; align-items: center; gap: 12px;">' +
            '<div style="background: rgba(0,255,255,0.15); padding: 10px; border-radius: 12px;"><i class="fas fa-calendar-alt" style="font-size: 24px; color: #00FFFF;"></i></div>' +
            '<div><h3 style="margin: 0; font-size: 1.25rem; font-weight: 600; color: #f8fafc;">Calendario de Pagos</h3><p id="calendarModalTitle" style="margin: 4px 0 0; font-size: 0.875rem; color: #94a3b8;">Grupo</p></div>' +
            '</div>' +
            '<button data-action="grp-close-calendar" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.1); border: none; width: 32px; height: 32px; border-radius: 8px; color: #94a3b8; cursor: pointer; font-size: 16px;" title="Cerrar"><i class="fas fa-times"></i></button>' +
            '</div>' +
            '<div id="calendarContent" class="modal-body" style="padding: 20px; max-height: 60vh; overflow-y: auto;"></div>' +
            '</div>';
        
        modal.onclick = function(e) {
            if (e.target === modal) closeCalendarModal();
        };
        
        document.body.appendChild(modal);
        return modal;
    }
    
    window.closeCalendarModal = function() {
        var modal = document.getElementById('calendarModal');
        if (modal) {
            modal.style.display = 'none'; modal.classList.remove('active');
            document.body.style.overflow = '';
        }
    };
    
    function renderCalendar(data) {
        var schedule = data.schedule || [];
        var group = data.group || {};
        var rules = data.payment_rules || {};
        
        var html = '';
        
        // Group info header
        html += '<div style="background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 16px; margin-bottom: 16px;">' +
            '<div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 12px;">' +
            '<div><span style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;">Frecuencia</span><p style="font-weight: 600; color: #f8fafc; margin: 2px 0 0; text-transform: capitalize;">' + escapeHtml(group.frequency || '-') + '</p></div>' +
            '<div><span style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;">Contribucion</span><p style="font-weight: 600; color: #00FFFF; margin: 2px 0 0;">L. ' + (group.contribution_amount || 0).toLocaleString() + '</p></div>' +
            '<div><span style="font-size: 0.7rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;">Miembros</span><p style="font-weight: 600; color: #f8fafc; margin: 2px 0 0;">' + (data.total_members || 0) + '</p></div>' +
            '</div></div>';
        
        // Payment rules banner
        if (rules.description) {
            html += '<div style="background: rgba(0,255,255,0.08); border: 1px solid rgba(0,255,255,0.2); border-radius: 10px; padding: 12px 14px; margin-bottom: 16px; display: flex; align-items: flex-start; gap: 10px;">' +
                '<span style="color: #00FFFF; font-size: 1.1rem; flex-shrink: 0; margin-top: 1px;">&#8505;</span>' +
                '<div style="font-size: 0.8rem; color: #cbd5e1; line-height: 1.5;">' + escapeHtml(rules.description) + '</div>' +
                '</div>';
        }
        
        // Schedule timeline
        if (schedule.length > 0) {
            html += '<h4 style="font-size: 0.95rem; font-weight: 600; color: #f8fafc; margin: 0 0 14px 0;"><i class="fas fa-clock" style="color: #00FFFF; margin-right: 8px;"></i>Proximos Turnos</h4>';
            html += '<div style="display: flex; flex-direction: column; gap: 10px;">';
            
            schedule.forEach(function(item) {
                var isCurrent = item.status === 'current';
                var isCompleted = item.status === 'completed';
                var borderColor = isCurrent ? '#00FFFF' : isCompleted ? '#22c55e' : 'rgba(255,255,255,0.08)';
                var bgColor = isCurrent ? 'rgba(0,255,255,0.06)' : isCompleted ? 'rgba(34,197,94,0.04)' : 'rgba(255,255,255,0.02)';
                var dateObj = new Date(item.date + 'T12:00:00');
                var formattedDate = dateObj.toLocaleDateString('es-HN', { day: 'numeric', month: 'short', year: 'numeric' });
                
                var deadlineHtml = '';
                if (item.grace_days > 0 && item.deadline_date) {
                    var dlObj = new Date(item.deadline_date + 'T12:00:00');
                    var dlFormatted = dlObj.toLocaleDateString('es-HN', { day: 'numeric', month: 'short' });
                    deadlineHtml = '<p style="font-size: 0.75rem; color: #f59e0b; margin: 3px 0 0;">&#9888; Limite: ' + dlFormatted + ' (' + item.grace_days + ' dias gracia)</p>';
                }
                
                var labelHtml = item.label ? '<span style="display: inline-block; padding: 1px 7px; background: rgba(255,255,255,0.06); border-radius: 4px; font-size: 0.65rem; color: #64748b; margin-top: 4px;">' + escapeHtml(item.label) + '</span>' : '';
                
                html += '<div style="display: flex; gap: 14px; padding: 14px; background: ' + bgColor + '; border: 1px solid ' + borderColor + '; border-radius: 10px;">' +
                    '<div style="min-width: 44px; text-align: center;">' +
                    '<div style="font-size: 1.3rem; font-weight: 700; color: ' + (isCurrent ? '#00FFFF' : isCompleted ? '#22c55e' : '#64748b') + ';">#' + item.position + '</div>' +
                    (isCompleted ? '<span style="font-size: 0.6rem; color: #22c55e;">&#10003;</span>' : '') +
                    '</div>' +
                    '<div style="flex: 1; min-width: 0;">' +
                    '<div style="display: flex; justify-content: space-between; align-items: start; gap: 8px;">' +
                    '<div style="min-width: 0;">' +
                    '<p style="font-weight: 500; color: #f8fafc; margin: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">' + escapeHtml(item.beneficiary?.name || 'Sin asignar') + '</p>' +
                    '<p style="font-size: 0.8rem; color: #94a3b8; margin: 3px 0 0;">&#128197; ' + formattedDate + '</p>' +
                    deadlineHtml +
                    labelHtml +
                    '</div>' +
                    '<div style="text-align: right; flex-shrink: 0;">' +
                    '<p style="font-weight: 600; color: #00FFFF; margin: 0; font-size: 0.95rem;">L. ' + item.amount.toLocaleString() + '</p>' +
                    (isCurrent ? '<span style="display: inline-block; padding: 2px 8px; background: #00FFFF; color: #0f172a; border-radius: 4px; font-size: 0.6rem; font-weight: 600; margin-top: 4px;">ACTUAL</span>' : '') +
                    '</div></div></div></div>';
            });
            
            html += '</div>';
        } else {
            html += '<div style="text-align: center; padding: 40px; color: #64748b;"><i class="fas fa-calendar-times" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px;"></i><p>No hay turnos programados</p></div>';
        }
        
        return html;
    }
    
})();
</script>

    <!-- View Details Modal -->
<script>
(function() {
    'use strict';

    var _vdEsc = typeof escapeHtml === 'function' ? escapeHtml : function(s) {
        return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    };

    // Override viewGroup to show modal popup instead of switching tabs
    window.viewGroup = async function(groupId) {
        var safeId = _vdEsc(String(groupId));

        // Create or get modal
        var modal = document.getElementById('viewDetailsModal');
        if (!modal) {
            modal = createViewDetailsModal();
        }

        // Show loading
        document.getElementById('viewDetailsContent').innerHTML = '<div style="text-align: center; padding: 60px;"><div class="spinner" style="width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: #00FFFF; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div><p style="margin-top: 16px; color: #94a3b8;">Cargando detalles...</p></div>';

        // Show modal
        modal.style.display = 'flex'; modal.classList.add('active');
        document.body.style.overflow = 'hidden';

        try {
            var apiBase = window.API_BASE_URL || 'https://latanda.online';
            var statsResponse = await fetch(apiBase + '/api/groups/' + encodeURIComponent(groupId) + '/stats', { headers: getAuthHeaders() });
            if (!statsResponse.ok) throw new Error('fetch');
            var statsData = await statsResponse.json();

            if (!statsData.success) {
                throw new Error('api');
            }

            document.getElementById('viewDetailsModalTitle').textContent = statsData.data.group?.name || 'Detalles del Grupo';
            document.getElementById('viewDetailsContent').innerHTML = renderGroupDetails(statsData.data, safeId);

        } catch (err) {
            document.getElementById('viewDetailsContent').innerHTML = '<div style="padding: 24px; background: rgba(220,38,38,0.1); border: 1px solid rgba(220,38,38,0.3); border-radius: 8px; color: #fca5a5; text-align: center;"><i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 12px;"></i><p>No se pudieron cargar los detalles del grupo.</p></div>';
        }
    };

    function createViewDetailsModal() {
        var modal = document.createElement('div');
        modal.id = 'viewDetailsModal';
        modal.className = 'modal-overlay';
        modal.style.cssText = 'display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); justify-content: center; align-items: center; z-index: 10000;';
        modal.innerHTML = '<div class="modal-content" style="background: #0f172a; border: 1px solid rgba(0,255,255,0.15); border-radius: 16px; max-width: 700px; width: 95%; max-height: 90vh; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);">' +
            '<div class="modal-header" style="background: linear-gradient(135deg, rgba(0,255,255,0.15) 0%, rgba(0,255,255,0.05) 100%); color: #f8fafc; padding: 20px; border-bottom: 1px solid rgba(0,255,255,0.1); position: relative;">' +
            '<div style="display: flex; align-items: center; gap: 12px;">' +
            '<div style="background: rgba(0,255,255,0.15); padding: 10px; border-radius: 12px;"><i class="fas fa-users" style="font-size: 24px; color: #00FFFF;"></i></div>' +
            '<div><h3 style="margin: 0; font-size: 1.25rem; font-weight: 600; color: #f8fafc;">Detalles del Grupo</h3><p id="viewDetailsModalTitle" style="margin: 4px 0 0; font-size: 0.875rem; color: #94a3b8;">Grupo</p></div>' +
            '</div>' +
            '<button data-action="grp-close-view-details" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.1); border: none; width: 32px; height: 32px; border-radius: 8px; color: #94a3b8; cursor: pointer;"><i class="fas fa-times"></i></button>' +
            '</div>' +
            '<div id="viewDetailsContent" class="modal-body" style="padding: 20px; max-height: 70vh; overflow-y: auto;"></div>' +
            '</div>';

        modal.addEventListener('click', function(e) {
            if (e.target === modal) closeViewDetailsModal();
            var btn = e.target.closest('[data-action]');
            if (!btn) return;
            var action = btn.getAttribute('data-action');
            var gid = btn.getAttribute('data-group-id');
            switch (action) {
                case 'grp-close-view-details':
                    closeViewDetailsModal();
                    break;
                case 'grp-vd-manage':
                    closeViewDetailsModal();
                    if (gid && typeof manageGroup === 'function') manageGroup(gid);
                    break;
                case 'grp-vd-calendar':
                    closeViewDetailsModal();
                    if (gid && typeof showCalendarModal === 'function') showCalendarModal(gid);
                    break;
                case 'grp-vd-tandas':
                    closeViewDetailsModal();
                    if (gid) sessionStorage.setItem('selected_group_id', gid);
                    if (typeof switchTab === 'function') switchTab('tandas');
                    break;
            }
        });

        document.body.appendChild(modal);
        return modal;
    }

    window.closeViewDetailsModal = function() {
        var modal = document.getElementById('viewDetailsModal');
        if (modal) {
            modal.style.display = 'none'; modal.classList.remove('active');
            document.body.style.overflow = '';
        }
    };

    function renderGroupDetails(stats, safeGroupId) {
        var frequencyMap = { 'weekly': 'Semanal', 'biweekly': 'Quincenal', 'monthly': 'Mensual' };
        var group = stats.group || {};
        var members = stats.members || {};
        var payments = stats.payments || {};
        var topContributors = stats.top_contributors || [];

        var html = '';

        // Quick stats row
        html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">';

        html += '<div style="text-align: center; padding: 16px; background: rgba(124,58,237,0.15); border: 1px solid rgba(124,58,237,0.2); border-radius: 12px;">' +
            '<i class="fas fa-users" style="font-size: 24px; color: #a78bfa;"></i>' +
            '<p style="font-size: 1.5rem; font-weight: 700; color: #f8fafc; margin: 8px 0 0;">' + (members.total || 0) + '</p>' +
            '<p style="font-size: 0.75rem; color: #94a3b8; margin: 0;">Miembros</p></div>';

        html += '<div style="text-align: center; padding: 16px; background: rgba(16,185,129,0.15); border: 1px solid rgba(16,185,129,0.2); border-radius: 12px;">' +
            '<i class="fas fa-coins" style="font-size: 24px; color: #34d399;"></i>' +
            '<p style="font-size: 1.5rem; font-weight: 700; color: #f8fafc; margin: 8px 0 0;">L. ' + (payments.total_collected || 0).toLocaleString() + '</p>' +
            '<p style="font-size: 0.75rem; color: #94a3b8; margin: 0;">Recaudado</p></div>';

        html += '<div style="text-align: center; padding: 16px; background: rgba(59,130,246,0.15); border: 1px solid rgba(59,130,246,0.2); border-radius: 12px;">' +
            '<i class="fas fa-check-circle" style="font-size: 24px; color: #60a5fa;"></i>' +
            '<p style="font-size: 1.5rem; font-weight: 700; color: #f8fafc; margin: 8px 0 0;">' + (payments.completed || 0) + '</p>' +
            '<p style="font-size: 0.75rem; color: #94a3b8; margin: 0;">Pagos</p></div>';

        var statusColor = group.status === 'active' ? '#34d399' : '#fbbf24';
        html += '<div style="text-align: center; padding: 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;">' +
            '<i class="fas fa-circle" style="font-size: 24px; color: ' + statusColor + ';"></i>' +
            '<p style="font-size: 1rem; font-weight: 600; color: #f8fafc; margin: 8px 0 0; text-transform: capitalize;">' + _vdEsc(group.status || '-') + '</p>' +
            '<p style="font-size: 0.75rem; color: #94a3b8; margin: 0;">Estado</p></div>';

        html += '</div>';

        // Group info
        html += '<div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 16px; margin-bottom: 20px;">' +
            '<h4 style="font-size: 0.875rem; font-weight: 600; color: #94a3b8; margin: 0 0 12px 0; text-transform: uppercase;">Informacion del Grupo</h4>' +
            '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">' +
            '<div><span style="font-size: 0.75rem; color: #64748b;">Contribucion</span><p style="font-weight: 600; color: #f8fafc; margin: 0;">L. ' + (group.contribution_amount || 0).toLocaleString() + '</p></div>' +
            '<div><span style="font-size: 0.75rem; color: #64748b;">Frecuencia</span><p style="font-weight: 600; color: #f8fafc; margin: 0; text-transform: capitalize;">' + _vdEsc(frequencyMap[group.frequency] || group.frequency || '-') + '</p></div>' +
            '</div></div>';

        // Top contributors
        if (topContributors.length > 0) {
            html += '<div style="margin-bottom: 20px;">' +
                '<h4 style="font-size: 0.875rem; font-weight: 600; color: #94a3b8; margin: 0 0 12px 0; text-transform: uppercase;"><i class="fas fa-trophy" style="color: #fbbf24; margin-right: 6px;"></i>Top Contribuyentes</h4>' +
                '<div style="display: flex; flex-direction: column; gap: 8px;">';

            topContributors.slice(0, 3).forEach(function(c, i) {
                var medal = i === 0 ? '&#x1F947;' : (i === 1 ? '&#x1F948;' : '&#x1F949;');
                html += '<div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;">' +
                    '<div style="display: flex; align-items: center; gap: 10px;">' +
                    '<span style="font-size: 1.25rem;">' + medal + '</span>' +
                    '<span style="font-weight: 500; color: #f8fafc;">' + _vdEsc(c.name || 'Usuario') + '</span></div>' +
                    '<span style="font-weight: 600; color: #00FFFF;">L. ' + (c.total || 0).toLocaleString() + '</span></div>';
            });

            html += '</div></div>';
        }

        // Quick actions — data-action instead of onclick
        html += '<div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 16px;">' +
            '<h4 style="font-size: 0.875rem; font-weight: 600; color: #94a3b8; margin: 0 0 12px 0; text-transform: uppercase;">Acciones Rapidas</h4>' +
            '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">' +
            '<button data-action="grp-vd-manage" data-group-id="' + safeGroupId + '" style="padding: 12px; background: rgba(0,255,255,0.15); border: 1px solid rgba(0,255,255,0.3); color: #00FFFF; border-radius: 8px; cursor: pointer; font-weight: 500;"><i class="fas fa-cog" style="margin-right: 6px;"></i>Administrar</button>' +
            '<button data-action="grp-vd-calendar" data-group-id="' + safeGroupId + '" style="padding: 12px; background: rgba(245,158,11,0.15); border: 1px solid rgba(245,158,11,0.3); color: #fbbf24; border-radius: 8px; cursor: pointer; font-weight: 500;"><i class="fas fa-calendar" style="margin-right: 6px;"></i>Calendario</button>' +
            '<button data-action="grp-vd-tandas" data-group-id="' + safeGroupId + '" style="padding: 12px; background: rgba(16,185,129,0.15); border: 1px solid rgba(16,185,129,0.3); color: #34d399; border-radius: 8px; cursor: pointer; font-weight: 500;"><i class="fas fa-list" style="margin-right: 6px;"></i>Ver Tandas</button>' +
            '</div></div>';

        return html;
    }

})();
</script>

    <script src="payout-frontend.js?v=1.5"></script>

    <!-- Tab Switching (delegated, no inline onclick) -->
    <script>
    (function() {
        'use strict';

        // Delegated click handler for tab switching
        document.addEventListener('click', function(e) {
            var btn = e.target.closest('[data-action="switch-groups-tab"]');
            if (!btn) return;
            var tabName = btn.getAttribute('data-tab');
            if (!tabName) return;

            // Update tab buttons
            document.querySelectorAll('.groups-tab').forEach(function(t) {
                t.classList.remove('active');
                t.setAttribute('aria-selected', 'false');
            });
            btn.classList.add('active');
            btn.setAttribute('aria-selected', 'true');

            // Also update old nav-tab buttons for compatibility with existing JS
            document.querySelectorAll('.nav-tab').forEach(function(t) { t.classList.remove('active'); });
            var oldTab = document.querySelector('.nav-tab[data-tab="' + tabName + '"]');
            if (oldTab) oldTab.classList.add('active');

            // Switch content sections
            document.querySelectorAll('.content-section').forEach(function(s) { s.classList.remove('active'); });
            var section = document.getElementById(tabName);
            if (section) section.classList.add('active');

            // Toggle sidebar cards based on active tab
            var tandasSidebar = document.getElementById('tandasSidebarCards');
            var grpStats = document.getElementById('grpSidebarStats');
            var grpTandaBalance = document.getElementById('grpTandaBalanceCard');
            var grpRoles = document.getElementById('grpSidebarRoles');
            if (tabName === 'tandas') {
                if (tandasSidebar) tandasSidebar.style.display = '';
                if (grpStats) grpStats.style.display = 'none';
                if (grpTandaBalance) grpTandaBalance.style.display = 'none';
                if (grpRoles) grpRoles.style.display = 'none';
                // Always re-fetch tandas data on tab switch for fresh data
                if (typeof refreshTandas === 'function') { refreshTandas().catch(function(){}); }
            } else {
                if (tandasSidebar) tandasSidebar.style.display = 'none';
                if (grpStats) grpStats.style.display = '';
                if (grpRoles) grpRoles.style.display = '';
            }

            // Call original switchTab if it exists (for integration hooks)
            if (typeof window.switchTab === 'function') {
                window._groupsTabSwitching = true;
                try { window.switchTab(tabName); } catch(e) { /* switchTab may not be defined yet during init */ }
                window._groupsTabSwitching = false;
            }
        });

        // Override switchTab to work with new tabs
        var origSwitch = window.switchTab;
        window.switchTab = function(tabName) {
            if (window._groupsTabSwitching) {
                if (origSwitch) origSwitch.call(this, tabName);
                return;
            }
            // Activate sections
            document.querySelectorAll('.content-section').forEach(function(s) { s.classList.remove('active'); });
            var section = document.getElementById(tabName);
            if (section) section.classList.add('active');
            // Update new tab buttons
            document.querySelectorAll('.groups-tab').forEach(function(t) {
                var isActive = t.getAttribute('data-tab') === tabName;
                t.classList.toggle('active', isActive);
                t.setAttribute('aria-selected', isActive ? 'true' : 'false');
            });
            // Call original for hooks
            if (origSwitch) origSwitch.call(this, tabName);
        };
    })();

    // Tandas filter bar — delegated change + debounced search
    (function() {
        document.addEventListener('change', function(e) {
            if (e.target.id === 'tandasStatusFilter' || e.target.id === 'tandasSortOrder') {
                if (typeof filterAndSortTandas === 'function') filterAndSortTandas();
            }
        });
        var _tandasSearchTimeout;
        document.addEventListener('input', function(e) {
            if (e.target.id === 'searchTandas') {
                clearTimeout(_tandasSearchTimeout);
                _tandasSearchTimeout = setTimeout(function() {
                    if (typeof filterAndSortTandas === 'function') filterAndSortTandas();
                }, 300);
            }
        });
    })();
    </script>

    <script src="js/user-sync.js"></script>
    <script src="js/url-param-handler.js?v=3.4"></script>

    <!-- Hub Components -->
    <script src="shared-components.js?v=7.21"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next@23.7.11/i18next.min.js" integrity="sha384-kqrz926ieztN0OKhKR17dS5DPBV82IGrRcqA8/gk9+wzQbGga63usrJmWolShECZ" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-http-backend@2.4.2/i18nextHttpBackend.min.js" integrity="sha384-yxTj8amMhnhYI1a2BiC6D8XPHPBenxjHwY+BnQuhFYuIl32glJcrevL/W0QyUQP3" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-browser-languagedetector@7.2.0/i18nextBrowserLanguageDetector.min.js" integrity="sha384-099MVvR7WaAXsovY5rMvaY+Uq49ZmVhGPTFSyf4wTuyjNEpC/cBjpOJJa0/J97Mk" crossorigin="anonymous"></script>
    <script src="i18next-implementation-backend.js?v=1759688935"></script>
    <script src="real-time-api-integration.js"></script>
    <script src="dashboard-integration-fix.js"></script>
    <script src="js/components/notification-center.js?v=2.7"></script>
    <script src="js/components/network-switcher.js"></script>
    <script src="js/components/transaction-modal.js"></script>
    <script src="js/dashboard-api-connector.js"></script>
    <script src="js/dashboard-sections-loader.js?v=14.1"></script>
    <script src="js/header-footer-cleanup.js"></script>
    <script src="js/components/loading-states.js"></script>
    <script src="js/components-loader.js?v=30.2"></script>
    <script src="js/hub/hub-api-connector.js?v=1.02"></script>
    <script src="js/hub/contextual-alerts.js?v=1.03"></script>
    <script src="js/hub/insights-engine.js?v=1.03"></script>
    <script src="js/hub/module-cards.js?v=1.02"></script>
    <script src="js/hub/mia-assistant.js?v=1.02"></script>
    <script src="js/hub/sidebar-widgets.js?v=1770829609"></script>
    <script src="js/mobile-drawer.js?v=1769469123"></script>
    <script src="js/dashboard-polish.js?v=1.0"></script>
    <script src="js/edge-swipe.js?v=1769558147"></script>
    <script src="js/hub/user-mini-profile.js?v=2.0"></script>

    <script>
    (function() {
        async function updateSidebarHubCards() {
            try {
                var token = localStorage.getItem('auth_token') || localStorage.getItem('authToken');
                if (!token) return;
                var container = document.getElementById('sidebarHubCards');
                if (!container) return;
                // Wallet balance card (non-blocking — Mi Tanda renders even if this fails)
                try {
                    var resp = await fetch('/api/wallet/balance', {
                        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }
                    });
                    if (resp.ok) {
                        var data = await resp.json();
                        if (data.success) {
                            var balance = data.data ? data.data.balance : data.balance || 0;
                            var ltdBalance = data.data ? data.data.ltd_balance : data.ltd_balance || 0;
                            container.innerHTML = '<div class="sidebar-hub-card">' +
                                '<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">' +
                                '<div style="width:40px;height:40px;background:rgba(0,255,255,0.15);border-radius:12px;display:flex;align-items:center;justify-content:center">' +
                                '<i class="fas fa-wallet" style="color:#00FFFF"></i></div>' +
                                '<div><div style="font-weight:600;color:#fff">Mi Wallet</div>' +
                                '<div style="font-size:0.8rem;color:#888">Saldo disponible</div></div></div>' +
                                '<div style="font-size:1.4rem;font-weight:700;color:#00FFFF">L. ' + Number(balance).toFixed(2) + '</div>' +
                                '<div style="font-size:0.85rem;color:#888;margin-top:4px">' + Number(ltdBalance).toFixed(2) + ' LTD</div>' +
                                '</div>';
                        }
                    }
                } catch(ew) { /* wallet balance is non-blocking */ }
                // v4.10.8: Fetch tanda balance for user's active group
                try {
                    var grpResp = await fetch('/api/groups/my-groups-pg', {
                        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }
                    });
                    if (grpResp.ok) {
                        var grpData = await grpResp.json();
                        var allGroups = grpData.data ? (grpData.data.groups || grpData.data || []) : (grpData.groups || grpData || []);
                        var activeGroups = (Array.isArray(allGroups) ? allGroups : []).filter(function(g) { return g.tanda_status === 'active'; });
                        if (activeGroups.length > 0) {
                            var primaryGroup = activeGroups[0];
                            var tbResp = await fetch('/api/groups/' + encodeURIComponent(primaryGroup.group_id) + '/tanda-balances', {
                                headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }
                            });
                            if (tbResp.ok) {
                                var tbData = await tbResp.json();
                                if (tbData.success && tbData.data && tbData.data.members) {
                                    var userId = (function(){ try { var lu = localStorage.getItem('latanda_user'); if(lu){var p=JSON.parse(lu); return String(p.user_id||p.id||'')} } catch(e){} return localStorage.getItem('latanda_user_id')||localStorage.getItem('user_id')||''; })();
                                    var myEntry = tbData.data.members.find(function(m) { return m.user_id === userId; });
                                    if (myEntry) {
                                        var tb = myEntry.tanda_balance;
                                        var tbSign = tb >= 0 ? '+' : '';
                                        var tbColor = tb >= 0 ? '#34d399' : '#f87171';
                                        var tbLabel = tb >= 0 ? 'Ahorro' : 'Prestamo';
                                        container.innerHTML += '<div class="sidebar-hub-card" style="margin-top:10px">' +
                                            '<div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">' +
                                            '<div style="width:40px;height:40px;background:rgba(0,255,255,0.1);border-radius:12px;display:flex;align-items:center;justify-content:center">' +
                                            '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#00FFFF" stroke-width="2"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div>' +
                                            '<div><div style="font-weight:600;color:#fff">Mi Tanda</div>' +
                                            '<div style="font-size:0.78rem;color:#888">' + escapeHtml(tbLabel) + ' &mdash; ' + escapeHtml(primaryGroup.name || '') + '</div></div></div>' +
                                            '<div style="font-size:1.3rem;font-weight:700;color:' + tbColor + '">' + (tb < 0 ? '-' : '+') + 'L. ' + Math.abs(tb).toLocaleString('es-HN', {minimumFractionDigits:2, maximumFractionDigits:2}) + '</div>' +
                                            '<div style="display:flex;align-items:center;gap:12px;margin-top:8px;font-size:0.78rem;color:#64748b">' +
                                            '<span style="display:inline-flex;align-items:center;gap:4px"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#00FFFF" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l2 2"/></svg> Turno #' + escapeHtml(String(myEntry.turn_position || '--')) + '</span>' +
                                            '<span style="display:inline-flex;align-items:center;gap:4px"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg> ' + escapeHtml(String(myEntry.payments_count || 0)) + ' pagos</span>' +
                                            '</div>' +
                                            '</div>';
                                    }
                                }
                            }
                        }
                    }
                } catch(e2) { /* tanda balance fetch is non-blocking */ }
            } catch(e) { /* sidebar hub cards fetch is non-blocking */ }
        }
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', updateSidebarHubCards);
        } else { updateSidebarHubCards(); }
        window.addEventListener('focus', function() { setTimeout(updateSidebarHubCards, 1000); });
    })();
    </script>

    <script src="js/hub/contextual-widgets.js?v=1770829609"></script>
    <script src="js/onboarding/onboarding-system.js?v=1.2"></script>
    <script src="pwa-manager.js"></script>

    <script>
    document.addEventListener('error', function(e) {
        if (e.target.tagName === 'IMG' && e.target.classList.contains('logo-fallback')) {
            e.target.style.display = 'none';
            var icon = document.createElement('i');
            icon.className = 'fas fa-coins';
            icon.style.color = '#00FFFF';
            e.target.parentElement.appendChild(icon);
        }
    }, true);
    </script>

    <!-- Delegated click handler for groups page (replaces inline onclick) -->
    <script>
    (function() {
        'use strict';
        document.addEventListener('click', function(e) {
            var btn = e.target.closest('[data-action]');
            if (!btn) return;
            var action = btn.getAttribute('data-action');

            switch(action) {
                // Group card actions
                case 'grp-view-group':
                    var gid = btn.getAttribute('data-group-id');
                    if (gid && typeof viewGroup === 'function') viewGroup(gid);
                    break;
                case 'grp-manage-group':
                    var gid2 = btn.getAttribute('data-group-id');
                    if (gid2 && typeof manageGroup === 'function') manageGroup(gid2);
                    break;

                case 'grp-request-extension':
                    var extGid = btn.getAttribute('data-group-id');
                    if (extGid && typeof showExtensionRequestModal === 'function') showExtensionRequestModal(extGid);
                    break;
                case 'grp-manage-members':
                    if (typeof openMemberManagementSafe === 'function') openMemberManagementSafe(btn);
                    break;

                // Filter & Retry
                case 'grp-reset-filters':
                    if (typeof resetFilters === 'function') resetFilters();
                    break;
                case 'grp-retry-load':
                    if (typeof fetchMyGroups === 'function') fetchMyGroups();
                    break;

                // Reject modal
                case 'grp-close-reject':
                    if (typeof closeRejectModal === 'function') closeRejectModal();
                    break;
                case 'grp-confirm-reject':
                    if (typeof confirmReject === 'function') confirmReject();
                    break;

                // Manual assign modal
                case 'grp-close-manual-assign':
                    if (typeof closeManualAssignModal === 'function') closeManualAssignModal();
                    break;
                case 'grp-confirm-manual-assign':
                    if (typeof confirmManualAssign === 'function') confirmManualAssign();
                    break;

                // History
                case 'grp-open-history':
                    if (typeof openHistoryModal === 'function') openHistoryModal();
                    break;
                case 'grp-switch-history-tab':
                    var htab = btn.getAttribute('data-htab');
                    if (htab && typeof switchHistoryTab === 'function') switchHistoryTab(htab);
                    break;

                // Payment
                case 'grp-pay-next':
                    if (typeof payNextDue === 'function') payNextDue();
                    break;

                // Tandas
                case 'grp-refresh-tandas':
                    if (window.advancedGroupsSystem) advancedGroupsSystem.refreshTandas();
                    break;
                case 'grp-clear-tanda-filters':
                    var sf = document.getElementById('tandasStatusFilter');
                    var so = document.getElementById('tandasSortOrder');
                    var si = document.getElementById('searchTandas');
                    if (sf) sf.value = 'all';
                    if (so) so.value = 'next-payment';
                    if (si) si.value = '';
                    if (typeof filterAndSortTandas === 'function') filterAndSortTandas();
                    break;
                case 'grp-show-tanda-history':
                    if (window.advancedGroupsSystem) advancedGroupsSystem.showTandaHistory();
                    break;

                // Edit group modal
                case 'grp-close-edit':
                    if (typeof closeEditGroupModal === 'function') closeEditGroupModal();
                    break;

                // Delete group modal
                case 'grp-close-delete':
                    if (typeof closeDeleteGroupModal === 'function') closeDeleteGroupModal();
                    break;
                case 'grp-confirm-delete':
                    if (typeof executeDeleteGroup === 'function') executeDeleteGroup();
                    break;

                // Manage turns modal
                case 'grp-close-manage-turns':
                    if (typeof closeManageTurnsModal === 'function') closeManageTurnsModal();
                    break;
                case 'grp-save-turns':
                    if (typeof saveTurnsOrder === 'function') saveTurnsOrder();
                    break;

                // Register payment modal
                case 'grp-close-register-payment':
                    if (typeof closeRegisterPaymentModal === 'function') closeRegisterPaymentModal();
                    break;
                case 'grp-payment-next':
                    if (typeof paymentNextStep === 'function') paymentNextStep();
                    break;
                case 'grp-payment-prev':
                    if (typeof paymentPrevStep === 'function') paymentPrevStep();
                    break;
                case 'grp-copy-reference':
                    if (typeof copyReferenceCode === 'function') copyReferenceCode();
                    break;
                case 'grp-select-payment-method':
                    var method = btn.getAttribute('data-method');
                    if (method && typeof selectPaymentMethod === 'function') selectPaymentMethod(method);
                    break;
                case 'grp-upload-proof':
                    var input = document.getElementById('proofFileInput');
                    if (input) input.click();
                    break;

                // Templates
                case 'grp-select-template':
                    var tmpl = btn.getAttribute('data-template');
                    if (tmpl && typeof selectGroupTemplate === 'function') selectGroupTemplate(tmpl);
                    break;

                // Tab switching
                case 'grp-switch-tab':
                    var tab = btn.getAttribute('data-tab');
                    if (tab && typeof switchTab === 'function') switchTab(tab);
                    break;

                // Collapsible sections
                case 'grp-toggle-collapsible':
                    if (typeof toggleCollapsible === 'function') toggleCollapsible(btn);
                    break;

                // Start tanda modal
                case 'grp-close-start-tanda':
                    if (typeof closeStartTandaModal === 'function') closeStartTandaModal();
                    break;
                case 'grp-close-start-tanda-overlay':
                    if (e.target === btn && typeof closeStartTandaModal === 'function') closeStartTandaModal();
                    break;
                case 'grp-confirm-start-tanda':
                    if (typeof confirmStartTandaNow === 'function') confirmStartTandaNow();
                    break;
                case 'grp-execute-lottery':
                    if (typeof executeLotteryFromModal === 'function') executeLotteryFromModal();
                    break;
                case 'grp-toggle-schedule':
                    if (typeof toggleScheduleSection === 'function') toggleScheduleSection();
                    break;
                case 'grp-confirm-schedule':
                    if (typeof confirmScheduleTandaStart === 'function') confirmScheduleTandaStart();
                    break;

                // Lottery
                case 'grp-close-lottery':
                    if (typeof closeLotteryAnimation === 'function') closeLotteryAnimation();
                    break;

                // Modal
                case 'grp-hide-modal':
                    if (window.advancedGroupsSystem) advancedGroupsSystem.hideModal();
                    break;
                case 'modal-process-payment':
                    if (typeof processModalPayment === 'function') processModalPayment();
                    break;
                case 'modal-submit-feedback':
                    if (window.advancedGroupsSystem && typeof advancedGroupsSystem.submitFeedback === 'function') advancedGroupsSystem.submitFeedback();
                    break;

                // Members modal
                case 'grp-close-members':
                    if (typeof closeMembersModal === 'function') closeMembersModal();
                    break;

                // Leave group modal
                case 'grp-close-leave-confirm':
                    if (typeof closeLeaveConfirmModal === 'function') closeLeaveConfirmModal();
                    break;
                case 'grp-execute-leave':
                    if (typeof executeLeaveGroup === 'function') executeLeaveGroup();
                    break;

                // Request role modal
                case 'grp-close-request-role':
                    if (typeof closeRequestRoleModal === 'function') closeRequestRoleModal();
                    break;
                case 'grp-submit-role-request':
                    if (typeof submitRoleRequest === 'function') submitRoleRequest();
                    break;

                // Transfer ownership modal
                case 'grp-close-transfer-ownership':
                    if (typeof closeTransferOwnershipModal === 'function') closeTransferOwnershipModal();
                    break;
                case 'grp-execute-transfer':
                    if (typeof executeTransferOwnership === 'function') executeTransferOwnership();
                    break;

                // Payments modal
                case 'grp-close-payments':
                    if (typeof closePaymentsModal === 'function') closePaymentsModal();
                    break;
                case 'ph-tab-resumen':
                    if (typeof phSwitchTab === 'function') phSwitchTab('resumen');
                    break;
                case 'ph-tab-historial':
                    if (typeof phSwitchTab === 'function') phSwitchTab('historial');
                    break;

                // Sidebar quick actions
                case 'gs-view-invitations':
                    window.location.href = '/notificaciones.html';
                    break;

                // Invite modal
                case 'grp-close-invite':
                    if (typeof closeInviteModal === 'function') closeInviteModal();
                    break;
                case 'grp-copy-invite-link':
                    if (typeof copyInviteLink === 'function') copyInviteLink();
                    break;
                case 'grp-share-whatsapp':
                    if (typeof shareViaWhatsApp === 'function') shareViaWhatsApp();
                    break;
                case 'grp-share-email':
                    if (typeof shareViaEmail === 'function') shareViaEmail();
                    break;
                case 'grp-reset-invite':
                    if (typeof resetInviteForm === 'function') resetInviteForm();
                    break;
                case 'grp-clear-selected-user':
                    if (typeof clearSelectedUser === 'function') clearSelectedUser();
                    break;

                // Verify payments modal
                case 'grp-close-verify-payments':
                    if (typeof closeVerifyPaymentsModal === 'function') closeVerifyPaymentsModal();
                    break;

                // Distribution modal
                case 'grp-close-balances':
                    if (typeof closeTandaBalancesModal === 'function') closeTandaBalancesModal();
                    break;

                case 'grp-close-distribution':
                    if (typeof closeDistributionModal === 'function') closeDistributionModal();
                    break;
                case 'grp-execute-distribution':
                    if (typeof executeDistribution === 'function') executeDistribution();
                    break;

                // Calendar modal
                case 'grp-close-calendar':
                    if (typeof closeCalendarModal === 'function') closeCalendarModal();
                    break;

                // Position management (Phase 1)
                case 'grp-auto-assign-random':
                    var aarGid = btn.getAttribute('data-group-id');
                    if (aarGid && typeof autoAssignPositions === 'function') autoAssignPositions(aarGid, 'random');
                    break;
                case 'grp-auto-assign-order':
                    var aaoGid = btn.getAttribute('data-group-id');
                    if (aaoGid && typeof autoAssignPositions === 'function') autoAssignPositions(aaoGid, 'order');
                    break;
                case 'grp-activate-tanda':
                    var atGid = btn.getAttribute('data-group-id');
                    if (atGid && typeof activateTanda === 'function') activateTanda(atGid);
                    break;
                case 'grp-approve-position':
                    var apGid = btn.getAttribute('data-group-id');
                    var apRid = btn.getAttribute('data-request-id');
                    if (apGid && apRid && typeof approvePositionRequest === 'function') approvePositionRequest(apGid, apRid);
                    break;
                case 'grp-reject-position':
                    var rpGid = btn.getAttribute('data-group-id');
                    var rpRid = btn.getAttribute('data-request-id');
                    if (rpGid && rpRid && typeof openRejectModal === 'function') openRejectModal(rpGid, rpRid);
                    break;
                case 'grp-open-manual-assign':
                    var omaGid = btn.getAttribute('data-group-id');
                    var omaPos = btn.getAttribute('data-position');
                    if (omaGid && omaPos && typeof openManualAssignModal === 'function') openManualAssignModal(omaGid, parseInt(omaPos));
                    break;
                case 'grp-quick-pay':
                    var qpTid = btn.getAttribute('data-tanda-id');
                    if (qpTid && typeof quickPay === 'function') quickPay(qpTid);
                    break;

                // Tanda card actions (Phase 1)
                case 'grp-start-tanda':
                    var stTid = btn.getAttribute('data-tanda-id');
                    if (stTid && typeof startTanda === 'function') startTanda(stTid);
                    break;
                case 'grp-invite-to-tanda':
                    var itTid = btn.getAttribute('data-tanda-id');
                    if (itTid && typeof inviteToTanda === 'function') inviteToTanda(itTid);
                    break;
                case 'grp-view-tanda-details':
                    var vtTid = btn.getAttribute('data-tanda-id');
                    if (vtTid && typeof viewTandaDetails === 'function') viewTandaDetails(vtTid);
                    break;
                case 'grp-make-tanda-payment':
                    var mtTid = btn.getAttribute('data-tanda-id');
                    if (mtTid && typeof makeTandaPayment === 'function') makeTandaPayment(mtTid);
                    break;

                // Toast close (Phase 1)
                case 'grp-toast-close':
                    var toast = btn.closest('.toast-notification');
                    if (toast) { toast.classList.add('removing'); setTimeout(function() { toast.remove(); }, 300); }
                    break;

                // Confirm dialog (Phase 1)
                case 'grp-confirm-cancel':
                    var cOverlay = btn.closest('.modal-overlay');
                    if (cOverlay) cOverlay.remove();
                    if (typeof confirmCancel === 'function') confirmCancel();
                    break;
                case 'grp-confirm-action':
                    var aOverlay = btn.closest('.modal-overlay');
                    if (aOverlay) aOverlay.remove();
                    if (typeof confirmAction === 'function') confirmAction();
                    break;

                // Member management (Phase 1)
                case 'grp-toggle-anonymous':
                    var taGid = btn.getAttribute('data-group-id');
                    var taUid = btn.getAttribute('data-user-id');
                    var taVal = btn.getAttribute('data-value') === 'true';
                    if (taGid && taUid && typeof toggleMemberAnonymous === 'function') toggleMemberAnonymous(taGid, taUid, taVal);
                    break;
                case 'grp-request-role':
                    var rrGid = btn.getAttribute('data-group-id');
                    var rrRole = btn.getAttribute('data-current-role');
                    if (rrGid && typeof showRequestRoleModal === 'function') showRequestRoleModal(rrGid, rrRole);
                    break;
                case 'grp-transfer-ownership':
                    var toGid = btn.getAttribute('data-group-id');
                    if (toGid && typeof showTransferOwnershipModal === 'function') showTransferOwnershipModal(toGid);
                    break;
                case 'grp-leave-group':
                    var lgGid = btn.getAttribute('data-group-id');
                    if (lgGid && typeof confirmLeaveGroup === 'function') confirmLeaveGroup(lgGid);
                    break;
                case 'grp-remove-member':
                    var rmGid = btn.getAttribute('data-group-id');
                    var rmUid = btn.getAttribute('data-user-id');
                    var rmName = btn.getAttribute('data-user-name') || 'Usuario';
                    if (rmGid && rmUid && typeof confirmRemoveMember === 'function') confirmRemoveMember(rmGid, rmUid, rmName);
                    break;

                // Invitation actions (Phase 1)
                case 'grp-send-reminder':
                    var srGid = btn.getAttribute('data-group-id');
                    var srIid = btn.getAttribute('data-invitation-id');
                    var srName = btn.getAttribute('data-invitee-name') || '';
                    if (srGid && srIid && typeof sendInvitationReminder === 'function') sendInvitationReminder(srGid, srIid, srName);
                    break;
                case 'grp-delete-invitation':
                    var diGid = btn.getAttribute('data-group-id');
                    var diIid = btn.getAttribute('data-invitation-id');
                    var diName = btn.getAttribute('data-invitee-name') || '';
                    if (diGid && diIid && typeof deleteInvitation === 'function') deleteInvitation(diGid, diIid, diName);
                    break;

                // User search result select (Phase 1)
                case 'grp-select-invite-user':
                    var siUid = btn.getAttribute('data-user-id');
                    var siName = btn.getAttribute('data-user-name') || '';
                    var siEmail = btn.getAttribute('data-user-email') || '';
                    if (siUid && typeof selectUserToInvite === 'function') selectUserToInvite(siUid, siName, siEmail);
                    break;

                // Edit group retry (Phase 1)
                case 'grp-retry-edit-load':
                    if (typeof currentEditGroupId !== 'undefined' && typeof showEditGroupModal === 'function') showEditGroupModal(currentEditGroupId);
                    break;

                // Lottery in turn management (Phase 1)
                case 'grp-start-lottery-countdown':
                    if (typeof startLotteryCountdown === 'function') startLotteryCountdown();
                    break;
                case 'grp-open-schedule-lottery':
                    if (typeof openScheduleLotteryModal === 'function') openScheduleLotteryModal();
                    break;

                // Turn management buttons (Phase 1)
                case 'grp-toggle-lock':
                    var tlIdx = parseInt(btn.getAttribute('data-index'));
                    if (!isNaN(tlIdx) && typeof toggleExpandedLock === 'function') toggleExpandedLock(tlIdx);
                    break;
                case 'grp-remove-position':
                    var rpUid2 = btn.getAttribute('data-user-id');
                    var rpSlot = parseInt(btn.getAttribute('data-slot'));
                    if (rpUid2 && !isNaN(rpSlot) && typeof removeExpandedPosition === 'function') removeExpandedPosition(rpUid2, rpSlot);
                    break;
                case 'grp-add-position':
                    var apUid2 = btn.getAttribute('data-user-id');
                    if (apUid2 && typeof addExpandedPosition === 'function') addExpandedPosition(apUid2);
                    break;
                case 'grp-move-up':
                    var muIdx = parseInt(btn.getAttribute('data-index'));
                    if (!isNaN(muIdx) && typeof moveExpandedUp === 'function') moveExpandedUp(muIdx);
                    break;
                case 'grp-move-down':
                    var mdIdx = parseInt(btn.getAttribute('data-index'));
                    if (!isNaN(mdIdx) && typeof moveExpandedDown === 'function') moveExpandedDown(mdIdx);
                    break;
                case 'grp-remove-from-turns':
                    var rftUid = btn.getAttribute('data-user-id');
                    if (rftUid && typeof removeMemberFromTurns === 'function') removeMemberFromTurns(rftUid);
                    break;

                // Schedule lottery modal (Phase 1)
                case 'grp-close-schedule-lottery':
                    if (typeof closeScheduleLotteryModal === 'function') closeScheduleLotteryModal();
                    break;
                case 'grp-submit-schedule-lottery':
                    if (typeof submitScheduleLottery === 'function') submitScheduleLottery();
                    break;
            }
        });
    })();
    </script>

    <!-- ============================================
         MOBILE DRAWER + BOTTOM NAV
         ============================================ -->
    <div class="mobile-drawer-overlay" id="mobileDrawerOverlay" data-action="drawer-close"></div>
    <aside class="mobile-drawer" id="mobileDrawer">
        <div class="mobile-drawer-header">
            <div class="mobile-drawer-brand">
                <div class="mobile-drawer-logo">
                    <img loading="lazy" src="images/latanda-icon.png" alt="La Tanda" class="logo-fallback">
                </div>
                <span class="mobile-drawer-title">La Tanda</span>
            </div>
            <button class="mobile-drawer-close" data-action="drawer-close"><i class="fas fa-times"></i></button>
        </div>
        <div class="mobile-drawer-user" id="mobileDrawerUser">
            <div class="mobile-drawer-avatar" id="mobileDrawerAvatar"><i class="fas fa-ellipsis-h"></i></div>
            <div class="mobile-drawer-user-info">
                <div class="mobile-drawer-user-name" id="mobileDrawerUserName">Usuario</div>
                <div class="mobile-drawer-user-handle" id="mobileDrawerUserHandle">@usuario</div>
            </div>
        </div>
        <div class="mobile-drawer-stats">
            <div class="mobile-drawer-stat">
                <span class="mobile-drawer-stat-value" id="mobileDrawerFollowing">0</span>
                <span class="mobile-drawer-stat-label">Siguiendo</span>
            </div>
            <div class="mobile-drawer-stat">
                <span class="mobile-drawer-stat-value" id="mobileDrawerFollowers">0</span>
                <span class="mobile-drawer-stat-label">Seguidores</span>
            </div>
        </div>
        <nav class="mobile-drawer-nav">
            <a href="mi-perfil.html" class="mobile-drawer-item"><i class="fas fa-user"></i><span>Perfil</span></a>
            <a href="my-wallet.html" class="mobile-drawer-item"><i class="fas fa-wallet"></i><span>Wallet</span></a>
            <a href="/groups-advanced-system.html" class="mobile-drawer-item"><i class="fas fa-users"></i><span>Mis Tandas</span></a>
            <a href="/marketplace-social.html" class="mobile-drawer-item"><i class="fas fa-store"></i><span>Mercado</span></a>
            <a href="/mensajes.html" class="mobile-drawer-item"><i class="fas fa-envelope"></i><span>Mensajes</span></a>
            <div class="mobile-drawer-divider"></div>
            <div class="mobile-drawer-section-label">Herramientas</div>
            <a href="/mia.html" class="mobile-drawer-item"><i class="fas fa-robot" style="color:#00FFFF;"></i><span>MIA Assistant</span></a>
            <a href="/lottery-predictor.html" class="mobile-drawer-item"><i class="fas fa-ticket-alt"></i><span>Loteria</span></a>
            <div class="mobile-drawer-divider"></div>
            <a href="/configuracion.html" class="mobile-drawer-item"><i class="fas fa-cog"></i><span>Configuracion</span></a>
        </nav>
        <div class="mobile-drawer-divider"></div>
        <div class="mobile-drawer-section-label">Tu Resumen</div>
        <div class="mobile-drawer-quick-stats" id="mobileDrawerQuickStats">
            <div class="drawer-stat-card">
                <div class="drawer-stat-icon" style="background:linear-gradient(135deg,#00FFFF,#00E5E5);"><i class="fas fa-wallet"></i></div>
                <div class="drawer-stat-info">
                    <div class="drawer-stat-label">Balance</div>
                    <div class="drawer-stat-value" id="drawerBalance">0.00 LTD</div>
                </div>
            </div>
            <div class="drawer-stat-card">
                <div class="drawer-stat-icon" style="background:linear-gradient(135deg,#22d55e,#16a34a);"><i class="fas fa-users"></i></div>
                <div class="drawer-stat-info">
                    <div class="drawer-stat-label">Tandas Activas</div>
                    <div class="drawer-stat-value" id="drawerTandas">0</div>
                </div>
            </div>
            <div class="drawer-stat-card">
                <div class="drawer-stat-icon" style="background:linear-gradient(135deg,#fbbf24,#f59e0b);"><i class="fas fa-store"></i></div>
                <div class="drawer-stat-info">
                    <div class="drawer-stat-label">Productos</div>
                    <div class="drawer-stat-value" id="drawerProducts">0</div>
                </div>
            </div>
            <div class="drawer-stat-card">
                <div class="drawer-stat-icon" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);"><i class="fas fa-chart-line"></i></div>
                <div class="drawer-stat-info">
                    <div class="drawer-stat-label">Tu Progreso</div>
                    <div class="drawer-stat-value" id="drawerProgress">0%</div>
                </div>
            </div>
        </div>
        <div class="mobile-drawer-footer">
            <button class="mobile-drawer-logout" data-action="drawer-logout"><i class="fas fa-sign-out-alt"></i><span>Cerrar Sesion</span></button>
        </div>
    </aside>

    <nav class="mobile-bottom-nav" id="mobileBottomNav" role="navigation" aria-label="Navegacion principal">
        <button class="mobile-nav-item" data-action="toggle-left-drawer" aria-label="Abrir menu">
            <i class="fas fa-bars"></i><span>Menu</span>
        </button>
        <a href="/home-dashboard.html" class="mobile-nav-item">
            <i class="fas fa-home"></i><span>Inicio</span>
        </a>
        <a href="/groups-advanced-system.html" class="mobile-nav-item active">
            <i class="fas fa-users"></i><span>Tandas</span>
        </a>
        <button class="mobile-nav-item" data-action="toggle-right-drawer" aria-label="Abrir sidebar">
            <i class="fas fa-th-large"></i><span>Widgets</span>
        </button>
    </nav>

    <script>
    (function() {
        document.addEventListener('click', function(e) {
            var btn = e.target.closest('[data-action]');
            if (!btn) return;
            var action = btn.getAttribute('data-action');
            switch(action) {
                case 'toggle-left-drawer':
                    if (window.EdgeSwipe) EdgeSwipe.toggleLeft();
                    else if (window.MobileDrawer) MobileDrawer.toggle();
                    break;
                case 'toggle-right-drawer':
                    if (window.EdgeSwipe) EdgeSwipe.toggleRight();
                    break;
                case 'drawer-close':
                    if (window.MobileDrawer) MobileDrawer.close();
                    if (window.EdgeSwipe) { EdgeSwipe.closeLeft(); EdgeSwipe.closeRight(); }
                    break;
                case 'drawer-logout':
                    if (window.MobileDrawer) MobileDrawer.logout();
                    break;
            }
        });
    })();
    </script>

</body>
</html>
