<!-- RESTORED FROM DEC12 BACKUP - 20251214-100755 -->
<!-- FASE 3 COMPLETA - Pr00f3ximo Pago CORREGIDO - 18:56:53 -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="groups.title">Sistema de Grupos & Tandas Avanzado - La Tanda Web3</title>
                <meta name="description" content="Sistema completo de gestión de grupos cooperativos y tandas con funcionalidades avanzadas integrado con La Tanda Web3">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha384-iw3OoTErCYJJB9mCa8LNS2hbsQ7M3C0EpIsO/H5+EGAkPGc6rk+V8i04oW/K5xq0" crossorigin="anonymous">
    <!-- Web3 Crypto Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&family=Exo+2:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="groups-advanced-system-v3.css">
    <!-- Translation System Styles -->
    <link rel="stylesheet" href="translation-styles.css">
    <!-- Shared Components Integration -->
    <link rel="stylesheet" href="shared-components.css">
    <link rel="stylesheet" href="notification-system.css">
    <link rel="stylesheet" href="loading-styles.css">
    <!-- PWA Service Worker -->
    <!-- Live Preview Card Styles (v1.2.0) -->
    <link rel="stylesheet" href="live-preview-card.css">
    <!-- Global i18n Translation System -->
    <!-- Smart Suggestions System (v1.3.0) -->
    <link rel="stylesheet" href="smart-suggestions.css">
    <script src="global-i18n-manager.js"></script>
    <!-- Group Duplication System (v1.4.0) -->
    <link rel="stylesheet" href="group-duplication.css">

    <script src="sw-register.js" defer></script>

    <style>
        /* Hide Connect Wallet button, language selector, and back button in groups-advanced-system only */
        #walletSection,
        .wallet-connect-btn,
        .language-selector,
        #languageSelector {
            display: none !important;
        }

        /* Hide page-specific back button */
        .page-title-section .back-button {
            display: none !important;
        }

        /* ===== TEMPLATE SELECTOR MODAL STYLES ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .template-selector-modal {
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 24px;
            max-width: 1100px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-overlay.active .template-selector-modal {
            transform: scale(1);
        }

        .modal-header-templates {
            padding: 2rem;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            position: relative;
        }

        .modal-header-templates h3 {
            font-size: 1.875rem;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .modal-header-templates p {
            color: var(--text-secondary);
            font-size: 1rem;
            line-height: 1.6;
        }

        .modal-close-templates {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close-templates:hover {
            background: rgba(239, 68, 68, 0.2);
            transform: scale(1.1);
        }

        .modal-body-templates {
            padding: 2rem;
            max-height: 60vh;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        .template-card {
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(148, 163, 184, 0.15);
            border-radius: 16px;
            padding: 1.75rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .template-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.05) 0%, rgba(0, 212, 255, 0.05) 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .template-card:hover {
            border-color: var(--tanda-cyan);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
            transform: translateY(-8px);
        }

        .template-card:hover::before {
            opacity: 1;
        }

        .template-icon {
            font-size: 3.5rem;
            margin-bottom: 1.25rem;
            position: relative;
            z-index: 1;
        }

        .template-card h4 {
            font-size: 1.35rem;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            font-weight: 700;
            position: relative;
            z-index: 1;
        }

        .template-card p {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 1.25rem;
            line-height: 1.5;
            position: relative;
            z-index: 1;
        }

        .template-specs {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
            position: relative;
            z-index: 1;
        }

        .template-specs span {
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid var(--border-accent);
            padding: 0.4rem 0.9rem;
            border-radius: 9px;
            font-size: 0.875rem;
            color: var(--tanda-cyan);
            font-weight: 600;
            white-space: nowrap;
        }

        .select-template-btn {
            width: 100%;
            padding: 0.875rem;
            background: linear-gradient(135deg, var(--tanda-cyan) 0%, #00d4ff 100%);
            color: #0f172a;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 1;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .select-template-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(0, 255, 255, 0.4);
        }

        .template-card.custom-template {
            border: 2px dashed var(--border-accent);
            background: rgba(15, 23, 42, 0.3);
        }

        .template-card.custom-template:hover {
            border-color: var(--tanda-cyan);
            border-style: solid;
        }

        .template-card.selected {
            border-color: var(--tanda-cyan);
            background: rgba(0, 255, 255, 0.1);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
        }

        @media (max-width: 768px) {
            .template-grid {
                grid-template-columns: 1fr;
            }

            .modal-header-templates {
                padding: 1.5rem;
            }

            .modal-body-templates {
                padding: 1.5rem;
            }

            .template-card {
                padding: 1.5rem;
            }
        }
        /* ===== END TEMPLATE SELECTOR MODAL STYLES ===== */

        /* ===== MULTI-STEP FORM STYLES ===== */
        .step-container {
            display: none;
        }
        .step-container.active {
            display: block;
        }
        /* ===== END MULTI-STEP FORM STYLES ===== */

        /* ===== TANDAS DASHBOARD STYLES ===== */
        .tandas-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .dashboard-card {
            background: var(--bg-card);
            border: 1px solid var(--border-accent);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            position: relative;
            transition: all 0.3s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .dashboard-card.clickable { cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .dashboard-card.clickable:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .dashboard-card.urgent {
            border-left: 4px solid #ef4444;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), transparent);
        }

        .dashboard-card.warning {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), transparent);
        }

        .dashboard-card.ok {
            border-left: 4px solid #10b981;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), transparent);
        }
        .dashboard-card.recruiting {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), transparent);
        }
        .dashboard-card.recruiting .card-icon { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .dashboard-card.highlight { box-shadow: 0 0 0 2px #10b981, 0 4px 20px rgba(16, 185, 129, 0.3); }
        .summary-progress-bar { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin-top: 8px; overflow: hidden; }
        .summary-progress-fill { height: 100%; background: linear-gradient(90deg, #10b981, #0ea5e9); border-radius: 3px; transition: width 0.5s ease; }

        .dashboard-card.success {
            border-left: 4px solid #10b981;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), transparent);
        }

        .dashboard-card.info {
            border-left: 4px solid var(--tanda-cyan);
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.1), transparent);
        }

        .dashboard-card .card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .dashboard-card.urgent .card-icon { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .dashboard-card.warning .card-icon { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .dashboard-card.ok .card-icon { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .dashboard-card.success .card-icon { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .dashboard-card.info .card-icon { background: rgba(0, 255, 255, 0.2); color: var(--tanda-cyan); }

        .dashboard-card .card-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 0;
        }

        .dashboard-card .card-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .dashboard-card .card-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
        }

        .dashboard-card .card-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .btn-pay-now {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            animation: pulse-pay 2s infinite;
            white-space: nowrap;
        }

        .btn-pay-now:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        @keyframes pulse-pay {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
        }

        @media (max-width: 768px) {
            .tandas-dashboard {
                grid-template-columns: 1fr;
            }
            .dashboard-card {
                flex-wrap: wrap;
            }
            .btn-pay-now {
                width: 100%;
                margin-top: 12px;
            }
        }
        /* ===== END TANDAS DASHBOARD STYLES ===== */

        /* ===== URGENT PAYMENTS LIST STYLES ===== */
        .urgent-payments-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .urgent-payment-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            transition: all 0.2s;
        }

        .urgent-payment-row:hover {
            border-color: var(--tanda-cyan);
            transform: translateX(4px);
        }

        .urgent-payment-row.urgent {
            border-left: 4px solid #ef4444;
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.1), transparent);
        }

        .urgent-payment-row.warning {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.1), transparent);
        }

        .urgent-payment-row.ok {
            border-left: 4px solid #10b981;
        }

        .urgency-indicator {
            font-size: 20px;
            flex-shrink: 0;
        }

        .urgent-payment-row .payment-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .urgent-payment-row .payment-info strong {
            font-size: 16px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .urgent-payment-row .payment-details {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .urgent-payment-row .payment-amount {
            font-size: 18px;
            font-weight: 700;
            color: var(--tanda-cyan);
            min-width: 100px;
            text-align: right;
        }

        .urgent-payment-row .payment-due {
            font-size: 14px;
            font-weight: 600;
            min-width: 70px;
            text-align: center;
        }

        .urgent-payment-row.urgent .payment-due {
            color: #ef4444;
        }

        .urgent-payment-row.warning .payment-due {
            color: #f59e0b;
        }

        .btn-quick-pay {
            background: linear-gradient(135deg, var(--tanda-cyan), var(--tanda-cyan-dark));
            color: #0a192f;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-quick-pay:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 255, 255, 0.3);
        }

        /* ===== COLLECTORS LIST STYLES ===== */
        .collectors-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .collector-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 10px;
            transition: all 0.2s;
        }

        .collector-row:hover {
            border-color: var(--border-accent);
        }

        .collector-row.is-me {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.15), rgba(0, 255, 255, 0.05));
            border-color: var(--tanda-cyan);
        }

        .collector-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .collector-row.is-me .collector-avatar {
            background: var(--tanda-cyan);
            color: #0a192f;
            font-size: 20px;
        }

        .collector-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .collector-info strong {
            color: var(--text-primary);
        }

        .collector-row.is-me .collector-info strong {
            color: var(--tanda-cyan);
        }

        .collector-info span {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .collector-amount {
            font-weight: 600;
            color: #10b981;
        }

        .empty-state {
            text-align: center;
            padding: 32px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 12px;
            color: #10b981;
        .recruiting-state {
            text-align: center;
            padding: 32px;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), transparent);
            border: 1px dashed #f59e0b;
            border-radius: 12px;
        }
        }

        @media (max-width: 640px) {
            .urgent-payment-row {
                flex-wrap: wrap;
            }
            .urgent-payment-row .payment-amount,
            .urgent-payment-row .payment-due {
                min-width: auto;
            }
            .btn-quick-pay {
                width: 100%;
                justify-content: center;
                margin-top: 8px;
            }
        }
        /* ===== END URGENT & COLLECTORS STYLES ===== */


        /* ===== CREATE GROUP PROGRESS BAR STYLES ===== */
        .create-group-form .progress-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            margin-bottom: 30px;
            padding: 0 20px;
            height: auto;
            background: transparent;
        }
        .create-group-form .progress-bar .progress-fill {
            position: absolute;
            top: 50%;
            left: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--tanda-cyan), var(--tanda-cyan-light));
            transform: translateY(-50%);
            z-index: 0;
            border-radius: 2px;
        }
        .create-group-form .progress-bar .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1;
            position: relative;
        }
        .create-group-form .progress-bar .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: 3px solid var(--border-accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }
        .create-group-form .progress-bar .step.active .step-number,
        .create-group-form .progress-bar .step.completed .step-number {
            background: var(--tanda-cyan);
            border-color: var(--tanda-cyan);
            color: #0a192f;
        }
        .create-group-form .progress-bar .step-title {
            margin-top: 8px;
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
        }
        .create-group-form .progress-bar .step.active .step-title {
            color: var(--tanda-cyan);
            font-weight: 600;
        }
        /* ===== END CREATE GROUP PROGRESS BAR STYLES ===== */

/* ===== MODAL DE PAGO RAPIDO ===== */
#quickPayModal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

.quick-pay-modal {
    background: white;
    border-radius: 16px;
    width: 90%;
    max-width: 480px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.quick-pay-modal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid #e5e7eb;
    background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
    color: white;
    border-radius: 16px 16px 0 0;
}

.quick-pay-modal .modal-header h3 {
    margin: 0;
    font-size: 1.25rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.quick-pay-modal .close-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    font-size: 1.5rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
}

.quick-pay-modal .close-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

.quick-pay-modal .modal-body {
    padding: 24px;
}

.payment-summary {
    background: #f8fafc;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 24px;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #e5e7eb;
}

.summary-row:last-child {
    border-bottom: none;
}

.summary-row .label {
    color: #64748b;
    font-size: 0.9rem;
}

.summary-row .value {
    font-weight: 600;
    color: #1e293b;
}

.summary-row .value.amount {
    color: #4F46E5;
    font-size: 1.1rem;
}

.payment-methods h4 {
    margin: 0 0 16px 0;
    color: #374151;
    font-size: 1rem;
}

.method-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.method-option {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
}

.method-option:hover {
    border-color: #4F46E5;
    background: #f8fafc;
}

.method-option input[type="radio"] {
    display: none;
}

.method-option input[type="radio"]:checked + .method-icon {
    background: #4F46E5;
    color: white;
}

.method-option input[type="radio"]:checked ~ .method-info .method-name {
    color: #4F46E5;
}

.method-option:has(input:checked) {
    border-color: #4F46E5;
    background: #EEF2FF;
}

.method-icon {
    width: 48px;
    height: 48px;
    background: #f1f5f9;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    color: #64748b;
    transition: all 0.2s;
}

.method-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.method-name {
    font-weight: 600;
    color: #1e293b;
}

.method-balance, .method-desc {
    font-size: 0.85rem;
    color: #64748b;
}

.insufficient-funds-warning {
    display: flex;
    align-items: center;
    gap: 10px;
    background: #FEF2F2;
    border: 1px solid #FECACA;
    color: #DC2626;
    padding: 12px 16px;
    border-radius: 8px;
    margin-top: 16px;
    font-size: 0.9rem;
}

.insufficient-funds-warning i {
    font-size: 1.1rem;
}

.quick-pay-modal .modal-footer {
    display: flex;
    gap: 12px;
    padding: 20px 24px;
    border-top: 1px solid #e5e7eb;
    background: #f8fafc;
    border-radius: 0 0 16px 16px;
}

.quick-pay-modal .modal-footer .btn {
    flex: 1;
    padding: 14px 24px;
    border-radius: 10px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
}

.quick-pay-modal .btn-secondary {
    background: #e5e7eb;
    color: #374151;
}

.quick-pay-modal .btn-secondary:hover {
    background: #d1d5db;
}

.quick-pay-modal .btn-primary {
    background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
    color: white;
}

.quick-pay-modal .btn-primary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
}

.quick-pay-modal .btn-primary:disabled {
    background: #9ca3af;
    cursor: not-allowed;
}

/* Responsive */
@media (max-width: 480px) {
    .quick-pay-modal {
        width: 95%;
        max-height: 95vh;
    }
    
    .quick-pay-modal .modal-header {
        padding: 16px 20px;
    }
    
    .quick-pay-modal .modal-body {
        padding: 20px;
    }
    
    .method-option {
        padding: 12px;
    }
    
    .method-icon {
        width: 40px;
        height: 40px;
    }
}
/* ===== FIN MODAL DE PAGO RAPIDO CSS ===== */

/* ===== MODAL HISTORIAL PERSONAL ===== */
.history-modal {
    background: white;
    border-radius: 16px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.history-modal .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid #e5e7eb;
    background: linear-gradient(135deg, #059669 0%, #10B981 100%);
    color: white;
}

.history-modal .modal-header h3 {
    margin: 0;
    font-size: 1.25rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.history-modal .close-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    font-size: 1.5rem;
    cursor: pointer;
}

.history-modal .modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 0;
}

.history-tabs {
    display: flex;
    border-bottom: 1px solid #e5e7eb;
    background: #f8fafc;
}

.history-tab {
    flex: 1;
    padding: 16px;
    border: none;
    background: none;
    font-size: 0.95rem;
    font-weight: 600;
    color: #64748b;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.history-tab:hover {
    background: #e5e7eb;
}

.history-tab.active {
    color: #059669;
    border-bottom: 3px solid #059669;
    background: white;
}

.history-filters {
    display: flex;
    gap: 12px;
    padding: 16px 20px;
    background: #f8fafc;
    border-bottom: 1px solid #e5e7eb;
}

.history-filters select {
    flex: 1;
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 0.9rem;
    background: white;
    cursor: pointer;
}

.history-summary {
    display: flex;
    gap: 12px;
    padding: 16px 20px;
    background: white;
    border-bottom: 1px solid #e5e7eb;
}

.summary-stat {
    flex: 1;
    text-align: center;
    padding: 12px;
    background: #f8fafc;
    border-radius: 10px;
}

.summary-stat .stat-value {
    display: block;
    font-size: 1.1rem;
    font-weight: 700;
    color: #059669;
}

.summary-stat .stat-label {
    font-size: 0.8rem;
    color: #64748b;
    margin-top: 4px;
}

.history-content {
    padding: 16px 20px;
    max-height: 300px;
    overflow-y: auto;
}

.history-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.history-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px;
    background: #f8fafc;
    border-radius: 10px;
    border-left: 4px solid #059669;
}

.history-item.payment {
    border-left-color: #EF4444;
}

.history-item.collection {
    border-left-color: #10B981;
}

.history-item .item-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
}

.history-item.payment .item-icon {
    background: #FEE2E2;
    color: #EF4444;
}

.history-item.collection .item-icon {
    background: #D1FAE5;
    color: #059669;
}

.history-item .item-info {
    flex: 1;
}

.history-item .item-tanda {
    font-weight: 600;
    color: #1e293b;
    font-size: 0.95rem;
}

.history-item .item-date {
    font-size: 0.85rem;
    color: #64748b;
    margin-top: 2px;
}

.history-item .item-amount {
    font-weight: 700;
    font-size: 1rem;
}

.history-item.payment .item-amount {
    color: #EF4444;
}

.history-item.collection .item-amount {
    color: #059669;
}

.history-empty {
    text-align: center;
    padding: 40px 20px;
    color: #64748b;
}

.history-empty i {
    font-size: 3rem;
    color: #d1d5db;
    margin-bottom: 16px;
}

.history-modal .modal-footer {
    display: flex;
    gap: 12px;
    padding: 20px 24px;
    border-top: 1px solid #e5e7eb;
    background: #f8fafc;
}

.history-modal .btn {
    padding: 12px 20px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.history-modal .btn-outline {
    background: white;
    border: 2px solid #059669;
    color: #059669;
}

.history-modal .btn-outline:hover {
    background: #059669;
    color: white;
}

@media (max-width: 480px) {
    .history-modal {
        width: 95%;
    }
    
    .history-filters {
        flex-direction: column;
    }
    
    .history-summary {
        flex-wrap: wrap;
    }
    
    .summary-stat {
        min-width: calc(50% - 6px);
    }
}
/* ===== FIN MODAL HISTORIAL CSS ===== */
        /* Recruiting status styles */
        .status-badge.recruiting { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        .tanda-card.status-recruiting { border-left: 4px solid #f59e0b; }
        .btn.btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; }
        .btn.btn-success:hover { background: linear-gradient(135deg, #059669 0%, #047857 100%); transform: translateY(-2px); }
        .waiting-text { color: #94a3b8; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 0.5rem; }
    
/* ===== START TANDA MODAL STYLES ===== */
.start-tanda-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(8px);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.start-tanda-modal-overlay.active {
    opacity: 1;
    visibility: visible;
}

.start-tanda-modal {
    background: rgba(15, 23, 42, 0.95);
    border: 1px solid rgba(148, 163, 184, 0.2);
    border-radius: 24px;
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    transform: scale(0.95);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    padding: 1.5rem;
}

.start-tanda-modal-overlay.active .start-tanda-modal {
    transform: scale(1);
}

.start-tanda-modal h3 {
    color: #f8fafc;
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    text-align: center;
}

.summary-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.summary-item {
    background: rgba(30, 41, 59, 0.5);
    border-radius: 12px;
    padding: 1rem;
}

.summary-label {
    color: #94a3b8;
    font-size: 0.875rem;
    display: block;
    margin-bottom: 0.25rem;
}

.summary-value {
    color: #f8fafc;
    font-size: 1.125rem;
    font-weight: 600;
}

.lottery-warning-box {
    background: rgba(245, 158, 11, 0.15);
    border: 1px solid rgba(245, 158, 11, 0.3);
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.lottery-warning-box p {
    color: #fbbf24;
    margin: 0 0 0.75rem 0;
    font-size: 0.875rem;
}

.lottery-warning-box .btn-lottery {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    transition: transform 0.2s;
}

.lottery-warning-box .btn-lottery:hover {
    transform: translateY(-2px);
}

.turns-section h4 {
    color: #f8fafc;
    font-size: 1rem;
    margin-bottom: 0.75rem;
}

.turns-list {
    background: rgba(30, 41, 59, 0.5);
    border-radius: 12px;
    padding: 0.75rem 1rem 0.75rem 2rem;
    margin: 0 0 1.5rem 0;
    max-height: 150px;
    overflow-y: auto;
}

.turns-list li {
    color: #e2e8f0;
    padding: 0.375rem 0;
    border-bottom: 1px solid rgba(148, 163, 184, 0.1);
}

.turns-list li:last-child {
    border-bottom: none;
}

.action-buttons {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.action-buttons .btn-primary {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    border: none;
    padding: 0.875rem 1.5rem;
    border-radius: 12px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}

.action-buttons .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
}

.action-buttons .btn-secondary {
    background: rgba(148, 163, 184, 0.1);
    color: #e2e8f0;
    border: 1px solid rgba(148, 163, 184, 0.2);
    padding: 0.875rem 1.5rem;
    border-radius: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
}

.action-buttons .btn-secondary:hover {
    background: rgba(148, 163, 184, 0.2);
}

.schedule-section {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(148, 163, 184, 0.1);
    display: none;
}

.schedule-section.show {
    display: block;
}

.schedule-section input[type="datetime-local"] {
    width: 100%;
    padding: 0.75rem;
    border-radius: 8px;
    border: 1px solid rgba(148, 163, 184, 0.3);
    background: rgba(30, 41, 59, 0.5);
    color: #f8fafc;
    margin-bottom: 0.75rem;
}

.schedule-section .btn-schedule {
    width: 100%;
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    color: white;
    border: none;
    padding: 0.75rem;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
}

.action-buttons .btn-cancel {
    background: transparent;
    color: #94a3b8;
    border: none;
    padding: 0.5rem;
    cursor: pointer;
    margin-top: 0.5rem;
}

.action-buttons .btn-cancel:hover {
    color: #f8fafc;
}
/* ===== END START TANDA MODAL STYLES ===== */

        </style>
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/header.css?v=24.5">
    <link rel="stylesheet" href="css/onboarding.css?v=1.0">
    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://latanda.online/groups-advanced-system.html">
    <meta property="og:title" content="Grupos | La Tanda">
    <meta property="og:description" content="Administra tus grupos de ahorro, invita miembros y gestiona contribuciones.">
    <meta property="og:image" content="https://latanda.online/assets/og-image.png">
    <meta property="og:site_name" content="La Tanda">
    <meta property="og:locale" content="es_HN">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Grupos | La Tanda">
    <meta name="twitter:description" content="Administra tus grupos de ahorro, invita miembros y gestiona contribuciones.">
    <meta name="twitter:image" content="https://latanda.online/assets/og-image.png">
</head>
<body>
    <!-- Global Header Component -->
    <div id="global-header"></div>
    <div class="bg-effects">
        <div class="gradient-orb gradient-orb-1"></div>
        <div class="gradient-orb gradient-orb-2"></div>
        <div class="gradient-orb gradient-orb-3"></div>
    </div>

    <!-- Unified Header -->
    
    <div class="container">
        <!-- Page-specific Header Section with Return Button -->
        <div class="page-title-section" style="padding: 40px 0 20px; text-align: center; position: relative;">
            <button onclick="window.location.href='home-dashboard.html'" class="back-button" style="position: absolute; left: 0; top: 50%; transform: translateY(-50%); background: var(--bg-card); border: 1px solid var(--border-accent); border-radius: 12px; padding: 12px 16px; color: var(--tanda-cyan); text-decoration: none; display: flex; align-items: center; gap: 8px; cursor: pointer; transition: all 0.3s ease; backdrop-filter: blur(10px);">
                <i class="fas fa-arrow-left"></i>
                <span data-translate="nav.back">Regresar</span>
            </button>
            <h1 style="font-size: 36px; margin-bottom: 8px; color: var(--tanda-cyan);" data-translate="groups.title">Sistema de Grupos & Tandas Avanzado</h1>
            <p style="color: var(--text-secondary); font-size: 18px;" data-translate="groups.subtitle">Plataforma digital para tandas tradicionales con tecnología La Tanda Web3</p>
        </div>

        <!-- Navigation Tabs -->
        <nav class="nav-tabs" role="tablist">
            <button class="nav-tab active" data-tab="calculator" onclick="switchTab('calculator')">
                <i class="fas fa-calculator"></i>
                <span data-translate="nav.calculator">Tanda Calculator</span>
            </button>
            <button class="nav-tab" data-tab="groups" onclick="switchTab('groups')">
                <i class="fas fa-users"></i>
                <span data-translate="nav.groups">My Groups</span>
            </button>
            <button class="nav-tab" data-tab="create" onclick="switchTab('create')">
                <i class="fas fa-plus-circle"></i>
                <span data-translate="nav.create">Create Group</span>
            </button>
            <button class="nav-tab" data-tab="tandas" onclick="switchTab('tandas')">
                <i class="fas fa-sync-alt"></i>
                <span data-translate="groups.tandas">Tandas</span>
            </button>
            <button class="nav-tab" data-tab="matching" onclick="switchTab('matching')">
                <i class="fas fa-magic"></i>
                <span data-translate="groups.matching">Matching</span>
            </button>
            <button class="nav-tab" data-tab="analytics" onclick="switchTab('analytics')">
                <i class="fas fa-chart-bar"></i>
                <span data-translate="nav.analytics">Analíticas</span>
            </button>
        </nav>

        <!-- Tanda Calculator Section -->
        <section id="calculator" class="content-section active">
            <div class="calculator-container" style="max-width: 800px; margin: 0 auto; padding: 20px;">

                <div class="calculator-hero" style="text-align: center; margin-bottom: 40px;">
                    <h2 style="font-size: 42px; margin-bottom: 12px;">
                        <i class="fas fa-calculator" style="color: var(--tanda-cyan);"></i>
                        <span data-translate="calculator.title">Tanda Calculator</span>
                    </h2>
                    <p style="font-size: 20px; color: var(--text-secondary);" data-translate="calculator.subtitle">Calculate your perfect tanda in seconds</p>
                </div>

                <!-- Calculator Form -->
                <div class="calculator-card" style="background: var(--bg-card); border: 1px solid var(--border-accent); border-radius: 16px; padding: 32px; margin-bottom: 24px; backdrop-filter: blur(10px);">
                    <h3 style="font-size: 24px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px;">
                        <i class="fas fa-edit" style="color: var(--tanda-cyan);"></i>
                        <span data-translate="calculator.form.title">Tanda Details</span>
                    </h3>

                    <div style="display: grid; gap: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-size: 16px; font-weight: 600;">
                                <i class="fas fa-users"></i> Number of Participants
                            </label>
                            <input type="number" id="calc-participants" min="2" value="10"
                                   style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border-accent); border-radius: 12px; color: var(--text-primary); font-size: 18px;">
                        </div>

                        <div>
                            <label style="display: block; margin-bottom: 8px; font-size: 16px; font-weight: 600;">
                                <i class="fas fa-dollar-sign"></i> Contribution per Person
                            </label>
                            <input type="number" id="calc-amount" min="50" value="1000" placeholder="Amount each person contributes"
                                   style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border-accent); border-radius: 12px; color: var(--text-primary); font-size: 18px;">
                        </div>

                        <div>
                            <label style="display: block; margin-bottom: 8px; font-size: 16px; font-weight: 600;"><i class="fas fa-calendar-alt"></i> <span data-translate="calculator.form.frequency">Frequency</span></label>
                            <select id="calc-frequency"
                                    style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border-accent); border-radius: 12px; color: var(--text-primary); font-size: 18px;">
                                <option value="weekly" data-translate="calculator.form.frequency_weekly">Weekly</option>
                                <option value="biweekly" data-translate="calculator.form.frequency_biweekly">Bi-weekly</option>
                                <option value="monthly" selected data-translate="calculator.form.frequency_monthly">Monthly</option>
                            </select>
                        </div>

                        <div>
                            <label style="display: block; margin-bottom: 8px; font-size: 16px; font-weight: 600;"><i class="fas fa-calendar-day"></i> Starting Date</label>
                            <input type="date" id="calc-startdate"
                                   style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border-accent); border-radius: 12px; color: var(--text-primary); font-size: 18px;">
                        </div>

                        <div>
                            <label style="display: block; margin-bottom: 8px; font-size: 16px; font-weight: 600;"><i class="fas fa-coins"></i> Currency</label>
                            <select id="calc-currency"
                                    style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border-accent); border-radius: 12px; color: var(--text-primary); font-size: 18px;">
                                <option value="HNL" selected>L (HNL - Lempira)</option>
                                <option value="USD">$ (USD - Dollar)</option>
                            </select>
                        </div>

                        <button onclick="calculateTanda()" class="action-btn btn-primary" style="width: 100%; padding: 16px; font-size: 18px; font-weight: 600; background: var(--tanda-cyan); color: #0a192f; border: none; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <i class="fas fa-calculator"></i> Calculate Tanda
                        </button>
                    </div>
                </div>

                <!-- Results Card -->
                <div id="calc-results" class="results-card" style="background: linear-gradient(135deg, rgba(0, 255, 255, 0.1), rgba(0, 255, 255, 0.05)); border: 1px solid var(--border-accent); border-radius: 16px; padding: 32px; backdrop-filter: blur(10px); display: none;">
                    <h3 style="font-size: 24px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px;">
                        <i class="fas fa-chart-line" style="color: var(--tanda-cyan);"></i>
                        <span data-translate="calculator.results.title">Your Tanda Results</span>
                    </h3>

                    <div style="display: grid; gap: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: rgba(0, 0, 0, 0.2); border-radius: 12px;">
                            <span style="font-size: 18px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-money-bill-wave" style="color: var(--tanda-cyan);"></i>
                                Contribution per Person:
                            </span>
                            <span id="result-contribution" style="font-size: 24px; font-weight: 700; color: var(--tanda-cyan);">$0</span>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: rgba(0, 0, 0, 0.2); border-radius: 12px;">
                            <span style="font-size: 18px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-clock" style="color: var(--tanda-cyan);"></i>
                                Duration:
                            </span>
                            <span id="result-duration" style="font-size: 24px; font-weight: 700; color: var(--tanda-cyan);">0 months</span>
                        </div>

                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: rgba(0, 0, 0, 0.2); border-radius: 12px;">
                            <span style="font-size: 18px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-hand-holding-usd" style="color: var(--tanda-cyan);"></i>
                                Total Payout:
                            </span>
                            <span id="result-payout" style="font-size: 24px; font-weight: 700; color: var(--tanda-cyan);">$0</span>
                        </div>
                    </div>

                    <div id="schedule-container" style="margin-top: 24px;">
                        <h4 style="font-size: 20px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-list-ol" style="color: var(--tanda-cyan);"></i>
                            Payment Schedule
                        </h4>
                        <div id="schedule-table" style="overflow-x: auto;"></div>
                    </div>

                    <!-- Benefits Section -->
                    <div style="margin-top: 32px; border-top: 2px solid rgba(0, 255, 255, 0.2); padding-top: 32px;">
                        <h4 style="font-size: 22px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px; color: var(--tanda-cyan);">
                            <i class="fas fa-gift"></i>
                            What You Gain with La Tanda
                        </h4>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                            <!-- Creators Benefits -->
                            <div style="background: rgba(0, 255, 255, 0.05); border: 1px solid var(--border-accent); border-radius: 12px; padding: 20px;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                    <div style="width: 48px; height: 48px; background: var(--tanda-cyan); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-crown" style="font-size: 24px; color: #0a192f;"></i>
                                    </div>
                                    <h5 style="font-size: 18px; font-weight: 700; margin: 0;" data-translate="calculator.benefits.creators.title">Creators Gain</h5>
                                </div>
                                <ul style="list-style: none; padding: 0; margin: 0; display: grid; gap: 12px;">
                                    <li style="display: flex; align-items: start; gap: 8px;">
                                        <i class="fas fa-check-circle" style="color: var(--tanda-cyan); margin-top: 4px;"></i>
                                        <span><strong data-translate="calculator.benefits.creators.fee">2-5% Coordination Fee</strong> <span data-translate="calculator.benefits.creators.fee_desc">on total tanda amount</span></span>
                                    </li>
                                    <li style="display: flex; align-items: start; gap: 8px;">
                                        <i class="fas fa-check-circle" style="color: var(--tanda-cyan); margin-top: 4px;"></i>
                                        <span><strong id="creator-reward-text" data-translate="calculator.benefits.creators.tokens">20% LTD Pool Bonus</strong> <span data-translate="calculator.benefits.creators.tokens_desc">+ participation share</span></span>
                                    </li>
                                    <li style="display: flex; align-items: start; gap: 8px;">
                                        <i class="fas fa-check-circle" style="color: var(--tanda-cyan); margin-top: 4px;"></i>
                                        <span><strong data-translate="calculator.benefits.creators.priority">Priority Matching</strong> <span data-translate="calculator.benefits.creators.priority_desc">for your tandas</span></span>
                                    </li>
                                    <li style="display: flex; align-items: start; gap: 8px;">
                                        <i class="fas fa-check-circle" style="color: var(--tanda-cyan); margin-top: 4px;"></i>
                                        <span><strong data-translate="calculator.benefits.creators.automation">Automated Management</strong> <span data-translate="calculator.benefits.creators.automation_desc">- Zero overhead</span></span>
                                    </li>
                                </ul>
                            </div>

                            <!-- Participants Benefits -->
                            <div style="background: rgba(0, 255, 255, 0.05); border: 1px solid var(--border-accent); border-radius: 12px; padding: 20px;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #00FFFF, #7FFFD8); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-users" style="font-size: 24px; color: #0a192f;"></i>
                                    </div>
                                    <h5 style="font-size: 18px; font-weight: 700; margin: 0;" data-translate="calculator.benefits.participants.title">Participants Gain</h5>
                                </div>
                                <ul style="list-style: none; padding: 0; margin: 0; display: grid; gap: 12px;">
                                    <li style="display: flex; align-items: start; gap: 8px;">
                                        <i class="fas fa-check-circle" style="color: var(--tanda-cyan); margin-top: 4px;"></i>
                                        <span><strong data-translate="calculator.benefits.participants.capital">Access to Capital</strong> <span data-translate="calculator.benefits.participants.capital_desc">without credit checks</span></span>
                                    </li>
                                    <li style="display: flex; align-items: start; gap: 8px;">
                                        <i class="fas fa-check-circle" style="color: var(--tanda-cyan); margin-top: 4px;"></i>
                                        <span><strong id="participant-reward-text" data-translate="calculator.benefits.participants.tokens">LTD Token Share</strong> <span data-translate="calculator.benefits.participants.tokens_desc">from 80% pool</span></span>
                                    </li>
                                    <li style="display: flex; align-items: start; gap: 8px;">
                                        <i class="fas fa-check-circle" style="color: var(--tanda-cyan); margin-top: 4px;"></i>
                                        <span><strong data-translate="calculator.benefits.participants.credit">Build Credit Score</strong> <span data-translate="calculator.benefits.participants.credit_desc">through participation</span></span>
                                    </li>
                                    <li style="display: flex; align-items: start; gap: 8px;">
                                        <i class="fas fa-check-circle" style="color: var(--tanda-cyan); margin-top: 4px;"></i>
                                        <span><strong data-translate="calculator.benefits.participants.interest">0% Interest</strong> <span data-translate="calculator.benefits.participants.interest_desc">- Community powered</span></span>
                                    </li>
                                </ul>
                            </div>

                            <!-- Platform Benefits -->
                            <div style="background: rgba(0, 255, 255, 0.05); border: 1px solid var(--border-accent); border-radius: 12px; padding: 20px;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #7FFFD8, #00CED1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-shield-alt" style="font-size: 24px; color: #0a192f;"></i>
                                    </div>
                                    <h5 style="font-size: 18px; font-weight: 700; margin: 0;" data-translate="calculator.benefits.platform.title">Platform Features</h5>
                                </div>
                                <ul style="list-style: none; padding: 0; margin: 0; display: grid; gap: 12px;">
                                    <li style="display: flex; align-items: start; gap: 8px;">
                                        <i class="fas fa-check-circle" style="color: var(--tanda-cyan); margin-top: 4px;"></i>
                                        <span><strong data-translate="calculator.benefits.platform.contracts">Smart Contracts</strong> <span data-translate="calculator.benefits.platform.contracts_desc">ensure transparency</span></span>
                                    </li>
                                    <li style="display: flex; align-items: start; gap: 8px;">
                                        <i class="fas fa-check-circle" style="color: var(--tanda-cyan); margin-top: 4px;"></i>
                                        <span><strong data-translate="calculator.benefits.platform.payments">Automated Payments</strong> <span data-translate="calculator.benefits.platform.payments_desc">- Never miss a turn</span></span>
                                    </li>
                                    <li style="display: flex; align-items: start; gap: 8px;">
                                        <i class="fas fa-check-circle" style="color: var(--tanda-cyan); margin-top: 4px;"></i>
                                        <span><strong data-translate="calculator.benefits.platform.dispute">Dispute Resolution</strong> <span data-translate="calculator.benefits.platform.dispute_desc">system included</span></span>
                                    </li>
                                    <li style="display: flex; align-items: start; gap: 8px;">
                                        <i class="fas fa-check-circle" style="color: var(--tanda-cyan); margin-top: 4px;"></i>
                                        <span><strong data-translate="calculator.benefits.platform.insurance">Insurance Pool</strong> <span data-translate="calculator.benefits.platform.insurance_desc">protects all members</span></span>
                                    </li>
                                </ul>
                            </div>
                        </div>

                        <!-- Commission Example -->
                        <div id="commission-example" style="margin-top: 24px; background: linear-gradient(135deg, rgba(0, 255, 255, 0.08), rgba(127, 255, 216, 0.05)); border: 1px solid var(--tanda-cyan); border-radius: 12px; padding: 20px;">
                            <h5 style="font-size: 18px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-calculator" style="color: var(--tanda-cyan);"></i>
                                Commission Breakdown for This Tanda
                            </h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px;" data-translate="calculator.benefits.commission.coordinator_fee">Coordinator Fee (3%)</div>
                                    <div id="coordinator-fee" style="font-size: 24px; font-weight: 700; color: var(--tanda-cyan);">$0</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px;" data-translate="calculator.benefits.commission.total_pool">Total LTD Pool</div>
                                    <div id="total-pool" style="font-size: 24px; font-weight: 700; color: var(--tanda-cyan);">0 LTD</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px;" data-translate="calculator.benefits.commission.creator_earns">Creator Earns (20% + share)</div>
                                    <div id="creator-tokens" style="font-size: 24px; font-weight: 700; color: var(--tanda-cyan);">0 LTD</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 4px;" data-translate="calculator.benefits.commission.participant_earns">Each Participant Earns</div>
                                    <div id="member-tokens" style="font-size: 24px; font-weight: 700; color: var(--tanda-cyan);">0 LTD</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- Groups Section -->
        <!-- My Groups V2 Section (Standalone - Exact Copy) -->
        <section id="groups" class="content-section">
            <style>
/* ===== VARIABLES & RESET ===== */
        :root {
            --tanda-cyan: #00FFFF;
            --tanda-cyan-light: #7FFFD8;
            --tanda-cyan-dark: #00B8D4;
            --text-primary: #f8fafc;
            --text-secondary: rgba(248, 250, 252, 0.7);
            --text-muted: rgba(248, 250, 252, 0.5);
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: rgba(30, 41, 59, 0.6);
            --border-primary: rgba(148, 163, 184, 0.1);
            --border-accent: rgba(0, 255, 255, 0.2);

            /* Status colors */
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;

            /* Spacing */
            --spacing-xs: 0.5rem;
            --spacing-sm: 0.75rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;

            /* Border radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, #0a0f1c 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ===== LAYOUT ===== */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 90px var(--spacing-md) var(--spacing-md) var(--spacing-md); /* top=header */
        }

        @media (min-width: 768px) {
            .container {
                padding: var(--spacing-xl);
            }
        }

        /* ===== HEADER ===== */
        .header {
            text-align: center;
            padding: var(--spacing-xl) var(--spacing-md);
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-accent);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-xl);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            font-size: clamp(1.75rem, 5vw, 2.5rem);
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
            background: linear-gradient(135deg, var(--tanda-cyan), var(--tanda-cyan-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: clamp(0.9rem, 2vw, 1.1rem);
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }

        /* ===== FILTER BAR ===== */
        .filter-bar {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-lg);
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
        }

        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--tanda-cyan);
            box-shadow: 0 0 0 3px rgba(0, 255, 255, 0.1);
        }

        /* ===== STATS SUMMARY ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }

        .stat-card {
            padding: var(--spacing-lg);
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: var(--tanda-cyan);
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--tanda-cyan);
            margin-bottom: var(--spacing-xs);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* ===== GROUPS GRID ===== */
        .groups-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(min(100%, 350px), 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        /* ===== GROUP CARD ===== */
        .group-card {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .group-card:hover {
            border-color: var(--tanda-cyan);
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        .group-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--tanda-cyan), var(--tanda-cyan-light));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .group-card:hover::before {
            opacity: 1;
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-md);
        }

        .group-title {
            flex: 1;
        }

        .group-title h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
            color: var(--text-primary);
        }

        .group-category {
            font-size: 0.813rem;
            color: var(--text-muted);
            text-transform: capitalize;
        }

        /* ===== BADGES ===== */
        .badges {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-md);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.625rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .badge-role {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .badge-role.creator {
            background: rgba(168, 85, 247, 0.2);
            color: #c084fc;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }

        .badge-role.coordinator {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .badge-payment {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .badge-payment.pending {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .badge-payment.late {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .badge-payment.suspended {
            background: rgba(127, 29, 29, 0.4);
            color: #fca5a5;
            border: 1px solid rgba(127, 29, 29, 0.6);
            animation: pulse-danger 2s infinite;
        }

        @keyframes pulse-danger {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .badge-goal-reached {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.25), rgba(5, 150, 105, 0.25));
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.5);
            font-weight: 600;
            animation: pulse-goal 2s ease-in-out infinite;
        }

        @keyframes pulse-goal {
            0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            50% { box-shadow: 0 0 0 4px rgba(16, 185, 129, 0); }
        }

        /* ===== TOOLTIP ===== */
        .group-title-wrapper {
            position: relative;
            display: inline-block;
        }

        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 0;
            background: rgba(15, 23, 42, 0.95);
            color: var(--text-primary);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-sm);
            font-size: 0.813rem;
            white-space: nowrap;
            max-width: 300px;
            white-space: normal;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            border: 1px solid var(--border-accent);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            margin-bottom: 8px;
        }

        .group-title-wrapper:hover .tooltip {
            opacity: 1;
        }

        .location-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: var(--spacing-xs);
        }

        /* ===== GROUP INFO ===== */
        .group-info {
            margin-bottom: var(--spacing-md);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm) 0;
            border-bottom: 1px solid var(--border-primary);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .info-value {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .info-value.highlight {
            color: var(--tanda-cyan);
        }

        /* ===== ALERTS ===== */
        .alerts {
            margin-top: var(--spacing-md);
        }

        .alert {
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            margin-bottom: var(--spacing-xs);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .alert:last-child {
            margin-bottom: 0;
        }

        .alert-icon {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
        }

        .alert-message {
            flex: 1;
        }

        .alert.success {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #34d399;
        }

        .alert.warning {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #fbbf24;
        }

        .alert.danger {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
        }

        .alert.info {
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #60a5fa;
        }

        .alert-action {
            flex-shrink: 0;
            padding: 0.25rem 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid currentColor;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            color: inherit;
        }

        .alert-action:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        /* ===== ACTION BUTTONS ===== */
        .group-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        .btn {
            flex: 1;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--tanda-cyan), var(--tanda-cyan-dark));
            color: var(--bg-primary);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 255, 255, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--tanda-cyan);
        }

        /* ===== LOADING & EMPTY STATES ===== */
        .loading {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-primary);
            border-top-color: var(--tanda-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--spacing-md);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-xl);
            background: rgba(0, 0, 0, 0.2);
            border: 1px dashed var(--border-primary);
            border-radius: var(--radius-lg);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: var(--spacing-md);
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: var(--spacing-sm);
        }

        .empty-state p {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-lg);
        }

        /* ===== MOBILE OPTIMIZATIONS ===== */
        @media (max-width: 767px) {
            .filter-bar {
                flex-direction: column;
            }

            .filter-group {
                min-width: 100%;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .group-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        /* ===== ACCESSIBILITY ===== */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* ===== HIGHLIGHTING DE GRUPO NUEVO ===== */
        .group-card.newly-created {
            animation: highlightPulse 2.5s ease-in-out;
            border: 2px solid var(--tanda-cyan) !important;
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.6);
            position: relative;
            overflow: visible;
        }

        .group-card.newly-created::before {
            content: '🎉 ¡Nuevo!';
            position: absolute;
            top: -12px;
            right: 20px;
            background: linear-gradient(135deg, #00ffff 0%, #00d4ff 100%);
            color: #0f172a;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0, 255, 255, 0.4);
            animation: badgeBounce 0.6s ease-out;
            z-index: 10;
        }

        @keyframes highlightPulse {
            0%, 100% {
                box-shadow: 0 0 25px rgba(0, 255, 255, 0.6);
                transform: scale(1);
            }
            25% {
                box-shadow: 0 0 40px rgba(0, 255, 255, 0.9);
                transform: scale(1.02);
            }
            50% {
                box-shadow: 0 0 35px rgba(0, 255, 255, 0.8);
                transform: scale(1.01);
            }
            75% {
                box-shadow: 0 0 30px rgba(0, 255, 255, 0.7);
                transform: scale(1);
            }
        }

        @keyframes badgeBounce {
            0% {
                transform: translateY(-10px) scale(0.8);
                opacity: 0;
            }
            50% {
                transform: translateY(-2px) scale(1.1);
            }
            100% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        /* Asegurar que el badge sea visible */
        .group-card {
            position: relative;
            overflow: visible !important;
        }
/* =====================================================================
   POSITION ASSIGNMENT COMPONENT STYLES
   To be integrated into groups-advanced-system.html
   ===================================================================== */

/* Position Assignment Section */
.position-assignment-section {
    margin-top: var(--spacing-lg);
    padding: var(--spacing-lg);
    background: rgba(0, 255, 255, 0.05);
    border: 1px solid var(--border-accent);
    border-radius: var(--radius-md);
}

.position-header {
    margin-bottom: var(--spacing-lg);
}

.position-header h4 {
    font-size: 1.1rem;
    color: var(--tanda-cyan);
    margin-bottom: var(--spacing-sm);
}

.position-progress {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
}

.progress-text {
    font-size: 0.9rem;
    color: var(--text-secondary);
    min-width: 100px;
}

.progress-bar {
    flex: 1;
    height: 8px;
    background: rgba(148, 163, 184, 0.2);
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--tanda-cyan), var(--tanda-cyan-light));
    transition: width 0.3s ease;
}

/* Pending Requests Section */
.pending-requests-section {
    margin-bottom: var(--spacing-lg);
}

.pending-requests-section h5 {
    font-size: 1rem;
    color: var(--text-primary);
    margin-bottom: var(--spacing-md);
}

.requests-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
}

.request-card {
    background: rgba(30, 41, 59, 0.6);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-sm);
    padding: var(--spacing-md);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--spacing-md);
    transition: all 0.2s ease;
}

.request-card:hover {
    background: rgba(30, 41, 59, 0.8);
    border-color: var(--border-accent);
}

.request-info {
    flex: 1;
}

.request-user {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-xs);
}

.request-user strong {
    color: var(--text-primary);
    font-size: 0.95rem;
}

.request-position-badge {
    display: inline-block;
    padding: 2px 8px;
    background: var(--tanda-cyan);
    color: var(--bg-primary);
    font-size: 0.75rem;
    font-weight: 600;
    border-radius: 12px;
}

.request-reason {
    margin-bottom: var(--spacing-xs);
    font-size: 0.85rem;
    color: var(--text-secondary);
    font-style: italic;
}

.request-date {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.request-actions {
    display: flex;
    gap: var(--spacing-xs);
}

/* Positions Grid Section */
.positions-grid-section {
    margin-bottom: var(--spacing-lg);
}

.positions-grid-section h5 {
    font-size: 1rem;
    color: var(--text-primary);
    margin-bottom: var(--spacing-md);
}

.positions-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: var(--spacing-sm);
}

@media (max-width: 768px) {
    .positions-grid {
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    }
}

.position-cell {
    aspect-ratio: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 8px;
    border-radius: var(--radius-sm);
    text-align: center;
    transition: all 0.2s ease;
    cursor: pointer;
    min-width: 50px;
    max-width: 65px;
    min-height: 50px;
    max-height: 65px;
    font-size: 14px;
}

.position-cell.available {
    background: rgba(148, 163, 184, 0.1);
    border: 2px dashed var(--border-primary);
}

.position-cell.available:hover {
    background: rgba(0, 255, 255, 0.1);
    border-color: var(--tanda-cyan);
    transform: translateY(-2px);
}

.position-cell.assigned {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
    border: 2px solid var(--success);
    cursor: default;
}

.position-cell.assigned.approved {
    border-color: var(--success);
}

.position-cell.assigned.manual {
    border-color: var(--info);
}

.position-cell.assigned.random {
    border-color: var(--warning);
}

.position-cell.assigned.auto {
    border-color: var(--tanda-cyan);
}

.position-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: var(--spacing-xs);
}

.position-cell.available .position-number {
    color: var(--text-muted);
}

.position-status {
    font-size: 0.75rem;
    color: var(--text-muted);
}

.position-user {
    font-size: 0.85rem;
    color: var(--text-primary);
    font-weight: 600;
    margin-bottom: 2px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 100%;
}

.position-type {
    font-size: 0.7rem;
    color: var(--text-secondary);
}

/* Position Actions */
.position-actions {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-sm);
    justify-content: space-between;
    align-items: center;
}

/* Modal Styles */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(8px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

.modal-content {
    background: var(--bg-secondary);
    border: 1px solid var(--border-accent);
    border-radius: var(--radius-lg);
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-lg);
    border-bottom: 1px solid var(--border-primary);
}

.modal-header h3 {
    font-size: 1.25rem;
    color: var(--text-primary);
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    font-size: 2rem;
    color: var(--text-secondary);
    cursor: pointer;
    line-height: 1;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.modal-close:hover {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-primary);
}

.modal-body {
    padding: var(--spacing-lg);
}

.modal-body label {
    display: block;
    margin-bottom: var(--spacing-xs);
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.modal-body textarea,
.modal-body select {
    width: 100%;
    padding: var(--spacing-sm);
    background: rgba(15, 23, 42, 0.6);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-family: inherit;
    font-size: 0.95rem;
    transition: all 0.2s ease;
}

.modal-body textarea:focus,
.modal-body select:focus {
    outline: none;
    border-color: var(--tanda-cyan);
    background: rgba(15, 23, 42, 0.8);
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: var(--spacing-sm);
    padding: var(--spacing-lg);
    border-top: 1px solid var(--border-primary);
}

/* Global Loader */
.global-loader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(8px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10001;
}

.loader-content {
    text-align: center;
}

.loader-spinner {
    width: 50px;
    height: 50px;
    border: 4px solid rgba(0, 255, 255, 0.2);
    border-top-color: var(--tanda-cyan);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto var(--spacing-md);
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loader-message {
    color: var(--text-primary);
    font-size: 1rem;
}

/* Notification */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: var(--spacing-md) var(--spacing-lg);
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 0.95rem;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    z-index: 100000;
    opacity: 0;
    transform: translateX(400px);
    transition: all 0.3s ease;
}

.notification.show {
    opacity: 1;
    transform: translateX(0);
}

.notification-success {
    border-left: 4px solid var(--success);
}

.notification-error {
    border-left: 4px solid var(--danger);
}

.notification-warning {
    border-left: 4px solid var(--warning);
}

.notification-info {
    border-left: 4px solid var(--info);
}

/* Button Variants */
.btn-sm {
    padding: 6px 12px;
    font-size: 0.85rem;
}

.btn-success {
    background: var(--success);
    color: white;
}

.btn-success:hover {
    background: #0d9668;
}

.btn-danger {
    background: var(--danger);
    color: white;
}

.btn-danger:hover {
    background: #dc2626;
}

.btn-disabled {
    background: rgba(148, 163, 184, 0.2);
    color: var(--text-muted);
    cursor: not-allowed;
    opacity: 0.6;
}

.btn-disabled:hover {
    background: rgba(148, 163, 184, 0.2);
    transform: none;
}
            
/* ========================================
   TANDAS TAB - MOBILE-FIRST STYLES
   ======================================== */

/* MOBILE PERFORMANCE OPTIMIZED */
.tanda-card {
    background: var(--bg-card);
    border: 1px solid var(--border-accent);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 16px;
    
    /* GPU-friendly */
    will-change: transform;
    transform: translateZ(0);
    
    /* Minimal blur for mobile */
    backdrop-filter: none;
}

@media (min-width: 768px) {
    .tanda-card {
        backdrop-filter: blur(4px); /* Only on desktop */
    }
}

/* STATUS COLORS */
.tanda-card.status-active {
    border-left: 4px solid var(--tanda-cyan);
}

.tanda-card.status-waiting-turn {
    border-left: 4px solid #FFA500;
}

.tanda-card.status-collecting {
    border-left: 4px solid #00FF00;
}

.tanda-card.status-completed {

.tanda-card.status-paused {
    border-left: 4px solid #ef4444;
    opacity: 0.8;
}
    border-left: 4px solid #808080;

.tanda-card.status-paused {
    border-left: 4px solid #ef4444;
    opacity: 0.8;
}
    opacity: 0.7;

.tanda-card.status-paused {
    border-left: 4px solid #ef4444;
    opacity: 0.8;
}
}

.tanda-card.status-paused {
    border-left: 4px solid #ef4444;
    opacity: 0.8;
}

/* HEADER */
.tanda-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
}

.tanda-title h3 {
    font-size: 18px;
    margin: 0 0 4px 0;
    color: var(--text-primary);
}

.status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.status-badge.active {
    background: rgba(0, 255, 255, 0.2);
    color: var(--tanda-cyan);
}

.status-badge.waiting-turn {
    background: rgba(255, 165, 0, 0.2);
    color: #FFA500;
}

.status-badge.collecting {
    background: rgba(0, 255, 0, 0.2);
    color: #00FF00;
}

.status-badge.completed {

.status-badge.paused {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}
    background: rgba(128, 128, 128, 0.2);

.status-badge.paused {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}
    color: #808080;

.status-badge.paused {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}
}

.status-badge.paused {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

/* PROGRESS */
.tanda-progress {
    margin-bottom: 16px;
}

.progress-info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 14px;
    color: var(--text-secondary);
}

.progress-bar {
    height: 8px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--tanda-cyan), var(--tanda-cyan-light));
    transition: width 0.3s ease;
}

/* INFO GRID */
.tanda-info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
}

@media (min-width: 480px) {
    .tanda-info-grid {
        grid-template-columns: repeat(4, 1fr);
    }
}

.info-item {
    display: flex;
    gap: 8px;
    align-items: center;
    padding: 8px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
}

.info-item i {
    font-size: 16px;
    color: var(--tanda-cyan);
}

.info-item small {
    display: block;
    font-size: 11px;
    color: var(--text-secondary);
}

.info-item strong {
    display: block;
    font-size: 13px;
    color: var(--text-primary);
}

/* ACTIONS */
.tanda-actions {
    display: flex;
    gap: 8px;
}

.tanda-actions button {
    flex: 1;
    min-height: 44px; /* iOS touch target */
}

/* TANDAS GRID */
.tandas-grid {
    display: grid;
    gap: 16px;
}

/* EMPTY STATE */
.tandas-empty-state {
    text-align: center;
    padding: 60px 20px;
}

.tandas-empty-state i {
    font-size: 64px;
    color: var(--text-secondary);
    margin-bottom: 20px;
    display: block;
}

.tandas-empty-state h3 {
    margin: 0 0 12px 0;
    color: var(--text-primary);
}

.tandas-empty-state p {
    color: var(--text-secondary);
    margin-bottom: 24px;
}

/* LOADING STATE */
.loading-state {
    text-align: center;
    padding: 40px 20px;
}

.loading-spinner {
    margin-bottom: 16px;
}

.loading-spinner i {
    font-size: 32px;
    color: var(--tanda-cyan);
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Disable animations on mobile */
@media (prefers-reduced-motion: reduce) {
    .loading-spinner i {
        animation: none;
    }
}

/* TANDAS CONTROLS */
.tandas-controls {
    margin-bottom: 24px;
}

.tandas-filters {
    display: grid;
    gap: 16px;
}

@media (min-width: 768px) {
    .tandas-filters {
        grid-template-columns: 1fr 1fr;
    }
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.filter-group label {
    font-size: 14px;
    color: var(--text-secondary);
}

.filter-group select {
    padding: 12px;
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid var(--border-accent);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 14px;
}

    </style>

            <!-- Stats Summary -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-value" id="totalGroups">0</div>
                <div class="stat-label">Total Grupos</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="activeGroups">0</div>
                <div class="stat-label">Activos</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="pendingPayments">0</div>
                <div class="stat-label">Pagos Pendientes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalPaid">L. 0</div>
                <div class="stat-label">Total Pagado</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalAlerts">0</div>
                <div class="stat-label">Alertas</div>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar">
            <div class="filter-group">
                <label for="filterRole">Filtrar por Rol</label>
                <select id="filterRole">
                    <option value="all">Todos los Roles</option>
                    <option value="creator">Creador</option>
                    <option value="coordinator">Coordinador</option>
                    <option value="member">Miembro</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filterPayment">Estado de Pago</label>
                <select id="filterPayment">
                    <option value="all">Todos</option>
                    <option value="up_to_date">Al día</option>
                    <option value="pending">Pendiente</option>
                    <option value="late">Atrasado</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="searchGroups">Buscar Grupo</label>
                <input type="text" id="searchGroups" placeholder="Nombre del grupo...">
            </div>
        </div>

        <!-- Groups Grid -->
        <div id="groupsContainer">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Cargando tus grupos...</p>
            </div>

            <script>

    // XSS prevention helper (v3.99.0)
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = String(text != null ? text : '');
        return div.innerHTML.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }
// ===== CONFIGURATION =====
        const API_BASE = 'https://latanda.online';
        // ===== GLOBAL AUTH HELPER =====
        // Auth headers - Local definition for immediate use (shared-components.js overrides when loaded)
        window.getAuthHeaders = function() {
            const token = localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token') || '';
            return token ? { 'Authorization': 'Bearer ' + token } : {};
        }


        function getCurrentUserId() {
            try {
                // 1. Variables globales (si existen)
                if (typeof currentUser !== "undefined" && currentUser && currentUser.id) {
                    return String(currentUser.id);
                }
                if (typeof userData !== "undefined" && userData && userData.id) {
                    return String(userData.id);
                }

                // 2. latanda_user (fuente principal)
                const latandaUser = localStorage.getItem("latanda_user") ||
                                   sessionStorage.getItem("latanda_user");
                if (latandaUser) {
                    const parsed = JSON.parse(latandaUser);
                    if (parsed.id) return String(parsed.id);
                    if (parsed.user_id) return String(parsed.user_id);
                }

                // 3. Fallbacks de compatibilidad
                const fallbackId = localStorage.getItem("latanda_user_id") ||
                                  sessionStorage.getItem("latanda_user_id") ||
                                  localStorage.getItem("userId") ||
                                  localStorage.getItem("user_id");
                if (fallbackId) return String(fallbackId);

                // 4. No autenticado
                return null;

            } catch (error) {
                return null;
            }
        }


        const USER_ID = getCurrentUserId();

        // ===== STATE =====
        let allGroups = [];
        let filteredGroups = [];

        // ===== ROLE & STATUS LABELS =====
        const roleLabels = {
            creator: 'Creador',
            coordinator: 'Coordinador',
            member: 'Miembro'
        };

        const paymentStatusLabels = {
            up_to_date: 'Al día',
            pending: 'Pendiente',
            late: 'Atrasado',
            suspended: 'Suspendido'
        };

        const alertIcons = {
            success: '✓',
            warning: '⚠',
            danger: '✕',
            info: 'ℹ'
        };

        // ===== POSTGRESQL DATA ADAPTER =====
        // Adapts PostgreSQL data structure to expected frontend format
        function adaptPostgreSQLGroup(pgGroup) {
            return {
                // IDs - handle both naming conventions
                id: pgGroup.group_id || pgGroup.id,
                group_id: pgGroup.group_id || pgGroup.id,
                
                // Basic data (exists in PostgreSQL)
                name: pgGroup.name || 'Sin nombre',
                description: pgGroup.description || '',
                category: pgGroup.category || 'general',
                location: pgGroup.location || '',
                contribution_amount: parseFloat(pgGroup.contribution_amount || 0),
                frequency: pgGroup.frequency || 'monthly',
                max_members: pgGroup.max_members || 0,
                status: pgGroup.status || 'active',
                start_date: pgGroup.start_date,
                lottery_scheduled_at: pgGroup.lottery_scheduled_at,
                lottery_executed_at: pgGroup.lottery_executed_at,
                lottery_executed: pgGroup.lottery_executed,
                created_at: pgGroup.created_at,
                total_amount_collected: parseFloat(pgGroup.total_amount_collected || 0),
                admin_id: pgGroup.admin_id,
                
                // Field with different name
                members_count: pgGroup.member_count || 0,
                total_positions: pgGroup.total_positions || pgGroup.member_count || 0,
                
                // Default values for missing fields (to prevent errors)
                my_role: pgGroup.my_role || 'creator',  // Assume creator for now (user is admin_id)
                my_payment_status: pgGroup.my_payment_status || 'up_to_date',  // Default status
                my_days_late: pgGroup.my_days_late || 0,
                my_next_payment_due: pgGroup.my_next_payment_due,
                my_total_paid: parseFloat(pgGroup.my_total_paid || 0),
                my_turn_number: pgGroup.my_turn_number,
                turns_until_mine: pgGroup.turns_until_mine,
                my_alerts: pgGroup.my_alerts || [],  // Empty array to prevent .length error
                has_active_tanda: pgGroup.has_active_tanda || false,
                current_turn_number: null,
                current_turn_recipient: null
            };
        }

        // ===== FETCH GROUPS =====
        async function fetchMyGroups() {
            try {
                // Get auth token from session
                const session = (() => { const token = localStorage.getItem("auth_token"); const user = localStorage.getItem("latanda_user"); return (token && user) ? { user: JSON.parse(user), token: token } : {}; })();
                const authToken = session.token || '';

                const response = await fetch(`${API_BASE}/api/groups/my-groups-pg?user_id=${USER_ID}`, {
                    headers: { ...getAuthHeaders(),
                        'Content-Type': 'application/json',
                        'Authorization': authToken ? `Bearer ${authToken}` : ''
                    }
                });
                const data = await response.json();

                if (data.success) {
                    allGroups = data.data.groups.map(adaptPostgreSQLGroup);
                    window.currentGroupsData = allGroups;  // Exponer para modal Administrar
                    filteredGroups = [...allGroups];
                    updateStats();
                    renderGroups();

                    // Also refresh tandas tab to sync turn positions
                    if (typeof refreshTandas === 'function') {
                        refreshTandas();
                    }

                    // ✅ Check if there's a newly created group to highlight
                    const newlyCreatedId = sessionStorage.getItem('newly_created_group_id');
                    if (newlyCreatedId) {
                        highlightNewGroup(newlyCreatedId);
                        sessionStorage.removeItem('newly_created_group_id');
                    }
                } else {
                    showError('Error al cargar grupos');
                }
            } catch (error) {
                showError('Error de conexión');
            }
        }

        // ===== UPDATE STATS =====
        function updateStats() {
            // Calculate real stats from allGroups data
            
            const activeGroups = allGroups.filter(g => g.status === 'active');
            
            // Count pending payments (groups where my_payment_status is pending or late)
            const pendingCount = allGroups.filter(g => 
                g.my_payment_status === 'pending' || g.my_payment_status === 'late'
            ).length;
            
            // Sum total paid across all groups
            const totalPaidSum = allGroups.reduce((sum, g) => sum + (g.my_total_paid || 0), 0);
            
            // Count total alerts
            const alertsCount = allGroups.reduce((sum, g) => sum + (g.my_alerts?.length || 0), 0);
            
            const stats = {
                total: allGroups.length,
                active: activeGroups.length,
                pendingPayments: pendingCount,
                totalPaid: totalPaidSum,
                totalAlerts: alertsCount
            };

            document.getElementById('totalGroups').textContent = stats.total;
            document.getElementById('activeGroups').textContent = stats.active;
            document.getElementById('pendingPayments').textContent = stats.pendingPayments;
            document.getElementById('totalPaid').textContent = `L. ${stats.totalPaid.toLocaleString()}`;
            document.getElementById('totalAlerts').textContent = stats.totalAlerts;
        }

        // ===== RENDER GROUPS =====
        function renderGroups() {
            const container = document.getElementById('groupsContainer');

            if (filteredGroups.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📭</div>
                        <h3>No hay grupos</h3>
                        <p>No se encontraron grupos que coincidan con los filtros.</p>
                        <button class="btn btn-primary" onclick="resetFilters()">Limpiar Filtros</button>
                    </div>
                `;
                return;
            }

            const html = `
                <div class="groups-grid">
                    ${filteredGroups.map(group => renderGroupCard(group)).join('')}
                </div>
            `;

            container.innerHTML = html;
            
            // Dispatch event for position requests to load
            setTimeout(() => {
                window.dispatchEvent(new CustomEvent('groupsRendered'));
            }, 100);
        }

        // ===== CALCULO DE COMISION DE PLATAFORMA =====
        // Comision variable: <L.50k=3%, L.50k-100k=2%, >L.100k=1%
        function calculatePlatformFee(totalPool) {
            if (totalPool < 50000) return totalPool * 0.03;      // 3%
            if (totalPool <= 100000) return totalPool * 0.02;   // 2%
            return totalPool * 0.01;                             // 1%
        }
        
        function getCommissionRate(totalPool) {
            if (totalPool < 50000) return 3;
            if (totalPool <= 100000) return 2;
            return 1;
        }
        
        function calculatePayoutBreakdown(contributionAmount, memberCount) {
            const totalPool = contributionAmount * memberCount;
            const platformFee = calculatePlatformFee(totalPool);
            const commissionRate = getCommissionRate(totalPool);
            const userReceives = totalPool - platformFee;
            
            return {
                contribution_amount: contributionAmount,
                member_count: memberCount,
                total_pool: totalPool,
                platform_fee: platformFee,
                commission_rate: commissionRate,
                user_receives: userReceives
            };
        }
        
        // Calcular fecha limite de payout
        function calculatePayoutDeadline(startDate, frequency, turnNumber, gracePeriod) {
            const intervals = { weekly: 7, biweekly: 14, monthly: 30 };
            const daysInterval = intervals[frequency] || 30;
            
            const deadline = new Date(startDate);
            deadline.setDate(deadline.getDate() + (turnNumber * daysInterval) + gracePeriod);
            return deadline;
        }
        
        // Verificar si se puede procesar el payout
        function canProcessPayout(group, currentTurn) {
            const totalExpected = (group.contribution_amount || 0) * (group.member_count || group.max_members || 1);
            const totalCollected = group.current_cycle_collected || group.total_amount_collected || 0;
            
            // Condicion 1: Todo recaudado
            if (totalCollected >= totalExpected) return {
                        can: true, reason: "all_paid" };
            
            // Condicion 2: Periodo de gracia cumplido
            if (group.start_date) {
                const deadline = calculatePayoutDeadline(
                    group.start_date,
                    group.frequency,
                    currentTurn || 1,
                    group.grace_period || 3
                );
                if (new Date() >= deadline) return {
                        can: true, reason: "deadline_passed" };
            }
            
            return {
                        can: false, reason: "waiting" };
        }

        // ===== RENDER GROUP CARD =====
        // ===== RENDER GROUP CARD (COMPLETE VERSION WITH ALERTS) =====
        function renderGroupCard(group) {
            const statusLabels = {
                'active': 'Activo',
                'pending': 'Pendiente',
                'completed': 'Completado',
                'cancelled': 'Cancelado',
                'paused': 'Pausado'
            };
            
            const frequencyLabels = {
                'weekly': 'Semanal',
                'biweekly': 'Quincenal',
                'monthly': 'Mensual'
            };

            const roleLabels = {
                'creator': 'Administrador',
                'coordinator': 'Coordinador',
                'member': 'Miembro'
            };

            const paymentStatusLabels = {
                'up_to_date': 'Al día',
                'pending': 'Pendiente',
                'late': 'Atrasado',
                'suspended': 'Suspendido'
            };

            const alertIcons = {
                'success': '✓',
                'warning': '⚠',
                'danger': '✕',
                'info': 'ℹ'
            };

            // Build payment badge with days late
            // Check if due date is actually in the future (timezone fix)
            let effectivePaymentStatus = group.my_payment_status;
            if (group.my_payment_status === 'pending' && group.my_next_payment_due) {
                const dueDate = new Date(group.my_next_payment_due.split('T')[0] + 'T23:59:59');
                if (dueDate > new Date()) {
                    effectivePaymentStatus = 'up_to_date'; // Due date is still in the future
                }
            }
            let paymentBadgeText = paymentStatusLabels[effectivePaymentStatus] || effectivePaymentStatus;
            if (effectivePaymentStatus === 'late' && group.my_days_late > 0) {
                paymentBadgeText += ` (${group.my_days_late}d)`;
            }

            // Calcular desglose de payout (lo que el usuario recibira)
            const memberCount = group.max_members || group.members_count || 1; // Usar max_members para calcular pozo total del ciclo
            const payout = calculatePayoutBreakdown(parseFloat(group.contribution_amount) || 0, memberCount);

            return `
                <div class="group-card" data-group-id="${group.id}">
                    <div class="group-header">
                        <div class="group-title">
                            ${group.description ? `
                            <div class="group-title-wrapper">
                                <h3>${escapeHtml(group.name)}</h3>
                                <div class="tooltip">${escapeHtml(group.description)}</div>
                            </div>
                            ` : `<h3>${escapeHtml(group.name)}</h3>`}
                            <div class="group-category">${escapeHtml(group.category)}</div>
                            ${group.location ? `<div class="location-badge">📍 ${escapeHtml(group.location)}</div>` : ''}
                        </div>
                    </div>

                    <div class="badges">
                        <span class="badge badge-status ${group.status}">${statusLabels[group.status] || group.status}</span>
                        <span class="badge badge-role">${roleLabels[group.my_role] || group.my_role}</span>
                        <span class="badge badge-payment ${effectivePaymentStatus}">${paymentBadgeText}</span>
                        ${(group.members_count >= group.max_members) ? '<span class="badge badge-goal-reached">🎯 Meta alcanzada</span>' : ''}
                    </div>

                    <div class="group-info">
                        <div class="info-row">
                            <span class="info-label">Aporte ${frequencyLabels[group.frequency] || group.frequency}</span>
                            <span class="info-value highlight">L. ${parseFloat(group.contribution_amount).toLocaleString()}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Recibes en tu turno</span>
                            <span class="info-value" style="color: var(--tanda-cyan);" title="Total del pozo: L.${payout.total_pool.toLocaleString()} - ${payout.commission_rate}% comisión">L. ${payout.user_receives.toLocaleString()}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Frecuencia</span>
                            <span class="info-value">${frequencyLabels[group.frequency] || group.frequency}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Miembros</span>
                            <span class="info-value">${group.total_positions || group.members_count || 0} / ${group.max_members} <span style="font-size: 0.7rem; color: #9ca3af;">(${group.members_count || 0} miembros)</span></span>
                        </div>
                        ${(group.start_date || group.my_next_payment_due) ? `
                        <div class="info-row">
                            <span class="info-label">${parseFloat(group.total_amount_collected || 0) > 0 ? "Próximo pago" : "Primer pago"}</span>
                            <span class="info-value">${new Date((group.start_date || group.my_next_payment_due).split("T")[0] + "T12:00:00").toLocaleDateString('es-HN')}</span>
                        </div>
                        ` : ''}
                        ${group.my_total_paid > 0 ? `
                        <div class="info-row">
                            <span class="info-label">Total Pagado</span>
                            <span class="info-value highlight">L. ${parseFloat(group.my_total_paid).toLocaleString()}</span>
                        </div>
                        ` : ''}
                        <div class="info-row">
                            <span class="info-label">Total Recaudado</span>
                            <span class="info-value">L. ${parseFloat(group.total_amount_collected || 0).toLocaleString()}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Creado</span>
                            <span class="info-value">${new Date(group.created_at).toLocaleDateString('es-HN')}</span>
                        </div>
                    </div>

                    ${group.my_alerts && group.my_alerts.length > 0 ? `
                    <div class="alerts">
                        ${group.my_alerts.map(alert => `
                            <div class="alert ${alert.severity}">
                                <span class="alert-icon">${alertIcons[alert.severity]}</span>
                                <span class="alert-message">${escapeHtml(alert.message)}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}

                    <div class="group-actions">
                        <button class="btn btn-primary" onclick="viewGroup('${group.id}')">Ver Detalles</button>
                        ${['creator', 'coordinator', 'admin'].includes(group.my_role)
                            ? `<button class="btn btn-secondary" onclick="manageGroup('${group.id}')">Administrar</button>
                               <button class="btn-manage-members" data-group-id="${group.id}" data-group-name="${escapeHtml(group.name)}" onclick="openMemberManagementSafe(this)" title="Gestionar miembros">
                                   &#x1F465; Miembros
                               </button>`
                            : `<button class="btn btn-secondary" onclick="viewGroup('${group.id}')">Ver Grupo</button>`
                        }
                    </div>
                </div>
            `;
        }

        // ===== FILTERS (SIMPLIFIED) =====
        function applyFilters() {
            const roleFilter = document.getElementById('filterRole') ? document.getElementById('filterRole').value : 'all';
            const paymentFilter = document.getElementById('filterPayment') ? document.getElementById('filterPayment').value : 'all';
            const searchTerm = document.getElementById('searchGroups') ? document.getElementById('searchGroups').value.toLowerCase() : '';

            filteredGroups = allGroups.filter(group => {
                const matchesRole = roleFilter === 'all' || (group.my_role && group.my_role === roleFilter);
                const matchesPayment = paymentFilter === 'all' || (group.my_payment_status && group.my_payment_status === paymentFilter);
                const matchesSearch = !searchTerm || (group.name && group.name.toLowerCase().includes(searchTerm));

                return matchesRole && matchesPayment && matchesSearch;
            });

            renderGroups();

                    // Also refresh tandas tab to sync turn positions
                    if (typeof refreshTandas === 'function') {
                        refreshTandas();
                    }
        }

        function resetFilters() {
            document.getElementById('filterRole').value = 'all';
            document.getElementById('filterPayment').value = 'all';
            document.getElementById('searchGroups').value = '';
            filteredGroups = [...allGroups];
            renderGroups();

                    // Also refresh tandas tab to sync turn positions
                    if (typeof refreshTandas === 'function') {
                        refreshTandas();
                    }
        }

        // ===== ACTIONS =====
        function viewGroup(groupId) {

            // Store selected group ID for detail view
            sessionStorage.setItem('selected_group_id', groupId);

            // Switch to tandas tab (group details)
            switchTab('tandas');

            // Trigger event for other sections to load group details
            window.dispatchEvent(new CustomEvent('groupSelected', {
                detail: { groupId: groupId }
            }));
        }

        function registerPayment(groupId) {

            // Check if payment integration manager exists
            if (window.paymentIntegrationManager) {
                const group = allGroups.find(g => g.id === groupId);
                if (group) {
                    // Open payment modal with group context
                    window.paymentIntegrationManager.openPaymentModal({
                        groupId: groupId,
                        amount: group.contribution_amount,
                        currency: 'HNL',
                        description: `Pago para ${escapeHtml(group.name)}`,
                        metadata: {
                            group_name: group.name,
                            payment_type: 'contribution'
                        }
                    });
                } else {
                    showError('Grupo no encontrado');
                }
            } else {
                // Fallback: navigate to payment page with group ID
                window.location.href = `/payment.html?group_id=${groupId}`;
            }
        }

        function handleAlertAction(groupId, actionUrl, alertType) {

            // Handle different action types
            switch (alertType) {
                case 'payment_due':
                case 'payment_overdue':
                    // Open payment registration
                    registerPayment(groupId);
                    break;

                case 'turn_upcoming':
                case 'your_turn_now':
                case 'can_advance_turn':
                    // Navigate to group details to see turn calendar
                    viewGroup(groupId);
                    break;

                case 'pending_approvals':
                    // Navigate to group admin section
                    viewGroup(groupId);
                    setTimeout(() => {
                        window.dispatchEvent(new CustomEvent('showAdminPanel', {
                            detail: { groupId: groupId }
                        }));
                    }, 500);
                    break;

                case 'late_members':
                    // Navigate to group details to see member list
                    viewGroup(groupId);
                    setTimeout(() => {
                        window.dispatchEvent(new CustomEvent('showMembersList', {
                            detail: { groupId: groupId, filter: 'late' }
                        }));
                    }, 500);
                    break;

                default:
                    // Generic navigation to action URL
                    if (actionUrl) {
                        if (actionUrl.startsWith('/') || actionUrl.startsWith('http')) {
                            window.location.href = actionUrl;
                        } else {
                            viewGroup(groupId);
                        }
                    }
            }
        }

        function getActionLabel(alertType) {
            const labels = {
                'payment_due': 'Pagar',
                'payment_overdue': 'Pagar Ahora',
                'turn_upcoming': 'Ver Calendario',
                'your_turn_now': 'Ver Estado',
                'pending_approvals': 'Aprobar',
                'can_advance_turn': 'Avanzar',
                'late_members': 'Ver Lista'
            };
            return labels[alertType] || 'Acción';
        }

        // ===== HIGHLIGHTING DE GRUPO RECIÉN CREADO =====
        function highlightNewGroup(groupId) {

            setTimeout(() => {
                // Find the group card by data attribute
                const groupCard = document.querySelector(`[data-group-id="${groupId}"]`);

                if (groupCard) {
                    // Add highlight class
                    groupCard.classList.add('newly-created');

                    // Scroll into view
                    groupCard.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });


                    // Remove highlight after 4 seconds
                    setTimeout(() => {
                        groupCard.classList.remove('newly-created');
                    }, 4000);
                } else {
                }
            }, 800); // Delay to ensure cards are rendered
        }

        // ===== UTILITIES =====
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-HN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        // ============================================
        // DATE HELPERS - Parse dates safely
        // ============================================
        
        // Parse date safely, avoiding timezone issues with DATE-only strings
        function parseDateLocal(dateString) {
            if (!dateString) return null;
            // If it is a DATE string (YYYY-MM-DD without time), add T00:00:00 to parse as local
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                return new Date(dateString + "T00:00:00");
            }
            // Otherwise parse normally (includes timestamp)
            return new Date(dateString);
        }

        function formatDateLocal(dateString) {
            var date = parseDateLocal(dateString);
            if (!date || isNaN(date)) return "";
            return date.toLocaleDateString("es-HN", {
                year: "numeric",
                month: "short",
                day: "numeric"
            });
        }



        // =====================================================================
        // POSITION ASSIGNMENT COMPONENT
        // =====================================================================
// =====================================================================
// POSITION ASSIGNMENT COMPONENT FOR COORDINATORS
// To be integrated into groups-advanced-system.html
// =====================================================================

// ===== POSITION ASSIGNMENT RENDERING =====

/**
 * Renders the position assignment section for a group in awaiting_positions status
 * This appears inside the group card for coordinators
 */
function renderPositionAssignmentSection(group) {
    if (group.status !== 'awaiting_positions') {
        return ''; // Only show for groups in position assignment phase
    }

    // Only show for creators/coordinators
    if (group.my_role !== 'creator' && group.my_role !== 'coordinator') {
        return '';
    }

    const positions = group.positions || [];
    const positionRequests = group.position_requests || [];
    const pendingRequests = positionRequests.filter(r => r.status === 'pending');
    const assignedCount = positions.filter(p => p.status === 'confirmed').length;
    const totalPositions = group.participant_count || group.max_members;
    const isComplete = assignedCount === totalPositions;

    return `
        <div class="position-assignment-section">
            <div class="position-header">
                <h4>📍 Asignación de Posiciones</h4>
                <div class="position-progress">
                    <span class="progress-text">${assignedCount}/${totalPositions} asignadas</span>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${(assignedCount / totalPositions) * 100}%"></div>
                    </div>
                </div>
            </div>



            <div class="positions-grid-section">
                <h5>🎯 Estado de Posiciones</h5>
                <div class="positions-grid">
                    ${Array.from({ length: totalPositions }, (_, i) => {
                        const posNum = i + 1;
                        const pos = positions.find(p => p.position === posNum);
                        return renderPositionCell(posNum, pos, group.id);
                    }).join('')}
                </div>
            </div>

            <div class="position-actions">
                ${!isComplete ? `
                    <button class="btn btn-secondary btn-sm" onclick="autoAssignPositions('${group.id}', 'random')">
                        🎲 Asignar Aleatorio
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="autoAssignPositions('${group.id}', 'order')">
                        📋 Asignar por Orden
                    </button>
                ` : ''}

                ${isComplete ? `
                    <button class="btn btn-primary" onclick="activateTanda('${group.id}')">
                        ✅ Activar Grupo
                    </button>
                ` : `
                    <button class="btn btn-disabled" disabled>
                        🔒 Completa asignaciones para activar
                    </button>
                `}
            </div>
        </div>
    `;
}

/**
 * Renders individual request card with approve/reject actions
 */
function renderRequestCard(request, groupId) {
    return `
        <div class="request-card" data-request-id="${request.id}">
            <div class="request-info">
                <div class="request-user">
                    <strong>${escapeHtml(request.user_name || request.user_id)}</strong>
                    <span class="request-position-badge">Posición #${request.requested_position}</span>
                </div>
                ${request.reason ? `
                    <div class="request-reason">
                        <em>"${escapeHtml(request.reason)}"</em>
                    </div>
                ` : ''}
                <div class="request-date">
                    ${formatRequestDate(request.created_at)}
                </div>
            </div>
            <div class="request-actions">
                <button class="btn btn-success btn-sm" onclick="approvePositionRequest('${groupId}', '${request.id}')">
                    ✓ Aprobar
                </button>
                <button class="btn btn-danger btn-sm" onclick="openRejectModal('${groupId}', '${request.id}')">
                    ✕ Rechazar
                </button>
            </div>
        </div>
    `;
}

/**
 * Renders individual position cell in the grid
 */
function renderPositionCell(positionNumber, positionData, groupId) {
    if (!positionData || positionData.status !== 'confirmed') {
        // Available position
        return `
            <div class="position-cell available" onclick="openManualAssignModal('${groupId}', ${positionNumber})">
                <div class="position-number">${positionNumber}</div>
                <div class="position-status">Disponible</div>
            </div>
        `;
    }

    // Assigned position
    const assignmentTypeLabel = {
        'approved': '✓ Aprobada',
        'manual': '✍ Manual',
        'random': '🎲 Aleatoria',
        'auto': '⚡ Auto'
    }[positionData.assignment_type] || 'Asignada';

    return `
        <div class="position-cell assigned ${positionData.assignment_type}">
            <div class="position-number">${positionNumber}</div>
            <div class="position-user">${positionData.user_name || positionData.user_id}</div>
            <div class="position-type">${assignmentTypeLabel}</div>
        </div>
    `;
}

// ===== API INTERACTION FUNCTIONS =====

/**
 * Approve a position request
 */
async function approvePositionRequest(groupId, requestId) {
    try {
        showLoading('Aprobando solicitud...');

        const session = (() => { const token = localStorage.getItem("auth_token"); const user = localStorage.getItem("latanda_user"); return (token && user) ? { user: JSON.parse(user), token: token } : {}; })();
        const response = await fetch(`${API_BASE}/api/groups/approve-position-request`, {
            method: 'POST',
            headers: { ...getAuthHeaders(),
                'Content-Type': 'application/json',
                'Authorization': session.token ? `Bearer ${session.token}` : ''
            },
            body: JSON.stringify({
                request_id: requestId,
                group_id: groupId,
                approved_by: USER_ID
            })
        });

        const data = await response.json();
        hideLoading();

        if (data.success) {
            showNotification('✅ Solicitud aprobada exitosamente', 'success');
            await fetchMyGroups(); // Reload groups to show updated state
        } else {
            showNotification('❌ Error: ' + (data.error || 'No se pudo aprobar'), 'error');
        }
    } catch (error) {
        hideLoading();
        showNotification('❌ Error de conexión', 'error');
    }
}

/**
 * Open modal to reject request with reason
 */
function openRejectModal(groupId, requestId) {
    const modal = document.getElementById('rejectModal') || createRejectModal();
    modal.dataset.groupId = groupId;
    modal.dataset.requestId = requestId;
    modal.style.display = 'flex'; modal.classList.add('active');
}

/**
 * Reject a position request with reason
 */
async function rejectPositionRequest(groupId, requestId, reason) {
    try {
        showLoading('Rechazando solicitud...');

        const session = (() => { const token = localStorage.getItem("auth_token"); const user = localStorage.getItem("latanda_user"); return (token && user) ? { user: JSON.parse(user), token: token } : {}; })();
        const response = await fetch(`${API_BASE}/api/groups/reject-position-request`, {
            method: 'POST',
            headers: { ...getAuthHeaders(),
                'Content-Type': 'application/json',
                'Authorization': session.token ? `Bearer ${session.token}` : ''
            },
            body: JSON.stringify({
                request_id: requestId,
                group_id: groupId,
                rejected_by: USER_ID,
                reason: reason
            })
        });

        const data = await response.json();
        hideLoading();

        if (data.success) {
            showNotification('✅ Solicitud rechazada', 'success');
            closeRejectModal();
            await fetchMyGroups();
        } else {
            showNotification('❌ Error: ' + (data.error || 'No se pudo rechazar'), 'error');
        }
    } catch (error) {
        hideLoading();
        showNotification('❌ Error de conexión', 'error');
    }
}

/**
 * Open modal to manually assign position to a user
 */
function openManualAssignModal(groupId, positionNumber) {
    const modal = document.getElementById('manualAssignModal') || createManualAssignModal();
    modal.dataset.groupId = groupId;
    modal.dataset.positionNumber = positionNumber;
    modal.style.display = 'flex'; modal.classList.add('active');

    // Load users without positions for this group
    loadUsersWithoutPositions(groupId);
}

/**
 * Manually assign position to user
 */
async function assignPositionManually(groupId, positionNumber, userId, userName) {
    try {
        showLoading('Asignando posición...');

        const session = (() => { const token = localStorage.getItem("auth_token"); const user = localStorage.getItem("latanda_user"); return (token && user) ? { user: JSON.parse(user), token: token } : {}; })();
        const response = await fetch(`${API_BASE}/api/groups/assign-position-manually`, {
            method: 'POST',
            headers: { ...getAuthHeaders(),
                'Content-Type': 'application/json',
                'Authorization': session.token ? `Bearer ${session.token}` : ''
            },
            body: JSON.stringify({
                group_id: groupId,
                user_id: userId,
                user_name: userName,
                position: positionNumber,
                assigned_by: USER_ID
            })
        });

        const data = await response.json();
        hideLoading();

        if (data.success) {
            showNotification('✅ Posición asignada exitosamente', 'success');
            closeManualAssignModal();
            await fetchMyGroups();
        } else {
            showNotification('❌ Error: ' + (data.error || 'No se pudo asignar'), 'error');
        }
    } catch (error) {
        hideLoading();
        showNotification('❌ Error de conexión', 'error');
    }
}

/**
 * Auto-assign all remaining positions
 */
async function autoAssignPositions(groupId, method = 'random') {
    if (!confirm(`¿Asignar automáticamente las posiciones restantes por método ${method === 'random' ? 'aleatorio' : 'de orden de ingreso'}?`)) {
        return;
    }

    try {
        showLoading('Asignando posiciones automáticamente...');

        const session = (() => { const token = localStorage.getItem("auth_token"); const user = localStorage.getItem("latanda_user"); return (token && user) ? { user: JSON.parse(user), token: token } : {}; })();
        const response = await fetch(`${API_BASE}/api/groups/auto-assign-positions`, {
            method: 'POST',
            headers: { ...getAuthHeaders(),
                'Content-Type': 'application/json',
                'Authorization': session.token ? `Bearer ${session.token}` : ''
            },
            body: JSON.stringify({
                group_id: groupId,
                method: method,
                assigned_by: USER_ID
            })
        });

        const data = await response.json();
        hideLoading();

        if (data.success) {
            showNotification(`✅ ${data.data.assigned_count} posiciones asignadas`, 'success');
            await fetchMyGroups();
        } else {
            showNotification('❌ Error: ' + (data.error || 'No se pudo auto-asignar'), 'error');
        }
    } catch (error) {
        hideLoading();
        showNotification('❌ Error de conexión', 'error');
    }
}

/**
 * Activate tanda after all positions assigned
 */
async function activateTanda(groupId) {
    // Check if lottery was executed
    const group = window.currentGroupsData ? window.currentGroupsData.find(g => g.id === groupId || g.group_id === groupId) : null;
    const lotteryExecuted = group ? group.lottery_executed : false;

    let confirmMessage = '¿Activar este grupo? Se generará el calendario de pagos y comenzará el ciclo.';

    if (!lotteryExecuted) {
        confirmMessage = '⚠️ ADVERTENCIA: La tómbola NO se ha ejecutado.\n\n' +
            'Las posiciones actuales de turno serán usadas tal como están.\n\n' +
            '¿Deseas continuar sin sortear las posiciones?';
    }

    if (!confirm(confirmMessage)) {
        return;
    }

    try {
        showLoading('Activando grupo...');

        const session = (() => { const token = localStorage.getItem("auth_token"); const user = localStorage.getItem("latanda_user"); return (token && user) ? { user: JSON.parse(user), token: token } : {}; })();
        const response = await fetch(`${API_BASE}/api/groups/activate-tanda`, {
            method: 'POST',
            headers: { ...getAuthHeaders(),
                'Content-Type': 'application/json',
                'Authorization': session.token ? `Bearer ${session.token}` : ''
            },
            body: JSON.stringify({
                group_id: groupId,
                activated_by: USER_ID
            })
        });

        const data = await response.json();
        hideLoading();

        if (data.success) {
            showNotification('✅ ¡Grupo activado exitosamente! El ciclo ha comenzado.', 'success');
            await fetchMyGroups();
        } else {
            showNotification('❌ Error: ' + (data.error || 'No se pudo activar'), 'error');
        }
    } catch (error) {
        hideLoading();
        showNotification('❌ Error de conexión', 'error');
    }
}

// ===== HELPER FUNCTIONS =====

function formatRequestDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Hace un momento';
    if (diffMins < 60) return `Hace ${diffMins} min`;
    if (diffHours < 24) return `Hace ${diffHours}h`;
    if (diffDays < 7) return `Hace ${diffDays}d`;

    return date.toLocaleDateString();
}

function showLoading(message = 'Cargando...') {
    let loader = document.getElementById('globalLoader');
    if (!loader) {
        loader = document.createElement('div');
        loader.id = 'globalLoader';
        loader.className = 'global-loader';
        loader.innerHTML = `
            <div class="loader-content">
                <div class="loader-spinner"></div>
                <p class="loader-message">${message}</p>
            </div>
        `;
        document.body.appendChild(loader);
    } else {
        loader.querySelector('.loader-message').textContent = message;
    }
    loader.style.display = 'flex';
}

function hideLoading() {
    const loader = document.getElementById('globalLoader');
    if (loader) {
        loader.style.display = 'none';
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.classList.add('show');
    }, 10);

    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// ===== MODAL CREATION FUNCTIONS =====

function createRejectModal() {
    const modal = document.createElement('div');
    modal.id = 'rejectModal';
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Rechazar Solicitud</h3>
                <button class="modal-close" onclick="closeRejectModal()">×</button>
            </div>
            <div class="modal-body">
                <label for="rejectReason">Razón del rechazo (opcional):</label>
                <textarea id="rejectReason" rows="3" placeholder="Explica por qué se rechaza esta solicitud..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeRejectModal()">Cancelar</button>
                <button class="btn btn-danger" onclick="confirmReject()">Rechazar Solicitud</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    return modal;
}

function closeRejectModal() {
    const modal = document.getElementById('rejectModal');
    if (modal) {
        modal.style.display = 'none'; modal.classList.remove('active'); modal.classList.remove('active');
        document.getElementById('rejectReason').value = '';
    }
}

function confirmReject() {
    const modal = document.getElementById('rejectModal');
    const groupId = modal.dataset.groupId;
    const requestId = modal.dataset.requestId;
    const reason = document.getElementById('rejectReason').value.trim();

    rejectPositionRequest(groupId, requestId, reason);
}

function createManualAssignModal() {
    const modal = document.createElement('div');
    modal.id = 'manualAssignModal';
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>Asignar Posición Manualmente</h3>
                <button class="modal-close" onclick="closeManualAssignModal()">×</button>
            </div>
            <div class="modal-body">
                <p>Posición: <strong id="assignPositionNumber">-</strong></p>
                <label for="assignUserId">Seleccionar usuario:</label>
                <select id="assignUserId">
                    <option value="">Cargando usuarios...</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeManualAssignModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmManualAssign()">Asignar</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    return modal;
}

function closeManualAssignModal() {
    const modal = document.getElementById('manualAssignModal');
    if (modal) {
        modal.style.display = 'none'; modal.classList.remove('active'); modal.classList.remove('active');
    }
}

function confirmManualAssign() {
    const modal = document.getElementById('manualAssignModal');
    const groupId = modal.dataset.groupId;
    const positionNumber = parseInt(modal.dataset.positionNumber);
    const select = document.getElementById('assignUserId');
    const userId = select.value;
    const userName = select.options[select.selectedIndex].text;

    if (!userId) {
        showWarning('Por favor selecciona un usuario');
        return;
    }

    assignPositionManually(groupId, positionNumber, userId, userName);
}

async function loadUsersWithoutPositions(groupId) {
    try {
        // Get group details from current state
        const group = allGroups.find(g => g.id === groupId);
        if (!group) return;

        // Find members without confirmed positions
        const assignedUserIds = (group.positions || [])
            .filter(p => p.status === 'confirmed')
            .map(p => p.user_id);

        // Get all members (this would need to come from API in real implementation)
        const response = await fetch(`${API_BASE}/api/groups/${groupId}/members`, {
            headers: { ...getAuthHeaders(),
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${(() => { const token = localStorage.getItem("auth_token"); const user = localStorage.getItem("latanda_user"); return (token && user) ? { user: JSON.parse(user), token: token } : {}; })().token || ''}`
            }
        });

        const data = await response.json();

        if (data.success && data.data && data.data.members) {
            const availableUsers = data.data.members.filter(m => !assignedUserIds.includes(m.user_id));

            const select = document.getElementById('assignUserId');
            select.innerHTML = availableUsers.length > 0
                ? availableUsers.map(u => `<option value="${u.user_id}">${u.name || u.user_id}</option>`).join('')
                : '<option value="">No hay usuarios disponibles</option>';

            document.getElementById('assignPositionNumber').textContent = `#${document.getElementById('manualAssignModal').dataset.positionNumber}`;
        }
    } catch (error) {
        document.getElementById('assignUserId').innerHTML = '<option value="">Error cargando usuarios</option>';
    }
}

        function showError(message) {
        message = escapeHtml(message);
            document.getElementById('groupsContainer').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">⚠️</div>
                    <h3>Error</h3>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="fetchMyGroups()">Reintentar</button>
                </div>
            `;
        }

        // ===== WEBSOCKET INTEGRATION =====
        function initWebSocketListeners() {
            // Check if WebSocket manager is available
            if (window.wsManager) {

                // Listen for group updates
                window.wsManager.on('group_update', (data) => {

                    // If the updated group is in our list, refresh
                    if (data.groupId && allGroups.some(g => g.id === data.groupId)) {
                        fetchMyGroups();
                    }
                });

                // Listen for payment confirmations
                window.wsManager.on('payment_confirmed', (data) => {

                    // If payment is for a group in our list, refresh
                    if (data.groupId && allGroups.some(g => g.id === data.groupId)) {
                        fetchMyGroups();
                    }
                });

                // Listen for general notifications that might affect groups
                window.wsManager.on('notification', (data) => {
                    if (data.type && data.type.includes('group')) {
                        // Optionally refresh groups on relevant notifications
                        fetchMyGroups();
                    }
                });

            } else {
                // Fallback: poll for updates every 60 seconds
                setInterval(() => {
                    fetchMyGroups();
                }, 60000);
            }
        }

        // ===== EVENT LISTENERS =====
        document.getElementById('filterRole').addEventListener('change', applyFilters);
        document.getElementById('filterPayment').addEventListener('change', applyFilters);
        document.getElementById('searchGroups').addEventListener('input', applyFilters);

        // ===== INITIALIZE =====
        fetchMyGroups();

        // Initialize WebSocket listeners after a brief delay to ensure wsManager is loaded
        setTimeout(initWebSocketListeners, 1000);
            </script>
        </section>


        <!-- Create Group Section -->
        <section id="create" class="content-section">
            <div class="section-header">
                <div>
                    <h2><i class="fas fa-plus-circle"></i> <span data-translate="groups.create_new_group">Crear Nuevo Grupo</span></h2>
                    <p class="section-description" data-translate="groups.create_description">Configura un nuevo grupo cooperativo con funciones avanzadas</p>
                </div>
            </div>
            <div class="create-group-form">
                <!-- Progress Bar -->
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 0%;"></div>
                    <div class="step active" data-step="1">
                        <div class="step-number">1</div>
                        <div class="step-title" data-translate="create.step_basic">Básico</div>
                    </div>
                    <div class="step" data-step="2">
                        <div class="step-number">2</div>
                        <div class="step-title" data-translate="create.step_config">Configuración</div>
                    </div>
                    <div class="step" data-step="3">
                        <div class="step-number">3</div>
                        <div class="step-title" data-translate="create.step_advanced">Avanzado</div>
                    </div>
                    <div class="step" data-step="4">
                        <div class="step-number">4</div>
                        <div class="step-title" data-translate="create.step_confirmation">Confirmación</div>
                    </div>
                </div>

                <!-- Multi-Step Form -->
                <form id="create-group-form" class="multi-step-form">
                    <!-- Step 1: Basic Information -->
                    <div class="step-container active" data-step="1">
                        <div class="form-card">
                            <h3><i class="fas fa-info-circle"></i> Información Básica</h3>
                            <p class="step-description">Define los aspectos fundamentales de tu grupo cooperativo</p>
                            
                            <div class="form-group">
                                <label for="group-name">Nombre del Grupo <span class="required">*</span></label>
                                <input type="text" id="group-name" placeholder="Ej: Cooperativa Familiar Norte" required>
                                <div class="help-text">Escoge un nombre descriptivo y fácil de recordar</div>
                                <div class="error-message" id="group-name-error"></div>
                            </div>

                            <div class="form-group">
                                <label for="group-description">Descripción del Grupo <span class="required">*</span></label>
                                <textarea id="group-description" placeholder="Describe el propósito y objetivos del grupo..." maxlength="250" required></textarea>
                                <div class="char-counter"><span id="desc-count">0</span>/250 caracteres</div>
                                <div class="error-message" id="group-description-error"></div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="group-type">Tipo de Grupo <span class="required">*</span></label>
                                    <select id="group-type" required>
                                        <option value="">Seleccionar tipo...</option>
                                        <option value="familiar">Familiar</option>
                                        <option value="laboral">Laboral</option>
                                        <option value="comunitario">Comunitario</option>
                                        <option value="comercial">Comercial</option>
                                    </select>
                                    <div class="error-message" id="group-type-error"></div>
                                </div>

                                <div class="form-group">
                                    <label for="location">Ubicación <span class="required">*</span></label>
                                    <input type="text" id="location" placeholder="Ej: Tegucigalpa, Comayagüela" required>
                                    <div class="error-message" id="location-error"></div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">¿Permites reuniones virtuales?</label>
                                <div class="radio-group">
                                    <label class="radio-option">
                                        <input type="radio" name="virtual-meetings" value="yes" checked>
                                        <span class="radio-custom"></span>
                                        <span>Sí, permitir reuniones online</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="virtual-meetings" value="no">
                                        <span class="radio-custom"></span>
                                        <span>Solo reuniones presenciales</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Financial Configuration -->
                    <div class="step-container" data-step="2">
                        <div class="form-card">
                            <h3><i class="fas fa-dollar-sign"></i> Configuración Financiera</h3>
                            <p class="step-description">Define los aspectos económicos y de participación</p>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="contribution">Contribución Base (L.) <span class="required">*</span></label>
                                    <input type="number" id="contribution" value="1500" min="100" max="50000" required>
                                    <div class="help-text">Monto que cada miembro aporta por ciclo</div>
                                    <div class="error-message" id="contribution-error"></div>
                                </div>

                                <div class="form-group">
                                    <label for="max-participants">Máximo Participantes <span class="required">*</span></label>
                                    <input type="number" id="max-participants" value="12" min="2" max="50" required>
                                    <div class="help-text">Número máximo de miembros en el grupo</div>
                                    <div class="error-message" id="max-participants-error"></div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="payment-frequency">Frecuencia de Pago <span class="required">*</span></label>
                                    <select id="payment-frequency" required>
                                        <option value="">Seleccionar frecuencia...</option>
                                        <option value="weekly">Semanal</option>
                                        <option value="biweekly">Quincenal</option>
                                        <option value="monthly">Mensual</option>
                                    </select>
                                    <div class="error-message" id="payment-frequency-error"></div>
                                </div>

                                <div class="form-group">
                                    <label for="start-date">Fecha de Inicio</label>
                                    <input type="date" id="start-date">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Opciones Adicionales</label>
                                <div class="checkbox-group">
                                    <label class="checkbox-option">
                                        <input type="checkbox" id="early-withdrawals">
                                        <span class="checkbox-custom"></span>
                                        <span>Permitir retiros anticipados (con penalización)</span>
                                    </label>
                                    <label class="checkbox-option">
                                        <input type="checkbox" id="insurance-required">
                                        <span class="checkbox-custom"></span>
                                        <span>Requerir seguro de participación</span>
                                    </label>
                                    <label class="checkbox-option">
                                        <input type="checkbox" id="late-penalties" checked>
                                        <span class="checkbox-custom"></span>
                                        <span>Aplicar multas por pagos tardíos</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Advanced Configuration -->
                    <div class="step-container" data-step="3">
                        <div class="form-card">
                            <h3><i class="fas fa-shield-alt"></i> Configuración Avanzada</h3>
                            <p class="step-description">Establece reglas y políticas del grupo con opciones avanzadas</p>
                            
                            <!-- Collapsible Section: Requisitos de Ingreso -->
                            <div class="collapsible-section">
                                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                    <span>
                                        <i class="fas fa-user-check"></i>
                                        <strong>Requisitos de Ingreso</strong>
                                        <span class="section-description">Define quién puede unirse al grupo</span>
                                    </span>
                                    <i class="fas fa-chevron-down collapsible-icon"></i>
                                </div>
                                <div class="collapsible-content expanded">
                                    <div class="collapsible-inner">
                                        <div class="checkbox-group">
                                            <label class="checkbox-option">
                                                <input type="checkbox" id="require-id" checked>
                                                <span class="checkbox-custom"></span>
                                                <span>Verificación de identidad obligatoria</span>
                                            </label>
                                            <label class="checkbox-option">
                                                <input type="checkbox" id="require-income">
                                                <span class="checkbox-custom"></span>
                                                <span>Comprobante de ingresos</span>
                                            </label>
                                            <label class="checkbox-option">
                                                <input type="checkbox" id="require-references">
                                                <span class="checkbox-custom"></span>
                                                <span>Referencias personales (mín. 2)</span>
                                            </label>
                                            <label class="checkbox-option">
                                                <input type="checkbox" id="require-min-trust-score">
                                                <span class="checkbox-custom"></span>
                                                <span>Puntaje mínimo de confianza: 70%</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Collapsible Section: Reglas y Políticas -->
                            <div class="collapsible-section">
                                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                    <span>
                                        <i class="fas fa-gavel"></i>
                                        <strong>Reglas y Políticas</strong>
                                        <span class="section-description">Establece las normas del grupo</span>
                                    </span>
                                    <i class="fas fa-chevron-down collapsible-icon"></i>
                                </div>
                                <div class="collapsible-content expanded">
                                    <div class="collapsible-inner">
                                        <div class="form-group">
                                            <label for="group-rules">Reglas del Grupo</label>
                                            <textarea id="group-rules" placeholder="Define las reglas específicas del grupo..." rows="4">• Puntualidad en pagos es obligatoria
• Participación en reuniones mensuales  
• Respeto mutuo entre miembros
• Comunicación transparente sobre dificultades financieras</textarea>
                                            <div class="help-text">Estas reglas serán visibles para todos los miembros</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Collapsible Section: Multas y Penalizaciones -->
                            <div class="collapsible-section">
                                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                    <span>
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <strong>Multas y Penalizaciones</strong>
                                        <span class="section-description">Configura sanciones por incumplimiento</span>
                                    </span>
                                    <i class="fas fa-chevron-down collapsible-icon"></i>
                                </div>
                                <div class="collapsible-content">
                                    <div class="collapsible-inner">
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="penalty-amount">Multa por Retraso (L.)</label>
                                                <input type="number" id="penalty-amount" placeholder="50" min="0" max="500" step="25">
                                                <div class="help-text">Multa aplicada por pagos tardíos</div>
                                                <div class="error-message" id="penalty-amount-error"></div>
                                            </div>
                                            <div class="form-group">
                                                <label for="grace-period">Período de Gracia (días)</label>
                                                <input type="number" id="grace-period" placeholder="3" min="0" max="15">
                                                <div class="help-text">Días adicionales sin multa</div>
                                                <div class="error-message" id="grace-period-error"></div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Acciones por Incumplimiento</label>
                                            <div class="checkbox-group">
                                                <label class="checkbox-option">
                                                    <input type="checkbox" id="auto-suspend" checked>
                                                    <span class="checkbox-custom"></span>
                                                    <span>Suspender automáticamente tras 3 faltas</span>
                                                </label>
                                                <label class="checkbox-option">
                                                    <input type="checkbox" id="require-guarantor">
                                                    <span class="checkbox-custom"></span>
                                                    <span>Requerir garante para reincorporación</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Collapsible Section: Notificaciones -->
                            <div class="collapsible-section">
                                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                    <span>
                                        <i class="fas fa-bell"></i>
                                        <strong>Notificaciones Automáticas</strong>
                                        <span class="section-description">Configura recordatorios y alertas</span>
                                    </span>
                                    <i class="fas fa-chevron-down collapsible-icon"></i>
                                </div>
                                <div class="collapsible-content">
                                    <div class="collapsible-inner">
                                        <div class="checkbox-group">
                                            <label class="checkbox-option">
                                                <input type="checkbox" id="notify-payment-reminder" checked>
                                                <span class="checkbox-custom"></span>
                                                <span>Recordatorio de pagos (3 días antes)</span>
                                            </label>
                                            <label class="checkbox-option">
                                                <input type="checkbox" id="notify-meeting-reminder" checked>
                                                <span class="checkbox-custom"></span>
                                                <span>Recordatorio de reuniones</span>
                                            </label>
                                            <label class="checkbox-option">
                                                <input type="checkbox" id="notify-turn-update" checked>
                                                <span class="checkbox-custom"></span>
                                                <span>Actualización de turnos de cobro</span>
                                            </label>
                                            <label class="checkbox-option">
                                                <input type="checkbox" id="notify-new-members">
                                                <span class="checkbox-custom"></span>
                                                <span>Notificar nuevos miembros</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Confirmation -->
                    <div class="step-container" data-step="4">
                        <div class="form-card">
                            <h3><i class="fas fa-check-circle"></i> Confirmación y Resumen</h3>
                            <p class="step-description">Revisa todos los detalles antes de crear el grupo</p>
                            
                            <div class="confirmation-summary" id="confirmationSummary">
                                <!-- Summary will be generated dynamically -->
                            </div>

                            <div class="form-group">
                                <label class="checkbox-option">
                                    <input type="checkbox" id="accept-terms" required>
                                    <span class="checkbox-custom"></span>
                                    <span>Acepto los términos y condiciones de La Tanda</span>
                                </label>
                                <div class="error-message" id="accept-terms-error"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Form Navigation -->
                    <div class="form-navigation">
                        <button type="button" class="btn btn-secondary" id="previous-step" style="display: none;">
                            <i class="fas fa-arrow-left"></i>
                            <span>Anterior</span>
                        </button>
                        <button type="button" class="btn btn-primary" id="next-step">
                            <span>Continuar</span>
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </form>

            <!-- ===== TEMPLATE SELECTOR MODAL ===== -->
            <div id="template-modal" class="modal-overlay" style="display: none;">
                <div class="modal-content template-selector-modal">
                    <div class="modal-header-templates">
                        <h3>🎯 Elige una Plantilla para tu Grupo</h3>
                        <p>Selecciona el tipo de grupo que más se ajuste a tus necesidades. Puedes modificar todos los valores después.</p>
                        <button class="modal-close-templates">&times;</button>
                    </div>
                    <div class="modal-body-templates">
                        <div class="template-grid">

                            <!-- Template Card 1: Familiar Pequeño -->
                            <div class="template-card" data-template="familiar-small">
                                <div class="template-icon">👨‍👩‍👧‍👦</div>
                                <h4>Grupo Familiar Pequeño</h4>
                                <p>Ideal para 6-8 familiares cercanos</p>
                                <div class="template-specs">
                                    <span>💰 L. 1,500/mes</span>
                                    <span>👥 8 miembros</span>
                                </div>
                                <button class="select-template-btn" onclick="selectGroupTemplate('familiar-small')">Seleccionar</button>
                            </div>

                            <!-- Template Card 2: Laboral -->
                            <div class="template-card" data-template="laboral">
                                <div class="template-icon">💼</div>
                                <h4>Grupo Laboral</h4>
                                <p>Para compañeros de trabajo</p>
                                <div class="template-specs">
                                    <span>💰 L. 2,000/quincenal</span>
                                    <span>👥 12 miembros</span>
                                </div>
                                <button class="select-template-btn" onclick="selectGroupTemplate('laboral')">Seleccionar</button>
                            </div>

                            <!-- Template Card 3: Comunitario -->
                            <div class="template-card" data-template="comunitario">
                                <div class="template-icon">🏘️</div>
                                <h4>Grupo Comunitario</h4>
                                <p>Vecinos y comunidad local</p>
                                <div class="template-specs">
                                    <span>💰 L. 500/mes</span>
                                    <span>👥 30 miembros</span>
                                </div>
                                <button class="select-template-btn" onclick="selectGroupTemplate('comunitario')">Seleccionar</button>
                            </div>

                            <!-- Template Card 4: Comercial -->
                            <div class="template-card" data-template="comercial">
                                <div class="template-icon">🏪</div>
                                <h4>Grupo Comercial</h4>
                                <p>Emprendedores y negocios</p>
                                <div class="template-specs">
                                    <span>💰 L. 5,000/quincenal</span>
                                    <span>👥 15 miembros</span>
                                </div>
                                <button class="select-template-btn" onclick="selectGroupTemplate('comercial')">Seleccionar</button>
                            </div>

                            <!-- Template Card 5: Tanda Rápida -->
                            <div class="template-card" data-template="tanda-rapida">
                                <div class="template-icon">⚡</div>
                                <h4>Tanda Rápida Semanal</h4>
                                <p>Ciclo corto, ahorro rápido</p>
                                <div class="template-specs">
                                    <span>💰 L. 500/semana</span>
                                    <span>👥 10 miembros</span>
                                </div>
                                <button class="select-template-btn" onclick="selectGroupTemplate('tanda-rapida')">Seleccionar</button>
                            </div>

                            <!-- Template Card 6: Custom -->
                            <div class="template-card custom-template" data-template="custom">
                                <div class="template-icon">✏️</div>
                                <h4>Custom (Desde Cero)</h4>
                                <p>Configura todo manualmente</p>
                                <div class="template-specs">
                                    <span>🎨 Personalizado 100%</span>
                                </div>
                                <button class="select-template-btn" onclick="selectGroupTemplate('custom')">Empezar</button>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
            <!-- ===== END TEMPLATE SELECTOR MODAL ===== -->

            </div>
        </section>

        <!-- Tandas Section -->
        <section id="tandas" class="content-section">
            <div class="section-header">
                <div>
                    <h2><i class="fas fa-coins"></i> Mis Tandas</h2>
                    <p class="section-description">Tu centro de pagos y cobros</p>
                </div>
                <div class="section-actions">
                    <button class="btn btn-outline" onclick="advancedGroupsSystem.refreshTandas()">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                    <button class="btn btn-primary" onclick="advancedGroupsSystem.showTandaHistory()">
                        <i class="fas fa-history"></i> Historial
                    </button>
                </div>
            </div>


            <!-- Dashboard de Resumen Personal -->
            <div class="tandas-dashboard">
                <div class="dashboard-card urgent" id="nextPaymentCard">
                    <div class="card-icon"><i class="fas fa-exclamation-circle"></i></div>
                    <div class="card-content">
                        <span class="card-label">Próximo Pago</span>
                        <span class="card-value" id="nextPaymentAmount">L. 0.00</span>
                        <span class="card-subtitle" id="nextPaymentDue">Sin pagos pendientes</span>
                    </div>
                    <button class="btn-pay-now" id="btnPayNow" onclick="payNextDue()" style="display:none;">
                        PAGAR AHORA
                    </button>
                </div>

                <div class="dashboard-card success" id="myCollectionCard">
                    <div class="card-icon"><i class="fas fa-hand-holding-usd"></i></div>
                    <div class="card-content">
                        <span class="card-label">Mi Próximo Cobro</span>
                        <span class="card-value" id="myNextCollection">--</span>
                        <span class="card-subtitle" id="myCollectionDate">--</span>
                    </div>
                </div>

                <div class="dashboard-card info clickable" id="summaryCard" onclick="openHistoryModal()" title="Ver historial completo">
                    <div class="card-icon"><i class="fas fa-chart-pie"></i></div>
                    <div class="card-content">
                        <span class="card-label">Resumen</span>
                        <span class="card-value" id="paymentProgress">0/0</span>
                        <span class="card-subtitle" id="totalPaid">L. 0 pagado</span>
                        <div class="summary-progress-bar"><div class="summary-progress-fill" id="summaryProgressFill" style="width: 0%"></div></div>
                    </div>
                </div>
            </div>


            <!-- Filtros y Controles -->
            <div class="tandas-controls">
                <div class="tandas-filters">
                    <div class="filter-group">
                        <label>Filtrar por estado:</label>
                        <select id="tandasStatusFilter" onchange="advancedGroupsSystem.filterTandas()">
                            <option value="all">Todas las tandas</option>
                            <option value="active">Activas</option>
                            <option value="waiting-turn">Esperando turno</option>
                            <option value="collecting">Cobrando este mes</option>
                            <option value="completed">Completadas</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Ordenar por:</label>
                        <select id="tandasSortOrder" onchange="advancedGroupsSystem.sortTandas()">
                            <option value="next-payment">Próximo pago</option>
                            <option value="amount">Monto</option>
                            
                            <option value="turn-position">Posición en turno</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Pagos Pendientes por Urgencia -->
            <div class="payments-urgent-section">
                <h3 style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px; color: var(--text-primary);">
                    <i class="fas fa-clock" style="color: var(--tanda-cyan);"></i> Pagos Pendientes
                </h3>
                <div id="urgentPaymentsList" class="urgent-payments-list">
                    <!-- Se genera dinámicamente -->
                </div>
            </div>

            <!-- Quién Cobra Este Mes -->
            <div class="collectors-section" style="margin-top: 24px;">
                <h3 style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px; color: var(--text-primary);">
                    <i class="fas fa-user-check" style="color: #10b981;"></i> Quién Cobra Este Mes
                </h3>
                <div id="currentCollectorsList" class="collectors-list">
                    <!-- Se genera dinámicamente -->
                </div>
            </div>

            <!-- ====== PAYOUT SYSTEM - Cobro de Tandas ====== -->
            <div id="collectTandaContainer"></div>
            <div id="payoutMethodsContainer"></div>
            <!-- ====== END PAYOUT SYSTEM ======  -->

            <!-- Lista de Tandas (legacy) -->
            <div class="tandas-container">
                <div id="tandasList" class="tandas-grid">
                    <!-- Las tandas se cargan dinámicamente aquí -->
                    <div class="loading-state" id="tandasLoading">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                        <p>Cargando tus tandas...</p>
                    </div>
                </div>
            </div>

        </section>

        <!-- Matching Section -->
        <section id="matching" class="content-section">
            <div class="section-header">
                <div>
                    <h2><i class="fas fa-magic"></i> Matching Inteligente</h2>
                    <p class="section-description">Encuentra grupos y personas compatibles con tu perfil</p>
                </div>
            </div>
            <div id="matchingContainer">
                <!-- Matching suggestions will be loaded here -->
            </div>
        </section>

        <!-- Analytics Section -->
        <section id="analytics" class="content-section">
            <div class="section-header">
                <div>
                    <h2><i class="fas fa-chart-bar"></i> Analíticas y Reportes</h2>
                    <p class="section-description">Revisa tu rendimiento y estadísticas detalladas</p>
                </div>
            </div>
            <div id="analyticsContainer" class="analytics-grid">
                <!-- Analytics will be loaded here -->
            </div>
        </section>

    <!-- Enhanced User Menu Overlay -->
    <div id="userMenuOverlay" class="overlay-menu" style="display: none;">
        <div class="user-menu-panel">
            <div class="user-menu-header">
                <div class="user-profile-card">
                    <div class="user-avatar">
                        <img loading="lazy" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%2300FFFF'/%3E%3Ctext x='50' y='60' text-anchor='middle' fill='%23000' font-size='40' font-weight='bold'%3EU%3C/text%3E%3C/svg%3E" alt="User Avatar">
                    </div>
                    <div class="user-info">
                        <h3 class="user-name">Coordinador Principal</h3>
                        <p class="user-email">coordinador@latanda.online</p>
                        <div class="user-status">
                            <span class="status-indicator active"></span>
                            <span class="status-text">En línea</span>
                        </div>
                    </div>
                    <button class="user-menu-close" onclick="advancedGroupsSystem.closeUserMenu()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            

            <div class="user-menu-navigation">
                <div class="menu-section">
                    <h4 class="section-title">My Account</h4>
                    <a href="#" class="menu-item" onclick="advancedGroupsSystem.openProfile()">
                        <i class="fas fa-user-edit"></i>
                        <span>Edit Profile</span>
                        <i class="fas fa-chevron-right"></i>
                    </a>
                    <a href="#" class="menu-item" onclick="advancedGroupsSystem.openWalletSettings()">
                        <i class="fas fa-wallet"></i>
                        <span>My Billetera</span>
                        <i class="fas fa-chevron-right"></i>
                    </a>
                    <a href="#" class="menu-item" onclick="advancedGroupsSystem.openVerification()">
                        <i class="fas fa-shield-check"></i>
                        <span>Verificación KYC</span>
                        <div class="verification-badge">Verificado</div>
                    </a>
                </div>

                <div class="menu-section">
                    <h4 class="section-title">Configuración</h4>
                    <a href="#" class="menu-item" onclick="advancedGroupsSystem.openNotificationSettings()">
                        <i class="fas fa-bell-slash"></i>
                        <span>Notificaciones</span>
                        <i class="fas fa-chevron-right"></i>
                    </a>
                    <a href="#" class="menu-item" onclick="advancedGroupsSystem.openSecuritySettings()">
                        <i class="fas fa-lock"></i>
                        <span>Security</span>
                        <i class="fas fa-chevron-right"></i>
                    </a>
                    <a href="#" class="menu-item" onclick="advancedGroupsSystem.openPrivacySettings()">
                        <i class="fas fa-user-shield"></i>
                        <span>Privacidad</span>
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </div>

                <div class="menu-section">
                    <h4 class="section-title">Soporte</h4>
                    <a href="#" class="menu-item" onclick="advancedGroupsSystem.openHelp()">
                        <i class="fas fa-question-circle"></i>
                        <span>Centro de Ayuda</span>
                        <i class="fas fa-chevron-right"></i>
                    </a>
                    <a href="#" class="menu-item" onclick="advancedGroupsSystem.openFeedback()">
                        <i class="fas fa-comment-alt"></i>
                        <span>Send Feedback</span>
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </div>

                <div class="menu-section logout-section">
                    <a href="#" class="menu-item logout" onclick="advancedGroupsSystem.logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Cerrar Sesión</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Notifications Panel -->
    <div id="notificationsPanel" class="overlay-menu" style="display: none;">
        <div class="notifications-panel">
            <div class="notifications-header">
                <h3>
                    <i class="fas fa-bell"></i>
                    Notificaciones
                </h3>
                <div class="notifications-actions">
                    <button class="btn-mark-all" onclick="advancedGroupsSystem.markAllAsRead()">
                        Marcar todo como leído
                    </button>
                    <button class="notifications-close" onclick="advancedGroupsSystem.closeNotifications()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="notifications-filters">
                <button class="notification-filter active" data-filter="all">Todas</button>
                <button class="notification-filter" data-filter="urgent">Urgentes</button>
                <button class="notification-filter" data-filter="payments">Pagos</button>
                <button class="notification-filter" data-filter="groups">Groups</button>
                <button class="notification-filter" data-filter="tandas">Tandas</button>
            </div>

            <div class="notifications-list" id="notificationsList">
                <!-- Notifications will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Enhanced Quick Search Overlay -->
    <div id="quickSearchOverlay" class="overlay-menu search-overlay" style="display: none;">
        <div class="search-panel">
            <div class="search-header">
                <div class="search-input-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="quickSearchInput" placeholder="Buscar grupos, tandas, miembros..." autocomplete="off">
                    <button class="search-close" onclick="advancedGroupsSystem.closeQuickSearch()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="search-results" id="quickSearchResults">
                <div class="search-suggestions">
                    <div class="suggestion-category">
                        <h4>Búsquedas rápidas</h4>
                        <div class="suggestion-item" onclick="advancedGroupsSystem.quickSearchAction('groups-active')">
                            <i class="fas fa-users"></i>
                            <span>Groups activos</span>
                        </div>
                        <div class="suggestion-item" onclick="advancedGroupsSystem.quickSearchAction('tandas-pending')">
                            <i class="fas fa-clock"></i>
                            <span>Tandas pendientes</span>
                        </div>
                        <div class="suggestion-item" onclick="advancedGroupsSystem.quickSearchAction('payments-due')">
                            <i class="fas fa-credit-card"></i>
                            <span>Pagos vencidos</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Theme Toggle Confirmation -->
    <div id="themeToggleIndicator" class="theme-indicator" style="display: none;">
        <div class="theme-indicator-content">
            <i class="fas fa-palette"></i>
            <span id="themeIndicatorText">Tema cambiado</span>
        </div>
    </div>

    <!-- Tanda Event Bus for Cross-Page Sync -->
    <script src="tanda-event-bus.js?v=1.0.0"></script>
    <!-- Load JavaScript -->
    <script src="groups-advanced-system-complete.js?v=20251215190800"></script>
    <script src="groups-advanced-system-integration.js?v=1.2.0"></script>
    <script src="notification-system.js"></script>
    <script src="loading-manager.js"></script>
    <script src="error-handler.js"></script>
    <script src="create-group-form-handler-v2.js?v=20260211001"></script>
    <script src="dashboard-metrics-engine.js?v=1.0.0"></script>
    <script src="dashboard-real-time-enhancements.js?v=1.0.3"></script>
    <script src="value-propositions-engine.js?v=1.0.0"></script>
    <!-- DISABLED: Conflicts with groups-advanced-system-complete.js
    <script src="groups-advanced-system.min.js?v=2.0.0"></script>
    -->
    
    <!-- User Menu Modals -->
    
    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="modal-overlay" style="display: none;">
        <div class="modal-container large-modal">
            <div class="modal-header">
                <h2><i class="fas fa-user-edit"></i> Edit Profile</h2>
                <button class="modal-close" onclick="advancedGroupsSystem.closeModal('editProfileModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="profile-edit-container">
                    <div class="profile-avatar-section">
                        <div class="avatar-container">
                            <img loading="lazy" id="profileAvatarPreview" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNTAiIGZpbGw9IiMwMEZGRkYiLz48dGV4dCB4PSI1MCIgeT0iNTUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIzMCIgZmlsbD0iIzBmMTcyYSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+TUE8L3RleHQ+PC9zdmc+" alt="Avatar">
                            <div class="avatar-overlay">
                                <i class="fas fa-camera"></i>
                            </div>
                        </div>
                        <input type="file" id="avatarUpload" accept="image/*" style="display: none;">
                        <button class="btn-secondary" onclick="document.getElementById('avatarUpload').click()">
                            <i class="fas fa-upload"></i> Cambiar Foto
                        </button>
                    </div>
                    
                    <div class="profile-form-section">
                        <form id="profileEditForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="firstName">Nombre</label>
                                    <input type="text" id="firstName" value="María" required>
                                </div>
                                <div class="form-group">
                                    <label for="lastName">Apellido</label>
                                    <input type="text" id="lastName" value="Andrade" required>
                                </div>
                                <div class="form-group">
                                    <label for="email">Correo Electrónico</label>
                                    <input type="email" id="email" value="maria.andrade@ejemplo.com" required>
                                </div>
                                <div class="form-group">
                                    <label for="phone">Teléfono</label>
                                    <input type="tel" id="phone" value="+504 9999-9999" required>
                                </div>
                                <div class="form-group">
                                    <label for="birthDate">Fecha de Nacimiento</label>
                                    <input type="date" id="birthDate" value="1985-06-15">
                                </div>
                                <div class="form-group">
                                    <label for="profession">Profesión</label>
                                    <input type="text" id="profession" value="Ingeniera de Software">
                                </div>
                                <div class="form-group">
                                    <label for="city">Ciudad</label>
                                    <select id="city">
                                        <option value="tegucigalpa" selected>Tegucigalpa</option>
                                        <option value="san-pedro-sula">San Pedro Sula</option>
                                        <option value="la-ceiba">La Ceiba</option>
                                        <option value="choloma">Choloma</option>
                                        <option value="danli">Danlí</option>
                                        <option value="siguatepeque">Siguatepeque</option>
                                        <option value="comayagua">Comayagua</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="address">Dirección</label>
                                    <textarea id="address" rows="2">Col. Palmira, Tegucigalpa</textarea>
                                </div>
                            </div>
                            
                            <div class="bio-section">
                                <label for="bio">Biografía</label>
                                <textarea id="bio" rows="3" placeholder="Cuéntanos un poco sobre ti...">Ingeniera apasionada por la tecnología financiera y el desarrollo comunitario. Participando en tandas desde hace 5 años.</textarea>
                            </div>
                            
                            <div class="preferences-section">
                                <h4>Preferencias de Comunicación</h4>
                                <div class="checkbox-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" checked> Notificaciones por email
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" checked> Notificaciones SMS
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox"> Newsletter semanal
                                    </label>
                                </div>
                            </div>
                            
                            <div class="modal-actions">
                                <button type="button" class="btn-secondary" onclick="advancedGroupsSystem.closeModal('editProfileModal')">
                                    Cancel
                                </button>
                                <button type="submit" class="btn-primary">
                                    <i class="fas fa-save"></i> Save Cambios
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- My Wallet Modal -->
    <div id="myWalletModal" class="modal-overlay" style="display: none;">
        <div class="modal-container large-modal">
            <div class="modal-header">
                <h2><i class="fas fa-wallet"></i> My Billetera</h2>
                <button class="modal-close" onclick="advancedGroupsSystem.closeModal('myWalletModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="wallet-container">
                    <div class="wallet-overview">
                        <div class="balance-cards">
                            <div class="balance-card main-balance">
                                <div class="balance-icon">
                                    <i class="fas fa-coins"></i>
                                </div>
                                <div class="balance-info">
                                    <span class="balance-label">Saldo Principal</span>
                                    <span class="balance-amount">L. 24,750.00</span>
                                </div>
                            </div>
                            <div class="balance-card tandas-balance">
                                <div class="balance-icon">
                                    <i class="fas fa-handshake"></i>
                                </div>
                                <div class="balance-info">
                                    <span class="balance-label">En Tandas</span>
                                    <span class="balance-amount">L. 18,500.00</span>
                                </div>
                            </div>
                            <div class="balance-card rewards-balance">
                                <div class="balance-icon">
                                    <i class="fas fa-trophy"></i>
                                </div>
                                <div class="balance-info">
                                    <span class="balance-label">Recompensas LTD</span>
                                    <span class="balance-amount">1,247 LTD</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="wallet-actions">
                        <button class="wallet-action-btn">
                            <i class="fas fa-plus"></i>
                            <span>Depositar</span>
                        </button>
                        <button class="wallet-action-btn">
                            <i class="fas fa-arrow-up"></i>
                            <span>Send</span>
                        </button>
                        <button class="wallet-action-btn">
                            <i class="fas fa-arrow-down"></i>
                            <span>Retirar</span>
                        </button>
                        <button class="wallet-action-btn">
                            <i class="fas fa-exchange-alt"></i>
                            <span>Intercambiar</span>
                        </button>
                    </div>
                    
                    <div class="wallet-tabs">
                        <div class="tab-buttons">
                            <button class="tab-btn active" onclick="advancedGroupsSystem.switchWalletTab('transactions')">
                                Transactions
                            </button>
                            <button class="tab-btn" onclick="advancedGroupsSystem.switchWalletTab('methods')">
                                Métodos de Pago
                            </button>
                            <button class="tab-btn" onclick="advancedGroupsSystem.switchWalletTab('security')">
                                Security
                            </button>
                        </div>
                        
                        <div class="tab-content" id="walletTransactions">
                            <div class="transactions-list">
                                <div class="transaction-item">
                                    <div class="transaction-icon income">
                                        <i class="fas fa-arrow-down"></i>
                                    </div>
                                    <div class="transaction-details">
                                        <div class="transaction-title">Pago Tanda Familiar</div>
                                        <div class="transaction-date">Hoy - 10:30 AM</div>
                                    </div>
                                    <div class="transaction-amount income">+L. 2,500.00</div>
                                </div>
                                <div class="transaction-item">
                                    <div class="transaction-icon expense">
                                        <i class="fas fa-arrow-up"></i>
                                    </div>
                                    <div class="transaction-details">
                                        <div class="transaction-title">Contribución Mensual</div>
                                        <div class="transaction-date">Ayer - 3:15 PM</div>
                                    </div>
                                    <div class="transaction-amount expense">-L. 500.00</div>
                                </div>
                                <div class="transaction-item">
                                    <div class="transaction-icon reward">
                                        <i class="fas fa-gift"></i>
                                    </div>
                                    <div class="transaction-details">
                                        <div class="transaction-title">Recompensa LTD</div>
                                        <div class="transaction-date">15 Ago - 9:00 AM</div>
                                    </div>
                                    <div class="transaction-amount reward">+50 LTD</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tab-content" id="walletMethods" style="display: none;">
                            <div class="payment-methods-list">
                                <div class="payment-method">
                                    <div class="method-icon">
                                        <i class="fas fa-credit-card"></i>
                                    </div>
                                    <div class="method-info">
                                        <div class="method-name">Visa •••• 4521</div>
                                        <div class="method-type">Tarjeta Principal</div>
                                    </div>
                                    <div class="method-actions">
                                        <button class="btn-icon" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn-icon" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="payment-method">
                                    <div class="method-icon">
                                        <i class="fas fa-university"></i>
                                    </div>
                                    <div class="method-info">
                                        <div class="method-name">Banco Atlántida</div>
                                        <div class="method-type">Account de Savingss</div>
                                    </div>
                                    <div class="method-actions">
                                        <button class="btn-icon" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn-icon" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <button class="add-method-btn">
                                    <i class="fas fa-plus"></i>
                                    Agregar Método de Pago
                                </button>
                            </div>
                        </div>
                        
                        <div class="tab-content" id="walletSecurity" style="display: none;">
                            <div class="security-options">
                                <div class="security-item">
                                    <div class="security-icon">
                                        <i class="fas fa-fingerprint"></i>
                                    </div>
                                    <div class="security-info">
                                        <div class="security-title">Autenticación Biométrica</div>
                                        <div class="security-desc">Huella dactilar activada</div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="security-item">
                                    <div class="security-icon">
                                        <i class="fas fa-key"></i>
                                    </div>
                                    <div class="security-info">
                                        <div class="security-title">PIN de Transactions</div>
                                        <div class="security-desc">Configurado</div>
                                    </div>
                                    <button class="btn-secondary">Cambiar</button>
                                </div>
                                <div class="security-item">
                                    <div class="security-icon">
                                        <i class="fas fa-shield-alt"></i>
                                    </div>
                                    <div class="security-info">
                                        <div class="security-title">Autenticación de Dos Factores</div>
                                        <div class="security-desc">Activada</div>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- KYC Verification Modal -->
    <div id="kycVerificationModal" class="modal-overlay" style="display: none;">
        <div class="modal-container large-modal">
            <div class="modal-header">
                <h2><i class="fas fa-shield-check"></i> Verificación KYC</h2>
                <button class="modal-close" onclick="advancedGroupsSystem.closeModal('kycVerificationModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="kyc-container">
                    <div class="kyc-status">
                        <div class="status-indicator verified">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="status-info">
                            <h3>¡Account Verificada!</h3>
                            <p>Tu verificación de identidad está completa</p>
                        </div>
                    </div>
                    
                    <div class="kyc-details">
                        <div class="verification-items">
                            <div class="verification-item completed">
                                <div class="item-icon">
                                    <i class="fas fa-id-card"></i>
                                </div>
                                <div class="item-info">
                                    <div class="item-title">Documento de Identidad</div>
                                    <div class="item-status">Verificado el 10 Ago 2024</div>
                                </div>
                                <div class="item-badge">
                                    <i class="fas fa-check"></i>
                                </div>
                            </div>
                            
                            <div class="verification-item completed">
                                <div class="item-icon">
                                    <i class="fas fa-camera"></i>
                                </div>
                                <div class="item-info">
                                    <div class="item-title">Verificación Facial</div>
                                    <div class="item-status">Verificada el 10 Ago 2024</div>
                                </div>
                                <div class="item-badge">
                                    <i class="fas fa-check"></i>
                                </div>
                            </div>
                            
                            <div class="verification-item completed">
                                <div class="item-icon">
                                    <i class="fas fa-home"></i>
                                </div>
                                <div class="item-info">
                                    <div class="item-title">Comprobante de Domicilio</div>
                                    <div class="item-status">Verificado el 12 Ago 2024</div>
                                </div>
                                <div class="item-badge">
                                    <i class="fas fa-check"></i>
                                </div>
                            </div>
                            
                            <div class="verification-item pending">
                                <div class="item-icon">
                                    <i class="fas fa-university"></i>
                                </div>
                                <div class="item-info">
                                    <div class="item-title">Verificación Bancaria</div>
                                    <div class="item-status">Opcional - No verificado</div>
                                </div>
                                <div class="item-action">
                                    <button class="btn-secondary">Verificar</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="kyc-benefits">
                            <h4>Beneficios de la Verificación</h4>
                            <ul class="benefits-list">
                                <li><i class="fas fa-check"></i> Límites de transacción más altos</li>
                                <li><i class="fas fa-check"></i> Acceso a grupos premium</li>
                                <li><i class="fas fa-check"></i> Mayor confianza de otros miembros</li>
                                <li><i class="fas fa-check"></i> Protección adicional de cuenta</li>
                                <li><i class="fas fa-check"></i> Soporte prioritario</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay" style="display: none;">
        <div class="modal-container large-modal">
            <div class="modal-header">
                <h2><i class="fas fa-cog"></i> Settings</h2>
                <button class="modal-close" onclick="advancedGroupsSystem.closeModal('settingsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="settings-container">
                    <div class="settings-sidebar">
                        <div class="settings-nav">
                            <button class="settings-nav-btn active" onclick="advancedGroupsSystem.switchSettingsTab('general')">
                                <i class="fas fa-cog"></i> General
                            </button>
                            <button class="settings-nav-btn" onclick="advancedGroupsSystem.switchSettingsTab('notifications')">
                                <i class="fas fa-bell"></i> Notificaciones
                            </button>
                            <button class="settings-nav-btn" onclick="advancedGroupsSystem.switchSettingsTab('privacy')">
                                <i class="fas fa-user-shield"></i> Privacidad
                            </button>
                            <button class="settings-nav-btn" onclick="advancedGroupsSystem.switchSettingsTab('appearance')">
                                <i class="fas fa-palette"></i> Apariencia
                            </button>
                            <button class="settings-nav-btn" onclick="advancedGroupsSystem.switchSettingsTab('language')">
                                <i class="fas fa-globe"></i> Idioma
                            </button>
                        </div>
                    </div>
                    
                    <div class="settings-content">
                        <div class="settings-tab" id="generalSettings">
                            <h3>Settings General</h3>
                            <div class="settings-group">
                                <div class="setting-item">
                                    <div class="setting-info">
                                        <label>Recibir Invitations</label>
                                        <span class="setting-desc">Permitir que otros usuarios te inviten a grupos</span>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                
                                <div class="setting-item">
                                    <div class="setting-info">
                                        <label>Profile Público</label>
                                        <span class="setting-desc">Tu perfil será visible para otros miembros</span>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                
                                <div class="setting-item">
                                    <div class="setting-info">
                                        <label>Mostrar Estado en Línea</label>
                                        <span class="setting-desc">Otros usuarios verán cuando estés conectado</span>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                
                                <div class="setting-item">
                                    <div class="setting-info">
                                        <label>Save Historial de Búsqueda</label>
                                        <span class="setting-desc">Recordar tus búsquedas anteriores</span>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="settings-tab" id="notificationSettings" style="display: none;">
                            <h3>Preferencias de Notificaciones</h3>
                            <div class="settings-group">
                                <h4>Notificaciones de Grupos</h4>
                                <div class="setting-item">
                                    <div class="setting-info">
                                        <label>Nuevas Invitations</label>
                                        <span class="setting-desc">Cuando te inviten a un grupo</span>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                
                                <div class="setting-item">
                                    <div class="setting-info">
                                        <label>Recordatorios de Pago</label>
                                        <span class="setting-desc">Antes de cada fecha de contribución</span>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                
                                <div class="setting-item">
                                    <div class="setting-info">
                                        <label>Mensajes del Grupo</label>
                                        <span class="setting-desc">Nuevos mensajes en el chat del grupo</span>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="settings-group">
                                <h4>Notificaciones por Email</h4>
                                <div class="setting-item">
                                    <div class="setting-info">
                                        <label>Resumen Semanal</label>
                                        <span class="setting-desc">Estadísticas y actividad de la semana</span>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                
                                <div class="setting-item">
                                    <div class="setting-info">
                                        <label>Nuevas Funciones</label>
                                        <span class="setting-desc">Actualizaciones y nuevas características</span>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="settings-tab" id="privacySettings" style="display: none;">
                            <h3>Settings de Privacidad</h3>
                            <div class="settings-group">
                                <div class="setting-item">
                                    <div class="setting-info">
                                        <label>Compartir Datos de Actividad</label>
                                        <span class="setting-desc">Para mejorar recomendaciones de grupos</span>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                
                                <div class="setting-item">
                                    <div class="setting-info">
                                        <label>Mostrar Historial de Tandas</label>
                                        <span class="setting-desc">Visible en tu perfil público</span>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                
                                <div class="setting-item">
                                    <div class="setting-info">
                                        <label>Búsqueda por Teléfono</label>
                                        <span class="setting-desc">Otros usuarios pueden encontrarte por número</span>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="settings-tab" id="appearanceSettings" style="display: none;">
                            <h3>Apariencia</h3>
                            <div class="settings-group">
                                <div class="setting-item">
                                    <div class="setting-info">
                                        <label>Tema</label>
                                        <span class="setting-desc">Apariencia visual de la aplicación</span>
                                    </div>
                                    <select class="setting-select">
                                        <option value="auto">Automático (sistema)</option>
                                        <option value="light">Claro</option>
                                        <option value="dark" selected>Oscuro</option>
                                    </select>
                                </div>
                                
                                <div class="setting-item">
                                    <div class="setting-info">
                                        <label>Tamaño de Fuente</label>
                                        <span class="setting-desc">Tamaño del texto en la interfaz</span>
                                    </div>
                                    <select class="setting-select">
                                        <option value="small">Pequeño</option>
                                        <option value="medium" selected>Mediano</option>
                                        <option value="large">Grande</option>
                                    </select>
                                </div>
                                
                                <div class="setting-item">
                                    <div class="setting-info">
                                        <label>Animaciones</label>
                                        <span class="setting-desc">Efectos visuales y transiciones</span>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="settings-tab" id="languageSettings" style="display: none;">
                            <h3>Idioma y Región</h3>
                            <div class="settings-group">
                                <div class="setting-item">
                                    <div class="setting-info">
                                        <label>Idioma de la Interfaz</label>
                                        <span class="setting-desc">Idioma principal de la aplicación</span>
                                    </div>
                                    <select class="setting-select">
                                        <option value="es" selected>Español</option>
                                        <option value="en">English</option>
                                        <option value="pt">Português</option>
                                    </select>
                                </div>
                                
                                <div class="setting-item">
                                    <div class="setting-info">
                                        <label>Moneda</label>
                                        <span class="setting-desc">Moneda para mostrar cantidades</span>
                                    </div>
                                    <select class="setting-select">
                                        <option value="HNL" selected>Lempira (L.)</option>
                                        <option value="USD">Dólar Americano (L)</option>
                                        <option value="EUR">Euro (€)</option>
                                    </select>
                                </div>
                                
                                <div class="setting-item">
                                    <div class="setting-info">
                                        <label>Zona Horaria</label>
                                        <span class="setting-desc">Para programar eventos y recordatorios</span>
                                    </div>
                                    <select class="setting-select">
                                        <option value="America/Tegucigalpa" selected>Centroamérica (GMT-6)</option>
                                        <option value="America/New_York">Nueva York (GMT-5)</option>
                                        <option value="America/Los_Angeles">Los Ángeles (GMT-8)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="advancedGroupsSystem.closeModal('settingsModal')">
                        Cancel
                    </button>
                    <button type="button" class="btn-primary" onclick="advancedGroupsSystem.saveSettings()">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Center Modal -->
    <div id="helpCenterModal" class="modal-overlay" style="display: none;">
        <div class="modal-container large-modal">
            <div class="modal-header">
                <h2><i class="fas fa-question-circle"></i> Centro de Ayuda</h2>
                <button class="modal-close" onclick="advancedGroupsSystem.closeModal('helpCenterModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="help-container">
                    <div class="help-search">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" placeholder="¿En qué podemos ayudarte?" id="helpSearch">
                        </div>
                    </div>
                    
                    <div class="help-categories">
                        <div class="category-cards">
                            <div class="category-card" onclick="advancedGroupsSystem.showHelpCategory('getting-started')">
                                <div class="category-icon">
                                    <i class="fas fa-rocket"></i>
                                </div>
                                <h4>Primeros Pasos</h4>
                                <p>Cómo comenzar y crear tu primer grupo</p>
                            </div>
                            
                            <div class="category-card" onclick="advancedGroupsSystem.showHelpCategory('groups')">
                                <div class="category-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <h4>Gestión de Grupos</h4>
                                <p>Administrar grupos y miembros</p>
                            </div>
                            
                            <div class="category-card" onclick="advancedGroupsSystem.showHelpCategory('payments')">
                                <div class="category-icon">
                                    <i class="fas fa-credit-card"></i>
                                </div>
                                <h4>Pagos y Billetera</h4>
                                <p>Transactions y métodos de pago</p>
                            </div>
                            
                            <div class="category-card" onclick="advancedGroupsSystem.showHelpCategory('security')">
                                <div class="category-icon">
                                    <i class="fas fa-shield-alt"></i>
                                </div>
                                <h4>Security</h4>
                                <p>Protección de cuenta y privacidad</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="help-content" id="helpContent">
                        <div class="faq-section">
                            <h3>Preguntas Frecuentes</h3>
                            <div class="faq-list">
                                <div class="faq-item">
                                    <div class="faq-question" onclick="advancedGroupsSystem.toggleFAQ(this)">
                                        <span>¿Cómo creo mi primer grupo de tanda?</span>
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                    <div class="faq-answer">
                                        <p>Para crear tu primer grupo:</p>
                                        <ol>
                                            <li>Ve a la pestaña "Create" en el menú principal</li>
                                            <li>Completa la información básica del grupo</li>
                                            <li>Establece las reglas de contribución</li>
                                            <li>Invita a los miembros</li>
                                            <li>¡Listo! Tu grupo estará activo</li>
                                        </ol>
                                    </div>
                                </div>
                                
                                <div class="faq-item">
                                    <div class="faq-question" onclick="advancedGroupsSystem.toggleFAQ(this)">
                                        <span>¿Qué pasa si un miembro no paga?</span>
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                    <div class="faq-answer">
                                        <p>Tenemos varios mecanismos de protección:</p>
                                        <ul>
                                            <li>Sistema de recordatorios automáticos</li>
                                            <li>Período de gracia configurable</li>
                                            <li>Fondo de emergencia del grupo</li>
                                            <li>Proceso de mediación</li>
                                            <li>En último caso, exclusión del grupo</li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="faq-item">
                                    <div class="faq-question" onclick="advancedGroupsSystem.toggleFAQ(this)">
                                        <span>¿Cómo funciona la verificación KYC?</span>
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                    <div class="faq-answer">
                                        <p>La verificación incluye:</p>
                                        <ul>
                                            <li>Foto de documento de identidad</li>
                                            <li>Selfie de verificación facial</li>
                                            <li>Comprobante de domicilio</li>
                                            <li>Verificación opcional bancaria</li>
                                        </ul>
                                        <p>Es completamente seguro y aumenta tu confiabilidad.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="help-contact">
                            <h3>¿No encuentras lo que buscas?</h3>
                            <div class="contact-options">
                                <button class="contact-btn" onclick="advancedGroupsSystem.startChat()">
                                    <i class="fas fa-comments"></i>
                                    Chat en Vivo
                                </button>
                                <button class="contact-btn" onclick="advancedGroupsSystem.openFeedbackModal()">
                                    <i class="fas fa-envelope"></i>
                                    Send Mensaje
                                </button>
                                <button class="contact-btn" onclick="window.open('tel:+5042222-3333')">
                                    <i class="fas fa-phone"></i>
                                    Llamar Soporte
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="modal-overlay" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h2><i class="fas fa-comment-alt"></i> Send Feedback</h2>
                <button class="modal-close" onclick="advancedGroupsSystem.closeModal('feedbackModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <div class="feedback-container">
                    <form id="feedbackForm">
                        <div class="feedback-type">
                            <label>Tipo de Feedback</label>
                            <div class="feedback-options">
                                <label class="radio-option">
                                    <input type="radio" name="feedbackType" value="suggestion" checked>
                                    <span class="radio-custom"></span>
                                    <div class="option-info">
                                        <i class="fas fa-lightbulb"></i>
                                        <span>Sugerencia</span>
                                    </div>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="feedbackType" value="bug">
                                    <span class="radio-custom"></span>
                                    <div class="option-info">
                                        <i class="fas fa-bug"></i>
                                        <span>Reportar Error</span>
                                    </div>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="feedbackType" value="compliment">
                                    <span class="radio-custom"></span>
                                    <div class="option-info">
                                        <i class="fas fa-heart"></i>
                                        <span>Felicitación</span>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="feedbackSubject">Asunto</label>
                            <input type="text" id="feedbackSubject" placeholder="Describe brevemente tu feedback" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="feedbackMessage">Mensaje</label>
                            <textarea id="feedbackMessage" rows="5" placeholder="Cuéntanos más detalles..." required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="feedbackRating">Calificación General</label>
                            <div class="rating-stars">
                                <span class="star" data-rating="1">⭐</span>
                                <span class="star" data-rating="2">⭐</span>
                                <span class="star" data-rating="3">⭐</span>
                                <span class="star" data-rating="4">⭐</span>
                                <span class="star" data-rating="5">⭐</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="feedbackEmail">
                                Quiero recibir una respuesta por email
                            </label>
                        </div>
                        
                        <div class="modal-actions">
                            <button type="button" class="btn-secondary" onclick="advancedGroupsSystem.closeModal('feedbackModal')">
                                Cancel
                            </button>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-paper-plane"></i> Send Feedback
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced API Proxy System v4.0.0 -->
    <script src="api-handlers-complete.js?v=4.0.1"></script>
    <script src="api-proxy-enhanced.js?v=4.0.4"></script>
    <script src="api-proxy-updated.js?v=4.0.1"></script>
    
    <!-- Global Functions for KYC and Audit -->
    <script>
        // Function to find available system with modal capabilities
        function findAvailableSystem() {
            // Check all possible system instances
            const systems = [
                window.advancedGroupsSystem,
                window.laTandaSystemComplete,
                window.groupsIntegration
            ];
            
            for (let system of systems) {
                if (system && typeof system.showModal === 'function') {
                    return system;
                }
            }
            return null;
        }

        // Global wrapper functions for openKYC and showAudit
        window.openKYC = function() {
            
            const system = findAvailableSystem();
            if (system && typeof system.openKYC === 'function') {
                system.openKYC();
                return;
            }
            
            // Try different modal functions
            if (system) {
                
                // Try the standard showModal function
                if (typeof system.showModal === 'function') {
                    try {
                        system.showModal({
                            title: '🆔 Verificación KYC',
                            content: `
                                <div style="padding: 20px; text-align: center;">
                                    <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, #00FFFF, #7FFFD8); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #0f172a;">
                                        <i class="fas fa-shield-alt"></i>
                                    </div>
                                    <h4 style="margin-bottom: 15px; color: #f8fafc;">Verificación de Identidad</h4>
                                    <p style="margin-bottom: 25px; color: rgba(248, 250, 252, 0.7);">Completa tu verificación KYC para acceder a todas las funcionalidades</p>
                                    
                                    <div style="margin-bottom: 30px;">
                                        <div style="display: flex; align-items: center; gap: 15px; padding: 12px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; margin-bottom: 10px;">
                                            <span style="width: 24px; height: 24px; border-radius: 50%; background: #22c55e; color: white; display: flex; align-items: center; justify-content: center; font-size: 12px;"><i class="fas fa-check"></i></span>
                                            <span style="color: #f8fafc;">Información básica</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 15px; padding: 12px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; margin-bottom: 10px;">
                                            <span style="width: 24px; height: 24px; border-radius: 50%; background: #22c55e; color: white; display: flex; align-items: center; justify-content: center; font-size: 12px;"><i class="fas fa-check"></i></span>
                                            <span style="color: #f8fafc;">Número de teléfono</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 15px; padding: 12px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; margin-bottom: 10px;">
                                            <span style="width: 24px; height: 24px; border-radius: 50%; background: #f59e0b; color: #0f172a; display: flex; align-items: center; justify-content: center; font-size: 12px;"><i class="fas fa-clock"></i></span>
                                            <span style="color: #f8fafc;">Verificación de documento</span>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 15px; padding: 12px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                                            <span style="width: 24px; height: 24px; border-radius: 50%; background: #f59e0b; color: #0f172a; display: flex; align-items: center; justify-content: center; font-size: 12px;"><i class="fas fa-clock"></i></span>
                                            <span style="color: #f8fafc;">Verificación facial</span>
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; gap: 15px; justify-content: center;">
                                        <button class="btn btn-primary" onclick="window.open('/kyc-registration.html', '_blank')" style="padding: 10px 20px; background: linear-gradient(135deg, #00FFFF, #7FFFD8); color: #0f172a; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                            <i class="fas fa-external-link-alt"></i> Continuar Verificación
                                        </button>
                                        <button class="btn btn-secondary" onclick="document.getElementById('modalOverlay')?.remove()" style="padding: 10px 20px; background: rgba(255, 255, 255, 0.1); color: #f8fafc; border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 8px; font-weight: 600; cursor: pointer;">
                                            <i class="fas fa-times"></i> Cerrar
                                        </button>
                                    </div>
                                </div>
                            `,
                            size: 'medium'
                        });
                        return;
                    } catch (error) {
                    }
                }
            }
            
            // Fallback if no modal system available
            const kyc = confirm('🆔 Verificación KYC\n\nPara completar tu verificación de identidad.\n\n¿Deseas abrir la página de verificación KYC?');
            if (kyc) {
                window.open('/kyc-registration.html', '_blank');
            }
        };

        window.showAudit = function() {
            
            const system = findAvailableSystem();
            if (system && typeof system.showAudit === 'function') {
                system.showAudit();
                return;
            }
            
            // Try different modal functions
            if (system) {
                
                // Try the standard showModal function
                if (typeof system.showModal === 'function') {
                    try {
                        system.showModal({
                            title: '📊 Auditoría del Sistema',
                            content: `
                                <div style="padding: 20px;">
                                    <div style="text-align: center; margin-bottom: 30px;">
                                        <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, #3b82f6, #1e40af); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: white;">
                                            <i class="fas fa-search"></i>
                                        </div>
                                        <h4 style="margin-bottom: 15px; color: #f8fafc;">Auditoría de Security</h4>
                                        <p style="margin-bottom: 25px; color: rgba(248, 250, 252, 0.7);">Reporte completo de la seguridad y transparencia del sistema</p>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                                        <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.1);">
                                            <span style="display: block; font-size: 2rem; font-weight: 700; color: #00FFFF; margin-bottom: 8px;">98.5%</span>
                                            <span style="display: block; color: rgba(248, 250, 252, 0.7); margin-bottom: 4px;">Smart Contract Success</span>
                                            <span style="font-size: 0.9rem; font-weight: 600; color: #22c55e;">↗ +2.1%</span>
                                        </div>
                                        <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.1);">
                                            <span style="display: block; font-size: 2rem; font-weight: 700; color: #00FFFF; margin-bottom: 8px;">100%</span>
                                            <span style="display: block; color: rgba(248, 250, 252, 0.7); margin-bottom: 4px;">Funds Security</span>
                                            <span style="font-size: 0.9rem; font-weight: 600; color: #22c55e;">✓ Secured</span>
                                        </div>
                                        <div style="text-align: center; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.1);">
                                            <span style="display: block; font-size: 2rem; font-weight: 700; color: #00FFFF; margin-bottom: 8px;">24/7</span>
                                            <span style="display: block; color: rgba(248, 250, 252, 0.7); margin-bottom: 4px;">Monitoring</span>
                                            <span style="font-size: 0.9rem; font-weight: 600;">🟢 Active</span>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-bottom: 30px;">
                                        <h5 style="color: #f8fafc; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid rgba(148, 163, 184, 0.1);">Últimas Auditorías</h5>
                                        <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 15px; padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); align-items: center;">
                                            <span style="color: rgba(248, 250, 252, 0.7); font-family: monospace; font-size: 0.9rem;">2024-08-20</span>
                                            <span style="color: #f8fafc;">Smart Contracts</span>
                                            <span style="color: #22c55e; font-weight: 600;">✅ Aprobado</span>
                                        </div>
                                        <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 15px; padding: 12px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); align-items: center;">
                                            <span style="color: rgba(248, 250, 252, 0.7); font-family: monospace; font-size: 0.9rem;">2024-08-15</span>
                                            <span style="color: #f8fafc;">Security Infrastructure</span>
                                            <span style="color: #22c55e; font-weight: 600;">✅ Aprobado</span>
                                        </div>
                                        <div style="display: grid; grid-template-columns: auto 1fr auto; gap: 15px; padding: 12px; align-items: center;">
                                            <span style="color: rgba(248, 250, 252, 0.7); font-family: monospace; font-size: 0.9rem;">2024-08-10</span>
                                            <span style="color: #f8fafc;">Financial Reserves</span>
                                            <span style="color: #22c55e; font-weight: 600;">✅ Aprobado</span>
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; gap: 15px; justify-content: center;">
                                        <button onclick="showInfo('Descargando reporte completo de auditoria...')" style="padding: 10px 20px; background: linear-gradient(135deg, #00FFFF, #7FFFD8); color: #0f172a; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                            <i class="fas fa-download"></i> Descargar Reporte
                                        </button>
                                        <button onclick="document.getElementById('modalOverlay')?.remove()" style="padding: 10px 20px; background: rgba(255, 255, 255, 0.1); color: #f8fafc; border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 8px; font-weight: 600; cursor: pointer;">
                                            <i class="fas fa-times"></i> Cerrar
                                        </button>
                                    </div>
                                </div>
                            `,
                            size: 'large'
                        });
                        return;
                    } catch (error) {
                    }
                }
            }
            
            // Fallback if no modal system available
            const audit = confirm('📊 Auditoría del Sistema\n\nSmart Contract Success: 98.5%\nFunds Security: 100%\nMonitoring: 24/7 Active\n\nTodos los contratos han pasado las auditorías de seguridad.\n\n¿Deseas ver más detalles?');
            if (audit) {
                showInfo('Ultimas Auditorias:\n\n• 2024-08-20: Smart Contracts ✅ Aprobado\n• 2024-08-15: Security Infrastructure ✅ Aprobado\n• 2024-08-10: Financial Reserves ✅ Aprobado');
            }
        };
        
        // Debug function to check available systems
        window.debugSystems = function() {
            
            const system = findAvailableSystem();
            if (system) {
            }
        };

        // Debug function to check dropdown elements
        window.debugDropdowns = function() {
            const dropdowns = document.querySelectorAll('.dropdown-menu');
            
            dropdowns.forEach((dropdown, index) => {
                const style = window.getComputedStyle(dropdown);
                    display: style.display,
                    position: style.position,
                    zIndex: style.zIndex,
                    visibility: style.visibility,
                    opacity: style.opacity,
                    left: style.left,
                    top: style.top,
                    classes: dropdown.className,
                    parent: dropdown.parentElement?.tagName
                });
            });

            const buttons = document.querySelectorAll('.dropdown-toggle');
        };

        // Test function to manually trigger dropdown
        window.testDropdown = function(groupId) {
            const system = findAvailableSystem();
            if (system && system.toggleGroupActions) {
                system.toggleGroupActions(groupId);
            } else {
            }
        };
        
        // Check systems when page loads
        window.addEventListener('load', function() {
            setTimeout(() => {
                window.debugSystems();
            }, 2000);
        });
    </script>

    <!-- Shared Components and Translation System Scripts -->
    <script src="shared-components.js?v=7.18"></script>
    <!-- <script src="translation-system-design.js"></script> DISABLED - Using global-i18n-manager.js -->
    <script>
        // OLD TRANSLATION SYSTEM - DISABLED
        // Using global-i18n-manager.js instead
        /*
        // Initialize Translation System
        let translationSystem;
        
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Initialize the translation system
                translationSystem = new LaTandaTranslationSystem();
                
                // Set up language selector
                await translationSystem.setupLanguageSelector();
                
                // Apply translations for current language
                await translationSystem.translatePage();
                
            } catch (error) {
            }
        });

        // Add translation handling to existing functions
        window.originalSwitchTab = window.switchTab;
        window.switchTab = function(tabName) {
            if (window.originalSwitchTab) {
                window.originalSwitchTab(tabName);
            }
            // Retranslate new content after tab switch
            if (translationSystem) {
                setTimeout(() => translationSystem.translatePage(), 100);
            }
        };
        */
    </script>
    
    <!-- Unified Footer -->
    <div id="latanda-footer" class="auto-footer"></div>
    <script>
    // ============================================
    // GROUPS API INTEGRATION PATCH - La Tanda
    // Date: 2025-10-03
    // ============================================
    
/**
 * 🔧 GROUPS API INTEGRATION PATCH
 * La Tanda - Production API Integration
 * Date: 2025-10-03
 * 
 * This patch connects groups-advanced-system.html to live backend API
 * Endpoints: POST /api/registration/groups/list, POST /api/registration/groups/create
 * Fallback: localStorage cache for offline support
 */


// API Configuration
const GROUPS_API_CONFIG = {
    baseURL: "https://latanda.online",
    endpoints: {
        list: "/api/groups/my-groups-pg",
        create: "/api/registration/groups/create",
        update: "/api/groups/{id}/update",
        invite: "/api/groups/{id}/members/invite",
        finances: "/api/groups/{id}/finances/summary"
    },
    cacheKey: "latanda_groups_cache",
    cacheExpiry: 300000 // 5 minutes
};

// Get current user ID
// [ELIMINADO] Definicion 2 - funcion duplicada removida

// Get auth token
function getAuthToken() {
    return localStorage.getItem("auth_token") || localStorage.getItem("latanda_auth_token") || 
           sessionStorage.getItem("latanda_auth_token") || "";
}

// API: Load groups from backend
async function loadGroupsFromAPI() {
    try {
        const userId = getCurrentUserId();
        
        const response = await fetch(`${GROUPS_API_CONFIG.baseURL}${GROUPS_API_CONFIG.endpoints.list}?user_id=${userId}&_t=${Date.now()}`, {
            method: "GET",
            headers: { ...getAuthHeaders(),
                "Content-Type": "application/json",
                "Authorization": `Bearer ${getAuthToken()}`
            },
        });

        if (response.ok) {
            const data = await response.json();
            const groups = data.data.groups || data.data || [];
            
            
            // Cache for offline
            localStorage.setItem(GROUPS_API_CONFIG.cacheKey, JSON.stringify({
                groups: groups,
                timestamp: Date.now()
            }));
            
            return groups;
        } else {
            return loadGroupsFromCache();
        }
    } catch (error) {
        return loadGroupsFromCache();
    }
}

// Fallback: Load from cache
function loadGroupsFromCache() {
    try {
        const cached = localStorage.getItem(GROUPS_API_CONFIG.cacheKey);
        if (cached) {
            const data = JSON.parse(cached);
            const age = Date.now() - data.timestamp;
            
            if (age < GROUPS_API_CONFIG.cacheExpiry) {
                return data.groups || [];
            }
        }
    } catch (error) {
    }
    
    return [];
}

// API: Create new group
async function createGroupViaAPI(groupData) {
    const debugToken = getAuthToken();
    
    // Validate token before proceeding
    if (!debugToken || debugToken.length < 50) {
        return { success: false, error: "Sesión expirada. Por favor inicie sesión de nuevo." };
    }
    try {
        
        const response = await fetch(`${GROUPS_API_CONFIG.baseURL}${GROUPS_API_CONFIG.endpoints.create}`, {
            method: "POST",
            headers: { ...getAuthHeaders(),
                "Content-Type": "application/json",
                "Authorization": `Bearer ${getAuthToken()}`
            },
            body: JSON.stringify({
                name: groupData.name,
                contribution_amount: parseFloat(groupData.contribution_amount),
                frequency: groupData.frequency,
                max_members: parseInt(groupData.max_members),
                admin_id: getCurrentUserId(),
                description: groupData.description || "",
                category: groupData.category || "general",
                location: groupData.location || "",
                meeting_schedule: groupData.meeting_schedule || ""
            })
        });

        if (response.ok) {
            const data = await response.json();
            
            // Refresh cache
            await loadGroupsFromAPI();

            // Also refresh tandas and groups views
            if (typeof fetchMyGroups === "function") fetchMyGroups();
            if (typeof refreshTandas === "function") refreshTandas();
            
            return {
                success: true,
                group_id: data.data.group_id,
                message: data.data.message
            };
        } else {
            const error = await response.json();
            return {
                success: false,
                error: error.data?.error?.message || "Failed to create group"
            };
        }
    } catch (error) {
        return {
            success: false,
            error: "Network error, please try again"
        };
    }
}

// Patch existing TandaManager class if it exists
if (typeof TandaManager !== "undefined" && TandaManager.prototype) {
    
    // Store original methods
    const original_loadUserTandas = TandaManager.prototype.loadUserTandas;
    const original_createTanda = TandaManager.prototype.createTanda;
    
    // Override loadUserTandas to use API
    TandaManager.prototype.loadUserTandas = async function() {
        const groups = await loadGroupsFromAPI();

            // Also refresh tandas and groups views
            if (typeof fetchMyGroups === "function") fetchMyGroups();
            if (typeof refreshTandas === "function") refreshTandas();
        
        // Transform API format to UI format if needed
        this.userTandas = groups.map(g => ({
            id: g.id,
            name: g.name,
            amount: g.contribution_amount,
            frequency: g.frequency,
            memberCount: g.member_count,
            maxMembers: g.max_members,
            status: g.status,
            adminId: g.admin_id,
            adminName: g.admin_name,
            description: g.description,
            category: g.category,
            location: g.location
        }));
        
        return this.userTandas;
    };
    
    // Override createTanda to use API
    TandaManager.prototype.createTanda = async function(tandaData) {
        const result = await createGroupViaAPI(tandaData);
        
        if (result.success) {
            // Reload groups
            await this.loadUserTandas();
        }
        
        return result;
    };
    
}

// Patch global functions if they exist
if (typeof window !== "undefined") {
    // Override global loadUserGroups if it exists
    if (typeof window.loadUserGroups === "function") {
        window.loadUserGroups_original = window.loadUserGroups;
        window.loadUserGroups = loadGroupsFromAPI;
    }
    
    // Override global createGroup if it exists
    if (typeof window.createGroup === "function") {
        window.createGroup_original = window.createGroup;
        window.createGroup = createGroupViaAPI;
    }
}


// Auto-load groups on page ready
if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", async () => {
        const groups = await loadGroupsFromAPI();

            // Also refresh tandas and groups views
            if (typeof fetchMyGroups === "function") fetchMyGroups();
            if (typeof refreshTandas === "function") refreshTandas();
    });
} else {
    // Already loaded
    setTimeout(async () => {
        const groups = await loadGroupsFromAPI();

            // Also refresh tandas and groups views
            if (typeof fetchMyGroups === "function") fetchMyGroups();
            if (typeof refreshTandas === "function") refreshTandas();
    }, 1000);
}
    </script>
    <script src="api-adapter.js"></script>
    <script>
        // Initialize API Adapter
    </script>

    <!-- Tanda Calculator Logic -->
    <script>
        function calculateTanda() {
            // Get inputs
            const participants = parseInt(document.getElementById('calc-participants').value);
            const totalAmount = parseFloat(document.getElementById('calc-amount').value);
            const frequency = document.getElementById('calc-frequency').value;
            const startDateInput = document.getElementById('calc-startdate').value;
            const currency = document.getElementById('calc-currency').value;
            const currencySymbol = currency === 'HNL' ? 'L' : '$';

            // Validations
            if (!participants || participants < 2) {
                showWarning('Ingresa al menos 2 participantes');
                return;
            }

            if (!totalAmount || totalAmount < 50) {
                showWarning('Ingresa un monto valido (minimo 50)');
                return;
            }

            // Calculate
            const contributionPerPerson = totalAmount; // User enters contribution per person
            const totalPayout = contributionPerPerson * participants; // Total payout = contribution x participants
            const duration = participants; // Number of periods equals number of participants

            // Duration text based on frequency
            let durationText = '';
            if (frequency === 'weekly') {
                durationText = duration + ' weeks';
            } else if (frequency === 'biweekly') {
                durationText = duration + ' bi-weeks (' + (duration * 2) + ' weeks)';
            } else {
                durationText = duration + ' months';
            }

            // Update results with currency symbol
            document.getElementById('result-contribution').textContent = currencySymbol + contributionPerPerson.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('result-duration').textContent = durationText;
            document.getElementById('result-payout').textContent = currencySymbol + totalPayout.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

            // Generate schedule with start date and currency
            generateSchedule(participants, totalPayout, frequency, startDateInput, currencySymbol);

            // Calculate and display commission breakdown
            const coordinatorFee = totalPayout * 0.03; // 3% coordinator fee
            document.getElementById('coordinator-fee').textContent = currencySymbol + coordinatorFee.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

            // Calculate LTD rewards (20/80 principle)
            let poolTotal;
            if (participants <= 5) {
                poolTotal = 50;
            } else if (participants <= 10) {
                poolTotal = 100;
            } else if (participants <= 15) {
                poolTotal = 125;
            } else {
                poolTotal = 150;
            }

            const creatorBonus = poolTotal * 0.20; // Creator gets 20% bonus
            const participantPool = poolTotal * 0.80; // 80% distributed among all
            const rewardPerParticipant = participantPool / participants;
            const creatorTotal = creatorBonus + rewardPerParticipant; // Creator also participates

            // Update LTD reward displays
            document.getElementById('total-pool').textContent = poolTotal.toFixed(0) + ' LTD';
            document.getElementById('creator-tokens').textContent = creatorTotal.toFixed(1) + ' LTD';
            document.getElementById('member-tokens').textContent = rewardPerParticipant.toFixed(1) + ' LTD';

            // Show results
            document.getElementById('calc-results').style.display = 'block';

            // Smooth scroll to results
            document.getElementById('calc-results').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function generateSchedule(participants, totalAmount, frequency, startDateInput, currencySymbol) {
            const scheduleTable = document.getElementById('schedule-table');
            // Use provided start date or today
            const today = startDateInput ? new Date(startDateInput + 'T00:00:00') : new Date();
            // Default currency symbol if not provided
            const symbol = currencySymbol || 'L';

            let html = '<table style="width: 100%; border-collapse: collapse; background: rgba(0, 0, 0, 0.2); border-radius: 12px; overflow: hidden;">';
            html += '<thead><tr style="background: rgba(0, 255, 255, 0.1);">';
            html += '<th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--border-accent);">Turn</th>';
            html += '<th style="padding: 12px; text-align: left; border-bottom: 1px solid var(--border-accent);">Date</th>';
            html += '<th style="padding: 12px; text-align: right; border-bottom: 1px solid var(--border-accent);">Payout</th>';
            html += '</tr></thead><tbody>';

            for (let i = 1; i <= participants; i++) {
                const turnDate = new Date(today);

                if (frequency === 'weekly') {
                    turnDate.setDate(today.getDate() + (i - 1) * 7);
                } else if (frequency === 'biweekly') {
                    turnDate.setDate(today.getDate() + (i - 1) * 14);
                } else { // monthly
                    turnDate.setMonth(today.getMonth() + (i - 1));
                }

                let dateStr;
                if (frequency === 'weekly' || frequency === 'biweekly') {
                    dateStr = turnDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                } else {
                    dateStr = turnDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                }

                html += '<tr style="border-bottom: 1px solid rgba(148, 163, 184, 0.1);">';
                html += '<td style="padding: 12px; font-weight: 600; color: var(--tanda-cyan);">' + i + '</td>';
                html += '<td style="padding: 12px;">' + dateStr + '</td>';
                html += '<td style="padding: 12px; text-align: right; font-weight: 600;">' + symbol + totalAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '</td>';
                html += '</tr>';
            }

            html += '</tbody>';
            html += '<tfoot><tr style="background: rgba(0, 255, 255, 0.15); font-weight: bold;">';
            html += '<td colspan="2" style="padding: 12px;">Total Volume</td>';
            html += '<td style="padding: 12px; text-align: right;">' + symbol + (totalAmount * participants).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '</td>';
            html += '</tr></tfoot>';
            html += '</table>';
            scheduleTable.innerHTML = html;
        }
    </script>
    <script>
        // Initialize calculator date picker with today's date
        document.addEventListener("DOMContentLoaded", function() {
            const dateInput = document.getElementById("calc-startdate");
            if (dateInput) {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, "0");
                const dd = String(today.getDate()).padStart(2, "0");
                dateInput.value = yyyy + "-" + mm + "-" + dd;
            }
        });
    </script>
    <!-- ===== GROUP TEMPLATES SYSTEM ===== -->
    <script>
        // Plantillas de grupos precreadas
        const groupTemplates = {
            'familiar-small': {
                name: "Grupo Familiar ",
                description: "Grupo cooperativo entre familiares para ahorros y apoyo mutuo",
                type: "familiar",
                contribution: 1500,
                frequency: "monthly",
                maxParticipants: 8,
                location: "",
                virtualMeetings: true
            },
            'laboral': {
                name: "Tanda de Oficina ",
                description: "Grupo cooperativo entre compañeros de trabajo",
                type: "laboral",
                contribution: 2000,
                frequency: "biweekly",
                maxParticipants: 12,
                location: "",
                virtualMeetings: true
            },
            'comunitario': {
                name: "Tanda Comunitaria ",
                description: "Grupo cooperativo de vecinos para proyectos comunitarios",
                type: "comunitario",
                contribution: 500,
                frequency: "monthly",
                maxParticipants: 30,
                location: "",
                virtualMeetings: false
            },
            'comercial': {
                name: "Red de Emprendedores ",
                description: "Grupo cooperativo de pequeños negocios para financiamiento mutuo",
                type: "comercial",
                contribution: 5000,
                frequency: "biweekly",
                maxParticipants: 15,
                location: "",
                virtualMeetings: true
            },
            'tanda-rapida': {
                name: "Tanda Rápida Semanal",
                description: "Ciclo corto de ahorro semanal para necesidades inmediatas",
                type: "familiar",
                contribution: 500,
                frequency: "weekly",
                maxParticipants: 10,
                location: "",
                virtualMeetings: true
            }
        };

        // Función para mostrar el modal de plantillas
        function showTemplateModal() {
            const modal = document.getElementById('template-modal');
            if (modal) {
                modal.style.display = 'flex'; modal.classList.add('active');
                setTimeout(() => {
                    modal.classList.add('active');
                }, 10);
            }
        }

        // Función para cerrar el modal de plantillas
        function closeTemplateModal() {
            const modal = document.getElementById('template-modal');
            if (modal) {
                modal.classList.remove('active');
                setTimeout(() => {
                    modal.style.display = 'none'; modal.classList.remove('active'); modal.classList.remove('active');
                }, 300);
            }
        }

        // Función para seleccionar una plantilla
        function selectGroupTemplate(templateId) {

            if (templateId === 'custom') {
                // Usuario quiere empezar desde cero
                closeTemplateModal();
                return;
            }

            const template = groupTemplates[templateId];
            if (!template) {
                return;
            }

            // Pre-llenar formulario con datos de la plantilla
            const groupNameInput = document.getElementById('group-name');
            const groupDescInput = document.getElementById('group-description');
            const groupTypeSelect = document.getElementById('group-type');
            const contributionInput = document.getElementById('contribution');
            const frequencySelect = document.getElementById('payment-frequency');
            const maxParticipantsInput = document.getElementById('max-participants');

            if (groupNameInput) groupNameInput.value = template.name;
            if (groupDescInput) {
                groupDescInput.value = template.description;
                // Actualizar contador de caracteres
                const charCounter = document.getElementById('desc-count');
                if (charCounter) charCounter.textContent = template.description.length;
            }
            if (groupTypeSelect) groupTypeSelect.value = template.type;
            if (contributionInput) contributionInput.value = template.contribution;
            if (frequencySelect) frequencySelect.value = template.frequency;
            if (maxParticipantsInput) maxParticipantsInput.value = template.maxParticipants;

            // Seleccionar reuniones virtuales
            const virtualMeetingValue = template.virtualMeetings ? 'yes' : 'no';
            const virtualMeetingRadio = document.querySelector(`input[name="virtual-meetings"][value="${virtualMeetingValue}"]`);
            if (virtualMeetingRadio) virtualMeetingRadio.checked = true;


            // Cerrar modal
            closeTemplateModal();

            // Mostrar notificación
            if (window.laTandaSystemComplete && window.laTandaSystemComplete.showNotification) {
                window.laTandaSystemComplete.showNotification(
                    '✅ Plantilla Cargada',
                    `Formulario pre-llenado con "${template.name}". Puedes modificar todos los valores.`,
                    'success'
                );
            }
        }

        // Event listener para cerrar modal con botón X
        document.addEventListener('DOMContentLoaded', function() {
            const closeBtn = document.querySelector('.modal-close-templates');
            if (closeBtn) {
                closeBtn.addEventListener('click', closeTemplateModal);
            }

            // Cerrar modal al hacer clic fuera del contenido
            const modalOverlay = document.getElementById('template-modal');
            if (modalOverlay) {
                modalOverlay.addEventListener('click', function(e) {
                    if (e.target === modalOverlay) {
                        closeTemplateModal();
                    }
                });
            }
        });

        // Mostrar modal automáticamente cuando se entra al tab "Create Group"
        // Esta función se llama desde el sistema de navegación de tabs
        function onCreateGroupTabActivated() {
            // Solo mostrar modal si no hay datos en el formulario
            const groupNameInput = document.getElementById('group-name');
            if (groupNameInput && !groupNameInput.value) {
                showTemplateModal();
            }
        }

        // Hook para interceptar cambio de tab a "Create Group"
        const originalSwitchTab = typeof switchTab !== 'undefined' ? switchTab : null;
        if (originalSwitchTab) {
            window.switchTab = function(tabName) {
                originalSwitchTab(tabName);
                if (tabName === 'create') {
                    setTimeout(onCreateGroupTabActivated, 300);
                }
            };
        }

    </script>
    <!-- ===== END GROUP TEMPLATES SYSTEM ===== -->

    <!-- Smart Suggestions Engine (v1.3.0) -->
    <!-- Group Duplication System (v1.4.0) -->
    <script src="group-duplication-system.js"></script>
    <script src="smart-suggestions-engine.js"></script>

    <script>
// Load position requests for awaiting_positions groups
(function() {

    async function loadPositionRequestsForGroup(groupId) {
        try {
            const authToken = localStorage.getItem("auth_token") || '';

            const response = await fetch(`/api/groups/position-requests?group_id=${groupId}`, {
                headers: { ...getAuthHeaders(),
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                }
            });

            const data = await response.json();

            if (data.success && data.data && data.data.requests) {
                const requests = data.data.requests;
                const pendingRequests = requests.filter(r => r.status === 'pending');

                updatePendingRequestsDisplay(groupId, pendingRequests);

                return pendingRequests;
            } else {
                updatePendingRequestsDisplay(groupId, []);
                return [];
            }
        } catch (error) {
            updatePendingRequestsDisplay(groupId, []);
            return [];
        }
    }

    function updatePendingRequestsDisplay(groupId, pendingRequests) {
        const groupCard = document.querySelector(`[data-group-id="${groupId}"]`);
        if (!groupCard) {
            return;
        }

        const positionSection = groupCard.querySelector('.position-assignment-section');
        if (!positionSection) {
            return;
        }

        let container = positionSection.querySelector('.pending-requests-list');
        if (!container) {
            const header = positionSection.querySelector('.position-header');
            if (header) {
                container = document.createElement('div');
                container.className = 'pending-requests-list';
                header.insertAdjacentElement('afterend', container);
            } else {
                return;
            }
        }

        if (pendingRequests.length > 0) {
            const requestsHTML = pendingRequests.map(request => `
                <div class="request-card" data-request-id="${request.id}">
                    <div class="request-header">
                        <div class="request-user">
                            <div class="request-avatar">${(request.user_name || 'User').charAt(0).toUpperCase()}</div>
                            <div class="request-info">
                                <div class="request-name">${escapeHtml(request.user_name || request.user_id)}</div>
                                <div class="request-position-badge">Posición #${request.requested_position}</div>
                            </div>
                        </div>
                        <div class="request-actions">
                            <button class="btn-approve" onclick="approvePositionRequest('${groupId}', '${request.id}')">✓</button>
                            <button class="btn-reject" onclick="openRejectModal('${groupId}', '${request.id}')">✕</button>
                        </div>
                    </div>
                    ${request.reason ? `<div class="request-reason">"${escapeHtml(request.reason)}"</div>` : ''}
                    <div class="request-timestamp">${formatRequestDate ? formatRequestDate(request.created_at) : new Date(request.created_at).toLocaleDateString()}</div>
                </div>
            `).join('');

            container.innerHTML = requestsHTML;
        } else {
            container.innerHTML = '<div class="no-requests">✅ No hay solicitudes pendientes</div>';
        }
    }

    function initializePositionRequests() {
        const positionSections = document.querySelectorAll('.position-assignment-section');

        positionSections.forEach(section => {
            const groupCard = section.closest('[data-group-id]');
            if (groupCard) {
                const groupId = groupCard.getAttribute('data-group-id');
                loadPositionRequestsForGroup(groupId);
            }
        });
    }

    // Wait for DOM and groups to load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initializePositionRequests, 1000);
        });
    } else {
        setTimeout(initializePositionRequests, 1000);
    }
    
    // Also listen for groups render events
    window.addEventListener('groupsRendered', () => {
        setTimeout(initializePositionRequests, 500);
    });

})();

    

// ========================================
// Create advancedGroupsSystem object if it doesn not exist
if (typeof advancedGroupsSystem === 'undefined') {
    if (typeof window.advancedGroupsSystem === "undefined") {
        window.advancedGroupsSystem = {};
    }
}

// TANDAS TAB FUNCTIONALITY
// ========================================

// Global state for tandas

// ========== DASHBOARD UPDATE FUNCTION ==========
function updateTandasDashboard(tandas) {
    // Separar tandas por estado
    const recruitingTandas = tandas.filter(t => t.status === "recruiting" || t.status === "pending" || t.status === "scheduled");
    const activeTandas = tandas.filter(t => t.status === "active" || t.status === "waiting-turn" || t.status === "collecting" || t.status === "scheduled" || t.status === "paused");
    const pendingPayments = activeTandas.filter(t => t.next_payment_date).sort((a, b) => new Date(a.next_payment_date) - new Date(b.next_payment_date));

    // ========== TARJETA 1: PRÓXIMO PAGO ==========
    const nextPaymentCard = document.getElementById("nextPaymentCard");
    const nextPaymentAmount = document.getElementById("nextPaymentAmount");
    const nextPaymentDue = document.getElementById("nextPaymentDue");
    const btnPayNow = document.getElementById("btnPayNow");

    if (pendingPayments.length > 0 && nextPaymentCard) {
        // Hay pagos pendientes
        const next = pendingPayments[0];
        const daysLeft = Math.ceil((new Date(next.next_payment_date) - new Date()) / (1000*60*60*24));

        if (nextPaymentAmount) nextPaymentAmount.textContent = "L. " + (next.contribution_amount || 0).toLocaleString();
        if (nextPaymentDue) nextPaymentDue.textContent = daysLeft <= 0 ? "¡VENCIDO!" : "Vence en " + daysLeft + " días";
        if (btnPayNow) {
            btnPayNow.style.display = "block";
            btnPayNow.dataset.tandaId = next.tanda_id || next.id;
        }

        nextPaymentCard.classList.remove("urgent", "warning", "ok", "recruiting");
        if (daysLeft <= 3) nextPaymentCard.classList.add("urgent");
        else if (daysLeft <= 7) nextPaymentCard.classList.add("warning");
        else nextPaymentCard.classList.add("ok");

    } else if (recruitingTandas.length > 0 && nextPaymentCard) {
        // Solo hay tandas en reclutamiento
        if (nextPaymentAmount) nextPaymentAmount.textContent = "Pendiente";
        if (nextPaymentDue) nextPaymentDue.textContent = "Esperando inicio de tanda";
        if (btnPayNow) btnPayNow.style.display = "none";
        nextPaymentCard.classList.remove("urgent", "warning", "ok");
        nextPaymentCard.classList.add("recruiting");

    } else if (nextPaymentCard) {
        // No hay tandas
        if (nextPaymentAmount) nextPaymentAmount.textContent = "L. 0.00";
        if (nextPaymentDue) nextPaymentDue.textContent = "Sin pagos pendientes";
        if (btnPayNow) btnPayNow.style.display = "none";
        nextPaymentCard.classList.remove("urgent", "warning", "recruiting");
        nextPaymentCard.classList.add("ok");
    }

    // ========== TARJETA 2: MI PRÓXIMO COBRO ==========
    const myNextCollection = document.getElementById("myNextCollection");
    const myCollectionDate = document.getElementById("myCollectionDate");
    const myCollectionCard = document.getElementById("myCollectionCard");

    // Buscar si el usuario está cobrando ahora
    const myCollection = activeTandas.find(t => t.is_my_turn || t.isMyTurn);

    if (myCollection && myNextCollection) {
        // ¡Me toca cobrar!
        const total = (myCollection.contribution_amount || 0) * (myCollection.total_participants || 1);
        myNextCollection.textContent = "L. " + total.toLocaleString();
        if (myCollectionDate) myCollectionDate.textContent = "¡Te toca cobrar!";
        if (myCollectionCard) myCollectionCard.classList.add("highlight");

    } else if (activeTandas.length > 0 && myNextCollection) {
        // Calcular turnos restantes
        const turnsAway = activeTandas
            .map(t => ({ 
                name: t.group_name || t.name, 
                turns: Math.max(0, (t.my_turn_position || 1) - (t.current_turn || 1)),
                amount: (t.contribution_amount || 0) * (t.total_participants || 1)
            }))
            .filter(t => t.turns > 0)
            .sort((a, b) => a.turns - b.turns)[0];

        if (turnsAway) {
            myNextCollection.textContent = "En " + turnsAway.turns + " turno" + (turnsAway.turns > 1 ? "s" : "");
            if (myCollectionDate) myCollectionDate.textContent = "~L. " + turnsAway.amount.toLocaleString();
        } else {
            myNextCollection.textContent = "--";
            if (myCollectionDate) myCollectionDate.textContent = "Ciclo completado";
        }
        if (myCollectionCard) myCollectionCard.classList.remove("highlight");

    } else if (recruitingTandas.length > 0 && myNextCollection) {
        // Solo tandas en reclutamiento - mostrar posición
        const firstRecruiting = recruitingTandas[0];
        myNextCollection.textContent = firstRecruiting.has_turn_assigned ? "Pos #" + (firstRecruiting.my_turn_position || 1) : "Pendiente";
        if (myCollectionDate) myCollectionDate.textContent = firstRecruiting.has_turn_assigned ? "Esperando inicio" : "Esperando asignación";
        if (myCollectionCard) myCollectionCard.classList.remove("highlight");

    } else if (myNextCollection) {
        myNextCollection.textContent = "--";
        if (myCollectionDate) myCollectionDate.textContent = "Sin tandas";
        if (myCollectionCard) myCollectionCard.classList.remove("highlight");
    }

    // ========== TARJETA 3: RESUMEN ==========
    const paymentProgress = document.getElementById("paymentProgress");
    const totalPaidEl = document.getElementById("totalPaid");
    const summaryCard = document.getElementById("summaryCard");

    const paidCount = tandas.reduce((sum, t) => sum + (t.my_contributions_paid || 0), 0);
    const totalCount = tandas.reduce((sum, t) => sum + (t.my_contributions_total || t.total_participants || 0), 0);
    const totalPaid = tandas.reduce((sum, t) => sum + ((t.my_contributions_paid || 0) * (t.contribution_amount || 0)), 0);
    const percent = totalCount > 0 ? Math.round((paidCount / totalCount) * 100) : 0;

    if (paymentProgress) paymentProgress.textContent = paidCount + "/" + totalCount + " (" + percent + "%)";
    if (totalPaidEl) totalPaidEl.textContent = "L. " + totalPaid.toLocaleString();

    // Actualizar barra de progreso si existe
    const progressBarFill = document.getElementById("summaryProgressFill");
    if (progressBarFill) {
        progressBarFill.style.width = percent + "%";
    }

}
function payNextDue() {
    const btn = document.getElementById("btnPayNow");
    if (btn && btn.dataset.tandaId) {
        quickPay(btn.dataset.tandaId);
    }
}
// ========== END DASHBOARD UPDATE FUNCTION ==========


// ===== FASE 3: LISTA DE PAGOS URGENTES =====
function renderUrgentPayments(tandas) {
    const container = document.getElementById("urgentPaymentsList");
    if (!container) return;
    
    // Separar tandas por estado
    const recruitingTandas = tandas.filter(t => t.status === "recruiting" || t.status === "pending" || t.status === "scheduled");
    const activeTandas = tandas.filter(t => t.status === "active" || t.status === "waiting-turn" || t.status === "collecting" || t.status === "scheduled" || t.status === "paused");
    
    // Filtrar tandas activas con pagos pendientes
    const pendingPayments = activeTandas
        .filter(t => t.next_payment_date)
        .map(t => {
            const dueDate = new Date(t.next_payment_date);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const daysLeft = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
            return {
                        ...t, daysLeft, dueDate };
        })
        .sort((a, b) => a.daysLeft - b.daysLeft);
    
    // Si solo hay tandas en reclutamiento
    if (pendingPayments.length === 0 && recruitingTandas.length > 0) {
        container.innerHTML = `
            <div class="recruiting-state">
                <i class="fas fa-users" style="font-size: 32px; color: #f59e0b; margin-bottom: 12px;"></i>
                <p style="color: var(--text-primary); font-weight: 500;">Tandas en Reclutamiento</p>
                <p style="color: var(--text-secondary); font-size: 14px;">${recruitingTandas.length} tanda(s) esperando más miembros para iniciar</p>
            </div>
        `;
        return;
    }
    
    // Si no hay tandas
    if (pendingPayments.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-check-circle" style="font-size: 32px; color: #10b981; margin-bottom: 12px;"></i>
                <p style="color: var(--text-primary);">¡No tienes pagos pendientes!</p>
            </div>
        `;
        return;
    }
    
    let html = "";
    pendingPayments.forEach(tanda => {
        // Determinar urgencia (colores según días restantes)
        let urgencyClass = "ok";
        let urgencyIcon = "🟢";
        if (tanda.daysLeft <= 0) {
            urgencyClass = "urgent";
            urgencyIcon = "🔴";
        } else if (tanda.daysLeft <= 3) {
            urgencyClass = "urgent";
            urgencyIcon = "🔴";
        } else if (tanda.daysLeft <= 7) {
            urgencyClass = "warning";
            urgencyIcon = "🟡";
        }
        
        const amount = parseFloat(tanda.contribution_amount || tanda.amount || 0);
        const formattedAmount = "L. " + amount.toLocaleString("es-HN", { minimumFractionDigits: 2 });
        const dueDateStr = tanda.dueDate.toLocaleDateString("es-HN", { day: "numeric", month: "short" });
        
        let daysText = "";
        if (tanda.daysLeft < 0) {
            daysText = "¡VENCIDO!";
        } else if (tanda.daysLeft === 0) {
            daysText = "¡HOY!";
        } else if (tanda.daysLeft === 1) {
            daysText = "Mañana";
        } else {
            daysText = tanda.daysLeft + " días";
        }
        
        html += `
            <div class="urgent-payment-row ${urgencyClass}">
                <span class="urgency-indicator">${urgencyIcon}</span>
                <div class="payment-info">
                    <span class="tanda-name" style="font-weight: 600; color: var(--text-primary);">${tanda.name || tanda.group_name}</span>
                    <span class="payment-details">${formattedAmount} • Vence ${dueDateStr}</span>
                </div>
                <span class="days-left" style="font-weight: 600; color: ${urgencyClass === 'urgent' ? '#ef4444' : urgencyClass === 'warning' ? '#f59e0b' : '#10b981'};">${daysText}</span>
                <button class="btn-quick-pay" onclick="quickPay('${tanda.tanda_id || tanda.id || tanda.group_id}')">
                    <i class="fas fa-credit-card"></i> PAGAR
                </button>
            </div>
        `;
    });
    
    container.innerHTML = html;
}
function renderCurrentCollectors(tandas) {
    const container = document.getElementById("currentCollectorsList");
    if (!container) return;
    
    const currentUserId = getCurrentUserId();
    
    // Separar tandas por estado
    const recruitingTandas = tandas.filter(t => t.status === "recruiting" || t.status === "pending" || t.status === "scheduled");
    const activeTandas = tandas.filter(t => t.status === "active" || t.status === "waiting-turn" || t.status === "collecting" || t.status === "scheduled" || t.status === "paused");
    
    // Si solo hay tandas en reclutamiento
    if (activeTandas.length === 0 && recruitingTandas.length > 0) {
        let html = '<div class="recruiting-collectors">';
        html += '<div style="text-align: center; padding: 16px; background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), transparent); border-radius: 12px; border: 1px dashed #f59e0b;">';
        html += '<i class="fas fa-hourglass-half" style="font-size: 24px; color: #f59e0b; margin-bottom: 8px;"></i>';
        html += '<p style="color: var(--text-primary); font-weight: 500; margin: 8px 0 4px;">Tandas en Reclutamiento</p>';
        html += '<p style="color: var(--text-secondary); font-size: 13px;">Los turnos se asignarán cuando inicien las tandas</p>';
        html += '</div>';
        
        // Mostrar lista de tandas recruiting con posición del usuario
        recruitingTandas.forEach(tanda => {
            const isCoordinator = tanda.is_coordinator === true;
            const myPosition = tanda.has_turn_assigned ? (tanda.my_turn_position || 1) : null;
            const totalMembers = tanda.members_needed || tanda.total_participants || "?";
            const membersJoined = tanda.members_joined || 1;
    const turnsAssigned = tanda.turns_assigned || 0;
            
            html += `
                <div class="collector-row recruiting" style="margin-top: 12px; border-left: 3px solid #f59e0b;">
                    <div class="collector-info">
                        <span class="collector-name" style="color: var(--text-primary);">
                            ${tanda.name || tanda.group_name}
                            ${isCoordinator ? '<span style="background: #f59e0b; color: #000; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 8px;">COORDINADOR</span>' : ''}
                        </span>
                        <span class="tanda-ref" style="color: var(--text-secondary);">
                            <i class="fas fa-users" style="margin-right: 4px;"></i> ${turnsAssigned}/${totalMembers} turnos asignados
                        </span>
                    </div>
                    <span class="turn-info" style="color: #f59e0b;">${myPosition ? "Pos #" + myPosition : "Pendiente"}</span>
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
        return;
    }
    
    // Si no hay tandas
    if (activeTandas.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-users" style="color: var(--text-secondary);"></i>
                <p>No hay tandas activas</p>
            </div>
        `;
        return;
    }
    
    // Mostrar tandas activas con cobrador actual
    let html = "";
    activeTandas.forEach(tanda => {
        const collector = tanda.current_collector || tanda.collecting_member;
        const collectorName = typeof collector === "string" ? collector : (collector ? (collector.name || collector.full_name || "Participante") : "Por definir");
        const currentTurn = tanda.current_turn || tanda.turn_number || 1;
        const totalTurns = tanda.total_turns || tanda.total_participants || tanda.num_participants || "?";
        
        // Verificar si el usuario actual es el cobrador
        const isMe = collector && (collector.id === currentUserId || collector.user_id === currentUserId);
        
        html += `
            <div class="collector-row ${isMe ? 'is-me' : ''}">
                <div class="collector-info">
                    <span class="collector-name">
                        ${isMe ? '⭐ TÚ - ¡Te toca cobrar!' : collectorName}
                    </span>
                    <span class="tanda-ref">${tanda.name || tanda.group_name}</span>
                </div>
                <span class="turn-info">Turno ${currentTurn} de ${totalTurns}</span>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Función auxiliar para obtener ID del usuario actual
// [ELIMINADO] Definicion 3 - funcion duplicada removida

// ===== FIN FASE 3 & 4 =====

// ===== FASE 5: MODAL DE PAGO RAPIDO =====
let currentPaymentTanda = null;
let userWalletBalance = 0;

async function quickPay(tandaId) {
    
    const tanda = window.tandasData ? window.tandasData.find(t => t.tanda_id === tandaId) : null;
    
    if (!tanda) {
        showToast("No se encontró la tanda: " + tandaId, "error");
        return;
    }
    
    currentPaymentTanda = tanda;
    
    // Fetch wallet balance
    let walletBalance = 0;
    try {
        const userId = getCurrentUserId();
        const response = await fetch("/api/wallet/balance?user_id=" + userId, {
            headers: { ...getAuthHeaders(),
                "Authorization": "Bearer " + (localStorage.getItem("auth_token") || localStorage.getItem("token") || "")
            }
        });
        if (response.ok) {
            const data = await response.json();
            walletBalance = parseFloat(data.balance || data.available || 0);
        }
    } catch (e) {
    }
    
    userWalletBalance = walletBalance;
    const amount = parseFloat(tanda.contribution_amount || tanda.amount || 0);
    const collector = tanda.current_collector || tanda.collecting_member;
    const beneficiaryName = collector ? (collector.name || collector.full_name || "Participante") : "Por definir";
    const dueDate = tanda.next_payment_date 
        ? new Date(tanda.next_payment_date.split("T")[0] + "T12:00:00").toLocaleDateString("es-HN", { day: "numeric", month: "long", year: "numeric" })
        : "Sin fecha";
    
    const insufficientFunds = walletBalance < amount;
    
    const content = `
        <div class="payment-summary" style="background: rgba(0,255,255,0.05); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
            <div class="summary-row" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <span style="color: #888;">Tanda:</span>
                <strong style="color: #fff;">${tanda.name || tanda.group_name}</strong>
            </div>
            <div class="summary-row" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <span style="color: #888;">Monto:</span>
                <strong style="color: #00ffff;">L. ${amount.toLocaleString("es-HN", { minimumFractionDigits: 2 })}</strong>
            </div>
            <div class="summary-row" style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <span style="color: #888;">Beneficiario:</span>
                <strong style="color: #fff;">${beneficiaryName}</strong>
            </div>
            <div class="summary-row" style="display: flex; justify-content: space-between; padding: 10px 0;">
                <span style="color: #888;">Vencimiento:</span>
                <strong style="color: #fff;">${dueDate}</strong>
            </div>
        </div>
        
        <div class="wallet-info" style="background: rgba(0,255,255,0.1); border-radius: 8px; padding: 15px; margin-bottom: 20px; text-align: center;">
            <span style="color: #00ffff;">💰 Saldo disponible: L. ${walletBalance.toLocaleString("es-HN", { minimumFractionDigits: 2 })}</span>
            ${insufficientFunds ? '<div style="color: #ff6b6b; margin-top: 10px;">⚠️ Fondos insuficientes para pago con billetera</div>' : ''}
        </div>
        
        <div class="payment-methods" style="margin-bottom: 20px;">
            <label style="display: flex; align-items: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 10px; cursor: pointer;">
                <input type="radio" name="modalPaymentMethod" value="wallet" ${insufficientFunds ? '' : 'checked'} style="margin-right: 10px;">
                <span>💳 Billetera La Tanda</span>
            </label>
            <label style="display: flex; align-items: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; cursor: pointer;">
                <input type="radio" name="modalPaymentMethod" value="transfer" ${insufficientFunds ? 'checked' : ''} style="margin-right: 10px;">
                <span>🏦 Transferencia Bancaria</span>
            </label>
        </div>
    `;
    
    window.advancedGroupsSystem.showModal({
        title: '💳 Realizar Pago',
        content: content,
        size: 'medium',
        buttons: [
            { text: 'Cancelar', class: 'btn-secondary', onclick: 'advancedGroupsSystem.hideModal()' },
            { text: 'Pagar Ahora', class: 'btn-primary', onclick: 'processModalPayment()' }
        ]
    });
}

async function processModalPayment() {
    if (!currentPaymentTanda) {
        showToast("Error: No hay tanda seleccionada", "error");
        return;
    }
    
    const selectedMethod = document.querySelector("input[name='modalPaymentMethod']:checked");
    if (!selectedMethod) {
        showToast("Selecciona un método de pago", "warning");
        return;
    }
    
    const amount = parseFloat(currentPaymentTanda.contribution_amount || currentPaymentTanda.amount || 0);
    const tandaId = currentPaymentTanda.tanda_id || currentPaymentTanda.id || currentPaymentTanda.group_id;
    
    // Show loading in modal
    const modalContent = document.querySelector('.modal-content');
    if (modalContent) {
        modalContent.innerHTML = '<div style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin" style="font-size: 40px; color: #00ffff;"></i><p style="margin-top: 20px;">Procesando pago...</p></div>';
    }
    
    try {
        const payload = {
            tanda_id: tandaId,
            amount: amount,
            payment_method: selectedMethod.value,
            user_id: getCurrentUserId()
        };
        
        const response = await fetch("/api/tandas/pay", {
            method: "POST",
            headers: { ...getAuthHeaders(),
                "Content-Type": "application/json",
                "Authorization": "Bearer " + (localStorage.getItem("auth_token") || localStorage.getItem("token") || "")
            },
            body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            window.advancedGroupsSystem.hideModal();
            showToast("¡Pago realizado exitosamente!", "success");
            currentPaymentTanda = null;
            if (typeof refreshTandas === "function") {
                refreshTandas();
            }
        } else {
            throw new Error(result.message || "Error al procesar el pago");
        }
    } catch (error) {
        showToast("Error al procesar el pago", "error");
        window.advancedGroupsSystem.hideModal();
    }
}


async function fetchWalletBalance() {
    try {
        const userId = getCurrentUserId();
        const response = await fetch("/api/wallet/balance?user_id=" + userId, {
            headers: { ...getAuthHeaders(),
                "Authorization": "Bearer " + (localStorage.getItem("auth_token") || localStorage.getItem("token") || "")
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            userWalletBalance = parseFloat(data.balance || data.available || 0);
        } else {
            userWalletBalance = 0;
        }
    } catch (error) {
        userWalletBalance = 0;
    }
    
    document.getElementById("qp-wallet-balance").textContent = 
        "Saldo: L. " + userWalletBalance.toLocaleString("es-HN", { minimumFractionDigits: 2 });
}

function checkSufficientFunds(amount) {
    const walletRadio = document.querySelector("input[name=\"paymentMethod\"][value=\"wallet\"]");
    const insufficientWarning = document.getElementById("qp-insufficient");
    const confirmBtn = document.getElementById("qp-confirm-btn");
    
    if (userWalletBalance < amount) {
        insufficientWarning.style.display = "flex";
        if (walletRadio.checked) {
            confirmBtn.disabled = true;
        }
    } else {
        insufficientWarning.style.display = "none";
        confirmBtn.disabled = false;
    }
}

function closeQuickPayModal() {
    document.getElementById("quickPayModal").style.display = "none";
    currentPaymentTanda = null;
}

async function confirmQuickPay() {
    if (!currentPaymentTanda) {
        showToast("Error: No hay tanda seleccionada", "error");
        return;
    }
    
    const selectedMethod = document.querySelector("input[name=\"paymentMethod\"]:checked").value;
    const amount = parseFloat(currentPaymentTanda.contribution_amount || currentPaymentTanda.amount || 0);
    const tandaId = currentPaymentTanda.id || currentPaymentTanda.group_id;
    
    const confirmBtn = document.getElementById("qp-confirm-btn");
    confirmBtn.disabled = true;
    confirmBtn.textContent = "Procesando...";
    
    try {
        const payload = {
            tanda_id: tandaId,
            amount: amount,
            payment_method: selectedMethod,
            user_id: getCurrentUserId()
        };
        
        const response = await fetch("/api/tandas/pay", {
            method: "POST",
            headers: { ...getAuthHeaders(),
                "Content-Type": "application/json",
                "Authorization": "Bearer " + (localStorage.getItem("auth_token") || localStorage.getItem("token") || "")
            },
            body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            showToast("Pago realizado exitosamente!", "success");
            closeQuickPayModal();
            if (typeof refreshTandas === "function") {
                refreshTandas();
            }
        } else {
            throw new Error(result.message || "Error al procesar el pago");
        }
    } catch (error) {
        showToast("Error al procesar el pago", "error");
    } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = "CONFIRMAR PAGO";
    }
}

// Event listener para cambio de metodo de pago
document.addEventListener("DOMContentLoaded", function() {
    const methodRadios = document.querySelectorAll("input[name=\"paymentMethod\"]");
    methodRadios.forEach(function(radio) {
        radio.addEventListener("change", function() {
            const confirmBtn = document.getElementById("qp-confirm-btn");
            const insufficientWarning = document.getElementById("qp-insufficient");
            
            if (this.value === "wallet" && currentPaymentTanda) {
                const amount = parseFloat(currentPaymentTanda.contribution_amount || currentPaymentTanda.amount || 0);
                if (userWalletBalance < amount) {
                    confirmBtn.disabled = true;
                    insufficientWarning.style.display = "flex";
                } else {
                    confirmBtn.disabled = false;
                    insufficientWarning.style.display = "none";
                }
            } else {
                confirmBtn.disabled = false;
                insufficientWarning.style.display = "none";
            }
        });
    });
});

// ===== FIN FASE 5 =====

// ===== FASE 6: HISTORIAL PERSONAL =====
let historyData = { payments: [], collections: [] };
let currentHistoryTab = "payments";

async function openHistoryModal() {
    
    // Show loading modal first
    window.advancedGroupsSystem.showModal({
        title: '📜 Historial de Pagos',
        content: '<div style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin" style="font-size: 40px; color: #00ffff;"></i><p style="margin-top: 20px;">Cargando historial...</p></div>',
        size: 'large'
    });
    
    const userId = getCurrentUserId();
    let payments = [];
    let collections = [];
    
    try {
        // Fetch payments sent
        const paymentsResponse = await fetch("/api/payments/history?user_id=" + userId + "&type=sent", {
            headers: { ...getAuthHeaders(),
                "Authorization": "Bearer " + (localStorage.getItem("auth_token") || localStorage.getItem("token") || "")
            }
        });
        if (paymentsResponse.ok) {
            const data = await paymentsResponse.json();
            payments = data.payments || (data.data && data.data.payments) || [];
        }
        
        // Fetch collections received
        const collectionsResponse = await fetch("/api/payments/history?user_id=" + userId + "&type=received", {
            headers: { ...getAuthHeaders(),
                "Authorization": "Bearer " + (localStorage.getItem("auth_token") || localStorage.getItem("token") || "")
            }
        });
        if (collectionsResponse.ok) {
            const data = await collectionsResponse.json();
            collections = data.payments || (data.data && data.data.payments) || [];
        }
    } catch (error) {
    }
    
    // Store for tab switching
    window.historyModalData = { payments, collections };
    
    const content = `
        <div class="history-tabs" style="display: flex; gap: 10px; margin-bottom: 20px;">
            <button class="history-tab active" onclick="switchHistoryTab('payments')" id="tab-payments" 
                style="flex: 1; padding: 12px; background: #00ffff; color: #000; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                📤 Pagos Enviados (${payments.length})
            </button>
            <button class="history-tab" onclick="switchHistoryTab('collections')" id="tab-collections"
                style="flex: 1; padding: 12px; background: rgba(255,255,255,0.1); color: #fff; border: none; border-radius: 8px; cursor: pointer;">
                📥 Cobros Recibidos (${collections.length})
            </button>
        </div>
        
        <div id="history-payments" class="history-list" style="max-height: 400px; overflow-y: auto;">
            ${payments.length ? payments.map(p => `
                <div class="history-item" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 10px;">
                    <div style="flex: 1;">
                        <div style="color: #fff; font-weight: bold;">${p.tanda_name || p.group_name || 'Tanda'}</div>
                        <div style="color: #888; font-size: 12px;">${p.recipient || 'Participante'}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: #ff6b6b; font-weight: bold;">-L. ${parseFloat(p.amount || 0).toLocaleString('es-HN', {minimumFractionDigits: 2})}</div>
                        <div style="color: #888; font-size: 12px;">${p.date ? new Date(p.date).toLocaleDateString('es-HN') : ''}</div>
                    </div>
                </div>
            `).join('') : '<div style="text-align: center; padding: 40px; color: #888;"><i class="fas fa-inbox" style="font-size: 40px; margin-bottom: 10px;"></i><p>No hay pagos enviados</p></div>'}
        </div>
        
        <div id="history-collections" class="history-list" style="max-height: 400px; overflow-y: auto; display: none;">
            ${collections.length ? collections.map(c => `
                <div class="history-item" style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 10px;">
                    <div style="flex: 1;">
                        <div style="color: #fff; font-weight: bold;">${c.tanda_name || c.group_name || 'Tanda'}</div>
                        <div style="color: #888; font-size: 12px;">${c.sender || 'Participante'}</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: #00ff88; font-weight: bold;">+L. ${parseFloat(c.amount || 0).toLocaleString('es-HN', {minimumFractionDigits: 2})}</div>
                        <div style="color: #888; font-size: 12px;">${c.date ? new Date(c.date).toLocaleDateString('es-HN') : ''}</div>
                    </div>
                </div>
            `).join('') : '<div style="text-align: center; padding: 40px; color: #888;"><i class="fas fa-inbox" style="font-size: 40px; margin-bottom: 10px;"></i><p>No hay cobros recibidos</p></div>'}
        </div>
    `;
    
    window.advancedGroupsSystem.showModal({
        title: '📜 Historial de Pagos',
        content: content,
        size: 'large',
        buttons: [
            { text: 'Cerrar', class: 'btn-secondary', onclick: 'advancedGroupsSystem.hideModal()' }
        ]
    });
}

function switchHistoryTab(tab) {
    const paymentsDiv = document.getElementById('history-payments');
    const collectionsDiv = document.getElementById('history-collections');
    const tabPayments = document.getElementById('tab-payments');
    const tabCollections = document.getElementById('tab-collections');
    
    if (tab === 'payments') {
        paymentsDiv.style.display = 'block';
        collectionsDiv.style.display = 'none';
        tabPayments.style.background = '#00ffff';
        tabPayments.style.color = '#000';
        tabCollections.style.background = 'rgba(255,255,255,0.1)';
        tabCollections.style.color = '#fff';
    } else {
        paymentsDiv.style.display = 'none';
        collectionsDiv.style.display = 'block';
        tabCollections.style.background = '#00ffff';
        tabCollections.style.color = '#000';
        tabPayments.style.background = 'rgba(255,255,255,0.1)';
        tabPayments.style.color = '#fff';
    }
}


function closeHistoryModal() {
    document.getElementById("personalHistoryModal").style.display = "none";
}

async function loadHistoryData() {
    const userId = getCurrentUserId();
    
    try {
        // Cargar pagos realizados
        const paymentsResponse = await fetch("/api/payments/history?user_id=" + userId + "&type=sent", {
            headers: { ...getAuthHeaders(),
                "Authorization": "Bearer " + (localStorage.getItem("auth_token") || localStorage.getItem("token") || "")
            }
        });
        
        if (paymentsResponse.ok) {
            const paymentsData = await paymentsResponse.json();
            const paymentsArr = paymentsData.payments || (paymentsData.data && paymentsData.data.payments) || [];
            historyData.payments = Array.isArray(paymentsArr) ? paymentsArr : [];
        }
        
        // Cargar cobros recibidos
        const collectionsResponse = await fetch("/api/payments/history?user_id=" + userId + "&type=received", {
            headers: { ...getAuthHeaders(),
                "Authorization": "Bearer " + (localStorage.getItem("auth_token") || localStorage.getItem("token") || "")
            }
        });
        
        if (collectionsResponse.ok) {
            const collectionsData = await collectionsResponse.json();
            const collectionsArr = collectionsData.payments || (collectionsData.data && collectionsData.data.payments) || [];
            historyData.collections = Array.isArray(collectionsArr) ? collectionsArr : [];
        }
        
    } catch (error) {
        historyData = { payments: [], collections: [] };
    }
    
    // Llenar filtro de tandas
    populateTandaFilter();
    
    // Actualizar resumen
    updateHistorySummary();
    
    // Renderizar lista
    renderHistoryList();
}

function populateTandaFilter() {
    const select = document.getElementById("historyTandaFilter");
    const tandaNames = new Set();
    
    historyData.payments.forEach(function(p) {
        if (p.tanda_name || p.group_name) {
            tandaNames.add(p.tanda_name || p.group_name);
        }
    });
    
    historyData.collections.forEach(function(c) {
        if (c.tanda_name || c.group_name) {
            tandaNames.add(c.tanda_name || c.group_name);
        }
    });
    
    select.innerHTML = "<option value=\"all\">Todas las tandas</option>";
    tandaNames.forEach(function(name) {
        select.innerHTML += "<option value=\"" + name + "\">" + name + "</option>";
    });
}

function updateHistorySummary() {
    let totalPaid = 0;
    let totalCollected = 0;
    
    historyData.payments.forEach(function(p) {
        totalPaid += parseFloat(p.amount || 0);
    });
    
    historyData.collections.forEach(function(c) {
        totalCollected += parseFloat(c.amount || 0);
    });
    
    document.getElementById("hist-total-paid").textContent = 
        "L. " + totalPaid.toLocaleString("es-HN", { minimumFractionDigits: 2 });
    document.getElementById("hist-total-collected").textContent = 
        "L. " + totalCollected.toLocaleString("es-HN", { minimumFractionDigits: 2 });
    document.getElementById("hist-transactions").textContent = 
        historyData.payments.length + historyData.collections.length;
}

function switchHistoryTab(tab) {
    currentHistoryTab = tab;
    
    // Actualizar tabs
    document.querySelectorAll(".history-tab").forEach(function(t) {
        t.classList.remove("active");
    });
    document.querySelector(".history-tab[data-tab=\"" + tab + "\"]").classList.add("active");
    
    // Mostrar lista correcta
    document.getElementById("paymentsList").style.display = tab === "payments" ? "flex" : "none";
    document.getElementById("collectionsList").style.display = tab === "collections" ? "flex" : "none";
    
    renderHistoryList();
}

function filterHistory() {
    renderHistoryList();
}

function renderHistoryList() {
    const tandaFilter = document.getElementById("historyTandaFilter").value;
    const periodFilter = document.getElementById("historyPeriodFilter").value;
    
    const isPayments = currentHistoryTab === "payments";
    const data = isPayments ? historyData.payments : historyData.collections;
    const container = document.getElementById(isPayments ? "paymentsList" : "collectionsList");
    
    // Filtrar datos
    let filtered = data.filter(function(item) {
        // Filtro por tanda
        if (tandaFilter !== "all") {
            const itemTanda = item.tanda_name || item.group_name || "";
            if (itemTanda !== tandaFilter) return false;
        }
        
        // Filtro por periodo
        if (periodFilter !== "all") {
            const itemDate = new Date(item.date || item.created_at);
            const now = new Date();
            
            if (periodFilter === "month") {
                if (itemDate.getMonth() !== now.getMonth() || itemDate.getFullYear() !== now.getFullYear()) {
                    return false;
                }
            } else if (periodFilter === "3months") {
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                if (itemDate < threeMonthsAgo) return false;
            } else if (periodFilter === "year") {
                if (itemDate.getFullYear() !== now.getFullYear()) return false;
            }
        }
        
        return true;
    });
    
    // Ordenar por fecha (mas reciente primero)
    filtered.sort(function(a, b) {
        return new Date(b.date || b.created_at) - new Date(a.date || a.created_at);
    });
    
    if (filtered.length === 0) {
        container.innerHTML = "<div class=\"history-empty\"><i class=\"fas fa-inbox\"></i><p>No hay " + (isPayments ? "pagos" : "cobros") + " en este periodo</p></div>";
        return;
    }
    
    let html = "";
    filtered.forEach(function(item) {
        const amount = parseFloat(item.amount || 0);
        const date = new Date(item.date || item.created_at);
        const dateStr = date.toLocaleDateString("es-HN", { day: "numeric", month: "short", year: "numeric" });
        const tandaName = item.tanda_name || item.group_name || "Tanda";
        const icon = isPayments ? "arrow-up" : "arrow-down";
        const type = isPayments ? "payment" : "collection";
        const prefix = isPayments ? "-" : "+";
        
        html += "<div class=\"history-item " + type + "\">";
        html += "  <div class=\"item-icon\"><i class=\"fas fa-" + icon + "\"></i></div>";
        html += "  <div class=\"item-info\">";
        html += "    <div class=\"item-tanda\">" + tandaName + "</div>";
        html += "    <div class=\"item-date\">" + dateStr + "</div>";
        html += "  </div>";
        html += "  <div class=\"item-amount\">" + prefix + " L. " + amount.toLocaleString("es-HN", { minimumFractionDigits: 2 }) + "</div>";
        html += "</div>";
    });
    
    container.innerHTML = html;
}

function exportHistory() {
    showToast("Funcion de exportar en desarrollo", "info");
    // TODO: Implementar exportacion a PDF
}

// ===== FIN FASE 6 =====
window.tandasData = [];
window.filteredTandas = [];

// 1. REFRESH TANDAS (Main loader)
async function refreshTandas() {
    try {
        // Show loading
        const container = document.getElementById("tandasList");
        if (!container) {
            return;
        }

        container.innerHTML = `
            <div class="loading-state">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <p>Cargando tus tandas...</p>
            </div>
        `;

        // Get user ID - use unified getCurrentUserId function
        const authToken = localStorage.getItem("auth_token") || "";
        const userId = getCurrentUserId();
        
        if (!userId) {
        }
        

        let allTandas = [];

        // 1. Try to get tandas from API
        try {
            const response = await fetch(
                `/api/tandas/my-tandas?user_id=${userId}`,
                {
                    headers: { ...getAuthHeaders(),
                        "Authorization": `Bearer ${authToken}`,
                        "Content-Type": "application/json"
                    }
                }
            );

            if (response.ok) {
                const data = await response.json();
                
                if (data.success && (data.tandas || data.data?.tandas)) {
                    allTandas = data.tandas || data.data?.tandas || [];
                }
            }
        } catch(apiError) {
        }

        // Store tandas
        window.tandasData = allTandas;
        window.filteredTandas = allTandas.slice();
        

        if (window.tandasData.length === 0) {
            // Check if user has any groups
            const userGroupCount = window.currentGroupsData ? window.currentGroupsData.length : 0;
            if (userGroupCount === 0) {
                showTandasEmptyState("NO_GROUPS");
            } else {
                showTandasEmptyState("NO_TANDAS", userGroupCount);
            }
            return;
        }

        updateTandasDashboard(window.tandasData);
        renderUrgentPayments(window.tandasData);
        renderCurrentCollectors(window.tandasData);
        renderTandas();
        startTandaLotteryCountdowns();

        // Broadcast tandas refreshed event
        if (window.tandaEventBus) {
            window.tandaEventBus.broadcast("tandasRefreshed", {
                tandas: window.tandasData,
                count: window.tandasData.length
            });
        }

    } catch (error) {
        showTandasEmptyState("Error al cargar tandas:  Intenta de nuevo.");
    }
}


// 2. RENDER TANDAS
function renderTandas() {
    const container = document.getElementById("tandasList");
    if (!container) return;

    if (window.filteredTandas.length === 0) {
        showTandasEmptyState("No tienes tandas activas. ¡Únete a un grupo para empezar!");
        return;
    }

    const html = window.filteredTandas.map(tanda => renderTandaCard(tanda)).join("");
    container.innerHTML = html;
}

// 3. RENDER TANDA CARD
// Get lottery status badge for tanda card
function getLotteryBadge(tanda) {
    if (!tanda) return "";

    // Only show for recruiting/pending status
    if (tanda.status !== "recruiting" && tanda.status !== "pending") {
        return "";
    }

    if (tanda.lottery_executed) {
        return '<span style="background: rgba(16,185,129,0.2); color: #10b981; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; display: inline-flex; align-items: center; gap: 4px;"><i class="fas fa-check-circle"></i> Posiciones asignadas</span>';
    }

    if (tanda.lottery_scheduled_at) {
        return '<span style="background: rgba(245,158,11,0.2); color: #f59e0b; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; display: inline-flex; align-items: center; gap: 4px;" data-countdown="' + tanda.lottery_scheduled_at + '" data-tanda-id="' + tanda.tanda_id + '"><i class="fas fa-dice"></i> <span class="countdown-timer">Cargando...</span></span>';
    }

    return '<span style="background: rgba(107,114,128,0.2); color: #9ca3af; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; display: inline-flex; align-items: center; gap: 4px;"><i class="fas fa-clock"></i> Tómbola pendiente</span>';
}


// Get goal reached badge for tanda card
function getGoalBadge(tanda) {
    if (!tanda) return "";
    
    // Check if recruiting and members_joined >= members_needed
    const membersJoined = tanda.members_joined || 0;
    const membersNeeded = tanda.members_needed || tanda.total_participants || 999;
    
    if ((tanda.status === "recruiting" || tanda.status === "pending") && membersJoined >= membersNeeded) {
        return '<span class="badge badge-goal-reached" style="margin-left: 4px;">🎯 Meta alcanzada</span>';
    }
    
    return "";
}

function renderTandaCard(tanda) {
    const statusLabels = {
        "active": "Activa",
        "waiting-turn": "Esperando Turno",
        "collecting": "Cobrando Este Mes",
        "completed": "Completada",
        "recruiting": "Reclutando",
        "pending": "Pendiente",
        "scheduled": "Programada",
        "paused": "Pausada"
    };

    const statusLabel = statusLabels[tanda.status] || tanda.status;
    const statusClass = tanda.status.replace(/-/g, "");
    const isRecruiting = tanda.status === "recruiting" || tanda.status === "pending" || tanda.status === "scheduled";
    const isCoordinator = tanda.is_coordinator === true;
    
    const membersJoined = tanda.members_joined || 1;
    const turnsAssigned = tanda.turns_assigned || 0;
    const membersNeeded = tanda.members_needed || tanda.total_participants;
    
    const nextPaymentFormatted = isRecruiting ? "Pendiente" : formatTandaDate(tanda.next_payment_date);
    const collectingMember = isRecruiting ? "—" : (tanda.collecting_member || "—");
    const progressText = isRecruiting 
        ? "Miembros " + membersJoined + "/" + membersNeeded
        : "Turno " + tanda.current_turn + "/" + tanda.total_participants;
    const progressPercent = isRecruiting
        ? Math.round((membersJoined / membersNeeded) * 100)
        : tanda.progress_percentage;

    let actionsHtml = "";
    if (isRecruiting && isCoordinator) {
        actionsHtml = '<button class="btn btn-sm btn-success" onclick="startTanda(\'' + tanda.tanda_id + '\')"><i class="fas fa-play"></i> Iniciar Tanda</button><button class="btn btn-sm btn-outline" onclick="inviteToTanda(\'' + tanda.tanda_id + '\')"><i class="fas fa-user-plus"></i> Invitar</button>';
    } else if (isRecruiting && tanda.has_turn_assigned) {
        actionsHtml = '<button class="btn btn-sm btn-outline" onclick="viewTandaDetails(\'' + tanda.tanda_id + '\')"><i class="fas fa-eye"></i> Ver Detalles</button><span class="waiting-text"><i class="fas fa-clock"></i> Esperando inicio</span>';
    } else if (isRecruiting) {
        actionsHtml = '<button class="btn btn-sm btn-outline" onclick="viewTandaDetails(\'' + tanda.tanda_id + '\')"><i class="fas fa-eye"></i> Ver Detalles</button><span class="waiting-text"><i class="fas fa-hourglass-half"></i> Esperando asignación de turno</span>';
    } else {
        actionsHtml = '<button class="btn btn-sm btn-secondary" onclick="openHistoryModal()"><i class="fas fa-history"></i> Historial</button><button class="btn btn-sm btn-outline" onclick="viewTandaDetails(\'' + tanda.tanda_id + '\')"><i class="fas fa-eye"></i> Ver Detalles</button><button class="btn btn-sm btn-primary" onclick="makeTandaPayment(\'' + tanda.tanda_id + '\')"><i class="fas fa-money-bill-wave"></i> Pagar</button>';
    }

    const totalAmount = tanda.total_per_turn || tanda.contribution_amount;
    const paidCount = tanda.my_contributions_paid || 0;
    const totalCount = tanda.my_contributions_total || tanda.total_participants;
    
    // Calcular desglose con comision
    const tandaPayout = calculatePayoutBreakdown(tanda.contribution_amount || 0, tanda.total_participants || 1);

    return '<div class="tanda-card status-' + tanda.status + '" data-tanda-id="' + tanda.tanda_id + '">' +
        '<div class="tanda-header">' +
            '<div class="tanda-title">' +
                '<h3>' + tanda.group_name + '</h3>' +
                '<div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">' +
                    '<span class="status-badge ' + statusClass + '">' + statusLabel + '</span>' +
                    getLotteryBadge(tanda) + getGoalBadge(tanda) +
                '</div>' +
            '</div>' +
            '<div class="tanda-amount">L. ' + formatTandaNumber(totalAmount) + '</div>' +
        '</div>' +
        '<div style="padding: 8px 16px; background: rgba(0,212,255,0.1); border-radius: 8px; margin: 8px 16px; display: flex; justify-content: space-between; align-items: center;">' +
            '<span style="color: #9ca3af; font-size: 0.85rem;">Recibes (- ' + tandaPayout.commission_rate + '% comisión)</span>' +
            '<span style="color: var(--tanda-cyan); font-weight: 600;">L. ' + formatTandaNumber(tandaPayout.user_receives) + '</span>' +
        '</div>' +
        '<div class="tanda-progress">' +
            '<div class="progress-info">' +
                '<span>' + progressText + '</span>' +
                '<span>' + progressPercent + '%</span>' +
            '</div>' +
            '<div class="progress-bar">' +
                '<div class="progress-fill" style="width: ' + progressPercent + '%"></div>' +
            '</div>' +
        '</div>' +
        '<div class="tanda-info-grid">' +
            '<div class="info-item">' +
                '<i class="fas fa-calendar"></i>' +
                '<div>' +
                    '<small>' + (isRecruiting ? "Estado" : "Próximo pago") + '</small>' +
                    '<strong>' + (isRecruiting ? "Reclutando miembros" : nextPaymentFormatted) + '</strong>' +
                '</div>' +
            '</div>' +
            '<div class="info-item">' +
                '<i class="fas fa-user-check"></i>' +
                '<div>' +
                    '<small>' + (isRecruiting ? "Coordinador" : "Cobrando") + '</small>' +
                    '<strong>' + (isRecruiting ? (isCoordinator ? "Tú" : (tanda.coordinator_name || "—")) : collectingMember) + '</strong>' +
                '</div>' +
            '</div>' +
            '<div class="info-item">' +
                '<i class="fas fa-trophy"></i>' +
                '<div>' +
                    '<small>Mi turno</small>' +
                    '<strong>' + (tanda.has_turn_assigned ? 'Pos #' + tanda.my_turn_position : 'Pendiente') + '</strong>' +
                '</div>' +
            '</div>' +
            '<div class="info-item">' +
                '<i class="fas fa-coins"></i>' +
                '<div>' +
                    '<small>Pagado</small>' +
                    '<strong>' + paidCount + '/' + totalCount + '</strong>' +
                '</div>' +
            '</div>' +
        '</div>' +
        '<div class="tanda-actions">' + actionsHtml + '</div>' +
    '</div>';
}
function filterTandas() {
    const statusFilter = document.getElementById("tandasStatusFilter");
    if (!statusFilter) return;

    const filterValue = statusFilter.value;

    if (filterValue === "all") {
        window.filteredTandas = [...window.tandasData];
    } else {
        window.filteredTandas = window.tandasData.filter(t => t.status === filterValue);
    }

    renderTandas();
}

// 5. SORT TANDAS
function sortTandas() {
    const sortOrder = document.getElementById("tandasSortOrder");
    if (!sortOrder) return;

    const sortBy = sortOrder.value;

    switch(sortBy) {
        case "next-payment":
            window.filteredTandas.sort((a, b) => new Date(a.next_payment_date) - new Date(b.next_payment_date));
            break;
        case "amount":
            window.filteredTandas.sort((a, b) => b.contribution_amount - a.contribution_amount);
            break;
        case "group-name":
            window.filteredTandas.sort((a, b) => a.group_name.localeCompare(b.group_name));
            break;
        case "turn-position":
            window.filteredTandas.sort((a, b) => a.my_turn_position - b.my_turn_position);
            break;
    }

    renderTandas();
}

// 6. SHOW TANDA HISTORY
function showTandaHistory() {
    openHistoryModal();  // Usar modal existente
    // TODO: Implement modal with tanda history
}

// 7. VIEW TANDA DETAILS

// START TANDA (coordinator only)
// Store current tanda info for modal
let currentStartTandaId = null;
let currentStartGroupId = null;

async function startTanda(tandaId) {
    // Get tanda info to find group_id
    const tanda = (window.tandasData || []).find(t => t.tanda_id === tandaId);
    if (!tanda) {
        showError("No se encontro la tanda");
        return;
    }
    
    currentStartTandaId = tandaId;
    currentStartGroupId = tanda.group_id;
    
    // Show modal and load summary
    await openStartTandaModal(tandaId, tanda.group_id);
}

async function openStartTandaModal(tandaId, groupId) {
    try {
        const token = localStorage.getItem("auth_token") || sessionStorage.getItem("auth_token") || "";
        const response = await fetch("/api/groups/" + groupId + "/start-summary", {
            headers: { "Authorization": "Bearer " + token }
        });
        
        const result = await response.json();
        if (!result.success) {
            showError("Error al cargar informacion: " + (result.data?.error?.message || "Error desconocido"));
            return;
        }
        
        const data = result.data;
        
        // Populate modal
        document.getElementById("stm-group-name").textContent = data.group_name || "Sin nombre";
        document.getElementById("stm-members").textContent = data.member_count + "/" + data.max_members;
        document.getElementById("stm-amount").textContent = "L " + (data.contribution_amount || 0) + " " + (data.frequency || "semanal");
        document.getElementById("stm-duration").textContent = data.total_duration || "N/A";
        
        // Lottery warning
        const warningBox = document.getElementById("stm-lottery-warning");
        warningBox.style.display = data.lottery_executed ? "none" : "flex";
        
        // Turns list
        const turnsList = document.getElementById("stm-turns-list");
        turnsList.innerHTML = "";
        (data.members_with_positions || []).forEach((m, idx) => {
            const li = document.createElement("li");
            li.textContent = m.name;
            turnsList.appendChild(li);
        });
        
        // Set min datetime for scheduler (now + 5 minutes)
        const minDate = new Date(Date.now() + 5 * 60000);
        document.getElementById("stm-start-datetime").min = minDate.toISOString().slice(0, 16);
        
        // Show modal
        document.getElementById("startTandaModalOverlay").classList.add("active");
        
    } catch (error) {
        showError("Error de conexion:  Intenta de nuevo.");
    }
}

function closeStartTandaModal() {
    document.getElementById("startTandaModalOverlay").classList.remove("active");
    document.getElementById("stm-schedule-section").classList.remove("show");
    currentStartTandaId = null;
    currentStartGroupId = null;
}

function toggleScheduleSection() {
    document.getElementById("stm-schedule-section").classList.toggle("show");
}

async function confirmStartTandaNow() {
    if (!currentStartTandaId) return;
    
    try {
        const userId = getCurrentUserId();
        const response = await fetch("/api/tandas/start", {
            method: "POST",
            headers: { ...getAuthHeaders(),
                "Content-Type": "application/json",
                "Authorization": "Bearer " + (localStorage.getItem("auth_token") || sessionStorage.getItem("auth_token") || "")
            },
            body: JSON.stringify({
                tanda_id: currentStartTandaId,
                user_id: userId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            closeStartTandaModal();
            showSuccess("Tanda iniciada exitosamente! El primer turno ha comenzado.");
            loadTandas();
        } else {
            showError(result.data?.error?.message || "No se pudo iniciar la tanda");
        }
    } catch (error) {
        showError("Error de conexion:  Intenta de nuevo.");
    }
}

async function confirmScheduleTandaStart() {
    if (!currentStartTandaId) return;
    
    const dateInput = document.getElementById("stm-start-datetime").value;
    if (!dateInput) {
        showWarning("Por favor selecciona una fecha y hora");
        return;
    }
    
    try {
        const userId = getCurrentUserId();
        const response = await fetch("/api/tandas/" + currentStartTandaId + "/schedule-start", {
            method: "POST",
            headers: { ...getAuthHeaders(),
                "Content-Type": "application/json",
                "Authorization": "Bearer " + (localStorage.getItem("auth_token") || sessionStorage.getItem("auth_token") || "")
            },
            body: JSON.stringify({
                start_at: new Date(dateInput).toISOString(),
                user_id: userId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            closeStartTandaModal();
            showSuccess("Tanda programada! Iniciara el " + new Date(dateInput).toLocaleString("es-ES"));
            loadTandas();
        } else {
            showError(result.data?.error?.message || "No se pudo programar");
        }
    } catch (error) {
        showError("Error de conexion:  Intenta de nuevo.");
    }
}

// Tombola countdown animation
function startLotteryCountdown() {
    if (!currentStartGroupId) {
        showError("No se ha seleccionado un grupo");
        return;
    }

    // Create overlay for animation
    const overlay = document.createElement("div");
    overlay.id = "tombola-overlay";
    overlay.style.cssText = "position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center;";

    const counter = document.createElement("div");
    counter.style.cssText = "font-size: 120px; color: #f59e0b; font-weight: bold; text-shadow: 0 0 30px rgba(245,158,11,0.5);";
    counter.textContent = "3";

    const message = document.createElement("div");
    message.style.cssText = "font-size: 24px; color: white; margin-top: 20px;";
    message.textContent = "Mezclando turnos...";

    const dice = document.createElement("div");
    dice.style.cssText = "font-size: 80px; margin-top: 30px; animation: spin 0.5s linear infinite;";
    dice.textContent = "🎲";

    // Add spin animation
    const style = document.createElement("style");
    style.textContent = "@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }";
    document.head.appendChild(style);

    overlay.appendChild(counter);
    overlay.appendChild(message);
    overlay.appendChild(dice);
    document.body.appendChild(overlay);

    let count = 3;
    const interval = setInterval(function() {
        count--;
        if (count > 0) {
            counter.textContent = count.toString();
        } else if (count === 0) {
            counter.textContent = "🎲";
            message.textContent = "Ejecutando tombola...";
        } else {
            clearInterval(interval);
            // Execute the lottery
            executeLotteryFromModal().then(function() {
                // Remove overlay after small delay
                setTimeout(function() {
                    if (overlay.parentNode) {
                        overlay.parentNode.removeChild(overlay);
                    }
                    style.remove();
                }, 500);
            }).catch(function(err) {
                if (overlay.parentNode) {
                    overlay.parentNode.removeChild(overlay);
                }
                style.remove();
                showError("Error en tombola:  Intenta de nuevo.");
            });
        }
    }, 1000);
}


async function executeLotteryFromModal() {
    if (!currentStartGroupId) return;
    
    try {
        const userId = getCurrentUserId();
        const response = await fetch("/api/groups/" + currentStartGroupId + "/lottery-assign", {
            method: "POST",
            headers: { ...getAuthHeaders(),
                "Content-Type": "application/json",
                "Authorization": "Bearer " + (localStorage.getItem("auth_token") || sessionStorage.getItem("auth_token") || "")
            },
            body: JSON.stringify({ user_id: userId })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showSuccess("Tombola ejecutada! Los turnos han sido asignados.");
            // Reload modal with updated data
            await openStartTandaModal(currentStartTandaId, currentStartGroupId);

            // Refresh tandas and groups to sync everywhere
            if (typeof refreshTandas === 'function') {
                refreshTandas();
            }
            if (typeof fetchMyGroups === 'function') {
                fetchMyGroups().then(() => {
                    if (typeof renderGroups === 'function') renderGroups();
                });
            }
        } else {
            showError(result.data?.error?.message || "Error en tombola");
        }
    } catch (error) {
        showError("Error de conexion:  Intenta de nuevo.");
    }
}

// INVITE TO TANDA
function inviteToTanda(tandaId) {
    const tanda = (window.tandasData || []).find(t => t.tanda_id === tandaId);
    if (!tanda) return;
    
    showInviteModal(tanda.group_id);
}

function viewTandaDetails(tandaId) {
    const tanda = (window.tandasData || tandasData).find(t => t.tanda_id === tandaId);
    if (!tanda) {
        return;
    }

    showInfo(`Detalles de ${tanda.group_name} - Funcion en desarrollo`);
    // TODO: Implement modal with full tanda details
}

// 8. MAKE TANDA PAYMENT
function makeTandaPayment(tandaId) {
    const tanda = (window.tandasData || tandasData).find(t => t.tanda_id === tandaId);
    if (!tanda) {
        return;
    }

    quickPay(tandaId);  // Usar el modal de pago existente
    // TODO: Integrate with payment system
}

// HELPER FUNCTIONS
function showTandasEmptyState(stateOrMessage, groupCount) {
    const container = document.getElementById("tandasList");
    if (!container) return;

    let html = "";

    if (stateOrMessage === "NO_GROUPS") {
        html = `
            <div class="tandas-empty-state">
                <div class="empty-icon" style="font-size: 4rem; margin-bottom: 20px;">👥</div>
                <h3 style="color: #f3f4f6; margin-bottom: 12px;">Aún no perteneces a ningún grupo</h3>
                <p style="color: #9ca3af; margin-bottom: 24px;">Únete a un grupo existente o crea uno nuevo para comenzar tu primera tanda.</p>
                <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="switchTab('groups')" style="padding: 12px 24px;">
                        <i class="fas fa-search"></i> Explorar Grupos
                    </button>
                    <button class="btn btn-outline" onclick="switchTab('create')" style="padding: 12px 24px;">
                        <i class="fas fa-plus"></i> Crear Grupo
                    </button>
                </div>
            </div>
        `;
    } else if (stateOrMessage === "NO_TANDAS") {
        html = `
            <div class="tandas-empty-state">
                <div class="empty-icon" style="font-size: 4rem; margin-bottom: 20px;">⏳</div>
                <h3 style="color: #f3f4f6; margin-bottom: 12px;">Tus grupos aún no tienen tandas activas</h3>
                <p style="color: #9ca3af; margin-bottom: 24px;">Estás en ${groupCount || 1} grupo(s). El coordinador debe activar la tanda para comenzar.</p>
                <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="switchTab('my-groups')" style="padding: 12px 24px;">
                        <i class="fas fa-users"></i> Ver Mis Grupos
                    </button>
                </div>
            </div>
        `;
    } else {
        // Default/error state - use message
        html = `
            <div class="tandas-empty-state">
                <div class="empty-icon" style="font-size: 4rem; margin-bottom: 20px;">💰</div>
                <h3 style="color: #f3f4f6; margin-bottom: 12px;">No hay tandas</h3>
                <p style="color: #9ca3af; margin-bottom: 24px;">${stateOrMessage}</p>
                <button class="btn btn-primary" onclick="switchTab('groups')" style="padding: 12px 24px;">
                    <i class="fas fa-search"></i> Explorar Grupos
                </button>
            </div>
        `;
    }

    container.innerHTML = html;
}

function formatTandaDate(dateString) {
    if (!dateString || dateString === "null") return "Pendiente";
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString("es-HN", {
            day: "numeric",
            month: "short",
            year: "numeric"
        });
    } catch (e) {
        return dateString;
    }
}

function formatTandaNumber(num) {
    try {
        return new Intl.NumberFormat("es-HN").format(num);
    } catch (e) {
        return num;
    }
}

// Add tandas functions to global scope for onclick handlers
// Add tandas functions to global scope - DEFERRED until system ready

// Lottery countdown functionality for tanda cards

// =============================================
// LOTTERY LIVE ANIMATION SYSTEM
// =============================================

// Show lottery animation overlay
function // Show animation with updated data structure
                    showLotteryAnimation(groupName, members, results, myTurn) {
    // Remove existing overlay if any
    const existingOverlay = document.querySelector('.lottery-animation-overlay');
    if (existingOverlay) existingOverlay.remove();

    // Create overlay
    const overlay = document.createElement('div');
    overlay.className = 'lottery-animation-overlay';

    // Build members HTML
    const membersHtml = members.map((member, idx) => {
        const result = results.find(r => r.member_id === member.id);
        const turnNum = result ? result.turn_number : '?';
        return '<div class="lottery-member" data-member-id="' + member.id + '">' +
               '<span class="member-name">' + member.name + '</span>' +
               '<span class="turn-number">#' + turnNum + '</span>' +
               '</div>';
    }).join('');

    overlay.innerHTML =
        '<div class="lottery-container">' +
            '<h2 class="lottery-title"><i class="fas fa-dice"></i> TOMBOLA EN VIVO</h2>' +
            '<p style="color: #9ca3af; margin-bottom: 1rem;">' + groupName + '</p>' +
            '<div class="lottery-wheel">' +
                '<div class="lottery-pointer"></div>' +
                '<div class="lottery-wheel-inner">' +
                    '<div class="lottery-wheel-center"><i class="fas fa-dice"></i></div>' +
                '</div>' +
            '</div>' +
            '<div class="lottery-members">' + membersHtml + '</div>' +
            '<div class="lottery-results">' +
                '<h4><i class="fas fa-check-circle"></i> Posiciones Asignadas</h4>' +
                (myTurn ?
                    '<div class="lottery-your-turn">' +
                        '<p style="margin: 0 0 0.5rem 0; opacity: 0.8;">Tu turno asignado:</p>' +
                        '<h3><i class="fas fa-trophy"></i> #' + myTurn + '</h3>' +
                    '</div>'
                : '') +
                '<button class="lottery-close-btn" onclick="closeLotteryAnimation()"><i class="fas fa-check"></i> Continuar</button>' +
            '</div>' +
        '</div>';

    document.body.appendChild(overlay);

    // Activate overlay
    setTimeout(() => overlay.classList.add('active'), 100);

    // Animate members one by one
    const memberElements = overlay.querySelectorAll('.lottery-member');
    results.forEach((result, idx) => {
        setTimeout(() => {
            const memberEl = overlay.querySelector('[data-member-id="' + result.member_id + '"]');
            if (memberEl) {
                memberEl.classList.add('assigned');
                // Play sound if available
                playLotterySound();
            }
        }, 3000 + (idx * 500)); // Start after wheel spin (3s) + stagger
    });

    // Show results after all animations
    setTimeout(() => {
        const resultsEl = overlay.querySelector('.lottery-results');
        if (resultsEl) resultsEl.classList.add('show');
    }, 3000 + (results.length * 500) + 500);
}

function closeLotteryAnimation() {
    const overlay = document.querySelector('.lottery-animation-overlay');
    if (overlay) {
        overlay.classList.remove('active');
        setTimeout(() => overlay.remove(), 500);
    }
    // Refresh tandas to show updated data
    if (typeof refreshTandas === 'function') {
        refreshTandas();
    }
}

function playLotterySound() {
    try {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + 0.2);
    } catch (e) {
        // Audio not supported, ignore
    }
}

// Poll for lottery execution (when countdown reaches zero)
function pollForLotteryExecution(tandaId, groupId) {
    let pollCount = 0;
    const maxPolls = 30; // Poll for 30 seconds max

    const pollInterval = setInterval(async () => {
        pollCount++;

        if (pollCount > maxPolls) {
            clearInterval(pollInterval);
            refreshTandas();
            return;
        }

        try {
            const token = localStorage.getItem('auth_token') || localStorage.getItem('auth_token');
            const response = await fetch('/api/groups/' + groupId + '/lottery-results', {
                headers: { 'Authorization': 'Bearer ' + token }
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success && data.data?.executed && data.data?.results) {
                    clearInterval(pollInterval);

                    // Get current user's turn
                    const userId = getCurrentUserId();
                    const myResult = data.data.results.find(r => r.user_id === userId);
                    const myTurn = myResult ? myResult.turn_number : null;

                    // Show animation
                    showLotteryAnimation(
                        data.data?.tanda_name || 'Tanda',
                        data.data?.results?.map(r => ({id: r.user_id, name: r.name})) || [],
                        data.data.results.map(r => ({member_id: r.user_id, turn_number: r.position})),
                        myTurn
                    );
                }
            }
        } catch (error) {
        }
    }, 1000);
}
// getCurrentUserId() - Now provided by LaTandaAuth in shared-components.js (removed duplicate)

function startTandaLotteryCountdowns() {
    const countdownElements = document.querySelectorAll('[data-countdown]');

    countdownElements.forEach(el => {
        const scheduledAt = new Date(el.dataset.countdown);
        const timerSpan = el.querySelector('.countdown-timer');

        if (!timerSpan) return;

        function updateCountdown() {
            const now = new Date();
            const diff = scheduledAt - now;

            if (diff <= 0) {
                timerSpan.textContent = 'Iniciando...';
                // Start polling for lottery results
                const tandaId = el.dataset.tandaId;
                if (tandaId) {
                    const groupId = el.closest('.tanda-card')?.dataset?.groupId;
                    if (groupId) pollForLotteryExecution(tandaId, groupId);
                }
                // Refresh tandas after a short delay
                setTimeout(() => {
                    if (typeof refreshTandas === 'function') {
                        refreshTandas();
                    }
                }, 2000);
                return;
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const secs = Math.floor((diff % (1000 * 60)) / 1000);

            if (days > 0) {
                timerSpan.textContent = days + 'd ' + hours + 'h';
            } else if (hours > 0) {
                timerSpan.textContent = hours + 'h ' + mins + 'm';
            } else {
                timerSpan.textContent = mins + ':' + (secs < 10 ? '0' : '') + secs;
            }
        }

        updateCountdown();
        setInterval(updateCountdown, 1000);
    });
}

// Call after rendering tandas
window.startTandaLotteryCountdowns = startTandaLotteryCountdowns;

function attachTandasFunctions() {
    // Ensure window.advancedGroupsSystem exists
    if (!window.advancedGroupsSystem) {
        window.advancedGroupsSystem = {};
    }
    
    // Assign all tandas functions
    window.advancedGroupsSystem.refreshTandas = refreshTandas;
    window.refreshTandas = refreshTandas;
    window.filterTandas = filterTandas;
    window.sortTandas = sortTandas;
    window.advancedGroupsSystem.filterTandas = filterTandas;
    window.advancedGroupsSystem.sortTandas = sortTandas;
    window.advancedGroupsSystem.showTandaHistory = showTandaHistory;
    window.viewTandaDetails = viewTandaDetails;
    window.advancedGroupsSystem.viewTandaDetails = viewTandaDetails;
    window.makeTandaPayment = makeTandaPayment;
    window.quickPay = quickPay;
    window.openHistoryModal = openHistoryModal;
    window.closeHistoryModal = closeHistoryModal;
    window.switchHistoryTab = switchHistoryTab;
    window.filterHistory = filterHistory;
    window.loadHistoryData = loadHistoryData;
    window.advancedGroupsSystem.makeTandaPayment = makeTandaPayment;

    // ========== SHOWMODAL / HIDEMODAL ==========
    if (!window.advancedGroupsSystem.showModal) {
        window.advancedGroupsSystem.showModal = function(options) {
            var title = options.title || "Modal";
            var content = options.content || "";
            var size = options.size || "large";
            var buttons = options.buttons || [];
            
            var existing = document.getElementById("modalOverlay");
            if (existing) existing.remove();

            var maxWidth = size === "large" ? "800px" : size === "medium" ? "600px" : "400px";
            
            var buttonsHtml = "";
            if (buttons.length > 0) {
                buttonsHtml = "<div class=\"modal-footer\" style=\"padding:20px;border-top:1px solid rgba(255,255,255,0.1);display:flex;gap:10px;justify-content:flex-end;\">";
                buttons.forEach(function(btn) {
                    var btnStyle = btn.class === "btn-primary" 
                        ? "background:linear-gradient(135deg,#00ffff,#00d4aa);color:#000;" 
                        : "background:rgba(255,255,255,0.1);color:#fff;";
                    buttonsHtml += "<button class=\"" + (btn.class || "btn-secondary") + "\" onclick=\"" + (btn.onclick || "advancedGroupsSystem.hideModal()") + "\" style=\"padding:12px 24px;border-radius:8px;border:none;cursor:pointer;font-weight:500;" + btnStyle + "\">" + btn.text + "</button>";
                });
                buttonsHtml += "</div>";
            }
            
            var modalHTML = "<div class=\"modal-overlay active\" id=\"modalOverlay\" style=\"visibility:visible;opacity:1;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:99999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);\">" +
                "<div class=\"modal-container " + size + "\" id=\"modalContainer\" style=\"background:rgba(15,23,42,0.98);border:1px solid rgba(0,255,255,0.3);border-radius:16px;max-width:" + maxWidth + ";width:90%;max-height:90vh;overflow-y:auto;box-shadow:0 25px 50px rgba(0,0,0,0.5);\">" +
                    "<div class=\"modal-header\" style=\"padding:20px;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;justify-content:space-between;align-items:center;\">" +
                        "<h3 style=\"color:#fff;margin:0;font-size:1.25rem;\">" + title + "</h3>" +
                        "<button onclick=\"advancedGroupsSystem.hideModal()\" style=\"background:none;border:none;color:#888;font-size:28px;cursor:pointer;line-height:1;\">&times;</button>" +
                    "</div>" +
                    "<div class=\"modal-content\" style=\"padding:20px;color:#fff;\">" + content + "</div>" +
                    buttonsHtml +
                "</div>" +
            "</div>";
            
            document.body.insertAdjacentHTML("beforeend", modalHTML);
        };
    }

    if (!window.advancedGroupsSystem.hideModal) {
        window.advancedGroupsSystem.hideModal = function() {
            var modal = document.getElementById("modalOverlay");
            if (modal) {
                modal.style.opacity = "0";
                setTimeout(function() { modal.remove(); }, 200);
            }
        };
    }
    // ========== END SHOWMODAL / HIDEMODAL ==========

    // ========== MISSING METHODS FIX - Added 2026-01-17 ==========
    
    // closeModal - Close a specific modal by ID
    if (!window.advancedGroupsSystem.closeModal) {
        window.advancedGroupsSystem.closeModal = function(modalId) {
            var modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = "none";
                modal.classList.remove("active");
            }
        };
    }
    
    // switchSettingsTab - Switch between settings tabs
    if (!window.advancedGroupsSystem.switchSettingsTab) {
        window.advancedGroupsSystem.switchSettingsTab = function(tabName) {
            // Map tab names to IDs
            var tabIds = {
                "general": "generalSettings",
                "notifications": "notificationSettings", 
                "privacy": "privacySettings",
                "appearance": "appearanceSettings",
                "language": "languageSettings"
            };
            
            // Hide all settings tabs
            document.querySelectorAll(".settings-tab").forEach(function(tab) {
                tab.style.display = "none";
            });
            
            // Remove active from all nav buttons
            document.querySelectorAll(".settings-nav-btn").forEach(function(btn) {
                btn.classList.remove("active");
            });
            
            // Show selected tab
            var targetId = tabIds[tabName] || (tabName + "Settings");
            var targetTab = document.getElementById(targetId);
            if (targetTab) {
                targetTab.style.display = "block";
            }
            
            // Activate the clicked button
            event.target.classList.add("active");
        };
    }
    
    // switchWalletTab - Switch between wallet tabs
    if (!window.advancedGroupsSystem.switchWalletTab) {
        window.advancedGroupsSystem.switchWalletTab = function(tabName) {
            // Map tab names to IDs
            var tabIds = {
                "transactions": "walletTransactions",
                "methods": "walletMethods",
                "security": "walletSecurity"
            };
            
            // Hide all wallet tabs
            document.querySelectorAll("#myWalletModal .tab-content").forEach(function(tab) {
                tab.style.display = "none";
            });
            
            // Remove active from all tab buttons
            document.querySelectorAll("#myWalletModal .tab-btn").forEach(function(btn) {
                btn.classList.remove("active");
            });
            
            // Show selected tab
            var targetId = tabIds[tabName] || ("wallet" + tabName.charAt(0).toUpperCase() + tabName.slice(1));
            var targetTab = document.getElementById(targetId);
            if (targetTab) {
                targetTab.style.display = "block";
            }
            
            // Activate clicked button
            if (event && event.target) {
                event.target.classList.add("active");
            }
        };
    }
    
    // quickSearchAction - Handle quick search suggestions
    if (!window.advancedGroupsSystem.quickSearchAction) {
        window.advancedGroupsSystem.quickSearchAction = function(action) {
            advancedGroupsSystem.closeQuickSearch();
            
            switch(action) {
                case "groups-active":
                    if (typeof switchTab === "function") switchTab("mis-grupos");
                    break;
                case "tandas-pending":
                    if (typeof switchTab === "function") switchTab("tandas");
                    break;
                case "payments-due":
                    if (typeof switchTab === "function") switchTab("tandas");
                    break;
                default:
            }
        };
    }
    
    // showHelpCategory - Show a specific help category
    if (!window.advancedGroupsSystem.showHelpCategory) {
        window.advancedGroupsSystem.showHelpCategory = function(category) {
            // Could expand a section or filter FAQs
            var helpContent = document.querySelector(".help-content");
            if (helpContent) {
                var sections = helpContent.querySelectorAll(".faq-section");
                sections.forEach(function(section) {
                    var sectionCategory = section.getAttribute("data-category");
                    if (sectionCategory === category || !sectionCategory) {
                        section.style.display = "block";
                    }
                });
            }
        };
    }
    
    // toggleFAQ - Toggle FAQ accordion item
    if (!window.advancedGroupsSystem.toggleFAQ) {
        window.advancedGroupsSystem.toggleFAQ = function(index) {
            var faqItems = document.querySelectorAll(".faq-item");
            if (faqItems[index]) {
                faqItems[index].classList.toggle("active");
                var answer = faqItems[index].querySelector(".faq-answer");
                if (answer) {
                    answer.style.display = answer.style.display === "none" ? "block" : "none";
                }
            }
        };
    }
    
    // closeUserMenu - Close the user menu panel
    if (!window.advancedGroupsSystem.closeUserMenu) {
        window.advancedGroupsSystem.closeUserMenu = function() {
            var userMenu = document.querySelector(".user-menu-panel");
            if (userMenu) {
                userMenu.classList.remove("active");
                userMenu.style.display = "none";
            }
            var overlay = document.querySelector(".menu-overlay");
            if (overlay) overlay.remove();
        };
    }
    
    // closeNotifications - Close notifications panel
    if (!window.advancedGroupsSystem.closeNotifications) {
        window.advancedGroupsSystem.closeNotifications = function() {
            var panel = document.getElementById("notificationsPanel");
            if (panel) {
                panel.style.display = "none";
                panel.classList.remove("active");
            }
        };
    }
    
    // closeQuickSearch - Close quick search panel  
    if (!window.advancedGroupsSystem.closeQuickSearch) {
        window.advancedGroupsSystem.closeQuickSearch = function() {
            var searchPanel = document.querySelector(".quick-search-panel");
            if (searchPanel) {
                searchPanel.classList.remove("active");
                searchPanel.style.display = "none";
            }
            var searchInput = document.getElementById("quickSearchInput");
            if (searchInput) searchInput.value = "";
        };
    }
    
    // openProfile - Open edit profile modal
    if (!window.advancedGroupsSystem.openProfile) {
        window.advancedGroupsSystem.openProfile = function() {
            advancedGroupsSystem.closeUserMenu();
            var modal = document.getElementById("editProfileModal");
            if (modal) {
                modal.style.display = "flex";
                modal.classList.add("active");
            }
        };
    }
    
    // openHelp - Open help/support modal
    if (!window.advancedGroupsSystem.openHelp) {
        window.advancedGroupsSystem.openHelp = function() {
            advancedGroupsSystem.closeUserMenu();
            var modal = document.getElementById("helpModal");
            if (modal) {
                modal.style.display = "flex";
                modal.classList.add("active");
            } else {
                // Fallback: show help via showModal
                advancedGroupsSystem.showModal({
                    title: "Centro de Ayuda",
                    content: "<p>¿Necesitas ayuda? Contactanos:</p><ul><li>Email: soporte@latanda.online</li><li>WhatsApp: +504 XXXX-XXXX</li></ul>",
                    size: "medium"
                });
            }
        };
    }
    
    // openWalletSettings - Open wallet in settings mode
    if (!window.advancedGroupsSystem.openWalletSettings) {
        window.advancedGroupsSystem.openWalletSettings = function() {
            advancedGroupsSystem.closeUserMenu();
            var modal = document.getElementById("myWalletModal");
            if (modal) {
                modal.style.display = "flex";
                modal.classList.add("active");
            }
        };
    }
    
    // openSecuritySettings - Open security settings
    if (!window.advancedGroupsSystem.openSecuritySettings) {
        window.advancedGroupsSystem.openSecuritySettings = function() {
            advancedGroupsSystem.closeUserMenu();
            var modal = document.getElementById("settingsModal");
            if (modal) {
                modal.style.display = "flex";
                advancedGroupsSystem.switchSettingsTab("privacy");
            }
        };
    }
    
    // openNotificationSettings - Open notification settings
    if (!window.advancedGroupsSystem.openNotificationSettings) {
        window.advancedGroupsSystem.openNotificationSettings = function() {
            advancedGroupsSystem.closeUserMenu();
            var modal = document.getElementById("settingsModal");
            if (modal) {
                modal.style.display = "flex";
                advancedGroupsSystem.switchSettingsTab("notifications");
            }
        };
    }
    
    // openPrivacySettings - Open privacy settings
    if (!window.advancedGroupsSystem.openPrivacySettings) {
        window.advancedGroupsSystem.openPrivacySettings = function() {
            advancedGroupsSystem.closeUserMenu();
            var modal = document.getElementById("settingsModal");
            if (modal) {
                modal.style.display = "flex";
                advancedGroupsSystem.switchSettingsTab("privacy");
            }
        };
    }
    
    // openVerification - Open KYC verification modal
    if (!window.advancedGroupsSystem.openVerification) {
        window.advancedGroupsSystem.openVerification = function() {
            advancedGroupsSystem.closeUserMenu();
            var modal = document.getElementById("kycVerificationModal");
            if (modal) {
                modal.style.display = "flex";
                modal.classList.add("active");
            }
        };
    }
    
    // openFeedback / openFeedbackModal - Open feedback form
    if (!window.advancedGroupsSystem.openFeedback) {
        window.advancedGroupsSystem.openFeedback = function() {
            advancedGroupsSystem.closeUserMenu();
            advancedGroupsSystem.showModal({
                title: "Enviar Feedback",
                content: "<textarea id=\"feedbackText\" placeholder=\"Tu opinión nos ayuda a mejorar...\" style=\"width:100%;height:150px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:#fff;padding:12px;resize:none;\"></textarea>",
                size: "medium",
                buttons: [
                    { text: "Cancelar", class: "btn-secondary", onclick: "advancedGroupsSystem.hideModal()" },
                    { text: "Enviar", class: "btn-primary", onclick: "advancedGroupsSystem.submitFeedback()" }
                ]
            });
        };
        window.advancedGroupsSystem.openFeedbackModal = window.advancedGroupsSystem.openFeedback;
    }
    
    // submitFeedback - Submit feedback form
    if (!window.advancedGroupsSystem.submitFeedback) {
        window.advancedGroupsSystem.submitFeedback = function() {
            var feedback = document.getElementById("feedbackText");
            if (feedback && feedback.value.trim()) {
                advancedGroupsSystem.hideModal();
                // Show success notification
                if (typeof showNotification === "function") {
                    showNotification("¡Gracias por tu feedback!", "success");
                }
            }
        };
    }
    
    // saveSettings - Save settings form
    if (!window.advancedGroupsSystem.saveSettings) {
        window.advancedGroupsSystem.saveSettings = function() {
            // Collect settings from form
            advancedGroupsSystem.closeModal("settingsModal");
            if (typeof showNotification === "function") {
                showNotification("Configuración guardada", "success");
            }
        };
    }
    
    // markAllAsRead - Mark all notifications as read
    if (!window.advancedGroupsSystem.markAllAsRead) {
        window.advancedGroupsSystem.markAllAsRead = function() {
            var notifications = document.querySelectorAll(".notification-item.unread");
            notifications.forEach(function(notif) {
                notif.classList.remove("unread");
            });
            // Update badge
            var badge = document.querySelector(".notification-badge");
            if (badge) badge.style.display = "none";
        };
    }
    
    // startChat - Start chat with support
    if (!window.advancedGroupsSystem.startChat) {
        window.advancedGroupsSystem.startChat = function() {
            window.open("https://wa.me/50412345678?text=Hola, necesito ayuda con La Tanda", "_blank");
        };
    }
    
    // logout - Logout user
    if (!window.advancedGroupsSystem.logout) {
        window.advancedGroupsSystem.logout = function() {
            if (confirm("¿Estás seguro que deseas cerrar sesión?")) {
                localStorage.removeItem("auth_token");
                localStorage.removeItem("latanda_user");
                window.location.href = "/auth-enhanced.html";
            }
        };
    }
    
    // ========== END MISSING METHODS FIX ==========

}

// Attach immediately AND on DOM load (defensive)
attachTandasFunctions();
if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", attachTandasFunctions);
} else {
    // DOM already loaded, attach again after a short delay to ensure system is ready
    setTimeout(attachTandasFunctions, 500);
}

    </script>

    <!-- Enhanced Toast Notification System -->
    <div id="toastContainer" style="position: fixed; top: 20px; right: 20px; z-index: 99999; display: flex; flex-direction: column; gap: 10px;"></div>

    <style>
        /* Toast Animations */
        @keyframes toastSlideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes toastSlideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .toast-notification {
            min-width: 300px;
            max-width: 400px;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: toastSlideIn 0.3s ease-out;
            background: white;
        }

        .toast-notification.removing {
            animation: toastSlideOut 0.3s ease-in forwards;
        }

        .toast-notification.success {
            border-left: 4px solid #10b981;
        }

        .toast-notification.error {
            border-left: 4px solid #ef4444;
        }

        .toast-notification.info {
            border-left: 4px solid #3b82f6;
        }

        .toast-notification.warning {
            border-left: 4px solid #f59e0b;
        }

        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .toast-notification.success .toast-icon {
            background: #d1fae5;
            color: #059669;
        }

        .toast-notification.error .toast-icon {
            background: #fee2e2;
            color: #dc2626;
        }

        .toast-notification.info .toast-icon {
            background: #dbeafe;
            color: #2563eb;
        }

        .toast-notification.warning .toast-icon {
            background: #fef3c7;
            color: #d97706;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            color: #111827;
            font-size: 0.9375rem;
            margin-bottom: 2px;
        }

        .toast-message {
            color: #6b7280;
            font-size: 0.8125rem;
        }

        .toast-close {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 4px;
            margin: -4px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .toast-close:hover {
            background: #f3f4f6;
            color: #6b7280;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99998;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e5e7eb;
            border-top-color: #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: 16px;
            color: #6b7280;
            font-size: 0.9375rem;
        }

        /* Button Loading State */
        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-left: 8px;
        }

        /* Smooth transitions for modals */
        .modal-overlay {
            transition: opacity 0.3s ease-out;
        }

        .modal-overlay .modal-content {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }

        /* Ripple effect for buttons */
        .btn-ripple {
            position: relative;
            overflow: hidden;
        }

        .btn-ripple::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
        }

        .btn-ripple:active::before {
            width: 200%;
            height: 200%;
        }

        /* Skeleton loading */
        .skeleton {
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: skeletonLoading 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes skeletonLoading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Improved form feedback */
        input:invalid:not(:placeholder-shown),
        select:invalid:not(:placeholder-shown) {
            border-color: #ef4444;
        }

        input:valid:not(:placeholder-shown) {
            border-color: #10b981;
        }
    </style>

    <script>
        // Enhanced Toast System
        window.showToast = function(message, type = 'info', duration = 4000) {
            var container = document.getElementById('toastContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toastContainer';
                container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 99999; display: flex; flex-direction: column; gap: 10px;';
                document.body.appendChild(container);
            }

            var icons = {
                success: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>',
                error: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
                info: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>',
                warning: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'
            };

            var titles = {
                success: 'Exito',
                error: 'Error',
                info: 'Informacion',
                warning: 'Advertencia'
            };

            var toast = document.createElement('div');
            toast.className = 'toast-notification ' + type;
            toast.innerHTML = '<div class="toast-icon">' + icons[type] + '</div>' +
                '<div class="toast-content">' +
                '<div class="toast-title">' + titles[type] + '</div>' +
                '<div class="toast-message">' + escapeHtml(message) + '</div>' +
                '</div>' +
                '<button class="toast-close" onclick="this.parentElement.classList.add(\'removing\'); setTimeout(function() { this.parentElement.remove(); }.bind(this), 300);">' +
                '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>' +
                '</button>';

            container.appendChild(toast);

            // Auto remove
            setTimeout(function() {
                if (toast.parentElement) {
                    toast.classList.add('removing');
                    setTimeout(function() {
                        toast.remove();
                    }, 300);
                }
            }, duration);
        };

        // Override existing functions
        window.showSuccess = function(message) {
            window.showToast(message, 'success');
        };

        window.showError = function(message) {
            window.showToast(message, 'error');
        };

        window.showInfo = function(message) {
            window.showToast(message, 'info');
        };

        window.showWarning = function(message) {
            window.showToast(message, 'warning');
        };

        // Loading overlay
        window.showLoadingOverlay = function(text) {
            var overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.className = 'loading-overlay';
            overlay.innerHTML = '<div class="loading-spinner"></div><div class="loading-text">' + (text || 'Cargando...') + '</div>';
            document.body.appendChild(overlay);
        };

        window.hideLoadingOverlay = function() {
            var overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.remove();
        };

        // Confirmation dialog
        window.showConfirm = function(message, onConfirm, onCancel) {
            var overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 100000;';
            overlay.innerHTML = '<div style="background: white; border-radius: 16px; padding: 24px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.25);">' +
                '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="1.5" style="margin-bottom: 16px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>' +
                '<h3 style="margin: 0 0 8px; color: #111827;">Confirmar Accion</h3>' +
                '<p style="margin: 0 0 24px; color: #6b7280;">' + message + '</p>' +
                '<div style="display: flex; gap: 12px; justify-content: center;">' +
                '<button onclick="this.closest(\'.modal-overlay\').remove(); if(typeof confirmCancel === \'function\') confirmCancel();" style="padding: 10px 24px; background: #f3f4f6; color: #374151; border: none; border-radius: 8px; cursor: pointer;">Cancelar</button>' +
                '<button onclick="this.closest(\'.modal-overlay\').remove(); if(typeof confirmAction === \'function\') confirmAction();" style="padding: 10px 24px; background: #ef4444; color: white; border: none; border-radius: 8px; cursor: pointer;">Confirmar</button>' +
                '</div></div>';

            window.confirmAction = onConfirm || function(){};
            window.confirmCancel = onCancel || function(){};

            document.body.appendChild(overlay);

            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    overlay.remove();
                    if (onCancel) onCancel();
                }
            });
        };

    </script>


    <!-- Edit Group Modal -->
    <div id="editGroupModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 550px; max-height: 85vh; overflow: hidden;">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 20px; border-radius: 16px 16px 0 0; position: relative;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 12px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                    </div>
                    <div>
                        <h3 id="editGroupModalTitle" style="margin: 0; font-size: 1.25rem; font-weight: 600;">Editar Grupo</h3>
                        <p style="margin: 4px 0 0; font-size: 0.875rem; opacity: 0.9;">Actualizar informacion del grupo</p>
                    </div>
                </div>
                <button onclick="closeEditGroupModal()" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>

            <form id="editGroupForm" onsubmit="submitGroupEdit(event)">
                <div class="modal-body" style="padding: 24px; max-height: calc(85vh - 180px); overflow-y: auto;">
                    <!-- Loading -->
                    <div id="editGroupLoading" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px;">
                        <div class="spinner" style="width: 40px; height: 40px; border: 3px solid #e5e7eb; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <p style="margin-top: 16px; color: #6b7280;">Cargando datos...</p>
                    </div>

                    <!-- Success Message -->
                    <div id="editGroupSuccess" style="display: none; text-align: center; padding: 20px;">
                        <div style="width: 60px; height: 60px; background: #d1fae5; border-radius: 50%; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center;">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#059669" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </div>
                        <h4 style="margin: 0 0 8px; color: #111827;">Grupo Actualizado!</h4>
                        <p style="margin: 0; color: #6b7280; font-size: 0.875rem;">Los cambios han sido guardados exitosamente.</p>
                    </div>

                    <!-- Form Fields -->
                    <div id="editGroupFormFields" style="display: none;">
                        <!-- Group Name -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 6px; font-size: 0.875rem;">Nombre del Grupo *</label>
                            <input type="text" id="editGroupName" required placeholder="Ej: Tanda Familiar" style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9375rem; box-sizing: border-box;">
                        </div>

                        <!-- Description -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 6px; font-size: 0.875rem;">Descripcion</label>
                            <textarea id="editGroupDescription" rows="3" placeholder="Descripcion del grupo..." style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9375rem; resize: vertical; box-sizing: border-box;"></textarea>
                        </div>

                        <!-- Contribution Amount & Frequency Row -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                            <div>
                                <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 6px; font-size: 0.875rem;">Contribucion (L.)</label>
                                <input type="number" id="editGroupAmount" min="1" step="0.01" placeholder="200.00" style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9375rem; box-sizing: border-box;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 6px; font-size: 0.875rem;">Frecuencia</label>
                                <select id="editGroupFrequency" style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9375rem; box-sizing: border-box; background: white;">
                                    <option value="weekly">Semanal</option>
                                    <option value="biweekly">Quincenal</option>
                                    <option value="monthly">Mensual</option>
                                </select>
                            </div>
                        </div>

                        <!-- Max Members & Location Row -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                            <div>
                                <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 6px; font-size: 0.875rem;">Max Miembros</label>
                                <input type="number" id="editGroupMaxMembers" min="2" max="50" placeholder="12" style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9375rem; box-sizing: border-box;">
                            </div>
                            <div>
                                <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 6px; font-size: 0.875rem;">Ubicacion</label>
                                <input type="text" id="editGroupLocation" placeholder="Tegucigalpa" style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9375rem; box-sizing: border-box;">
                            </div>
                        </div>

                        <!-- Fecha de Inicio -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 6px; font-size: 0.875rem;">Fecha de Inicio</label>
                            <input type="date" id="editGroupStartDate" style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9375rem; box-sizing: border-box;">
                            <p style="margin: 4px 0 0; font-size: 0.75rem; color: #6b7280;">Fecha en que inicia el ciclo de la tanda</p>
                        </div>

                        <!-- Status -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 6px; font-size: 0.875rem;">Estado del Grupo</label>
                            <select id="editGroupStatus" style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9375rem; box-sizing: border-box; background: white;">
                                <option value="active">Activo</option>
                                <option value="paused">Pausado</option>
                                <option value="completed">Completado</option>
                            </select>
                        </div>

                        <div id="editGroupError" style="display: none; padding: 12px; background: #fee2e2; color: #dc2626; border-radius: 8px; font-size: 0.875rem;"></div>
                    </div>
                </div>

                <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid #e5e7eb; background: #f9fafb; border-radius: 0 0 16px 16px; display: flex; gap: 12px; justify-content: flex-end;" id="editGroupFormFooter">
                    <button type="button" onclick="closeEditGroupModal()" style="padding: 10px 20px; background: #f3f4f6; color: #374151; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">Cancelar</button>
                    <button type="submit" id="editGroupSubmitBtn" style="padding: 10px 24px; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

    <style>
        #editGroupModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        #editGroupModal .modal-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            width: 90%;
            animation: modalSlideIn 0.3s ease-out;
        }

        #editGroupModal input:focus,
        #editGroupModal select:focus,
        #editGroupModal textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        #editGroupSubmitBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>



    <!-- ===== DELETE GROUP CONFIRMATION MODAL ===== -->
    <div id="deleteGroupModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 99999; justify-content: center; align-items: center;">
        <div class="modal-content" style="max-width: 450px; background: #1a2332; border-radius: 16px; overflow: hidden; margin: 20px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); color: white; padding: 20px; position: relative;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 12px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            <line x1="10" y1="11" x2="10" y2="17"/>
                            <line x1="14" y1="11" x2="14" y2="17"/>
                        </svg>
                    </div>
                    <div>
                        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">Eliminar Grupo</h3>
                        <p style="margin: 4px 0 0; font-size: 0.875rem; opacity: 0.9;">Esta accion es irreversible</p>
                    </div>
                </div>
                <button onclick="closeDeleteGroupModal()" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            
            <div class="modal-body" style="padding: 24px;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="width: 64px; height: 64px; background: #fef2f2; border-radius: 50%; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center;">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                    </div>
                    <h4 style="margin: 0 0 8px; color: #f3f4f6; font-size: 1.1rem;">¿Estas seguro?</h4>
                    <p style="margin: 0; color: #9ca3af; font-size: 0.9rem;">Vas a eliminar el grupo:</p>
                    <p id="deleteGroupName" style="margin: 8px 0 0; color: #f97316; font-weight: 600; font-size: 1rem;">Nombre del Grupo</p>
                </div>
                
                <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 10px; padding: 12px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#d97706" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                            <line x1="12" y1="9" x2="12" y2="13"/>
                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                        <div style="color: #92400e; font-size: 0.85rem;">
                            <strong>Nota:</strong> No se puede eliminar grupos con contribuciones registradas. Los grupos activos con dinero deben completar su ciclo.
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px;">
                    <button onclick="closeDeleteGroupModal()" style="flex: 1; padding: 14px; background: #374151; border: none; border-radius: 10px; color: white; font-size: 0.9375rem; font-weight: 500; cursor: pointer;">
                        Cancelar
                    </button>
                    <button id="confirmDeleteBtn" onclick="executeDeleteGroup()" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #dc2626, #991b1b); border: none; border-radius: 10px; color: white; font-size: 0.9375rem; font-weight: 500; cursor: pointer;">
                        Si, Eliminar Grupo
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- ===== END DELETE GROUP MODAL ===== -->

    <!-- ===== MANAGE TURNS MODAL ===== -->
    <div id="manageTurnsModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 99999; justify-content: center; align-items: center;">
        <div class="modal-content" style="max-width: 500px; background: #1a2332; border-radius: 16px; overflow: hidden; margin: 20px; max-height: 80vh;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 20px; position: relative;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 12px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M8 12l2 2 4-4"/>
                        </svg>
                    </div>
                    <div>
                        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">Gestionar Turnos</h3>
                        <p style="margin: 4px 0 0; font-size: 0.875rem; opacity: 0.9;">Arrastra para reordenar</p>
                    </div>
                </div>
                <button onclick="closeManageTurnsModal()" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            
            <div class="modal-body" style="padding: 20px; max-height: calc(80vh - 180px); overflow-y: auto;">
                <!-- Loading -->
                <div id="turnsLoading" style="display: none; text-align: center; padding: 40px;">
                    <div class="spinner" style="width: 40px; height: 40px; border: 3px solid #374151; border-top-color: #f59e0b; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                    <p style="margin-top: 16px; color: #9ca3af;">Cargando miembros...</p>
                </div>
                
                <!-- Error -->
                <div id="turnsError" style="display: none; padding: 16px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 10px; color: #dc2626; text-align: center;"></div>
                
                <!-- Turns List -->
                <div id="turnsContent" style="display: none;"></div>
                
                <!-- Instructions -->
                <div style="margin-top: 16px; padding: 12px; background: #1e293b; border-radius: 10px;">
                    <div style="display: flex; align-items: flex-start; gap: 10px;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#60a5fa" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="16" x2="12" y2="12"/>
                            <line x1="12" y1="8" x2="12.01" y2="8"/>
                        </svg>
                        <div style="color: #9ca3af; font-size: 0.8rem;">
                            Usa las flechas o arrastra los miembros para cambiar el orden de turnos. El numero indica el orden en que recibiran el pago.
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer" style="padding: 16px 20px; border-top: 1px solid #334155; display: flex; gap: 12px;">
                <button onclick="closeManageTurnsModal()" style="flex: 1; padding: 12px; background: #374151; border: none; border-radius: 10px; color: white; font-size: 0.9375rem; cursor: pointer;">
                    Cancelar
                </button>
                <button id="saveTurnsBtn" onclick="saveTurnsOrder()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #f59e0b, #d97706); border: none; border-radius: 10px; color: white; font-size: 0.9375rem; font-weight: 500; cursor: pointer;">
                    Guardar Cambios
                </button>
            </div>
        </div>
    </div>
    <!-- ===== END MANAGE TURNS MODAL ===== -->
    <!-- Register Payment Modal -->
    <div id="registerPaymentModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 520px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden;">
            <div class="modal-header" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; padding: 20px; border-radius: 16px 16px 0 0; position: relative;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 12px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                        </svg>
                    </div>
                    <div>
                        <h3 id="registerPaymentModalTitle" style="margin: 0; font-size: 1.25rem; font-weight: 600;">Registrar Pago</h3>
                        <p id="registerPaymentModalSubtitle" style="margin: 4px 0 0; font-size: 0.875rem; opacity: 0.9;">Contribucion al grupo</p>
                    </div>
                </div>
                <button onclick="closeRegisterPaymentModal()" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>

            <!-- Step Indicator -->
            <div id="paymentStepIndicator" style="display: flex; justify-content: center; gap: 8px; padding: 16px; background: #f9fafb; border-bottom: 1px solid #e5e7eb;">
                <div class="step-dot active" data-step="1" style="width: 10px; height: 10px; border-radius: 50%; background: #059669;"></div>
                <div class="step-dot" data-step="2" style="width: 10px; height: 10px; border-radius: 50%; background: #d1d5db;"></div>
                <div class="step-dot" data-step="3" style="width: 10px; height: 10px; border-radius: 50%; background: #d1d5db;"></div>
            </div>

            <div class="modal-body" style="padding: 24px; flex: 1; overflow-y: auto;">
                
                <!-- STEP 1: Select Method and Amount -->
                <div id="paymentStep1" class="payment-step">
                    <h4 style="margin: 0 0 16px; color: #111827; font-size: 1rem;">Paso 1: Selecciona metodo y monto</h4>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 6px; font-size: 0.875rem;">Monto de Contribucion (L.) *</label>
                        <input type="number" id="paymentAmount" required min="1" step="0.01" placeholder="0.00" style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 1rem; box-sizing: border-box;">
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 6px; font-size: 0.875rem;">Metodo de Pago *</label>
                        <div id="paymentMethodCards" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <div class="payment-method-card" data-method="bank_transfer" onclick="selectPaymentMethod('bank_transfer')" style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 16px; cursor: pointer; text-align: center; transition: all 0.2s;">
                                <div style="font-size: 24px; margin-bottom: 8px;">🏦</div>
                                <div style="font-weight: 500; color: #374151; font-size: 0.875rem;">Transferencia</div>
                            </div>
                            <div class="payment-method-card" data-method="mobile_money" onclick="selectPaymentMethod('mobile_money')" style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 16px; cursor: pointer; text-align: center; transition: all 0.2s;">
                                <div style="font-size: 24px; margin-bottom: 8px;">📱</div>
                                <div style="font-weight: 500; color: #374151; font-size: 0.875rem;">Tigo Money</div>
                            </div>
                            <div class="payment-method-card" data-method="cash" onclick="selectPaymentMethod('cash')" style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 16px; cursor: pointer; text-align: center; transition: all 0.2s;">
                                <div style="font-size: 24px; margin-bottom: 8px;">💵</div>
                                <div style="font-weight: 500; color: #374151; font-size: 0.875rem;">Efectivo</div>
                            </div>
                            <div class="payment-method-card" data-method="crypto" onclick="selectPaymentMethod('crypto')" style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 16px; cursor: pointer; text-align: center; transition: all 0.2s;">
                                <div style="font-size: 24px; margin-bottom: 8px;">₿</div>
                                <div style="font-weight: 500; color: #374151; font-size: 0.875rem;">Crypto</div>
                            </div>
                        </div>
                        <input type="hidden" id="paymentMethod" value="">
                    </div>

                    <div id="paymentStep1Error" style="display: none; padding: 12px; background: #fee2e2; color: #dc2626; border-radius: 8px; margin-bottom: 16px; font-size: 0.875rem;"></div>
                </div>

                <!-- STEP 2: Instructions -->
                <div id="paymentStep2" class="payment-step" style="display: none;">
                    <h4 style="margin: 0 0 16px; color: #111827; font-size: 1rem;">Paso 2: Realiza el pago</h4>
                    
                    <!-- Reference Code Box -->
                    <div id="referenceCodeBox" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); border-radius: 12px; padding: 16px; margin-bottom: 20px; color: white; text-align: center;">
                        <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 4px;">TU CODIGO DE REFERENCIA</div>
                        <div id="referenceCodeDisplay" style="font-size: 1.1rem; font-weight: 700; font-family: monospace; letter-spacing: 1px;">LT-CNT-XXXX-XXXX</div>
                        <button type="button" onclick="copyReferenceCode()" style="margin-top: 10px; background: rgba(255,255,255,0.2); border: none; padding: 6px 12px; border-radius: 6px; color: white; cursor: pointer; font-size: 0.75rem;">
                            📋 Copiar Codigo
                        </button>
                    </div>

                    <!-- Instructions List -->
                    <div id="paymentInstructionsList" style="background: #f9fafb; border-radius: 12px; padding: 16px;">
                        <div style="font-weight: 600; color: #374151; margin-bottom: 12px;" id="instructionsTitle">Instrucciones</div>
                        <ol id="instructionsSteps" style="margin: 0; padding-left: 20px; color: #4b5563; font-size: 0.875rem; line-height: 1.8;"></ol>
                    </div>

                    <!-- Bank Details (for transfers) -->
                    <div id="bankDetailsBox" style="display: none; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 12px; padding: 16px; margin-top: 16px;">
                        <div style="font-weight: 600; color: #1e40af; margin-bottom: 12px;">📋 Datos Bancarios</div>
                        <div id="bankDetailsContent" style="font-size: 0.875rem; color: #1e3a8a;"></div>
                    </div>

                    <!-- Time indicator -->
                    <div id="verificationTimeBox" style="display: flex; align-items: center; gap: 8px; margin-top: 16px; padding: 12px; background: #fef3c7; border-radius: 8px;">
                        <span style="font-size: 1.2rem;">⏱️</span>
                        <span id="verificationTimeText" style="font-size: 0.875rem; color: #92400e;"></span>
                    </div>
                </div>

                <!-- STEP 3: Upload Proof -->
                <div id="paymentStep3" class="payment-step" style="display: none;">
                    <h4 style="margin: 0 0 16px; color: #111827; font-size: 1rem;">Paso 3: Sube tu comprobante</h4>
                    
                    <div id="proofUploadArea" style="border: 2px dashed #d1d5db; border-radius: 12px; padding: 32px; text-align: center; cursor: pointer; transition: all 0.2s;" onclick="document.getElementById('proofFileInput').click()">
                        <div id="proofPreview" style="display: none;">
                            <img id="proofPreviewImage" style="max-width: 100%; max-height: 200px; border-radius: 8px; margin-bottom: 12px;" alt=>
                        </div>
                        <div id="proofUploadPrompt">
                            <div style="font-size: 48px; margin-bottom: 12px;">📷</div>
                            <div style="font-weight: 500; color: #374151; margin-bottom: 4px;">Subir comprobante</div>
                            <div style="font-size: 0.875rem; color: #6b7280;">Toca para seleccionar imagen</div>
                        </div>
                        <input type="file" id="proofFileInput" accept="image/*" style="display: none;" onchange="handleProofUpload(event)">
                    </div>

                    <div id="paymentStep3Error" style="display: none; padding: 12px; background: #fee2e2; color: #dc2626; border-radius: 8px; margin-top: 16px; font-size: 0.875rem;"></div>

                    <div style="margin-top: 16px; padding: 12px; background: #ecfdf5; border-radius: 8px; font-size: 0.875rem; color: #065f46;">
                        <strong>Importante:</strong> El comprobante es obligatorio para verificar tu pago.
                    </div>
                </div>

                <!-- SUCCESS State -->
                <div id="paymentSuccess" class="payment-step" style="display: none; text-align: center; padding: 20px;">
                    <div style="width: 70px; height: 70px; background: #d1fae5; border-radius: 50%; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center;">
                        <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#059669" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <h4 style="margin: 0 0 8px; color: #111827; font-size: 1.25rem;">Pago Registrado!</h4>
                    <p id="paymentSuccessMessage" style="margin: 0 0 8px; color: #6b7280; font-size: 0.875rem;">Tu pago ha sido registrado exitosamente.</p>
                    <div id="paymentSuccessCode" style="background: #f3f4f6; padding: 12px; border-radius: 8px; margin: 16px 0; font-family: monospace; font-size: 0.875rem; color: #374151;"></div>
                    <p style="margin: 0 0 20px; color: #6b7280; font-size: 0.8rem;" id="paymentSuccessStatus">Estado: Esperando verificacion</p>
                </div>

            </div>

            <!-- Footer with navigation buttons -->
            <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid #e5e7eb; background: #f9fafb; border-radius: 0 0 16px 16px; display: flex; gap: 12px; justify-content: space-between;" id="paymentFormFooter">
                <button type="button" id="paymentBackBtn" onclick="paymentPrevStep()" style="display: none; padding: 10px 20px; background: #f3f4f6; color: #374151; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                    ← Atras
                </button>
                <div style="flex: 1;"></div>
                <button type="button" id="paymentCancelBtn" onclick="closeRegisterPaymentModal()" style="padding: 10px 20px; background: #f3f4f6; color: #374151; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">Cancelar</button>
                <button type="button" id="paymentNextBtn" onclick="paymentNextStep()" style="padding: 10px 24px; background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                    Continuar →
                </button>
                <button type="button" id="paymentDoneBtn" onclick="closeRegisterPaymentModal()" style="display: none; padding: 10px 24px; background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <style>
        .payment-method-card:hover { border-color: #059669 !important; background: #ecfdf5; }
        .payment-method-card.selected { border-color: #059669 !important; background: #d1fae5; }
        #proofUploadArea:hover { border-color: #059669; background: #f9fafb; }
        .step-dot.active { background: #059669 !important; }
        .step-dot.completed { background: #059669 !important; }
        #registerPaymentModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        #registerPaymentModal .modal-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            animation: modalSlideIn 0.3s ease-out;
        }

        #registerPaymentModal .modal-body {
            flex: 1;
            overflow-y: auto;
        }

        #registerPaymentModal .modal-footer {
            flex-shrink: 0;
        }

        #registerPaymentModal input:focus,
        #registerPaymentModal select:focus,
        #registerPaymentModal textarea:focus {
            outline: none;
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }

        #paymentSubmitBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>


    <!-- View Members Modal -->
    <div id="groupMembersModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 600px; max-height: 85vh; overflow: hidden;">
            <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 20px; border-radius: 16px 16px 0 0; position: relative;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 12px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                    </div>
                    <div>
                        <h3 id="membersModalTitle" style="margin: 0; font-size: 1.25rem; font-weight: 600;">Miembros del Grupo</h3>
                        <p id="membersModalSubtitle" style="margin: 4px 0 0; font-size: 0.875rem; opacity: 0.9;">Lista de participantes</p>
                    </div>
                </div>
                <button onclick="closeMembersModal()" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>

            <div class="modal-body" style="padding: 20px; max-height: calc(85vh - 140px); overflow-y: auto;">
                <!-- Loading -->
                <div id="membersLoading" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px;">
                    <div class="spinner" style="width: 40px; height: 40px; border: 3px solid #e5e7eb; border-top-color: #8b5cf6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="margin-top: 16px; color: #6b7280;">Cargando miembros...</p>
                </div>

                <!-- Members List -->
                <div id="membersList" style="display: none;"></div>

                <!-- Empty State -->
                <div id="membersEmpty" style="display: none; text-align: center; padding: 40px;">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="1.5" style="margin-bottom: 16px;">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                    </svg>
                    <p style="color: #6b7280; margin: 0;">No hay miembros en este grupo</p>
                </div>
            </div>
        </div>
    </div>

    <style>
        #groupMembersModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        #groupMembersModal .modal-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            width: 90%;
            animation: modalSlideIn 0.3s ease-out;
        }

        .member-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 12px;
            margin-bottom: 8px;
        }

        .member-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.125rem;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-weight: 500;
            color: #111827;
            margin-bottom: 2px;
        }

        .member-role {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 9999px;
            display: inline-block;
        }

        .member-role.creator { background: #fef3c7; color: #d97706; }
        .member-role.coordinator { background: #dbeafe; color: #2563eb; }
        .member-role.member { background: #f3f4f6; color: #6b7280; }

        .member-position {
            font-size: 0.8125rem;
            color: #6b7280;
        }

        /* Current user highlight */
        .member-card.current-user {
            background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
            border: 2px solid #8b5cf6;
        }

        .member-avatar.anonymous {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }

        /* Member action buttons */
        .member-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 0 0 12px 12px;
            margin-top: -8px;
            margin-bottom: 8px;
            border-top: 1px dashed #e5e7eb;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            font-size: 0.8125rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn.anonymous-btn {
            background: #fef3c7;
            color: #d97706;
        }
        .action-btn.anonymous-btn:hover {
            background: #fde68a;
        }

        .action-btn.role-btn {
            background: #dbeafe;
            color: #2563eb;
        }
        .action-btn.role-btn:hover {
            background: #bfdbfe;
        }

        .action-btn.leave-btn {
            background: #fee2e2;
            color: #dc2626;
        }
        .action-btn.leave-btn:hover {
            background: #fecaca;
        }

        .action-btn.leave-btn.warning {
            background: #ffedd5;
            color: #ea580c;
        }
        .action-btn.leave-btn.warning:hover {
            background: #fed7aa;
        }

        .member-position {
            font-size: 0.8125rem;
            color: #6b7280;
        }
    </style>


    <!-- View Payments Modal -->

    <!-- Leave Group Confirmation Modal -->
    <div id="leaveGroupConfirmModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100001; justify-content: center; align-items: center;">
        <div class="modal-content" style="max-width: 400px; background: #1a2332; border-radius: 16px; overflow: hidden; margin: 20px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #dc2626, #991b1b); color: white; padding: 20px; position: relative;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 12px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                            <polyline points="16 17 21 12 16 7"/>
                            <line x1="21" y1="12" x2="9" y2="12"/>
                        </svg>
                    </div>
                    <div>
                        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">Salir del Grupo</h3>
                        <p style="margin: 4px 0 0; font-size: 0.875rem; opacity: 0.9;">Esta accion no se puede deshacer</p>
                    </div>
                </div>
                <button onclick="closeLeaveConfirmModal()" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; color: white; cursor: pointer;">X</button>
            </div>
            <div style="padding: 24px; text-align: center;">
                <p style="color: #e5e7eb; margin-bottom: 24px;">Estas seguro que deseas salir de este grupo? Perderas tu posicion y no podras volver a unirte automaticamente.</p>
                <div style="display: flex; gap: 12px;">
                    <button onclick="closeLeaveConfirmModal()" style="flex: 1; padding: 12px; background: #374151; border: none; border-radius: 10px; color: white; cursor: pointer;">Cancelar</button>
                    <button id="confirmLeaveBtn" onclick="executeLeaveGroup()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #dc2626, #991b1b); border: none; border-radius: 10px; color: white; cursor: pointer;">Si, Salir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Role Modal -->
    <div id="requestRoleModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100001; justify-content: center; align-items: center;">
        <div class="modal-content" style="max-width: 420px; background: #1a2332; border-radius: 16px; overflow: hidden; margin: 20px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; padding: 20px; position: relative;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 12px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="8.5" cy="7" r="4"/>
                            <line x1="20" y1="8" x2="20" y2="14"/>
                            <line x1="23" y1="11" x2="17" y2="11"/>
                        </svg>
                    </div>
                    <div>
                        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">Solicitar Rol</h3>
                        <p style="margin: 4px 0 0; font-size: 0.875rem; opacity: 0.9;">El admin revisara tu solicitud</p>
                    </div>
                </div>
                <button onclick="closeRequestRoleModal()" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; color: white; cursor: pointer;">X</button>
            </div>
            <div style="padding: 24px;">
                <div id="roleOptionsContainer" style="margin-bottom: 16px;"></div>
                <style>
                    .role-option {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 12px;
                        background: #243447;
                        border-radius: 10px;
                        margin-bottom: 8px;
                        cursor: pointer;
                        color: #e5e7eb;
                    }
                    .role-option:hover { background: #2d4156; }
                    .role-option input { width: 18px; height: 18px; }
                    .role-option span { font-weight: 500; }
                    .role-option small { display: block; font-size: 0.75rem; color: #9ca3af; margin-top: 2px; }
                </style>
                <textarea id="roleRequestReason" placeholder="Razon de la solicitud (opcional)..." style="width: 100%; padding: 12px; background: #243447; border: 1px solid #374151; border-radius: 10px; color: #e5e7eb; resize: none; height: 80px; margin-bottom: 16px;"></textarea>
                <div style="display: flex; gap: 12px;">
                    <button onclick="closeRequestRoleModal()" style="flex: 1; padding: 12px; background: #374151; border: none; border-radius: 10px; color: white; cursor: pointer;">Cancelar</button>
                    <button id="submitRoleRequestBtn" onclick="submitRoleRequest()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #2563eb, #1d4ed8); border: none; border-radius: 10px; color: white; cursor: pointer;">Enviar Solicitud</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Transfer Ownership Modal -->
    <div id="transferOwnershipModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100001; justify-content: center; align-items: center;">
        <div class="modal-content" style="max-width: 420px; background: #1a2332; border-radius: 16px; overflow: hidden; margin: 20px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #ea580c, #c2410c); color: white; padding: 20px; position: relative;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 12px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 1l4 4-4 4"/>
                            <path d="M3 11V9a4 4 0 0 1 4-4h14"/>
                            <path d="M7 23l-4-4 4-4"/>
                            <path d="M21 13v2a4 4 0 0 1-4 4H3"/>
                        </svg>
                    </div>
                    <div>
                        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">Transferir Propiedad</h3>
                        <p style="margin: 4px 0 0; font-size: 0.875rem; opacity: 0.9;">Selecciona el nuevo propietario</p>
                    </div>
                </div>
                <button onclick="closeTransferOwnershipModal()" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; color: white; cursor: pointer;">X</button>
            </div>
            <div style="padding: 24px;">
                <p style="color: #fbbf24; background: rgba(251,191,36,0.1); padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 0.875rem;">
                    <strong>Importante:</strong> Al transferir la propiedad, perderas todos los permisos de administrador y el nuevo propietario tendra control total del grupo.
                </p>
                <select id="newOwnerSelect" style="width: 100%; padding: 12px; background: #243447; border: 1px solid #374151; border-radius: 10px; color: #e5e7eb; margin-bottom: 16px;">
                    <option value="">Cargando miembros...</option>
                </select>
                <div style="display: flex; gap: 12px;">
                    <button onclick="closeTransferOwnershipModal()" style="flex: 1; padding: 12px; background: #374151; border: none; border-radius: 10px; color: white; cursor: pointer;">Cancelar</button>
                    <button id="confirmTransferBtn" onclick="executeTransferOwnership()" style="flex: 1; padding: 12px; background: linear-gradient(135deg, #ea580c, #c2410c); border: none; border-radius: 10px; color: white; cursor: pointer;">Transferir y Continuar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="groupPaymentsModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 700px; max-height: 85vh; overflow: hidden;">
            <div class="modal-header" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; padding: 20px; border-radius: 16px 16px 0 0; position: relative;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 12px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                        </svg>
                    </div>
                    <div>
                        <h3 id="paymentsModalTitle" style="margin: 0; font-size: 1.25rem; font-weight: 600;">Historial de Pagos</h3>
                        <p id="paymentsModalSubtitle" style="margin: 4px 0 0; font-size: 0.875rem; opacity: 0.9;">Contribuciones del grupo</p>
                    </div>
                </div>
                <button onclick="closePaymentsModal()" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>

            <!-- Stats Summary -->
            <div id="paymentsSummary" style="padding: 16px 20px; background: #f0fdf4; border-bottom: 1px solid #d1fae5; display: none;">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; text-align: center;">
                    <div>
                        <div style="font-size: 1.25rem; font-weight: 600; color: #059669;" id="totalPayments">0</div>
                        <div style="font-size: 0.75rem; color: #6b7280;">Total Pagos</div>
                    </div>
                    <div>
                        <div style="font-size: 1.25rem; font-weight: 600; color: #059669;" id="totalAmount">L. 0</div>
                        <div style="font-size: 0.75rem; color: #6b7280;">Monto Total</div>
                    </div>
                    <div>
                        <div style="font-size: 1.25rem; font-weight: 600; color: #059669;" id="completedPayments">0</div>
                        <div style="font-size: 0.75rem; color: #6b7280;">Completados</div>
                    </div>
                </div>
            </div>

            <div class="modal-body" style="padding: 20px; max-height: calc(85vh - 220px); overflow-y: auto;">
                <!-- Loading -->
                <div id="paymentsLoading" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px;">
                    <div class="spinner" style="width: 40px; height: 40px; border: 3px solid #e5e7eb; border-top-color: #059669; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="margin-top: 16px; color: #6b7280;">Cargando historial...</p>
                </div>

                <!-- Payments List -->
                <div id="paymentsList" style="display: none;"></div>

                <!-- Empty State -->
                <div id="paymentsEmpty" style="display: none; text-align: center; padding: 40px;">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="1.5" style="margin-bottom: 16px;">
                        <path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                    </svg>
                    <p style="color: #6b7280; margin: 0;">No hay pagos registrados</p>
                </div>
            </div>
        </div>
    </div>

    <style>
        #groupPaymentsModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        #groupPaymentsModal .modal-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            width: 90%;
            animation: modalSlideIn 0.3s ease-out;
        }

        .payment-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 12px;
            margin-bottom: 8px;
        }

        .payment-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .payment-icon.completed { background: #d1fae5; color: #059669; }
        .payment-icon.pending { background: #fef3c7; color: #d97706; }
        .payment-icon.failed { background: #fee2e2; color: #dc2626; }

        .payment-info {
            flex: 1;
        }

        .payment-user {
            font-weight: 500;
            color: #111827;
            margin-bottom: 2px;
        }

        .payment-method {
            font-size: 0.8125rem;
            color: #6b7280;
        }

        .payment-amount {
            font-weight: 600;
            font-size: 1rem;
        }

        .payment-amount.completed { color: #059669; }
        .payment-amount.pending { color: #d97706; }

        .payment-date {
            font-size: 0.75rem;
            color: #9ca3af;
            text-align: right;
        }
    </style>


    <!-- Invite Members Modal -->
    <div id="inviteMembersModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px; max-height: 85vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 20px; border-radius: 16px 16px 0 0; position: relative;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 12px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                            <circle cx="8.5" cy="7" r="4"/>
                            <line x1="20" y1="8" x2="20" y2="14"/>
                            <line x1="23" y1="11" x2="17" y2="11"/>
                        </svg>
                    </div>
                    <div>
                        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">Invitar Miembros</h3>
                        <p id="inviteModalSubtitle" style="margin: 4px 0 0; font-size: 0.875rem; opacity: 0.9;">Genera un link de invitacion</p>
                    </div>
                </div>
                <button onclick="closeInviteModal()" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>

            <form id="inviteForm" onsubmit="submitSimpleInvitation(event)" style="display: flex; flex-direction: column; flex: 1; min-height: 0; overflow: hidden;">
                <div class="modal-body" style="padding: 24px; flex: 1; overflow-y: auto; min-height: 0;">
                    <!-- Success Message -->
                    <!-- Success Message with Link -->
                    <div id="inviteSuccess" style="display: none; text-align: center; padding: 20px;">
                        <div style="width: 60px; height: 60px; background: #d1fae5; border-radius: 50%; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center;">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#059669" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                        </div>
                        <h4 style="margin: 0 0 8px; color: #111827;">Invitacion Creada!</h4>
                        <p style="margin: 0 0 16px; color: #6b7280; font-size: 0.875rem;">Comparte el siguiente link con el invitado:</p>
                        
                        <!-- Invite Link Display -->
                        <div style="background: #f3f4f6; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                            <input type="text" id="generatedInviteLink" readonly style="width: 100%; background: transparent; border: none; text-align: center; color: #374151; font-size: 0.8125rem; font-family: monospace;">
                        </div>
                        
                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin-bottom: 16px;">
                            <button type="button" onclick="copyInviteLink()" style="display: flex; align-items: center; gap: 6px; padding: 10px 16px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                                Copiar Link
                            </button>
                            <button type="button" onclick="shareViaWhatsApp()" style="display: flex; align-items: center; gap: 6px; padding: 10px 16px; background: #25D366; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                                WhatsApp
                            </button>
                            <button type="button" onclick="shareViaEmail()" style="display: flex; align-items: center; gap: 6px; padding: 10px 16px; background: #EA4335; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                                Email
                            </button>
                        </div>
                        
                        <p id="inviteLinkCopied" style="display: none; color: #059669; font-size: 0.8125rem; margin-bottom: 12px;">Link copiado al portapapeles!</p>
                        
                        <button type="button" onclick="resetInviteForm()" style="padding: 10px 20px; background: #f3f4f6; color: #374151; border: none; border-radius: 8px; cursor: pointer;">Enviar Otra Invitacion</button>
                    </div>


                    <!-- User Search Section -->
                    <div id="userSearchSection" style="margin-bottom: 24px; padding-bottom: 20px; border-bottom: 1px solid #e5e7eb;">
                        <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 8px; font-size: 0.9375rem;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 6px;"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                            Buscar usuario registrado
                        </label>
                        <div style="position: relative;">
                            <input type="text" id="userSearchInput" placeholder="Buscar por nombre o email..."
                                   oninput="searchUsersToInvite(this.value)"
                                   style="width: 100%; padding: 12px 12px 12px 40px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9375rem; box-sizing: border-box;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2"
                                 style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%);">
                                <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
                            </svg>
                        </div>
                        <div id="userSearchResults" style="margin-top: 8px; max-height: 200px; overflow-y: auto;"></div>
                        <div id="selectedUserDisplay" style="display: none; margin-top: 12px; padding: 12px; background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span style="font-weight: 500; color: #166534;" id="selectedUserName"></span>
                                    <span style="font-size: 0.8125rem; color: #6b7280; margin-left: 8px;" id="selectedUserEmail"></span>
                                </div>
                                <button type="button" onclick="clearSelectedUser()" style="background: none; border: none; color: #dc2626; cursor: pointer; font-size: 1.25rem;">&times;</button>
                            </div>
                            <input type="hidden" id="selectedUserId">
                        </div>
                        <p style="font-size: 0.75rem; color: #9ca3af; margin-top: 8px;">Busca usuarios existentes o usa el formulario abajo para invitar por link</p>
                    </div>

                    <!-- Simplified Form Fields -->
                    <div id="inviteFormFields">
                        <!-- Name (Optional) -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 6px; font-size: 0.875rem;">Nombre del Invitado <span style="color: #9ca3af; font-weight: 400;">(opcional)</span></label>
                            <input type="text" id="inviteeName" placeholder="Ej: Juan Perez" style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9375rem; box-sizing: border-box;">
                        </div>

                        <!-- Message (Optional) -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 500; color: #374151; margin-bottom: 6px; font-size: 0.875rem;">Mensaje Personal <span style="color: #9ca3af; font-weight: 400;">(opcional)</span></label>
                            <textarea id="inviteMessage" rows="3" placeholder="Te invito a unirte a nuestra tanda..." style="width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9375rem; resize: vertical; box-sizing: border-box;"></textarea>
                        </div>

                        <div id="inviteError" style="display: none; padding: 12px; background: #fee2e2; color: #dc2626; border-radius: 8px; margin-bottom: 16px; font-size: 0.875rem;"></div>
                    </div>
                    <!-- Pending Invitations Section -->
                    <div id="pendingInvitationsSection" style="margin-top: 24px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
                        <h4 style="margin: 0 0 12px; font-size: 0.9375rem; font-weight: 600; color: #374151; display: flex; align-items: center; gap: 8px;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                            Invitaciones Pendientes
                        </h4>
                        <div id="pendingInvitationsList">
                            <p style="font-size: 0.875rem; color: #9ca3af; text-align: center; padding: 1rem;">Cargando...</p>
                        </div>
                    </div>

                </div>

                <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid #e5e7eb; background: #f9fafb; border-radius: 0 0 16px 16px; display: flex; gap: 12px; justify-content: flex-end; flex-shrink: 0;" id="inviteFormFooter">
                    <button type="button" onclick="closeInviteModal()" style="padding: 10px 20px; background: #f3f4f6; color: #374151; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">Cancelar</button>
                    <button type="submit" id="inviteSubmitBtn" style="padding: 10px 24px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">Generar Link</button>
                </div>
            </form>
        </div>
    </div>

    <style>
        #inviteMembersModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        #inviteMembersModal .modal-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            width: 90%;
            animation: modalSlideIn 0.3s ease-out;
        }

        /* Mobile fixes for invite modal */
        @media (max-width: 480px) {
            #inviteMembersModal .modal-content {
                max-height: 95vh !important;
                margin: 10px;
                border-radius: 12px;
            }
            #inviteMembersModal .modal-header {
                padding: 16px !important;
            }
            #inviteMembersModal .modal-body {
                padding: 16px !important;
            }
            #inviteMembersModal .modal-footer {
                padding: 12px 16px !important;
                flex-wrap: wrap;
            }
            #inviteMembersModal .modal-footer button {
                flex: 1;
                min-width: 120px;
            }
        }

        #inviteMembersModal input:focus,
        #inviteMembersModal textarea:focus {
            outline: none;
            border-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
        }

        .invite-method-btn.active {
            border-color: #f59e0b !important;
            background: #fffbeb !important;
            color: #d97706 !important;
        }

        #inviteSubmitBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>


    <script>
        // ============================================
        // MODAL SYSTEM - JavaScript Functions
        // ============================================

        // Global variables for modals
        var currentMembersGroupId = null;
        var currentPaymentsGroupId = null;
        var currentInviteGroupId = null;
        var currentInviteMethod = 'email';

        // ============================================
        // VIEW MEMBERS MODAL
        // ============================================
        function viewGroupMembers(groupId) {
            closeModal(); // Close admin modal first
            setTimeout(function() {
                showMembersModal(groupId);
            }, 100);
        }
        window.viewGroupMembers = viewGroupMembers;

        async function showMembersModal(groupId) {
            currentMembersGroupId = groupId;
            var modal = document.getElementById('groupMembersModal');
            var loading = document.getElementById('membersLoading');
            var list = document.getElementById('membersList');
            var empty = document.getElementById('membersEmpty');
            var currentUserId = getCurrentUserId();

            // Reset state
            loading.style.display = 'flex';
            list.style.display = 'none';
            empty.style.display = 'none';
            list.innerHTML = '';

            // Show modal
            modal.style.display = 'flex'; modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Load members
            try {
                var apiBase = window.API_BASE_URL || 'https://latanda.online';
                var response = await fetch(apiBase + '/api/groups/' + groupId + '/members', { headers: getAuthHeaders() });
                var data = await response.json();

                loading.style.display = 'none';

                if (data.success && data.data.members && data.data.members.length > 0) {
                    var members = data.data.members;
                    var expandedOrder = data.data.expanded_order || data.expanded_order || [];
                    var html = '';
                    var currentUserRole = null;
                    
                    // Build position map from expanded_order (user_id -> [positions])
                    var userPositions = {};
                    expandedOrder.forEach(function(pos, index) {
                        var uid = pos.user_id || pos;
                        if (!userPositions[uid]) userPositions[uid] = [];
                        userPositions[uid].push(index + 1);
                    });
                    
                    // Find current user's role
                    var currentMember = members.find(function(m) { return m.user_id === currentUserId; });
                    if (currentMember) currentUserRole = currentMember.role;

                    members.forEach(function(member) {
                        var isCurrentUser = member.user_id === currentUserId;
                        var initials = (member.name || 'U').charAt(0).toUpperCase();
                        var roleClass = member.role || 'member';
                        var roleText = member.role === 'creator' ? 'Creador' :
                                       member.role === 'coordinator' ? 'Coordinador' : 
                                       member.role === 'admin' ? 'Admin' : 'Miembro';
                        
                        // Display name logic (anonymous)
                        var displayName = member.name || 'Usuario';
                        var isAnonymous = member.is_anonymous;
                        if (isAnonymous && !isCurrentUser && currentUserRole !== 'creator' && currentUserRole !== 'admin') {
                            displayName = 'Miembro Anonimo';
                            initials = '?';
                        }
                        
                        // Anonymous indicator for admin/creator
                        var anonymousIndicator = '';
                        if (isAnonymous && (currentUserRole === 'creator' || currentUserRole === 'admin')) {
                            anonymousIndicator = ' <span style="font-size:0.7rem;color:#f59e0b;">(Anonimo)</span>';
                        }

                        html += '<div class="member-card' + (isCurrentUser ? ' current-user' : '') + '" data-user-id="' + member.user_id + '">' +
                            '<div class="member-avatar' + (isAnonymous ? ' anonymous' : '') + '">' + initials + '</div>' +
                            '<div class="member-info">' +
                                '<div class="member-name">' + displayName + anonymousIndicator + (isCurrentUser ? ' <span style="color:#8b5cf6;font-size:0.75rem;">(Tu)</span>' : '') + '</div>' +
                                '<span class="member-role ' + roleClass + '">' + roleText + '</span>' +
                            '</div>' +
                            '<div class="member-position">' + (function() { var pos = userPositions[member.user_id] || (member.turn_position ? [member.turn_position] : []); if (pos.length === 0) return 'Sin turno'; if (pos.length === 1) return 'Turno #' + pos[0]; return 'Turnos #' + pos.join(', #'); })() + '</div>' +
                        '</div>';
                        
                        // Add action buttons for current user
                        if (isCurrentUser) {
                            html += '<div class="member-actions">';
                            
                            // Toggle Anonymous button
                            html += '<button onclick="toggleMemberAnonymous(\'' + groupId + '\', \'' + member.user_id + '\', ' + !isAnonymous + ')" class="action-btn anonymous-btn">' +
                                '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>' +
                                (isAnonymous ? ' Mostrar Nombre' : ' Ocultar Nombre') +
                            '</button>';
                            
                            // Request Role button (only for members and coordinators)
                            if (member.role === 'member' || member.role === 'coordinator') {
                                html += '<button onclick="showRequestRoleModal(\'' + groupId + '\', \'' + member.role + '\')" class="action-btn role-btn">' +
                                    '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>' +
                                    ' Solicitar Rol' +
                                '</button>';
                            }
                            
                            // Leave Group button
                            if (member.role === 'creator') {
                                html += '<button onclick="showTransferOwnershipModal(\'' + groupId + '\')" class="action-btn leave-btn warning">' +
                                    '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>' +
                                    ' Transferir y Salir' +
                                '</button>';
                            } else {
                                html += '<button onclick="confirmLeaveGroup(\'' + groupId + '\')" class="action-btn leave-btn">' +
                                    '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>' +
                                    ' Salir del Grupo' +
                                '</button>';
                            }
                            
                            html += '</div>';
                        // Admin action buttons (remove member) for admins/coordinators
                        } else if (!isCurrentUser && (currentUserRole === "creator" || currentUserRole === "coordinator" || currentUserRole === "admin")) {
                            // Cannot remove creator
                            if (member.role !== "creator") {
                                var safeName = displayName.replace(/\x27/g, "\\\x27");
                                html += "<div class=\"member-actions\">";
                                html += "<button onclick=\"confirmRemoveMember(\x27" + groupId + "\x27, \x27" + member.user_id + "\x27, \x27" + safeName + "\x27)\" class=\"action-btn leave-btn\" style=\"background: rgba(239, 68, 68, 0.1); color: #ef4444;\">" +
                                    "<svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><path d=\"M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2\"/><circle cx=\"8.5\" cy=\"7\" r=\"4\"/><line x1=\"18\" y1=\"8\" x2=\"23\" y2=\"13\"/><line x1=\"23\" y1=\"8\" x2=\"18\" y2=\"13\"/></svg>" +
                                    " Remover" +
                                "</button>";
                                html += "</div>";
                            }

                        }
                    });

                    list.innerHTML = html;
                    list.style.display = 'block';
                    document.getElementById('membersModalSubtitle').textContent = members.length + ' miembros' + (expandedOrder.length > members.length ? ' (' + expandedOrder.length + ' turnos)' : '');
                } else {
                    empty.style.display = 'block';
                }
            } catch (err) {
                loading.innerHTML = '<p style="color: #ef4444;">Error al cargar miembros</p>';
            }
        }

        // ============================================
        // MEMBER ACTION FUNCTIONS
        // ============================================
        
        // Toggle anonymous mode for member
        async function toggleMemberAnonymous(groupId, userId, makeAnonymous) {
            try {
                var apiBase = window.API_BASE_URL || 'https://latanda.online';
                var response = await fetch(apiBase + '/api/groups/' + groupId + '/members/' + userId + '/anonymous', {
                    method: 'PUT',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_anonymous: makeAnonymous })
                });
                var result = await response.json();
                
                if (result.success) {
                    showNotification(makeAnonymous ? 'Tu nombre ahora esta oculto' : 'Tu nombre ahora es visible', 'success');
                    // Reload members list
                    showMembersModal(groupId);
                } else {
                    showNotification(result.error || 'Error al cambiar modo anonimo', 'error');
                }
            } catch (err) {
                showNotification('Error de conexion', 'error');
            }
        }
        window.toggleMemberAnonymous = toggleMemberAnonymous;
        
        // Confirm leave group
        var pendingLeaveGroupId = null;
        
        async function confirmLeaveGroup(groupId) {
            pendingLeaveGroupId = groupId;
            
            try {
                var apiBase = window.API_BASE_URL || 'https://latanda.online';
                var userId = getCurrentUserId();
                
                var url = apiBase + '/api/groups/' + groupId + '/members/' + userId + '/can-leave';
                
                var response = await fetch(url, { headers: getAuthHeaders() });
                
                var result = await response.json();
                
                var canLeave = (result.data && result.data.can_leave) || result.can_leave;
                
                if (!result.success || !canLeave) {
                    var reason = (result.data && result.data.reason) || result.reason || 'Tienes pagos pendientes';
                    showNotification('No puedes salir: ' + reason, 'error');
                    return;
                }
                
                var modal = document.getElementById('leaveGroupConfirmModal');
                if (modal) {
                    modal.style.display = 'flex'; modal.classList.add('active');
                } else {
                }
            } catch (err) {
                // Show confirmation anyway on error
                var modal = document.getElementById('leaveGroupConfirmModal');
                if (modal) {
                    modal.style.display = 'flex'; modal.classList.add('active');
                }
            }
        }
        window.confirmLeaveGroup = confirmLeaveGroup;
        
        function closeLeaveConfirmModal() {
            var modal = document.getElementById('leaveGroupConfirmModal');
            if (modal) modal.style.display = 'none'; modal.classList.remove('active');
            pendingLeaveGroupId = null;
        }
        window.closeLeaveConfirmModal = closeLeaveConfirmModal;
        
        async function executeLeaveGroup() {
            if (!pendingLeaveGroupId) return;
            
            var btn = document.getElementById('confirmLeaveBtn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-small"></span> Saliendo...';
            }
            
            try {
                var apiBase = window.API_BASE_URL || 'https://latanda.online';
                var userId = getCurrentUserId();
                var response = await fetch(apiBase + '/api/groups/' + pendingLeaveGroupId + '/members/' + userId, {
                    method: 'DELETE',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' }
                });
                var result = await response.json();
                
                if (result.success) {
                    showNotification('Has salido del grupo exitosamente', 'success');
                    closeLeaveConfirmModal();
                    closeMembersModal();
                    // Reload groups and tandas
                    if (typeof fetchMyGroups === 'function') {
                        fetchMyGroups().then(() => {
                            if (typeof renderGroups === 'function') renderGroups();
                        });
                    }
                    if (typeof refreshTandas === 'function') {
                        refreshTandas();
                    }
                } else {
                    showNotification(result.error || 'No se pudo salir del grupo', 'error');
                }
            } catch (err) {
                showNotification('Error de conexion', 'error');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = 'Si, Salir';
                }
            }
        }
        window.executeLeaveGroup = executeLeaveGroup;
        
        // Show request role modal
        var pendingRoleRequest = { groupId: null, currentRole: null };
        
        function showRequestRoleModal(groupId, currentRole) {
            pendingRoleRequest.groupId = groupId;
            pendingRoleRequest.currentRole = currentRole;
            
            var modal = document.getElementById('requestRoleModal');
            var roleOptions = document.getElementById('roleOptionsContainer');
            
            if (modal && roleOptions) {
                // Build role options based on current role
                var html = '';
                if (currentRole === 'member') {
                    html += '<label class="role-option"><input type="radio" name="requestedRole" value="coordinator"> <span>Coordinador</span> <small>Ayuda a gestionar el grupo</small></label>';
                }
                html += '<label class="role-option"><input type="radio" name="requestedRole" value="admin"> <span>Administrador</span> <small>Permisos completos de gestion</small></label>';
                
                roleOptions.innerHTML = html;
                modal.style.display = 'flex'; modal.classList.add('active');
            }
        }
        window.showRequestRoleModal = showRequestRoleModal;
        
        function closeRequestRoleModal() {
            var modal = document.getElementById('requestRoleModal');
            if (modal) modal.style.display = 'none'; modal.classList.remove('active');
            pendingRoleRequest = { groupId: null, currentRole: null };
        }
        window.closeRequestRoleModal = closeRequestRoleModal;
        
        async function submitRoleRequest() {
            var selectedRole = document.querySelector('input[name="requestedRole"]:checked');
            var reason = document.getElementById('roleRequestReason')?.value || '';
            
            if (!selectedRole) {
                showNotification('Selecciona un rol', 'error');
                return;
            }
            
            var btn = document.getElementById('submitRoleRequestBtn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-small"></span> Enviando...';
            }
            
            try {
                var apiBase = window.API_BASE_URL || 'https://latanda.online';
                var userId = getCurrentUserId();
                var response = await fetch(apiBase + '/api/groups/' + pendingRoleRequest.groupId + '/role-requests', {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        requested_role: selectedRole.value,
                        reason: reason
                    })
                });
                var result = await response.json();
                
                if (result.success) {
                    showNotification('Solicitud enviada. El administrador la revisara pronto.', 'success');
                    closeRequestRoleModal();
                } else {
                    showNotification(result.error || 'Error al enviar solicitud', 'error');
                }
            } catch (err) {
                showNotification('Error de conexion', 'error');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = 'Enviar Solicitud';
                }
            }
        }
        window.submitRoleRequest = submitRoleRequest;
        
        // Transfer ownership modal
        var pendingTransferGroupId = null;
        
        async function showTransferOwnershipModal(groupId) {
            pendingTransferGroupId = groupId;
            
            var modal = document.getElementById('transferOwnershipModal');
            var memberSelect = document.getElementById('newOwnerSelect');
            
            if (!modal || !memberSelect) return;
            
            // Load members for selection
            try {
                var apiBase = window.API_BASE_URL || 'https://latanda.online';
                var response = await fetch(apiBase + '/api/groups/' + groupId + '/members', { headers: getAuthHeaders() });
                var result = await response.json();
                
                if (result.success && result.data.members) {
                    var currentUserId = getCurrentUserId();
                    var html = '<option value="">Selecciona un miembro...</option>';
                    
                    result.data.members.forEach(function(m) {
                        if (m.user_id !== currentUserId) {
                            html += '<option value="' + m.user_id + '">' + (m.name || m.user_id) + ' (' + m.role + ')</option>';
                        }
                    });
                    
                    memberSelect.innerHTML = html;
                    modal.style.display = 'flex'; modal.classList.add('active');
                }
            } catch (err) {
                showNotification('Error al cargar miembros', 'error');
            }
        }
        window.showTransferOwnershipModal = showTransferOwnershipModal;
        
        function closeTransferOwnershipModal() {
            var modal = document.getElementById('transferOwnershipModal');
            if (modal) modal.style.display = 'none'; modal.classList.remove('active');
            pendingTransferGroupId = null;
        }
        window.closeTransferOwnershipModal = closeTransferOwnershipModal;
        
        async function executeTransferOwnership() {
            var newOwnerId = document.getElementById('newOwnerSelect')?.value;
            
            if (!newOwnerId) {
                showNotification('Selecciona un miembro para transferir', 'error');
                return;
            }
            
            var btn = document.getElementById('confirmTransferBtn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-small"></span> Transfiriendo...';
            }
            
            try {
                var apiBase = window.API_BASE_URL || 'https://latanda.online';
                var response = await fetch(apiBase + '/api/groups/' + pendingTransferGroupId + '/transfer-ownership', {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_owner_id: newOwnerId })
                });
                var result = await response.json();
                
                if (result.success) {
                    showNotification('Propiedad transferida exitosamente', 'success');
                    closeTransferOwnershipModal();
                    closeMembersModal();
                    // Now can leave group
                    confirmLeaveGroup(pendingTransferGroupId);
                } else {
                    showNotification(result.error || 'Error al transferir propiedad', 'error');
                }
            } catch (err) {
                showNotification('Error de conexion', 'error');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = 'Transferir y Continuar';
                }
            }
        }
        window.executeTransferOwnership = executeTransferOwnership;

        function closeMembersModal() {
            var modal = document.getElementById('groupMembersModal');
            if (modal) {
                modal.style.display = 'none'; modal.classList.remove('active'); modal.classList.remove('active');
                document.body.style.overflow = '';
            }
            currentMembersGroupId = null;
        }

        // Close on overlay click
        document.addEventListener('DOMContentLoaded', function() {
            var modal = document.getElementById('groupMembersModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) closeMembersModal();
                });
            }
        });

        // ============================================
        // VIEW PAYMENTS MODAL
        // ============================================
        function viewGroupPayments(groupId) {
            closeModal(); // Close admin modal first
            setTimeout(function() {
                showPaymentsModal(groupId);
            }, 100);
        }
        window.viewGroupPayments = viewGroupPayments;

        async function showPaymentsModal(groupId) {
            currentPaymentsGroupId = groupId;
            var modal = document.getElementById('groupPaymentsModal');
            var loading = document.getElementById('paymentsLoading');
            var list = document.getElementById('paymentsList');
            var empty = document.getElementById('paymentsEmpty');
            var summary = document.getElementById('paymentsSummary');

            // Reset state
            loading.style.display = 'flex';
            list.style.display = 'none';
            empty.style.display = 'none';
            summary.style.display = 'none';
            list.innerHTML = '';

            // Show modal
            modal.style.display = 'flex'; modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Load payments
            try {
                var apiBase = window.API_BASE_URL || 'https://latanda.online';
                var response = await fetch(apiBase + '/api/groups/' + groupId + '/contributions', { headers: getAuthHeaders() });
                var data = await response.json();

                loading.style.display = 'none';

                if (data.success && data.data.contributions && data.data.contributions.length > 0) {
                    var contributions = data.data.contributions;
                    var html = '';
                    var totalAmount = 0;
                    var completedCount = 0;

                    contributions.forEach(function(payment) {
                        var statusClass = payment.status || 'pending';
                        var icon = statusClass === 'completed' ? '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>' :
                                   '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>';

                        var methodText = {
                            'cash': 'Efectivo',
                            'bank_transfer': 'Transferencia',
                            'mobile_money': 'Tigo Money',
                            'card': 'Tarjeta',
                            'crypto': 'Crypto'
                        }[payment.payment_method] || payment.payment_method || 'N/A';

                        var amount = parseFloat(payment.amount) || 0;
                        totalAmount += amount;
                        if (statusClass === 'completed') completedCount++;

                        var dateStr = payment.created_at ? new Date(payment.created_at).toLocaleDateString('es-HN') : '';

                        html += '<div class="payment-card">' +
                            '<div class="payment-icon ' + statusClass + '">' + icon + '</div>' +
                            '<div class="payment-info">' +
                                '<div class="payment-user">' + (payment.user_name || 'Usuario') + '</div>' +
                                '<div class="payment-method">' + methodText + '</div>' +
                            '</div>' +
                            '<div style="text-align: right;">' +
                                '<div class="payment-amount ' + statusClass + '">L. ' + amount.toLocaleString('es-HN', {minimumFractionDigits: 2}) + '</div>' +
                                '<div class="payment-date">' + dateStr + '</div>' +
                            '</div>' +
                        '</div>';
                    });

                    list.innerHTML = html;
                    list.style.display = 'block';

                    // Update summary
                    document.getElementById('totalPayments').textContent = contributions.length;
                    document.getElementById('totalAmount').textContent = 'L. ' + totalAmount.toLocaleString('es-HN', {minimumFractionDigits: 2});
                    document.getElementById('completedPayments').textContent = completedCount;
                    summary.style.display = 'block';
                } else {
                    empty.style.display = 'block';
                }
            } catch (err) {
                loading.innerHTML = '<p style="color: #ef4444;">Error al cargar pagos</p>';
            }
        }

        function closePaymentsModal() {
            var modal = document.getElementById('groupPaymentsModal');
            if (modal) {
                modal.style.display = 'none'; modal.classList.remove('active'); modal.classList.remove('active');
                document.body.style.overflow = '';
            }
            currentPaymentsGroupId = null;
        }

        // Close on overlay click
        document.addEventListener('DOMContentLoaded', function() {
            var modal = document.getElementById('groupPaymentsModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) closePaymentsModal();
                });
            }
        });

        // ============================================
        // INVITE MEMBERS MODAL
        // ============================================
        function inviteToGroup(groupId) {
            closeModal(); // Close admin modal first
            setTimeout(function() {
                showInviteModal(groupId);
            }, 100);
        }
        window.inviteToGroup = inviteToGroup;

        function showInviteModal(groupId) {
            currentInviteGroupId = groupId;
            var modal = document.getElementById('inviteMembersModal');

            // Reset form
            resetInviteForm();

            // Show modal
            document.body.style.overflow = 'hidden';
        }

        function setInviteMethod(method) {
            currentInviteMethod = method;
            var emailBtn = document.getElementById('inviteMethodEmail');
            var phoneBtn = document.getElementById('inviteMethodPhone');
            var emailField = document.getElementById('inviteEmailField');
            var phoneField = document.getElementById('invitePhoneField');
            var emailInput = document.getElementById('inviteeEmail');
            var phoneInput = document.getElementById('inviteePhone');

            if (method === 'email') {
                emailBtn.classList.add('active');
                phoneBtn.classList.remove('active');
                emailField.style.display = 'block';
                phoneField.style.display = 'none';
                emailInput.required = true;
                phoneInput.required = false;
            } else {
                phoneBtn.classList.add('active');
                emailBtn.classList.remove('active');
                emailField.style.display = 'none';
                phoneField.style.display = 'block';
                emailInput.required = false;
                phoneInput.required = true;
            }
        }

        
        // Store the generated invite link
        var lastGeneratedInviteLink = '';
        
        // Copy invite link to clipboard
        function copyInviteLink() {
            var linkInput = document.getElementById('generatedInviteLink');
            if (linkInput && linkInput.value) {
                navigator.clipboard.writeText(linkInput.value).then(function() {
                    document.getElementById('inviteLinkCopied').style.display = 'block';
                    setTimeout(function() {
                        document.getElementById('inviteLinkCopied').style.display = 'none';
                    }, 3000);
                }).catch(function(err) {
                    // Fallback for older browsers
                    linkInput.select();
                    document.execCommand('copy');
                    document.getElementById('inviteLinkCopied').style.display = 'block';
                    setTimeout(function() {
                        document.getElementById('inviteLinkCopied').style.display = 'none';
                    }, 3000);
                });
            }
        }
        window.copyInviteLink = copyInviteLink;
        
        // Share via WhatsApp
        function shareViaWhatsApp() {
            var linkInput = document.getElementById('generatedInviteLink');
            if (linkInput && linkInput.value) {
                var inviteeName = document.getElementById('inviteeName').value.trim() || 'Amigo';
                var text = 'Hola ' + inviteeName + '! Te invito a unirte a mi grupo de ahorro en La Tanda. Usa este link: ' + linkInput.value;
                var whatsappUrl = 'https://wa.me/?text=' + encodeURIComponent(text);
                window.open(whatsappUrl, '_blank');
            }
        }
        window.shareViaWhatsApp = shareViaWhatsApp;

        // Share via Email
        function shareViaEmail() {
            var linkInput = document.getElementById('generatedInviteLink');
            if (linkInput && linkInput.value) {
                var inviteeName = document.getElementById('inviteeName').value.trim() || 'Amigo';
                var subject = encodeURIComponent('Invitacion a La Tanda - Grupo de Ahorro');
                var body = encodeURIComponent('Hola ' + inviteeName + '!\n\nTe invito a unirte a mi grupo de ahorro en La Tanda.\n\nUsa este link para unirte:\n' + linkInput.value + '\n\nSaludos!');
                var mailtoUrl = 'mailto:?subject=' + subject + '&body=' + body;
                window.location.href = mailtoUrl;
            }
        }
        window.shareViaEmail = shareViaEmail;

        // Simplified invitation - just generates a link
        async function submitSimpleInvitation(event) {
            event.preventDefault();

            var name = document.getElementById('inviteeName').value.trim();
            var message = document.getElementById('inviteMessage').value.trim();
            var errorDiv = document.getElementById('inviteError');
            var submitBtn = document.getElementById('inviteSubmitBtn');

            errorDiv.style.display = 'none';
            submitBtn.disabled = true;
            submitBtn.textContent = 'Generando...';

            try {
                var apiBase = window.API_BASE_URL || 'https://latanda.online';
                var userId = getCurrentUserId();

                // Check if a registered user was selected
                var selectedUserId = document.getElementById('selectedUserId') ? document.getElementById('selectedUserId').value : null;

                var inviteData = {
                    inviter_id: userId,
                    invitee_name: name || null,
                    message: message || null,
                    user_id: selectedUserId || null  // Include user_id if inviting existing user
                };

                var response = await fetch(apiBase + '/api/groups/' + currentInviteGroupId + '/members/invite', {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(inviteData)
                });

                var data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.data && data.data.error && data.data.error.message || data.error || 'Error al crear invitacion');
                }

                // Get invitation token from response
                var inviteData = data.data || data;
                var token = inviteData.token || inviteData.invitation_token;
                
                if (!token) {
                    throw new Error('No se pudo obtener el token de invitacion');
                }

                // Store the invite link for sharing
                var inviteLink = 'https://latanda.online/invitaciones.html?token=' + token;
                window.currentInviteLink = inviteLink;
                
                // Set the link in the input field
                document.getElementById('generatedInviteLink').value = inviteLink;

                // Show success with link
                document.getElementById('inviteFormFields').style.display = 'none';
                document.getElementById('inviteFormFooter').style.display = 'none';
                document.getElementById('inviteSuccess').style.display = 'block';

                // Clear selected user after successful invitation
                if (typeof clearSelectedUser === 'function') {
                    clearSelectedUser();
                }

                if (typeof window.showSuccess === 'function') {
                    window.showSuccess(selectedUserId ? 'Invitacion enviada al usuario' : 'Link de invitacion generado');
                }

            } catch (err) {
                errorDiv.textContent = err.message || 'Error al crear la invitacion';
                errorDiv.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Generar Link';
            }
        }
        window.submitSimpleInvitation = submitSimpleInvitation;


        function resetInviteForm() {
            document.getElementById('inviteForm').reset();
            document.getElementById('inviteFormFields').style.display = 'block';
            document.getElementById('inviteFormFooter').style.display = 'flex';
            document.getElementById('inviteSuccess').style.display = 'none';
            document.getElementById('inviteError').style.display = 'none';
            document.getElementById('inviteSubmitBtn').disabled = false;
            // setInviteMethod removed - simplified form
        }

        async function submitInvitation(event) {
            event.preventDefault();

            var name = document.getElementById('inviteeName').value.trim();
            var email = document.getElementById('inviteeEmail').value.trim();
            var phone = document.getElementById('inviteePhone').value.trim();
            var message = document.getElementById('inviteMessage').value.trim();
            var errorDiv = document.getElementById('inviteError');
            var submitBtn = document.getElementById('inviteSubmitBtn');

            // Validation
            if (currentInviteMethod === 'email' && !email) {
                errorDiv.textContent = 'Por favor ingresa un email';
                errorDiv.style.display = 'block';
                return;
            }
            if (currentInviteMethod === 'phone' && !phone) {
                errorDiv.textContent = 'Por favor ingresa un telefono';
                errorDiv.style.display = 'block';
                return;
            }

            errorDiv.style.display = 'none';
            submitBtn.disabled = true;
            submitBtn.textContent = 'Enviando...';

            try {
                var apiBase = window.API_BASE_URL || 'https://latanda.online';
                var userId = getCurrentUserId();

                var inviteData = {
                    inviter_id: userId,
                    invitee_name: name || null,
                    message: message || null
                };

                if (currentInviteMethod === 'email') {
                    inviteData.invitee_email = email;
                } else {
                    inviteData.invitee_phone = phone;
                }

                var response = await fetch(apiBase + '/api/groups/' + currentInviteGroupId + '/members/invite', {
                    method: 'POST',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(inviteData)
                });

                var data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.data?.error?.message || 'Error al enviar invitacion');
                }

                // Show success
                document.getElementById('inviteFormFields').style.display = 'none';
                document.getElementById('inviteFormFooter').style.display = 'none';
                document.getElementById('inviteSuccess').style.display = 'block';

                if (typeof window.showSuccess === 'function') {
                    window.showSuccess('Invitacion enviada exitosamente');
                    // Refresh groups to show updated member count
                    if (typeof fetchMyGroups === 'function') fetchMyGroups();
                }

            } catch (err) {
                errorDiv.textContent = err.message || 'Error al enviar la invitacion';
                errorDiv.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Enviar Invitacion';
            }
        }

        function closeInviteModal() {
            var modal = document.getElementById('inviteMembersModal');
            if (modal) {
                modal.style.display = 'none'; modal.classList.remove('active'); modal.classList.remove('active');
                document.body.style.overflow = '';
            }
            currentInviteGroupId = null;
        }

        // Close on overlay click
        document.addEventListener('DOMContentLoaded', function() {
            var modal = document.getElementById('inviteMembersModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) closeInviteModal();
                });
            }
        });


        // ============================================
        // PENDING INVITATIONS & REMINDERS
        // ============================================
        
        async function loadPendingInvitations(groupId) {
            try {
                var apiBase = window.API_BASE_URL || "https://latanda.online";
                var userId = getCurrentUserId();
                var response = await fetch(apiBase + "/api/invitations/sent/" + userId, { headers: getAuthHeaders() });
                var data = await response.json();
                
                if (data.success && data.data && data.data.invitations) {
                    var groupInvitations = data.data.invitations.filter(function(inv) {
                        return inv.group_id === groupId && inv.status === "pending";
                    });
                    
                    var container = document.getElementById("pendingInvitationsList");
                    if (!container) return;
                    
                    if (groupInvitations.length === 0) {
                        container.innerHTML = "<p style=\"font-size: 0.875rem; color: #9ca3af; text-align: center; padding: 1rem;\">No hay invitaciones pendientes</p>";
                        return;
                    }
                    
                    var html = "";
                    groupInvitations.forEach(function(inv) {
                        var name = inv.invitee_name || inv.invitee_email || inv.invitee_phone || "Invitado";
                        var safeName = name.replace(/\x27/g, "\\\x27");
                        var contact = inv.invitee_email || inv.invitee_phone || "";
                        var expiresDate = new Date(inv.expires_at);
                        var isExpired = expiresDate < new Date();
                        var reminderCount = inv.reminder_count || 0;
                        var lastReminded = inv.last_reminded_at ? new Date(inv.last_reminded_at) : null;
                        var canRemind = true;
                        
                        if (lastReminded) {
                            var hoursSince = (Date.now() - lastReminded.getTime()) / (1000 * 60 * 60);
                            canRemind = hoursSince >= 24;
                        }
                        
                        html += "<div class=\"invitation-card\" style=\"background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 0.75rem 1rem; margin-bottom: 0.5rem; display: flex; align-items: center; justify-content: space-between;\">";
                        html += "<div style=\"flex: 1;\">";
                        html += "<div style=\"font-weight: 500; font-size: 0.875rem; color: #111827;\">" + name + "</div>";
                        if (contact) {
                            html += "<div style=\"font-size: 0.75rem; color: #6b7280;\">" + contact + "</div>";
                        }
                        if (reminderCount > 0) {
                            html += "<div style=\"font-size: 0.7rem; color: #9ca3af; margin-top: 0.25rem;\">Recordatorios enviados: " + reminderCount + "</div>";
                        }
                        html += "</div>";
                        
                        if (!isExpired && canRemind) {
                            html += "<button type=\"button\" onclick=\"sendInvitationReminder(\x27" + groupId + "\x27, \x27" + inv.id + "\x27, \x27" + safeName + "\x27)\" class=\"action-btn\" style=\"background: rgba(139, 92, 246, 0.1); color: #8b5cf6; font-size: 0.8rem; padding: 0.5rem 0.75rem;\">";
                            html += "<svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><path d=\"M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z\"/></svg>";
                            html += " Recordar";
                            html += "</button>";
                        } else if (!canRemind) {
                            html += "<span style=\"font-size: 0.7rem; color: #9ca3af;\">Espera 24h</span>";
                        } else if (isExpired) {
                            html += "<span style=\"font-size: 0.7rem; color: #ef4444;\">Expirado</span>";
                        }

                        // Delete button - always show for pending invitations
                        html += "<button type=\"button\" onclick=\"deleteInvitation('" + groupId + "', '" + inv.id + "', '" + safeName + "')\" style=\"background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 6px 8px; border: none; border-radius: 6px; cursor: pointer; margin-left: 8px; display: inline-flex; align-items: center;\" title=\"Eliminar\">";                        html += "<svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><polyline points=\"3 6 5 6 21 6\"/><path d=\"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2\"/></svg>";                        html += "</button>";
                        
                        html += "</div>";
                    });
                    
                    container.innerHTML = html;
                }
            } catch (err) {
            }
        }
        window.loadPendingInvitations = loadPendingInvitations;

        // Delete pending invitation
        async function deleteInvitation(groupId, invitationId, inviteeName) {
            if (!confirm("¿Eliminar la invitación para " + inviteeName + "? Esta acción no se puede deshacer.")) {
                return;
            }

            try {
                var apiBase = window.API_BASE_URL || "https://latanda.online";
                var response = await fetch(apiBase + "/api/groups/" + groupId + "/invitations/" + invitationId, {
                    method: "DELETE",
                    headers: getAuthHeaders()
                });
                var result = await response.json();

                if (result.success) {
                    showNotification("Invitación eliminada", "success");
                    loadPendingInvitations(groupId);
                } else {
                    showNotification(result.error || result.data?.error || "Error al eliminar invitación", "error");
                }
            } catch (err) {
                showNotification("Error al eliminar invitación", "error");
            }
        }
        window.deleteInvitation = deleteInvitation;
        
        // Send invitation reminder with promotional card
        async function sendInvitationReminder(groupId, invitationId, inviteeName) {
            try {
                var apiBase = window.API_BASE_URL || "https://latanda.online";
                var response = await fetch(apiBase + "/api/groups/" + groupId + "/invitations/" + invitationId + "/remind", {
                    method: "POST",
                    headers: Object.assign({}, getAuthHeaders(), {"Content-Type": "application/json"})
                });
                var result = await response.json();
                
                if (result.success) {
                    var data = result.data || result;
                    showNotification("Recordatorio registrado para " + inviteeName, "success");
                    
                    var groupData = null;
                    if (window.myGroupsCache) {
                        groupData = window.myGroupsCache.find(function(g) { return g.group_id === groupId; });
                    }
                    if (!groupData && window.currentGroupsData) {
                        groupData = window.currentGroupsData.find(function(g) { return g.group_id === groupId; });
                    }
                    
                    if (data.invite_link) {
                        if (!window.InvitationCardGenerator && window.LaTandaComponentLoader) {
                            await LaTandaComponentLoader.loadInvitationCards();
                        }
                        
                        if (window.InvitationCardGenerator) {
                            var currentUser = JSON.parse(localStorage.getItem("latanda_user") || "{}");
                            var inviterName = currentUser.name || currentUser.email || "Tu amigo";
                            
                            InvitationCardGenerator.show({
                                groupName: groupData ? groupData.name : "Grupo de Ahorro",
                                groupDesc: groupData ? (groupData.description || "Únete a nuestra tanda") : "Únete a nuestra tanda",
                                contribution: groupData ? parseFloat(groupData.contribution_amount) : 0,
                                frequency: groupData ? groupData.frequency : "monthly",
                                members: groupData ? parseInt(groupData.members_count || groupData.member_count || 0) : 0,
                                maxMembers: groupData ? parseInt(groupData.max_members) : 10,
                                inviteLink: data.invite_link,
                                inviterName: inviterName,
                                theme: "purple"
                            });
                        } else {
                            var shareMsg = "Deseas compartir el link de invitacion ahora?";
                            if (confirm(shareMsg)) {
                                var text = "Hola " + inviteeName + "! Te recuerdo que tienes una invitacion pendiente. Usa este link: " + data.invite_link;
                                var whatsappUrl = "https://wa.me/?text=" + encodeURIComponent(text);
                                window.open(whatsappUrl, "_blank");
                            }
                        }
                    }
                    
                    loadPendingInvitations(groupId);
                } else {
                    showNotification(result.error || "Error al enviar recordatorio", "error");
                }
            } catch (err) {
                showNotification("Error: " + (err.message || "conexion fallida"), "error");
            }
        }
        window.sendInvitationReminder = sendInvitationReminder;

        // ============================================
        // USER SEARCH FOR INVITATIONS
        // ============================================
        var userSearchTimeout = null;
        var selectedInviteUser = null;

        async function searchUsersToInvite(query) {
            clearTimeout(userSearchTimeout);
            var resultsDiv = document.getElementById('userSearchResults');

            if (!query || query.length < 2) {
                resultsDiv.innerHTML = '';
                return;
            }

            userSearchTimeout = setTimeout(async function() {
                try {
                    resultsDiv.innerHTML = '<p style="font-size: 0.8125rem; color: #6b7280; padding: 8px;">Buscando...</p>';

                    var apiBase = window.API_BASE_URL || 'https://latanda.online';
                    var groupId = currentInviteGroupId || '';
                    var response = await fetch(apiBase + '/api/users/search-to-invite?q=' + encodeURIComponent(query) + '&group_id=' + groupId, {
                        headers: getAuthHeaders()
                    });
                    var result = await response.json();

                    if (result.success && result.data.users.length > 0) {
                        var html = '';
                        result.data.users.forEach(function(user) {
                            html += '<div onclick="selectUserToInvite(\'' + user.user_id + '\', \'' + user.name.replace(/'/g, "\\'") + '\', \'' + user.email_masked + '\')" ';
                            html += 'style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center;" ';
                            html += 'onmouseover="this.style.background=\'#f9fafb\'" onmouseout="this.style.background=\'transparent\'">';
                            html += '<div>';
                            html += '<div style="font-weight: 500; color: #111827;">' + user.name + '</div>';
                            html += '<div style="font-size: 0.75rem; color: #6b7280;">' + user.email_masked + '</div>';
                            html += '</div>';
                            html += '<span style="font-size: 0.6875rem; padding: 2px 6px; border-radius: 4px; ' + (user.status === 'verified' ? 'background: #dcfce7; color: #166534;' : 'background: #fef3c7; color: #92400e;') + '">' + (user.status === 'verified' ? 'Verificado' : 'Sin verificar') + '</span>';
                            html += '</div>';
                        });
                        resultsDiv.innerHTML = html;
                    } else {
                        resultsDiv.innerHTML = '<p style="font-size: 0.8125rem; color: #9ca3af; padding: 8px; text-align: center;">No se encontraron usuarios</p>';
                    }
                } catch (err) {
                    resultsDiv.innerHTML = '<p style="font-size: 0.8125rem; color: #dc2626; padding: 8px;">Error al buscar</p>';
                }
            }, 300);
        }

        function selectUserToInvite(userId, userName, userEmail) {
            selectedInviteUser = { user_id: userId, name: userName, email: userEmail };

            document.getElementById('userSearchResults').innerHTML = '';
            document.getElementById('userSearchInput').value = '';

            document.getElementById('selectedUserId').value = userId;
            document.getElementById('selectedUserName').textContent = userName;
            document.getElementById('selectedUserEmail').textContent = userEmail;
            document.getElementById('selectedUserDisplay').style.display = 'block';

            // Update the invitee name field
            document.getElementById('inviteeName').value = userName;
        }

        function clearSelectedUser() {
            selectedInviteUser = null;
            document.getElementById('selectedUserId').value = '';
            document.getElementById('selectedUserDisplay').style.display = 'none';
            document.getElementById('inviteeName').value = '';
        }

        window.searchUsersToInvite = searchUsersToInvite;
        window.selectUserToInvite = selectUserToInvite;
        window.clearSelectedUser = clearSelectedUser;



        // ============================================
        // REMOVE MEMBER FUNCTIONALITY
        // ============================================
        var pendingRemoveMember = { groupId: null, userId: null, userName: null };
        
        async function confirmRemoveMember(groupId, userId, userName) {
            pendingRemoveMember = { groupId: groupId, userId: userId, userName: userName };
            var confirmed = confirm("Estas seguro de que deseas remover a " + userName + " del grupo?\n\nEsta accion no se puede deshacer.");
            if (confirmed) {
                await executeRemoveMember();
            }
        }
        window.confirmRemoveMember = confirmRemoveMember;
        
        async function executeRemoveMember() {
            if (!pendingRemoveMember.groupId || !pendingRemoveMember.userId) return;
            
            try {
                var apiBase = window.API_BASE_URL || "https://latanda.online";
                var response = await fetch(apiBase + "/api/groups/" + pendingRemoveMember.groupId + "/members/" + pendingRemoveMember.userId, {
                    method: "DELETE",
                    headers: Object.assign({}, getAuthHeaders(), {"Content-Type": "application/json"}),
                    body: JSON.stringify({ action: "remove" })
                });
                var result = await response.json();
                
                if (result.success) {
                    showNotification(pendingRemoveMember.userName + " ha sido removido del grupo", "success");
                    showMembersModal(pendingRemoveMember.groupId);
                    pendingRemoveMember = { groupId: null, userId: null, userName: null };
                } else {
                    showNotification(result.error || "No se pudo remover al miembro", "error");
                }
            } catch (err) {
                showNotification("Error de conexion", "error");
            }
        }
        window.executeRemoveMember = executeRemoveMember;




    </script>


    <script>
        // ============================================
        // EDIT GROUP MODAL FUNCTIONS
        // ============================================
        var currentEditGroupId = null;

        function editGroup(groupId) {
            closeModal(); // Close admin modal first
            setTimeout(function() {
                showEditGroupModal(groupId);
            }, 100);
        }
        window.editGroup = editGroup;

        async function showEditGroupModal(groupId) {
            currentEditGroupId = groupId;
            var modal = document.getElementById('editGroupModal');
            var loading = document.getElementById('editGroupLoading');
            var formFields = document.getElementById('editGroupFormFields');
            var success = document.getElementById('editGroupSuccess');

            // Reset state
            if (loading) loading.style.display = 'flex';
            if (formFields) formFields.style.display = 'none';
            if (success) success.style.display = 'none';

            var errorDiv = document.getElementById('editGroupError');
            if (errorDiv) errorDiv.style.display = 'none';

            var submitBtn = document.getElementById('editGroupSubmitBtn');
            if (submitBtn) submitBtn.disabled = false;

            var footer = document.getElementById('editGroupFormFooter');
            if (footer) footer.style.display = 'flex';

            // Show modal
            modal.style.display = 'flex'; modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Load group data
            try {
                var apiBase = window.API_BASE_URL || 'https://latanda.online';
                var response = await fetch(apiBase + '/api/groups/' + groupId, { headers: getAuthHeaders() });
                var data = await response.json();

                if (!data.success) {
                    throw new Error('Error al cargar datos del grupo');
                }

                var group = data.data.data || data.data;

                // Populate form
                document.getElementById('editGroupName').value = group.name || '';
                document.getElementById('editGroupDescription').value = group.description || '';
                document.getElementById('editGroupAmount').value = group.contribution_amount || '';
                document.getElementById('editGroupFrequency').value = group.frequency || 'weekly';
                document.getElementById('editGroupMaxMembers').value = group.max_members || '';
                document.getElementById('editGroupLocation').value = group.location || '';
                document.getElementById('editGroupStartDate').value = group.start_date ? group.start_date.split('T')[0] : '';
                document.getElementById('editGroupStatus').value = group.status || 'active';

                if (loading) loading.style.display = 'none';
                if (formFields) formFields.style.display = 'block';

            } catch (err) {
                if (loading) {
                    loading.innerHTML = '<p style="color: #ef4444;">Error al cargar datos</p><button type="button" onclick="showEditGroupModal(currentEditGroupId)" style="margin-top: 16px; padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">Reintentar</button>';
                }
            }
        }

        function closeEditGroupModal() {
            var modal = document.getElementById('editGroupModal');
            if (modal) {
                modal.style.display = 'none'; modal.classList.remove('active'); modal.classList.remove('active');
                document.body.style.overflow = '';
            }
            currentEditGroupId = null;
        }

        // ===== DELETE GROUP FUNCTIONALITY =====
        var deleteGroupId = null;
        
        function confirmDeleteGroup(groupId) {
            deleteGroupId = groupId;
            
            // Find the group to show its name
            var group = (window.currentGroupsData || []).find(function(g) { return g.group_id == groupId || g.id == groupId; });
            var groupName = group ? group.name : 'este grupo';
            
            // Update modal content
            document.getElementById('deleteGroupName').textContent = groupName;
            
            // Show modal
            var modal = document.getElementById('deleteGroupModal');
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
            
            // Close admin modal if open
            var adminModal = document.getElementById('groupManageModal');
            if (adminModal) {
                adminModal.style.display = 'none';
            }
        }
        window.confirmDeleteGroup = confirmDeleteGroup;
        
        function closeDeleteGroupModal() {
            var modal = document.getElementById('deleteGroupModal');
            if (modal) {
                modal.style.display = 'none'; modal.classList.remove('active');
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
            deleteGroupId = null;
        }
        
        async function executeDeleteGroup() {
            if (!deleteGroupId) {
                showNotification('Error: No se seleccionó ningún grupo', 'error');
                return;
            }
            
            var deleteBtn = document.getElementById('confirmDeleteBtn');
            if (deleteBtn) {
                deleteBtn.disabled = true;
                deleteBtn.innerHTML = '<span class="spinner-small"></span> Eliminando...';
            }
            
            try {
                var userId = getCurrentUserId();
                var response = await fetch((window.API_BASE_URL || 'https://latanda.online') + '/api/groups/' + deleteGroupId + '?user_id=' + userId, {
                    method: 'DELETE',
                    headers: { ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    }
                });
                
                var result = await response.json();
                
                if (response.ok && result.success) {
                    showNotification('Grupo eliminado exitosamente', 'success');
                    closeDeleteGroupModal();
                    
                    // Refresh groups list
                    await fetchMyGroups();
                    renderGroups();

                    // Also refresh tandas tab to sync turn positions
                    if (typeof refreshTandas === 'function') {
                        refreshTandas();
                    }
                } else {
                    var errorMsg = result.error || result.message || 'No se pudo eliminar el grupo';
                    
                    // Special handling for groups with contributions
                    if (errorMsg.includes('contribuciones') || errorMsg.includes('contributions')) {
                        showNotification('No se puede eliminar: el grupo tiene contribuciones registradas. Debe completar el ciclo.', 'error');
                    } else {
                        showNotification(errorMsg, 'error');
                    }
                }
            } catch (error) {
                showNotification('Error de conexión al eliminar grupo', 'error');
            } finally {
                if (deleteBtn) {
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML = 'Sí, Eliminar Grupo';
                }
            }
        }
        // Expose delete functions to window
        window.confirmDeleteGroup = confirmDeleteGroup;
        window.closeDeleteGroupModal = closeDeleteGroupModal;
        window.executeDeleteGroup = executeDeleteGroup;
        // ===== END DELETE GROUP FUNCTIONALITY =====

        // ===== MANAGE TURNS FUNCTIONALITY =====
        var manageTurnsGroupId = null;
        var turnsMembers = [];
        
        async function manageTurns(groupId) {
            manageTurnsGroupId = groupId;
            
            // Close admin modal if open
            var adminModal = document.getElementById('groupManageModal');
            if (adminModal) {
                adminModal.style.display = 'none';
            }
            
            // Show loading in modal
            var modal = document.getElementById('manageTurnsModal');
            if (modal) {
                modal.style.display = 'flex';
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
            
            // Load members with their turn positions
            // Load expanded turns system if not loaded
            try { if (!window.expandMembersToPositions && window.LaTandaComponentLoader) {
                await LaTandaComponentLoader.loadExpandedTurns(); } } catch(e) { }
            
            await loadTurnsMembers(groupId);
        }
        
        async function loadTurnsMembers(groupId) {
            var loadingDiv = document.getElementById('turnsLoading');
            var contentDiv = document.getElementById('turnsContent');
            var errorDiv = document.getElementById('turnsError');
            
            if (loadingDiv) loadingDiv.style.display = 'block';
            if (contentDiv) contentDiv.style.display = 'none';
            if (errorDiv) errorDiv.style.display = 'none';
            
            try {
                var response = await fetch((window.API_BASE_URL || 'https://latanda.online') + '/api/groups/' + groupId + '/members', { headers: getAuthHeaders() });
                var result = await response.json();
                
                if (result.success && (result.members || result.data?.members)) {
                    turnsMembers = (result.members || result.data?.members || []).map(function(m) {
                        m.turn_locked = m.turn_locked || false;
                        m.num_positions = parseInt(m.num_positions) || 1;
                        return m;
                    }).sort(function(a, b) {
                        return (a.turn_position || 999) - (b.turn_position || 999);
                    });
                    // Use expanded_order from API if available, otherwise expand from members
                    var expandedOrder = result.expanded_order || result.data?.expanded_order;
                    if (expandedOrder && expandedOrder.length > 0) {
                        // Reconstruct expandedTurns from server's expanded_order
                        var memberMap = {};
                        turnsMembers.forEach(function(m) { memberMap[m.user_id] = m; });
                        
                        window.expandedTurns = expandedOrder.map(function(pos) {
                            var member = memberMap[pos.user_id];
                            var posLocks = member ? (member.position_locks || []) : [];
                            var lockInfo = posLocks[pos.slot] || {};
                            return {
                                user_id: pos.user_id,
                                name: member ? member.name : 'Usuario',
                                role: member ? member.role : 'member',
                                slot_index: pos.slot || 0,
                                total_slots: member ? member.num_positions : 1,
                                turn_locked: lockInfo.locked === true,
                                original_member: member
                            };
                        });
                    } else if (window.expandMembersToPositions) {
                        // Fallback: expand from members (positions will be consecutive)
                        window.expandedTurns = window.expandMembersToPositions(turnsMembers);
                    }
                    renderTurnsList();
                } else {
                    showTurnsError('No se pudieron cargar los miembros');
                }
            } catch (error) {
            } finally {
                if (loadingDiv) loadingDiv.style.display = 'none';
            }
        }
        
function renderTurnsList() {
            var contentDiv = document.getElementById('turnsContent');
            if (!contentDiv) return;
            
            // Use expanded turns if available, otherwise fall back to turnsMembers
            var displayList = window.expandedTurns || turnsMembers.map(function(m, i) {
                return { user_id: m.user_id, name: m.name || m.full_name, role: m.role, slot_index: 0, total_slots: 1, turn_locked: m.turn_locked };
            });
            
            // Lottery action bar
            var actionsHtml = '<div style="display: flex; gap: 10px; margin-bottom: 16px; padding: 12px; background: rgba(245,158,11,0.1); border-radius: 10px; border: 1px solid rgba(245,158,11,0.3); flex-wrap: wrap;">' +
                '<button onclick="startLotteryCountdown()" style="flex: 1; min-width: 140px; padding: 10px 16px; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;"><span style="font-size: 1.2rem;">🎲</span> Iniciar Ahora</button>' +
                '<button onclick="openScheduleLotteryModal()" style="flex: 1; min-width: 140px; padding: 10px 16px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;"><span style="font-size: 1.2rem;">📅</span> Programar</button>' +
            '</div>';
            
            var html = actionsHtml + '<div id="turnsList" style="display: flex; flex-direction: column; gap: 8px;">';
            
            displayList.forEach(function(pos, index) {
                var position = index + 1;
                var isLocked = pos.turn_locked === true;
                var lockIcon = isLocked ? '🔒' : '🔓';
                var lockBg = isLocked ? '#059669' : '#374151';
                var itemBg = isLocked ? '#1e3a3a' : '#1e293b';
                var itemBorder = isLocked ? '#059669' : '#334155';
                
                // Show name with position indicator if member has multiple slots
                var displayName = pos.name || 'Usuario';
                if (pos.total_slots > 1) {
                    displayName += ' ' + (pos.slot_index + 1) + '/' + pos.total_slots;
                }
                
                var roleText = (pos.role === 'creator' || pos.role === 'admin') ? 'Administrador' : 'Miembro';
                if (isLocked) roleText += ' • Anclado';
                
                html += '<div class="turn-item' + (isLocked ? ' turn-locked' : '') + '" ' + 
                    (!isLocked ? 'draggable="true"' : '') + 
                    ' data-user-id="' + pos.user_id + '" data-index="' + index + '" data-slot="' + pos.slot_index + '" data-locked="' + isLocked + '" ' +
                    'style="display: flex; align-items: center; gap: 12px; padding: 12px; background: ' + itemBg + '; border: 1px solid ' + itemBorder + '; border-radius: 10px; cursor: ' + (!isLocked ? 'grab' : 'default') + ';">' +
                    '<div style="width: 32px; height: 32px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; color: white; font-size: 0.875rem;">' + position + '</div>' +
                    '<div style="flex: 1;">' +
                        '<div style="font-weight: 500; color: #f3f4f6;">' + displayName + '</div>' +
                        '<div style="font-size: 0.75rem; color: #9ca3af;">' + roleText + '</div>' +
                    '</div>' +
                    '<button onclick="toggleExpandedLock(' + index + ')" style="width: 32px; height: 32px; background: ' + lockBg + '; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem;" title="' + (isLocked ? 'Desbloquear' : 'Anclar posicion') + '">' + lockIcon + '</button>' +
                    '<div style="display: flex; align-items: center; gap: 3px; background: #374151; padding: 4px 6px; border-radius: 6px;" title="Posiciones">' +
                        '<button onclick="removeExpandedPosition(\'' + pos.user_id + '\', ' + pos.slot_index + ')" style="width: 22px; height: 22px; background: ' + (pos.total_slots > 1 ? '#dc2626' : '#4b5563') + '; border: none; border-radius: 4px; color: white; cursor: ' + (pos.total_slots > 1 ? 'pointer' : 'not-allowed') + '; font-size: 1rem; opacity: ' + (pos.total_slots > 1 ? '1' : '0.4') + ';" ' + (pos.total_slots > 1 ? '' : 'disabled') + '>-</button>' +
                        '<span style="min-width: 20px; text-align: center; color: #f59e0b; font-weight: 600; font-size: 0.85rem;">' + pos.total_slots + '</span>' +
                        '<button onclick="addExpandedPosition(\'' + pos.user_id + '\')" style="width: 22px; height: 22px; background: #059669; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 1rem;">+</button>' +
                    '</div>' +
                    '<div style="display: flex; gap: 4px;">' +
                        '<button onclick="moveExpandedUp(' + index + ')" style="width: 28px; height: 28px; background: #374151; border: none; border-radius: 6px; color: ' + (isLocked ? '#4b5563' : '#9ca3af') + '; cursor: ' + (isLocked || index === 0 ? 'not-allowed' : 'pointer') + '; display: flex; align-items: center; justify-content: center; opacity: ' + (isLocked || index === 0 ? '0.3' : '1') + ';" ' + (isLocked || index === 0 ? 'disabled' : '') + '>' +
                            '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 15l-6-6-6 6"/></svg>' +
                        '</button>' +
                        '<button onclick="moveExpandedDown(' + index + ')" style="width: 28px; height: 28px; background: #374151; border: none; border-radius: 6px; color: ' + (isLocked ? '#4b5563' : '#9ca3af') + '; cursor: ' + (isLocked || index === displayList.length - 1 ? 'not-allowed' : 'pointer') + '; display: flex; align-items: center; justify-content: center; opacity: ' + (isLocked || index === displayList.length - 1 ? '0.3' : '1') + ';" ' + (isLocked || index === displayList.length - 1 ? 'disabled' : '') + '>' +
                            '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>' +
                        '</button>' +
                    '</div>' +
                '</div>';
            });
            
            html += '</div>';
            contentDiv.innerHTML = html;
            contentDiv.style.display = 'block';
            
            // Enable drag and drop (only for unlocked items)
            initExpandedDragAndDrop();
        }
        
        // Move position up in expanded list
        function moveExpandedUp(index) {
            if (!window.expandedTurns || index <= 0) return;
            if (window.expandedTurns[index].turn_locked) return;
            // Also check if destination is locked
            if (window.expandedTurns[index - 1].turn_locked) return;
            var temp = window.expandedTurns[index];
            window.expandedTurns[index] = window.expandedTurns[index - 1];
            window.expandedTurns[index - 1] = temp;
            renderTurnsList();
        }
        
        // Move position down in expanded list
        function moveExpandedDown(index) {
            if (!window.expandedTurns) return;
            if (window.expandedTurns[index].turn_locked) return;
            if (index >= window.expandedTurns.length - 1) return;
            // Also check if destination is locked
            if (window.expandedTurns[index + 1].turn_locked) return;
            var temp = window.expandedTurns[index];
            window.expandedTurns[index] = window.expandedTurns[index + 1];
            window.expandedTurns[index + 1] = temp;
            renderTurnsList();
        }
        
        // Toggle lock on expanded position
        function toggleExpandedLock(index) {
            if (!window.expandedTurns || index < 0 || index >= window.expandedTurns.length) return;
            window.expandedTurns[index].turn_locked = !window.expandedTurns[index].turn_locked;
            renderTurnsList();
        }
        
        // Drag and drop for expanded turns
        function initExpandedDragAndDrop() {
            var items = document.querySelectorAll('.turn-item');
            var draggedItem = null;
            
            items.forEach(function(item) {
                item.addEventListener('dragstart', function(e) {
                    if (this.dataset.locked === 'true') {
                        e.preventDefault();
                        return;
                    }
                    draggedItem = this;
                    this.style.opacity = '0.5';
                });
                
                item.addEventListener('dragend', function(e) {
                    this.style.opacity = '1';
                    draggedItem = null;
                });
                
                item.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    if (this.dataset.locked !== 'true') {
                        this.style.borderColor = '#f59e0b';
                    }
                });
                
                item.addEventListener('dragleave', function(e) {
                    this.style.borderColor = this.dataset.locked === 'true' ? '#059669' : '#334155';
                });
                
                item.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.style.borderColor = this.dataset.locked === 'true' ? '#059669' : '#334155';
                    
                    if (draggedItem && draggedItem !== this && window.expandedTurns) {
                        var fromIndex = parseInt(draggedItem.dataset.index);
                        var toIndex = parseInt(this.dataset.index);
                        
                        // Check if either position is locked
                        if (window.expandedTurns[fromIndex].turn_locked || window.expandedTurns[toIndex].turn_locked) {
                            return;
                        }
                        
                        // Reorder array
                        var item = window.expandedTurns.splice(fromIndex, 1)[0];
                        window.expandedTurns.splice(toIndex, 0, item);
                        renderTurnsList();
                    }
                });
            });
        }
        
        // Expose new functions to window
        window.moveExpandedUp = moveExpandedUp;
        window.moveExpandedDown = moveExpandedDown;
        window.toggleExpandedLock = toggleExpandedLock;

        // Add position for a member
        function addExpandedPosition(userId) {
            if (window.addPositionForMember) {
                window.addPositionForMember(userId);
            } else {
            }
        }
        window.addExpandedPosition = addExpandedPosition;

        // Remove position for a member
        function removeExpandedPosition(userId, slotIndex) {
            if (window.removePositionForMember) {
                window.removePositionForMember(userId, slotIndex);
            } else {
            }
        }
        window.removeExpandedPosition = removeExpandedPosition;

        function showTurnsError(message) {
            var errorDiv = document.getElementById('turnsError');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }
        
        function closeManageTurnsModal() {
            var modal = document.getElementById('manageTurnsModal');
            if (modal) {
                modal.style.display = 'none'; modal.classList.remove('active');
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
            manageTurnsGroupId = null;
            turnsMembers = [];
        }
        
        async function saveTurnsOrder() {
            var saveBtn = document.getElementById('saveTurnsBtn');
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<span class="spinner-small"></span> Guardando...';
            }
            
            try {
                // Collapse expanded positions back to member format
                var collapsedMembers = window.collapsePositionsToMembers && window.expandedTurns ? window.collapsePositionsToMembers(window.expandedTurns) : turnsMembers;
                
                var memberTurns = collapsedMembers.map(function(member, index) {
                    return {
                        user_id: member.user_id,
                        new_position: index + 1,
                        turn_locked: member.turn_locked || false,
                        num_positions: member.num_positions || 1,
                        position_locks: member.position_locks || []
                    };
                });
                
                var response = await fetch((window.API_BASE_URL || 'https://latanda.online') + '/api/groups/' + manageTurnsGroupId + '/reorder-turns', {
                    method: 'PUT',
                    headers: { ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ member_turns: memberTurns, expanded_turns: window.expandedTurns })
                });
                
                var result = await response.json();
                
                if (response.ok && result.success) {
                    showNotification('Turnos actualizados exitosamente', 'success');
                    closeManageTurnsModal();
                    
                    // Refresh groups
                    await fetchMyGroups();
                    renderGroups();

                    // Also refresh tandas tab to sync turn positions
                    if (typeof refreshTandas === 'function') {
                        refreshTandas();
                    }
                } else {
                    showNotification(result.error || 'Error al guardar turnos', 'error');
                }
            } catch (error) {
                showNotification('Error de conexion al guardar', 'error');
            } finally {
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = 'Guardar Cambios';
                }
            }
        }
        // Expose functions to window for onclick
        window.manageTurns = manageTurns;

        // Toggle tanda pause status
        async function toggleTandaPause(groupId) {
            if (!groupId) {
                showNotification("Error: ID de grupo no especificado", "error");
                return;
            }
            
            try {
                var apiBase = window.API_BASE_URL || "https://latanda.online";
                var response = await fetch(apiBase + "/api/groups/" + groupId + "/toggle-pause", {
                    method: "POST",
                    headers: getAuthHeaders(),
                    body: JSON.stringify({})
                });
                
                var data = await response.json();
                
                if (data.success) {
                    var newStatus = data.data.new_status;
                    var message = newStatus === "paused" ? "Tanda pausada exitosamente" : "Tanda reanudada exitosamente";
                    showNotification(message, "success");
                    closeModal();
                    // Refresh the groups list
                    if (typeof loadMyGroups === "function") loadMyGroups();
                    if (typeof loadActiveGroups === "function") loadActiveGroups();
                } else {
                    showNotification(data.data?.error?.message || "Error al cambiar estado", "error");
                }
            } catch (error) {
                showNotification("Error de conexion", "error");
            }
        }
        window.toggleTandaPause = toggleTandaPause;
        window.closeManageTurnsModal = closeManageTurnsModal;

        // =============================================
        // SCHEDULE LOTTERY FUNCTIONALITY
        // =============================================
        
        // Variable to store existing lottery data
        var scheduleLotteryExistingData = null;
        
        async function openScheduleLotteryModal() {
            // Get group ID from manage turns context
            var groupId = manageTurnsGroupId || currentStartGroupId;
            if (!groupId) {
                showNotification("Error: No se ha seleccionado un grupo", "error");
                return;
            }
            
            // FIX 2025-12-31: Load existing lottery schedule
            try {
                var response = await fetch((window.API_BASE_URL || "https://latanda.online") + "/api/groups/" + groupId + "/lottery-status", {
                    headers: getAuthHeaders()
                });
                var result = await response.json();
                if (result.success && result.data) {
                    scheduleLotteryExistingData = {
                        scheduled_at: result.data.scheduled_at,
                        countdown_seconds: result.data.countdown_seconds
                    };
                } else {
                    scheduleLotteryExistingData = null;
                }
            } catch (e) {
                scheduleLotteryExistingData = null;
            }
            
            // Create modal HTML
            var modalHtml = 
                "<div id=\"scheduleLotteryModal\" style=\"position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10001; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px);\">" +
                    "<div style=\"background: linear-gradient(135deg, #1e293b, #0f172a); border-radius: 16px; max-width: 420px; width: 90%; max-height: 90vh; overflow: hidden; border: 1px solid rgba(59,130,246,0.3);\">" +
                        "<div style=\"background: linear-gradient(135deg, #3b82f6, #1d4ed8); padding: 20px; position: relative;\">" +
                            "<div style=\"display: flex; align-items: center; gap: 12px;\">" +
                                "<div style=\"width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;\">" +
                                    "<span style=\"font-size: 1.5rem;\">📅</span>" +
                                "</div>" +
                                "<div>" +
                                    "<h3 style=\"margin: 0; font-size: 1.25rem; font-weight: 600; color: white;\">Programar Tombola</h3>" +
                                    "<p style=\"margin: 4px 0 0; font-size: 0.875rem; opacity: 0.9; color: white;\">Los miembros seran notificados</p>" +
                                "</div>" +
                            "</div>" +
                            "<button onclick=\"closeScheduleLotteryModal()\" style=\"position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; color: white; cursor: pointer;\">✕</button>" +
                        "</div>" +
                        "<div style=\"padding: 24px;\">" +
                            "<div style=\"margin-bottom: 20px;\">" +
                                "<label style=\"display: block; font-weight: 500; color: #e5e7eb; margin-bottom: 8px;\">Fecha y Hora</label>" +
                                "<input type=\"datetime-local\" id=\"scheduleLotteryDateTime\" style=\"width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #1e293b; color: white; font-size: 1rem; box-sizing: border-box;\">" +
                            "</div>" +
                            "<div style=\"margin-bottom: 20px;\">" +
                                "<label style=\"display: block; font-weight: 500; color: #e5e7eb; margin-bottom: 8px;\">Tiempo de Conteo (segundos)</label>" +
                                "<select id=\"scheduleLotteryCountdown\" style=\"width: 100%; padding: 12px; border: 1px solid #374151; border-radius: 8px; background: #1e293b; color: white; font-size: 1rem;\">" +
                                    "<option value=\"5\">5 segundos</option>" +
                                    "<option value=\"10\" selected>10 segundos</option>" +
                                    "<option value=\"15\">15 segundos</option>" +
                                    "<option value=\"30\">30 segundos</option>" +
                                    "<option value=\"60\">1 minuto</option>" +
                                "</select>" +
                            "</div>" +
                            "<div style=\"background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3); border-radius: 8px; padding: 12px; margin-bottom: 20px;\">" +
                                "<p style=\"margin: 0; color: #93c5fd; font-size: 0.875rem;\">💡 Todos los miembros del grupo recibiran una notificacion cuando programes la tombola.</p>" +
                            "</div>" +
                            "<div id=\"scheduleLotteryError\" style=\"display: none; padding: 12px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); border-radius: 8px; color: #fca5a5; margin-bottom: 16px;\"></div>" +
                            "<div style=\"display: flex; gap: 12px;\">" +
                                "<button onclick=\"closeScheduleLotteryModal()\" style=\"flex: 1; padding: 12px; background: #374151; border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 500;\">Cancelar</button>" +
                                "<button onclick=\"submitScheduleLottery()\" id=\"scheduleLotteryBtn\" style=\"flex: 1; padding: 12px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600;\">Programar</button>" +
                            "</div>" +
                        "</div>" +
                    "</div>" +
                "</div>";
            
            document.body.insertAdjacentHTML("beforeend", modalHtml);
            
            // Set minimum datetime to now + 5 minutes
            var now = new Date();
            now.setMinutes(now.getMinutes() + 5);
            var minDateTime = now.toISOString().slice(0, 16);
            document.getElementById("scheduleLotteryDateTime").min = minDateTime;
            
            // FIX 2025-12-31: Load existing scheduled date if available
            var existingDate = scheduleLotteryExistingData?.scheduled_at;
            var existingCountdown = scheduleLotteryExistingData?.countdown_seconds;
            
            if (existingDate) {
                var existingDateTime = new Date(existingDate).toISOString().slice(0, 16);
                document.getElementById("scheduleLotteryDateTime").value = existingDateTime;
            } else {
                document.getElementById("scheduleLotteryDateTime").value = minDateTime;
            }
            
            if (existingCountdown) {
                document.getElementById("scheduleLotteryCountdown").value = existingCountdown.toString();
            }
        }
        
        function closeScheduleLotteryModal() {
            var modal = document.getElementById("scheduleLotteryModal");
            if (modal) modal.remove();
        }
        
        async function submitScheduleLottery() {
            var groupId = manageTurnsGroupId || currentStartGroupId;
            var dateTimeInput = document.getElementById("scheduleLotteryDateTime");
            var countdownSelect = document.getElementById("scheduleLotteryCountdown");
            var errorDiv = document.getElementById("scheduleLotteryError");
            var submitBtn = document.getElementById("scheduleLotteryBtn");
            
            if (!dateTimeInput.value) {
                errorDiv.textContent = "Por favor selecciona una fecha y hora";
                errorDiv.style.display = "block";
                return;
            }
            
            var scheduledAt = new Date(dateTimeInput.value);
            if (scheduledAt <= new Date()) {
                errorDiv.textContent = "La fecha debe ser en el futuro";
                errorDiv.style.display = "block";
                return;
            }
            
            errorDiv.style.display = "none";
            submitBtn.disabled = true;
            submitBtn.textContent = "Programando...";
            
            try {
                var response = await fetch((window.API_BASE_URL || "https://latanda.online") + "/api/groups/" + groupId + "/lottery-schedule", {
                    method: "POST",
                    headers: {
                        ...getAuthHeaders(),
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        scheduled_at: scheduledAt.toISOString(),
                        countdown_seconds: parseInt(countdownSelect.value)
                    })
                });
                
                var result = await response.json();
                
                if (result.success) {
                    closeScheduleLotteryModal();
                    closeManageTurnsModal();
                    showNotification("Tombola programada! " + result.data.members_notified + " miembros notificados", "success");
                    
                    // Refresh data
                    if (typeof refreshTandas === "function") refreshTandas();
                    if (typeof fetchMyGroups === "function") {
                        fetchMyGroups().then(function() {
                            if (typeof renderGroups === "function") renderGroups();
                        });
                    }
                } else {
                    errorDiv.textContent = result.error || result.message || "Error al programar";
                    errorDiv.style.display = "block";
                }
            } catch (error) {
                errorDiv.textContent = "Error de conexion";
                errorDiv.style.display = "block";
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = "Programar";
            }
        }
        
        // Expose functions to global scope
        window.openScheduleLotteryModal = openScheduleLotteryModal;
        window.closeScheduleLotteryModal = closeScheduleLotteryModal;
        window.submitScheduleLottery = submitScheduleLottery;

        window.saveTurnsOrder = saveTurnsOrder;
        window.loadTurnsMembers = loadTurnsMembers;
        window.moveExpandedUp = moveExpandedUp;
        window.moveExpandedDown = moveExpandedDown;
        window.increasePositions = increasePositions;
        window.decreasePositions = decreasePositions;
        window.toggleTurnLock = toggleTurnLock;
        window.renderTurnsList = renderTurnsList;
        // ===== END MANAGE TURNS FUNCTIONALITY =====



        async function submitGroupEdit(event) {
            event.preventDefault();

            var name = document.getElementById('editGroupName').value.trim();
            var description = document.getElementById('editGroupDescription').value.trim();
            var amount = document.getElementById('editGroupAmount').value;
            var frequency = document.getElementById('editGroupFrequency').value;
            var maxMembers = document.getElementById('editGroupMaxMembers').value;
            var location = document.getElementById('editGroupLocation').value.trim();
            var status = document.getElementById('editGroupStatus').value;
            var start_date = document.getElementById('editGroupStartDate').value;
            var errorDiv = document.getElementById('editGroupError');
            var submitBtn = document.getElementById('editGroupSubmitBtn');

            if (!name) {
                if (errorDiv) {
                    errorDiv.textContent = 'El nombre del grupo es requerido';
                    errorDiv.style.display = 'block';
                }
                return;
            }

            if (errorDiv) errorDiv.style.display = 'none';
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Guardando...';
            }

            try {
                var apiBase = window.API_BASE_URL || 'https://latanda.online';
                var userId = getCurrentUserId();

                var updateData = {
                    name: name,
                    description: description || null,
                    status: status
                };

                if (amount) updateData.contribution_amount = parseFloat(amount);
                if (frequency) updateData.frequency = frequency;
                if (maxMembers) updateData.max_members = parseInt(maxMembers);
                if (start_date) updateData.start_date = start_date;
                if (location) updateData.location = location;
                updateData.updated_by = userId;

                var response = await fetch(apiBase + '/api/groups/' + currentEditGroupId + '/update', {
                    method: 'PATCH',
                    headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });

                var data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.data?.error?.message || 'Error al actualizar grupo');
                }

                // Show success
                document.getElementById('editGroupFormFields').style.display = 'none';
                document.getElementById('editGroupFormFooter').style.display = 'none';
                document.getElementById('editGroupSuccess').style.display = 'block';

                if (typeof window.showSuccess === 'function') {
                    window.showSuccess('Grupo actualizado exitosamente');
                }

                // Refresh groups list after 1.5 seconds
                setTimeout(function() {
                    closeEditGroupModal();
                    if (typeof fetchMyGroups === "function") {
                        fetchMyGroups();
                    }
                }, 1500);

            } catch (err) {
                if (errorDiv) {
                    errorDiv.textContent = err.message || 'Error al actualizar el grupo';
                    errorDiv.style.display = 'block';
                }
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Guardar Cambios';
                }
            }
        }

        // Close edit group modal on overlay click
        document.addEventListener('DOMContentLoaded', function() {
            var modal = document.getElementById('editGroupModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) closeEditGroupModal();
                });
            }
        });

        // ============================================
        // REGISTER PAYMENT MODAL FUNCTIONS
        // ============================================
        var currentPaymentGroupId = null;


        // ========== PAYMENT MODAL - Step-based Flow ==========
        var currentPaymentStep = 1;
        var currentPaymentData = null;
        var selectedPaymentMethod = null;
        var proofFile = null;

        function registerGroupPayment(groupId) {
            closeModal(); // Close admin modal first
            setTimeout(function() {
                showRegisterPaymentModal(groupId);
            }, 100);
        }
        window.registerGroupPayment = registerGroupPayment;

        async function showRegisterPaymentModal(groupId) {
            currentPaymentGroupId = groupId;
            currentPaymentStep = 1;
            currentPaymentData = null;
            selectedPaymentMethod = null;
            proofFile = null;
            
            var modal = document.getElementById('registerPaymentModal');
            
            // Reset to step 1
            resetPaymentModal();
            
            // Show modal
            modal.style.display = 'flex'; modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function resetPaymentModal() {
            currentPaymentStep = 1;
            selectedPaymentMethod = null;
            proofFile = null;
            
            // Reset form fields
            var amountInput = document.getElementById('paymentAmount');
            if (amountInput) amountInput.value = '';
            
            // Reset method selection
            document.querySelectorAll('.payment-method-card').forEach(function(card) {
                card.classList.remove('selected');
            });
            var methodInput = document.getElementById('paymentMethod');
            if (methodInput) methodInput.value = '';
            
            // Reset proof upload
            var proofPreview = document.getElementById('proofPreview');
            var proofPrompt = document.getElementById('proofUploadPrompt');
            if (proofPreview) proofPreview.style.display = 'none';
            if (proofPrompt) proofPrompt.style.display = 'block';
            
            // Show step 1, hide others
            showPaymentStep(1);
            updateStepIndicator(1);
            updatePaymentButtons();
        }

        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            document.getElementById('paymentMethod').value = method;
            
            // Update visual selection
            document.querySelectorAll('.payment-method-card').forEach(function(card) {
                card.classList.remove('selected');
            });
            document.querySelector('.payment-method-card[data-method="' + method + '"]').classList.add('selected');
        }

        function showPaymentStep(step) {
            document.querySelectorAll('.payment-step').forEach(function(s) {
                s.style.display = 'none';
            });
            
            var stepEl = document.getElementById('paymentStep' + step);
            if (stepEl) stepEl.style.display = 'block';
            
            // Special handling for success
            if (step === 'success') {
                document.getElementById('paymentSuccess').style.display = 'block';
            }
        }

        function updateStepIndicator(step) {
            document.querySelectorAll('.step-dot').forEach(function(dot, index) {
                dot.classList.remove('active', 'completed');
                if (index + 1 < step) {
                    dot.classList.add('completed');
                } else if (index + 1 === step) {
                    dot.classList.add('active');
                }
            });
        }

        function updatePaymentButtons() {
            var backBtn = document.getElementById('paymentBackBtn');
            var nextBtn = document.getElementById('paymentNextBtn');
            var cancelBtn = document.getElementById('paymentCancelBtn');
            var doneBtn = document.getElementById('paymentDoneBtn');
            var stepIndicator = document.getElementById('paymentStepIndicator');
            
            if (currentPaymentStep === 1) {
                backBtn.style.display = 'none';
                nextBtn.style.display = 'block';
                cancelBtn.style.display = 'block';
                doneBtn.style.display = 'none';
                stepIndicator.style.display = 'flex';
                nextBtn.textContent = 'Continuar →';
            } else if (currentPaymentStep === 2) {
                backBtn.style.display = 'block';
                nextBtn.style.display = 'block';
                cancelBtn.style.display = 'none';
                doneBtn.style.display = 'none';
                stepIndicator.style.display = 'flex';
                nextBtn.textContent = 'Ya realice el pago →';
            } else if (currentPaymentStep === 3) {
                backBtn.style.display = 'block';
                nextBtn.style.display = 'block';
                cancelBtn.style.display = 'none';
                doneBtn.style.display = 'none';
                stepIndicator.style.display = 'flex';
                nextBtn.textContent = 'Enviar Comprobante';
            } else if (currentPaymentStep === 4) {
                // Success state
                backBtn.style.display = 'none';
                nextBtn.style.display = 'none';
                cancelBtn.style.display = 'none';
                doneBtn.style.display = 'block';
                stepIndicator.style.display = 'none';
            }
        }

        async function paymentNextStep() {
            if (currentPaymentStep === 1) {
                // Validate step 1
                var amount = parseFloat(document.getElementById('paymentAmount').value);
                var method = document.getElementById('paymentMethod').value;
                var errorDiv = document.getElementById('paymentStep1Error');
                
                if (!amount || amount <= 0) {
                    errorDiv.textContent = 'Por favor ingresa un monto valido';
                    errorDiv.style.display = 'block';
                    return;
                }
                if (!method) {
                    errorDiv.textContent = 'Por favor selecciona un metodo de pago';
                    errorDiv.style.display = 'block';
                    return;
                }
                errorDiv.style.display = 'none';
                
                // Request payment code from API
                var nextBtn = document.getElementById('paymentNextBtn');
                nextBtn.disabled = true;
                nextBtn.textContent = 'Generando codigo...';
                
                try {
                    var userId = (function() {
                        // Try multiple sources for user ID
                        var latandaUser = localStorage.getItem('latanda_user');
                        if (latandaUser) {
                            try {
                                var userData = JSON.parse(latandaUser);
                                if (userData.user_id) return userData.user_id;
                                if (userData.id) return userData.id;
                            } catch(e) {}
                        }
                        return localStorage.getItem('latanda_user_id') || 
                               sessionStorage.getItem('latanda_user_id') ||
                               localStorage.getItem('userId') ||
                               window.currentUserId ||
                               'user_unknown';
                    })();
                    var apiBase = window.API_BASE_URL || 'https://latanda.online';
                    
                    var response = await fetch(apiBase + '/api/contributions/request', {
                        method: 'POST',
                        headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id: userId,
                            group_id: currentPaymentGroupId,
                            amount: amount,
                            payment_method: method
                        })
                    });
                    
                    var result = await response.json();
                    
                    if (!result.success || !result.data) {
                        throw new Error(result.data?.error?.message || 'Error al generar codigo');
                    }
                    
                    currentPaymentData = result.data;
                    
                    // Display instructions
                    displayPaymentInstructions(currentPaymentData);
                    
                    // Move to step 2
                    currentPaymentStep = 2;
                    showPaymentStep(2);
                    updateStepIndicator(2);
                    updatePaymentButtons();
                    
                } catch (err) {
                    errorDiv.textContent = err.message || 'Error al generar codigo de pago';
                    errorDiv.style.display = 'block';
                } finally {
                    nextBtn.disabled = false;
                    nextBtn.textContent = 'Continuar →';
                }
                
            } else if (currentPaymentStep === 2) {
                // Move to step 3 (upload proof)
                currentPaymentStep = 3;
                showPaymentStep(3);
                updateStepIndicator(3);
                updatePaymentButtons();
                
            } else if (currentPaymentStep === 3) {
                // Submit proof and complete
                await submitPaymentWithProof();
            }
        }

        function paymentPrevStep() {
            if (currentPaymentStep > 1) {
                currentPaymentStep--;
                showPaymentStep(currentPaymentStep);
                updateStepIndicator(currentPaymentStep);
                updatePaymentButtons();
            }
        }

        function displayPaymentInstructions(data) {
            // Reference code
            document.getElementById('referenceCodeDisplay').textContent = data.reference_code;
            
            // Instructions title
            document.getElementById('instructionsTitle').textContent = data.instructions.title;
            
            // Instructions steps
            var stepsList = document.getElementById('instructionsSteps');
            stepsList.innerHTML = '';
            data.instructions.steps.forEach(function(step) {
                var li = document.createElement('li');
                li.textContent = step;
                li.style.marginBottom = '8px';
                stepsList.appendChild(li);
            });
            
            // Bank details (if applicable)
            var bankBox = document.getElementById('bankDetailsBox');
            if (data.instructions.bank_details) {
                bankBox.style.display = 'block';
                var bankContent = document.getElementById('bankDetailsContent');
                var bd = data.instructions.bank_details;
                bankContent.innerHTML = 
                    '<div style="margin-bottom: 6px;"><strong>Banco:</strong> ' + bd.bank_name + '</div>' +
                    '<div style="margin-bottom: 6px;"><strong>Cuenta:</strong> ' + bd.account_number + '</div>' +
                    '<div style="margin-bottom: 6px;"><strong>Titular:</strong> ' + bd.account_holder + '</div>' +
                    '<div><strong>Tipo:</strong> ' + bd.account_type + '</div>';
            } else {
                bankBox.style.display = 'none';
            }
            
            // Verification time
            document.getElementById('verificationTimeText').textContent = 
                'Tiempo de verificacion: ' + data.instructions.verification_time;
        }

        function copyReferenceCode() {
            var code = document.getElementById('referenceCodeDisplay').textContent;
            navigator.clipboard.writeText(code).then(function() {
                if (typeof window.showSuccess === 'function') {
                    window.showSuccess('Codigo copiado!');
                } else {
                    showSuccess('Codigo copiado!');
                }
            });
        }

        function handleProofUpload(event) {
            var file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                var errorDiv = document.getElementById('paymentStep3Error');
                errorDiv.textContent = 'Por favor selecciona una imagen';
                errorDiv.style.display = 'block';
                return;
            }
            
            proofFile = file;
            
            // Show preview
            var reader = new FileReader();
            reader.onload = function(e) {
                var previewImg = document.getElementById('proofPreviewImage');
                previewImg.src = e.target.result;
                document.getElementById('proofPreview').style.display = 'block';
                document.getElementById('proofUploadPrompt').style.display = 'none';
            };
            reader.readAsDataURL(file);
            
            document.getElementById('paymentStep3Error').style.display = 'none';
        }

        async function submitPaymentWithProof() {
            var errorDiv = document.getElementById('paymentStep3Error');
            var nextBtn = document.getElementById('paymentNextBtn');

            // Validate proof file
            if (!proofFile) {
                errorDiv.textContent = 'Por favor sube un comprobante';
                errorDiv.style.display = 'block';
                return;
            }

            // Validate we have contribution data
            if (!currentPaymentData || !currentPaymentData.contribution_id) {
                errorDiv.textContent = 'Error: datos de contribucion no encontrados';
                errorDiv.style.display = 'block';
                return;
            }

            nextBtn.disabled = true;
            nextBtn.textContent = 'Enviando...';
            errorDiv.style.display = 'none';

            try {
                var apiBase = window.API_BASE_URL || 'https://latanda.online';

                // Create FormData for file upload
                var formData = new FormData();
                formData.append('proof', proofFile);

                // Upload proof to backend
                var response = await fetch(apiBase + '/api/contributions/' + currentPaymentData.contribution_id + '/upload-proof', {
                    method: 'POST',
                    headers: { ...getAuthHeaders() },
                    body: formData
                });

                var result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.error || result.message || 'Error al subir comprobante');
                }

                // Show success
                currentPaymentStep = 4;
                showPaymentStep('success');

                document.getElementById('paymentSuccessMessage').textContent =
                    'Pago de L. ' + currentPaymentData.amount.toLocaleString('es-HN', {minimumFractionDigits: 2}) + ' registrado';
                document.getElementById('paymentSuccessCode').textContent =
                    'Codigo: ' + currentPaymentData.reference_code;
                document.getElementById('paymentSuccessStatus').textContent =
                    'Estado: Esperando verificacion';

                updatePaymentButtons();

                if (typeof window.showSuccess === 'function') {
                    window.showSuccess('Comprobante enviado exitosamente');
                }

                // Refresh the page data after a short delay
                setTimeout(function() {
                    if (typeof loadGroupsData === 'function') {
                        loadGroupsData();
                    }
                }, 2000);

            } catch (err) {
                errorDiv.textContent = err.message || 'Error al enviar comprobante';
                errorDiv.style.display = 'block';
            } finally {
                nextBtn.disabled = false;
                nextBtn.textContent = 'Enviar Comprobante';
            }
        }

        function closeRegisterPaymentModal() {
            var modal = document.getElementById('registerPaymentModal');
            if (modal) {
                modal.style.display = 'none'; modal.classList.remove('active');
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
            currentPaymentGroupId = null;
            currentPaymentData = null;
            proofFile = null;
        }

        // Keep legacy functions for backwards compatibility
        function resetPaymentForm() {
            resetPaymentModal();
        }

        async function loadMembersForPayment(groupId) {
            // Legacy function - no longer needed in new flow
            return;
        }

        async function submitPayment(event) {
            // Legacy function - redirects to new flow
            if (event) event.preventDefault();
            paymentNextStep();
        }
        // ========== END PAYMENT MODAL ==========

        // Close register payment modal on overlay click
        document.addEventListener('DOMContentLoaded', function() {
            var modal = document.getElementById('registerPaymentModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) closeRegisterPaymentModal();
                });
            }
        });

    </script>


    <script>
        // ============================================
        // GROUP MANAGEMENT MODAL
        // ============================================
        var currentManagedGroupId = null;

        // Global closeModal function for admin modal
        window.closeModal = function() {
            var modal = document.getElementById('groupManageModal');
            if (modal) {
                modal.style.display = 'none'; modal.classList.remove('active'); modal.classList.remove('active');
                document.body.style.overflow = '';
            }
            currentManagedGroupId = null;
        };

        // manageGroup - shows the admin options modal
        window.manageGroup = function(groupId) {
            currentManagedGroupId = groupId;
            // Always recreate modal to ensure all buttons are present
            var modal = document.getElementById('groupManageModal');
            if (modal) { modal.remove(); }
            var groupData = window.currentGroupsData?.find(function(g) { return g.id === groupId; }); var userRole = groupData?.my_role || "member"; createGroupManageModal(userRole);
            modal = document.getElementById('groupManageModal');

            // Update the group name in modal title
            var titleEl = document.getElementById('manageModalGroupName');
            if (titleEl) {
                titleEl.textContent = groupData?.name || 'Grupo';
            }

            modal.style.display = 'flex'; modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        };

        function createGroupManageModal(userRole) { var canManageTurns = (userRole === "creator" || userRole === "coordinator"); var canEditGroup = (userRole === "creator" || userRole === "coordinator"); var canDeleteGroup = (userRole === "creator");
            var modalHtml = '<div id="groupManageModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 10000;">' +
                '<div class="modal-content" style="background: white; border-radius: 16px; max-width: 400px; width: 90%; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); animation: modalSlideIn 0.3s ease-out;">' +
                    '<div class="modal-header" style="background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%); color: white; padding: 20px; border-radius: 16px 16px 0 0; position: relative;">' +
                        '<div style="display: flex; align-items: center; gap: 12px;">' +
                            '<div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 12px;">' +
                                '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>' +
                            '</div>' +
                            '<div>' +
                                '<h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">Administrar Grupo</h3>' +
                                '<p id="manageModalGroupName" style="margin: 4px 0 0; font-size: 0.875rem; opacity: 0.9;">Grupo</p>' +
                            '</div>' +
                        '</div>' +
                        '<button onclick="closeModal()" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;">' +
                            '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>' +
                        '</button>' +
                    '</div>' +
                    '<div class="modal-body" style="padding: 16px;">' +
                        '<div style="display: flex; flex-direction: column; gap: 8px;">' +
                            '<button onclick="viewGroupMembers(currentManagedGroupId)" class="admin-option-btn" style="display: flex; align-items: center; gap: 12px; width: 100%; padding: 14px 16px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.2s;">' +
                                '<div style="width: 40px; height: 40px; background: #ede9fe; border-radius: 10px; display: flex; align-items: center; justify-content: center;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#7c3aed" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div>' +
                                '<div style="text-align: left;"><div style="font-weight: 500; color: #111827;">Ver Miembros</div><div style="font-size: 0.75rem; color: #6b7280;">Lista de participantes</div></div>' +
                            '</button>' +
                            '<button onclick="viewGroupPayments(currentManagedGroupId)" class="admin-option-btn" style="display: flex; align-items: center; gap: 12px; width: 100%; padding: 14px 16px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.2s;">' +
                                '<div style="width: 40px; height: 40px; background: #d1fae5; border-radius: 10px; display: flex; align-items: center; justify-content: center;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#059669" stroke-width="2"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div>' +
                                '<div style="text-align: left;"><div style="font-weight: 500; color: #111827;">Ver Pagos</div><div style="font-size: 0.75rem; color: #6b7280;">Historial de contribuciones</div></div>' +
                            '</button>' +
                            '<button onclick="inviteToGroup(currentManagedGroupId)" class="admin-option-btn" style="display: flex; align-items: center; gap: 12px; width: 100%; padding: 14px 16px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.2s;">' +
                                '<div style="width: 40px; height: 40px; background: #fef3c7; border-radius: 10px; display: flex; align-items: center; justify-content: center;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#d97706" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg></div>' +
                                '<div style="text-align: left;"><div style="font-weight: 500; color: #111827;">Invitar Miembros</div><div style="font-size: 0.75rem; color: #6b7280;">Enviar invitaciones</div></div>' +
                            '</button>' +
                            '<button onclick="registerGroupPayment(currentManagedGroupId)" class="admin-option-btn" style="display: flex; align-items: center; gap: 12px; width: 100%; padding: 14px 16px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.2s;">' +
                                '<div style="width: 40px; height: 40px; background: #dbeafe; border-radius: 10px; display: flex; align-items: center; justify-content: center;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg></div>' +
                                '<div style="text-align: left;"><div style="font-weight: 500; color: #111827;">Registrar Pago</div><div style="font-size: 0.75rem; color: #6b7280;">Agregar contribucion</div></div>' +
                            '</button>' +
                            (canManageTurns ? '<button onclick="verifyPendingPayments(currentManagedGroupId)" class="admin-option-btn" style="display: flex; align-items: center; gap: 12px; width: 100%; padding: 14px 16px; background: #fef3c7; border: 1px solid #fcd34d; border-radius: 12px; cursor: pointer; transition: all 0.2s;">' +
                                '<div style="width: 40px; height: 40px; background: #fef3c7; border-radius: 10px; display: flex; align-items: center; justify-content: center;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#d97706" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg></div>' +
                                '<div style="text-align: left;"><div style="font-weight: 500; color: #92400e;">Verificar Pagos</div><div style="font-size: 0.75rem; color: #b45309;">Aprobar pagos pendientes</div></div>' +
                            '</button>' : '') +
                            (canManageTurns ? '<button onclick="showDistributionPreview(currentManagedGroupId)" class="admin-option-btn" style="display: flex; align-items: center; gap: 12px; width: 100%; padding: 14px 16px; background: #d1fae5; border: 1px solid #6ee7b7; border-radius: 12px; cursor: pointer; transition: all 0.2s;">' +
                                '<div style="width: 40px; height: 40px; background: #d1fae5; border-radius: 10px; display: flex; align-items: center; justify-content: center;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#059669" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg></div>' +
                                '<div style="text-align: left;"><div style="font-weight: 500; color: #065f46;">Distribuir Ciclo</div><div style="font-size: 0.75rem; color: #047857;">Repartir fondos del ciclo</div></div>' +
                            '</button>' : '') +
                            (canManageTurns ? '<button onclick="manageTurns(currentManagedGroupId)" class="admin-option-btn" style="display: flex; align-items: center; gap: 12px; width: 100%; padding: 14px 16px; background: #fef3c7; border: 1px solid #fcd34d; border-radius: 12px; cursor: pointer; transition: all 0.2s;">' +
                                '<div style="width: 40px; height: 40px; background: #fef3c7; border-radius: 10px; display: flex; align-items: center; justify-content: center;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#d97706" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 12l2 2 4-4"/></svg></div>' +
                                '<div style="text-align: left;"><div style="font-weight: 500; color: #92400e;">Gestionar Turnos</div><div style="font-size: 0.75rem; color: #b45309;">Reordenar posiciones</div></div>' +
                            '</button>' : '') +
                            (canManageTurns ? '<button onclick="toggleTandaPause(currentManagedGroupId)" class="admin-option-btn" style="display: flex; align-items: center; gap: 12px; width: 100%; padding: 14px 16px; background: #fef2f2; border: 1px solid #fca5a5; border-radius: 12px; cursor: pointer; transition: all 0.2s;">' +
                                '<div style="width: 40px; height: 40px; background: #fee2e2; border-radius: 10px; display: flex; align-items: center; justify-content: center;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg></div>' +
                                '<div style="text-align: left;"><div style="font-weight: 500; color: #dc2626;">Pausar/Reanudar</div><div style="font-size: 0.75rem; color: #ef4444;">Detener temporalmente la tanda</div></div>' +
                            '</button>' : '') +
                            (canEditGroup ? '<button onclick="editGroup(currentManagedGroupId)" class="admin-option-btn" style="display: flex; align-items: center; gap: 12px; width: 100%; padding: 14px 16px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.2s;">' +
                                '<div style="width: 40px; height: 40px; background: #e0e7ff; border-radius: 10px; display: flex; align-items: center; justify-content: center;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#4f46e5" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></div>' +
                                '<div style="text-align: left;"><div style="font-weight: 500; color: #111827;">Editar Grupo</div><div style="font-size: 0.75rem; color: #6b7280;">Modificar configuracion</div></div>' +
                            '</button>' : '') +
                            (canDeleteGroup ? '<button onclick="confirmDeleteGroup(currentManagedGroupId)" class="admin-option-btn" style="display: flex; align-items: center; gap: 12px; width: 100%; padding: 14px 16px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 12px; cursor: pointer; transition: all 0.2s;">' +
                                '<div style="width: 40px; height: 40px; background: #fee2e2; border-radius: 10px; display: flex; align-items: center; justify-content: center;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></div>' +
                                '<div style="text-align: left;"><div style="font-weight: 500; color: #dc2626;">Eliminar Grupo</div><div style="font-size: 0.75rem; color: #ef4444;">Esta accion es irreversible</div></div>' +
                            '</button>' : '') +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';

            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Add click outside to close
            var modal = document.getElementById('groupManageModal');
            modal.addEventListener('click', function(e) {
                if (e.target === modal) closeModal();
            });
        }

        // Add hover effect styles
        var styleEl = document.createElement('style');
        styleEl.textContent = '.admin-option-btn:hover { background: #f3f4f6 !important; border-color: #d1d5db !important; transform: translateX(4px); }';
        document.head.appendChild(styleEl);

    </script>

<!-- FASE 2: Group Notification Helpers (Toast-based) - Added 2025-11-27 -->
<script>
(function() {
    'use strict';
    
    // Helper functions for group notifications using existing toast system
    window.notifyMemberAdded = function(groupName, memberName) {
        if (window.showToast) {
            window.showToast(memberName + ' se unio a ' + groupName, 'success');
        }
    };
    
    window.notifyPaymentRegistered = function(groupName, amount) {
        if (window.showToast) {
            window.showToast('Pago de $' + amount + ' registrado en ' + groupName, 'success');
        }
    };
    
    window.notifyInvitationSent = function(groupName, email) {
        if (window.showToast) {
            window.showToast('Invitacion enviada a ' + email, 'success');
        }
    };
    
    window.notifyGroupUpdated = function(groupName) {
        if (window.showToast) {
            window.showToast('Grupo ' + groupName + ' actualizado', 'success');
        }
    };
    
    window.notifyGroupCreated = function(groupName) {
        if (window.showToast) {
            window.showToast('Grupo ' + groupName + ' creado exitosamente', 'success');
        }
    };
    
    window.notifyExportStarted = function(format) {
        if (window.showToast) {
            window.showToast('Exportando datos en formato ' + format.toUpperCase() + '...', 'info');
        }
    };
    
    window.notifyError = function(message) {
        if (window.showToast) {
            window.showToast(message, 'error');
        }
    };
    
})();
</script>

<!-- FASE 1: Export Functions - Added 2025-11-27 -->
<script>
(function() {
    'use strict';
    window.exportGroupMembers = function(groupId, format) {
        if (!groupId) groupId = window.currentMembersGroupId || window.currentManagedGroupId;
        if (!groupId) { showError('No se pudo determinar el grupo'); return; }
        var apiBase = window.API_BASE_URL || 'https://latanda.online';
        if (window.notifyExportStarted) window.notifyExportStarted(format); window.open(apiBase + '/api/groups/' + groupId + '/export/members?format=' + format, '_blank');
    };
    window.exportGroupPayments = function(groupId, format) {
        if (!groupId) groupId = window.currentPaymentsGroupId || window.currentManagedGroupId;
        if (!groupId) { showError('No se pudo determinar el grupo'); return; }
        var apiBase = window.API_BASE_URL || 'https://latanda.online';
        if (window.notifyExportStarted) window.notifyExportStarted(format); window.open(apiBase + '/api/groups/' + groupId + '/export/payments?format=' + format, '_blank');
    };
})();
</script>

<!-- FASE 1: Export Buttons for Admin Modal - Added 2025-11-27 -->
<script>
(function() {
    'use strict';
    
    // Override manageGroup to add export buttons after modal is shown
    var originalManageGroup = window.manageGroup;
    window.manageGroup = function(groupId) {
        originalManageGroup(groupId);
        
        // Add export buttons after a short delay to ensure modal is rendered
        setTimeout(function() {
            var modal = document.getElementById('groupManageModal');
            if (!modal) return;
            
            var modalBody = modal.querySelector('.modal-body > div');
            if (!modalBody) return;
            
            // Check if export section already exists
            if (modal.querySelector('.export-section')) return;
            
            // Create export section
            var exportSection = document.createElement('div');
            exportSection.className = 'export-section';
            exportSection.style.cssText = 'margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;';
            exportSection.innerHTML = 
                '<div style="padding: 8px 0; color: #6b7280; font-size: 0.75rem; font-weight: 500; text-transform: uppercase;">Exportar Datos</div>' +
                '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">' +
                    '<button id="export-members-pdf" style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 10px; cursor: pointer; font-size: 0.875rem; color: #374151;"><span>📄</span> Miembros PDF</button>' +
                    '<button id="export-members-csv" style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 10px; cursor: pointer; font-size: 0.875rem; color: #374151;"><span>📊</span> Miembros CSV</button>' +
                    '<button id="export-payments-pdf" style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 10px; cursor: pointer; font-size: 0.875rem; color: #374151;"><span>📄</span> Pagos PDF</button>' +
                    '<button id="export-payments-csv" style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 10px; cursor: pointer; font-size: 0.875rem; color: #374151;"><span>📊</span> Pagos CSV</button>' +
                '</div>';
            
            modalBody.appendChild(exportSection);
            
            // Add click handlers
            exportSection.querySelector('#export-members-pdf').onclick = function() { window.exportGroupMembers(window.currentManagedGroupId, 'pdf'); };
            exportSection.querySelector('#export-members-csv').onclick = function() { window.exportGroupMembers(window.currentManagedGroupId, 'csv'); };
            exportSection.querySelector('#export-payments-pdf').onclick = function() { window.exportGroupPayments(window.currentManagedGroupId, 'pdf'); };
            exportSection.querySelector('#export-payments-csv').onclick = function() { window.exportGroupPayments(window.currentManagedGroupId, 'csv'); };
            
        }, 50);
    };
    
})();
</script>

<!-- ===== MODAL DE PAGO RÁPIDO ===== -->
<div id="quickPayModal" class="modal" style="display:none; position:fixed !important; top:0 !important; left:0 !important; width:100vw !important; height:100vh !important; background:rgba(255,0,0,0.9) !important; z-index:999999 !important; justify-content:center !important; align-items:center !important;">
    <div class="modal-content quick-pay-modal" style="background:#1a2332; border-radius:12px; padding:20px; max-width:500px; width:90%; color:white;">
        <div class="modal-header">
            <h3><i class="fas fa-credit-card"></i> Realizar Pago</h3>
            <button class="close-btn" onclick="closeQuickPayModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="payment-summary">
                <div class="summary-row">
                    <span class="label">Tanda:</span>
                    <span class="value" id="qp-tanda-name">--</span>
                </div>
                <div class="summary-row">
                    <span class="label">Monto:</span>
                    <span class="value amount" id="qp-amount">L. 0.00</span>
                </div>
                <div class="summary-row">
                    <span class="label">Beneficiario:</span>
                    <span class="value" id="qp-beneficiary">--</span>
                </div>
                <div class="summary-row">
                    <span class="label">Vencimiento:</span>
                    <span class="value" id="qp-due-date">--</span>
                </div>
            </div>
            
            <div class="payment-methods">
                <h4>Método de Pago</h4>
                <div class="method-options">
                    <label class="method-option">
                        <input type="radio" name="paymentMethod" value="wallet" checked>
                        <span class="method-icon"><i class="fas fa-wallet"></i></span>
                        <span class="method-info">
                            <span class="method-name">Billetera La Tanda</span>
                            <span class="method-balance" id="qp-wallet-balance">Saldo: L. 0.00</span>
                        </span>
                    </label>
                    <label class="method-option">
                        <input type="radio" name="paymentMethod" value="transfer">
                        <span class="method-icon"><i class="fas fa-university"></i></span>
                        <span class="method-info">
                            <span class="method-name">Transferencia Bancaria</span>
                            <span class="method-desc">Se generará referencia</span>
                        </span>
                    </label>
                    <label class="method-option">
                        <input type="radio" name="paymentMethod" value="cash">
                        <span class="method-icon"><i class="fas fa-money-bill-wave"></i></span>
                        <span class="method-info">
                            <span class="method-name">Pago en Efectivo</span>
                            <span class="method-desc">Registrar pago manual</span>
                        </span>
                    </label>
                </div>
            </div>
            
            <div class="insufficient-funds-warning" id="qp-insufficient" style="display:none;">
                <i class="fas fa-exclamation-triangle"></i>
                <span>Saldo insuficiente. Selecciona otro método de pago.</span>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeQuickPayModal()">Cancelar</button>
            <button class="btn btn-primary" id="qp-confirm-btn" onclick="confirmQuickPay()">
                <i class="fas fa-check"></i> CONFIRMAR PAGO
            </button>
        </div>
    </div>
</div>
<!-- ===== FIN MODAL DE PAGO RÁPIDO ===== -->

<!-- ===== MODAL DE HISTORIAL PERSONAL ===== -->
<div id="personalHistoryModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:99999; justify-content:center; align-items:center;">
    <div class="modal-content history-modal">
        <div class="modal-header">
            <h3><i class="fas fa-history"></i> Mi Historial</h3>
            <button class="close-btn" onclick="closeHistoryModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="history-tabs">
                <button class="history-tab active" data-tab="payments" onclick="switchHistoryTab(\"payments\")">
                    <i class="fas fa-arrow-up"></i> Mis Pagos
                </button>
                <button class="history-tab" data-tab="collections" onclick="switchHistoryTab(\"collections\")">
                    <i class="fas fa-arrow-down"></i> Mis Cobros
                </button>
            </div>
            
            <div class="history-filters">
                <select id="historyTandaFilter" onchange="filterHistory()">
                    <option value="all">Todas las tandas</option>
                </select>
                <select id="historyPeriodFilter" onchange="filterHistory()">
                    <option value="all">Todo el tiempo</option>
                    <option value="month">Este mes</option>
                    <option value="3months">Ultimos 3 meses</option>
                    <option value="year">Este ano</option>
                </select>
            </div>
            
            <div class="history-summary">
                <div class="summary-stat">
                    <span class="stat-value" id="hist-total-paid">L. 0.00</span>
                    <span class="stat-label">Total Pagado</span>
                </div>
                <div class="summary-stat">
                    <span class="stat-value" id="hist-total-collected">L. 0.00</span>
                    <span class="stat-label">Total Cobrado</span>
                </div>
                <div class="summary-stat">
                    <span class="stat-value" id="hist-transactions">0</span>
                    <span class="stat-label">Transacciones</span>
                </div>
            </div>
            
            <div id="historyContent" class="history-content">
                <div class="history-list" id="paymentsList">
                    <!-- Se genera dinamicamente -->
                </div>
                <div class="history-list" id="collectionsList" style="display:none;">
                    <!-- Se genera dinamicamente -->
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeHistoryModal()">Cerrar</button>
            <button class="btn btn-outline" onclick="exportHistory()">
                <i class="fas fa-download"></i> Exportar PDF
            </button>
        </div>
    </div>
</div>
<!-- ===== FIN MODAL DE HISTORIAL ===== -->

<!-- PAYMENT VERIFICATION MODAL - Added for coordinator verification -->
<div id="verifyPaymentsModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 10001;">
    <div class="modal-content" style="background: white; border-radius: 16px; max-width: 600px; width: 95%; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden;">
        <div class="modal-header" style="background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%); color: white; padding: 20px; border-radius: 16px 16px 0 0; position: relative;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 12px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
                    </svg>
                </div>
                <div>
                    <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">Verificar Pagos</h3>
                    <p id="verifyModalGroupName" style="margin: 4px 0 0; font-size: 0.875rem; opacity: 0.9;">Pagos pendientes de aprobacion</p>
                </div>
            </div>
            <button onclick="closeVerifyPaymentsModal()" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div id="verifyPaymentsContent" class="modal-body" style="padding: 20px; flex: 1; overflow-y: auto;">
            <div style="text-align: center; padding: 40px;">
                <div class="spinner" style="border: 3px solid #f3f3f3; border-top: 3px solid #d97706; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                <p style="margin-top: 16px; color: #6b7280;">Cargando pagos pendientes...</p>
            </div>
        </div>
    </div>
</div>

<style>
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.pending-payment-card { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-bottom: 12px; }
.pending-payment-card:hover { border-color: #d97706; }
.payment-proof-thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; cursor: pointer; border: 2px solid #e5e7eb; }
.payment-proof-thumb:hover { border-color: #d97706; }
.verify-btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 500; font-size: 0.875rem; }
.verify-btn.approve { background: #059669; color: white; }
.verify-btn.approve:hover { background: #047857; }
.verify-btn.reject { background: #dc2626; color: white; }
.verify-btn.reject:hover { background: #b91c1c; }
</style>

<script>
(function() {
    'use strict';

    var currentVerifyGroupId = null;

    window.verifyPendingPayments = async function(groupId) {
        currentVerifyGroupId = groupId;
        closeModal(); // Close admin modal

        setTimeout(async function() {
            var modal = document.getElementById('verifyPaymentsModal');
            modal.style.display = 'flex'; modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Load pending payments
            await loadPendingPayments(groupId);
        }, 100);
    };

    async function loadPendingPayments(groupId) {
        var contentDiv = document.getElementById('verifyPaymentsContent');

        try {
            var apiBase = window.API_BASE_URL || 'https://latanda.online';
            var response = await fetch(apiBase + '/api/groups/' + groupId + '/contributions/pending', { headers: getAuthHeaders() });
            var result = await response.json();

            if (!result.success) {
                throw new Error(result.error || 'Error al cargar pagos');
            }

            var contributions = result.data.contributions || [];

            if (contributions.length === 0) {
                contentDiv.innerHTML =
                    '<div style="text-align: center; padding: 40px;">' +
                        '<div style="font-size: 48px; margin-bottom: 16px;">✅</div>' +
                        '<h4 style="margin: 0 0 8px; color: #111827;">No hay pagos pendientes</h4>' +
                        '<p style="color: #6b7280; margin: 0;">Todos los pagos han sido verificados</p>' +
                    '</div>';
                return;
            }

            var html = '<div style="margin-bottom: 16px;">' +
                '<p style="margin: 0; color: #6b7280; font-size: 0.875rem;">' + contributions.length + ' pago(s) pendiente(s) de verificacion</p>' +
            '</div>';

            contributions.forEach(function(c) {
                var statusBadge = c.status === 'pending_verification'
                    ? '<span style="background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem;">Esperando verificacion</span>'
                    : '<span style="background: #dbeafe; color: #2563eb; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem;">Esperando pago</span>';

                var methodIcon = {
                    'cash': '💵',
                    'bank_transfer': '🏦',
                    'mobile_money': '📱',
                    'card': '💳',
                    'crypto': '₿',
                    'wallet': '👛'
                }[c.payment_method] || '💰';

                var proofHtml = c.proof_url
                    ? '<img loading="lazy" src="' + (window.API_BASE_URL || 'https://latanda.online') + c.proof_url + '" class="payment-proof-thumb" onclick="showProofFullscreen(\'' + c.proof_url + '\')" alt="Comprobante">'
                    : '<div style="width: 60px; height: 60px; background: #f3f4f6; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #9ca3af; font-size: 0.75rem;">Sin comprobante</div>';

                html += '<div class="pending-payment-card" data-contribution-id="' + c.id + '">' +
                    '<div style="display: flex; gap: 16px;">' +
                        '<div>' + proofHtml + '</div>' +
                        '<div style="flex: 1;">' +
                            '<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">' +
                                '<div>' +
                                    '<div style="font-weight: 600; color: #111827;">' + (c.user_name || 'Usuario') + '</div>' +
                                    '<div style="font-size: 0.75rem; color: #6b7280;">' + (c.user_email || c.user_phone || '') + '</div>' +
                                '</div>' +
                                statusBadge +
                            '</div>' +
                            '<div style="display: flex; gap: 16px; margin-bottom: 8px;">' +
                                '<div>' +
                                    '<div style="font-size: 0.75rem; color: #6b7280;">Monto</div>' +
                                    '<div style="font-weight: 600; color: #059669;">L. ' + parseFloat(c.amount).toLocaleString('es-HN', {minimumFractionDigits: 2}) + '</div>' +
                                '</div>' +
                                '<div>' +
                                    '<div style="font-size: 0.75rem; color: #6b7280;">Metodo</div>' +
                                    '<div style="font-weight: 500;">' + methodIcon + ' ' + formatPaymentMethod(c.payment_method) + '</div>' +
                                '</div>' +
                            '</div>' +
                            '<div style="font-size: 0.75rem; color: #9ca3af; margin-bottom: 12px;">' +
                                'Ref: ' + (c.reference_code || 'N/A') + ' · ' + new Date(c.created_at).toLocaleString('es-HN') +
                            '</div>' +
                            (c.status === 'pending_verification' ?
                            '<div style="display: flex; gap: 8px;">' +
                                '<button class="verify-btn approve" onclick="approvePayment(\'' + c.id + '\')">✓ Aprobar</button>' +
                                '<button class="verify-btn reject" onclick="rejectPayment(\'' + c.id + '\')">✗ Rechazar</button>' +
                            '</div>' :
                            '<div style="font-size: 0.875rem; color: #6b7280; font-style: italic;">Esperando que el usuario suba comprobante</div>') +
                        '</div>' +
                    '</div>' +
                '</div>';
            });

            contentDiv.innerHTML = html;

        } catch (err) {
            contentDiv.innerHTML =
                '<div style="text-align: center; padding: 40px;">' +
                    '<div style="font-size: 48px; margin-bottom: 16px;">❌</div>' +
                    '<h4 style="margin: 0 0 8px; color: #dc2626;">Error al cargar</h4>' +
                    '<p style="color: #6b7280; margin: 0;">' + (err.message || 'Intenta de nuevo') + '</p>' +
                '</div>';
        }
    }

    function formatPaymentMethod(method) {
        var methods = {
            'cash': 'Efectivo',
            'bank_transfer': 'Transferencia',
            'mobile_money': 'Tigo Money',
            'card': 'Tarjeta',
            'crypto': 'Crypto',
            'wallet': 'Billetera'
        };
        return methods[method] || method;
    }

    window.approvePayment = async function(contributionId) {
        if (!confirm('¿Confirmas que este pago es válido?')) return;

        try {
            var apiBase = window.API_BASE_URL || 'https://latanda.online';
            var userId = (function() {
                var latandaUser = localStorage.getItem('latanda_user');
                if (latandaUser) {
                    try {
                        var userData = JSON.parse(latandaUser);
                        if (userData.user_id) return userData.user_id;
                        if (userData.id) return userData.id;
                    } catch(e) {}
                }
                return localStorage.getItem('latanda_user_id') || 
                       sessionStorage.getItem('latanda_user_id') ||
                       localStorage.getItem('userId') ||
                       window.currentUserId ||
                       'coordinator';
            })();

            var response = await fetch(apiBase + '/api/contributions/' + contributionId + '/verify', {
                method: 'POST',
                headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'approve',
                    verified_by: userId
                })
            });

            var result = await response.json();

            if (!result.success) {
                throw new Error(result.error || 'Error al aprobar pago');
            }

            if (window.showSuccess) window.showSuccess('Pago aprobado exitosamente');

            // Reload payments
            await loadPendingPayments(currentVerifyGroupId);

        } catch (err) {
            showError(err.message || 'No se pudo aprobar el pago');
        }
    };

    window.rejectPayment = async function(contributionId) {
        var reason = prompt('Motivo del rechazo (opcional):');
        if (reason === null) return; // Cancelled

        try {
            var apiBase = window.API_BASE_URL || 'https://latanda.online';
            var userId = localStorage.getItem('latanda_user_id') || 'coordinator';

            var response = await fetch(apiBase + '/api/contributions/' + contributionId + '/verify', {
                method: 'POST',
                headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'reject',
                    verified_by: userId,
                    rejection_reason: reason || 'Rechazado por coordinador'
                })
            });

            var result = await response.json();

            if (!result.success) {
                throw new Error(result.error || 'Error al rechazar pago');
            }

            if (window.showSuccess) window.showSuccess('Pago rechazado');

            // Reload payments
            await loadPendingPayments(currentVerifyGroupId);

        } catch (err) {
            showError(err.message || 'No se pudo rechazar el pago');
        }
    };

    window.showProofFullscreen = function(proofUrl) {
        var fullUrl = (window.API_BASE_URL || 'https://latanda.online') + proofUrl;

        var overlay = document.createElement('div');
        overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100000; display: flex; align-items: center; justify-content: center; cursor: pointer;';
        overlay.onclick = function() { overlay.remove(); };

        var img = document.createElement('img');
        img.src = fullUrl;
        img.style.cssText = 'max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px;';

        overlay.appendChild(img);
        document.body.appendChild(overlay);
    };

    window.closeVerifyPaymentsModal = function() {
        var modal = document.getElementById('verifyPaymentsModal');
        if (modal) {
            modal.style.display = 'none'; modal.classList.remove('active');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }
        currentVerifyGroupId = null;
    };

})();
</script>


<!-- CYCLE DISTRIBUTION MODAL - Added for coordinator distribution view -->
<div id="distributionModal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 10001;">
    <div class="modal-content" style="background: white; border-radius: 16px; max-width: 550px; width: 95%; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden;">
        <div class="modal-header" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; padding: 20px; border-radius: 16px 16px 0 0; position: relative;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 12px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                    </svg>
                </div>
                <div>
                    <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">Distribucion de Ciclo</h3>
                    <p id="distributionGroupName" style="margin: 4px 0 0; font-size: 0.875rem; opacity: 0.9;">Resumen de distribucion</p>
                </div>
            </div>
            <button onclick="closeDistributionModal()" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>
        <div id="distributionContent" class="modal-body" style="padding: 20px; flex: 1; overflow-y: auto;">
            <div style="text-align: center; padding: 40px;">
                <div class="spinner" style="border: 3px solid #f3f3f3; border-top: 3px solid #059669; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                <p style="margin-top: 16px; color: #6b7280;">Calculando distribucion...</p>
            </div>
        </div>
        <div id="distributionFooter" class="modal-footer" style="display: none; padding: 16px 24px; border-top: 1px solid #e5e7eb; background: #f9fafb; border-radius: 0 0 16px 16px;">
            <button onclick="closeDistributionModal()" style="padding: 10px 20px; background: #f3f4f6; color: #374151; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">Cancelar</button>
            <button id="executeDistributionBtn" onclick="executeDistribution()" style="padding: 10px 24px; background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">
                Ejecutar Distribucion
            </button>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';

    var currentDistributionGroupId = null;
    var currentDistributionData = null;

    window.showDistributionPreview = async function(groupId) {
        currentDistributionGroupId = groupId;
        closeModal(); // Close admin modal

        setTimeout(async function() {
            var modal = document.getElementById('distributionModal');
            modal.style.display = 'flex'; modal.classList.add('active');
            document.body.style.overflow = 'hidden';

            await loadDistributionPreview(groupId);
        }, 100);
    };

    async function loadDistributionPreview(groupId) {
        var contentDiv = document.getElementById('distributionContent');
        var footerDiv = document.getElementById('distributionFooter');

        try {
            var apiBase = window.API_BASE_URL || 'https://latanda.online';
            var response = await fetch(apiBase + '/api/groups/' + groupId + '/distribution/preview', { headers: getAuthHeaders() });
            var result = await response.json();

            if (!result.success) {
                throw new Error(result.error || 'Error al calcular distribucion');
            }

            currentDistributionData = result.data;
            var d = result.data;

            // Update group name
            document.getElementById('distributionGroupName').textContent = d.group_name + ' - Ciclo ' + d.cycle_number;

            // Build the preview HTML
            var html = '';

            // Collection summary
            html += '<div style="background: #f9fafb; border-radius: 12px; padding: 16px; margin-bottom: 16px;">' +
                '<h4 style="margin: 0 0 12px; color: #374151; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px;">Resumen de Recaudacion</h4>' +
                '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">' +
                    '<div><div style="font-size: 0.75rem; color: #6b7280;">Total Recaudado</div><div style="font-size: 1.5rem; font-weight: 700; color: #059669;">L. ' + d.collection.total_collected.toLocaleString('es-HN', {minimumFractionDigits: 2}) + '</div></div>' +
                    '<div><div style="font-size: 0.75rem; color: #6b7280;">Contribuciones</div><div style="font-size: 1.5rem; font-weight: 700; color: #374151;">' + d.collection.total_contributions + '/' + d.collection.expected_contributions + '</div></div>' +
                    '<div><div style="font-size: 0.75rem; color: #6b7280;">Efectivo</div><div style="font-size: 1rem; font-weight: 600; color: #4b5563;">L. ' + d.collection.cash_collected.toLocaleString('es-HN', {minimumFractionDigits: 2}) + '</div></div>' +
                    '<div><div style="font-size: 0.75rem; color: #6b7280;">Transferencias</div><div style="font-size: 1rem; font-weight: 600; color: #4b5563;">L. ' + d.collection.transfer_collected.toLocaleString('es-HN', {minimumFractionDigits: 2}) + '</div></div>' +
                '</div>' +
            '</div>';

            // Fees - Platform gets 10% of coordinator fee
            var isCoordTurn = d.fees.is_coordinator_turn;
            html += '<div style="background: #fef3c7; border-radius: 12px; padding: 16px; margin-bottom: 16px;">' +
                '<h4 style="margin: 0 0 12px; color: #92400e; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px;">Comisiones</h4>' +
                '<div style="display: flex; justify-content: space-between; margin-bottom: 8px;">' +
                    '<span style="color: #78350f;">Plataforma (' + d.fees.platform_rate + '% de comision)</span>' +
                    '<span style="font-weight: 600; color: #92400e;">L. ' + d.fees.platform_fee.toLocaleString('es-HN', {minimumFractionDigits: 2}) + '</span>' +
                '</div>' +
                (isCoordTurn ? '' :
                '<div style="display: flex; justify-content: space-between;">' +
                    '<span style="color: #78350f;">Coordinador (' + d.fees.coordinator_rate + '%)</span>' +
                    '<span style="font-weight: 600; color: #92400e;">L. ' + d.fees.coordinator_fee.toLocaleString('es-HN', {minimumFractionDigits: 2}) + '</span>' +
                '</div>') +
            '</div>';

            // Distribution
            html += '<div style="background: #d1fae5; border-radius: 12px; padding: 16px; margin-bottom: 16px;">' +
                '<h4 style="margin: 0 0 12px; color: #065f46; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px;">Distribucion</h4>' +
                (isCoordTurn ? '' : 
                '<div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border-radius: 8px; margin-bottom: 12px;">' +
                    '<div style="width: 40px; height: 40px; background: #fef3c7; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">👤</div>' +
                    '<div style="flex: 1;">' +
                        '<div style="font-weight: 600; color: #374151;">Coordinador recibe</div>' +
                        '<div style="font-size: 0.75rem; color: #6b7280;">' + d.distribution.coordinator_receives.method + '</div>' +
                    '</div>' +
                    '<div style="font-size: 1.25rem; font-weight: 700; color: #059669;">L. ' + d.distribution.coordinator_receives.net_commission.toLocaleString('es-HN', {minimumFractionDigits: 2}) + '</div>' +
                '</div>') +
                '<div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border-radius: 8px;">' +
                    '<div style="width: 40px; height: 40px; background: #dbeafe; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">' + (isCoordTurn ? '👤' : '🎯') + '</div>' +
                    '<div style="flex: 1;">' +
                        '<div style="font-weight: 600; color: #374151;">' + (d.distribution.beneficiary_receives.user_name || 'Beneficiario') + (isCoordTurn ? ' (Coordinador)' : '') + '</div>' +
                        '<div style="font-size: 0.75rem; color: #6b7280;">' + d.distribution.beneficiary_receives.method + '</div>' +
                    '</div>' +
                    '<div style="font-size: 1.25rem; font-weight: 700; color: #2563eb;">L. ' + d.distribution.beneficiary_receives.amount.toLocaleString('es-HN', {minimumFractionDigits: 2}) + '</div>' +
                '</div>' +
            '</div>';

            // Status
            if (!d.can_distribute) {
                html += '<div style="background: #fee2e2; border-radius: 12px; padding: 16px; color: #dc2626; text-align: center;">' +
                    '<strong>⚠️ No se puede distribuir</strong><br>' +
                    '<span style="font-size: 0.875rem;">Faltan contribuciones por completar</span>' +
                '</div>';
                footerDiv.style.display = 'none';
            } else {
                html += '<div style="background: #d1fae5; border-radius: 12px; padding: 12px; color: #065f46; text-align: center; font-size: 0.875rem;">' +
                    '✅ Todas las contribuciones completadas. Listo para distribuir.' +
                '</div>';
                footerDiv.style.display = 'flex';
                footerDiv.style.justifyContent = 'space-between';
            }

            contentDiv.innerHTML = html;

        } catch (err) {
            contentDiv.innerHTML =
                '<div style="text-align: center; padding: 40px;">' +
                    '<div style="font-size: 48px; margin-bottom: 16px;">❌</div>' +
                    '<h4 style="margin: 0 0 8px; color: #dc2626;">Error al cargar</h4>' +
                    '<p style="color: #6b7280; margin: 0;">' + (err.message || 'Intenta de nuevo') + '</p>' +
                '</div>';
            footerDiv.style.display = 'none';
        }
    }

    window.executeDistribution = async function() {
        if (!currentDistributionData || !currentDistributionData.can_distribute) {
            showWarning('No se puede ejecutar la distribucion');
            return;
        }

        var isCoordTurn = currentDistributionData.fees.is_coordinator_turn;
        var confirmMsg = '¿Confirmas la distribucion del Ciclo ' + currentDistributionData.cycle_number + '?\n\n';
        if (!isCoordTurn) {
            confirmMsg += '• Coordinador recibe: L. ' + currentDistributionData.distribution.coordinator_receives.net_commission.toLocaleString('es-HN', {minimumFractionDigits: 2}) + '\n';
        }
        confirmMsg += '• ' + (currentDistributionData.distribution.beneficiary_receives.user_name || 'Beneficiario') + ' recibe: L. ' + currentDistributionData.distribution.beneficiary_receives.amount.toLocaleString('es-HN', {minimumFractionDigits: 2});

        if (!confirm(confirmMsg)) return;

        var btn = document.getElementById('executeDistributionBtn');
        btn.disabled = true;
        btn.textContent = 'Ejecutando...';

        try {
            var apiBase = window.API_BASE_URL || 'https://latanda.online';
            var userId = localStorage.getItem('latanda_user_id') || 'coordinator';

            var response = await fetch(apiBase + '/api/groups/' + currentDistributionGroupId + '/distribution/execute', {
                method: 'POST',
                headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    executed_by: userId
                })
            });

            var result = await response.json();

            if (!result.success) {
                throw new Error(result.error || 'Error al ejecutar distribucion');
            }

            // Show success
            var contentDiv = document.getElementById('distributionContent');
            contentDiv.innerHTML =
                '<div style="text-align: center; padding: 40px;">' +
                    '<div style="width: 70px; height: 70px; background: #d1fae5; border-radius: 50%; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center;">' +
                        '<svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#059669" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>' +
                    '</div>' +
                    '<h4 style="margin: 0 0 8px; color: #111827; font-size: 1.25rem;">Distribucion Exitosa!</h4>' +
                    '<p style="margin: 0 0 16px; color: #6b7280;">Ciclo ' + result.data.cycle_number + ' completado</p>' +
                    '<div style="background: #f3f4f6; padding: 12px; border-radius: 8px; font-size: 0.875rem; text-align: left;">' +
                        '<div style="margin-bottom: 8px;"><strong>Coordinador:</strong> L. ' + result.data.coordinator_net.toLocaleString('es-HN', {minimumFractionDigits: 2}) + '</div>' +
                        '<div><strong>Beneficiario:</strong> L. ' + result.data.beneficiary_net.toLocaleString('es-HN', {minimumFractionDigits: 2}) + '</div>' +
                    '</div>' +
                    '<p style="margin: 16px 0 0; color: #6b7280; font-size: 0.875rem;">Siguiente ciclo: ' + result.data.next_cycle + '</p>' +
                '</div>';

            var footerDiv = document.getElementById('distributionFooter');
            footerDiv.innerHTML = '<button onclick="closeDistributionModal()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #059669 0%, #10b981 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">Cerrar</button>';

            if (window.showSuccess) window.showSuccess('Distribucion ejecutada exitosamente');

            // Refresh data
            setTimeout(function() {
                if (typeof loadGroupsData === 'function') loadGroupsData();
            }, 2000);

        } catch (err) {
            showError(err.message || 'No se pudo ejecutar la distribucion');
            btn.disabled = false;
            btn.textContent = 'Ejecutar Distribucion';
        }
    };

    window.closeDistributionModal = function() {
        var modal = document.getElementById('distributionModal');
        if (modal) {
            modal.style.display = 'none'; modal.classList.remove('active');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }
        currentDistributionGroupId = null;
        currentDistributionData = null;
    };

})();
</script>

<script src="member-management-frontend.js?v=11.8"></script>
<script src="coordinator-panel.js?v=1766688609"></script>
<script src="lottery-functions.js?v=1765255172"></script>
<script src="disputes-frontend.js?v=1.0"></script>
<script src="coordinator-payouts-view.js"></script>
    <script src="js/components-loader.js?v=30.2"></script>

    <!-- START TANDA MODAL -->
    <div id="startTandaModalOverlay" class="start-tanda-modal-overlay" onclick="if(event.target === this) closeStartTandaModal()">
        <div class="start-tanda-modal">
            <h2><i class="fas fa-play-circle"></i> Iniciar Tanda</h2>
            
            <div class="start-tanda-summary">
                <div class="summary-row">
                    <span>Grupo:</span>
                    <span id="stm-group-name">-</span>
                </div>
                <div class="summary-row">
                    <span>Participantes:</span>
                    <span id="stm-members">-</span>
                </div>
                <div class="summary-row">
                    <span>Aporte:</span>
                    <span id="stm-amount">-</span>
                </div>
                <div class="summary-row">
                    <span>Duracion:</span>
                    <span id="stm-duration">-</span>
                </div>
            </div>

            <div id="stm-lottery-warning" class="lottery-warning-box" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <div>
                    <p><strong>La tombola no ha sido ejecutada.</strong> Se usaran las posiciones actuales de los miembros.</p>
                    <button onclick="executeLotteryFromModal()"><i class="fas fa-dice"></i> Ejecutar Tombola</button>
                </div>
            </div>

            <div class="turns-preview">
                <h4><i class="fas fa-list-ol"></i> Orden de Turnos</h4>
                <ol id="stm-turns-list" class="turns-list"></ol>
            </div>

            <div class="start-options">
                <button class="btn-start-now" onclick="confirmStartTandaNow()">
                    <i class="fas fa-play"></i> Iniciar Ahora
                </button>
                <button class="btn-schedule" onclick="toggleScheduleSection()">
                    <i class="fas fa-calendar-alt"></i> Programar
                </button>
            </div>

            <div id="stm-schedule-section" class="schedule-section">
                <input type="datetime-local" id="stm-start-datetime">
                <button onclick="confirmScheduleTandaStart()"><i class="fas fa-check"></i> Confirmar Fecha</button>
            </div>

            <button class="btn-cancel-modal" onclick="closeStartTandaModal()">Cancelar</button>
        </div>
    </div>

    <script src="js/user-sync.js"></script>
    <script src="js/url-param-handler.js?v=3.4"></script>
    <script src="js/onboarding/onboarding-system.js?v=1.2"></script>
    <script src="pwa-manager.js"></script>
</body>

<!-- FASE 3: Analytics Dashboard System - Added 2025-11-27 -->
<script>
(function() {
    'use strict';
    
    var analyticsLoaded = false;
    var currentAnalyticsGroupId = null;
    
    // Load analytics when tab is switched to analytics
    var originalTabSwitch = window.switchTab;
    window.switchTab = function(tabName) {
        if (originalTabSwitch) originalTabSwitch(tabName);
        
        if (tabName === 'analytics') {
            loadAnalyticsDashboard();
        }
    };
    
    async function loadAnalyticsDashboard() {
        var container = document.getElementById('analyticsContainer');
        if (!container) return;
        
        // Show loading state
        container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner" style="width: 40px; height: 40px; border: 3px solid #e5e7eb; border-top-color: #4f46e5; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div><p style="margin-top: 16px; color: #6b7280;">Cargando estadisticas...</p></div><style>@keyframes spin { to { transform: rotate(360deg); } }</style>';
        
        try {
            // Get user groups first
            var apiBase = window.API_BASE_URL || 'https://latanda.online';
            var userId = getCurrentUserId();
            
            var groupsResponse = await fetch(apiBase + '/api/groups?user_id=' + userId + '&limit=20', { headers: getAuthHeaders() });
            var groupsData = await groupsResponse.json();
            
            if (!groupsData.success || !groupsData.data || groupsData.data.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 60px; color: #6b7280;"><i class="fas fa-chart-pie" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px;"></i><h3 style="color: #374151;">Sin datos disponibles</h3><p>No tienes grupos para mostrar estadisticas</p></div>';
                return;
            }
            
            var groups = groupsData.data;
            
            // Build group selector and stats container
            container.innerHTML = buildAnalyticsUI(groups);
            
            // Load stats for first group
            if (groups.length > 0) {
                loadGroupStats(groups[0].id);
            }
            
        } catch (err) {
            container.innerHTML = '<div style="text-align: center; padding: 60px; color: #dc2626;"><i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i><h3>Error al cargar estadisticas</h3><p>' + (err.message || 'Intenta nuevamente') + '</p></div>';
        }
    }
    
    function buildAnalyticsUI(groups) {
        var options = groups.map(function(g) {
            return '<option value="' + g.id + '">' + g.name + '</option>';
        }).join('');
        
        return '<div style="margin-bottom: 24px;">' +
            '<label style="font-weight: 500; color: #374151; display: block; margin-bottom: 8px;">Seleccionar Grupo:</label>' +
            '<select id="analyticsGroupSelector" onchange="window.loadGroupStats(this.value)" style="width: 100%; max-width: 400px; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 1rem; background: white;">' + options + '</select>' +
        '</div>' +
        '<div id="analyticsStatsContainer">' +
            '<div style="text-align: center; padding: 40px;"><div class="spinner" style="width: 40px; height: 40px; border: 3px solid #e5e7eb; border-top-color: #4f46e5; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div></div>' +
        '</div>';
    }
    
    window.loadGroupStats = async function(groupId) {
        var statsContainer = document.getElementById('analyticsStatsContainer');
        if (!statsContainer) return;
        
        currentAnalyticsGroupId = groupId;
        statsContainer.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner" style="width: 40px; height: 40px; border: 3px solid #e5e7eb; border-top-color: #4f46e5; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div></div>';
        
        try {
            var apiBase = window.API_BASE_URL || 'https://latanda.online';
            var userId = window.currentUserId || ''; var response = await fetch(apiBase + '/api/groups/' + groupId + '/stats?user_id=' + userId, { headers: getAuthHeaders() });
            var data = await response.json();
            
            if (!data.success) {
                throw new Error(data.data?.error?.message || 'Error al cargar stats');
            }
            
            statsContainer.innerHTML = renderStats(data.data);
            
        } catch (err) {
            statsContainer.innerHTML = '<div style="padding: 24px; background: #fee2e2; border-radius: 8px; color: #dc2626;">Error: ' + (err.message || 'No se pudieron cargar las estadisticas') + '</div>';
        }
    };
    
    function renderStats(stats) {
        var group = stats.group || {};
        var members = stats.members || {};
        var payments = stats.payments || {};
        var topContributors = stats.top_contributors || [];
        var tanda = stats.tanda || {};
        var user = stats.user || {};
        var isAdmin = user.is_admin || false;
        
        var frequencyMap = { "weekly": "Semanal", "biweekly": "Quincenal", "monthly": "Mensual" };
        // Stats cards
        var html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">';
        
        // Members card
        html += '<div style="background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%); padding: 20px; border-radius: 12px;">' +
            '<div style="display: flex; align-items: center; gap: 12px;">' +
            '<div style="width: 48px; height: 48px; background: #8b5cf6; border-radius: 12px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-users" style="color: white; font-size: 20px;"></i></div>' +
            '<div><p style="font-size: 0.875rem; color: #6b7280; margin: 0;">Miembros</p><p style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin: 0;">' + (members.total || 0) + '</p></div>' +
            '</div></div>';
        
        // Total Collected card
        html += '<div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 20px; border-radius: 12px;">' +
            '<div style="display: flex; align-items: center; gap: 12px;">' +
            '<div style="width: 48px; height: 48px; background: #10b981; border-radius: 12px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-coins" style="color: white; font-size: 20px;"></i></div>' +
            '<div><p style="font-size: 0.875rem; color: #6b7280; margin: 0;">Recaudado</p><p style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin: 0;">L. ' + (payments.total_collected || 0).toLocaleString() + '</p></div>' +
            '</div></div>';
        
        // Payments card
        html += '<div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 20px; border-radius: 12px;">' +
            '<div style="display: flex; align-items: center; gap: 12px;">' +
            '<div style="width: 48px; height: 48px; background: #3b82f6; border-radius: 12px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-receipt" style="color: white; font-size: 20px;"></i></div>' +
            '<div><p style="font-size: 0.875rem; color: #6b7280; margin: 0;">Pagos</p><p style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin: 0;">' + (payments.completed || 0) + '/' + (payments.total || 0) + '</p></div>' +
            '</div></div>';
        
        // Pending card
        html += '<div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 20px; border-radius: 12px;">' +
            '<div style="display: flex; align-items: center; gap: 12px;">' +
            '<div style="width: 48px; height: 48px; background: #f59e0b; border-radius: 12px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-clock" style="color: white; font-size: 20px;"></i></div>' +
            '<div><p style="font-size: 0.875rem; color: #6b7280; margin: 0;">Pendiente</p><p style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin: 0;">L. ' + (payments.pending_amount || 0).toLocaleString() + '</p></div>' +
            '</div></div>';
        
        html += '</div>';
        
        // Top Contributors section (admin only)
        if (isAdmin && topContributors.length > 0) {
            html += '<div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 24px;">' +
                '<h3 style="font-size: 1.125rem; font-weight: 600; color: #1f2937; margin: 0 0 16px 0;"><i class="fas fa-trophy" style="color: #f59e0b; margin-right: 8px;"></i>Top Contribuyentes</h3>' +
                '<div style="display: flex; flex-direction: column; gap: 12px;">';
            
            topContributors.slice(0, 5).forEach(function(c, i) {
                var medal = i === 0 ? '🥇' : (i === 1 ? '🥈' : (i === 2 ? '🥉' : (i + 1) + '.'));
                html += '<div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #f9fafb; border-radius: 8px;">' +
                    '<div style="display: flex; align-items: center; gap: 12px;">' +
                    '<span style="font-size: 1.25rem;">' + medal + '</span>' +
                    '<div><p style="font-weight: 500; color: #1f2937; margin: 0;">' + (c.name || 'Usuario') + '</p><p style="font-size: 0.75rem; color: #6b7280; margin: 0;">' + c.payment_count + ' pagos</p></div>' +
                    '</div>' +
                    '<p style="font-weight: 600; color: #10b981; margin: 0;">L. ' + (c.total || 0).toLocaleString() + '</p>' +
                    '</div>';
            });
            
            html += '</div></div>';
        }
        
        // Group Info
        html += '<div style="background: #f9fafb; border-radius: 12px; padding: 20px;">' +
            '<h3 style="font-size: 1rem; font-weight: 600; color: #6b7280; margin: 0 0 12px 0;">Info del Grupo</h3>' +
            '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">' +
            '<div><p style="font-size: 0.75rem; color: #9ca3af; margin: 0;">Nombre</p><p style="font-weight: 500; color: #1f2937; margin: 0;">' + (group.name || '-') + '</p></div>' +
            '<div><p style="font-size: 0.75rem; color: #9ca3af; margin: 0;">Contribucion</p><p style="font-weight: 500; color: #1f2937; margin: 0;">L. ' + (group.contribution_amount || 0).toLocaleString() + '</p></div>' +
            '<div><p style="font-size: 0.75rem; color: #9ca3af; margin: 0;">Frecuencia</p><p style="font-weight: 500; color: #1f2937; margin: 0;">' + (frequencyMap[group.frequency] || group.frequency || '-') + '</p></div>' +
            '<div><p style="font-size: 0.75rem; color: #9ca3af; margin: 0;">Estado</p><p style="font-weight: 500; color: #1f2937; margin: 0;">' + (group.status || '-') + '</p></div>' +
            '</div></div>';
        
        // Monthly Progress Chart (only for admins with data)
        var monthly = stats.monthly || [];
        if (isAdmin && monthly.length > 0) {
            var maxAmount = Math.max.apply(null, monthly.map(function(m) { return m.amount; })) || 1;
            html += '<div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 24px;">' +
                '<h3 style="font-size: 1rem; font-weight: 600; color: #1f2937; margin: 0 0 16px 0;"><i class="fas fa-chart-bar" style="color: #3b82f6; margin-right: 8px;"></i>Progreso Mensual</h3>' +
                '<div style="display: flex; align-items: flex-end; gap: 8px; height: 150px;">';
            
            monthly.slice(0, 6).reverse().forEach(function(m) {
                var heightPct = Math.round((m.amount / maxAmount) * 100);
                var monthLabel = m.month.split('-')[1];
                var monthNames = { '01': 'Ene', '02': 'Feb', '03': 'Mar', '04': 'Abr', '05': 'May', '06': 'Jun', '07': 'Jul', '08': 'Ago', '09': 'Sep', '10': 'Oct', '11': 'Nov', '12': 'Dic' };
                html += '<div style="flex: 1; display: flex; flex-direction: column; align-items: center;">' +
                    '<div style="width: 100%; background: linear-gradient(180deg, #3b82f6 0%, #1d4ed8 100%); border-radius: 4px 4px 0 0; height: ' + heightPct + '%; min-height: 10px; transition: height 0.3s;"></div>' +
                    '<p style="font-size: 0.7rem; color: #6b7280; margin: 4px 0 0 0;">' + (monthNames[monthLabel] || monthLabel) + '</p>' +
                    '<p style="font-size: 0.65rem; color: #9ca3af; margin: 0;">L.' + (m.amount / 1000).toFixed(1) + 'K</p>' +
                    '</div>';
            });
            
            html += '</div></div>';
        }
        
        // Tanda Info Section (only if tanda exists)
        if (tanda && tanda.tanda_id) {
            var statusColors = { 'recruiting': '#f59e0b', 'pending': '#6b7280', 'active': '#10b981', 'completed': '#3b82f6', 'paused': '#ef4444' };
            var statusLabels = { 'recruiting': 'Reclutando', 'pending': 'Pendiente', 'active': 'Activa', 'completed': 'Completada', 'paused': 'Pausada' };
            html += '<div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 12px; padding: 20px; margin-top: 16px;">' +
                '<h3 style="font-size: 1rem; font-weight: 600; color: #166534; margin: 0 0 12px 0;"><i class="fas fa-sync-alt" style="margin-right: 8px;"></i>Estado de la Tanda</h3>' +
                '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">' +
                '<div><p style="font-size: 0.75rem; color: #166534; margin: 0;">Estado</p><p style="font-weight: 600; color: ' + (statusColors[tanda.status] || '#6b7280') + '; margin: 0;">' + (statusLabels[tanda.status] || tanda.status) + '</p></div>' +
                '<div><p style="font-size: 0.75rem; color: #166534; margin: 0;">Turno Actual</p><p style="font-weight: 500; color: #1f2937; margin: 0;">' + (tanda.current_turn || 0) + ' / ' + (tanda.total_turns || 0) + '</p></div>' +
                '</div></div>';
        }
        
        // User Position Info (for members)
        if (user && user.user_id) {
            var roleLabels = { 'creator': 'Creador', 'coordinator': 'Coordinador', 'admin': 'Admin', 'member': 'Miembro' };
            html += '<div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 12px; padding: 16px; margin-top: 16px; display: flex; align-items: center; justify-content: space-between;">' +
                '<div style="display: flex; align-items: center; gap: 12px;">' +
                '<div style="width: 40px; height: 40px; background: #3b82f6; border-radius: 50%; display: flex; align-items: center; justify-content: center;"><i class="fas fa-user" style="color: white;"></i></div>' +
                '<div><p style="font-size: 0.875rem; font-weight: 500; color: #1e40af; margin: 0;">Tu rol: ' + (roleLabels[user.role] || user.role || 'Miembro') + '</p>' +
                (user.turn_position ? '<p style="font-size: 0.75rem; color: #3b82f6; margin: 0;">Posicion de turno: #' + user.turn_position + '</p>' : '') +
                '</div></div>' +
                (isAdmin ? '<span style="background: #4f46e5; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 500;"><i class="fas fa-shield-alt" style="margin-right: 4px;"></i>Admin</span>' : '') +
                '</div>';
        }
        
        return html;
    }
    
    // Expose function globally
    window.loadAnalyticsDashboard = loadAnalyticsDashboard;
    
})();
</script>

<!-- FASE 4: Calendar Modal System - Added 2025-11-27 -->
<script>
(function() {
    'use strict';
    
    // Add Calendar button to admin modal
    var originalManageGroup = window.manageGroup;
    var calendarButtonAdded = {};
    
    window.manageGroup = function(groupId) {
        originalManageGroup(groupId);
        
        setTimeout(function() {
            var modal = document.getElementById('groupManageModal');
            if (!modal) return;
            
            // Check if calendar button already exists
            if (calendarButtonAdded[groupId]) return;
            
            var exportSection = modal.querySelector('.export-section');
            if (!exportSection) return;
            
            // Create calendar button before export section
            var calendarBtn = document.createElement('button');
            calendarBtn.className = 'admin-option-btn';
            calendarBtn.style.cssText = 'display: flex; align-items: center; gap: 12px; width: 100%; padding: 14px 16px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: all 0.2s; margin-bottom: 8px;';
            calendarBtn.innerHTML = '<div style="width: 40px; height: 40px; background: #fef3c7; border-radius: 10px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-calendar-alt" style="color: #d97706; font-size: 18px;"></i></div><div style="text-align: left;"><div style="font-weight: 500; color: #111827;">Calendario de Pagos</div><div style="font-size: 0.75rem; color: #6b7280;">Ver proximas fechas y turnos</div></div>';
            
            calendarBtn.onclick = function() {
                showCalendarModal(window.currentManagedGroupId);
            };
            
            // Insert before export section
            exportSection.parentNode.insertBefore(calendarBtn, exportSection);
            calendarButtonAdded[groupId] = true;
            
        }, 100);
    };
    
    window.showCalendarModal = async function(groupId) {
        // Close admin modal first
        closeModal();
        
        // Create or get calendar modal
        var modal = document.getElementById('calendarModal');
        if (!modal) {
            modal = createCalendarModal();
        }
        
        // Show loading state
        document.getElementById('calendarContent').innerHTML = '<div style="text-align: center; padding: 60px;"><div class="spinner" style="width: 40px; height: 40px; border: 3px solid #e5e7eb; border-top-color: #4f46e5; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div><p style="margin-top: 16px; color: #6b7280;">Cargando calendario...</p></div>';
        
        // Show modal
        modal.style.display = 'flex'; modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // Load calendar data
        try {
            var apiBase = window.API_BASE_URL || 'https://latanda.online';
            var response = await fetch(apiBase + '/api/groups/' + groupId + '/calendar', { headers: getAuthHeaders() });
            var data = await response.json();
            
            if (!data.success) {
                throw new Error(data.data?.error?.message || 'Error al cargar calendario');
            }
            
            document.getElementById('calendarModalTitle').textContent = data.data.group?.name || 'Calendario';
            document.getElementById('calendarContent').innerHTML = renderCalendar(data.data);
            
        } catch (err) {
            document.getElementById('calendarContent').innerHTML = '<div style="padding: 24px; background: #fee2e2; border-radius: 8px; color: #dc2626; text-align: center;"><i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 12px;"></i><p>' + (err.message || 'No se pudo cargar el calendario') + '</p></div>';
        }
    };
    
    function createCalendarModal() {
        var modal = document.createElement('div');
        modal.id = 'calendarModal';
        modal.className = 'modal-overlay';
        modal.style.cssText = 'display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 10000;';
        modal.innerHTML = '<div class="modal-content" style="background: white; border-radius: 16px; max-width: 600px; width: 90%; max-height: 85vh; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">' +
            '<div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 20px; border-radius: 16px 16px 0 0; position: relative;">' +
            '<div style="display: flex; align-items: center; gap: 12px;">' +
            '<div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 12px;"><i class="fas fa-calendar-alt" style="font-size: 24px;"></i></div>' +
            '<div><h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">Calendario de Pagos</h3><p id="calendarModalTitle" style="margin: 4px 0 0; font-size: 0.875rem; opacity: 0.9;">Grupo</p></div>' +
            '</div>' +
            '<button onclick="closeCalendarModal()" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; color: white; cursor: pointer;"><i class="fas fa-times"></i></button>' +
            '</div>' +
            '<div id="calendarContent" class="modal-body" style="padding: 20px; max-height: 60vh; overflow-y: auto;"></div>' +
            '</div>';
        
        modal.onclick = function(e) {
            if (e.target === modal) closeCalendarModal();
        };
        
        document.body.appendChild(modal);
        return modal;
    }
    
    window.closeCalendarModal = function() {
        var modal = document.getElementById('calendarModal');
        if (modal) {
            modal.style.display = 'none'; modal.classList.remove('active');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }
    };
    
    function renderCalendar(data) {
        var schedule = data.schedule || [];
        var group = data.group || {};
        
        var html = '';
        
        // Group info header
        html += '<div style="background: #f9fafb; border-radius: 12px; padding: 16px; margin-bottom: 20px;">' +
            '<div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 12px;">' +
            '<div><span style="font-size: 0.75rem; color: #6b7280;">Frecuencia</span><p style="font-weight: 600; color: #1f2937; margin: 0; text-transform: capitalize;">' + (group.frequency || '-') + '</p></div>' +
            '<div><span style="font-size: 0.75rem; color: #6b7280;">Contribucion</span><p style="font-weight: 600; color: #1f2937; margin: 0;">L. ' + (group.contribution_amount || 0).toLocaleString() + '</p></div>' +
            '<div><span style="font-size: 0.75rem; color: #6b7280;">Miembros</span><p style="font-weight: 600; color: #1f2937; margin: 0;">' + (data.total_members || 0) + '</p></div>' +
            '</div></div>';
        
        // Schedule timeline
        if (schedule.length > 0) {
            html += '<h4 style="font-size: 1rem; font-weight: 600; color: #374151; margin: 0 0 16px 0;"><i class="fas fa-clock" style="color: #f59e0b; margin-right: 8px;"></i>Proximos Turnos</h4>';
            html += '<div style="display: flex; flex-direction: column; gap: 12px;">';
            
            schedule.forEach(function(item) {
                var isCurrent = item.status === 'current';
                var borderColor = isCurrent ? '#f59e0b' : '#e5e7eb';
                var bgColor = isCurrent ? '#fffbeb' : '#ffffff';
                var dateObj = new Date(item.date + 'T12:00:00');
                var formattedDate = dateObj.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
                
                html += '<div style="display: flex; gap: 16px; padding: 16px; background: ' + bgColor + '; border: 2px solid ' + borderColor + '; border-radius: 12px;">' +
                    '<div style="min-width: 50px; text-align: center;">' +
                    '<div style="font-size: 1.5rem; font-weight: 700; color: ' + (isCurrent ? '#f59e0b' : '#6b7280') + ';">#' + item.position + '</div>' +
                    '</div>' +
                    '<div style="flex: 1;">' +
                    '<div style="display: flex; justify-content: space-between; align-items: start;">' +
                    '<div><p style="font-weight: 500; color: #1f2937; margin: 0;">' + (item.beneficiary?.name || 'Sin asignar') + '</p>' +
                    '<p style="font-size: 0.875rem; color: #6b7280; margin: 4px 0 0;">' + formattedDate + '</p></div>' +
                    '<div style="text-align: right;"><p style="font-weight: 600; color: #10b981; margin: 0;">L. ' + item.amount.toLocaleString() + '</p>' +
                    (isCurrent ? '<span style="display: inline-block; padding: 2px 8px; background: #f59e0b; color: white; border-radius: 4px; font-size: 0.625rem; font-weight: 500; margin-top: 4px;">TURNO ACTUAL</span>' : '') +
                    '</div></div></div></div>';
            });
            
            html += '</div>';
        } else {
            html += '<div style="text-align: center; padding: 40px; color: #6b7280;"><i class="fas fa-calendar-times" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px;"></i><p>No hay turnos programados</p></div>';
        }
        
        return html;
    }
    
})();
</script>

<!-- FASE 5: Enhanced View Details Modal - Added 2025-11-27 -->
<script>
(function() {
    'use strict';
    
    // Override viewGroup to show modal popup instead of switching tabs
    window.viewGroup = async function(groupId) {
        
        // Create or get modal
        var modal = document.getElementById('viewDetailsModal');
        if (!modal) {
            modal = createViewDetailsModal();
        }
        
        // Show loading
        document.getElementById('viewDetailsContent').innerHTML = '<div style="text-align: center; padding: 60px;"><div class="spinner" style="width: 40px; height: 40px; border: 3px solid #e5e7eb; border-top-color: #4f46e5; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div><p style="margin-top: 16px; color: #6b7280;">Cargando detalles...</p></div>';
        
        // Show modal
        modal.style.display = 'flex'; modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        try {
            var apiBase = window.API_BASE_URL || 'https://latanda.online';
            
            // Fetch group stats
            var statsResponse = await fetch(apiBase + '/api/groups/' + groupId + '/stats', { headers: getAuthHeaders() });
            var statsData = await statsResponse.json();
            
            if (!statsData.success) {
                throw new Error(statsData.data?.error?.message || 'Error al cargar datos');
            }
            
            document.getElementById('viewDetailsModalTitle').textContent = statsData.data.group?.name || 'Detalles del Grupo';
            document.getElementById('viewDetailsContent').innerHTML = renderGroupDetails(statsData.data, groupId);
            
        } catch (err) {
            document.getElementById('viewDetailsContent').innerHTML = '<div style="padding: 24px; background: #fee2e2; border-radius: 8px; color: #dc2626; text-align: center;"><i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 12px;"></i><p>' + (err.message || 'No se pudieron cargar los detalles') + '</p></div>';
        }
    };
    
    function createViewDetailsModal() {
        var modal = document.createElement('div');
        modal.id = 'viewDetailsModal';
        modal.className = 'modal-overlay';
        modal.style.cssText = 'display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 10000;';
        modal.innerHTML = '<div class="modal-content" style="background: white; border-radius: 16px; max-width: 700px; width: 95%; max-height: 90vh; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);">' +
            '<div class="modal-header" style="background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%); color: white; padding: 20px; border-radius: 16px 16px 0 0; position: relative;">' +
            '<div style="display: flex; align-items: center; gap: 12px;">' +
            '<div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 12px;"><i class="fas fa-users" style="font-size: 24px;"></i></div>' +
            '<div><h3 style="margin: 0; font-size: 1.25rem; font-weight: 600;">Detalles del Grupo</h3><p id="viewDetailsModalTitle" style="margin: 4px 0 0; font-size: 0.875rem; opacity: 0.9;">Grupo</p></div>' +
            '</div>' +
            '<button onclick="closeViewDetailsModal()" style="position: absolute; top: 16px; right: 16px; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; color: white; cursor: pointer;"><i class="fas fa-times"></i></button>' +
            '</div>' +
            '<div id="viewDetailsContent" class="modal-body" style="padding: 20px; max-height: 70vh; overflow-y: auto;"></div>' +
            '</div>';
        
        modal.onclick = function(e) {
            if (e.target === modal) closeViewDetailsModal();
        };
        
        document.body.appendChild(modal);
        return modal;
    }
    
    window.closeViewDetailsModal = function() {
        var modal = document.getElementById('viewDetailsModal');
        if (modal) {
            modal.style.display = 'none'; modal.classList.remove('active');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }
    };
    
    function renderGroupDetails(stats, groupId) {
        var frequencyMap = { 'weekly': 'Semanal', 'biweekly': 'Quincenal', 'monthly': 'Mensual' };
        var group = stats.group || {};
        var members = stats.members || {};
        var payments = stats.payments || {};
        var topContributors = stats.top_contributors || [];
        
        var html = '';
        
        // Quick stats row
        html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">';
        
        // Members
        html += '<div style="text-align: center; padding: 16px; background: #ede9fe; border-radius: 12px;">' +
            '<i class="fas fa-users" style="font-size: 24px; color: #7c3aed;"></i>' +
            '<p style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin: 8px 0 0;">' + (members.total || 0) + '</p>' +
            '<p style="font-size: 0.75rem; color: #6b7280; margin: 0;">Miembros</p></div>';
        
        // Collected
        html += '<div style="text-align: center; padding: 16px; background: #d1fae5; border-radius: 12px;">' +
            '<i class="fas fa-coins" style="font-size: 24px; color: #10b981;"></i>' +
            '<p style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin: 8px 0 0;">L. ' + (payments.total_collected || 0).toLocaleString() + '</p>' +
            '<p style="font-size: 0.75rem; color: #6b7280; margin: 0;">Recaudado</p></div>';
        
        // Payments
        html += '<div style="text-align: center; padding: 16px; background: #dbeafe; border-radius: 12px;">' +
            '<i class="fas fa-check-circle" style="font-size: 24px; color: #3b82f6;"></i>' +
            '<p style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin: 8px 0 0;">' + (payments.completed || 0) + '</p>' +
            '<p style="font-size: 0.75rem; color: #6b7280; margin: 0;">Pagos</p></div>';
        
        // Status
        var statusColor = group.status === 'active' ? '#10b981' : '#f59e0b';
        html += '<div style="text-align: center; padding: 16px; background: #f3f4f6; border-radius: 12px;">' +
            '<i class="fas fa-circle" style="font-size: 24px; color: ' + statusColor + ';"></i>' +
            '<p style="font-size: 1rem; font-weight: 600; color: #1f2937; margin: 8px 0 0; text-transform: capitalize;">' + (group.status || '-') + '</p>' +
            '<p style="font-size: 0.75rem; color: #6b7280; margin: 0;">Estado</p></div>';
        
        html += '</div>';
        
        // Group info
        html += '<div style="background: #f9fafb; border-radius: 12px; padding: 16px; margin-bottom: 20px;">' +
            '<h4 style="font-size: 0.875rem; font-weight: 600; color: #6b7280; margin: 0 0 12px 0; text-transform: uppercase;">Informacion del Grupo</h4>' +
            '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">' +
            '<div><span style="font-size: 0.75rem; color: #9ca3af;">Contribucion</span><p style="font-weight: 600; color: #1f2937; margin: 0;">L. ' + (group.contribution_amount || 0).toLocaleString() + '</p></div>' +
            '<div><span style="font-size: 0.75rem; color: #9ca3af;">Frecuencia</span><p style="font-weight: 600; color: #1f2937; margin: 0; text-transform: capitalize;">' + (frequencyMap[group.frequency] || group.frequency || '-') + '</p></div>' +
            '</div></div>';
        
        // Top contributors
        if (topContributors.length > 0) {
            html += '<div style="margin-bottom: 20px;">' +
                '<h4 style="font-size: 0.875rem; font-weight: 600; color: #6b7280; margin: 0 0 12px 0; text-transform: uppercase;"><i class="fas fa-trophy" style="color: #f59e0b; margin-right: 6px;"></i>Top Contribuyentes</h4>' +
                '<div style="display: flex; flex-direction: column; gap: 8px;">';
            
            topContributors.slice(0, 3).forEach(function(c, i) {
                var medal = i === 0 ? '🥇' : (i === 1 ? '🥈' : '🥉');
                html += '<div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: white; border: 1px solid #e5e7eb; border-radius: 8px;">' +
                    '<div style="display: flex; align-items: center; gap: 10px;">' +
                    '<span style="font-size: 1.25rem;">' + medal + '</span>' +
                    '<span style="font-weight: 500; color: #1f2937;">' + (c.name || 'Usuario') + '</span></div>' +
                    '<span style="font-weight: 600; color: #10b981;">L. ' + (c.total || 0).toLocaleString() + '</span></div>';
            });
            
            html += '</div></div>';
        }
        
        // Quick actions
        html += '<div style="border-top: 1px solid #e5e7eb; padding-top: 16px;">' +
            '<h4 style="font-size: 0.875rem; font-weight: 600; color: #6b7280; margin: 0 0 12px 0; text-transform: uppercase;">Acciones Rapidas</h4>' +
            '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">' +
            '<button onclick="closeViewDetailsModal(); manageGroup(\'' + groupId + '\');" style="padding: 12px; background: #4f46e5; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;"><i class="fas fa-cog" style="margin-right: 6px;"></i>Administrar</button>' +
            '<button onclick="closeViewDetailsModal(); showCalendarModal(\'' + groupId + '\');" style="padding: 12px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;"><i class="fas fa-calendar" style="margin-right: 6px;"></i>Calendario</button>' +
            '<button onclick="closeViewDetailsModal(); switchTab(\'tandas\'); sessionStorage.setItem(\'selected_group_id\', \'' + groupId + '\');" style="padding: 12px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;"><i class="fas fa-list" style="margin-right: 6px;"></i>Ver Tandas</button>' +
            '</div></div>';
        
        return html;
    }
    
})();
</script>

<!-- MATCHING SYSTEM - Added 2025-12-03 - Uses PostgreSQL -->
<script>
(function() {
    'use strict';

    // Load matching when tab is switched
    var origTabSwitch = window.switchTab;
    window.switchTab = function(tabName) {
        if (tabName === 'matching') {
            // Bypass integration.js para matching - usar nuevo sistema PostgreSQL directamente
            loadMatchingTab();
            // Cambiar clases de tabs manualmente
            document.querySelectorAll('.nav-tab').forEach(function(t) { t.classList.remove('active'); });
            var matchingTab = document.querySelector('[data-tab="matching"]');
            if (matchingTab) matchingTab.classList.add('active');
            document.querySelectorAll('.content-section').forEach(function(s) { s.classList.remove('active'); });
            var matchingSection = document.getElementById('matching');
            if (matchingSection) matchingSection.classList.add('active');
            return; // No pasar por integration.js
        }
        if (origTabSwitch) origTabSwitch(tabName);
    };

    async function loadMatchingTab() {
        var container = document.getElementById('matchingContainer');
        if (!container) return;

        // Show loading
        container.innerHTML = '<div style="text-align: center; padding: 60px;"><div class="spinner" style="width: 50px; height: 50px; border: 4px solid #e5e7eb; border-top-color: #8b5cf6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div><p style="margin-top: 20px; color: #6b7280;">Buscando grupos disponibles...</p></div><style>@keyframes spin { to { transform: rotate(360deg); } }</style>';

        try {
            var apiBase = window.API_BASE_URL || 'https://latanda.online';
            var userId = getCurrentUserId();

            // Get pending requests AND public groups in parallel
            var [pendingResp, publicResp] = await Promise.all([
                fetch(apiBase + '/api/groups/my-pending-requests?user_id=' + userId, { headers: getAuthHeaders() }),
                fetch(apiBase + '/api/groups/public-pg?user_id=' + userId, { headers: getAuthHeaders() })
            ]);

            var pendingData = await pendingResp.json();
            var publicData = await publicResp.json();

            var pendingRequests = pendingData.data?.requests || [];
            var availableGroups = publicData.data?.groups || [];

            var html = '';

            // Show pending requests first
            if (pendingRequests.length > 0) {
                html += renderPendingRequests(pendingRequests);
            }

            // Then show available groups
            if (availableGroups.length === 0 && pendingRequests.length === 0) {
                html += renderEmptyState();
            } else if (availableGroups.length > 0) {
                html += renderMatchingUI(availableGroups);
            }

            container.innerHTML = html;

        } catch (err) {
            container.innerHTML = '<div style="text-align: center; padding: 60px; color: #dc2626;"><i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i><h3>Error al cargar grupos</h3><p>' + (err.message || 'Intenta nuevamente') + '</p></div>';
        }
    }

    function renderPendingRequests(requests) {
        var frequencyMap = { weekly: 'Semanal', biweekly: 'Quincenal', monthly: 'Mensual' };

        var html = '<div style="margin-bottom: 32px;">' +
            '<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">' +
            '<div style="width: 40px; height: 40px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center;">' +
            '<i class="fas fa-clock" style="color: white; font-size: 18px;"></i></div>' +
            '<div><h3 style="margin: 0; font-size: 1.125rem; font-weight: 600; color: #1f2937;">Mis Solicitudes Pendientes</h3>' +
            '<p style="margin: 0; font-size: 0.875rem; color: #6b7280;">' + requests.length + ' solicitud(es) esperando aprobación</p></div></div>';

        html += '<div style="display: grid; gap: 12px;">';

        requests.forEach(function(req) {
            var contribution = parseFloat(req.contribution_amount) || 0;
            var requestDate = new Date(req.requested_at).toLocaleDateString('es-HN', { day: 'numeric', month: 'short', year: 'numeric' });

            html += '<div style="background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border: 1px solid #fcd34d; border-radius: 12px; padding: 16px;">' +
                '<div style="display: flex; justify-content: space-between; align-items: start;">' +
                '<div style="flex: 1;">' +
                '<h4 style="margin: 0 0 4px 0; font-size: 1rem; font-weight: 600; color: #92400e;">' + (req.group_name || 'Grupo') + '</h4>' +
                '<div style="display: flex; gap: 16px; font-size: 0.8rem; color: #b45309;">' +
                '<span><i class="fas fa-coins" style="margin-right: 4px;"></i>L. ' + contribution.toLocaleString() + '</span>' +
                '<span><i class="fas fa-sync-alt" style="margin-right: 4px;"></i>' + (frequencyMap[req.frequency] || req.frequency) + '</span>' +
                '<span><i class="fas fa-users" style="margin-right: 4px;"></i>' + req.member_count + '/' + req.max_members + '</span>' +
                '</div>' +
                '<p style="margin: 8px 0 0; font-size: 0.75rem; color: #b45309;"><i class="fas fa-user-shield" style="margin-right: 4px;"></i>Admin: ' + (req.admin_name || 'N/A') + '</p>' +
                '</div>' +
                '<div style="text-align: right;">' +
                '<span style="display: inline-flex; align-items: center; gap: 6px; background: #fef3c7; border: 1px solid #fcd34d; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; color: #92400e;">' +
                '<i class="fas fa-hourglass-half"></i>Pendiente</span>' +
                '<p style="margin: 8px 0 0; font-size: 0.7rem; color: #b45309;">Enviada: ' + requestDate + '</p>' +
                '</div></div></div>';
        });

        html += '</div></div>';

        // Add separator if there will be more content
        html += '<div style="border-bottom: 1px solid #e5e7eb; margin-bottom: 24px;"></div>';

        return html;
    }
    function renderEmptyState() {
        return '<div style="text-align: center; padding: 60px;">' +
            '<div style="width: 120px; height: 120px; background: linear-gradient(135deg, #ede9fe 0%, #ddd6fe 100%); border-radius: 50%; margin: 0 auto 24px; display: flex; align-items: center; justify-content: center;">' +
            '<i class="fas fa-users" style="font-size: 48px; color: #8b5cf6;"></i></div>' +
            '<h3 style="font-size: 1.5rem; font-weight: 600; color: #1f2937; margin-bottom: 12px;">No hay grupos disponibles</h3>' +
            '<p style="color: #6b7280; max-width: 400px; margin: 0 auto 24px;">Actualmente no hay grupos publicos con espacio disponible. Puedes crear tu propio grupo o esperar a que se abran nuevas oportunidades.</p>' +
            '<button onclick="window.switchTab(\'create\')" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; padding: 14px 28px; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 1rem;">' +
            '<i class="fas fa-plus" style="margin-right: 8px;"></i>Crear mi Grupo</button></div>';
    }

    function renderMatchingUI(groups) {
        var frequencyMap = { weekly: 'Semanal', biweekly: 'Quincenal', monthly: 'Mensual' };

        // Store groups for filtering
        window.allMatchingGroups = groups;
        
        var html = '<div style="margin-bottom: 24px;">' +
            '<p style="color: #6b7280; margin-bottom: 16px;">Encontramos <strong>' + groups.length + '</strong> grupo(s) donde puedes unirte:</p>' +
            '<div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center;">' +
            '<select id="matchingFrequencyFilter" onchange="window.filterMatchingGroups()" style="padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.875rem; background: white;">' +
            '<option value="">Todas las frecuencias</option>' +
            '<option value="weekly">Semanal</option>' +
            '<option value="biweekly">Quincenal</option>' +
            '<option value="monthly">Mensual</option></select>' +
            '<select id="matchingContribFilter" onchange="window.filterMatchingGroups()" style="padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.875rem; background: white;">' +
            '<option value="">Cualquier contribución</option>' +
            '<option value="0-500">L. 0 - 500</option>' +
            '<option value="501-1000">L. 501 - 1,000</option>' +
            '<option value="1001-2000">L. 1,001 - 2,000</option>' +
            '<option value="2001+">L. 2,001+</option></select>' +
            '<button onclick="window.clearMatchingFilters()" style="padding: 8px 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.875rem; background: #f9fafb; cursor: pointer;"><i class="fas fa-times" style="margin-right: 4px;"></i>Limpiar</button>' +
            '</div></div>';

        html += '<div style="display: grid; gap: 16px;">';

        groups.forEach(function(group) {
            var maxMem = group.max_members || 10;
            var memCount = group.member_count || 0;
            var spotsLeft = maxMem - memCount;
            var progress = Math.round((memCount / maxMem) * 100);
            var escapedName = (group.name || 'Grupo').replace(/'/g, "\\'").replace(/"/g, '');
            var contribution = parseFloat(group.contribution_amount) || 0;
            var desc = group.description || '';
            var truncDesc = desc.length > 100 ? desc.substring(0, 100) + '...' : desc;

            html += '<div style="background: white; border: 1px solid #e5e7eb; border-radius: 16px; overflow: hidden; transition: all 0.2s;" class="matching-card">' +
                '<div style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); padding: 16px 20px; color: white;">' +
                '<div style="display: flex; justify-content: space-between; align-items: center;">' +
                '<h3 style="font-size: 1.125rem; font-weight: 600; margin: 0;">' + (group.name || 'Grupo') + '</h3>' +
                (memCount >= maxMem ? '<span style="background: #10b981; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; margin-right: 8px;">🎯 Meta alcanzada</span>' : '') + '<span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 0.75rem;">' + (frequencyMap[group.frequency] || group.frequency || 'Mensual') + '</span></div></div>' +
                '<div style="padding: 12px 20px; background: #f9fafb; border-bottom: 1px solid #e5e7eb;">' +
                '<div style="display: flex; justify-content: space-between; font-size: 0.875rem;">' +
                '<span style="color: #6b7280;"><i class="fas fa-user-shield" style="margin-right: 6px;"></i>' + (group.admin_name || 'Admin') + '</span>' +
                '<span style="color: #6b7280;"><i class="fas fa-map-marker-alt" style="margin-right: 6px;"></i>' + (group.location || 'Honduras') + '</span></div>' +
                (truncDesc ? '<p style="margin: 8px 0 0; font-size: 0.8rem; color: #9ca3af;">' + truncDesc + '</p>' : '') + '</div>' +
                '<div style="padding: 20px;">' +
                '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 16px;">' +
                '<div style="text-align: center;">' +
                '<p style="font-size: 0.75rem; color: #9ca3af; margin: 0 0 4px 0;">Contribucion</p>' +
                '<p style="font-size: 1.25rem; font-weight: 700; color: #10b981; margin: 0;">L. ' + contribution.toLocaleString() + '</p></div>' +
                '<div style="text-align: center;">' +
                '<p style="font-size: 0.75rem; color: #9ca3af; margin: 0 0 4px 0;">Miembros</p>' +
                '<p style="font-size: 1.25rem; font-weight: 700; color: #1f2937; margin: 0;">' + memCount + '/' + maxMem + '</p></div>' +
                '<div style="text-align: center;">' +
                '<p style="font-size: 0.75rem; color: #9ca3af; margin: 0 0 4px 0;">Disponibles</p>' +
                '<p style="font-size: 1.25rem; font-weight: 700; color: #f59e0b; margin: 0;">' + spotsLeft + ' lugares</p></div></div>' +
                '<div style="background: #f3f4f6; border-radius: 8px; height: 8px; overflow: hidden; margin-bottom: 16px;">' +
                '<div style="background: linear-gradient(90deg, #10b981, #34d399); height: 100%; width: ' + progress + '%;"></div></div>' +
                '<button onclick="window.requestJoinGroup(\'' + group.id + '\', \'' + escapedName + '\')" style="width: 100%; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 14px; border-radius: 10px; font-weight: 600; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 8px;">' +
                '<i class="fas fa-user-plus"></i>Solicitar Unirme</button></div></div>';
        });

        html += '</div>';
        html += `<style>.matching-card:hover { box-shadow: 0 8px 25px rgba(0,0,0,0.1); transform: translateY(-2px); }
    /* ===== LOTTERY ANIMATION STYLES ===== */
    .lottery-animation-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(10px);
        z-index: 20000;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: all 0.5s ease;
    }

    .lottery-animation-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .lottery-container {
        text-align: center;
        color: white;
        max-width: 600px;
        padding: 2rem;
    }

    .lottery-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
        background: linear-gradient(135deg, #00d4ff, #7c3aed);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: pulse 1.5s ease-in-out infinite;
    }

    .lottery-wheel {
        width: 300px;
        height: 300px;
        margin: 2rem auto;
        position: relative;
    }

    .lottery-wheel-inner {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: conic-gradient(
            #f59e0b 0deg 60deg,
            #10b981 60deg 120deg,
            #3b82f6 120deg 180deg,
            #ec4899 180deg 240deg,
            #8b5cf6 240deg 300deg,
            #06b6d4 300deg 360deg
        );
        animation: spin 3s ease-out forwards;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 50px rgba(0, 212, 255, 0.5);
    }

    .lottery-wheel-center {
        width: 80px;
        height: 80px;
        background: #1e293b;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        border: 4px solid #00d4ff;
    }

    .lottery-pointer {
        position: absolute;
        top: -20px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 20px solid transparent;
        border-right: 20px solid transparent;
        border-top: 40px solid #00d4ff;
        filter: drop-shadow(0 0 10px rgba(0, 212, 255, 0.8));
    }

    .lottery-members {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 1rem;
        margin-top: 2rem;
    }

    .lottery-member {
        background: rgba(255, 255, 255, 0.1);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        opacity: 0.5;
        transition: all 0.3s ease;
    }

    .lottery-member.assigned {
        background: linear-gradient(135deg, #10b981, #059669);
        opacity: 1;
        transform: scale(1.1);
        box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
    }

    .lottery-member .turn-number {
        background: rgba(0, 0, 0, 0.3);
        padding: 2px 8px;
        border-radius: 10px;
        margin-left: 8px;
        font-weight: bold;
    }

    .lottery-results {
        margin-top: 2rem;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.5s ease;
    }

    .lottery-results.show {
        opacity: 1;
        transform: translateY(0);
    }

    .lottery-results h4 {
        color: #10b981;
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }

    .lottery-your-turn {
        background: linear-gradient(135deg, #7c3aed, #ec4899);
        padding: 1.5rem 2rem;
        border-radius: 16px;
        margin-top: 1rem;
        animation: celebrate 0.5s ease-in-out;
    }

    .lottery-your-turn h3 {
        font-size: 2rem;
        margin: 0;
    }

    .lottery-close-btn {
        margin-top: 2rem;
        padding: 1rem 3rem;
        background: linear-gradient(135deg, #00d4ff, #7c3aed);
        border: none;
        border-radius: 12px;
        color: white;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .lottery-close-btn:hover {
        transform: scale(1.05);
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(1800deg); }
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    @keyframes celebrate {
        0% { transform: scale(0.8); opacity: 0; }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); opacity: 1; }
    }

    /* Live badge animation for card */
    .lottery-live-badge {
        background: linear-gradient(135deg, #f59e0b, #ef4444);
        color: white;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        animation: liveGlow 1.5s ease-in-out infinite;
    }

    .lottery-live-badge .live-dot {
        width: 8px;
        height: 8px;
        background: white;
        border-radius: 50%;
        animation: blink 1s ease-in-out infinite;
    }

    @keyframes liveGlow {
        0%, 100% { box-shadow: 0 0 10px rgba(245, 158, 11, 0.5); }
        50% { box-shadow: 0 0 25px rgba(239, 68, 68, 0.8); }
    }

    @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
    }

    
     </style>`;

        return html;
    }

    window.requestJoinGroup = async function(groupId, groupName) {
        if (!confirm('Deseas solicitar unirte al grupo "' + groupName + '"?')) return;

        try {
            var apiBase = window.API_BASE_URL || 'https://latanda.online';
            var userId = getCurrentUserId();
            var userData = JSON.parse(localStorage.getItem('latanda_user') || '{}');

            var response = await fetch(apiBase + '/api/groups/' + groupId + '/join-pg', {
                method: 'POST',
                headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: userId,
                    user_name: userData.name || userData.full_name || 'Usuario'
                })
            });

            var data = await response.json();

            if (data.success) {
                showSuccess('Solicitud enviada! El administrador revisara tu solicitud.');
                loadMatchingTab(); // Refresh
            } else {
                showError(data.error?.message || data.message || 'No se pudo enviar la solicitud');
            }
        } catch (err) {
            showError('Error de conexion. Intenta nuevamente.');
        }
    };

    // Filter functions for matching
    window.filterMatchingGroups = function() {
        var groups = window.allMatchingGroups || [];
        var freqFilter = document.getElementById('matchingFrequencyFilter')?.value || '';
        var contribFilter = document.getElementById('matchingContribFilter')?.value || '';
        
        var filtered = groups.filter(function(g) {
            // Frequency filter
            if (freqFilter && g.frequency !== freqFilter) return false;
            
            // Contribution filter
            if (contribFilter) {
                var contrib = parseFloat(g.contribution_amount) || 0;
                if (contribFilter === '0-500' && contrib > 500) return false;
                if (contribFilter === '501-1000' && (contrib <= 500 || contrib > 1000)) return false;
                if (contribFilter === '1001-2000' && (contrib <= 1000 || contrib > 2000)) return false;
                if (contribFilter === '2001+' && contrib <= 2000) return false;
            }
            return true;
        });
        
        // Re-render only the groups grid
        var container = document.getElementById('matchingContainer');
        if (container) {
            var html = renderMatchingUI(filtered);
            container.innerHTML = html;
        }
    };
    
    window.clearMatchingFilters = function() {
        document.getElementById('matchingFrequencyFilter').value = '';
        document.getElementById('matchingContribFilter').value = '';
        window.filterMatchingGroups();
    };

    window.loadMatchingTab = loadMatchingTab;

// ===========================================
// 🔌 WEBSOCKET CLIENT FOR LIVE LOTTERY SYSTEM
// Created: 2025-12-26
// ===========================================

class LotteryWebSocket {
    constructor() {
        this.ws = null;
        this.groupId = null;
        this.userId = null;
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 5;
        this.overlay = null;
        this.onAssignment = null;
        this.onComplete = null;
    }

    connect(groupId, userId) {
        return new Promise((resolve, reject) => {
            this.groupId = groupId;
            this.userId = userId;
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = protocol + '//' + window.location.host + '/ws/lottery?groupId=' + groupId + '&userId=' + userId;
            
            
            try {
                this.ws = new WebSocket(wsUrl);
            } catch (err) {
                reject(err);
                return;
            }
            
            this.ws.onopen = () => {
                this.reconnectAttempts = 0;
                resolve();
            };
            
            this.ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    this.handleMessage(data);
                } catch (err) {
                }
            };
            
            this.ws.onerror = (error) => {
            };
            
            this.ws.onclose = (event) => {
            };
            
            setTimeout(() => {
                if (this.ws.readyState !== WebSocket.OPEN) {
                    reject(new Error('Connection timeout'));
                }
            }, 5000);
        });
    }

    handleMessage(data) {
        switch (data.type) {
            case 'connected':
                this.updateOverlayStatus('Conectado - ' + data.roomSize + ' participantes en sala');
                break;
                
            case 'room_update':
                this.updateOverlayStatus(data.roomSize + ' participantes en sala');
                break;
                
            case 'countdown_start':
                this.showCountdownOverlay(data.seconds, data.groupName);
                break;
                
            case 'countdown_tick':
                this.updateCountdown(data.remaining);
                break;
                
            case 'mixing':
                this.showMixingAnimation();
                break;
                
            case 'assignment':
                this.showAssignment(data.member, data.turn, data.total);
                break;
                
            case 'complete':
                this.showComplete(data.results);
                break;
                
            case 'error':
                this.showError(data.message);
                break;
        }
    }

    showCountdownOverlay(seconds, groupName) {
        if (this.overlay) {
            this.overlay.remove();
        }
        
        this.overlay = document.createElement('div');
        this.overlay.id = 'lottery-live-overlay';
        this.overlay.innerHTML = 
            '<div class="ll-container">' +
                '<div class="ll-header">' +
                    '<div class="ll-live-badge"><span class="ll-live-dot"></span> EN VIVO</div>' +
                    '<div class="ll-group-name">' + (groupName || 'Tombola') + '</div>' +
                '</div>' +
                '<div class="ll-countdown" id="ll-countdown">' + seconds + '</div>' +
                '<div class="ll-message" id="ll-message">Preparando tombola...</div>' +
                '<div class="ll-dice" id="ll-dice">🎲</div>' +
                '<div class="ll-participants" id="ll-participants"></div>' +
                '<div class="ll-assignments" id="ll-assignments"></div>' +
            '</div>';
        
        document.body.appendChild(this.overlay);
        this.addLiveStyles();
    }

    updateCountdown(remaining) {
        const el = document.getElementById('ll-countdown');
        if (el) {
            el.textContent = remaining;
            el.classList.add('ll-pulse');
            setTimeout(() => el.classList.remove('ll-pulse'), 500);
        }
    }

    showMixingAnimation() {
        const countdown = document.getElementById('ll-countdown');
        const message = document.getElementById('ll-message');
        const dice = document.getElementById('ll-dice');
        
        if (countdown) countdown.style.display = 'none';
        if (message) message.textContent = '¡Mezclando turnos!';
        if (dice) {
            dice.style.fontSize = '100px';
            dice.classList.add('ll-spinning');
        }
    }

    showAssignment(member, turn, total) {
        const message = document.getElementById('ll-message');
        const assignments = document.getElementById('ll-assignments');
        const dice = document.getElementById('ll-dice');
        
        if (dice) dice.classList.remove('ll-spinning');
        if (message) message.textContent = 'Asignando turnos... ' + turn + '/' + total;
        
        if (assignments) {
            const assignmentEl = document.createElement('div');
            assignmentEl.className = 'll-assignment ll-assignment-new';
            assignmentEl.innerHTML = 
                '<span class="ll-turn-number">' + turn + '</span>' +
                '<span class="ll-member-name">' + (member.name || member.user_name || 'Usuario') + '</span>';
            assignments.appendChild(assignmentEl);
            
            setTimeout(() => assignmentEl.classList.remove('ll-assignment-new'), 500);
            
            if (this.onAssignment) {
                this.onAssignment(member, turn);
            }
        }
    }

    showComplete(results) {
        const message = document.getElementById('ll-message');
        const dice = document.getElementById('ll-dice');
        
        if (dice) {
            dice.textContent = '✅';
            dice.classList.remove('ll-spinning');
        }
        if (message) {
            message.innerHTML = '¡Tombola completada!<br><small>Todos los turnos han sido asignados</small>';
        }
        
        if (this.onComplete) {
            this.onComplete(results);
        }
        
        setTimeout(() => {
            this.closeOverlay();
            showSuccess('¡Tombola ejecutada exitosamente! Los turnos han sido asignados.');
            if (typeof openStartTandaModal === 'function' && currentStartTandaId && currentStartGroupId) {
                openStartTandaModal(currentStartTandaId, currentStartGroupId);
            }
            if (typeof refreshTandas === 'function') refreshTandas();
            if (typeof fetchMyGroups === 'function') {
                fetchMyGroups().then(() => {
                    if (typeof renderGroups === 'function') renderGroups();
                });
            }
        }, 2500);
    }

    showError(errorMessage) {
        const message = document.getElementById('ll-message');
        const dice = document.getElementById('ll-dice');
        
        if (dice) dice.textContent = '❌';
        if (message) {
            message.innerHTML = 'Error: ' + errorMessage;
            message.style.color = '#ef4444';
        }
        
        setTimeout(() => this.closeOverlay(), 3000);
    }

    updateOverlayStatus(status) {
        const participants = document.getElementById('ll-participants');
        if (participants) {
            participants.textContent = status;
        }
    }

    closeOverlay() {
        if (this.overlay) {
            this.overlay.remove();
            this.overlay = null;
        }
        this.disconnect();
    }

    disconnect() {
        if (this.ws) {
            this.ws.close();
            this.ws = null;
        }
    }

    addLiveStyles() {
        if (document.getElementById('lottery-live-styles')) return;
        
        const style = document.createElement('style');
        style.id = 'lottery-live-styles';
        style.textContent = 
            '#lottery-live-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100000; display: flex; align-items: center; justify-content: center; }' +
            '.ll-container { text-align: center; padding: 40px; max-width: 500px; }' +
            '.ll-header { margin-bottom: 30px; }' +
            '.ll-live-badge { display: inline-flex; align-items: center; gap: 8px; background: #dc2626; color: white; padding: 6px 16px; border-radius: 20px; font-weight: bold; font-size: 14px; margin-bottom: 10px; }' +
            '.ll-live-dot { width: 8px; height: 8px; background: white; border-radius: 50%; animation: ll-blink 1s infinite; }' +
            '@keyframes ll-blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0.3; } }' +
            '.ll-group-name { color: #f59e0b; font-size: 24px; font-weight: 600; }' +
            '.ll-countdown { font-size: 150px; color: #f59e0b; font-weight: bold; text-shadow: 0 0 50px rgba(245,158,11,0.5); transition: transform 0.2s; }' +
            '.ll-countdown.ll-pulse { transform: scale(1.1); }' +
            '.ll-message { color: white; font-size: 20px; margin: 20px 0; }' +
            '.ll-dice { font-size: 60px; margin: 20px 0; }' +
            '.ll-dice.ll-spinning { animation: ll-spin 0.3s linear infinite; }' +
            '@keyframes ll-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }' +
            '.ll-participants { color: #9ca3af; font-size: 14px; margin-bottom: 20px; }' +
            '.ll-assignments { display: flex; flex-direction: column; gap: 8px; max-height: 200px; overflow-y: auto; padding: 10px; }' +
            '.ll-assignment { display: flex; align-items: center; gap: 12px; background: rgba(245,158,11,0.1); padding: 10px 16px; border-radius: 8px; border: 1px solid rgba(245,158,11,0.3); transition: all 0.3s; }' +
            '.ll-assignment-new { background: rgba(245,158,11,0.3); transform: scale(1.05); }' +
            '.ll-turn-number { background: #f59e0b; color: black; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }' +
            '.ll-member-name { color: white; font-size: 16px; }';
        
        document.head.appendChild(style);
    }
}

// Global instance
window.lotteryWS = new LotteryWebSocket();

// New live lottery function
async function startLiveLottery() {
    if (!currentStartGroupId) {
        showError('No se ha seleccionado un grupo');
        return;
    }
    
    const userId = getCurrentUserId();
    
    try {
        // Show connecting overlay
        window.lotteryWS.showCountdownOverlay(0, 'Conectando...');
        document.getElementById('ll-countdown').textContent = '⏳';
        document.getElementById('ll-message').textContent = 'Conectando al servidor...';
        
        // Connect to WebSocket
        await window.lotteryWS.connect(currentStartGroupId, userId);
        
        document.getElementById('ll-message').textContent = 'Conectado! Iniciando tombola...';
        
        // Trigger live lottery via API
        const response = await fetch('/api/groups/' + currentStartGroupId + '/lottery-live', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + (localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token') || '')
            },
            body: JSON.stringify({ 
                user_id: userId,
                countdown_seconds: 5
            })
        });
        
        const result = await response.json();
        
        if (!result.success) {
            window.lotteryWS.showError(result.data?.error?.message || result.error || 'Error iniciando tombola');
        }
        // If success, WebSocket events will handle the UI updates
        
    } catch (err) {
        window.lotteryWS.showError('Error de conexion: ' + err.message);
    }
}

// Override the old function to use WebSocket
window.startLotteryCountdown = startLiveLottery;

})();
</script>
<script src="payout-frontend.js?v=1.1"></script>
</html>
