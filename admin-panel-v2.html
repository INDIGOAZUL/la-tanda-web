<!DOCTYPE html>
<html lang="es">
<head>
    <script src="js/admin-guard.js"></script>
    <meta charset="UTF-8">
    <!-- üîê AUTH PROTECTION - Redirect to login if not authenticated (ADMIN ONLY) -->
    <script>

        // XSS prevention helper (v4.1.0)
        function escapeHtml(text) {
            if (text == null) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }
    (function() {
        const AUTH_PAGE = "/auth-enhanced.html";
        const currentPage = window.location.pathname;
        
        function isValidToken(token) {
            // v4.1.0: JWT-only validation (not permissive)
            if (!token || typeof token !== 'string') return false;
            const parts = token.split('.');
            return parts.length === 3 && parts.every(p => p.length > 0);
        }
        
        // Check authentication
        const token = localStorage.getItem("auth_token") || localStorage.getItem("auth_token");
        const adminToken = localStorage.getItem("admin_token");
        const session = localStorage.getItem("latanda_session");
        
        let hasValidAuth = false;
        
        if (adminToken && adminToken.length === 64 && /^[a-f0-9]+$/.test(adminToken)) {
            hasValidAuth = true;
        } else if (token && isValidToken(token)) {
            hasValidAuth = true;
        } else if (session) {
            try {
                const parsedSession = JSON.parse(session);
                if (parsedSession.auth_token && isValidToken(parsedSession.auth_token)) {
                    hasValidAuth = true;
                }
            } catch (e) {}
        }
        
        if (!hasValidAuth) {
            localStorage.setItem("redirect_after_auth", currentPage);
        } else {
        }
    })();
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>La Tanda - Panel de Administraci√≥n v2.3 - Fixed Pending Approval</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha384-iw3OoTErCYJJB9mCa8LNS2hbsQ7M3C0EpIsO/H5+EGAkPGc6rk+V8i04oW/K5xq0" crossorigin="anonymous">
    <!-- Shared Components -->
    <link rel="stylesheet" href="shared-components.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --tanda-cyan: #00FFFF;
            --tanda-cyan-light: #7FFFD8;
            --primary-color: #00FFFF; /* Legacy support */
            --secondary-color: #0f172a;
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-accent: rgba(15, 23, 42, 0.8);
            --text-primary: #f8fafc;
            --text-secondary: rgba(248, 250, 252, 0.7);
            --border-color: rgba(148, 163, 184, 0.1);
            --border-accent: rgba(0, 255, 255, 0.2);
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            font-weight: 400;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            backdrop-filter: blur(24px);
            border: 1px solid var(--border-color);
        }

        .header h1 {
            color: var(--primary-color);
            font-size: 1.875rem;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: -0.025em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
            letter-spacing: 0.025em;
        }

        .stat-trend {
            font-size: 0.8rem;
            margin-top: 4px;
            font-weight: 500;
        }

        .stat-trend.up {
            color: var(--success-color);
        }

        .stat-trend.down {
            color: var(--danger-color);
        }

        .stat-trend.neutral {
            color: var(--text-secondary);
        }

        .deposits-section, .withdrawals-section {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            padding: 24px;
            backdrop-filter: blur(24px);
            border: 1px solid var(--border-color);
            margin-bottom: 24px;
        }

        .section-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            color: var(--primary-color);
            font-size: 1.375rem;
            font-weight: 600;
            margin-bottom: 4px;
            letter-spacing: -0.025em;
        }

        .refresh-btn {
            background: var(--primary-color);
            color: var(--bg-primary);
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 255, 0.3);
        }

        .deposits-table, .withdrawals-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .deposits-table th, .withdrawals-table th {
            background: rgba(0, 255, 255, 0.1);
            color: var(--primary-color);
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid rgba(0, 255, 255, 0.2);
            font-size: 0.875rem;
            font-weight: 600;
            letter-spacing: 0.025em;
            text-transform: uppercase;
        }

        .deposits-table td, .withdrawals-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: top;
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .deposits-table tr:hover, .withdrawals-table tr:hover {
            background: rgba(0, 255, 255, 0.05);
        }

        /* Bank account info styling */
        .bank-info {
            background: rgba(0, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
        }

        .bank-info h4 {
            color: var(--primary-color);
            margin: 0 0 8px 0;
            font-size: 0.9rem;
        }

        .bank-detail {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
            font-size: 0.85rem;
        }

        .bank-detail .label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .bank-detail .value {
            color: var(--text-primary);
            font-family: monospace;
        }

        .account-verified {
            color: var(--success-color);
            font-size: 0.8rem;
        }

        .btn-copy {
            background: rgba(0, 255, 255, 0.1);
            color: var(--primary-color);
            border: 1px solid rgba(0, 255, 255, 0.3);
        }

        .btn-copy:hover {
            background: rgba(0, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning-color);
        }

        .status-processing {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .reference-code {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Source Code Pro', monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8125rem;
            font-weight: 500;
            letter-spacing: 0.05em;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn {
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-confirm {
            background: var(--success-color);
            color: white;
        }

        .btn-reject {
            background: var(--danger-color);
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(12px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            border: 2px solid rgba(0, 255, 255, 0.2);
            border-radius: 20px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
        }

        .modal-header {
            color: var(--primary-color);
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 24px;
        }

        .btn-cancel {
            background: #374151;
            color: white;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--text-secondary);
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.show {
            transform: translateX(0);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 16px;
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
            .deposits-table {
                font-size: 0.9rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* TANDA COMMISSION BREAKDOWN STYLES */
        .commission-breakdown {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 16px 0;
            border: 1px solid rgba(0, 255, 255, 0.2);
        }

        .commission-breakdown h4 {
            color: var(--primary-color);
            margin-bottom: 16px;
            font-size: 1.2rem;
        }

        .breakdown-grid {
            display: grid;
            gap: 12px;
            margin-bottom: 20px;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .breakdown-item.commission {
            border-left-color: var(--warning-color);
            background: rgba(245, 158, 11, 0.1);
        }

        .breakdown-item.net {
            border-left-color: var(--success-color);
            background: rgba(16, 185, 129, 0.1);
            font-weight: 600;
        }

        .breakdown-item label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .breakdown-item span {
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .commission-distribution {
            border-top: 1px solid rgba(148, 163, 184, 0.2);
            padding-top: 16px;
        }

        .commission-distribution h5 {
            color: var(--text-primary);
            margin-bottom: 12px;
            font-size: 1rem;
        }

        .commission-list {
            display: grid;
            gap: 8px;
        }

        .commission-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.15);
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .commission-item span:first-child {
            color: var(--text-secondary);
        }

        .commission-item span:last-child {
            font-weight: 600;
            font-family: 'Courier New', monospace;
            color: var(--primary-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1><i class="fas fa-shield-alt"></i> Panel de Administraci√≥n</h1>
                    <p style="color: var(--text-secondary);">Gesti√≥n de dep√≥sitos y confirmaciones manuales</p>
                </div>
                <div class="header-actions">
                    <a href="admin-kyc-review.html" class="btn" style="background: #9333ea; color: white; margin-right: 10px; text-decoration: none; padding: 10px 15px; border-radius: 8px;"><i class="fas fa-id-card"></i> KYC Review</a>
                    <a href="admin-audit-logs-viewer.html" class="btn" style="background: #6366f1; color: white; margin-right: 10px; text-decoration: none; padding: 10px 15px; border-radius: 8px;"><i class="fas fa-clipboard-list"></i> Audit Logs</a>
                    <button onclick="cleanOldData()" class="btn btn-warning" style="background: var(--danger-color); color: var(--text-primary); margin-right: 10px;">
                        <i class="fas fa-broom"></i> Limpiar Datos Antiguos
                    </button>
                    <button onclick="createSampleDataForTesting()" class="btn btn-secondary" style="background: var(--warning-color); color: var(--bg-primary);">
                        <i class="fas fa-database"></i> Crear Datos de Prueba
                    </button>
                </div>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <!-- Basic Stats Row -->
            <div class="stat-card">
                <div class="stat-value" id="pendingCount">-</div>
                <div class="stat-label">Dep√≥sitos Pendientes</div>
                <div class="stat-trend" id="pendingTrend"></div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalAmount">$-</div>
                <div class="stat-label">Monto Total Pendiente</div>
                <div class="stat-trend" id="amountTrend"></div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="banksCount">-</div>
                <div class="stat-label">Bancos Activos</div>
                <div class="stat-trend" id="banksTrend"></div>
            </div>

            <!-- Enhanced Analytics Row -->
            <div class="stat-card">
                <div class="stat-value" id="approvedToday">-</div>
                <div class="stat-label">Aprobados Hoy</div>
                <div class="stat-trend" id="approvedTrend"></div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="rejectedToday">-</div>
                <div class="stat-label">Rechazados Hoy</div>
                <div class="stat-trend" id="rejectedTrend"></div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgProcessingTime">-</div>
                <div class="stat-label">Tiempo Promedio</div>
                <div class="stat-trend" id="timeTrend"></div>
            </div>

            <!-- OCR Quality Row -->
            <div class="stat-card">
                <div class="stat-value" id="highConfidenceOcr">-</div>
                <div class="stat-label">Alta Confianza OCR (‚â•80%)</div>
                <div class="stat-trend" id="ocrHighTrend"></div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="lowConfidenceOcr">-</div>
                <div class="stat-label">Baja Confianza OCR (<50%)</div>
                <div class="stat-trend" id="ocrLowTrend"></div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="oldestPending">-</div>
                <div class="stat-label">M√°s Antiguo Pendiente</div>
                <div class="stat-trend" id="oldestTrend"></div>
            </div>

            <!-- Withdrawal Statistics Row -->
            <div class="stat-card">
                <div class="stat-value" id="totalWithdrawalsCard">-</div>
                <div class="stat-label">Retiros Pendientes</div>
                <div class="stat-trend">‚Üë +5% vs ayer</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalWithdrawalAmountCard">-</div>
                <div class="stat-label">Monto Retiros</div>
                <div class="stat-trend">‚Üó +2% vs ayer</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalAppealsCard">0</div>
                <div class="stat-label">Apelaciones Pendientes</div>
                <div class="stat-trend" id="appealsTrend">üìã Requieren revisi√≥n</div>
            </div>
        </div>

        <!-- Analytics Dashboard Section -->
        <div class="analytics-dashboard" style="margin-bottom: 24px;">
            <div class="section-header">
                <h3 class="section-title">Analytics Dashboard</h3>
            </div>
            <div class="analytics-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div class="analytics-card" style="background: rgba(0, 0, 0, 0.3); border-radius: 12px; padding: 20px;">
                    <h4 style="color: var(--primary-color); margin-bottom: 16px;">
                        <i class="fas fa-chart-line"></i> Daily Performance
                    </h4>
                    <div id="dailyPerformance">
                        <div class="metric-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Success Rate:</span>
                            <span id="successRate" style="color: var(--success-color);">-</span>
                        </div>
                        <div class="metric-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Avg Amount:</span>
                            <span id="avgAmount">$-</span>
                        </div>
                        <div class="metric-row" style="display: flex; justify-content: space-between;">
                            <span>Total Processed:</span>
                            <span id="totalProcessed">-</span>
                        </div>
                    </div>
                </div>

                <div class="analytics-card" style="background: rgba(0, 0, 0, 0.3); border-radius: 12px; padding: 20px;">
                    <h4 style="color: var(--primary-color); margin-bottom: 16px;">
                        <i class="fas fa-eye"></i> OCR Analysis
                    </h4>
                    <div id="ocrAnalysis">
                        <div class="metric-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Avg Confidence:</span>
                            <span id="avgConfidence">-%</span>
                        </div>
                        <div class="metric-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Auto-Processable:</span>
                            <span id="autoProcessable" style="color: var(--success-color);">-</span>
                        </div>
                        <div class="metric-row" style="display: flex; justify-content: space-between;">
                            <span>Manual Review:</span>
                            <span id="manualReview" style="color: var(--warning-color);">-</span>
                        </div>
                    </div>
                </div>

                <div class="analytics-card" style="background: rgba(0, 0, 0, 0.3); border-radius: 12px; padding: 20px;">
                    <h4 style="color: var(--primary-color); margin-bottom: 16px;">
                        <i class="fas fa-university"></i> Bank Distribution
                    </h4>
                    <div id="bankDistribution">
                        <div class="metric-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Banco Atl√°ntida:</span>
                            <span id="atlantidaCount">-</span>
                        </div>
                        <div class="metric-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Lightning Network:</span>
                            <span id="lightningCount">-</span>
                        </div>
                        <div class="metric-row" style="display: flex; justify-content: space-between;">
                            <span>Other Banks:</span>
                            <span id="otherBanksCount">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="deposits-section">
            <div class="section-header">
                <div>
                    <h2 class="section-title">Gesti√≥n de Dep√≥sitos</h2>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">Administraci√≥n completa de transacciones</p>
                </div>
                <button class="refresh-btn" onclick="loadDepositsByStatus()">
                    <i class="fas fa-sync-alt"></i>
                    Actualizar
                </button>
            </div>

            <!-- Deposit Tabs -->
            <div class="deposit-tabs">
                <button class="tab-btn active" onclick="switchDepositTab('pending')" id="tab-pending">
                    <i class="fas fa-clock"></i> Pendientes (<span id="pending-count">0</span>)
                </button>
                <button class="tab-btn" onclick="switchDepositTab('completed')" id="tab-completed">
                    <i class="fas fa-check-circle"></i> Completadas (<span id="completed-count">0</span>)
                </button>
                <button class="tab-btn" onclick="switchDepositTab('rejected')" id="tab-rejected">
                    <i class="fas fa-times-circle"></i> Rechazadas (<span id="rejected-count">0</span>)
                </button>
            </div>

            <div id="depositsContainer">
                <div class="loading" style="margin: 40px auto; display: block;"></div>
            </div>
        </div>

        <!-- Withdrawals Section -->
        <div class="withdrawals-section">
            <div class="section-header">
                <div>
                    <h2 class="section-title">üè¶ Retiros Bancarios Pendientes</h2>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">Requieren procesamiento manual</p>
                </div>
                <button class="refresh-btn" onclick="loadPendingWithdrawals()">
                    <i class="fas fa-sync-alt"></i>
                    Actualizar
                </button>
            </div>

            <!-- Withdrawal Statistics moved to main dashboard cards above -->

            <div id="withdrawalsContainer">
                <div class="loading" style="margin: 40px auto; display: block;"></div>
            </div>
        </div>

        <!-- Appeals Section -->
        <div class="appeals-section">
            <div class="section-header">
                <div>
                    <h2 class="section-title">‚öñÔ∏è Apelaciones Pendientes</h2>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">Revisiones de decisiones rechazadas</p>
                </div>
                <button class="refresh-btn" onclick="loadPendingAppeals()">
                    <i class="fas fa-sync-alt"></i>
                    Actualizar
                </button>
            </div>
            <div id="appealsContainer">
                <div class="loading" style="margin: 40px auto; display: block;"></div>
            </div>
        </div>

        <!-- Deleted Groups Management Section -->
        <div class="deleted-groups-section" style="margin-top: 30px;">
            <div class="section-header">
                <div>
                    <h2 class="section-title">üóëÔ∏è Grupos Eliminados</h2>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">Grupos marcados para eliminaci√≥n (soft-delete)</p>
                </div>
                <button class="refresh-btn" onclick="loadDeletedGroups()">
                    <i class="fas fa-sync-alt"></i>
                    Actualizar
                </button>
            </div>
            <div id="deletedGroupsContainer">
                <div class="loading" style="margin: 40px auto; display: block;"></div>
            </div>
        </div>

        <!-- Failed Group Joins Section -->
        <div class="failed-joins-section" style="margin-top: 30px;">
            <div class="section-header">
                <div>
                    <h2 class="section-title">‚ö†Ô∏è Errores de Uni√≥n a Grupos</h2>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">Usuarios que tuvieron problemas al unirse a grupos</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <select id="failedJoinsFilter" onchange="loadFailedJoins()" style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary);">
                        <option value="false">Sin Resolver</option>
                        <option value="true">Resueltos</option>
                        <option value="">Todos</option>
                    </select>
                    <button class="refresh-btn" onclick="loadFailedJoins()">
                        <i class="fas fa-sync-alt"></i>
                        Actualizar
                    </button>
                </div>
            </div>
            <div id="failedJoinsStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <!-- Stats will be loaded here -->
            </div>
            <div id="failedJoinsContainer">
                <div class="loading" style="margin: 40px auto; display: block;"></div>
            </div>
        </div>

        <!-- Resolve Failed Join Modal -->
        <div id="resolveFailedJoinModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 500px;">
                <h3 class="modal-header" style="color: #10b981;">
                    <i class="fas fa-check-circle"></i> Resolver Error
                </h3>
                <div id="resolveFailedJoinInfo" style="margin: 15px 0; padding: 10px; background: #f8fafc; border-radius: 6px;"></div>
                <div class="form-group">
                    <label class="form-label">Tipo de Resoluci√≥n</label>
                    <select id="resolutionType" class="form-input">
                        <option value="manual">Resuelto Manualmente</option>
                        <option value="user_retry">Usuario reintent√≥ exitosamente</option>
                        <option value="not_needed">Ya no es necesario</option>
                        <option value="duplicate">Duplicado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Notas (opcional)</label>
                    <textarea id="resolveNotes" class="form-input form-textarea" placeholder="Detalles de la resoluci√≥n..."></textarea>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-cancel" onclick="closeResolveModal()">Cancelar</button>
                    <button class="btn btn-confirm" onclick="executeResolveFailedJoin()" style="background: #10b981;">
                        <i class="fas fa-check"></i> Marcar como Resuelto
                    </button>
                </div>
            </div>
        </div>

        <!-- Hard Delete Confirmation Modal -->
        <div id="hardDeleteModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 500px;">
                <h3 class="modal-header" style="color: #dc2626;">
                    <i class="fas fa-exclamation-triangle"></i> ‚ö†Ô∏è Eliminar Permanentemente
                </h3>
                <div style="margin: 20px 0; padding: 15px; background: #fef2f2; border-radius: 8px; border: 1px solid #fecaca;">
                    <p style="color: #991b1b; font-weight: 600; margin-bottom: 10px;">
                        Esta acci√≥n es IRREVERSIBLE
                    </p>
                    <p style="color: #7f1d1d; font-size: 0.9rem;">
                        Se eliminar√°n permanentemente:<br>
                        ‚Ä¢ El grupo y toda su configuraci√≥n<br>
                        ‚Ä¢ Todas las contribuciones asociadas<br>
                        ‚Ä¢ Todos los miembros del grupo<br>
                        ‚Ä¢ Las tandas relacionadas
                    </p>
                </div>
                <div id="hardDeleteGroupInfo" style="margin: 15px 0; padding: 10px; background: #f8fafc; border-radius: 6px;"></div>
                <div class="form-group">
                    <label class="form-label">Para confirmar, escriba el nombre del grupo:</label>
                    <input type="text" id="hardDeleteConfirmInput" class="form-input" placeholder="Nombre exacto del grupo" autocomplete="off">
                </div>
                <div class="modal-actions">
                    <button class="btn btn-cancel" onclick="closeHardDeleteModal()">Cancelar</button>
                    <button class="btn" id="hardDeleteBtn" onclick="executeHardDelete()" style="background: #dc2626; color: white;" disabled>
                        <i class="fas fa-trash-alt"></i> Eliminar Permanentemente
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-header"><i class="fas fa-check-circle"></i> Confirmar Dep√≥sito</h3>
            <div id="confirmDepositInfo"></div>
            
            <div class="form-group">
                <label class="form-label">Monto Recibido (opcional)</label>
                <input type="number" id="receivedAmount" class="form-input" placeholder="Dejar vac√≠o si es igual al monto solicitado" step="0.01">
            </div>
            
            <div class="form-group">
                <label class="form-label">Notas del Administrador</label>
                <textarea id="adminNotes" class="form-input form-textarea" placeholder="Comentarios o detalles adicionales..."></textarea>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-confirm" onclick="executeConfirm()">
                    <i class="fas fa-check"></i> Confirmar Dep√≥sito
                </button>
            </div>
        </div>
    </div>

    <!-- Reject Modal -->
    <div id="rejectModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-header"><i class="fas fa-times-circle"></i> Rechazar Dep√≥sito</h3>
            <div id="rejectDepositInfo"></div>
            
            <div class="form-group">
                <label class="form-label">Raz√≥n del Rechazo *</label>
                <select id="rejectionReason" class="form-input" required>
                    <option value="">Seleccionar raz√≥n...</option>
                    <option value="insufficient_amount">Monto insuficiente recibido</option>
                    <option value="wrong_reference">Referencia incorrecta</option>
                    <option value="wrong_account">Cuenta origen incorrecta</option>
                    <option value="fraudulent">Transacci√≥n sospechosa</option>
                    <option value="technical_issue">Problema t√©cnico</option>
                    <option value="other">Otra raz√≥n</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Notas Adicionales</label>
                <textarea id="rejectNotes" class="form-input form-textarea" placeholder="Explicaci√≥n detallada del rechazo..."></textarea>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-reject" onclick="executeReject()">
                    <i class="fas fa-times"></i> Rechazar Dep√≥sito
                </button>
            </div>
        </div>
    </div>

    <!-- Withdrawal Details Modal -->
    <div id="withdrawalDetailsModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-header"><i class="fas fa-money-bill-wave"></i> Detalles del Retiro</h3>
            <div id="withdrawalDetailsInfo"></div>

            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeModal()">Cerrar</button>
                <button class="btn btn-copy" onclick="copyBankingDetails()">
                    <i class="fas fa-copy"></i> Copiar Datos Bancarios
                </button>
            </div>
        </div>
    </div>

    <!-- Process Withdrawal Modal -->
    <div id="processWithdrawalModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-header"><i class="fas fa-check-circle"></i> Procesar Retiro</h3>
            <div id="processWithdrawalInfo"></div>

            <div class="form-group">
                <label class="form-label">Comprobante de Transferencia</label>
                <input type="file" id="transferReceipt" class="form-input" accept="image/*,.pdf">
                <small style="color: var(--text-secondary);">Opcional: Adjuntar comprobante de la transferencia bancaria</small>
            </div>

            <div class="form-group">
                <label class="form-label">Notas del Procesamiento</label>
                <textarea id="processingNotes" class="form-input form-textarea" placeholder="Detalles del procesamiento, n√∫mero de confirmaci√≥n, etc..."></textarea>
            </div>

            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-confirm" onclick="confirmWithdrawalProcessing()">
                    <i class="fas fa-check"></i> Marcar como Procesado
                </button>
            </div>
        </div>
    </div>

    <!-- Reject Withdrawal Modal -->
    <div id="rejectWithdrawalModal" class="modal">
        <div class="modal-content">
            <h3 class="modal-header"><i class="fas fa-times-circle"></i> Rechazar Retiro</h3>
            <div id="rejectWithdrawalInfo"></div>

            <div class="form-group">
                <label class="form-label">Motivo del Rechazo</label>
                <select id="withdrawalRejectionReason" class="form-input" required>
                    <option value="">Seleccionar motivo...</option>
                    <option value="insufficient_funds">Fondos insuficientes</option>
                    <option value="invalid_account">Datos bancarios inv√°lidos</option>
                    <option value="unverified_account">Cuenta no verificada</option>
                    <option value="suspicious_activity">Actividad sospechosa</option>
                    <option value="system_maintenance">Mantenimiento del sistema</option>
                    <option value="other">Otro (especificar)</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Detalles Adicionales</label>
                <textarea id="withdrawalRejectionNotes" class="form-input form-textarea" placeholder="Explicaci√≥n detallada del rechazo..."></textarea>
            </div>

            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-reject" onclick="confirmWithdrawalRejection()">
                    <i class="fas fa-times"></i> Rechazar Retiro
                </button>
            </div>
        </div>
    </div>

    <!-- Security Warning Modal -->
    <div id="securityModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3 class="modal-header" style="color: var(--danger-color);">
                <i class="fas fa-exclamation-triangle"></i> Acceso No Autorizado
            </h3>
            <div style="padding: 20px; text-align: center;">
                <p style="margin-bottom: 20px;">Esta es un √°rea administrativa protegida.</p>
                <p style="margin-bottom: 20px;">Por favor, use el portal de acceso seguro.</p>
                <button onclick="window.location.href='/admin-portal.html'"
                        style="background: var(--primary-color); color: var(--bg-primary); border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                    <i class="fas fa-shield-alt"></i> Portal Seguro
                </button>
            </div>
        </div>
    </div>

        <!-- User Management Section -->
        <div class="users-section" id="usersSection" style="margin-top: 30px;">
            <div class="section-header">
                <div>
                    <h2 class="section-title"><i class="fas fa-users"></i> Gestion de Usuarios</h2>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">Administracion completa de usuarios registrados</p>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="userSearchInput" placeholder="Buscar por email o nombre..." 
                           style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary); min-width: 200px;">
                    <select id="userStatusFilter" style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary);">
                        <option value="">Todos los estados</option>
                        <option value="active">Activos</option>
                        <option value="suspended">Suspendidos</option>
                        <option value="banned">Baneados</option>
                    </select>
                    <button class="refresh-btn" onclick="loadUsers()">
                        <i class="fas fa-sync-alt"></i> Actualizar
                    </button>
                </div>
            </div>

            <!-- User Statistics Cards -->
            <div id="userStatsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 1.8rem; font-weight: bold; color: var(--tanda-cyan);" id="statTotalUsers">-</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Total Usuarios</div>
                </div>
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 1.8rem; font-weight: bold; color: #10b981;" id="statActiveUsers">-</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Activos</div>
                </div>
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 1.8rem; font-weight: bold; color: #f59e0b;" id="statSuspendedUsers">-</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Suspendidos</div>
                </div>
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 1.8rem; font-weight: bold; color: #6366f1;" id="statVerifiedUsers">-</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Verificados</div>
                </div>
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 1.8rem; font-weight: bold; color: #8b5cf6;" id="statKycComplete">-</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">KYC Completo</div>
                </div>
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 1.8rem; font-weight: bold; color: #ec4899;" id="statNewWeek">-</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Nuevos (7d)</div>
                </div>
            </div>

            <!-- Users Table -->
            <div style="overflow-x: auto;">
                <table id="usersTable" style="width: 100%; border-collapse: collapse; background: rgba(0,0,0,0.2); border-radius: 10px; overflow: hidden;">
                    <thead>
                        <tr style="background: rgba(0,255,255,0.1);">
                            <th style="padding: 12px; text-align: left; color: var(--tanda-cyan);">Usuario</th>
                            <th style="padding: 12px; text-align: left; color: var(--tanda-cyan);">Email</th>
                            <th style="padding: 12px; text-align: center; color: var(--tanda-cyan);">Estado</th>
                            <th style="padding: 12px; text-align: center; color: var(--tanda-cyan);">Verificacion</th>
                            <th style="padding: 12px; text-align: center; color: var(--tanda-cyan);">Rol</th>
                            <th style="padding: 12px; text-align: left; color: var(--tanda-cyan);">Registro</th>
                            <th style="padding: 12px; text-align: center; color: var(--tanda-cyan);">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr><td colspan="7" style="padding: 40px; text-align: center; color: var(--text-secondary);"><div class="loading"></div></td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div id="usersPagination" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px;"></div>
        </div>

        <!-- User Action Modal -->
        <div id="userActionModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 450px;">
                <h3 class="modal-header" style="color: var(--tanda-cyan);">
                    <i class="fas fa-user-cog"></i> Accion de Usuario
                </h3>
                <div id="userActionInfo" style="margin: 15px 0; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                    <p><strong>Usuario:</strong> <span id="actionUserName">-</span></p>
                    <p><strong>Email:</strong> <span id="actionUserEmail">-</span></p>
                    <p><strong>Estado actual:</strong> <span id="actionUserStatus">-</span></p>
                </div>
                <div class="form-group">
                    <label class="form-label">Nuevo Estado</label>
                    <select id="newUserStatus" style="width: 100%; padding: 10px; border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color);">
                        <option value="active">Activo</option>
                        <option value="suspended">Suspendido</option>
                        <option value="banned">Baneado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Razon (opcional)</label>
                    <textarea id="statusChangeReason" style="width: 100%; padding: 10px; border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color); min-height: 80px;" placeholder="Motivo del cambio de estado..."></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button onclick="closeUserActionModal()" style="padding: 10px 20px; border-radius: 6px; border: 1px solid var(--border-color); background: transparent; color: var(--text-primary); cursor: pointer;">Cancelar</button>
                    <button onclick="executeUserStatusChange()" style="padding: 10px 20px; border-radius: 6px; border: none; background: var(--tanda-cyan); color: var(--bg-primary); cursor: pointer; font-weight: 600;">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                </div>
            </div>
        </div>
        <!-- Groups Management Section -->
        <div class="groups-section" id="groupsSection" style="margin-top: 30px;">
            <div class="section-header">
                <div>
                    <h2 class="section-title"><i class="fas fa-users-cog"></i> Gestion de Grupos/Tandas</h2>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">Vista de grupos activos y administracion</p>
                </div>
                <button class="refresh-btn" onclick="loadAdminGroups()">
                    <i class="fas fa-sync-alt"></i> Actualizar
                </button>
            </div>

            <!-- Group Statistics Cards -->
            <div id="groupStatsGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 1.8rem; font-weight: bold; color: var(--tanda-cyan);" id="statTotalGroups">-</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Total Grupos</div>
                </div>
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 1.8rem; font-weight: bold; color: #10b981;" id="statActiveGroups">-</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Activos</div>
                </div>
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 1.8rem; font-weight: bold; color: #6366f1;" id="statTotalMembers">-</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Miembros</div>
                </div>
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 1.8rem; font-weight: bold; color: #f59e0b;" id="statDeletedGroups">-</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Eliminados</div>
                </div>
            </div>

            <!-- Groups Table -->
            <div style="overflow-x: auto;">
                <table id="groupsTable" style="width: 100%; border-collapse: collapse; background: rgba(0,0,0,0.2); border-radius: 10px; overflow: hidden;">
                    <thead>
                        <tr style="background: rgba(0,255,255,0.1);">
                            <th style="padding: 12px; text-align: left; color: var(--tanda-cyan);">Nombre</th>
                            <th style="padding: 12px; text-align: center; color: var(--tanda-cyan);">Miembros</th>
                            <th style="padding: 12px; text-align: center; color: var(--tanda-cyan);">Aporte</th>
                            <th style="padding: 12px; text-align: center; color: var(--tanda-cyan);">Frecuencia</th>
                            <th style="padding: 12px; text-align: center; color: var(--tanda-cyan);">Estado</th>
                            <th style="padding: 12px; text-align: left; color: var(--tanda-cyan);">Creado</th>
                        </tr>
                    </thead>
                    <tbody id="groupsTableBody">
                        <tr><td colspan="6" style="padding: 40px; text-align: center; color: var(--text-secondary);"><div class="loading"></div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    <script>
        let currentDepositId = null;
        let currentUser = null;
        let authToken = null;

        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Force local development mode immediately
            const isLocalDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            if (isLocalDev) {
                // Hide login modal immediately
                setTimeout(() => {
                    const loginModal = document.getElementById('loginModal');
                    if (loginModal) {
                        loginModal.style.display = 'none';
                    }
                    const container = document.querySelector('.container');
                    if (container) {
                        container.style.display = 'block';
                    }
                }, 100);
            }
            checkAuthentication();
        });

        async function checkAuthentication() {
            // Check if we're in local development mode
            const isLocalDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

            if (isLocalDev) {
                // Local development mode
                // Create local admin user for development
                currentUser = {
                    id: 'dev_admin_1',
                    name: 'Admin Local',
                    role: 'Administrator',
                    email: 'admin@localhost',
                    permissions: ['confirm_deposits', 'view_deposits', 'admin_access', 'all_permissions']
                };
                authToken = 'local_dev_token_' + Date.now();
                localStorage.setItem('admin_token', authToken);
                hideLoginModal();
                updateUIForUser();
                loadPendingDeposits();
                // Local authentication successful
                return;
            }

            const token = localStorage.getItem('admin_token');
            if (!token) {
                showLoginModal();
                return;
            }

            try {
                const response = await fetch('https://latanda.online/api/admin/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: token })
                });

                const data = await response.json();

                if (data.success && response.ok) {
                    currentUser = data.data.user;
                    // Ensure currentUser has required properties
                    if (!currentUser.permissions) {
                        currentUser.permissions = ['confirm_deposits', 'view_deposits', 'admin_access'];
                    }
                    if (!currentUser.name) {
                        currentUser.name = 'Admin';
                    }
                    if (!currentUser.role) {
                        currentUser.role = 'Administrator';
                    }
                    authToken = token;
                    hideLoginModal();
                    updateUIForUser();
                    loadPendingDeposits();
                } else {
                    localStorage.removeItem('admin_token');
                    authToken = null;
                    currentUser = null;
                    showLoginModal();
                }
            } catch (error) {
                localStorage.removeItem('admin_token');
                authToken = null;
                currentUser = null;
                showLoginModal();
            }
        }

        // Helper function for authenticated API requests
        async function makeAuthenticatedRequest(url, options = {}) {
            const isLocalDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

            // In development mode, don't make API calls
            if (isLocalDev) {
                throw new Error('Development mode - API calls disabled');
            }

            if (!authToken) {
                showLoginModal();
                throw new Error('No authentication token');
            }

            const response = await fetch(url, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`,
                    ...options.headers
                }
            });

            // Handle 401 errors globally
            if (response.status === 401) {
                localStorage.removeItem('admin_token');
                authToken = null;
                currentUser = null;
                showLoginModal();
                throw new Error('Session expired');
            }

            return response;
        }

        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'flex';
            document.querySelector('.container').style.display = 'none';
        }

        function hideLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
            document.querySelector('.container').style.display = 'block';
        }

        async function adminLogin() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            if (!username || !password) {
                errorDiv.textContent = 'Usuario y contrase√±a son requeridos';
                errorDiv.style.display = 'block';
                return;
            }

            // Local development credentials bypass
            const isLocalDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const localCredentials = {
                'admin': 'LaTanda2025!Admin',
                'finance': 'Finance2025!LT',
                'support': 'Support2025!Help'
            };

            if (isLocalDev && localCredentials[username] === password) {

                const userRoles = {
                    'admin': {
                        id: 'local_admin',
                        name: 'Administrador Principal',
                        role: 'Administrator',
                        email: 'admin@localhost',
                        permissions: ['confirm_deposits', 'reject_deposits', 'view_all', 'admin_access']
                    },
                    'finance': {
                        id: 'local_finance',
                        name: 'Usuario Finanzas',
                        role: 'Finance',
                        email: 'finance@localhost',
                        permissions: ['confirm_deposits', 'reject_deposits', 'view_deposits']
                    },
                    'support': {
                        id: 'local_support',
                        name: 'Usuario Soporte',
                        role: 'Support',
                        email: 'support@localhost',
                        permissions: ['view_deposits']
                    }
                };

                currentUser = userRoles[username];
                authToken = `local_token_${username}_${Date.now()}`;
                localStorage.setItem('admin_token', authToken);

                hideLoginModal();
                updateUIForUser();
                loadPendingDeposits();
                return;
            }

            try {
                const response = await fetch('https://latanda.online/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (data.success) {
                    currentUser = data.data.user;
                    // Ensure currentUser has required properties
                    if (!currentUser.permissions) {
                        currentUser.permissions = ['confirm_deposits', 'view_deposits', 'admin_access'];
                    }
                    if (!currentUser.name) {
                        currentUser.name = 'Admin';
                    }
                    if (!currentUser.role) {
                        currentUser.role = 'Administrator';
                    }
                    authToken = data.data.token;
                    localStorage.setItem('admin_token', authToken);
                    
                    errorDiv.style.display = 'none';
                    hideLoginModal();
                    updateUIForUser();
                    loadPendingDeposits();
                    
                    showNotification(`Bienvenido ${escapeHtml(currentUser.name)}`, 'success');
                } else {
                    errorDiv.textContent = data.message || 'Credenciales inv√°lidas';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Error de conexi√≥n';
                errorDiv.style.display = 'block';
            }
        }

        function updateUIForUser() {
            // Safety check: ensure currentUser exists
            if (!currentUser) {
                return;
            }

            // Update header with user info - clear existing first
            const header = document.querySelector('.header');

            // Remove existing user info sections
            const existingUserInfo = header.querySelectorAll('.user-info-section');
            existingUserInfo.forEach(element => element.remove());

            const userInfo = document.createElement('div');
            userInfo.classList.add('user-info-section'); // Add class for identification
            userInfo.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-top: 10px;';
            userInfo.innerHTML = `
                <div style="color: var(--text-secondary); font-size: 0.9rem;">
                    <i class="fas fa-user"></i> ${escapeHtml(currentUser.name)} (${currentUser.role})
                </div>
                <button onclick="adminLogout()" style="background: var(--danger-color); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
                </button>
            `;
            header.appendChild(userInfo);

            // Hide action buttons if user doesn't have permissions
            if (currentUser && currentUser.permissions && !currentUser.permissions.includes('confirm_deposits')) {
                const style = document.createElement('style');
                style.textContent = '.btn-confirm, .btn-reject { display: none !important; }';
                document.head.appendChild(style);
            }
        }

        async function adminLogout() {
            if (authToken) {
                try {
                    await fetch('https://latanda.online/api/admin/logout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token: authToken })
                    });
                } catch (error) {
                }
            }

            localStorage.removeItem('admin_token');
            currentUser = null;
            authToken = null;
            
            // Reload page to reset state
            window.location.href = "/index.html";
        }

        async function loadPendingDeposits() {
            // Add visual feedback
            const refreshBtn = document.querySelector('.refresh-btn');
            const originalContent = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Actualizando...';
            refreshBtn.disabled = true;

            // Check if we're in local development mode
            const isLocalDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

            if (isLocalDev) {
                loadLocalDepositData();

                // Restore button state
                setTimeout(() => {
                    refreshBtn.innerHTML = originalContent;
                    refreshBtn.disabled = false;
                }, 1000);
                return;
            }

            try {
                const response = await makeAuthenticatedRequest('https://latanda.online/api/admin/contributions/pending', {
                    method: 'GET'
                });

                const data = await response.json();

                if (data.success) {
                    displayStats(data.data);
                    displayDeposits(data.data.pending_deposits);
                } else {
                    throw new Error(data.message || 'Error loading deposits');
                }
            } catch (error) {
                // Silently fall back to local data in development mode
                loadLocalDepositData();

                const testDeposits = [
                        {
                            id: 'deposit_c54af87b6b651e91',
                            user_id: 'user_001',
                            amount: 1000.00,
                            net_amount: 1000.00,
                            bank_name: 'Banco Atl√°ntida',
                            reference_number: 'BT1757352194072',
                            status: 'under_review',
                            status_description: 'Apelaci√≥n en revisi√≥n administrativa',
                            created_at: '2025-09-08T11:23:14Z',
                            time_remaining: 0,
                            receipt: {
                                filename: 'receipt_test.jpg'
                            }
                        },
                        {
                            id: 'deposit_test_pending',
                            user_id: 'user_002',
                            amount: 500.00,
                            net_amount: 500.00,
                            bank_name: 'Banco BAC',
                            reference_number: 'BT1757999999999',
                            status: 'pending',
                            status_description: 'Pendiente de confirmaci√≥n',
                            created_at: '2025-09-18T10:00:00Z',
                            time_remaining: 24,
                            receipt: {
                                filename: 'receipt_pending.jpg'
                            }
                        }
                    ];

                    displayDeposits(testDeposits);
            } finally {
                // Always restore button state
                setTimeout(() => {
                    refreshBtn.innerHTML = originalContent;
                    refreshBtn.disabled = false;
                }, 1000);
            }
        }

        function displayStats(data) {
            // Basic stats
            document.getElementById('pendingCount').textContent = data.total_pending || 0;
            // Use multi-currency display if available, otherwise fallback to single currency
            const totalAmountText = data.total_amount_display || formatCurrency(data.total_amount || 0, data.primary_currency || 'USD');
            document.getElementById('totalAmount').textContent = totalAmountText;
            document.getElementById('banksCount').textContent = Object.keys(data.banks_summary || {}).length;

            // Enhanced analytics
            document.getElementById('approvedToday').textContent = data.approved_today || 0;
            document.getElementById('rejectedToday').textContent = data.rejected_today || 0;
            document.getElementById('avgProcessingTime').textContent = data.avg_processing_time || '-';

            // OCR quality stats
            document.getElementById('highConfidenceOcr').textContent = data.high_confidence_ocr || 0;
            document.getElementById('lowConfidenceOcr').textContent = data.low_confidence_ocr || 0;

            // Format oldest pending properly
            let oldestText = '-';
            if (data.oldest_pending) {
                const uploadTime = new Date(data.oldest_pending.uploadTime || data.oldest_pending);
                const hoursAgo = Math.floor((Date.now() - uploadTime) / (1000 * 60 * 60));
                oldestText = `${hoursAgo}h`;
            }
            document.getElementById('oldestPending').textContent = oldestText;

            // Trends (simulate with random but realistic values)
            setTrend('pendingTrend', calculateTrend('pending', data.total_pending));
            setTrend('amountTrend', calculateTrend('amount', data.total_amount));
            setTrend('approvedTrend', calculateTrend('approved', data.approved_today));
            setTrend('rejectedTrend', calculateTrend('rejected', data.rejected_today));
            setTrend('ocrHighTrend', calculateTrend('ocr_high', data.high_confidence_ocr));
            setTrend('ocrLowTrend', calculateTrend('ocr_low', data.low_confidence_ocr));

            // Analytics dashboard
            displayAnalyticsDashboard(data);
        }

        function calculateTrend(metric, currentValue) {
            // Simulate trend calculation (in real implementation, compare with historical data)
            const trends = {
                pending: { change: -15, type: 'down' }, // fewer pending is good
                amount: { change: +8, type: 'up' },
                approved: { change: +25, type: 'up' },
                rejected: { change: -10, type: 'down' },
                ocr_high: { change: +12, type: 'up' },
                ocr_low: { change: -18, type: 'down' }
            };

            const trend = trends[metric] || { change: 0, type: 'neutral' };
            return {
                text: `${trend.change > 0 ? '+' : ''}${trend.change}% vs ayer`,
                type: trend.type,
                icon: trend.type === 'up' ? '‚Üó' : trend.type === 'down' ? '‚Üò' : '‚Üí'
            };
        }

        function setTrend(elementId, trend) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = `${trend.icon} ${trend.text}`;
                element.className = `stat-trend ${trend.type}`;
            }
        }

        function displayAnalyticsDashboard(data) {
            const approved = data.approved_today || 0;
            const rejected = data.rejected_today || 0;
            const total = approved + rejected;
            const successRate = total > 0 ? Math.round((approved / total) * 100) : 0;

            // Daily Performance
            document.getElementById('successRate').textContent = `${successRate}%`;
            document.getElementById('avgAmount').textContent = formatCurrency(data.avg_amount || 0, data.primary_currency || 'USD');
            document.getElementById('totalProcessed').textContent = total;

            // OCR Analysis
            const avgConfidence = data.avg_confidence || 0;
            const autoProcessable = data.auto_processable || 0;
            const manualReview = (data.total_pending || 0) - autoProcessable;

            document.getElementById('avgConfidence').textContent = `${Math.round(avgConfidence)}%`;
            document.getElementById('autoProcessable').textContent = autoProcessable;
            document.getElementById('manualReview').textContent = manualReview;

            // Bank Distribution
            const banks = data.banks_distribution || {};
            document.getElementById('atlantidaCount').textContent = banks.atlantida || 0;
            document.getElementById('lightningCount').textContent = banks.lightning || 0;
            document.getElementById('otherBanksCount').textContent = banks.others || 0;
        }

        function displayDeposits(deposits) {
            const container = document.getElementById('depositsContainer');
            
            if (deposits.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h3>No hay dep√≥sitos pendientes</h3>
                        <p>Todos los dep√≥sitos han sido procesados</p>
                    </div>
                `;
                return;
            }

            const table = `
                <table class="deposits-table">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Monto</th>
                            <th>Banco</th>
                            <th>Referencia</th>
                            <th>Estado</th>
                            <th>Creado</th>
                            <th>Tiempo Rest.</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${deposits.map(deposit => `
                            <tr>
                                <td>
                                    <strong>${deposit.user_id}</strong><br>
                                    <small>Cuenta: ${deposit.user_account_number || deposit.account || 'LOCAL-' + deposit.user_id.slice(-4)}</small>
                                </td>
                                <td>
                                    <strong>${formatCurrency(deposit.amount, deposit.currency)}</strong><br>
                                    <small>Neto: ${formatCurrency(deposit.net_amount, deposit.currency)}</small>
                                </td>
                                <td>${deposit.bank_name}</td>
                                <td><span class="reference-code">${deposit.reference_number}</span></td>
                                <td>
                                    <span class="status-badge status-${deposit.status.replace('_', '-')}">
                                        ${deposit.status_description}
                                    </span>
                                </td>
                                <td>
                                    ${new Date(deposit.created_at).toLocaleDateString('es-ES')}<br>
                                    <small>${new Date(deposit.created_at).toLocaleTimeString('es-ES')}</small>
                                </td>
                                <td>
                                    ${deposit.time_remaining ? 
                                        Math.round(deposit.time_remaining) + 'h' : 
                                        '<span style="color: var(--danger-color);">Expirado</span>'
                                    }
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        ${deposit.receipt ? `
                                            <button class="btn btn-info" onclick="showReceiptModal('${deposit.id}', '${deposit.receipt.filename}')" style="margin-bottom: 4px;">
                                                <i class="fas fa-receipt"></i> Ver Comprobante
                                            </button>
                                            <br>
                                        ` : ''}
                                        ${deposit.status === 'under_review' ? `
                                            <button class="btn btn-success" onclick="approveAppeal('${deposit.id}')" style="margin-bottom: 4px;">
                                                <i class="fas fa-check-circle"></i> Aprobar Apelaci√≥n
                                            </button>
                                            <button class="btn btn-warning" onclick="requestNewReceipt('${deposit.id}')" style="margin-bottom: 4px;">
                                                <i class="fas fa-camera"></i> Solicitar Nueva Imagen
                                            </button>
                                            <button class="btn btn-reject" onclick="rejectAppeal('${deposit.id}')">
                                                <i class="fas fa-times-circle"></i> Rechazar Apelaci√≥n
                                            </button>
                                        ` : `
                                            ${deposit.receipt ? `
                                                <button class="btn" onclick="requestNewReceipt('${deposit.id}')" style="background: #f59e0b; color: white; margin-bottom: 4px;">
                                                    <i class="fas fa-image"></i> Solicitar Imagen
                                                </button>
                                            ` : ''}
                                            <button class="btn btn-confirm" onclick="showConfirmModal('${deposit.id}')">
                                                <i class="fas fa-check"></i> Confirmar
                                            </button>
                                            <button class="btn btn-reject" onclick="showRejectModal('${deposit.id}')">
                                                <i class="fas fa-times"></i> Rechazar
                                            </button>
                                        `}
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = table;
        }

        function showConfirmModal(depositId) {
            currentDepositId = depositId;
            const modal = document.getElementById('confirmModal');
            
            // Find deposit info
            const depositInfo = getCurrentDepositInfo(depositId);
            document.getElementById('confirmDepositInfo').innerHTML = `
                <div style="background: rgba(16, 185, 129, 0.1); border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                    <h4 style="color: var(--success-color); margin-bottom: 8px;">Confirmar Dep√≥sito</h4>
                    <p><strong>Usuario:</strong> ${escapeHtml(depositInfo.user_id)}</p>
                    <p><strong>Monto:</strong> ${formatCurrency(depositInfo.amount, depositInfo.currency || 'USD')}</p>
                    <p><strong>Referencia:</strong> ${escapeHtml(depositInfo.reference_number)}</p>
                    <p><strong>Banco:</strong> ${escapeHtml(depositInfo.bank_name)}</p>
                </div>
            `;
            
            // Clear form
            document.getElementById('receivedAmount').value = '';
            document.getElementById('adminNotes').value = '';
            
            modal.style.display = 'flex';
        }

        // üîî ENHANCED NOTIFICATION SYSTEM - localStorage + API integration
        async function requestNewReceipt(depositId) {
            const message = prompt('Mensaje para el usuario sobre la nueva imagen requerida:',
                'Su comprobante actual no es v√°lido. Por favor, suba una nueva imagen clara del comprobante de transferencia.');
            if (!message) return;

            try {
                // Find the deposit information
                const depositInfo = getCurrentDepositInfo(depositId);

                // Create notification object
                const notification = {
                    id: `notify_${Date.now()}`,
                    deposit_id: depositId,
                    user_id: depositInfo.user_id,
                    message: message,
                    admin_id: currentUser.username || 'Admin',
                    created_at: new Date().toISOString(),
                    type: 'resubmit_request',
                    acknowledged: false
                };

                // Update transaction status directly (simple sync)
                let updates = JSON.parse(localStorage.getItem('latanda_transaction_updates') || '{}');
                updates[depositId] = {
                    status: 'resubmit_required',
                    message: message,
                    admin_id: currentUser.username || 'Admin',
                    timestamp: new Date().toISOString(),
                    type: 'admin_request_image'
                };
                localStorage.setItem('latanda_transaction_updates', JSON.stringify(updates));

                // Also try to send via API for persistence (fallback if API not available)
                try {
                    await makeAuthenticatedRequest('https://latanda.online/api/admin/request-resubmit', {
                        method: 'POST',
                        body: JSON.stringify({
                            deposit_id: depositId,
                            user_id: depositInfo.user_id,
                            message: message,
                            admin_id: currentUser.username || 'Admin'
                        })
                    });
                } catch (apiError) {
                }

                // Show success message
                showNotification('‚úÖ Solicitud de nueva imagen enviada. El usuario ver√° la notificaci√≥n en su wallet.', 'success');

                // Refresh deposits to update status
                setTimeout(() => loadPendingDeposits(), 1000);

            } catch (error) {
                showNotification('‚ùå Error al enviar solicitud. Int√©ntelo de nuevo.', 'error');
            }
        }

        function showRejectModal(depositId) {
            currentDepositId = depositId;
            const modal = document.getElementById('rejectModal');
            
            // Find deposit info
            const depositInfo = getCurrentDepositInfo(depositId);
            document.getElementById('rejectDepositInfo').innerHTML = `
                <div style="background: rgba(239, 68, 68, 0.1); border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                    <h4 style="color: var(--danger-color); margin-bottom: 8px;">Rechazar Dep√≥sito</h4>
                    <p><strong>Usuario:</strong> ${escapeHtml(depositInfo.user_id)}</p>
                    <p><strong>Monto:</strong> ${formatCurrency(depositInfo.amount, depositInfo.currency || 'USD')}</p>
                    <p><strong>Referencia:</strong> ${escapeHtml(depositInfo.reference_number)}</p>
                    <p><strong>Banco:</strong> ${escapeHtml(depositInfo.bank_name)}</p>
                </div>
            `;
            
            // Clear form
            document.getElementById('rejectionReason').value = '';
            document.getElementById('rejectNotes').value = '';
            
            modal.style.display = 'flex';
        }

        function getCurrentDepositInfo(depositId) {
            try {
                // Try to find deposit info from stored data first
                if (window.depositsData && window.depositsData[depositId]) {
                    return window.depositsData[depositId];
                }

                // Fallback to DOM extraction with safer method
                const rows = document.querySelectorAll('.deposits-table tbody tr');
                for (let row of rows) {
                    try {
                        // Check if this row contains the depositId
                        const buttons = row.querySelectorAll('button[onclick*="' + depositId + '"]');
                        if (buttons.length > 0) {
                            const cells = row.cells;
                            if (cells && cells.length >= 4) {
                                const userStrong = cells[0]?.querySelector('strong');
                                const amountStrong = cells[1]?.querySelector('strong');

                                return {
                                    user_id: userStrong?.textContent || 'user_001',
                                    amount: amountStrong?.textContent || '0.00',
                                    bank_name: cells[2]?.textContent || 'Banco Desconocido',
                                    reference_number: cells[3]?.textContent || depositId
                                };
                            }
                        }
                    } catch (rowError) {
                        continue;
                    }
                }

                // Fallback data if nothing found
                return {
                    user_id: 'user_001',
                    amount: '0.00',
                    bank_name: 'Banco Desconocido',
                    reference_number: depositId
                };
            } catch (error) {
                return {
                    user_id: 'user_001',
                    amount: '0.00',
                    bank_name: 'Banco Desconocido',
                    reference_number: depositId || 'unknown'
                };
            }
        }

        async function executeConfirm() {
            if (!currentDepositId) return;

            const receivedAmount = parseFloat(document.getElementById('receivedAmount').value) || null;
            const adminNotes = document.getElementById('adminNotes').value.trim();

            // Check if we're in development mode
            const isLocalDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

            try {
                if (isLocalDev) {
                    // Handle local confirmation

                    // Update local transaction data
                    const walletTransactions = JSON.parse(localStorage.getItem('transactionHistory') || '[]');
                    const transactionIndex = walletTransactions.findIndex(tx => tx.id === currentDepositId);

                    if (transactionIndex !== -1) {
                        const transaction = walletTransactions[transactionIndex];
                        const finalAmount = receivedAmount || transaction.amount;

                        // Update transaction status
                        walletTransactions[transactionIndex].status = 'completed';
                        walletTransactions[transactionIndex].confirmedAmount = finalAmount;
                        walletTransactions[transactionIndex].adminNotes = adminNotes;
                        walletTransactions[transactionIndex].confirmedAt = new Date().toISOString();
                        walletTransactions[transactionIndex].confirmedBy = 'admin_local';
                        walletTransactions[transactionIndex].pendingVerification = false;
                        walletTransactions[transactionIndex].canAppeal = false;
                        walletTransactions[transactionIndex].canResubmit = false;

                        localStorage.setItem('transactionHistory', JSON.stringify(walletTransactions));

                        // Update wallet balance (simulate adding to balance)
                        const balances = JSON.parse(localStorage.getItem('la_tanda_balances') || '{"USD": 0, "HNL": 0}');
                        const currency = transaction.currency || 'USD';
                        balances[currency] = (balances[currency] || 0) + finalAmount;
                        localStorage.setItem('la_tanda_balances', JSON.stringify(balances));
                    }

                    // Record admin action
                    const adminActions = JSON.parse(localStorage.getItem('la_tanda_admin_actions') || '[]');
                    adminActions.push({
                        type: 'approved',
                        depositId: currentDepositId,
                        confirmedAmount: receivedAmount,
                        notes: adminNotes,
                        timestamp: new Date().toISOString(),
                        adminId: 'admin_local'
                    });
                    localStorage.setItem('la_tanda_admin_actions', JSON.stringify(adminActions));

                    showNotification('Dep√≥sito confirmado exitosamente (modo desarrollo)', 'success');
                    closeModal();

                    // Force refresh to show updated status immediately
                    setTimeout(() => {
                        loadDepositsByStatus(); // Refresh with new tabbed system
                    }, 500);

                } else {
                    // Production API call
                    const response = await makeAuthenticatedRequest('https://latanda.online/api/admin/deposits/confirm', {
                        method: 'POST',
                        body: JSON.stringify({
                            deposit_id: currentDepositId,
                            admin_id: currentUser.username,
                            admin_notes: adminNotes,
                            received_amount: receivedAmount
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        showNotification('Dep√≥sito confirmado exitosamente', 'success');
                        closeModal();
                        loadPendingDeposits(); // Refresh the list
                    } else {
                        throw new Error(data.message || 'Error confirming deposit');
                    }
                }
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            }
        }

        async function executeReject() {
            if (!currentDepositId) return;

            const rejectionReason = document.getElementById('rejectionReason').value;
            const adminNotes = document.getElementById('rejectNotes').value.trim();

            if (!rejectionReason) {
                showNotification('Debe seleccionar una raz√≥n de rechazo', 'error');
                return;
            }

            // Check if we're in development mode
            const isLocalDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

            try {
                if (isLocalDev) {
                    // Handle local rejection

                    // Update local transaction data
                    const walletTransactions = JSON.parse(localStorage.getItem('transactionHistory') || '[]');
                    const transactionIndex = walletTransactions.findIndex(tx => tx.id === currentDepositId);

                    if (transactionIndex !== -1) {
                        walletTransactions[transactionIndex].status = 'rejected';
                        walletTransactions[transactionIndex].rejectionReason = rejectionReason;
                        walletTransactions[transactionIndex].adminNotes = adminNotes;
                        walletTransactions[transactionIndex].rejectedAt = new Date().toISOString();
                        walletTransactions[transactionIndex].rejectedBy = 'admin_local';
                        walletTransactions[transactionIndex].pendingVerification = false;
                        walletTransactions[transactionIndex].canAppeal = true;
                        walletTransactions[transactionIndex].canResubmit = true;

                        localStorage.setItem('transactionHistory', JSON.stringify(walletTransactions));
                    }

                    // Record admin action
                    const adminActions = JSON.parse(localStorage.getItem('la_tanda_admin_actions') || '[]');
                    adminActions.push({
                        type: 'rejected',
                        depositId: currentDepositId,
                        reason: rejectionReason,
                        notes: adminNotes,
                        timestamp: new Date().toISOString(),
                        adminId: 'admin_local'
                    });
                    localStorage.setItem('la_tanda_admin_actions', JSON.stringify(adminActions));

                    showNotification('Dep√≥sito rechazado exitosamente (modo desarrollo)', 'success');
                    closeModal();

                    // Force refresh to show updated status immediately
                    setTimeout(() => {
                        loadDepositsByStatus(); // Refresh with new tabbed system
                    }, 500);

                } else {
                    // Production API call
                    const response = await makeAuthenticatedRequest('https://latanda.online/api/admin/deposits/reject', {
                        method: 'POST',
                        body: JSON.stringify({
                            deposit_id: currentDepositId,
                            admin_id: currentUser.username,
                            rejection_reason: rejectionReason,
                            admin_notes: adminNotes
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        showNotification('Dep√≥sito rechazado exitosamente', 'success');
                        closeModal();
                        loadPendingDeposits(); // Refresh the list
                    } else {
                        throw new Error(data.message || 'Error rejecting deposit');
                    }
                }
            } catch (error) {
                showNotification('Error: ' + error.message, 'error');
            }
        }

        function showReceiptModal(depositId, filename) {
            if (!filename) {
                showNotification('No hay comprobante disponible', 'error');
                return;
            }


            // Check if we have local sample data with fileUrl
            let imageUrl = `https://latanda.online/api/receipt/${escapeHtml(filename)}`;
            let isLocalData = false;

            // Look for receipt in our local sample data
            if (window.adminPanelDeposits) {
                const deposit = window.adminPanelDeposits.find(d => d.id === depositId);

                if (deposit && deposit._localData && deposit._localData.fileUrl) {
                    imageUrl = deposit._localData.fileUrl;
                    isLocalData = true;
                } else {
                    // Fallback: check if we have global sample data
                    const localReceiptData = [
                        { id: 'receipt_sample_high_', fileUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjUwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iYmciIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojZjRmNGY0O3N0b3Atb3BhY2l0eToxIiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNlMGUwZTA7c3RvcC1vcGFjaXR5OjEiIC8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI2JnKSIgc3Ryb2tlPSIjY2NjIiBzdHJva2Utd2lkdGg9IjIiLz4KICA8IS0tIEhlYWRlciAtLT4KICA8cmVjdCB4PSIwIiB5PSIwIiB3aWR0aD0iNDAwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjMDA2NmNjIi8+CiAgPHRleHQgeD0iMjAiIHk9IjMwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSJ3aGl0ZSI+QmFuY28gQXRsw6FudGlkYTwvdGV4dD4KICA8dGV4dCB4PSIyMCIgeT0iNTUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0id2hpdGUiPkNvbXByb2JhbnRlIGRlIERlcMOzc2l0bzwvdGV4dD4KICA8IS0tIEFtb3VudCAtLT4KICA8dGV4dCB4PSIyMCIgeT0iMTMwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiMzMzMiPk1vbnRvOjwvdGV4dD4KICA8dGV4dCB4PSIyMCIgeT0iMTYwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjgiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSIjMDA2NmNjIj4kNTAwLjAwIFVTRDwvdGV4dD4KICA8IS0tIERldGFpbHMgLS0+CiAgPHRleHQgeD0iMjAiIHk9IjIxMCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjNTU1Ij5SZWZlcmVuY2lhOiBBVEwxNzU3MzUyMTk0MDcyPC90ZXh0PgogIDx0ZXh0IHg9IjIwIiB5PSIyNDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzU1NSI+RmVjaGE6IDI1LzkvMjAyNTwvdGV4dD4KICA8dGV4dCB4PSIyMCIgeT0iMjcwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM1NTUiPkhvcmE6IDA3OjQ3OjQyPC90ZXh0PgogIDx0ZXh0IHg9IjIwIiB5PSIzMDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzU1NSI+VGlwbzogRGVww7NzaXRvIEVsZWN0csOzbmljbzwvdGV4dD4KICA8IS0tIFN0YW1wIC0tPgogIDxyZWN0IHg9IjI1MCIgeT0iMzUwIiB3aWR0aD0iMTMwIiBoZWlnaHQ9IjUwIiBmaWxsPSJub25lIiBzdHJva2U9IiMwMGNjNjYiIHN0cm9rZS13aWR0aD0iMyIgc3Ryb2tlLWRhc2hhcnJheT0iNSw1IiB0cmFuc2Zvcm09InJvdGF0ZSgtMTUgMzE1IDM3NSkiLz4KICA8dGV4dCB4PSIzMTUiIHk9IjM4NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE2IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iIzAwY2M2NiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgdHJhbnNmb3JtPSJyb3RhdGUoLTE1IDMxNSAzODUpIj5WQUxJREFETzwvdGV4dD4KPC9zdmc+'},
                        { id: 'receipt_sample_med_', fileUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjUwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iYmcyIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6I2ZmZjhmODtzdG9wLW9wYWNpdHk6MSIgLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojZmRkOWQ5O3N0b3Atb3BhY2l0eToxIiAvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICA8L2RlZnM+CiAgPHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0idXJsKCNiZzIpIiBzdHJva2U9IiNlZGE0YTQiIHN0cm9rZS13aWR0aD0iMiIvPgogIDx0ZXh0IHg9IjIwIiB5PSIzMCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE4IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iIzk5MTgyOCI+QmFuY28gQXRsw6FudGlkYTwvdGV4dD4KICA8dGV4dCB4PSIyMCIgeT0iNTUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzc5MjQyNCI+Q29tcHJvYmFudGUgZGUgRGVww7NzaXRvPC90ZXh0PgogIDx0ZXh0IHg9IjIwIiB5PSIxMzAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzM3Mzc0MSI+TW9udG86PC90ZXh0PgogIDx0ZXh0IHg9IjIwIiB5PSIxNjAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyOCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiNkYzI2MjYiPiQyNTAuMDAgVVNEPC90ZXh0PgogIDx0ZXh0IHg9IjIwIiB5PSIxOTAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2RjMjYyNiI+KE9DUiBkZXRlY3TDszogJDI0NS4wMCk8L3RleHQ+CiAgPHRleHQgeD0iMjAiIHk9IjI0MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjNTU1Ij5SZWZlcmVuY2lhOiBBVEwxNzU3OTk5ODg4Nzc3PC90ZXh0PgogIDx0ZXh0IHg9IjIwIiB5PSIyNzAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzU1NSI+RmVjaGE6IDI1LzkvMjAyNTwvdGV4dD4KICA8dGV4dCB4PSIyMCIgeT0iMzAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM1NTUiPkhvcmE6IDA5OjAyOjQyPC90ZXh0PgogIDxyZWN0IHg9IjI1MCIgeT0iMzUwIiB3aWR0aD0iMTMwIiBoZWlnaHQ9IjUwIiBmaWxsPSJub25lIiBzdHJva2U9IiNmZjc5NzUiIHN0cm9rZS13aWR0aD0iMyIgc3Ryb2tlLWRhc2hhcnJheT0iNSw1IiB0cmFuc2Zvcm09InJvdGF0ZSgtMTUgMzE1IDM3NSkiLz4KICA8dGV4dCB4PSIzMTUiIHk9IjM4NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iI2VmNDQ0NCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgdHJhbnNmb3JtPSJyb3RhdGUoLTE1IDMxNSAzODUpIj5SRVZJU0lPTiBNQU5VQUw8L3RleHQ+Cjwvc3ZnPg==' },
                        { id: 'receipt_sample_low_', fileUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjUwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iYmc0IiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6I2Y3ZjdmNztzdG9wLW9wYWNpdHk6MSIgLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojZDFkMWQxO3N0b3Atb3BhY2l0eToxIiAvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICA8L2RlZnM+CiAgPHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0idXJsKCNiZzQpIiBzdHJva2U9IiNhM2EzYTMiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWRhc2hhcnJheT0iNSw1Ii8+CiAgPHRleHQgeD0iMjAiIHk9IjMwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSIjNmI3Mjc5Ij5CYW5jbyBBdGzDoW50aWRhPC90ZXh0PgogIDx0ZXh0IHg9IjIwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjNmI3Mjc5Ij5Db21wcm9iYW50ZSBkZSBEZXDDs2l0bzwvdGV4dD4KICA8IS0tIEJsdXJyeSB0ZXh0IGVmZmVjdCAtLT4KICA8dGV4dCB4PSIyMCIgeT0iMTMwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiM5Y2EzYWYiIGZpbHRlcj0iYmx1cigycHgpIj5Nb250bzo8L3RleHQ+CiAgPHRleHQgeD0iMjAiIHk9IjE2MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjI4IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iIzZiNzI3OSIgZmlsdGVyPSJibHVyKDNweCkiPiQ3NS4wMCBVU0Q8L3RleHQ+CiAgPCEtLSBCbHVycnkgZGV0YWlscyAtLT4KICA8dGV4dCB4PSIyMCIgeT0iMjQwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5Y2EzYWYiIGZpbHRlcj0iYmx1cigycHgpIj5SZWZlcmVuY2lhOiBBVEwxNzU3Li4uIGJvcnJvc288L3RleHQ+CiAgPHRleHQgeD0iMjAiIHk9IjI3MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOWNhM2FmIiBmaWx0ZXI9ImJsdXIoMnB4KSI+RmVjaGE6IDI1Lz4uLi5ib3Jyb3NhPC90ZXh0PgogIDx0ZXh0IHg9IjIwIiB5PSIzMDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzljYTNhZiIgZmlsdGVyPSJibHVyKDJweCkiPkhvcmE6IDI5Oj8/Oj8/PC90ZXh0PgogIDxyZWN0IHg9IjI1MCIgeT0iMzUwIiB3aWR0aD0iMTMwIiBoZWlnaHQ9IjUwIiBmaWxsPSJub25lIiBzdHJva2U9IiNmZjU5MjEiIHN0cm9rZS13aWR0aD0iNCIgc3Ryb2tlLWRhc2hhcnJheT0iMywyIiB0cmFuc2Zvcm09InJvdGF0ZSgtMTUgMzE1IDM3NSkiLz4KICA8dGV4dCB4PSIzMTUiIHk9IjM4NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iI2VhNTgyZCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgdHJhbnNmb3JtPSJyb3RhdGUoLTE1IDMxNSAzODUpIj5JTEVHSUJMRTwvdGV4dD4KPC9zdmc+'}
                    ];

                    // Try to match by ID pattern
                    for (const localReceipt of localReceiptData) {
                        if (depositId.includes(localReceipt.id)) {
                            imageUrl = localReceipt.fileUrl;
                            isLocalData = true;
                            break;
                        }
                    }
                }
            } else {
            }

            const modal = document.createElement('div');
            modal.id = 'receiptModal';
            modal.className = 'modal';
            modal.style.display = 'flex';

            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
                    <h3 class="modal-header" style="flex-shrink: 0;">
                        <i class="fas fa-receipt"></i> Comprobante de Pago
                        <button onclick="closeReceiptModal()" style="background: none; border: none; color: var(--text-secondary); float: right; font-size: 20px; cursor: pointer;">&times;</button>
                    </h3>

                    <div style="margin-bottom: 15px; padding: 10px; background: rgba(0, 255, 255, 0.1); border-radius: 8px; flex-shrink: 0;">
                        <p style="margin: 0; color: var(--text-primary); font-size: 14px;">
                            <strong>Dep√≥sito:</strong> ${depositId}<br>
                            <strong>Archivo:</strong> ${escapeHtml(filename)}
                            ${isLocalData ? '<br><small style="color: var(--warning-color);"><i class="fas fa-database"></i> Datos de desarrollo</small>' : ''}
                        </p>
                    </div>

                    <div style="text-align: center; flex: 1; overflow-y: auto; min-height: 0;">
                        <img id="receiptImage"
                             src="${imageUrl}"
                             style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);"
                             alt="Comprobante">

                        <div id="receiptError" style="display: none; padding: 20px; color: var(--danger-color);">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>No se pudo cargar la imagen del comprobante.</p>
                            ${!isLocalData ? `<a href="${imageUrl}" target="_blank" rel="noopener noreferrer" style="color: var(--primary-color);">Intentar abrir en nueva ventana</a>` : '<p style="color: var(--text-secondary);">Imagen de desarrollo no disponible</p>'}
                        </div>
                    </div>

                    <div style="margin-top: 20px; text-align: center;">
                        ${!isLocalData ? `<button onclick="window.open('${imageUrl}', '_blank')" class="btn btn-info" style="margin-right: 10px;"><i class="fas fa-external-link-alt"></i> Abrir en Nueva Ventana</button>` : ''}
                        <button onclick="closeReceiptModal()" class="btn btn-cancel">
                            <i class="fas fa-times"></i> Cerrar
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }
        
        function closeReceiptModal() {
            const modal = document.getElementById('receiptModal');
            if (modal) {
                modal.remove();
            }
        }

        function closeModal() {
            // Close deposit modals
            document.getElementById('confirmModal').style.display = 'none';
            document.getElementById('rejectModal').style.display = 'none';

            // Close withdrawal modals
            document.getElementById('withdrawalDetailsModal').style.display = 'none';
            document.getElementById('processWithdrawalModal').style.display = 'none';
            document.getElementById('rejectWithdrawalModal').style.display = 'none';

            closeReceiptModal();
            currentDepositId = null;

            // Clear withdrawal processing variables
            window.currentWithdrawalDetails = null;
            window.currentProcessingWithdrawal = null;
            window.currentRejectingWithdrawal = null;
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Trigger animation
            setTimeout(() => notification.classList.add('show'), 100);
            
            // Remove after 5 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 5000);
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                closeModal();
            }
        });

        // Appeal approval/rejection functions
        function approveAppeal(depositId) {
            if (confirm('¬øAprobar esta apelaci√≥n? El dep√≥sito ser√° confirmado.')) {
                try {
                    // Update transaction status to approved
                    let updates = JSON.parse(localStorage.getItem('latanda_transaction_updates') || '{}');
                    updates[depositId] = {
                        status: 'confirmed',
                        message: 'Apelaci√≥n aprobada por administrador',
                        admin_id: currentUser.username || 'Admin',
                        timestamp: new Date().toISOString(),
                        type: 'admin_approval'
                    };
                    localStorage.setItem('latanda_transaction_updates', JSON.stringify(updates));

                    showNotification('‚úÖ Apelaci√≥n aprobada. Dep√≥sito confirmado.', 'success');

                    // Refresh deposits view
                    setTimeout(loadPendingDeposits, 1000);

                } catch (error) {
                    showNotification('Error aprobando apelaci√≥n', 'error');
                }
            }
        }

        function rejectAppeal(depositId) {
            const reason = prompt('Motivo del rechazo de la apelaci√≥n:');
            if (reason && reason.trim()) {
                try {
                    // Update transaction status to rejected
                    let updates = JSON.parse(localStorage.getItem('latanda_transaction_updates') || '{}');
                    updates[depositId] = {
                        status: 'rejected',
                        message: `Apelaci√≥n rechazada: ${reason.trim()}`,
                        admin_id: currentUser.username || 'Admin',
                        timestamp: new Date().toISOString(),
                        type: 'admin_rejection',
                        rejection_reason: reason.trim()
                    };
                    localStorage.setItem('latanda_transaction_updates', JSON.stringify(updates));

                    showNotification('‚ùå Apelaci√≥n rechazada.', 'error');

                    // Refresh deposits view
                    setTimeout(loadPendingDeposits, 1000);

                } catch (error) {
                    showNotification('Error rechazando apelaci√≥n', 'error');
                }
            }
        }

        // Auto-refresh disabled for local development to prevent loops
        // setInterval(() => {
        //     const isLocalDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        //     if (!isLocalDev || !(currentUser && currentUser.id && currentUser.id.includes('local'))) {
        //         loadPendingDeposits();
        //     }
        // }, 30000);

        // ================================
        // üí∞ TANDA COMMISSION CALCULATION
        // ================================

        function calculateTandaCommissions(totalAmount, numberOfParticipants) {
            // Comisi√≥n total sobre el monto
            const COMMISSION_RATE = 0.10; // 10% comisi√≥n total
            const totalCommission = totalAmount * COMMISSION_RATE;

            // Distribuci√≥n seg√∫n sistema 90/10
            const commissionDistribution = {
                // 90% para el coordinador/creador directo de la Tanda
                creator_commission: totalCommission * 0.90,

                // 10% distribuido en niveles superiores
                level_2_commission: totalCommission * 0.05, // 5% del total
                level_3_commission: totalCommission * 0.03, // 3% del total
                level_4_commission: totalCommission * 0.02, // 2% del total

                // C√°lculo del monto EXACTO para el ganador del ciclo
                cycle_winner_amount: totalAmount - totalCommission
            };

            return {
                total_collected: totalAmount,
                total_commission: totalCommission,
                distribution: commissionDistribution,

                // DATOS PARA ADMIN PANEL
                admin_panel_instructions: {
                    // Monto EXACTO a transferir al ganador
                    transfer_to_winner: commissionDistribution.cycle_winner_amount,

                    // Comisiones a distribuir
                    coordinator_payment: commissionDistribution.creator_commission,
                    level_2_payment: commissionDistribution.level_2_commission,
                    level_3_payment: commissionDistribution.level_3_commission,
                    level_4_payment: commissionDistribution.level_4_commission,

                    // Para notificaci√≥n al usuario
                    commission_breakdown: {
                        gross_amount: totalAmount,
                        commission_deducted: totalCommission,
                        net_received: commissionDistribution.cycle_winner_amount,
                        commission_rate: '10%'
                    }
                },

                // Formato para mostrar en el admin panel
                formatted_summary: `
                    üí∞ Tanda de ${formatCurrency(totalAmount)}
                    üìä Comisi√≥n total: ${formatCurrency(totalCommission)} (10%)
                    üë§ Al ganador: ${formatCurrency(commissionDistribution.cycle_winner_amount)}
                    üéØ Al coordinador: ${formatCurrency(commissionDistribution.creator_commission)}
                `
            };
        }

        function processTandaPayout(tandaData) {
            // Calcular comisiones usando la funci√≥n alineada
            const commissionData = calculateTandaCommissions(
                tandaData.total_amount,
                tandaData.participants_count
            );

            // Crear transacci√≥n para el admin panel
            const transaction = {
                id: 'tanda_' + Date.now(),
                type: 'tanda_payout',
                tanda_id: tandaData.tanda_id,
                winner_user_id: tandaData.cycle_winner,

                // Montos calculados
                gross_amount: commissionData.total_collected,
                commission_amount: commissionData.total_commission,
                net_amount: commissionData.admin_panel_instructions.transfer_to_winner,

                // Distribuci√≥n de comisiones
                coordinator_commission: commissionData.admin_panel_instructions.coordinator_payment,
                level_commissions: {
                    level_2: commissionData.admin_panel_instructions.level_2_payment,
                    level_3: commissionData.admin_panel_instructions.level_3_payment,
                    level_4: commissionData.admin_panel_instructions.level_4_payment
                },

                // Estado y metadata
                status: 'pending_admin_approval',
                created_at: new Date().toISOString(),
                currency: tandaData.currency,

                // Para mostrar en el admin panel
                display_summary: commissionData.formatted_summary
            };

            return transaction;
        }

        function formatCurrency(amount, currency = 'USD') {
            // Handle special formatting for different currencies
            const locale = currency === 'HNL' ? 'es-HN' : 'en-US';

            try {
                return new Intl.NumberFormat(locale, {
                    style: 'currency',
                    currency: currency,
                    minimumFractionDigits: 2
                }).format(amount);
            } catch (error) {
                // Fallback for unsupported currencies
                const symbols = {
                    'USD': '$',
                    'HNL': 'L',
                    'EUR': '‚Ç¨',
                    'BTC': '‚Çø'
                };
                const symbol = symbols[currency] || currency;
                return `${symbol} ${amount.toFixed(2)}`;
            }
        }

        // ================================
        // üéØ ADMIN PANEL TANDA INTEGRATION
        // ================================

        function showTandaCommissionBreakdown(transaction) {
            if (transaction.type !== 'tanda_payout') return '';

            return `
                <div class="commission-breakdown">
                    <h4>üí∞ Desglose de Comisiones</h4>
                    <div class="breakdown-grid">
                        <div class="breakdown-item">
                            <label>Monto bruto recaudado:</label>
                            <span>${formatCurrency(transaction.gross_amount, transaction.currency)}</span>
                        </div>
                        <div class="breakdown-item commission">
                            <label>Comisi√≥n total (10%):</label>
                            <span>-${formatCurrency(transaction.commission_amount, transaction.currency)}</span>
                        </div>
                        <div class="breakdown-item net">
                            <label>üéØ A transferir al ganador:</label>
                            <span>${formatCurrency(transaction.net_amount, transaction.currency)}</span>
                        </div>
                    </div>

                    <div class="commission-distribution">
                        <h5>üìä Distribuci√≥n de Comisiones:</h5>
                        <div class="commission-list">
                            <div class="commission-item">
                                <span>üëë Coordinador (90%):</span>
                                <span>${formatCurrency(transaction.coordinator_commission, transaction.currency)}</span>
                            </div>
                            <div class="commission-item">
                                <span>üë• Nivel 2 (5%):</span>
                                <span>${formatCurrency(transaction.level_commissions.level_2, transaction.currency)}</span>
                            </div>
                            <div class="commission-item">
                                <span>üë• Nivel 3 (3%):</span>
                                <span>${formatCurrency(transaction.level_commissions.level_3, transaction.currency)}</span>
                            </div>
                            <div class="commission-item">
                                <span>üë• Nivel 4 (2%):</span>
                                <span>${formatCurrency(transaction.level_commissions.level_4, transaction.currency)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Enhanced Receipt Preview Modal
        function showReceiptPreview(depositId) {
            const deposit = document.querySelector(`[data-deposit-id="${depositId}"]`);
            if (!deposit) return;

            // Get receipt data from our local system if available
            let receiptData = null;
            if (deposit.dataset.localData === 'true' && receiptManager) {
                // Find transaction first to get receiptId
                const transaction = JSON.parse(localStorage.getItem('transactionHistory') || '[]')
                    .find(tx => tx.id === depositId);

                if (transaction && transaction.receiptId) {
                    // Find receipt using transaction's receiptId
                    const receipt = receiptManager.receipts.find(r => r.id === transaction.receiptId);
                    if (receipt) {
                        receiptData = receipt;
                    } else {
                    }
                } else {
                }
            }

            const modal = document.createElement('div');
            modal.className = 'receipt-preview-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.9);
                backdrop-filter: blur(8px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10001;
                padding: 20px;
            `;

            modal.innerHTML = `
                <div class="receipt-modal-content" style="
                    background: var(--bg-secondary);
                    border-radius: 16px;
                    width: 100%;
                    max-width: 900px;
                    max-height: 90vh;
                    overflow-y: auto;
                    border: 1px solid var(--border-color);
                    backdrop-filter: blur(24px);
                    display: flex;
                    gap: 20px;
                    padding: 24px;
                ">
                    <div class="receipt-image-section" style="flex: 1;">
                        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: var(--text-primary); margin: 0;">Vista Previa del Comprobante</h3>
                            <button onclick="this.closest('.receipt-preview-modal').remove()" style="
                                background: transparent;
                                border: none;
                                color: var(--text-secondary);
                                font-size: 1.25rem;
                                cursor: pointer;
                                padding: 8px;
                                border-radius: 8px;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.background='rgba(239, 68, 68, 0.1)'; this.style.color='#ef4444';" onmouseout="this.style.background='transparent'; this.style.color='var(--text-secondary)';">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        ${receiptData && receiptData.dataUrl ? `
                            <div class="receipt-image-container" style="
                                background: #000;
                                border-radius: 12px;
                                overflow: hidden;
                                margin-bottom: 16px;
                            ">
                                <img loading="lazy" id="receiptImage" src="${receiptData.dataUrl || '#'}" alt="Comprobante" style="
                                    width: 100%;
                                    height: auto;
                                    max-height: 500px;
                                    object-fit: contain;
                                ">
                            </div>
                            <div class="receipt-actions" style="display: flex; gap: 12px;">
                                <button onclick="downloadReceiptImage('${depositId}')" class="btn-secondary" style="
                                    flex: 1;
                                    padding: 10px;
                                    border-radius: 8px;
                                    border: 1px solid var(--border-color);
                                    background: transparent;
                                    color: var(--text-primary);
                                    cursor: pointer;
                                ">
                                    <i class="fas fa-download"></i> Descargar
                                </button>
                                <button onclick="openReceiptFullscreen('${depositId}')" class="btn-secondary" style="
                                    flex: 1;
                                    padding: 10px;
                                    border-radius: 8px;
                                    border: 1px solid var(--border-color);
                                    background: transparent;
                                    color: var(--text-primary);
                                    cursor: pointer;
                                ">
                                    <i class="fas fa-expand"></i> Pantalla Completa
                                </button>
                            </div>
                        ` : `
                            <div class="no-receipt" style="
                                text-align: center;
                                padding: 40px;
                                color: var(--text-secondary);
                                background: var(--bg-primary);
                                border-radius: 12px;
                                border: 2px dashed var(--border-color);
                            ">
                                <i class="fas fa-file-image" style="font-size: 3rem; margin-bottom: 16px; opacity: 0.5;"></i>
                                <p>No hay comprobante disponible</p>
                                <small>Este dep√≥sito no tiene un archivo de comprobante adjunto</small>
                            </div>
                        `}
                    </div>

                    <div class="receipt-details-section" style="flex: 1;">
                        <h4 style="color: var(--primary-color); margin-bottom: 16px;">Detalles del Dep√≥sito</h4>

                        <div class="deposit-info-card" style="
                            background: var(--bg-primary);
                            border-radius: 12px;
                            padding: 16px;
                            margin-bottom: 16px;
                        ">
                            <div class="info-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: var(--text-secondary);">ID:</span>
                                <span style="color: var(--text-primary); font-family: monospace;">${depositId}</span>
                            </div>
                            <div class="info-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: var(--text-secondary);">Monto:</span>
                                <span style="color: var(--primary-color); font-weight: bold;">$${receiptData?.expectedAmount || '0.00'} ${receiptData?.expectedCurrency || 'USD'}</span>
                            </div>
                            <div class="info-row" style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: var(--text-secondary);">M√©todo:</span>
                                <span style="color: var(--text-primary);">${receiptData?.method === 'atlantida' ? 'Banco Atl√°ntida' : 'Lightning Network'}</span>
                            </div>
                            <div class="info-row" style="display: flex; justify-content: space-between;">
                                <span style="color: var(--text-secondary);">Fecha:</span>
                                <span style="color: var(--text-primary);">${receiptData ? new Date(receiptData.uploadTime).toLocaleString('es-HN') : 'N/A'}</span>
                            </div>
                        </div>

                        ${receiptData?.ocrResult ? `
                            <h4 style="color: var(--primary-color); margin-bottom: 16px;">An√°lisis OCR</h4>
                            <div class="ocr-analysis-card" style="
                                background: var(--bg-primary);
                                border-radius: 12px;
                                padding: 16px;
                                margin-bottom: 16px;
                                border-left: 4px solid ${receiptData.ocrResult.confidence >= 80 ? '#22c55e' : receiptData.ocrResult.confidence >= 50 ? '#f59e0b' : '#ef4444'};
                            ">
                                <div class="ocr-confidence" style="margin-bottom: 12px;">
                                    <span style="color: var(--text-secondary);">Confianza del OCR:</span>
                                    <span style="
                                        color: ${receiptData.ocrResult.confidence >= 80 ? '#22c55e' : receiptData.ocrResult.confidence >= 50 ? '#f59e0b' : '#ef4444'};
                                        font-weight: bold;
                                        margin-left: 8px;
                                    ">${receiptData.ocrResult.confidence}%</span>
                                </div>

                                <div class="ocr-data">
                                    <div class="ocr-item" style="margin-bottom: 8px;">
                                        <span style="color: var(--text-secondary);">Monto detectado:</span>
                                        <span style="color: var(--text-primary); margin-left: 8px;">$${receiptData.ocrResult.extractedAmount || 'N/A'}</span>
                                    </div>
                                    <div class="ocr-item" style="margin-bottom: 8px;">
                                        <span style="color: var(--text-secondary);">Banco:</span>
                                        <span style="color: var(--text-primary); margin-left: 8px;">${receiptData.ocrResult.bankName || 'No detectado'}</span>
                                    </div>
                                    <div class="ocr-item" style="margin-bottom: 8px;">
                                        <span style="color: var(--text-secondary);">Fecha detectada:</span>
                                        <span style="color: var(--text-primary); margin-left: 8px;">${receiptData.ocrResult.date || 'No detectada'}</span>
                                    </div>
                                </div>

                                ${receiptData.ocrValidation?.issues?.length > 0 ? `
                                    <div class="validation-issues" style="
                                        margin-top: 12px;
                                        padding: 12px;
                                        background: rgba(239, 68, 68, 0.1);
                                        border-radius: 8px;
                                        border-left: 3px solid #ef4444;
                                    ">
                                        <h5 style="color: #ef4444; margin-bottom: 8px; font-size: 0.875rem;">‚ö†Ô∏è Problemas de Validaci√≥n:</h5>
                                        ${receiptData.ocrValidation.issues.map(issue => `
                                            <div style="color: #ef4444; font-size: 0.8rem; margin-bottom: 4px;">‚Ä¢ ${issue}</div>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <div class="validation-success" style="
                                        margin-top: 12px;
                                        padding: 8px 12px;
                                        background: rgba(34, 197, 94, 0.1);
                                        border-radius: 8px;
                                        color: #22c55e;
                                        font-size: 0.875rem;
                                    ">
                                        ‚úÖ Validaci√≥n exitosa
                                    </div>
                                `}
                            </div>
                        ` : ''}

                        <div class="admin-actions-section">
                            <h4 style="color: var(--primary-color); margin-bottom: 16px;">Acciones de Administrador</h4>
                            <div style="display: flex; gap: 12px;">
                                <button onclick="handleQuickApproval('${depositId}'); this.closest('.receipt-preview-modal').remove();" class="btn-success" style="
                                    flex: 1;
                                    padding: 12px;
                                    border-radius: 8px;
                                    border: none;
                                    background: linear-gradient(135deg, #22c55e, #16a34a);
                                    color: white;
                                    cursor: pointer;
                                    font-weight: 600;
                                ">
                                    <i class="fas fa-check"></i> Aprobar
                                </button>
                                <button onclick="handleQuickRejection('${depositId}'); this.closest('.receipt-preview-modal').remove();" class="btn-danger" style="
                                    flex: 1;
                                    padding: 12px;
                                    border-radius: 8px;
                                    border: none;
                                    background: linear-gradient(135deg, #ef4444, #dc2626);
                                    color: white;
                                    cursor: pointer;
                                    font-weight: 600;
                                ">
                                    <i class="fas fa-times"></i> Rechazar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Load receipt image if available
            if (receiptData && receiptData.file) {
                loadReceiptImage(receiptData, 'receiptImage');
            }
        }

        // Load receipt image from file data
        function loadReceiptImage(receiptData, imageElementId) {
            if (!receiptData.file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById(imageElementId);
                if (img) {
                    img.src = e.target.result;
                    receiptData.fileDataUrl = e.target.result; // Cache for future use
                }
            };
            reader.readAsDataURL(receiptData.file);
        }

        // Quick approval from modal
        function handleQuickApproval(depositId) {
            handleLocalDepositApproval(depositId, true);
        }

        // Quick rejection from modal
        function handleQuickRejection(depositId) {
            const reason = prompt('Raz√≥n del rechazo (opcional):');
            handleLocalDepositApproval(depositId, false, reason);
        }

        // Download receipt image
        function downloadReceiptImage(depositId) {
            if (!receiptManager) return;

            // Find transaction first to get receiptId
            const transaction = JSON.parse(localStorage.getItem('transactionHistory') || '[]')
                .find(tx => tx.id === depositId);

            if (!transaction || !transaction.receiptId) {
                return;
            }

            // Find receipt using transaction's receiptId
            const receipt = receiptManager.receipts.find(r => r.id === transaction.receiptId);
            if (!receipt || !receipt.dataUrl) {
                return;
            }

            const link = document.createElement('a');
            link.href = receipt.dataUrl;
            link.download = receipt.fileName || `receipt_${depositId}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Open receipt in fullscreen
        function openReceiptFullscreen(depositId) {
            if (!receiptManager) return;

            const receipt = receiptManager.receipts.find(r => r.id === depositId);
            if (!receipt || !receipt.fileDataUrl) return;

            const fullscreenWindow = window.open('', '_blank');
            fullscreenWindow.document.write(`
                <html>
                    <head>
                        <title>Comprobante - ${receipt.fileName}</title>
                        <style>
                            body { margin: 0; background: #000; display: flex; align-items: center; justify-content: center; }
                            img { max-width: 100vw; max-height: 100vh; object-fit: contain; }
                        </style>
                    </head>
                    <body>
                        <img loading="lazy" src="${receipt.fileDataUrl}" alt="Comprobante">
                    </body>
                </html>
            `);
        }
        // ========== USER MANAGEMENT FUNCTIONS ==========
        let currentUsersPage = 1;
        let currentUserForAction = null;

        async function loadUsers(page = 1) {
            currentUsersPage = page;
            const search = document.getElementById('userSearchInput').value;
            const status = document.getElementById('userStatusFilter').value;
            const tbody = document.getElementById('usersTableBody');
            
            tbody.innerHTML = '<tr><td colspan="7" style="padding: 40px; text-align: center;"><div class="loading"></div></td></tr>';
            
            try {
                const token = localStorage.getItem('admin_token') || localStorage.getItem('auth_token');
                let url = '/api/admin/users?page=' + page + '&limit=15';
                if (search) url += '&search=' + encodeURIComponent(search);
                if (status) url += '&status=' + status;
                
                const res = await fetch(url, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await res.json();
                
                if (data.success && data.data && data.data.users) {
                    renderUsersTable(data.data.users, data.data.pagination);
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" style="padding: 40px; text-align: center; color: var(--text-secondary);">Error al cargar usuarios</td></tr>';
                }
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="7" style="padding: 40px; text-align: center; color: #dc2626;">Error de conexion</td></tr>';
            }
        }

        function renderUsersTable(users, pagination) {
            const tbody = document.getElementById('usersTableBody');
            
            if (!users.length) {
                tbody.innerHTML = '<tr><td colspan="7" style="padding: 40px; text-align: center; color: var(--text-secondary);">No se encontraron usuarios</td></tr>';
                return;
            }
            
            const statusColors = { active: '#10b981', suspended: '#f59e0b', banned: '#dc2626' };
            const statusLabels = { active: 'Activo', suspended: 'Suspendido', banned: 'Baneado' };
            
            let html = '';
            users.forEach(function(u) {
                const color = statusColors[u.status] || '#666';
                const label = statusLabels[u.status] || u.status;
                const name = u.full_name || u.username || '-';
                const verified = u.email_verified ? '<i class="fas fa-check-circle" style="color: #10b981;"></i>' : '<i class="fas fa-times-circle" style="color: #666;"></i>';
                const date = new Date(u.created_at).toLocaleDateString('es-HN');
                
                html += '<tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">';
                html += '<td style="padding: 12px;">' + name + '</td>';
                html += '<td style="padding: 12px;">' + u.email + '</td>';
                html += '<td style="padding: 12px; text-align: center;"><span style="background: ' + color + '20; color: ' + color + '; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">' + label + '</span></td>';
                html += '<td style="padding: 12px; text-align: center;">' + verified + '</td>';
                html += '<td style="padding: 12px; text-align: center;">' + (u.role || 'user') + '</td>';
                html += '<td style="padding: 12px; font-size: 0.85rem; color: var(--text-secondary);">' + date + '</td>';
                html += '<td style="padding: 12px; text-align: center;"><button onclick="openUserActionModal(' + u.id + ')" style="background: var(--tanda-cyan); color: var(--bg-primary); border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;"><i class="fas fa-edit"></i></button></td>';
                html += '</tr>';
            });
            tbody.innerHTML = html;
            
            // Store users for modal
            window.usersCache = {};
            users.forEach(function(u) { window.usersCache[u.id] = u; });
            
            renderUsersPagination(pagination);
        }

        function renderUsersPagination(pagination) {
            const container = document.getElementById('usersPagination');
            if (!pagination || pagination.total_pages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '';
            const prevDisabled = pagination.page <= 1 ? 'disabled style="opacity:0.5;"' : '';
            const nextDisabled = pagination.page >= pagination.total_pages ? 'disabled style="opacity:0.5;"' : '';
            
            html += '<button onclick="loadUsers(' + (pagination.page - 1) + ')" ' + prevDisabled + ' style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-color); background: transparent; color: var(--text-primary); cursor: pointer;"><i class="fas fa-chevron-left"></i></button>';
            html += '<span style="color: var(--text-secondary);">Pagina ' + pagination.page + ' de ' + pagination.total_pages + '</span>';
            html += '<button onclick="loadUsers(' + (pagination.page + 1) + ')" ' + nextDisabled + ' style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-color); background: transparent; color: var(--text-primary); cursor: pointer;"><i class="fas fa-chevron-right"></i></button>';
            
            container.innerHTML = html;
        }

        async function loadUserStats() {
            try {
                const token = localStorage.getItem('admin_token') || localStorage.getItem('auth_token');
                const res = await fetch('/api/admin/users/stats', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await res.json();
                
                if (data.success && data.data) {
                    document.getElementById('statTotalUsers').textContent = data.data.total || 0;
                    document.getElementById('statActiveUsers').textContent = data.data.active || 0;
                    document.getElementById('statSuspendedUsers').textContent = data.data.suspended || 0;
                    document.getElementById('statVerifiedUsers').textContent = data.data.verified || 0;
                    document.getElementById('statKycComplete').textContent = data.data.kyc_complete || 0;
                    document.getElementById('statNewWeek').textContent = data.data.new_this_week || 0;
                }
            } catch (err) {
            }
        }

        function openUserActionModal(userId) {
            const user = window.usersCache[userId];
            if (!user) return;
            
            currentUserForAction = user;
            document.getElementById('actionUserName').textContent = user.full_name || user.username || '-';
            document.getElementById('actionUserEmail').textContent = user.email;
            document.getElementById('actionUserStatus').textContent = user.status;
            document.getElementById('newUserStatus').value = user.status;
            document.getElementById('statusChangeReason').value = '';
            document.getElementById('userActionModal').style.display = 'flex';
        }

        function closeUserActionModal() {
            document.getElementById('userActionModal').style.display = 'none';
            currentUserForAction = null;
        }

        async function executeUserStatusChange() {
            if (!currentUserForAction) return;
            
            const newStatus = document.getElementById('newUserStatus').value;
            const reason = document.getElementById('statusChangeReason').value;
            
            try {
                const token = localStorage.getItem('admin_token') || localStorage.getItem('auth_token');
                const res = await fetch('/api/admin/users/' + currentUserForAction.id + '/status', {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus, reason: reason })
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('Estado actualizado correctamente');
                    closeUserActionModal();
                    loadUsers(currentUsersPage);
                    loadUserStats();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo actualizar'));
                }
            } catch (err) {
                alert('Error de conexion');
            }
        }

        // Initialize users section on page load
        (function initUsersSection() {
            if (document.getElementById('usersSection')) {
                loadUsers();
                loadUserStats();
                
                document.getElementById('userSearchInput').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') loadUsers();
                });
                
                document.getElementById('userStatusFilter').addEventListener('change', function() {
                    loadUsers();
                });
            }
        })();
        // ========== GROUPS MANAGEMENT FUNCTIONS ==========
        async function loadAdminGroups() {
            const tbody = document.getElementById('groupsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center;"><div class="loading"></div></td></tr>';
            
            try {
                const token = localStorage.getItem('admin_token') || localStorage.getItem('auth_token');
                
                // Load active groups
                const res = await fetch('/api/groups', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await res.json();
                
                // Load deleted groups count
                let deletedCount = 0;
                try {
                    const delRes = await fetch('/api/admin/groups/deleted', {
                        headers: { 'Authorization': 'Bearer ' + token }
                    });
                    const delData = await delRes.json();
                    if (delData.success && delData.data) {
                        deletedCount = delData.data.length || 0;
                    }
                } catch (e) { }
                
                const groups = data.data || data.groups || data || [];
                
                // Calculate stats
                let activeCount = 0;
                let totalMembers = 0;
                
                groups.forEach(function(g) {
                    if (g.status === 'active') activeCount++;
                    totalMembers += parseInt(g.member_count) || 0;
                });
                
                // Update stats
                document.getElementById('statTotalGroups').textContent = groups.length;
                document.getElementById('statActiveGroups').textContent = activeCount;
                document.getElementById('statTotalMembers').textContent = totalMembers;
                document.getElementById('statDeletedGroups').textContent = deletedCount;
                
                // Render table
                renderGroupsTable(groups);
                
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: #dc2626;">Error al cargar grupos</td></tr>';
            }
        }
        
        function renderGroupsTable(groups) {
            const tbody = document.getElementById('groupsTableBody');
            
            if (!groups.length) {
                tbody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: var(--text-secondary);">No hay grupos registrados</td></tr>';
                return;
            }
            
            const statusColors = { active: '#10b981', paused: '#f59e0b', completed: '#6366f1', cancelled: '#dc2626' };
            const statusLabels = { active: 'Activo', paused: 'Pausado', completed: 'Completado', cancelled: 'Cancelado' };
            const freqLabels = { weekly: 'Semanal', biweekly: 'Quincenal', monthly: 'Mensual' };
            
            let html = '';
            groups.forEach(function(g) {
                const color = statusColors[g.status] || '#666';
                const label = statusLabels[g.status] || g.status || 'N/A';
                const freq = freqLabels[g.frequency] || g.frequency || 'N/A';
                const date = g.created_at ? new Date(g.created_at).toLocaleDateString('es-HN') : 'N/A';
                const amount = g.contribution_amount ? 'L ' + parseFloat(g.contribution_amount).toFixed(2) : 'N/A';
                const members = (g.member_count || 0) + '/' + (g.max_members || 12);
                
                html += '<tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">';
                html += '<td style="padding: 12px;">' + (g.name || 'Sin nombre') + '</td>';
                html += '<td style="padding: 12px; text-align: center;">' + members + '</td>';
                html += '<td style="padding: 12px; text-align: center;">' + amount + '</td>';
                html += '<td style="padding: 12px; text-align: center;">' + freq + '</td>';
                html += '<td style="padding: 12px; text-align: center;"><span style="background: ' + color + '20; color: ' + color + '; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">' + label + '</span></td>';
                html += '<td style="padding: 12px; font-size: 0.85rem; color: var(--text-secondary);">' + date + '</td>';
                html += '</tr>';
            });
            tbody.innerHTML = html;
        }
        
        // Initialize groups section
        (function initGroupsSection() {
            if (document.getElementById('groupsSection')) {
                setTimeout(loadAdminGroups, 500);
            }
        })();
    </script>

    <!-- La Tanda Deposit/Receipt System Integration -->
    <!-- Shared Components -->
    <script src="shared-components.js?v=7.18"></script>

    <script src="receipt-manager.js"></script>
    <script src="ocr-receipt-processor.js"></script>
    <script src="notification-system.js"></script>

    <!-- Admin Panel Integration Bridge -->
    <script>
        // Bridge between admin panel and our deposit system
        let receiptManager;
        let walletTransactionHistory = [];

        // Initialize our systems when admin panel loads
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize receipt manager
            if (typeof ReceiptManager !== 'undefined') {
                receiptManager = new ReceiptManager();

                // Connect to admin panel refresh
                const originalLoadPendingDeposits = window.loadPendingDeposits;
                window.loadPendingDeposits = function() {
                    loadLocalDepositData();
                    if (originalLoadPendingDeposits) {
                        originalLoadPendingDeposits.call(this);
                    }
                };
            }
        });

        // Load deposit data from our local systems
        function loadLocalDepositData() {

            // ALWAYS use real wallet data, regardless of receiptManager presence

            // Debug: Show all localStorage keys related to transactions/receipts
            const allKeys = [];
            const relevantKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                allKeys.push(key);
                if (key && (key.includes('transaction') || key.includes('receipt') || key.includes('tanda') || key.includes('balance'))) {
                    relevantKeys.push(key);
                }
            }

            // Show content of key localStorage entries
            relevantKeys.forEach(key => {
                try {
                    const value = localStorage.getItem(key);
                    const parsed = JSON.parse(value);
                } catch (e) {
                }
            });

            // Read transactions and receipts from localStorage (wallet data)
            // Try multiple possible localStorage keys used by wallet
            const walletTransactions = JSON.parse(
                localStorage.getItem('transactionHistory') ||
                localStorage.getItem('wallet_transaction_history') ||
                localStorage.getItem('la_tanda_transactions') ||
                '[]'
            );
            const walletReceipts = JSON.parse(
                localStorage.getItem('la_tanda_receipts') ||
                localStorage.getItem('receipts') ||
                localStorage.getItem('receipt_history') ||
                '[]'
            );


            // DEBUG: Show actual transaction statuses

            // DEBUG: Check bank mapping
            walletTransactions.forEach(tx => {
                if (tx.type === 'deposit') {
                }
            });

            // ALWAYS use the unified data processing logic
            createAdminDataFromWallet(walletTransactions, walletReceipts);
        }

        // Create admin panel data from wallet localStorage data
        function createAdminDataFromWallet(transactions, receipts) {

            const adminPanelDeposits = [];

            // DEBUG: Show all deposits before filtering
            const allDeposits = transactions.filter(tx => tx.type === 'deposit');

            // Enhanced filtering to include all relevant deposit statuses
            const pendingDeposits = transactions.filter(tx => {
                const isDeposit = tx.type === 'deposit';
                const isNotLightning = tx.method !== 'lightning';

                // Include all pending and completed deposits for admin review
                const relevantStatuses = [
                    'pending_verification',
                    'pending_admin_verification',
                    'pending_approval',
                    'completed',
                    'approved',
                    'confirmed'
                ];
                const hasRelevantStatus = relevantStatuses.includes(tx.status);

                const matches = isDeposit && isNotLightning && hasRelevantStatus;

                if (isDeposit) {
                }

                return matches;
            });


            // If no real data exists, show empty state instead of sample data
            if (pendingDeposits.length === 0) {

                // Show empty admin panel
                displayDeposits([]);

                const stats = {
                    total_pending: 0,
                    total_amount: 0,
                    total_amount_display: '$0.00',
                    primary_currency: 'USD',
                    currency_breakdown: {},
                    avg_amount: 0,
                    pending_deposits: 0,
                    approved_today: 0,
                    rejected_today: 0,
                    high_confidence_ocr: 0,
                    low_confidence_ocr: 0,
                    avg_confidence: 0,
                    auto_processable: 0,
                    banks_distribution: { atlantida: 0, lightning: 0, others: 0 },
                    banks_summary: {}
                };
                displayStats(stats);

                return;
            }

            // Process real deposits

            /*
            // REMOVED: Sample data creation - now only via manual "Crear Datos de Prueba" button

                // Create sample deposits with SVG images
                const sampleDeposits = [
                    {
                        id: 'receipt_sample_high_' + Date.now(),
                        user_id: 'local_user_001',
                        amount: 500.00,
                        net_amount: 500.00,
                        currency: 'USD',
                        bank_name: 'Banco Atl√°ntida',
                        reference_number: 'ATL1757352194072',
                        status: 'ready_for_review',
                        status_description: 'Listo para revisi√≥n',
                        created_at: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
                        time_remaining: 46,
                        receipt: { filename: 'atlantida_deposit_500.jpg' },
                        _localData: {
                            fileUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjUwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iYmciIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojZjRmNGY0O3N0b3Atb3BhY2l0eToxIiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNlMGUwZTA7c3RvcC1vcGFjaXR5OjEiIC8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI2JnKSIgc3Ryb2tlPSIjY2NjIiBzdHJva2Utd2lkdGg9IjIiLz4KICA8IS0tIEhlYWRlciAtLT4KICA8cmVjdCB4PSIwIiB5PSIwIiB3aWR0aD0iNDAwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjMDA2NmNjIi8+CiAgPHRleHQgeD0iMjAiIHk9IjMwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSJ3aGl0ZSI+QmFuY28gQXRsw6FudGlkYTwvdGV4dD4KICA8dGV4dCB4PSIyMCIgeT0iNTUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0id2hpdGUiPkNvbXByb2JhbnRlIGRlIERlcMOzc2l0bzwvdGV4dD4KICA8IS0tIEFtb3VudCAtLT4KICA8dGV4dCB4PSIyMCIgeT0iMTMwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiMzMzMiPk1vbnRvOjwvdGV4dD4KICA8dGV4dCB4PSIyMCIgeT0iMTYwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjgiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSIjMDA2NmNjIj4kNTAwLjAwIFVTRDwvdGV4dD4KICA8IS0tIERldGFpbHMgLS0+CiAgPHRleHQgeD0iMjAiIHk9IjIxMCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjNTU1Ij5SZWZlcmVuY2lhOiBBVEwxNzU3MzUyMTk0MDcyPC90ZXh0PgogIDx0ZXh0IHg9IjIwIiB5PSIyNDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzU1NSI+RmVjaGE6IDI1LzkvMjAyNTwvdGV4dD4KICA8dGV4dCB4PSIyMCIgeT0iMjcwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM1NTUiPkhvcmE6IDA3OjQ3OjQyPC90ZXh0PgogIDx0ZXh0IHg9IjIwIiB5PSIzMDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzU1NSI+VGlwbzogRGVww7NzaXRvIEVsZWN0csOzbmljbzwvdGV4dD4KICA8IS0tIFN0YW1wIC0tPgogIDxyZWN0IHg9IjI1MCIgeT0iMzUwIiB3aWR0aD0iMTMwIiBoZWlnaHQ9IjUwIiBmaWxsPSJub25lIiBzdHJva2U9IiMwMGNjNjYiIHN0cm9rZS13aWR0aD0iMyIgc3Ryb2tlLWRhc2hhcnJheT0iNSw1IiB0cmFuc2Zvcm09InJvdGF0ZSgtMTUgMzE1IDM3NSkiLz4KICA8dGV4dCB4PSIzMTUiIHk9IjM4NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE2IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iIzAwY2M2NiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgdHJhbnNmb3JtPSJyb3RhdGUoLTE1IDMxNSAzODUpIj5WQUxJREFETzwvdGV4dD4KPC9zdmc+'
                        }
                    },
                    {
                        id: 'receipt_sample_med_' + Date.now(),
                        user_id: 'local_user_001',
                        amount: 250.00,
                        net_amount: 250.00,
                        currency: 'USD',
                        bank_name: 'Banco Atl√°ntida',
                        reference_number: 'ATL1757999888777',
                        status: 'under_review',
                        status_description: 'Requiere revisi√≥n manual',
                        created_at: new Date(Date.now() - 45 * 60 * 1000).toISOString(),
                        time_remaining: 41,
                        receipt: { filename: 'atlantida_deposit_250.jpg' },
                        _localData: {
                            fileUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjUwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iYmcyIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6I2ZmZjhmODtzdG9wLW9wYWNpdHk6MSIgLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojZmRkOWQ5O3N0b3Atb3BhY2l0eToxIiAvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICA8L2RlZnM+CiAgPHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0idXJsKCNiZzIpIiBzdHJva2U9IiNlZGE0YTQiIHN0cm9rZS13aWR0aD0iMiIvPgogIDx0ZXh0IHg9IjIwIiB5PSIzMCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE4IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iIzk5MTgyOCI+QmFuY28gQXRsw6FudGlkYTwvdGV4dD4KICA8dGV4dCB4PSIyMCIgeT0iNTUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzc5MjQyNCI+Q29tcHJvYmFudGUgZGUgRGVww7NzaXRvPC90ZXh0PgogIDx0ZXh0IHg9IjIwIiB5PSIxMzAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzM3Mzc0MSI+TW9udG86PC90ZXh0PgogIDx0ZXh0IHg9IjIwIiB5PSIxNjAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyOCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiNkYzI2MjYiPiQyNTAuMDAgVVNEPC90ZXh0PgogIDx0ZXh0IHg9IjIwIiB5PSIxOTAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2RjMjYyNiI+KE9DUiBkZXRlY3TDszogJDI0NS4wMCk8L3RleHQ+CiAgPHRleHQgeD0iMjAiIHk9IjI0MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjNTU1Ij5SZWZlcmVuY2lhOiBBVEwxNzU3OTk5ODg4Nzc3PC90ZXh0PgogIDx0ZXh0IHg9IjIwIiB5PSIyNzAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzU1NSI+RmVjaGE6IDI1LzkvMjAyNTwvdGV4dD4KICA8dGV4dCB4PSIyMCIgeT0iMzAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM1NTUiPkhvcmE6IDA5OjAyOjQyPC90ZXh0PgogIDxyZWN0IHg9IjI1MCIgeT0iMzUwIiB3aWR0aD0iMTMwIiBoZWlnaHQ9IjUwIiBmaWxsPSJub25lIiBzdHJva2U9IiNmZjc5NzUiIHN0cm9rZS13aWR0aD0iMyIgc3Ryb2tlLWRhc2hhcnJheT0iNSw1IiB0cmFuc2Zvcm09InJvdGF0ZSgtMTUgMzE1IDM3NSkiLz4KICA8dGV4dCB4PSIzMTUiIHk9IjM4NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iI2VmNDQ0NCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgdHJhbnNmb3JtPSJyb3RhdGUoLTE1IDMxNSAzODUpIj5SRVZJU0lPTiBNQU5VQUw8L3RleHQ+Cjwvc3ZnPg=='
                        }
                    },
                    {
                        id: 'receipt_sample_low_' + Date.now(),
                        user_id: 'local_user_001',
                        amount: 75.00,
                        net_amount: 75.00,
                        currency: 'USD',
                        bank_name: 'Banco Atl√°ntida',
                        reference_number: 'ATL1757000111222',
                        status: 'under_review',
                        status_description: 'Requiere revisi√≥n manual',
                        created_at: new Date(Date.now() - 10 * 60 * 1000).toISOString(),
                        time_remaining: 41,
                        receipt: { filename: 'blurry_receipt_75.jpg' },
                        _localData: {
                            fileUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjUwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iYmc0IiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6I2Y3ZjdmNztzdG9wLW9wYWNpdHk6MSIgLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojZDFkMWQxO3N0b3Atb3BhY2l0eToxIiAvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICA8L2RlZnM+CiAgPHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0idXJsKCNiZzQpIiBzdHJva2U9IiNhM2EzYTMiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWRhc2hhcnJheT0iNSw1Ii8+CiAgPHRleHQgeD0iMjAiIHk9IjMwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSIjNmI3Mjc5Ij5CYW5jbyBBdGzDoW50aWRhPC90ZXh0PgogIDx0ZXh0IHg9IjIwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjNmI3Mjc5Ij5Db21wcm9iYW50ZSBkZSBEZXDDs2l0bzwvdGV4dD4KICA8IS0tIEJsdXJyeSB0ZXh0IGVmZmVjdCAtLT4KICA8dGV4dCB4PSIyMCIgeT0iMTMwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiM5Y2EzYWYiIGZpbHRlcj0iYmx1cigycHgpIj5Nb250bzo8L3RleHQ+CiAgPHRleHQgeD0iMjAiIHk9IjE2MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjI4IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iIzZiNzI3OSIgZmlsdGVyPSJibHVyKDNweCkiPiQ3NS4wMCBVU0Q8L3RleHQ+CiAgPCEtLSBCbHVycnkgZGV0YWlscyAtLT4KICA8dGV4dCB4PSIyMCIgeT0iMjQwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5Y2EzYWYiIGZpbHRlcj0iYmx1cigycHgpIj5SZWZlcmVuY2lhOiBBVEwxNzU3Li4uIGJvcnJvc288L3RleHQ+CiAgPHRleHQgeD0iMjAiIHk9IjI3MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOWNhM2FmIiBmaWx0ZXI9ImJsdXIoMnB4KSI+RmVjaGE6IDI1Lz4uLi5ib3Jyb3NhPC90ZXh0PgogIDx0ZXh0IHg9IjIwIiB5PSIzMDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzljYTNhZiIgZmlsdGVyPSJibHVyKDJweCkiPkhvcmE6IDI5Oj8/Oj8/PC90ZXh0PgogIDxyZWN0IHg9IjI1MCIgeT0iMzUwIiB3aWR0aD0iMTMwIiBoZWlnaHQ9IjUwIiBmaWxsPSJub25lIiBzdHJva2U9IiNmZjU5MjEiIHN0cm9rZS13aWR0aD0iNCIgc3Ryb2tlLWRhc2hhcnJheT0iMywyIiB0cmFuc2Zvcm09InJvdGF0ZSgtMTUgMzE1IDM3NSkiLz4KICA8dGV4dCB4PSIzMTUiIHk9IjM4NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iI2VhNTgyZCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgdHJhbnNmb3JtPSJyb3RhdGUoLTE1IDMxNSAzODUpIj5JTEVHSUJMRTwvdGV4dD4KPC9zdmc+'
                        }
                    },
                    {
                        id: 'receipt_hnl_test_' + Date.now(),
                        user_id: 'local_user_001',
                        amount: 1850.00,
                        net_amount: 1850.00,
                        currency: 'HNL',
                        bank_name: 'Banco Atl√°ntida',
                        reference_number: 'ATL1757888999000',
                        status: 'ready_for_review',
                        status_description: 'Listo para revisi√≥n',
                        created_at: new Date(Date.now() - 5 * 60 * 1000).toISOString(),
                        time_remaining: 47,
                        receipt: { filename: 'atlantida_deposit_1850_hnl.jpg' },
                        _localData: {
                            fileUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjUwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iYmdITkwiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojZTBmMmU3O3N0b3Atb3BhY2l0eToxIiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNjNGUzY2Q7c3RvcC1vcGFjaXR5OjEiIC8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI2JnSE5MKSIgc3Ryb2tlPSIjMTI4NDNkIiBzdHJva2Utd2lkdGg9IjIiLz4KICA8IS0tIEhlYWRlciAtLT4KICA8cmVjdCB4PSIwIiB5PSIwIiB3aWR0aD0iNDAwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjMTI4NDNkIi8+CiAgPHRleHQgeD0iMjAiIHk9IjMwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSJ3aGl0ZSI+QmFuY28gQXRsw6FudGlkYTwvdGV4dD4KICA8dGV4dCB4PSIyMCIgeT0iNTUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0id2hpdGUiPkNvbXByb2JhbnRlIGRlIERlcMOzc2l0bzwvdGV4dD4KICA8IS0tIEFtb3VudCAtLT4KICA8dGV4dCB4PSIyMCIgeT0iMTMwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiMxODNkNGIiPk1vbnRvOjwvdGV4dD4KICA8dGV4dCB4PSIyMCIgeT0iMTYwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjgiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSIjMTI4NDNkIj5MIDEsODUwLjAwIEhOTDwvdGV4dD4KICA8IS0tIERldGFpbHMgLS0+CiAgPHRleHQgeD0iMjAiIHk9IjIxMCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjNTU1Ij5SZWZlcmVuY2lhOiBBVEwxNzU3ODg4OTk5MDAwPC90ZXh0PgogIDx0ZXh0IHg9IjIwIiB5PSIyNDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzU1NSI+RmVjaGE6IDI3LzkvMjAyNTwvdGV4dD4KICA8dGV4dCB4PSIyMCIgeT0iMjcwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM1NTUiPkhvcmE6IDE0OjE1OjMwPC90ZXh0PgogIDx0ZXh0IHg9IjIwIiB5PSIzMDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzU1NSI+VGlwbzogRGVww7NzaXRvIEVsZWN0csOzbmljbzwvdGV4dD4KICA8IS0tIFN0YW1wIC0tPgogIDxyZWN0IHg9IjI1MCIgeT0iMzUwIiB3aWR0aD0iMTMwIiBoZWlnaHQ9IjUwIiBmaWxsPSJub25lIiBzdHJva2U9IiMxMjg0M2QiIHN0cm9rZS13aWR0aD0iMyIgc3Ryb2tlLWRhc2hhcnJheT0iNSw1IiB0cmFuc2Zvcm09InJvdGF0ZSgtMTUgMzE1IDM3NSkiLz4KICA8dGV4dCB4PSIzMTUiIHk9IjM4NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE2IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iIzEyODQzZCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgdHJhbnNmb3JtPSJyb3RhdGUoLTE1IDMxNSAzODUpIj5MRU1QSVJBUzwvdGV4dD4KPC9zdmc+'
                        }
                    }
                ];

                adminPanelDeposits.push(...sampleDeposits);
            */

            // Convert real wallet data to admin format
            pendingDeposits.forEach(tx => {
                    const relatedReceipt = receipts.find(r => r.id === tx.receiptId);

                    adminPanelDeposits.push({
                        id: tx.id,
                        user_id: tx.userId || 'user_unknown',
                        amount: tx.amount || 0,
                        net_amount: tx.amount || 0,
                        currency: tx.currency || 'USD',
                        bank_name: getBankName(tx.method, tx),
                        reference_number: tx.reference || tx.id,
                        status: mapWalletStatusToAdmin(tx.status),
                        status_description: getStatusDescription(tx.status),
                        created_at: tx.timestamp || new Date().toISOString(),
                        time_remaining: calculateTimeRemaining(tx.timestamp),
                        receipt: relatedReceipt ? { filename: relatedReceipt.fileName } : null,
                        _localData: relatedReceipt ? {
                            fileUrl: relatedReceipt.dataUrl,
                            ...relatedReceipt
                        } : null
                    });
                });

            // Make data available globally for modal access
            window.adminPanelDeposits = adminPanelDeposits;
            displayDeposits(adminPanelDeposits);

            // Update stats with multi-currency support
            const currencyTotals = adminPanelDeposits.reduce((totals, dep) => {
                const currency = dep.currency || 'USD';
                totals[currency] = (totals[currency] || 0) + (dep.amount || 0);
                return totals;
            }, {});

            // Calculate primary currency (highest total) and display format
            const primaryCurrency = Object.keys(currencyTotals).reduce((a, b) =>
                currencyTotals[a] > currencyTotals[b] ? a : b, 'USD');

            const totalAmount = currencyTotals[primaryCurrency] || 0;
            const avgAmount = adminPanelDeposits.length > 0 ? totalAmount / adminPanelDeposits.length : 0;

            // Create multi-currency display string
            const currencyDisplay = Object.entries(currencyTotals)
                .map(([currency, amount]) => formatCurrency(amount, currency))
                .join(' + ');

            // DEBUG: Show calculation details

            // Calculate bank distribution for analytics
            const bankDistribution = {
                atlantida: adminPanelDeposits.filter(d => d.bank_name === 'Banco Atl√°ntida').length,
                lightning: adminPanelDeposits.filter(d => d.bank_name === 'Lightning Network').length,
                others: adminPanelDeposits.filter(d => d.bank_name && d.bank_name !== 'Banco Atl√°ntida' && d.bank_name !== 'Lightning Network').length
            };

            // Get admin actions for today's statistics
            const adminActions = JSON.parse(localStorage.getItem('la_tanda_admin_actions') || '[]');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayActions = adminActions.filter(action => {
                const actionDate = new Date(action.timestamp);
                actionDate.setHours(0, 0, 0, 0);
                return actionDate.getTime() === today.getTime();
            });

            const stats = {
                total_pending: adminPanelDeposits.length,
                total_amount: totalAmount,
                total_amount_display: currencyDisplay, // Multi-currency display
                primary_currency: primaryCurrency,
                currency_breakdown: currencyTotals,
                avg_amount: avgAmount,
                pending_deposits: adminPanelDeposits.length,
                approved_today: todayActions.filter(a => a.type === 'approved').length,
                rejected_today: todayActions.filter(a => a.type === 'rejected').length,
                high_confidence_ocr: adminPanelDeposits.filter(d => d._localData?.ocrResult?.confidence >= 80).length,
                low_confidence_ocr: adminPanelDeposits.filter(d => d._localData?.ocrResult?.confidence < 50).length,
                avg_confidence: adminPanelDeposits.reduce((sum, d) => sum + (d._localData?.ocrResult?.confidence || 0), 0) / (adminPanelDeposits.length || 1),
                auto_processable: adminPanelDeposits.filter(d => d._localData?.ocrResult?.confidence >= 80).length,
                banks_distribution: bankDistribution,
                banks_summary: { 'Banco Atl√°ntida': true, 'Lightning Network': true }
            };
            displayStats(stats);

        }

        // Helper function to map wallet status to admin status
        function mapWalletStatusToAdmin(walletStatus) {
            const statusMap = {
                'pending_verification': 'ready_for_review',
                'pending_admin_verification': 'under_review'
            };
            return statusMap[walletStatus] || 'ready_for_review';
        }

        // Helper function to get bank name from method or transaction
        function getBankName(method, transaction = null) {
            // First try the method field
            const bankMap = {
                'atlantida': 'Banco Atl√°ntida',
                'bac': 'Banco BAC',
                'ficohsa': 'Banco Ficohsa',
                'occidente': 'Banco de Occidente'
            };

            if (method && bankMap[method]) {
                return bankMap[method];
            }

            // If no method or unknown method, try to infer from transaction data
            if (transaction) {
                // Check bankAccount field
                if (transaction.bankAccount) {
                    if (transaction.bankAccount.toLowerCase().includes('atl√°ntida') ||
                        transaction.bankAccount.toLowerCase().includes('atlantida')) {
                        return 'Banco Atl√°ntida';
                    }
                }

                // Check reference patterns
                if (transaction.reference) {
                    const ref = transaction.reference.toUpperCase();
                    // ATL prefix pattern
                    if (ref.startsWith('ATL')) {
                        return 'Banco Atl√°ntida';
                    }
                    // LT-DEP pattern (La Tanda deposits typically use Atl√°ntida)
                    if (ref.startsWith('LT-DEP')) {
                        return 'Banco Atl√°ntida';
                    }
                    // Other bank patterns
                    if (ref.startsWith('BAC')) {
                        return 'Banco BAC';
                    }
                }

                // Check transaction ID patterns
                if (transaction.id) {
                    const id = transaction.id.toUpperCase();
                    if (id.startsWith('LT-DEP') || id.includes('DEP')) {
                        return 'Banco Atl√°ntida'; // Default for La Tanda deposits
                    }
                }

                // Check if it's a manual/local deposit (typically Atl√°ntida)
                if (transaction.userId && transaction.userId.includes('default')) {
                    return 'Banco Atl√°ntida';
                }
            }

            return bankMap[method] || 'Banco Atl√°ntida'; // Default to Atl√°ntida instead of "Desconocido"
        }

        // Helper functions
        function getStatusDescription(status) {
            const statusMap = {
                'uploaded': 'Comprobante subido',
                'ready_for_review': 'Listo para revisi√≥n',
                'needs_manual_review': 'Requiere revisi√≥n manual',
                'pending_verification': 'Pendiente de verificaci√≥n',
                'pending_admin_verification': 'Pendiente de verificaci√≥n administrativa'
            };
            return statusMap[status] || 'Pendiente de revisi√≥n';
        }

        function calculateTimeRemaining(timestamp) {
            if (!timestamp) return 0;
            const uploadTime = new Date(timestamp);
            const now = new Date();
            const diffHours = Math.ceil((now - uploadTime) / (1000 * 60 * 60));
            return Math.max(0, 48 - diffHours); // 48 hour review period
        }

        // Enhanced confirm function that works with our system
        window.originalConfirmDeposit = window.confirmDeposit;
        window.confirmDeposit = function(depositId, status = 'confirmed') {
            const deposit = document.querySelector(`[data-deposit-id="${depositId}"]`);
            if (!deposit) return;

            // If this is from our local system, handle it locally
            if (deposit.dataset.localData) {
                handleLocalDepositApproval(depositId, status === 'confirmed');
            } else {
                // Use original API-based confirmation
                if (window.originalConfirmDeposit) {
                    window.originalConfirmDeposit(depositId, status);
                }
            }
        };

        // Handle local deposit approval/rejection
        function handleLocalDepositApproval(depositId, approved) {
            if (!receiptManager) return;


            // Update receipt status
            const receipt = receiptManager.receipts.find(r => r.id === depositId);
            if (receipt) {
                receipt.status = approved ? 'approved' : 'rejected';
                receipt.adminDecision = {
                    approved: approved,
                    timestamp: new Date(),
                    admin: 'Admin Local'
                };
                receiptManager.saveReceipts();
            }

            // Update transaction status
            const transactions = JSON.parse(localStorage.getItem('transactionHistory') || '[]');
            const transaction = transactions.find(tx => tx.id === depositId || tx.receiptId === depositId);
            if (transaction) {
                transaction.status = approved ? 'completed' : 'rejected';
                transaction.adminDecision = {
                    approved: approved,
                    timestamp: new Date(),
                    admin: 'Admin Local'
                };
                localStorage.setItem('transactionHistory', JSON.stringify(transactions));

                // Create admin update notification for wallet to detect
                let adminUpdates = JSON.parse(localStorage.getItem('latanda_transaction_updates') || '{}');
                adminUpdates[transaction.id] = {
                    status: approved ? 'completed' : 'rejected',
                    message: approved ? 'Dep√≥sito aprobado por administrador' : 'Dep√≥sito rechazado por administrador',
                    timestamp: new Date().toISOString(),
                    type: approved ? 'admin_approval' : 'admin_rejection',
                    admin_id: currentUser?.username || 'Admin Local'
                };
                localStorage.setItem('latanda_transaction_updates', JSON.stringify(adminUpdates));


                // If approved, update user balance
                if (approved) {
                    updateUserBalance(transaction.user_id || 'user_local', transaction.amount, transaction.currency);
                }
            }

            // Show success notification
            showNotification(
                `Dep√≥sito ${approved ? 'aprobado' : 'rechazado'} exitosamente`,
                approved ? 'success' : 'warning'
            );

            // Refresh the deposits list
            setTimeout(() => {
                loadLocalDepositData();
            }, 500);
        }

        // Enhanced reject function
        window.originalRejectDeposit = window.rejectDeposit;
        window.rejectDeposit = function(depositId, reason = '') {
            const deposit = document.querySelector(`[data-deposit-id="${depositId}"]`);
            if (!deposit) return;

            if (deposit.dataset.localData) {
                handleLocalDepositApproval(depositId, false);
            } else if (window.originalRejectDeposit) {
                window.originalRejectDeposit(depositId, reason);
            }
        };

        // User Balance Management - Updated to match wallet's simple balance format
        function updateUserBalance(userId, amount, currency) {
            try {
                // Get existing balances using wallet's simple format
                let balances = JSON.parse(localStorage.getItem('balances') || '{"USD": 0, "HNL": 0}');

                // Update balance directly (wallet uses simple format, not user-based)
                const oldBalance = balances[currency] || 0;
                balances[currency] = oldBalance + amount;

                // Save updated balances using wallet's key and format
                localStorage.setItem('balances', JSON.stringify(balances));

                // Log balance update


                return true;
            } catch (error) {
                return false;
            }
        }

        function getUserBalance(userId) {
            try {
                const balances = JSON.parse(localStorage.getItem('balances') || '{"USD": 0, "HNL": 0}');
                return balances;
            } catch (error) {
                return { USD: 0, HNL: 0, BTC: 0, LTD: 0 };
            }
        }

        // Sample Data Generator for Testing
        function createSampleDataForTesting() {
            if (!receiptManager) {
                return;
            }


            // Clear existing data
            receiptManager.receipts = [];
            localStorage.removeItem('transactionHistory');

            // Create sample transactions with receipts
            const sampleTransactions = [];
            const sampleReceipts = [];

            // High confidence OCR deposit
            const receipt1 = {
                id: 'receipt_sample_high_' + Date.now(),
                depositId: 'dep_sample_1',
                fileName: 'atlantida_deposit_500.jpg',
                fileSize: 2048000,
                fileType: 'image/jpeg',
                uploadTime: new Date(Date.now() - 2 * 60 * 60 * 1000), // 2 hours ago
                status: 'ready_for_review',
                method: 'atlantida',
                expectedAmount: 500.00,
                expectedCurrency: 'USD',
                reference: 'ATL1757352194072',
                ocrResult: {
                    extractedAmount: 500.00,
                    confidence: 92,
                    bankName: 'Banco Atl√°ntida',
                    date: new Date().toISOString().split('T')[0],
                    currency: 'USD',
                    transactionId: 'TXN123456789'
                },
                ocrValidation: {
                    valid: true,
                    confidence: 92,
                    issues: []
                },
                // Simulate file for demo with viewable image
                file: createMockFile('atlantida_deposit_500.jpg', 'image/jpeg', 2048000),
                fileUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjUwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iYmciIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdHlsZT0ic3RvcC1jb2xvcjojZjRmNGY0O3N0b3Atb3BhY2l0eToxIiAvPgogICAgICA8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNlMGUwZTA7c3RvcC1vcGFjaXR5OjEiIC8+CiAgICA8L2xpbmVhckdyYWRpZW50PgogIDwvZGVmcz4KICA8cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI2JnKSIgc3Ryb2tlPSIjY2NjIiBzdHJva2Utd2lkdGg9IjIiLz4KICA8IS0tIEhlYWRlciAtLT4KICA8cmVjdCB4PSIwIiB5PSIwIiB3aWR0aD0iNDAwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjMDA2NmNjIi8+CiAgPHRleHQgeD0iMjAiIHk9IjMwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSJ3aGl0ZSI+QmFuY28gQXRsw6FudGlkYTwvdGV4dD4KICA8dGV4dCB4PSIyMCIgeT0iNTUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0id2hpdGUiPkNvbXByb2JhbnRlIGRlIERlcMOzc2l0bzwvdGV4dD4KICA8IS0tIEFtb3VudCAtLT4KICA8dGV4dCB4PSIyMCIgeT0iMTMwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiMzMzMiPk1vbnRvOjwvdGV4dD4KICA8dGV4dCB4PSIyMCIgeT0iMTYwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjgiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSIjMDA2NmNjIj4kNTAwLjAwIFVTRDwvdGV4dD4KICA8IS0tIERldGFpbHMgLS0+CiAgPHRleHQgeD0iMjAiIHk9IjIxMCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjNTU1Ij5SZWZlcmVuY2lhOiBBVEwxNzU3MzUyMTk0MDcyPC90ZXh0PgogIDx0ZXh0IHg9IjIwIiB5PSIyNDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzU1NSI+RmVjaGE6IDI1LzkvMjAyNTwvdGV4dD4KICA8dGV4dCB4PSIyMCIgeT0iMjcwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM1NTUiPkhvcmE6IDA3OjQ3OjQyPC90ZXh0PgogIDx0ZXh0IHg9IjIwIiB5PSIzMDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzU1NSI+VGlwbzogRGVww7NzaXRvIEVsZWN0csOzbmljbzwvdGV4dD4KICA8IS0tIFN0YW1wIC0tPgogIDxyZWN0IHg9IjI1MCIgeT0iMzUwIiB3aWR0aD0iMTMwIiBoZWlnaHQ9IjUwIiBmaWxsPSJub25lIiBzdHJva2U9IiMwMGNjNjYiIHN0cm9rZS13aWR0aD0iMyIgc3Ryb2tlLWRhc2hhcnJheT0iNSw1IiB0cmFuc2Zvcm09InJvdGF0ZSgtMTUgMzE1IDM3NSkiLz4KICA8dGV4dCB4PSIzMTUiIHk9IjM4NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE2IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iIzAwY2M2NiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgdHJhbnNmb3JtPSJyb3RhdGUoLTE1IDMxNSAzODUpIj5WQUxJREFETzwvdGV4dD4KPC9zdmc+'
            };

            const transaction1 = {
                id: 'dep_sample_1',
                type: 'deposit',
                description: 'Dep√≥sito Banco Atl√°ntida',
                amount: 500.00,
                currency: 'USD',
                status: 'pending_verification',
                timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000),
                reference: 'ATL1757352194072',
                method: 'atlantida',
                receiptId: receipt1.id,
                userId: 'user_001',
                isMyTransaction: true,
                category: 'deposit'
            };

            // Medium confidence OCR deposit
            const receipt2 = {
                id: 'receipt_sample_med_' + Date.now(),
                depositId: 'dep_sample_2',
                fileName: 'atlantida_deposit_250.jpg',
                fileSize: 1844000,
                fileType: 'image/jpeg',
                uploadTime: new Date(Date.now() - 45 * 60 * 1000), // 45 minutes ago
                status: 'needs_manual_review',
                method: 'atlantida',
                expectedAmount: 250.00,
                expectedCurrency: 'USD',
                reference: 'ATL1757999888777',
                ocrResult: {
                    extractedAmount: 245.00, // Slight discrepancy
                    confidence: 68,
                    bankName: 'Banco Atl√°ntida',
                    date: new Date().toISOString().split('T')[0],
                    currency: 'USD'
                },
                ocrValidation: {
                    valid: false,
                    confidence: 68,
                    issues: [
                        'Confianza OCR por debajo del umbral',
                        'Monto detectado ($245) no coincide con esperado ($250)',
                        'Calidad de imagen sub√≥ptima'
                    ]
                },
                file: createMockFile('atlantida_deposit_250.jpg', 'image/jpeg', 1844000),
                fileUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjUwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iYmcyIiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6I2ZmZjhmODtzdG9wLW9wYWNpdHk6MSIgLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojZmRkOWQ5O3N0b3Atb3BhY2l0eToxIiAvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICA8L2RlZnM+CiAgPHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0idXJsKCNiZzIpIiBzdHJva2U9IiNlZGE0YTQiIHN0cm9rZS13aWR0aD0iMiIvPgogIDx0ZXh0IHg9IjIwIiB5PSIzMCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE4IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iIzk5MTgyOCI+QmFuY28gQXRsw6FudGlkYTwvdGV4dD4KICA8dGV4dCB4PSIyMCIgeT0iNTUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzc5MjQyNCI+Q29tcHJvYmFudGUgZGUgRGVww7NzaXRvPC90ZXh0PgogIDx0ZXh0IHg9IjIwIiB5PSIxMzAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzM3Mzc0MSI+TW9udG86PC90ZXh0PgogIDx0ZXh0IHg9IjIwIiB5PSIxNjAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyOCIgZm9udC13ZWlnaHQ9ImJvbGQiIGZpbGw9IiNkYzI2MjYiPiQyNTAuMDAgVVNEPC90ZXh0PgogIDx0ZXh0IHg9IjIwIiB5PSIxOTAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2RjMjYyNiI+KE9DUiBkZXRlY3TDszogJDI0NS4wMCk8L3RleHQ+CiAgPHRleHQgeD0iMjAiIHk9IjI0MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjNTU1Ij5SZWZlcmVuY2lhOiBBVEwxNzU3OTk5ODg4Nzc3PC90ZXh0PgogIDx0ZXh0IHg9IjIwIiB5PSIyNzAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzU1NSI+RmVjaGE6IDI1LzkvMjAyNTwvdGV4dD4KICA8dGV4dCB4PSIyMCIgeT0iMzAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM1NTUiPkhvcmE6IDA5OjAyOjQyPC90ZXh0PgogIDxyZWN0IHg9IjI1MCIgeT0iMzUwIiB3aWR0aD0iMTMwIiBoZWlnaHQ9IjUwIiBmaWxsPSJub25lIiBzdHJva2U9IiNmZjc5NzUiIHN0cm9rZS13aWR0aD0iMyIgc3Ryb2tlLWRhc2hhcnJheT0iNSw1IiB0cmFuc2Zvcm09InJvdGF0ZSgtMTUgMzE1IDM3NSkiLz4KICA8dGV4dCB4PSIzMTUiIHk9IjM4NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iI2VmNDQ0NCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgdHJhbnNmb3JtPSJyb3RhdGUoLTE1IDMxNSAzODUpIj5SRVZJU0lPTiBNQU5VQUw8L3RleHQ+Cjwvc3ZnPg=='
            };

            const transaction2 = {
                id: 'dep_sample_2',
                type: 'deposit',
                description: 'Dep√≥sito Banco Atl√°ntida',
                amount: 250.00,
                currency: 'USD',
                status: 'pending_admin_verification',
                timestamp: new Date(Date.now() - 45 * 60 * 1000),
                reference: 'ATL1757999888777',
                method: 'atlantida',
                receiptId: receipt2.id,
                userId: 'user_002',
                isMyTransaction: true,
                category: 'deposit'
            };

            // Lightning deposit without OCR
            const receipt3 = {
                id: 'receipt_sample_ln_' + Date.now(),
                depositId: 'dep_sample_3',
                fileName: 'lightning_invoice_100.png',
                fileSize: 512000,
                fileType: 'image/png',
                uploadTime: new Date(Date.now() - 15 * 60 * 1000), // 15 minutes ago
                status: 'uploaded',
                method: 'lightning',
                expectedAmount: 100.00,
                expectedCurrency: 'USD',
                reference: 'LN1757352999444',
                ocrResult: null, // Lightning doesn't need OCR
                file: createMockFile('lightning_invoice_100.png', 'image/png', 512000)
            };

            const transaction3 = {
                id: 'dep_sample_3',
                type: 'deposit',
                description: 'Dep√≥sito Lightning Network',
                amount: 100.00,
                currency: 'USD',
                status: 'pending_verification',
                timestamp: new Date(Date.now() - 15 * 60 * 1000),
                reference: 'LN1757352999444',
                method: 'lightning',
                receiptId: receipt3.id,
                userId: 'user_003',
                isMyTransaction: true,
                category: 'deposit'
            };

            // Low confidence OCR deposit (problematic)
            const receipt4 = {
                id: 'receipt_sample_low_' + Date.now(),
                depositId: 'dep_sample_4',
                fileName: 'blurry_receipt_75.jpg',
                fileSize: 1200000,
                fileType: 'image/jpeg',
                uploadTime: new Date(Date.now() - 10 * 60 * 1000), // 10 minutes ago
                status: 'needs_manual_review',
                method: 'atlantida',
                expectedAmount: 75.00,
                expectedCurrency: 'USD',
                reference: 'ATL1757000111222',
                ocrResult: {
                    extractedAmount: null,
                    confidence: 23,
                    bankName: null,
                    date: null,
                    currency: null
                },
                ocrValidation: {
                    valid: false,
                    confidence: 23,
                    issues: [
                        'Confianza OCR muy baja (23%)',
                        'No se pudo extraer el monto',
                        'Imagen borrosa o de mala calidad',
                        'Texto ilegible',
                        'Requiere revisi√≥n manual completa'
                    ]
                },
                file: createMockFile('blurry_receipt_75.jpg', 'image/jpeg', 1200000),
                fileUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjUwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iYmc0IiB4MT0iMCUiIHkxPSIwJSIgeDI9IjEwMCUiIHkyPSIxMDAlIj4KICAgICAgPHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6I2Y3ZjdmNztzdG9wLW9wYWNpdHk6MSIgLz4KICAgICAgPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojZDFkMWQxO3N0b3Atb3BhY2l0eToxIiAvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICA8L2RlZnM+CiAgPHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0idXJsKCNiZzQpIiBzdHJva2U9IiNhM2EzYTMiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWRhc2hhcnJheT0iNSw1Ii8+CiAgPHRleHQgeD0iMjAiIHk9IjMwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTgiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSIjNmI3Mjc5Ij5CYW5jbyBBdGzDoW50aWRhPC90ZXh0PgogIDx0ZXh0IHg9IjIwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjNmI3Mjc5Ij5Db21wcm9iYW50ZSBkZSBEZXDDs2l0bzwvdGV4dD4KICA8IS0tIEJsdXJyeSB0ZXh0IGVmZmVjdCAtLT4KICA8dGV4dCB4PSIyMCIgeT0iMTMwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiM5Y2EzYWYiIGZpbHRlcj0iYmx1cigycHgpIj5Nb250bzo8L3RleHQ+CiAgPHRleHQgeD0iMjAiIHk9IjE2MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjI4IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iIzZiNzI3OSIgZmlsdGVyPSJibHVyKDNweCkiPiQ3NS4wMCBVU0Q8L3RleHQ+CiAgPCEtLSBCbHVycnkgZGV0YWlscyAtLT4KICA8dGV4dCB4PSIyMCIgeT0iMjQwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5Y2EzYWYiIGZpbHRlcj0iYmx1cigycHgpIj5SZWZlcmVuY2lhOiBBVEwxNzU3Li4uIGJvcnJvc288L3RleHQ+CiAgPHRleHQgeD0iMjAiIHk9IjI3MCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSIjOWNhM2FmIiBmaWx0ZXI9ImJsdXIoMnB4KSI+RmVjaGE6IDI1Lz4uLi5ib3Jyb3NhPC90ZXh0PgogIDx0ZXh0IHg9IjIwIiB5PSIzMDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzljYTNhZiIgZmlsdGVyPSJibHVyKDJweCkiPkhvcmE6IDI5Oj8/Oj8/PC90ZXh0PgogIDxyZWN0IHg9IjI1MCIgeT0iMzUwIiB3aWR0aD0iMTMwIiBoZWlnaHQ9IjUwIiBmaWxsPSJub25lIiBzdHJva2U9IiNmZjU5MjEiIHN0cm9rZS13aWR0aD0iNCIgc3Ryb2tlLWRhc2hhcnJheT0iMywyIiB0cmFuc2Zvcm09InJvdGF0ZSgtMTUgMzE1IDM3NSkiLz4KICA8dGV4dCB4PSIzMTUiIHk9IjM4NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0iI2VhNTgyZCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgdHJhbnNmb3JtPSJyb3RhdGUoLTE1IDMxNSAzODUpIj5JTEVHSUJMRTwvdGV4dD4KPC9zdmc+'
            };

            const transaction4 = {
                id: 'dep_sample_4',
                type: 'deposit',
                description: 'Dep√≥sito Banco Atl√°ntida',
                amount: 75.00,
                currency: 'USD',
                status: 'pending_admin_verification',
                timestamp: new Date(Date.now() - 10 * 60 * 1000),
                reference: 'ATL1757000111222',
                method: 'atlantida',
                receiptId: receipt4.id,
                userId: 'user_004',
                isMyTransaction: true,
                category: 'deposit'
            };

            // Add to systems (exclude Lightning - receipt3, transaction3)
            receiptManager.receipts = [receipt1, receipt2, receipt4];
            receiptManager.saveReceipts();

            const allTransactions = [transaction1, transaction2, transaction4];
            localStorage.setItem('transactionHistory', JSON.stringify(allTransactions));

            // Create some admin action history
            const adminActions = [
                {
                    id: 'action_' + (Date.now() - 86400000), // 1 day ago
                    type: 'approved',
                    depositId: 'dep_old_1',
                    amount: 300,
                    currency: 'USD',
                    method: 'atlantida',
                    notes: 'OCR validation successful',
                    timestamp: new Date(Date.now() - 86400000),
                    adminId: 'admin_local'
                },
                {
                    id: 'action_' + (Date.now() - 43200000), // 12 hours ago
                    type: 'rejected',
                    depositId: 'dep_old_2',
                    amount: 150,
                    currency: 'USD',
                    method: 'atlantida',
                    notes: 'Comprobante falsificado',
                    timestamp: new Date(Date.now() - 43200000),
                    adminId: 'admin_local'
                }
            ];
            localStorage.setItem('la_tanda_admin_actions', JSON.stringify(adminActions));


            // Refresh the admin panel
            loadLocalDepositData();
            showNotification('üß™ Datos de prueba creados exitosamente', 'success');
        }

        // Clean old data function
        function cleanOldData() {
            if (!confirm('¬øEst√°s seguro de que quieres limpiar todos los datos antiguos? Esta acci√≥n no se puede deshacer.')) {
                return;
            }


            // List of localStorage keys to clean
            const keysToClean = [
                'transactionHistory',
                'la_tanda_receipts',
                'la_tanda_admin_actions',
                'la_tanda_balances',
                'la_tanda_notifications',
                'la_tanda_user_session'
            ];

            let cleanedCount = 0;
            keysToClean.forEach(key => {
                if (localStorage.getItem(key)) {
                    localStorage.removeItem(key);
                    cleanedCount++;
                }
            });

            // Also clear any window variables
            if (window.adminPanelDeposits) {
                window.adminPanelDeposits = [];
            }

            if (window.receiptManager) {
                window.receiptManager.receipts = [];
            }

            showNotification(`Datos antiguos eliminados (${cleanedCount} elementos)`, 'success');

            // Refresh the page to start clean
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        }

        // Create mock file for testing
        function createMockFile(fileName, type, size) {
            // Create a minimal mock file object for testing
            return {
                name: fileName,
                type: type,
                size: size,
                lastModified: Date.now()
            };
        }

        // Enhanced statistics using real admin panel data
        function updateEnhancedStatistics() {
            // Use the real admin panel data instead of receipt manager
            if (!window.adminPanelDeposits || !Array.isArray(window.adminPanelDeposits)) {
                return;
            }

            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            // Get admin actions
            const adminActions = JSON.parse(localStorage.getItem('la_tanda_admin_actions') || '[]');
            const todayActions = adminActions.filter(action => {
                const actionDate = new Date(action.timestamp);
                return actionDate >= today;
            });

            // Use real admin panel deposits data
            const pending = window.adminPanelDeposits;

            // Calculate statistics with multi-currency support
            const currencyTotals = pending.reduce((totals, dep) => {
                const currency = dep.currency || 'USD';
                totals[currency] = (totals[currency] || 0) + (dep.amount || 0);
                return totals;
            }, {});

            // Calculate primary currency and display format
            const primaryCurrency = Object.keys(currencyTotals).reduce((a, b) =>
                currencyTotals[a] > currencyTotals[b] ? a : b, 'USD');

            const totalAmount = currencyTotals[primaryCurrency] || 0;

            // Create multi-currency display string
            const currencyDisplay = Object.entries(currencyTotals)
                .map(([currency, amount]) => formatCurrency(amount, currency))
                .join(' + ');


            // Calculate statistics with correct property names
            const stats = {
                total_pending: pending.length,
                total_amount: totalAmount,
                total_amount_display: currencyDisplay, // Multi-currency display
                primary_currency: primaryCurrency,
                pending_deposits: pending.length, // Keep both for compatibility
                total_pending_amount: totalAmount,
                approved_today: todayActions.filter(a => a.type === 'approved').length,
                rejected_today: todayActions.filter(a => a.type === 'rejected').length,
                high_confidence_ocr: pending.filter(r => r._localData?.ocrResult?.confidence >= 80).length,
                low_confidence_ocr: pending.filter(r => r._localData?.ocrResult?.confidence < 50).length,
                avg_processing_time: calculateAverageProcessingTime(pending),
                oldest_pending: getOldestPendingDeposit(pending),
                avg_confidence: pending.reduce((sum, r) => sum + (r._localData?.ocrResult?.confidence || 0), 0) / (pending.length || 1),
                auto_processable: pending.filter(r => r._localData?.ocrResult?.confidence >= 80).length,
                banks_distribution: {
                    atlantida: pending.filter(r => r.bank_name === 'Banco Atl√°ntida').length,
                    lightning: pending.filter(r => r.bank_name === 'Lightning Network').length,
                    others: pending.filter(r => r.bank_name && r.bank_name !== 'Banco Atl√°ntida' && r.bank_name !== 'Lightning Network').length
                },
                banks_summary: { 'Banco Atl√°ntida': true, 'Lightning Network': true } // For banks count
            };

            // Update main stats
            if (typeof displayStats === 'function') {
                displayStats(stats);
            }

            // Update enhanced stats in header if elements exist
            updateHeaderStatistics(stats);

            return stats;
        }

        function calculateAverageProcessingTime(pending) {
            if (pending.length === 0) return 0;

            const now = new Date();
            const totalMinutes = pending.reduce((sum, deposit) => {
                // Support both receipt uploadTime and admin panel created_at
                const uploadTime = new Date(deposit.uploadTime || deposit.created_at);
                const diffMinutes = Math.floor((now - uploadTime) / (1000 * 60));
                return sum + diffMinutes;
            }, 0);

            return Math.round(totalMinutes / pending.length);
        }

        function getOldestPendingDeposit(pending) {
            if (pending.length === 0) return null;

            return pending.reduce((oldest, current) => {
                // Support both receipt uploadTime and admin panel created_at
                const oldestTime = new Date(oldest.uploadTime || oldest.created_at);
                const currentTime = new Date(current.uploadTime || current.created_at);
                return currentTime < oldestTime ? current : oldest;
            });
        }

        function updateHeaderStatistics(stats) {
            // DISABLED: This was creating duplicate stat cards with the main dashboard
            // The main dashboard already shows these statistics properly
            return;

            /*
            // Add enhanced statistics to header if not already there
            const header = document.querySelector('.header');
            if (!header) return;

            let enhancedStats = document.getElementById('enhanced-stats');
            if (!enhancedStats) {
                enhancedStats = document.createElement('div');
                enhancedStats.id = 'enhanced-stats';
                enhancedStats.style.cssText = `
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                    gap: 12px;
                    margin-top: 16px;
                    padding-top: 16px;
                    border-top: 1px solid var(--border-color);
                `;
                header.appendChild(enhancedStats);
            }

            enhancedStats.innerHTML = `
                <div class="mini-stat">
                    <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary-color);">${stats.high_confidence_ocr}</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">OCR Alta Confianza</div>
                </div>
                <div class="mini-stat">
                    <div style="font-size: 1.2rem; font-weight: bold; color: var(--warning-color);">${stats.low_confidence_ocr}</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">OCR Baja Confianza</div>
                </div>
                <div class="mini-stat">
                    <div style="font-size: 1.2rem; font-weight: bold; color: var(--text-primary);">${stats.avg_processing_time}min</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Tiempo Promedio</div>
                </div>
                <div class="mini-stat">
                    <div style="font-size: 1.2rem; font-weight: bold; color: ${stats.oldest_pending ? 'var(--danger-color)' : 'var(--success-color)'};">
                        ${stats.oldest_pending ? Math.floor((Date.now() - new Date(stats.oldest_pending.uploadTime)) / (1000 * 60 * 60)) + 'h' : '0h'}
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">M√°s Antiguo</div>
                </div>
            `;
            */
        }

        // Auto-refresh enhanced statistics - DISABLED: Conflicts with real wallet data
        // This was overwriting correct statistics from createAdminDataFromWallet() with zeros
        /*
        setInterval(() => {
            if (receiptManager) {
                updateEnhancedStatistics();
            }
        }, 30000); // Every 30 seconds
        */

        // Integration complete - using displayDeposits directly


        // ================================
        // üè¶ WITHDRAWAL MANAGEMENT FUNCTIONS
        // ================================

        function updateWithdrawalStatistics(withdrawals) {
            try {
                // Calculate withdrawal statistics
                const totalWithdrawals = withdrawals.length;

                // Calculate total amount by currency
                const currencyTotals = withdrawals.reduce((totals, withdrawal) => {
                    const currency = withdrawal.method === 'crypto' ? 'USDT' : 'HNL';
                    totals[currency] = (totals[currency] || 0) + (withdrawal.amount || 0);
                    return totals;
                }, {});

                // Create multi-currency display
                const totalAmountDisplay = Object.entries(currencyTotals)
                    .map(([currency, amount]) => formatCurrency(amount, currency))
                    .join(' + ') || '$0.00';

                // Calculate average processing time
                let avgTime = 0;
                let oldestTime = 0;
                if (withdrawals.length > 0) {
                    const times = withdrawals.map(w => {
                        const timeElapsed = Date.now() - new Date(w.created_at).getTime();
                        return Math.floor(timeElapsed / (1000 * 60 * 60)); // hours
                    });
                    avgTime = Math.round(times.reduce((a, b) => a + b, 0) / times.length);
                    oldestTime = Math.max(...times);
                }

                // Update main dashboard cards
                const totalWithdrawalsCardEl = document.getElementById('totalWithdrawalsCard');
                if (totalWithdrawalsCardEl) {
                    totalWithdrawalsCardEl.textContent = totalWithdrawals + ' Pendientes';
                }

                const totalWithdrawalAmountCardEl = document.getElementById('totalWithdrawalAmountCard');
                if (totalWithdrawalAmountCardEl) {
                    totalWithdrawalAmountCardEl.textContent = totalAmountDisplay;
                }


            } catch (error) {
                // Set fallback values for main dashboard cards
                const totalWithdrawalsCardEl = document.getElementById('totalWithdrawalsCard');
                if (totalWithdrawalsCardEl) totalWithdrawalsCardEl.textContent = '0 Pendientes';

                const totalWithdrawalAmountCardEl = document.getElementById('totalWithdrawalAmountCard');
                if (totalWithdrawalAmountCardEl) totalWithdrawalAmountCardEl.textContent = '$0.00';
            }
        }

        async function loadPendingWithdrawals() {
            const refreshBtn = document.querySelector('.withdrawals-section .refresh-btn');
            const originalContent = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cargando...';

            try {
                // Load withdrawal data from API (PostgreSQL)
                const response = await makeAuthenticatedRequest("https://latanda.online/api/admin/withdrawals/pending", {
                    method: "GET"
                });

                const data = await response.json();

                if (data.success && data.data) {
                    const pendingWithdrawals = data.data.withdrawals || [];
                    displayWithdrawals(pendingWithdrawals);
                    updateWithdrawalStatistics(pendingWithdrawals);
                } else {
                    displayWithdrawals([]);
                    updateWithdrawalStatistics([]);
                }
            } catch (error) {
                showNotification('Error cargando retiros', 'error');
                displayWithdrawals([]);
                updateWithdrawalStatistics([]);
            } finally {
                setTimeout(() => {
                    refreshBtn.innerHTML = originalContent;
                }, 1000);
            }
        }

        function displayWithdrawals(withdrawals) {
            const container = document.getElementById('withdrawalsContainer');

            if (withdrawals.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-money-bill-wave"></i>
                        <h3>No hay retiros pendientes</h3>
                        <p>Todos los retiros han sido procesados</p>
                    </div>
                `;
                return;
            }

            const table = `
                <table class="withdrawals-table">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Monto</th>
                            <th>Cuenta Bancaria</th>
                            <th>Estado</th>
                            <th>Fecha</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${withdrawals.map(withdrawal => `
                            <tr>
                                <td>
                                    <strong>${withdrawal.user_name || 'Usuario'}</strong><br>
                                    <small>ID: ${withdrawal.id.slice(-8)}</small>
                                </td>
                                <td>
                                    <strong style="color: var(--danger-color);">${withdrawal.method === 'crypto' ? '$' : 'L.'} ${withdrawal.amount.toFixed(2)}</strong><br>
                                    <small>M√©todo: ${withdrawal.method}</small>
                                </td>
                                <td>
                                    ${renderBankInfo({bank: withdrawal.bank_name || withdrawal.provider || withdrawal.network, account_number: withdrawal.account_number || withdrawal.phone_number || withdrawal.wallet_address, account_holder: withdrawal.account_holder || withdrawal.user_name})}
                                </td>
                                <td>
                                    <span class="status-badge status-pending">
                                        <i class="fas fa-clock"></i> Pendiente
                                    </span>
                                </td>
                                <td>
                                    <div>${formatWithdrawalDate(withdrawal.created_at)}</div>
                                    <small style="color: var(--text-secondary);">
                                        ${getTimeAgo(withdrawal.created_at)}
                                    </small>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-info btn-sm" onclick="showWithdrawalDetails('${withdrawal.id}')">
                                            <i class="fas fa-eye"></i> Ver Detalles
                                        </button>
                                        <button class="btn btn-confirm btn-sm" onclick="processWithdrawal('${withdrawal.id}')">
                                            <i class="fas fa-check"></i> Procesar
                                        </button>
                                        <button class="btn btn-reject btn-sm" onclick="rejectWithdrawal('${withdrawal.id}')">
                                            <i class="fas fa-times"></i> Rechazar
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = table;
        }

        function renderBankInfo(account) {
            if (!account) return '<small style="color: var(--text-secondary);">Sin informaci√≥n bancaria</small>';

            // Handle both old and new account structure formats
            const bankName = account.bank || account.bankName || 'Banco no especificado';
            const accountNumber = account.account_number || account.accountNumber || '';
            const accountHolder = account.account_holder || account.accountHolder || 'Titular no especificado';
            const isVerified = account.verified || false;

            return `
                <div class="bank-summary">
                    <strong>${bankName}</strong><br>
                    <small style="font-family: monospace;">****${accountNumber.toString().slice(-4)}</small><br>
                    <small style="color: var(--text-secondary);">${accountHolder}</small>
                    ${isVerified ? '<span class="account-verified">‚úÖ Verificado</span>' : ''}
                </div>
            `;
        }

        function showWithdrawalDetails(withdrawalId) {
            const walletTransactions = JSON.parse(localStorage.getItem('transactionHistory') || '[]');
            const withdrawal = walletTransactions.find(tx => tx.id === withdrawalId);

            if (!withdrawal) {
                showNotification('Retiro no encontrado', 'error');
                return;
            }

            const modal = document.getElementById('withdrawalDetailsModal');
            const infoDiv = document.getElementById('withdrawalDetailsInfo');

            infoDiv.innerHTML = `
                <div class="withdrawal-details">
                    <div class="detail-section">
                        <h4>üìÑ Informaci√≥n del Retiro</h4>
                        <div class="detail-row">
                            <span>ID de Transacci√≥n:</span>
                            <span style="font-family: monospace;">${withdrawal.id}</span>
                        </div>
                        <div class="detail-row">
                            <span>Monto:</span>
                            <span style="color: var(--danger-color); font-weight: bold;">${withdrawal.method === 'crypto' ? '$' : 'L.'} ${withdrawal.amount.toFixed(2)}</span>
                        </div>
                        <div class="detail-row">
                            <span>Comisi√≥n:</span>
                            <span>${(withdrawal.fee || 0).toFixed(2)} ${escapeHtml(withdrawal.currency)}</span>
                        </div>
                        <div class="detail-row">
                            <span>Neto a transferir:</span>
                            <span style="font-weight: bold;">${(withdrawal.amount - (withdrawal.fee || 0)).toFixed(2)} ${escapeHtml(withdrawal.currency)}</span>
                        </div>
                        <div class="detail-row">
                            <span>Fecha de solicitud:</span>
                            <span>${formatWithdrawalDate(withdrawal.created_at)}</span>
                        </div>
                    </div>

                    ${withdrawal.withdrawalAccount ? `
                    <div class="detail-section">
                        <div class="bank-info">
                            <h4>üè¶ Informaci√≥n Bancaria para Transferencia</h4>
                            <div class="bank-detail">
                                <span class="label">Banco:</span>
                                <span class="value">${escapeHtml(withdrawal.withdrawalAccount.bank)}</span>
                            </div>
                            <div class="bank-detail">
                                <span class="label">N√∫mero de Cuenta:</span>
                                <span class="value">${escapeHtml(withdrawal.withdrawalAccount.account_number)}</span>
                            </div>
                            <div class="bank-detail">
                                <span class="label">Titular:</span>
                                <span class="value">${escapeHtml(withdrawal.withdrawalAccount.account_holder)}</span>
                            </div>
                            <div class="bank-detail">
                                <span class="label">Tipo de Cuenta:</span>
                                <span class="value">${withdrawal.withdrawalAccount.account_type || 'No especificado'}</span>
                            </div>
                            <div class="bank-detail">
                                <span class="label">Estado:</span>
                                <span class="value ${withdrawal.withdrawalAccount.verified ? 'account-verified' : ''}">
                                    ${withdrawal.withdrawalAccount.verified ? '‚úÖ Verificado' : '‚ö†Ô∏è No verificado'}
                                </span>
                            </div>
                            ${withdrawal.admin_instructions ? `
                            <div class="bank-detail">
                                <span class="label">Referencia:</span>
                                <span class="value">${withdrawal.admin_instructions.reference}</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;

            // Store current withdrawal for copy function
            window.currentWithdrawalDetails = withdrawal;
            modal.style.display = 'flex';
        }

        // Enhanced copy functions for the improved modal
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('‚úÖ Copiado al portapapeles', 'success');
            }).catch(() => {
                showNotification('‚ùå Error al copiar', 'error');
            });
        }

        function copyAllBankingInfo() {
            if (!window.currentWithdrawalDetails?.withdrawalAccount) {
                showNotification('No hay datos bancarios para copiar', 'warning');
                return;
            }

            const account = window.currentWithdrawalDetails.withdrawalAccount;
            const withdrawal = window.currentWithdrawalDetails;
            const netAmount = withdrawal.amount - (withdrawal.fee || 0);

            const bankingText = `üè¶ INSTRUCCIONES DE TRANSFERENCIA BANCARIA
========================================

üí∞ MONTO A TRANSFERIR: ${netAmount.toFixed(2)} ${escapeHtml(withdrawal.currency)}

üè¶ DATOS BANCARIOS:
‚Ä¢ Banco: ${escapeHtml(account.bank)}
‚Ä¢ N√∫mero de Cuenta: ${escapeHtml(account.account_number)}
‚Ä¢ Titular: ${escapeHtml(account.account_holder)}
‚Ä¢ Tipo de Cuenta: ${account.account_type || 'Ahorros'}

üìù INFORMACI√ìN DE REFERENCIA:
‚Ä¢ C√≥digo de Referencia: ${withdrawal.admin_instructions?.reference || withdrawal.id.slice(-8).toUpperCase()}
‚Ä¢ ID de Transacci√≥n: ${withdrawal.id}
‚Ä¢ Usuario: ${withdrawal.user_name || 'Usuario'}
‚Ä¢ Fecha de Solicitud: ${formatWithdrawalDate(withdrawal.created_at)}

‚ö†Ô∏è IMPORTANTE:
- Verificar que el titular coincida con los documentos del usuario
- Usar el c√≥digo de referencia en la transferencia
- Marcar como procesado una vez completada la transferencia`;

            navigator.clipboard.writeText(bankingText).then(() => {
                showNotification('‚úÖ Informaci√≥n bancaria completa copiada', 'success');
            }).catch(() => {
                showNotification('‚ùå Error al copiar datos', 'error');
            });
        }

        function copyBankingDetails() {
            if (!window.currentWithdrawalDetails?.withdrawalAccount) {
                showNotification('No hay datos bancarios para copiar', 'warning');
                return;
            }

            const account = window.currentWithdrawalDetails.withdrawalAccount;
            const withdrawal = window.currentWithdrawalDetails;

            const bankingText = `DATOS PARA TRANSFERENCIA BANCARIA
=================================
Monto a transferir: ${(withdrawal.amount - (withdrawal.fee || 0)).toFixed(2)} ${escapeHtml(withdrawal.currency)}
Banco: ${escapeHtml(account.bank)}
N√∫mero de Cuenta: ${escapeHtml(account.account_number)}
Titular: ${escapeHtml(account.account_holder)}
Tipo de Cuenta: ${account.account_type || 'No especificado'}
Referencia: ${withdrawal.admin_instructions?.reference || withdrawal.id}

ID de Transacci√≥n: ${withdrawal.id}
Fecha de solicitud: ${formatWithdrawalDate(withdrawal.created_at)}`;

            navigator.clipboard.writeText(bankingText).then(() => {
                showNotification('‚úÖ Datos bancarios copiados al portapapeles', 'success');
            }).catch(() => {
                showNotification('‚ùå Error al copiar datos', 'error');
            });
        }

        function processWithdrawal(withdrawalId) {
            const walletTransactions = JSON.parse(localStorage.getItem('transactionHistory') || '[]');
            const withdrawal = walletTransactions.find(tx => tx.id === withdrawalId);

            if (!withdrawal) {
                showNotification('Retiro no encontrado', 'error');
                return;
            }

            const modal = document.getElementById('processWithdrawalModal');
            const infoDiv = document.getElementById('processWithdrawalInfo');

            infoDiv.innerHTML = `
                <div class="process-info">
                    <p><strong>Confirmar procesamiento del retiro:</strong></p>
                    <div style="background: rgba(0, 255, 255, 0.05); padding: 12px; border-radius: 8px; margin: 12px 0;">
                        <div>Monto: <strong style="color: var(--danger-color);">${withdrawal.method === 'crypto' ? '$' : 'L.'} ${withdrawal.amount.toFixed(2)}</strong></div>
                        <div>Titular: <strong>${withdrawal.withdrawalAccount?.account_holder || 'No especificado'}</strong></div>
                        <div>Banco: <strong>${withdrawal.withdrawalAccount?.bank || 'No especificado'}</strong></div>
                        <div>Cuenta: <strong>${withdrawal.withdrawalAccount?.account_number || 'No especificado'}</strong></div>
                    </div>
                </div>
            `;

            window.currentProcessingWithdrawal = withdrawalId;
            modal.style.display = 'flex';
        }

        function confirmWithdrawalProcessing() {
            const withdrawalId = window.currentProcessingWithdrawal;
            const processingNotes = document.getElementById('processingNotes').value.trim();
            const transferReceiptFile = document.getElementById('transferReceipt').files[0];

            try {
                // Update transaction status
                const walletTransactions = JSON.parse(localStorage.getItem('transactionHistory') || '[]');
                const withdrawalIndex = walletTransactions.findIndex(tx => tx.id === withdrawalId);

                if (withdrawalIndex === -1) {
                    throw new Error('Retiro no encontrado');
                }

                // Handle receipt upload
                if (transferReceiptFile) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const receiptData = {
                            name: transferReceiptFile.name,
                            type: transferReceiptFile.type,
                            size: transferReceiptFile.size,
                            data: e.target.result,
                            uploadedAt: new Date().toISOString(),
                            uploadedBy: currentUser.name
                        };

                        // Complete the processing with receipt
                        completeWithdrawalProcessing(withdrawalIndex, walletTransactions, processingNotes, receiptData, withdrawalId);
                    };
                    reader.readAsDataURL(transferReceiptFile);
                } else {
                    // Complete processing without receipt
                    completeWithdrawalProcessing(withdrawalIndex, walletTransactions, processingNotes, null, withdrawalId);
                }

            } catch (error) {
                showNotification('‚ùå Error al procesar retiro: ' + error.message, 'error');
            }
        }

        function completeWithdrawalProcessing(withdrawalIndex, walletTransactions, processingNotes, receiptData, withdrawalId) {
            // Generate a unique reference number
            const referenceNumber = 'TRF-' + Date.now().toString().slice(-8);

            // Update transaction with complete processing information
            walletTransactions[withdrawalIndex].status = 'completed';
            walletTransactions[withdrawalIndex].processedAt = new Date().toISOString();
            walletTransactions[withdrawalIndex].processedBy = currentUser.name;
            walletTransactions[withdrawalIndex].processingNotes = processingNotes;
            walletTransactions[withdrawalIndex].referenceNumber = referenceNumber;

            if (receiptData) {
                walletTransactions[withdrawalIndex].transferReceipt = receiptData;
                walletTransactions[withdrawalIndex].hasReceipt = true;
            }

            // Create proof of completion
            walletTransactions[withdrawalIndex].completionProof = {
                processedAt: new Date().toISOString(),
                processedBy: currentUser.name,
                referenceNumber: referenceNumber,
                processingNotes: processingNotes,
                confirmationCode: 'CFM-' + Math.random().toString(36).substr(2, 8).toUpperCase(),
                hasReceipt: !!receiptData
            };

            // Save updated transactions
            localStorage.setItem('transactionHistory', JSON.stringify(walletTransactions));

            // Notify user via admin updates with comprehensive information
            const adminUpdates = JSON.parse(localStorage.getItem('latanda_transaction_updates') || '{}');
            adminUpdates[withdrawalId] = {
                status: 'completed',
                admin_message: `Retiro procesado exitosamente. ${processingNotes || 'Transferencia completada.'}`,
                processed_at: new Date().toISOString(),
                processed_by: currentUser.name,
                reference_number: referenceNumber,
                confirmation_code: walletTransactions[withdrawalIndex].completionProof.confirmationCode,
                has_receipt: !!receiptData,
                processing_notes: processingNotes
            };
            localStorage.setItem('latanda_transaction_updates', JSON.stringify(adminUpdates));

            showNotification('‚úÖ Retiro procesado exitosamente - Referencia: ' + referenceNumber, 'success');
            closeModal();
            loadPendingWithdrawals();
        }

        function rejectWithdrawal(withdrawalId) {
            const walletTransactions = JSON.parse(localStorage.getItem('transactionHistory') || '[]');
            const withdrawal = walletTransactions.find(tx => tx.id === withdrawalId);

            if (!withdrawal) {
                showNotification('Retiro no encontrado', 'error');
                return;
            }

            const modal = document.getElementById('rejectWithdrawalModal');
            const infoDiv = document.getElementById('rejectWithdrawalInfo');

            infoDiv.innerHTML = `
                <div class="reject-info">
                    <p><strong>Rechazar el siguiente retiro:</strong></p>
                    <div style="background: rgba(239, 68, 68, 0.05); padding: 12px; border-radius: 8px; margin: 12px 0;">
                        <div>Monto: <strong>${withdrawal.method === 'crypto' ? '$' : 'L.'} ${withdrawal.amount.toFixed(2)}</strong></div>
                        <div>Usuario: <strong>${withdrawal.user_name || 'Usuario'}</strong></div>
                        <div>Solicitud: <strong>${formatWithdrawalDate(withdrawal.created_at)}</strong></div>
                    </div>
                    <p style="color: var(--warning-color);"><i class="fas fa-exclamation-triangle"></i> El monto ser√° devuelto al balance del usuario.</p>
                </div>
            `;

            window.currentRejectingWithdrawal = withdrawalId;
            modal.style.display = 'flex';
        }

        function confirmWithdrawalRejection() {
            const withdrawalId = window.currentRejectingWithdrawal;
            const rejectionReason = document.getElementById('withdrawalRejectionReason').value;
            const rejectionNotes = document.getElementById('withdrawalRejectionNotes').value.trim();

            if (!rejectionReason) {
                showNotification('Debe seleccionar un motivo de rechazo', 'error');
                return;
            }

            try {
                // Update transaction status
                const walletTransactions = JSON.parse(localStorage.getItem('transactionHistory') || '[]');
                const withdrawalIndex = walletTransactions.findIndex(tx => tx.id === withdrawalId);

                if (withdrawalIndex === -1) {
                    throw new Error('Retiro no encontrado');
                }

                const withdrawal = walletTransactions[withdrawalIndex];

                walletTransactions[withdrawalIndex].status = 'rejected';
                walletTransactions[withdrawalIndex].rejectedAt = new Date().toISOString();
                walletTransactions[withdrawalIndex].rejectedBy = currentUser.name;
                walletTransactions[withdrawalIndex].rejectionReason = rejectionReason;
                walletTransactions[withdrawalIndex].rejectionNotes = rejectionNotes;

                // Restore user balance (return the amount back) - try multiple balance key formats
                let balanceUpdated = false;

                // Try wallet's main balance format first
                try {
                    const balances = JSON.parse(localStorage.getItem('balances') || '{"USD": 0, "HNL": 0}');
                    balances[withdrawal.currency] = (balances[withdrawal.currency] || 0) + withdrawal.amount;
                    localStorage.setItem('balances', JSON.stringify(balances));
                    balanceUpdated = true;
                } catch (e) {
                }

                // Also try la_tanda_balances format as backup
                try {
                    const ltBalances = JSON.parse(localStorage.getItem('la_tanda_balances') || '{"USD": 0, "HNL": 0}');
                    ltBalances[withdrawal.currency] = (ltBalances[withdrawal.currency] || 0) + withdrawal.amount;
                    localStorage.setItem('la_tanda_balances', JSON.stringify(ltBalances));
                } catch (e) {
                }

                // Save updated transactions
                localStorage.setItem('transactionHistory', JSON.stringify(walletTransactions));

                // Create comprehensive admin update notification for wallet
                const adminUpdates = JSON.parse(localStorage.getItem('latanda_transaction_updates') || '{}');
                adminUpdates[withdrawalId] = {
                    status: 'rejected',
                    admin_message: `Retiro rechazado: ${getRejectionReasonText(rejectionReason)}. ${rejectionNotes || ''} El monto ha sido devuelto a tu balance.`,
                    rejected_at: new Date().toISOString(),
                    rejected_by: currentUser.name,
                    amount_restored: withdrawal.amount,
                    currency: withdrawal.currency,
                    type: 'withdrawal_rejection'
                };
                localStorage.setItem('latanda_transaction_updates', JSON.stringify(adminUpdates));

                showNotification('‚ùå Retiro rechazado. Monto devuelto al usuario.', 'success');
                closeModal();

                // Force refresh to show updated status immediately
                setTimeout(() => {
                    loadPendingWithdrawals();
                }, 500);

            } catch (error) {
                showNotification('‚ùå Error al rechazar retiro: ' + error.message, 'error');
            }
        }

        function getRejectionReasonText(reason) {
            const reasons = {
                'insufficient_funds': 'Fondos insuficientes',
                'invalid_account': 'Datos bancarios inv√°lidos',
                'unverified_account': 'Cuenta no verificada',
                'suspicious_activity': 'Actividad sospechosa',
                'system_maintenance': 'Mantenimiento del sistema',
                'other': 'Motivo adicional especificado'
            };
            return reasons[reason] || reason;
        }

        function formatWithdrawalDate(timestamp) {
            return new Date(timestamp).toLocaleDateString('es-HN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getTimeAgo(timestamp) {
            const now = Date.now();
            const time = new Date(timestamp).getTime();
            const diffMinutes = Math.floor((now - time) / (1000 * 60));

            if (diffMinutes < 60) return `${diffMinutes}m`;
            const diffHours = Math.floor(diffMinutes / 60);
            if (diffHours < 24) return `${diffHours}h`;
            const diffDays = Math.floor(diffHours / 24);
            return `${diffDays}d`;
        }

        // Auto-load withdrawals when page loads
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                loadPendingWithdrawals();
            }, 2000); // Load after deposits are loaded
        });


        // ================================
        // üß™ TESTING FUNCTIONS
        // ================================

        // Function to create test withdrawal for demonstration
        function createTestWithdrawal() {
            const testWithdrawal = {
                id: 'withdrawal_test_' + Date.now(),
                type: 'withdrawal',
                amount: 200.00,
                currency: 'USD',
                fee: 5.00,
                status: 'pending',
                timestamp: new Date().toISOString(),
                userId: 'user_local_001',
                description: 'Retiro de mi wallet personal',
                withdrawalAccount: {
                    bank: 'Banco Atl√°ntida',
                    account_number: '1234567890',
                    account_holder: 'Juan P√©rez Gonz√°lez',
                    account_type: 'savings',
                    currency: 'USD',
                    verified: true,
                    verification_date: '2024-01-15'
                },
                admin_instructions: {
                    platform: 'Banking',
                    bank_name: 'Banco Atl√°ntida',
                    account_number: '1234567890',
                    account_holder: 'Juan P√©rez Gonz√°lez',
                    amount: 200.00,
                    currency: 'USD',
                    reference: 'WITHDRAWAL_' + Date.now(),
                    priority: 'MEDIUM',
                    execution_time: '1-2_business_days'
                }
            };

            // Add to localStorage
            const transactions = JSON.parse(localStorage.getItem('transactionHistory') || '[]');
            transactions.push(testWithdrawal);
            localStorage.setItem('transactionHistory', JSON.stringify(transactions));

            showNotification('‚úÖ Transacci√≥n de retiro de prueba creada', 'success');

            // Refresh the withdrawals view
            loadPendingWithdrawals();
        }

        // Auto-create test withdrawal DISABLED - causing interference with real debugging
        // setTimeout(() => {
        //     const transactions = JSON.parse(localStorage.getItem('transactionHistory') || '[]');
        //     const withdrawals = transactions.filter(tx => tx.type === 'withdrawal');

        //     if (withdrawals.length === 0) {
        //         console.log('üß™ No withdrawals found, creating test withdrawal for demonstration...');
        //         createTestWithdrawal();
        //     }
        // }, 3000);

        // Global function for manual testing
        window.createTestWithdrawal = createTestWithdrawal;

        // ================================
        // üîî APPEALS MANAGEMENT SYSTEM
        // ================================

        async function loadPendingAppeals() {
            const refreshBtn = document.querySelector('.appeals-section .refresh-btn');
            const originalContent = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cargando...';

            try {
                // Load appeals from localStorage
                const adminAppeals = JSON.parse(localStorage.getItem('admin_appeals_queue') || '[]');
                const pendingAppeals = adminAppeals.filter(appeal => appeal.status === 'pending_review');

                displayAppeals(pendingAppeals);
                updateAppealsStatistics(pendingAppeals);

            } catch (error) {
                showNotification('Error cargando apelaciones', 'error');
            } finally {
                setTimeout(() => {
                    refreshBtn.innerHTML = originalContent;
                }, 1000);
            }
        }

        function displayAppeals(appeals) {
            const container = document.getElementById('appealsContainer');

            if (appeals.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-gavel"></i>
                        <h3>No hay apelaciones pendientes</h3>
                        <p>Todas las apelaciones han sido revisadas</p>
                    </div>
                `;
                return;
            }

            const table = `
                <table class="appeals-table">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Tipo</th>
                            <th>Monto</th>
                            <th>Rechazo Original</th>
                            <th>Motivo Apelaci√≥n</th>
                            <th>Fecha</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${appeals.map(appeal => `
                            <tr class="appeal-row">
                                <td>
                                    <div class="user-info">
                                        <div class="user-name">${escapeHtml(appeal.userId)}</div>
                                        <div class="transaction-desc">${escapeHtml(appeal.description)}</div>
                                        <div class="transaction-id">ID: ${escapeHtml(appeal.transactionId)}</div>
                                    </div>
                                </td>
                                <td>
                                    <div class="transaction-type-container">
                                        <span class="transaction-type-badge ${escapeHtml(appeal.transactionType)}">
                                            <i class="fas ${appeal.transactionType === 'deposit' ? 'fa-arrow-down' : 'fa-arrow-up'}"></i>
                                            ${appeal.transactionType === 'deposit' ? 'Dep√≥sito' : 'Retiro'}
                                        </span>
                                    </div>
                                </td>
                                <td>
                                    <div class="amount-display">
                                        <div class="amount-value">${formatCurrency(appeal.amount, appeal.currency)}</div>
                                        <div class="currency-label">${appeal.currency}</div>
                                    </div>
                                </td>
                                <td>
                                    <div class="rejection-info">
                                        <div class="rejection-label">Motivo original:</div>
                                        <div class="rejection-text">${appeal.originalRejectionReason || 'No especificado'}</div>
                                    </div>
                                </td>
                                <td>
                                    <div class="appeal-info">
                                        <div class="appeal-text">${escapeHtml(appeal.appealReason)}</div>
                                        ${appeal.evidenceFile ? '<div class="evidence-badge"><i class="fas fa-paperclip"></i> Evidencia</div>' : ''}
                                    </div>
                                </td>
                                <td>
                                    <div class="date-display">
                                        <div class="date-value">${formatDate(appeal.appealedAt)}</div>
                                        <div class="time-ago">${getTimeAgo(appeal.appealedAt)}</div>
                                    </div>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="action-btn view-btn" onclick="viewAppealDetails('${appeal.id}')" title="Ver detalles completos">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="action-btn approve-btn" onclick="approveAppeal('${appeal.id}')" title="Aprobar apelaci√≥n">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="action-btn reject-btn" onclick="rejectAppeal('${appeal.id}')" title="Rechazar apelaci√≥n">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = table;
        }

        function updateAppealsStatistics(appeals) {
            const totalAppealsCardEl = document.getElementById('totalAppealsCard');
            const appealsTrendEl = document.getElementById('appealsTrend');

            if (totalAppealsCardEl) {
                totalAppealsCardEl.textContent = appeals.length;
            }

            if (appealsTrendEl) {
                if (appeals.length === 0) {
                    appealsTrendEl.textContent = '‚úÖ Sin apelaciones';
                } else if (appeals.length <= 2) {
                    appealsTrendEl.textContent = 'üìã Pocas pendientes';
                } else {
                    appealsTrendEl.textContent = 'üî• Requieren atenci√≥n';
                }
            }
        }

        // Generic modal function for admin panel
        function showGenericModal(title, content) {
            // Remove existing modal if any
            const existingModal = document.getElementById('genericModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Create modal
            const modal = document.createElement('div');
            modal.id = 'genericModal';
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                    <h3 class="modal-header">${title}</h3>
                    <div class="modal-body">
                        ${content}
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Close on backdrop click
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function viewAppealDetails(appealId) {

            const adminAppeals = JSON.parse(localStorage.getItem('admin_appeals_queue') || '[]');
            const appeal = adminAppeals.find(a => a.id === appealId);


            if (!appeal) {
                showNotification('Apelaci√≥n no encontrada', 'error');
                return;
            }

            const content = `
                <div class="appeal-details-view">
                    <div class="appeal-header">
                        <div class="appeal-status-badge">
                            <i class="fas fa-gavel"></i>
                            Apelaci√≥n Pendiente
                        </div>
                    </div>

                    <div class="appeal-grid">
                        <div class="detail-card">
                            <h4><i class="fas fa-user"></i> Informaci√≥n del Usuario</h4>
                            <div class="detail-row">
                                <span class="label">Usuario:</span>
                                <span class="value">${escapeHtml(appeal.userId)}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">ID Transacci√≥n:</span>
                                <span class="value code">${escapeHtml(appeal.transactionId)}</span>
                            </div>
                        </div>

                        <div class="detail-card">
                            <h4><i class="fas fa-dollar-sign"></i> Detalles de la Transacci√≥n</h4>
                            <div class="detail-row">
                                <span class="label">Tipo:</span>
                                <span class="value">
                                    <span class="type-badge ${escapeHtml(appeal.transactionType)}">
                                        <i class="fas ${appeal.transactionType === 'deposit' ? 'fa-arrow-down' : 'fa-arrow-up'}"></i>
                                        ${appeal.transactionType === 'deposit' ? 'Dep√≥sito' : 'Retiro'}
                                    </span>
                                </span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Monto:</span>
                                <span class="value amount">${formatCurrency(appeal.amount, appeal.currency)}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Descripci√≥n:</span>
                                <span class="value">${escapeHtml(appeal.description)}</span>
                            </div>
                        </div>

                        <div class="detail-card rejection-card">
                            <h4><i class="fas fa-times-circle"></i> Rechazo Original</h4>
                            <div class="detail-row">
                                <span class="label">Motivo:</span>
                                <span class="value rejection-reason">${appeal.originalRejectionReason || 'No especificado'}</span>
                            </div>
                        </div>

                        <div class="detail-card appeal-card">
                            <h4><i class="fas fa-gavel"></i> Apelaci√≥n del Usuario</h4>
                            <div class="detail-row">
                                <span class="label">Fecha:</span>
                                <span class="value">${formatDateTime(appeal.appealedAt)}</span>
                            </div>
                            <div class="detail-row full-width">
                                <span class="label">Motivo de la Apelaci√≥n:</span>
                                <div class="appeal-reason-display">${escapeHtml(appeal.appealReason)}</div>
                            </div>
                            ${appeal.evidenceFile ? `
                                <div class="detail-row">
                                    <span class="label">Evidencia:</span>
                                    <span class="value">
                                        <div class="evidence-container">
                                            <span class="evidence-indicator">
                                                <i class="fas fa-paperclip"></i> ${appeal.evidenceFile}
                                            </span>
                                            <button class="btn-view-evidence" onclick="viewAppealEvidence('${escapeHtml(appeal.transactionId)}')" title="Ver comprobante de la apelaci√≥n">
                                                <i class="fas fa-eye"></i> Ver Comprobante
                                            </button>
                                        </div>
                                    </span>
                                </div>
                            ` : ''}
                        </div>
                    </div>

                    <div class="appeal-actions">
                        <button onclick="document.getElementById('genericModal').remove()" class="btn btn-cancel">
                            <i class="fas fa-times"></i> Cerrar
                        </button>
                        <button onclick="approveAppeal('${appeal.id}'); document.getElementById('genericModal').remove();" class="btn btn-confirm">
                            <i class="fas fa-check"></i> Aprobar Apelaci√≥n
                        </button>
                        <button onclick="rejectAppeal('${appeal.id}'); document.getElementById('genericModal').remove();" class="btn btn-reject">
                            <i class="fas fa-times"></i> Rechazar Apelaci√≥n
                        </button>
                    </div>
                </div>
            `;

            showGenericModal('‚öñÔ∏è Detalles de la Apelaci√≥n', content);
        }

        function viewAppealEvidence(transactionId) {

            // First, look for evidence in the transaction itself
            const walletTransactions = JSON.parse(localStorage.getItem('transactionHistory') || '[]');
            const transaction = walletTransactions.find(tx => tx.id === transactionId);


            if (transaction && transaction.appealEvidence) {

                // Check if evidence has file data
                if (transaction.appealEvidence.dataUrl) {
                    showReceiptImage(
                        transaction.appealEvidence.dataUrl,
                        transaction.appealEvidence.fileName || 'Evidencia de Apelaci√≥n'
                    );
                    return;
                } else if (typeof transaction.appealEvidence === 'string') {
                    // Legacy format - just filename, look in receipts
                }
            }

            // Fallback: Find the receipt associated with this transaction
            const receipts = JSON.parse(localStorage.getItem('la_tanda_receipts') || '[]');
            const transactionReceipt = receipts.find(receipt =>
                receipt.depositId === transactionId ||
                receipt.id.includes(transactionId.split('-').pop()) ||
                receipt.fileName === (transaction?.appealEvidence?.fileName || transaction?.appealEvidence)
            );


            if (transactionReceipt && transactionReceipt.dataUrl) {
                showReceiptImage(transactionReceipt.dataUrl, transactionReceipt.fileName || 'Comprobante de Apelaci√≥n');
                return;
            }

            // Additional fallback: try receipt manager
            if (window.receiptManager && window.receiptManager.receipts) {
                const managerReceipt = window.receiptManager.receipts.find(r =>
                    r.depositId === transactionId ||
                    r.id.includes(transactionId.split('-').pop()) ||
                    r.fileName === (transaction?.appealEvidence?.fileName || transaction?.appealEvidence)
                );
                if (managerReceipt && managerReceipt.dataUrl) {
                    showReceiptImage(managerReceipt.dataUrl, managerReceipt.fileName || 'Comprobante de Apelaci√≥n');
                    return;
                }
            }

            // If we still haven't found anything, show more helpful error
            if (transaction && transaction.appealEvidence) {
                showNotification('‚ö†Ô∏è Se encontr√≥ evidencia de apelaci√≥n pero no se pudo cargar el archivo', 'warning');
            } else {
                showNotification('‚ö†Ô∏è No se encontr√≥ evidencia de apelaci√≥n para esta transacci√≥n', 'warning');
            }
        }

        function showReceiptImage(dataUrl, fileName) {
            const content = `
                <div class="receipt-viewer">
                    <div class="receipt-header">
                        <h4><i class="fas fa-receipt"></i> ${fileName}</h4>
                        <p class="receipt-info">Comprobante adjunto en la apelaci√≥n</p>
                    </div>
                    <div class="receipt-image-container">
                        <img loading="lazy" src="${dataUrl}" alt="Comprobante" class="receipt-image" onclick="openFullscreen('${dataUrl}')">
                        <div class="receipt-actions-overlay">
                            <button class="btn-fullscreen" onclick="openFullscreen('${dataUrl}')" title="Ver en pantalla completa">
                                <i class="fas fa-expand"></i> Pantalla Completa
                            </button>
                        </div>
                    </div>
                    <div class="receipt-actions-bottom">
                        <button onclick="document.getElementById('genericModal').remove()" class="btn btn-cancel">
                            <i class="fas fa-times"></i> Cerrar
                        </button>
                        <button onclick="openFullscreen('${dataUrl}')" class="btn btn-primary">
                            <i class="fas fa-external-link-alt"></i> Abrir en Nueva Pesta√±a
                        </button>
                    </div>
                </div>
            `;

            showGenericModal('üìÑ Comprobante de Apelaci√≥n', content);
        }

        function openFullscreen(dataUrl) {
            const fullscreenWindow = window.open('', '_blank');
            fullscreenWindow.document.write(`
                <html>
                    <head>
                        <title>Comprobante - Apelaci√≥n</title>
                        <style>
                            body {
                                margin: 0;
                                background: #000;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                min-height: 100vh;
                            }
                            img {
                                max-width: 100vw;
                                max-height: 100vh;
                                object-fit: contain;
                                cursor: zoom-in;
                            }
                            img:hover {
                                cursor: zoom-out;
                            }
                        </style>
                    </head>
                    <body>
                        <img loading="lazy" src="${dataUrl}" alt="Comprobante" onclick="window.close()">
                    </body>
                </html>
            `);
        }

        function approveAppeal(appealId) {
            try {
                // Update appeal status
                const adminAppeals = JSON.parse(localStorage.getItem('admin_appeals_queue') || '[]');
                const appealIndex = adminAppeals.findIndex(a => a.id === appealId);

                if (appealIndex === -1) {
                    showNotification('Apelaci√≥n no encontrada', 'error');
                    return;
                }

                const appeal = adminAppeals[appealIndex];
                adminAppeals[appealIndex].status = 'approved';
                adminAppeals[appealIndex].reviewedAt = new Date();
                adminAppeals[appealIndex].reviewedBy = currentUser.name;

                // Update the original transaction status
                const walletTransactions = JSON.parse(localStorage.getItem('transactionHistory') || '[]');
                const transactionIndex = walletTransactions.findIndex(tx => tx.id === appeal.transactionId);

                if (transactionIndex !== -1) {
                    walletTransactions[transactionIndex].status = 'completed';
                    walletTransactions[transactionIndex].appealApproved = true;
                    walletTransactions[transactionIndex].appealApprovedAt = new Date();
                    walletTransactions[transactionIndex].appealApprovedBy = currentUser.name;

                    // For deposits, add to balance
                    if (appeal.transactionType === 'deposit') {
                        // Update balance in localStorage
                        const balances = JSON.parse(localStorage.getItem('balances') || '{"USD": 0, "HNL": 0}');
                        balances[appeal.currency] += appeal.amount;
                        localStorage.setItem('balances', JSON.stringify(balances));
                    }

                    localStorage.setItem('transactionHistory', JSON.stringify(walletTransactions));
                }

                // Create admin update for wallet
                const adminUpdates = JSON.parse(localStorage.getItem('latanda_transaction_updates') || '{}');
                adminUpdates[appeal.transactionId] = {
                    status: 'completed',
                    message: `Tu apelaci√≥n fue aprobada. ${appeal.transactionType === 'deposit' ? 'El monto ha sido agregado a tu balance.' : 'La transacci√≥n fue procesada.'}`,
                    approved_at: new Date(),
                    approved_by: currentUser.name,
                    type: 'appeal_approved'
                };
                localStorage.setItem('latanda_transaction_updates', JSON.stringify(adminUpdates));

                // Save updated appeals
                localStorage.setItem('admin_appeals_queue', JSON.stringify(adminAppeals));

                showNotification('‚úÖ Apelaci√≥n aprobada exitosamente', 'success');

                // Refresh appeals list
                setTimeout(() => {
                    loadPendingAppeals();
                }, 500);

            } catch (error) {
                showNotification('Error al aprobar apelaci√≥n: ' + error.message, 'error');
            }
        }

        function rejectAppeal(appealId) {
            const reason = prompt('Motivo del rechazo de la apelaci√≥n:');
            if (!reason) return;

            try {
                // Update appeal status
                const adminAppeals = JSON.parse(localStorage.getItem('admin_appeals_queue') || '[]');
                const appealIndex = adminAppeals.findIndex(a => a.id === appealId);

                if (appealIndex === -1) {
                    showNotification('Apelaci√≥n no encontrada', 'error');
                    return;
                }

                const appeal = adminAppeals[appealIndex];
                adminAppeals[appealIndex].status = 'rejected';
                adminAppeals[appealIndex].rejectionReason = reason;
                adminAppeals[appealIndex].reviewedAt = new Date();
                adminAppeals[appealIndex].reviewedBy = currentUser.name;

                // Update the original transaction
                const walletTransactions = JSON.parse(localStorage.getItem('transactionHistory') || '[]');
                const transactionIndex = walletTransactions.findIndex(tx => tx.id === appeal.transactionId);

                if (transactionIndex !== -1) {
                    walletTransactions[transactionIndex].status = 'appeal_rejected';
                    walletTransactions[transactionIndex].appealRejected = true;
                    walletTransactions[transactionIndex].appealRejectionReason = reason;
                    walletTransactions[transactionIndex].appealRejectedAt = new Date();
                    walletTransactions[transactionIndex].appealRejectedBy = currentUser.name;
                    walletTransactions[transactionIndex].canAppeal = false;

                    localStorage.setItem('transactionHistory', JSON.stringify(walletTransactions));
                }

                // Create admin update for wallet
                const adminUpdates = JSON.parse(localStorage.getItem('latanda_transaction_updates') || '{}');
                adminUpdates[appeal.transactionId] = {
                    status: 'appeal_rejected',
                    message: `Tu apelaci√≥n fue rechazada. Motivo: ${reason}`,
                    rejected_at: new Date(),
                    rejected_by: currentUser.name,
                    type: 'appeal_rejected'
                };
                localStorage.setItem('latanda_transaction_updates', JSON.stringify(adminUpdates));

                // Save updated appeals
                localStorage.setItem('admin_appeals_queue', JSON.stringify(adminAppeals));

                showNotification('‚ùå Apelaci√≥n rechazada', 'success');

                // Refresh appeals list
                setTimeout(() => {
                    loadPendingAppeals();
                }, 500);

            } catch (error) {
                showNotification('Error al rechazar apelaci√≥n: ' + error.message, 'error');
            }
        }

        // Load appeals on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Add appeals loading to existing initialization
            if (typeof loadPendingAppeals === 'function') {
                setTimeout(loadPendingAppeals, 2000);
            }
        });

        // ================================
        // üïí UTILITY DATE/TIME FUNCTIONS
        // ================================

        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('es-HN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            } catch (error) {
                return dateString;
            }
        }

        function formatTime(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return date.toLocaleTimeString('es-HN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            } catch (error) {
                return dateString;
            }
        }

        function formatDateTime(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return `${formatDate(dateString)} ${formatTime(dateString)}`;
            } catch (error) {
                return dateString;
            }
        }

        function getTimeAgo(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                const now = new Date();
                const diffMs = now - date;
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffDays = Math.floor(diffHours / 24);

                if (diffDays > 0) {
                    return `hace ${diffDays}d`;
                } else if (diffHours > 0) {
                    return `hace ${diffHours}h`;
                } else {
                    const diffMinutes = Math.floor(diffMs / (1000 * 60));
                    return `hace ${diffMinutes}m`;
                }
            } catch (error) {
                return '';
            }
        }

        function getRemainingTime(dateString) {
            if (!dateString) return '48h';
            try {
                const uploadTime = new Date(dateString);
                const now = new Date();
                const diffMs = now - uploadTime;
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const remainingHours = Math.max(0, 48 - diffHours);

                if (remainingHours > 24) {
                    const days = Math.floor(remainingHours / 24);
                    const hours = remainingHours % 24;
                    return hours > 0 ? `${days}d ${hours}h` : `${days}d`;
                } else if (remainingHours > 0) {
                    return `${remainingHours}h`;
                } else {
                    return 'Vencido';
                }
            } catch (error) {
                return '48h';
            }
        }

        // ================================
        // üìä DEPOSIT TABS MANAGEMENT SYSTEM
        // ================================

        let currentDepositTab = 'pending';

        function switchDepositTab(tabName) {
            currentDepositTab = tabName;

            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // Load deposits for selected tab
            loadDepositsByStatus();
        }

        function loadDepositsByStatus() {
            const refreshBtn = document.querySelector('.refresh-btn');
            const originalContent = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cargando...';

            try {

                // Load wallet transactions
                const walletTransactions = JSON.parse(localStorage.getItem('transactionHistory') || '[]');
                const depositTransactions = walletTransactions.filter(tx => tx.type === 'deposit');

                // Filter by current tab
                let filteredDeposits = [];
                switch(currentDepositTab) {
                    case 'pending':
                        filteredDeposits = depositTransactions.filter(tx =>
                            tx.status === 'pending_verification' ||
                            tx.status === 'pending' ||
                            tx.status === 'pending_approval'
                        );
                        break;
                    case 'completed':
                        filteredDeposits = depositTransactions.filter(tx =>
                            tx.status === 'completed' ||
                            tx.status === 'confirmed'
                        );
                        break;
                    case 'rejected':
                        filteredDeposits = depositTransactions.filter(tx =>
                            tx.status === 'rejected' ||
                            tx.status === 'appeal_rejected'
                        );
                        break;
                }

                // Update tab counters
                updateTabCounters(depositTransactions);

                // Display deposits
                displayDepositsByTab(filteredDeposits);


            } catch (error) {
                showNotification('Error cargando dep√≥sitos', 'error');
            } finally {
                setTimeout(() => {
                    refreshBtn.innerHTML = originalContent;
                }, 1000);
            }
        }

        function updateTabCounters(allDeposits) {
            const pending = allDeposits.filter(tx =>
                tx.status === 'pending_verification' ||
                tx.status === 'pending' ||
                tx.status === 'pending_approval'
            ).length;

            const completed = allDeposits.filter(tx =>
                tx.status === 'completed' ||
                tx.status === 'confirmed'
            ).length;

            const rejected = allDeposits.filter(tx =>
                tx.status === 'rejected' ||
                tx.status === 'appeal_rejected'
            ).length;

            document.getElementById('pending-count').textContent = pending;
            document.getElementById('completed-count').textContent = completed;
            document.getElementById('rejected-count').textContent = rejected;
        }

        function displayDepositsByTab(deposits) {
            const container = document.getElementById('depositsContainer');

            if (deposits.length === 0) {
                const statusText = {
                    pending: 'No hay dep√≥sitos pendientes',
                    completed: 'No hay dep√≥sitos completados',
                    rejected: 'No hay dep√≥sitos rechazados'
                };

                const statusIcon = {
                    pending: 'fas fa-clock',
                    completed: 'fas fa-check-circle',
                    rejected: 'fas fa-times-circle'
                };

                container.innerHTML = `
                    <div class="empty-state">
                        <i class="${statusIcon[currentDepositTab]}"></i>
                        <h3>${statusText[currentDepositTab]}</h3>
                        <p>No se encontraron transacciones en esta categor√≠a</p>
                    </div>
                `;
                return;
            }

            // Generate table based on current tab
            const actionsColumn = currentDepositTab === 'pending' ?
                '<th>Acciones</th>' : '<th>Info</th>';

            const table = `
                <table class="deposits-table">
                    <thead>
                        <tr>
                            <th>Usuario</th>
                            <th>Monto</th>
                            <th>Banco</th>
                            <th>Referencia</th>
                            <th>Estado</th>
                            <th>Fecha</th>
                            ${currentDepositTab === 'pending' ? '<th>Tiempo Rest.</th>' : '<th>Procesado</th>'}
                            ${actionsColumn}
                        </tr>
                    </thead>
                    <tbody>
                        ${deposits.map(deposit => createDepositRowByTab(deposit)).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = table;
        }

        function createDepositRowByTab(deposit) {
            const statusClass = {
                'pending_verification': 'status-pending',
                'pending': 'status-pending',
                'pending_approval': 'status-pending',
                'completed': 'status-completed',
                'confirmed': 'status-completed',
                'rejected': 'status-rejected',
                'appeal_rejected': 'status-rejected'
            };

            const statusText = {
                'pending_verification': 'Pendiente de revisi√≥n',
                'pending': 'Pendiente',
                'pending_approval': 'Esperando aprobaci√≥n',
                'completed': 'Completado',
                'confirmed': 'Confirmado',
                'rejected': 'Rechazado',
                'appeal_rejected': 'Apelaci√≥n rechazada'
            };

            // Different actions based on tab
            let actionsHtml = '';
            if (currentDepositTab === 'pending') {
                actionsHtml = `
                    <div class="action-buttons">
                        <button class="action-btn view-btn" onclick="showReceiptModal('${deposit.id}', '${deposit.receiptFile || ''}')" title="Ver comprobante">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn request-btn" onclick="requestNewReceipt('${deposit.id}')" title="Solicitar nueva imagen">
                            <i class="fas fa-camera"></i>
                        </button>
                        <button class="action-btn approve-btn" onclick="showConfirmModal('${deposit.id}')" title="Confirmar">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="action-btn reject-btn" onclick="showRejectModal('${deposit.id}')" title="Rechazar">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            } else {
                actionsHtml = `
                    <div class="action-buttons">
                        <button class="action-btn view-btn" onclick="showReceiptModal('${deposit.id}', '${deposit.receiptFile || ''}')" title="Ver comprobante">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn info-btn" onclick="showDepositHistory('${deposit.id}')" title="Ver historial">
                            <i class="fas fa-history"></i>
                        </button>
                    </div>
                `;
            }

            const timeColumn = currentDepositTab === 'pending'
                ? `<td>${getRemainingTime(deposit.timestamp)}</td>`
                : `<td>${formatDate(deposit.confirmedAt || deposit.rejectedAt || deposit.timestamp)}</td>`;

            return `
                <tr data-deposit-id="${deposit.id}" >
                    <td>
                        <div class="user-info">
                            <strong>${deposit.userId || 'user_default_123'}</strong>
                            <div class="user-details">Cuenta: ${deposit.bankAccount || 'LOCAL-_123'}</div>
                        </div>
                    </td>
                    <td>
                        <div class="amount-info">
                            <strong>${formatCurrency(deposit.amount, deposit.currency)}</strong>
                            <div class="net-amount">Neto: ${formatCurrency(deposit.amount, deposit.currency)}</div>
                        </div>
                    </td>
                    <td>
                        <div class="bank-info">
                            <span class="bank-name">${(deposit.method === 'atlantida' || deposit.method === 'bank_atlantida') ? 'Banco Atl√°ntida' : 'Banco Desconocido'}</span>
                        </div>
                    </td>
                    <td>
                        <div class="reference-info">
                            <span class="reference">${deposit.reference || deposit.id}</span>
                        </div>
                    </td>
                    <td>
                        <span class="status-badge ${statusClass[deposit.status] || 'status-pending'}">
                            ${statusText[deposit.status] || deposit.status}
                        </span>
                    </td>
                    <td>
                        <div class="date-info">
                            <div>${formatDate(deposit.timestamp)}</div>
                            <div class="time-ago">${formatTime(deposit.timestamp)}</div>
                        </div>
                    </td>
                    ${timeColumn}
                    <td>${actionsHtml}</td>
                </tr>
            `;
        }

        function showDepositHistory(depositId) {
            const walletTransactions = JSON.parse(localStorage.getItem('transactionHistory') || '[]');
            const deposit = walletTransactions.find(tx => tx.id === depositId);

            if (!deposit) {
                showNotification('Dep√≥sito no encontrado', 'error');
                return;
            }

            const content = `
                <div class="deposit-history">
                    <h3>üìä Historial del Dep√≥sito</h3>
                    <div class="history-info-grid">
                        <div class="info-row">
                            <label>ID de Transacci√≥n:</label>
                            <span>${deposit.id}</span>
                        </div>
                        <div class="info-row">
                            <label>Usuario:</label>
                            <span>${deposit.userId || 'user_default_123'}</span>
                        </div>
                        <div class="info-row">
                            <label>Monto:</label>
                            <span>${formatCurrency(deposit.amount, deposit.currency)}</span>
                        </div>
                        <div class="info-row">
                            <label>Estado Actual:</label>
                            <span class="status-badge">${deposit.status}</span>
                        </div>
                        <div class="info-row">
                            <label>Fecha de Creaci√≥n:</label>
                            <span>${formatDateTime(deposit.timestamp)}</span>
                        </div>
                        ${deposit.confirmedAt ? `
                            <div class="info-row">
                                <label>Fecha de Confirmaci√≥n:</label>
                                <span>${formatDateTime(deposit.confirmedAt)}</span>
                            </div>
                        ` : ''}
                        ${deposit.confirmedBy ? `
                            <div class="info-row">
                                <label>Confirmado por:</label>
                                <span>${deposit.confirmedBy}</span>
                            </div>
                        ` : ''}
                        ${deposit.rejectedAt ? `
                            <div class="info-row">
                                <label>Fecha de Rechazo:</label>
                                <span>${formatDateTime(deposit.rejectedAt)}</span>
                            </div>
                        ` : ''}
                        ${deposit.rejectionReason ? `
                            <div class="info-row">
                                <label>Motivo de Rechazo:</label>
                                <span>${deposit.rejectionReason}</span>
                            </div>
                        ` : ''}
                        ${deposit.adminNotes ? `
                            <div class="info-row">
                                <label>Notas del Admin:</label>
                                <span>${deposit.adminNotes}</span>
                            </div>
                        ` : ''}
                    </div>
                    <div class="history-actions">
                        <button onclick="closeModal()" class="btn-secondary">Cerrar</button>
                        ${deposit.receiptFile ? `
                            <button onclick="showReceiptModal('${deposit.id}', '${deposit.receiptFile}')" class="btn-primary">
                                <i class="fas fa-eye"></i> Ver Comprobante
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;

            showModal('Historial de Dep√≥sito', content);
        }

        // Replace the old loadPendingDeposits calls with new tabbed system
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize with pending tab
            setTimeout(() => {
                loadDepositsByStatus();
            }, 1000);
        });

        // ============================================
        // DELETED GROUPS MANAGEMENT
        // ============================================
        
        let deletedGroupsList = [];
        let currentHardDeleteGroup = null;
        
        async function loadDeletedGroups() {
            const container = document.getElementById('deletedGroupsContainer');
            if (!container) return;
            
            container.innerHTML = '<div class="loading" style="margin: 40px auto; display: block;"></div>';
            
            try {
                const token = localStorage.getItem('auth_token') || localStorage.getItem('admin_token');
                const response = await fetch('/api/admin/groups/deleted', {
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) throw new Error('Failed to load deleted groups');
                
                const result = await response.json();
                deletedGroupsList = result.data?.groups || result.data || [];
                
                renderDeletedGroups();
            } catch (error) {
                container.innerHTML = '<p style="text-align: center; color: #ef4444; padding: 20px;">Error al cargar grupos eliminados'</p>';
            }
        }
        
        function renderDeletedGroups() {
            const container = document.getElementById('deletedGroupsContainer');
            if (!container) return;
            
            if (deletedGroupsList.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);"><i class="fas fa-check-circle" style="font-size: 3rem; color: #22c55e; margin-bottom: 15px;"></i><p>No hay grupos eliminados</p></div>';
                return;
            }
            
            let html = '<table class="deposits-table"><thead><tr><th>Grupo</th><th>Admin</th><th>Contribuciones</th><th>Miembros</th><th>Eliminado</th><th>Acciones</th></tr></thead><tbody>';
            
            deletedGroupsList.forEach(group => {
                const deletedDate = group.deleted_at ? new Date(group.deleted_at).toLocaleDateString('es-HN') : 'N/A';
                const groupId = group.group_id || group.id;
                const groupName = (group.name || 'Sin nombre').replace(/'/g, "\\'");
                html += '<tr>';
                html += '<td><strong>' + (group.name || 'Sin nombre') + '</strong><br><small style="color: #666;">' + groupId + '</small></td>';
                html += '<td>' + (group.admin_id || 'N/A') + '</td>';
                html += '<td style="text-align: center;">' + (group.contribution_count || 0) + '</td>';
                html += '<td style="text-align: center;">' + (group.member_count || 0) + '</td>';
                html += '<td>' + deletedDate + '</td>';
                html += '<td>';
                html += '<button onclick="restoreGroup(\'' + groupId + '\')" class="btn" style="background: #22c55e; color: white; padding: 6px 12px; margin-right: 5px; font-size: 0.8rem;"><i class="fas fa-undo"></i> Restaurar</button>';
                html += '<button onclick="openHardDeleteModal(\'' + groupId + '\', \'' + groupName + '\', ' + (group.contribution_count || 0) + ', ' + (group.member_count || 0) + ')" class="btn" style="background: #dc2626; color: white; padding: 6px 12px; font-size: 0.8rem;"><i class="fas fa-trash-alt"></i> Eliminar</button>';
                html += '</td>';
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function openHardDeleteModal(groupId, groupName, contributionCount, memberCount) {
            currentHardDeleteGroup = { id: groupId, name: groupName };
            
            document.getElementById('hardDeleteGroupInfo').innerHTML = 
                '<p><strong>Grupo:</strong> ' + groupName + '</p>' +
                '<p><strong>ID:</strong> ' + groupId + '</p>' +
                '<p><strong>Contribuciones a eliminar:</strong> ' + contributionCount + '</p>' +
                '<p><strong>Miembros a remover:</strong> ' + memberCount + '</p>';
            
            document.getElementById('hardDeleteConfirmInput').value = '';
            document.getElementById('hardDeleteBtn').disabled = true;
            document.getElementById('hardDeleteModal').style.display = 'flex';
            
            document.getElementById('hardDeleteConfirmInput').oninput = function() {
                const matches = this.value === groupName;
                document.getElementById('hardDeleteBtn').disabled = !matches;
            };
        }
        
        function closeHardDeleteModal() {
            document.getElementById('hardDeleteModal').style.display = 'none';
            currentHardDeleteGroup = null;
        }
        
        async function executeHardDelete() {
            if (!currentHardDeleteGroup) return;
            
            const confirmInput = document.getElementById('hardDeleteConfirmInput').value;
            if (confirmInput !== currentHardDeleteGroup.name) {
                alert('El nombre no coincide. Por favor escriba el nombre exacto del grupo.');
                return;
            }
            
            const btn = document.getElementById('hardDeleteBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Eliminando...';
            
            try {
                const token = localStorage.getItem('auth_token') || localStorage.getItem('admin_token');
                const response = await fetch('/api/groups/' + currentHardDeleteGroup.id + '?mode=hard&confirm=' + encodeURIComponent(currentHardDeleteGroup.name), {
                    method: 'DELETE',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    closeHardDeleteModal();
                    if (typeof showToast === 'function') showToast('Grupo eliminado permanentemente', 'success');
                    loadDeletedGroups();
                } else {
                    throw new Error(result.data?.error?.message || result.message || 'Error al eliminar');
                }
            } catch (error) {
                alert('Error: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-trash-alt"></i> Eliminar Permanentemente';
            }
        }
        
        async function restoreGroup(groupId) {
            if (!confirm('¬øRestaurar este grupo?')) return;
            
            try {
                const token = localStorage.getItem('auth_token') || localStorage.getItem('admin_token');
                const response = await fetch('/api/admin/groups/' + groupId + '/restore', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    if (typeof showToast === 'function') showToast('Grupo restaurado exitosamente', 'success');
                    loadDeletedGroups();
                } else {
                    throw new Error(result.data?.error?.message || result.message || 'Error al restaurar');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        // Load deleted groups on page load
        setTimeout(loadDeletedGroups, 3000);

        // ============================================
        // FAILED GROUP JOINS MANAGEMENT
        // ============================================

        let currentFailedJoinId = null;

        async function loadFailedJoins() {
            const container = document.getElementById('failedJoinsContainer');
            const statsContainer = document.getElementById('failedJoinsStats');
            const filter = document.getElementById('failedJoinsFilter').value;

            container.innerHTML = '<div class="loading" style="margin: 40px auto; display: block;"></div>';

            try {
                const token = localStorage.getItem('admin_token') || sessionStorage.getItem('admin_token');
                
                // Load stats
                const statsResponse = await fetch('/api/admin/failed-joins/stats', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const statsData = await statsResponse.json();

                if (statsData.success) {
                    const s = statsData.data.summary;
                    statsContainer.innerHTML = `
                        <div style="background: linear-gradient(135deg, #fef3c7, #fcd34d); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #92400e;">${s.unresolved || 0}</div>
                            <div style="font-size: 12px; color: #a16207;">Sin Resolver</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #d1fae5, #6ee7b7); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #065f46;">${s.resolved || 0}</div>
                            <div style="font-size: 12px; color: #047857;">Resueltos</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #e0e7ff, #a5b4fc); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #3730a3;">${s.last_24h || 0}</div>
                            <div style="font-size: 12px; color: #4338ca;">√öltimas 24h</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #fce7f3, #f9a8d4); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #9d174d;">${s.affected_users || 0}</div>
                            <div style="font-size: 12px; color: #be185d;">Usuarios Afectados</div>
                        </div>
                    `;
                }

                // Load list
                let url = '/api/admin/failed-joins?limit=50';
                if (filter !== '') {
                    url += '&resolved=' + filter;
                }

                const response = await fetch(url, {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                const data = await response.json();

                if (!data.success) {
                    container.innerHTML = '<p style="color: var(--error-color); text-align: center;">Error al cargar errores</p>';
                    return;
                }

                if (data.data.failed_joins.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <i class="fas fa-check-circle" style="font-size: 48px; color: #10b981; margin-bottom: 15px;"></i>
                            <h3 style="margin-bottom: 10px;">¬°Todo bien!</h3>
                            <p>No hay errores de uni√≥n ${filter === 'false' ? 'pendientes' : filter === 'true' ? 'resueltos' : ''}</p>
                        </div>
                    `;
                    return;
                }

                let html = '<table class="deposits-table"><thead><tr>';
                html += '<th>Fecha</th><th>Usuario</th><th>Grupo</th><th>Error</th><th>Reintentos</th><th>Estado</th><th>Acciones</th>';
                html += '</tr></thead><tbody>';

                for (const fj of data.data.failed_joins) {
                    const date = new Date(fj.created_at).toLocaleString('es-HN');
                    const userName = fj.user_name || fj.user_email || fj.user_id || 'Desconocido';
                    const groupName = fj.group_name || fj.group_id || 'Desconocido';
                    const statusBadge = fj.resolved 
                        ? '<span style="background: #d1fae5; color: #065f46; padding: 2px 8px; border-radius: 4px; font-size: 11px;">Resuelto</span>'
                        : '<span style="background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 4px; font-size: 11px;">Pendiente</span>';

                    html += `<tr>
                        <td style="font-size: 12px;">${date}</td>
                        <td><strong>${escapeHtml(userName)}</strong><br><small style="color: var(--text-secondary);">${fj.user_email_from_users || ''}</small></td>
                        <td>${escapeHtml(groupName)}</td>
                        <td><span style="background: #fee2e2; color: #991b1b; padding: 2px 6px; border-radius: 4px; font-size: 11px;">${fj.error_type}</span><br><small>${(fj.error_message || '').substring(0, 50)}</small></td>
                        <td style="text-align: center;">${fj.retry_count}/${fj.max_retries}</td>
                        <td>${statusBadge}</td>
                        <td>
                            ${!fj.resolved ? `
                                <button onclick="retryFailedJoin('${escapeHtml(fj.id)}')" class="btn" style="background: #3b82f6; color: white; padding: 4px 8px; font-size: 11px; margin: 2px;" title="Reintentar">
                                    <i class="fas fa-redo"></i>
                                </button>
                                <button onclick="openResolveModal('${escapeHtml(fj.id)}', '${escapeHtml(userName)}', '${escapeHtml(groupName)}')" class="btn" style="background: #10b981; color: white; padding: 4px 8px; font-size: 11px; margin: 2px;" title="Resolver">
                                    <i class="fas fa-check"></i>
                                </button>
                            ` : `
                                <small style="color: var(--text-secondary);">Resuelto por ${fj.resolved_by || 'sistema'}</small>
                            `}
                        </td>
                    </tr>`;
                }

                html += '</tbody></table>';
                container.innerHTML = html;

            } catch (error) {
                container.innerHTML = '<p style="color: var(--error-color); text-align: center;">Error de conexi√≥n</p>';
            }
        }

        async function retryFailedJoin(id) {
            if (!confirm('¬øReintentar agregar este usuario al grupo?')) return;

            try {
                const token = localStorage.getItem('admin_token') || sessionStorage.getItem('admin_token');
                const response = await fetch(`/api/admin/failed-joins/${id}/retry`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ ' + data.data.message);
                    loadFailedJoins();
                } else {
                    alert('‚ùå Error: ' + (data.data?.error?.message || 'Error desconocido'));
                }
            } catch (error) {
                alert('‚ùå Error de conexi√≥n');
            }
        }

        function openResolveModal(id, userName, groupName) {
            currentFailedJoinId = id;
            document.getElementById('resolveFailedJoinInfo').innerHTML = `
                <p><strong>Usuario:</strong> ${escapeHtml(userName)}</p>
                <p><strong>Grupo:</strong> ${escapeHtml(groupName)}</p>
            `;
            document.getElementById('resolveFailedJoinModal').style.display = 'flex';
        }

        function closeResolveModal() {
            document.getElementById('resolveFailedJoinModal').style.display = 'none';
            currentFailedJoinId = null;
        }

        async function executeResolveFailedJoin() {
            if (!currentFailedJoinId) return;

            const resolutionType = document.getElementById('resolutionType').value;
            const notes = document.getElementById('resolveNotes').value;

            try {
                const token = localStorage.getItem('admin_token') || sessionStorage.getItem('admin_token');
                const response = await fetch(`/api/admin/failed-joins/${currentFailedJoinId}/resolve`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ resolution_type: resolutionType, notes })
                });
                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ Marcado como resuelto');
                    closeResolveModal();
                    loadFailedJoins();
                } else {
                    alert('‚ùå Error: ' + (data.data?.error?.message || 'Error desconocido'));
                }
            } catch (error) {
                alert('‚ùå Error de conexi√≥n');
            }
        }

        // Load failed joins on page load
        setTimeout(loadFailedJoins, 3500);
    </script>

    <style>
        /* OCR badges */
        .ocr-badge {
            background: rgba(148, 163, 184, 0.1);
            color: var(--text-secondary);
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 8px;
        }
        .ocr-badge.high {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }
        .ocr-badge.low {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        /* Local data indicator */
        [] {
            border-left: 3px solid var(--primary-color);
        }

        /* Deposit Tabs Styling */
        .deposit-tabs {
            display: flex;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 24px;
            gap: 4px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab-btn:hover {
            background: rgba(148, 163, 184, 0.1);
            color: var(--text-primary);
        }

        .tab-btn.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 255, 255, 0.2);
        }

        .tab-btn i {
            font-size: 0.8rem;
        }

        .tab-btn span {
            font-weight: 600;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.75rem;
            min-width: 18px;
            text-align: center;
        }

        .tab-btn.active span {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Action buttons styling for tabs */
        .action-buttons {
            display: flex;
            gap: 4px;
            justify-content: center;
        }

        .action-btn {
            background: transparent;
            border: 1px solid rgba(148, 163, 184, 0.3);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px;
            transition: all 0.2s ease;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            background: rgba(148, 163, 184, 0.1);
            color: var(--text-primary);
            border-color: rgba(148, 163, 184, 0.5);
        }

        .action-btn.view-btn:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border-color: #3b82f6;
        }

        .action-btn.approve-btn:hover {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border-color: #10b981;
        }

        .action-btn.reject-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border-color: #ef4444;
        }

        .action-btn.request-btn:hover {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
            border-color: #f59e0b;
        }

        .action-btn.info-btn:hover {
            background: rgba(168, 85, 247, 0.1);
            color: #a855f7;
            border-color: #a855f7;
        }

        /* Appeals table styling */
        .appeal-row {
            border-left: 3px solid rgba(245, 158, 11, 0.6);
        }

        .user-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .transaction-desc {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-top: 2px;
        }

        .transaction-id {
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-family: 'Courier New', monospace;
            margin-top: 2px;
        }

        .transaction-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .transaction-type-badge.deposit {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .transaction-type-badge.withdrawal {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .amount-display {
            text-align: center;
        }

        .amount-value {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .currency-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .rejection-info {
            max-width: 180px;
        }

        .rejection-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .rejection-text {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 0.8rem;
            border-left: 3px solid #ef4444;
        }

        .appeal-info {
            max-width: 200px;
        }

        .appeal-text {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 0.85rem;
            border-left: 3px solid #3b82f6;
            margin-bottom: 6px;
        }

        .evidence-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .date-display {
            text-align: center;
        }

        .date-value {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .time-ago {
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-top: 2px;
        }

        /* Appeal details modal styling */
        .appeal-details-view {
            padding: 20px;
        }

        .appeal-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .appeal-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            border: 2px solid rgba(245, 158, 11, 0.3);
        }

        .appeal-grid {
            display: grid;
            gap: 16px;
            margin-bottom: 24px;
        }

        .detail-card {
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 12px;
            padding: 16px;
        }

        .detail-card h4 {
            color: var(--text-primary);
            font-size: 1rem;
            margin: 0 0 12px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
            gap: 12px;
        }

        .detail-row.full-width {
            flex-direction: column;
            gap: 6px;
        }

        .detail-row .label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            min-width: 100px;
        }

        .detail-row .value {
            color: var(--text-primary);
            font-size: 0.9rem;
            text-align: right;
            flex: 1;
        }

        .detail-row .value.code {
            font-family: 'Courier New', monospace;
            background: rgba(148, 163, 184, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .detail-row .value.amount {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary-color);
        }

        .type-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .type-badge.deposit {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .type-badge.withdrawal {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .rejection-card {
            border-left: 4px solid #ef4444;
        }

        .rejection-reason {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            padding: 6px 10px;
            border-radius: 8px;
            font-weight: 500;
        }

        .appeal-card {
            border-left: 4px solid #3b82f6;
        }

        .appeal-reason-display {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid #3b82f6;
            font-style: italic;
            line-height: 1.4;
        }

        .evidence-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .appeal-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            border-top: 1px solid rgba(148, 163, 184, 0.1);
            padding-top: 20px;
        }

        .appeal-actions .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .appeal-actions .btn-cancel {
            background: rgba(148, 163, 184, 0.1);
            color: var(--text-secondary);
            border: 1px solid rgba(148, 163, 184, 0.3);
        }

        .appeal-actions .btn-confirm {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border: 1px solid #10b981;
        }

        .appeal-actions .btn-reject {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .appeal-actions .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Evidence viewing components */
        .evidence-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
        }

        .btn-view-evidence {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border: 1px solid #3b82f6;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-view-evidence:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: translateY(-1px);
        }

        /* Receipt viewer modal */
        .receipt-viewer {
            padding: 20px;
            max-width: 700px;
        }

        .receipt-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .receipt-header h4 {
            color: var(--text-primary);
            margin: 0 0 8px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .receipt-info {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin: 0;
        }

        .receipt-image-container {
            position: relative;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .receipt-image {
            width: 100%;
            height: auto;
            max-height: 500px;
            object-fit: contain;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .receipt-image:hover {
            transform: scale(1.02);
        }

        .receipt-actions-overlay {
            position: absolute;
            top: 12px;
            right: 12px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .receipt-image-container:hover .receipt-actions-overlay {
            opacity: 1;
        }

        .btn-fullscreen {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-fullscreen:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        .receipt-actions-bottom {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .receipt-actions-bottom .btn {
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .receipt-actions-bottom .btn-primary {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border: 1px solid #3b82f6;
        }

        .receipt-actions-bottom .btn-primary:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: translateY(-1px);
        }
    </style>
<!-- Admin Login Modal -->
<div id="loginModal" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); justify-content: center; align-items: center; z-index: 10000;">
    <div style="background: #1a1a2e; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%; border: 1px solid #00d4ff;">
        <h2 style="color: #00d4ff; margin-bottom: 20px; text-align: center;">
            <i class="fas fa-shield-alt"></i> Admin Login
        </h2>
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; color: #ccc;">Usuario</label>
            <input type="text" id="loginUsername" placeholder="admin / finance / support" style="width: 100%; padding: 12px; border: 1px solid #333; border-radius: 8px; background: #0d0d1a; color: white; box-sizing: border-box;">
        </div>
        <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; color: #ccc;">Contrase√±a</label>
            <input type="password" autocomplete="current-password" id="loginPassword" placeholder="Contrase√±a" style="width: 100%; padding: 12px; border: 1px solid #333; border-radius: 8px; background: #0d0d1a; color: white; box-sizing: border-box;">
        </div>
        <button onclick="adminLogin()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #00d4ff, #0099cc); border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; font-size: 16px;">
            <i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n
        </button>
        <div id="loginError" style="color: #ff4444; margin-top: 10px; text-align: center; display: none;"></div>
    </div>
</div>
</body>
</html><script src="admin-payouts.js"></script>
