<!DOCTYPE html>
<html lang="es">
<head>
  <script type="module" crossorigin src="/assets/js/polyfills--1Z-T_Bc.js"></script>

    <meta charset="UTF-8">
    <!-- Resource Optimization -->
    <!-- DNS Prefetch for external resources -->
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://fonts.gstatic.com">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    
    <!-- Preconnect to critical origins -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Tanda - Registro y Verificaci√≥n KYC</title>
    <meta name="description" content="Sistema avanzado de registro y verificaci√≥n KYC para La Tanda Ecosystem">
    <link rel="manifest" href="/assets/json/manifest-GvDl68cn.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Optimized Google Fonts loading -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"></noscript>
    <!-- Critical CSS: Font Awesome with async loading -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha384-iw3OoTErCYJJB9mCa8LNS2hbsQ7M3C0EpIsO/H5+EGAkPGc6rk+V8i04oW/K5xq0" crossorigin="anonymous"></noscript>
    <style>
        /* Ensure Font Awesome icons are visible */
        .fas, .far, .fab {
            font-family: 'Font Awesome 6 Free', 'Font Awesome 6 Pro', sans-serif !important;
            font-weight: 900 !important;
            font-style: normal !important;
            font-display: swap !important;
        }
        
        /* Fix potential icon visibility issues */
        i[class*="fa-"] {
            display: inline-block !important;
            width: auto !important;
            height: auto !important;
            vertical-align: baseline !important;
        }
        
        /* Security badge specific styling */
        .security-icon i {
            color: #10b981;
            font-size: 1.2em;
        }
    </style>
  <script type="module" crossorigin src="/assets/js/kycRegistration-BnRnaQc2.js"></script>
  <link rel="modulepreload" crossorigin href="/assets/js/modulepreload-polyfill-YP0FEG5d.js">
  <link rel="modulepreload" crossorigin href="/assets/js/api-proxy-chunk-l0sNRNKZ.js">
  <link rel="stylesheet" crossorigin href="/assets/css/kycRegistration-OtCZS19B.css">
  <script type="module">import.meta.url;import("_").catch(()=>1);(async function*(){})().next();if(location.protocol!="file:"){window.__vite_is_modern_browser=true}</script>
  <script type="module">!function(){if(window.__vite_is_modern_browser)return;console.warn("vite: loading legacy chunks, syntax error above and the same error below should be ignored");var e=document.getElementById("vite-legacy-polyfill"),n=document.createElement("script");n.src=e.src,n.onload=function(){System.import(document.getElementById('vite-legacy-entry').getAttribute('data-src'))},document.body.appendChild(n)}();</script>
<link rel="manifest" href="/manifest.webmanifest"><script id="vite-plugin-pwa:register-sw" src="/registerSW.js"></script>    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/header.css?v=24.5">
    <link rel="stylesheet" href="css/onboarding.css?v=1.0">
    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://latanda.online/kyc-registration.html">
    <meta property="og:title" content="Verificacion KYC | La Tanda">
    <meta property="og:description" content="Verifica tu identidad para acceder a todas las funciones.">
    <meta property="og:image" content="https://latanda.online/assets/og-image.png">
    <meta property="og:site_name" content="La Tanda">
    <meta property="og:locale" content="es_HN">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Verificacion KYC | La Tanda">
    <meta name="twitter:description" content="Verifica tu identidad para acceder a todas las funciones.">
    <meta name="twitter:image" content="https://latanda.online/assets/og-image.png">
</head>
<body>
    <!-- Global Header Component -->
    <div id="global-header"></div>
    <!-- Background Effects -->
    <div class="bg-effects">
        <div class="bg-grid"></div>
        <div class="bg-particles" id="particles"></div>
    </div>

    <!-- Navigation Menu -->
    <nav class="main-nav" style="background: rgba(15, 23, 42, 0.95); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4); backdrop-filter: blur(24px); border-bottom: 1px solid rgba(0, 255, 255, 0.2);">
        <div class="nav-left" style="display: flex; align-items: center; gap: 20px;">
            <button onclick="window.location.href='home-dashboard.html'" style="background: linear-gradient(135deg, #00FFFF, #7FFFD8); color: #000000; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: 600; transition: all 0.3s ease;">
                <i class="fas fa-home"></i> Dashboard
            </button>
            <div class="nav-links" style="display: flex; gap: 15px;">
                <a href="my-wallet.html" style="color: #f8fafc; text-decoration: none; padding: 8px 12px; border-radius: 6px; transition: all 0.3s ease; border: 1px solid transparent;"><i class="fas fa-wallet"></i> Wallet</a>
                <a href="groups-advanced-system.html" style="color: #f8fafc; text-decoration: none; padding: 8px 12px; border-radius: 6px; transition: all 0.3s ease; border: 1px solid transparent;"><i class="fas fa-users"></i> Grupos</a>
                <a href="web3-dashboard.html" style="color: #f8fafc; text-decoration: none; padding: 8px 12px; border-radius: 6px; transition: all 0.3s ease; border: 1px solid transparent;"><i class="fas fa-chart-line"></i> Trading</a>
                <a href="marketplace-social.html" style="color: #f8fafc; text-decoration: none; padding: 8px 12px; border-radius: 6px; transition: all 0.3s ease; border: 1px solid transparent;"><i class="fas fa-shopping-bag"></i> Marketplace</a>
            </div>
        </div>
        <div class="nav-right">
            <span style="color: #00FFFF; font-weight: 600; text-shadow: 0 0 10px rgba(0, 255, 255, 0.4);"><i class="fas fa-clipboard-check"></i> Verificaci√≥n KYC</span>
        </div>
    </nav>

    <!-- Info Banner -->
    <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(6, 182, 212, 0.1)); border: 1px solid rgba(16, 185, 129, 0.3); padding: 12px 20px; margin: 0; text-align: center; color: #10b981; font-weight: 500;">
        <i class="fas fa-info-circle"></i> <strong>Informaci√≥n:</strong> Este registro KYC no requiere wallet de criptomonedas. Puedes completar la verificaci√≥n usando solo tu informaci√≥n personal.
    </div>

    <!-- Main Container -->
    <div class="registration-container">
        <!-- Header -->
        <div class="registration-header">
            <div class="logo-section">
                <div class="brand-info">
                    <h1 class="brand-title">La Tanda</h1>
                    <p class="brand-subtitle">Registro & Verificaci√≥n KYC</p>
                </div>
            </div>
            <div class="security-badge">
                <div class="security-icon"><i class="fas fa-shield-alt"></i></div>
                <span>Verificaci√≥n Segura</span>
            </div>
        </div>

        <!-- Progress Indicator -->
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-steps">
                <div class="step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">Informaci√≥n B√°sica</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Verificaci√≥n KYC</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Perfil Financiero</div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">Verificaci√≥n</div>
                </div>
                <div class="step" data-step="5">
                    <div class="step-number">5</div>
                    <div class="step-label">Completado</div>
                </div>
            </div>
        </div>

        <!-- Registration Forms -->
        <div class="forms-container">
            <!-- Step 1: Basic Information -->
            <div class="form-step active" id="step1">
                <div class="step-header">
                    <h2>Informaci√≥n B√°sica</h2>
                    <p>Comencemos con tus datos personales fundamentales</p>
                </div>

                <form class="registration-form" id="basicInfoForm">
                    <div class="form-grid">
                        <div class="input-group">
                            <label for="firstName">Nombre <span class="required">*</span></label>
                            <input type="text" id="firstName" name="firstName" required 
                                   placeholder="Tu primer nombre" autocomplete="given-name">
                            <span class="input-error" id="firstNameError"></span>
                        </div>

                        <div class="input-group">
                            <label for="lastName">Apellido <span class="required">*</span></label>
                            <input type="text" id="lastName" name="lastName" required 
                                   placeholder="Tu apellido" autocomplete="family-name">
                            <span class="input-error" id="lastNameError"></span>
                        </div>

                        <div class="input-group full-width">
                            <label for="email">Correo Electr√≥nico <span class="required">*</span></label>
                            <input type="email" id="email" name="email" required 
                                   placeholder="tu@email.com" autocomplete="email">
                            <span class="input-error" id="emailError"></span>
                            <span class="input-help">Usaremos este email para comunicaciones importantes</span>
                        </div>

                        <div class="input-group">
                            <label for="phone">Tel√©fono <span class="required">*</span></label>
                            <div class="phone-input">
                                <select id="countryCode" name="countryCode" class="country-selector">
                                    <option value="+504" data-flag="üá≠üá≥">üá≠üá≥ +504</option>
                                    <option value="+1" data-flag="üá∫üá∏">üá∫üá∏ +1</option>
                                    <option value="+52" data-flag="üá≤üáΩ">üá≤üáΩ +52</option>
                                    <option value="+503" data-flag="üá∏üáª">üá∏üáª +503</option>
                                    <option value="+502" data-flag="üá¨üáπ">üá¨üáπ +502</option>
                                    <option value="+506" data-flag="üá®üá∑">üá®üá∑ +506</option>
                                </select>
                                <input type="tel" id="phone" name="phone" required 
                                       placeholder="0000-0000" autocomplete="tel">
                            </div>
                            <span class="input-error" id="phoneError"></span>
                        </div>

                        <div class="input-group">
                            <label for="birthDate">Fecha de Nacimiento <span class="required">*</span></label>
                            <input type="date" id="birthDate" name="birthDate" required 
                                   max="2006-01-01" autocomplete="bday">
                            <span class="input-error" id="birthDateError"></span>
                            <span class="input-help">Debes ser mayor de 18 a√±os</span>
                        </div>

                        <div class="input-group full-width">
                            <label for="country">Pa√≠s de Residencia <span class="required">*</span></label>
                            <select id="country" name="country" required autocomplete="country">
                                <option value="">Selecciona tu pa√≠s</option>
                                <option value="HN">üá≠üá≥ Honduras</option>
                                <option value="US">üá∫üá∏ Estados Unidos</option>
                                <option value="MX">üá≤üáΩ M√©xico</option>
                                <option value="SV">üá∏üáª El Salvador</option>
                                <option value="GT">üá¨üáπ Guatemala</option>
                                <option value="CR">üá®üá∑ Costa Rica</option>
                                <option value="PA">üáµüá¶ Panam√°</option>
                                <option value="NI">üá≥üáÆ Nicaragua</option>
                                <option value="BZ">üáßüáø Belice</option>
                                <option value="OTHER">üåç Otro pa√≠s</option>
                            </select>
                            <span class="input-error" id="countryError"></span>
                        </div>

                        <div class="input-group full-width">
                            <label for="password">Contrase√±a Segura <span class="required">*</span></label>
                            <div class="password-input">
                                <input type="password" autocomplete="new-password" id="password" name="password" required 
                                       placeholder="M√≠nimo 8 caracteres" autocomplete="new-password">
                                <button type="button" class="password-toggle" onclick="kycSystem.togglePassword('password')">
                                    <span class="toggle-icon"><i class="fas fa-eye"></i></span>
                                </button>
                            </div>
                            <div class="password-strength" id="passwordStrength"></div>
                            <span class="input-error" id="passwordError"></span>
                        </div>

                        <div class="input-group full-width">
                            <label for="confirmPassword">Confirmar Contrase√±a <span class="required">*</span></label>
                            <input type="password" autocomplete="new-password" id="confirmPassword" name="confirmPassword" required 
                                   placeholder="Repite tu contrase√±a" autocomplete="new-password">
                            <span class="input-error" id="confirmPasswordError"></span>
                        </div>
                    </div>

                    <!-- User type selection moved to financial profile step -->

                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="window.location.href='index.html'">
                            Volver al Inicio
                        </button>
                        <button type="submit" class="btn-primary">
                            Continuar ‚Üí
                        </button>
                    </div>
                </form>
            </div>

            <!-- Step 2: KYC Verification -->
            <div class="form-step" id="step2">
                <div class="step-header">
                    <h2>Verificaci√≥n KYC</h2>
                    <p>Necesitamos verificar tu identidad para garantizar la seguridad del ecosistema</p>
                </div>

                <form class="registration-form" id="kycForm">
                    <div class="kyc-section">
                        <h3><i class="fas fa-id-card"></i> Documento de Identidad</h3>
                        <p class="section-description">Sube una foto clara de tu documento oficial de identidad</p>

                        <div class="document-type-selector">
                            <label class="document-option">
                                <input type="radio" name="documentType" value="national_id" checked>
                                <div class="option-content">
                                    <span class="option-icon">üÜî</span>
                                    <span class="option-text">C√©dula de Identidad</span>
                                </div>
                            </label>
                            <label class="document-option">
                                <input type="radio" name="documentType" value="passport">
                                <div class="option-content">
                                    <span class="option-icon">üìò</span>
                                    <span class="option-text">Pasaporte</span>
                                </div>
                            </label>
                            <label class="document-option">
                                <input type="radio" name="documentType" value="driver_license">
                                <div class="option-content">
                                    <span class="option-icon">üöó</span>
                                    <span class="option-text">Licencia de Conducir</span>
                                </div>
                            </label>
                        </div>

                        <div class="file-upload-area">
                            <div class="upload-zone" id="documentUpload">
                                <div class="upload-icon">üìÑ</div>
                                <div class="upload-text">
                                    <p><strong>Arrastra tu documento aqu√≠</strong></p>
                                    <p>o haz clic para seleccionar</p>
                                </div>
                                <input type="file" id="documentFile" name="documentFile" 
                                       accept="image/*,.pdf" style="display: none;">
                            </div>
                            <div class="upload-requirements">
                                <h4>Requisitos:</h4>
                                <ul>
                                    <li>‚úì Imagen clara y n√≠tida</li>
                                    <li>‚úì Todos los datos visibles</li>
                                    <li>‚úì Formato: JPG, PNG o PDF</li>
                                    <li>‚úì Tama√±o m√°ximo: 10MB</li>
                                </ul>
                            </div>
                        </div>

                        <div class="document-preview" id="documentPreview" style="display: none;">
                            <div class="preview-header">
                                <h4>Vista previa del documento</h4>
                                <button type="button" class="remove-file" onclick="kycSystem.removeFile('document')">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </div>
                            <div class="preview-content">
                                <img id="documentPreviewImg" alt="Preview">
                                <div class="file-info">
                                    <span class="file-name" id="documentFileName"></span>
                                    <span class="file-size" id="documentFileSize"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="kyc-section">
                        <h3>ü§≥ Selfie de Verificaci√≥n</h3>
                        <p class="section-description">Toma una selfie sosteniendo tu documento para verificar que eres t√∫</p>

                        <div class="selfie-upload-area">
                            <div class="selfie-options">
                                <div class="upload-option" onclick="kycSystem.openCamera()">
                                    <div class="option-icon">üì∑</div>
                                    <div class="option-content">
                                        <h4>Tomar Foto</h4>
                                        <p>Usa tu c√°mara para tomar la selfie ahora</p>
                                    </div>
                                </div>
                                
                                <div class="upload-option" onclick="kycSystem.selectSelfieFile()">
                                    <div class="option-icon">üìÅ</div>
                                    <div class="option-content">
                                        <h4>Subir Archivo</h4>
                                        <p>Selecciona una foto existente de tu dispositivo</p>
                                    </div>
                                </div>
                                
                                <div class="upload-option" onclick="kycSystem.scanFace()">
                                    <div class="option-icon">üîç</div>
                                    <div class="option-content">
                                        <h4>Escanear Rostro</h4>
                                        <p>Verificaci√≥n biom√©trica autom√°tica</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="upload-zone" id="selfieUpload" style="display: none;">
                                <div class="upload-icon">üì∏</div>
                                <div class="upload-text">
                                    <p><strong>Toma una selfie con tu documento</strong></p>
                                    <p>o sube una foto existente</p>
                                </div>
                                <input type="file" id="selfieFile" name="selfieFile" 
                                       accept="image/*" capture="user" style="display: none;">
                            </div>
                            
                            <div class="selfie-requirements">
                                <h4>Instrucciones:</h4>
                                <ul>
                                    <li><i class="fas fa-mobile-alt"></i> Sost√©n tu documento junto a tu cara</li>
                                    <li>üí° Buena iluminaci√≥n, evita sombras</li>
                                    <li>üëÄ Mira directamente a la c√°mara</li>
                                    <li>üìÑ El documento debe ser legible</li>
                                </ul>
                            </div>
                        </div>

                        <div class="selfie-preview" id="selfiePreview" style="display: none;">
                            <div class="preview-header">
                                <h4>Vista previa de selfie</h4>
                                <button type="button" class="remove-file" onclick="kycSystem.removeFile('selfie')">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </div>
                            <div class="preview-content">
                                <img id="selfiePreviewImg" alt="Selfie Preview">
                                <div class="file-info">
                                    <span class="file-name" id="selfieFileName"></span>
                                    <span class="file-size" id="selfieFileSize"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="kyc-section">
                        <h3>üè† Comprobante de Direcci√≥n</h3>
                        <p class="section-description">Documento que confirme tu direcci√≥n actual (opcional pero recomendado)</p>

                        <div class="address-proof-selector">
                            <label class="document-option">
                                <input type="radio" name="addressProofType" value="utility_bill">
                                <div class="option-content">
                                    <span class="option-icon"><i class="fas fa-bolt"></i></span>
                                    <span class="option-text">Recibo de Servicios</span>
                                </div>
                            </label>
                            <label class="document-option">
                                <input type="radio" name="addressProofType" value="bank_statement">
                                <div class="option-content">
                                    <span class="option-icon"><i class="fas fa-university"></i></span>
                                    <span class="option-text">Estado de Cuenta</span>
                                </div>
                            </label>
                            <label class="document-option">
                                <input type="radio" name="addressProofType" value="rental_agreement">
                                <div class="option-content">
                                    <span class="option-icon"><i class="fas fa-clipboard-check"></i></span>
                                    <span class="option-text">Contrato de Alquiler</span>
                                </div>
                            </label>
                        </div>

                        <div class="file-upload-area">
                            <div class="upload-zone optional" id="addressUpload">
                                <div class="upload-icon">üè†</div>
                                <div class="upload-text">
                                    <p><strong>Comprobante de direcci√≥n</strong></p>
                                    <p>(Opcional - mejora tu verificaci√≥n)</p>
                                </div>
                                <input type="file" id="addressFile" name="addressFile" 
                                       accept="image/*,.pdf" style="display: none;">
                            </div>
                        </div>

                        <div class="address-preview" id="addressPreview" style="display: none;">
                            <div class="preview-header">
                                <h4>Comprobante de direcci√≥n</h4>
                                <button type="button" class="remove-file" onclick="kycSystem.removeFile('address')">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </div>
                            <div class="preview-content">
                                <img id="addressPreviewImg" alt="Address Proof Preview">
                                <div class="file-info">
                                    <span class="file-name" id="addressFileName"></span>
                                    <span class="file-size" id="addressFileSize"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="kycSystem.previousStep()">
                            ‚Üê Anterior
                        </button>
                        <button type="submit" class="btn-primary">
                            Continuar ‚Üí
                        </button>
                    </div>
                </form>
            </div>

            <!-- Step 3: Financial Profile -->
            <div class="form-step" id="step3">
                <div class="step-header">
                    <h2>Perfil Financiero</h2>
                    <p>Esta informaci√≥n nos ayuda a ofrecerte las mejores opciones de tandas</p>
                </div>

                <form class="registration-form" id="financialForm">
                    <div class="financial-section">
                        <h3>üíº Informaci√≥n Laboral</h3>
                        
                        <div class="form-grid">
                            <div class="input-group">
                                <label for="employmentStatus">Estado Laboral <span class="required">*</span></label>
                                <select id="employmentStatus" name="employmentStatus" required>
                                    <option value="">Selecciona tu situaci√≥n</option>
                                    <option value="employed">Empleado/a</option>
                                    <option value="self_employed">Trabajador/a Independiente</option>
                                    <option value="business_owner">Empresario/a</option>
                                    <option value="freelancer">Freelancer</option>
                                    <option value="unemployed">Desempleado/a</option>
                                    <option value="student">Estudiante</option>
                                    <option value="retired">Jubilado/a</option>
                                </select>
                                <span class="input-error" id="employmentStatusError"></span>
                            </div>

                            <div class="input-group">
                                <label for="monthlyIncome">Ingresos Mensuales <span class="required">*</span></label>
                                <select id="monthlyIncome" name="monthlyIncome" required>
                                    <option value="">Selecciona rango</option>
                                    <option value="0-500">$0 - $500 USD</option>
                                    <option value="500-1000">$500 - $1,000 USD</option>
                                    <option value="1000-2000">$1,000 - $2,000 USD</option>
                                    <option value="2000-5000">$2,000 - $5,000 USD</option>
                                    <option value="5000-10000">$5,000 - $10,000 USD</option>
                                    <option value="10000+">$10,000+ USD</option>
                                </select>
                                <span class="input-error" id="monthlyIncomeError"></span>
                            </div>

                            <div class="input-group full-width">
                                <label for="occupation">Ocupaci√≥n/Profesi√≥n</label>
                                <input type="text" id="occupation" name="occupation" 
                                       placeholder="Ej: Comerciante, Ingeniero, etc.">
                                <span class="input-help">Opcional - nos ayuda a conectarte con grupos afines</span>
                            </div>
                        </div>
                    </div>

                    <div class="financial-section">
                        <h3><i class="fas fa-users"></i> Tipo de Participaci√≥n</h3>
                        <p class="section-description">¬øC√≥mo planeas usar La Tanda? (Puedes cambiar esto m√°s adelante)</p>
                        
                        <div class="user-type-cards">
                            <label class="user-type-card">
                                <input type="radio" name="userType" value="participant" checked>
                                <div class="card-content">
                                    <div class="card-icon">üë§</div>
                                    <h4>Participante</h4>
                                    <p>Quiero unirme a tandas existentes y ahorrar con otros</p>
                                    <div class="card-benefits">
                                        <span>‚úì Ahorro autom√°tico</span>
                                        <span>‚úì Acceso a capital</span>
                                        <span>‚úì Comunidad confiable</span>
                                    </div>
                                </div>
                            </label>

                            <label class="user-type-card coordinator">
                                <input type="radio" name="userType" value="coordinator">
                                <div class="card-content">
                                    <div class="card-icon">üëë</div>
                                    <h4>Coordinador</h4>
                                    <p>Quiero crear y liderar grupos, ganando comisiones</p>
                                    <div class="card-benefits">
                                        <span>‚úì Ingresos de comisiones</span>
                                        <span>‚úì Liderazgo de grupos</span>
                                        <span>‚úì Crecimiento escalable</span>
                                    </div>
                                    <div class="earnings-preview">
                                        <small>Ganancias potenciales: <strong>$500-5,000+ USD/mes</strong></small>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="financial-section">
                        <h3><i class="fas fa-bullseye"></i> Objetivos Financieros</h3>
                        
                        <div class="form-grid">
                            <div class="input-group">
                                <label for="savingGoal">Principal Objetivo de Ahorro</label>
                                <select id="savingGoal" name="savingGoal">
                                    <option value="">Selecciona objetivo</option>
                                    <option value="emergency">Fondo de Emergencia</option>
                                    <option value="business">Iniciar/Expandir Negocio</option>
                                    <option value="education">Educaci√≥n</option>
                                    <option value="housing">Vivienda</option>
                                    <option value="travel">Viajes</option>
                                    <option value="retirement">Jubilaci√≥n</option>
                                    <option value="investment">Inversi√≥n</option>
                                    <option value="other">Otros</option>
                                </select>
                            </div>

                            <div class="input-group">
                                <label for="preferredAmount">Monto Preferido por Tanda</label>
                                <select id="preferredAmount" name="preferredAmount">
                                    <option value="">Selecciona rango</option>
                                    <option value="100-300">$100 - $300 USD</option>
                                    <option value="300-500">$300 - $500 USD</option>
                                    <option value="500-1000">$500 - $1,000 USD</option>
                                    <option value="1000-2000">$1,000 - $2,000 USD</option>
                                    <option value="2000-5000">$2,000 - $5,000 USD</option>
                                    <option value="5000+">$5,000+ USD</option>
                                </select>
                                <span class="input-help">Puedes participar en tandas de diferentes montos</span>
                            </div>

                            <div class="input-group full-width">
                                <label for="experience">Experiencia con Tandas</label>
                                <select id="experience" name="experience">
                                    <option value="">Selecciona tu experiencia</option>
                                    <option value="none">Primera vez - Soy nuevo/a</option>
                                    <option value="traditional">He participado en tandas tradicionales</option>
                                    <option value="online">He usado plataformas digitales similares</option>
                                    <option value="coordinator">He coordinado tandas antes</option>
                                    <option value="expert">Tengo mucha experiencia</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="financial-section">
                        <h3><i class="fas fa-key"></i> Preferencias de Seguridad</h3>
                        
                        <div class="security-preferences">
                            <label class="checkbox-option">
                                <input type="checkbox" name="notifications" value="platform" checked>
                                <span class="checkmark"></span>
                                <div class="option-content">
                                    <strong>Notificaciones en Plataforma</strong>
                                    <p>Alertas y mensajes dentro de La Tanda (recomendado)</p>
                                </div>
                            </label>

                            <label class="checkbox-option">
                                <input type="checkbox" name="notifications" value="email" checked>
                                <span class="checkmark"></span>
                                <div class="option-content">
                                    <strong>Notificaciones por Email</strong>
                                    <p>Recibir actualizaciones importantes por correo</p>
                                </div>
                            </label>

                            <label class="checkbox-option">
                                <input type="checkbox" name="notifications" value="sms">
                                <span class="checkmark"></span>
                                <div class="option-content">
                                    <strong>Notificaciones por SMS</strong>
                                    <p>Alertas de pagos y recordatorios por mensaje</p>
                                </div>
                            </label>

                            <label class="checkbox-option">
                                <input type="checkbox" name="notifications" value="push">
                                <span class="checkmark"></span>
                                <div class="option-content">
                                    <strong>Notificaciones Push</strong>
                                    <p>Alertas instant√°neas en tu dispositivo</p>
                                </div>
                            </label>

                            <label class="checkbox-option">
                                <input type="checkbox" name="privacy" value="public_profile">
                                <span class="checkmark"></span>
                                <div class="option-content">
                                    <strong>Perfil P√∫blico</strong>
                                    <p>Permitir que otros usuarios vean mi perfil b√°sico</p>
                                </div>
                            </label>

                            <label class="checkbox-option">
                                <input type="checkbox" name="marketing" value="promotions">
                                <span class="checkmark"></span>
                                <div class="option-content">
                                    <strong>Ofertas y Promociones</strong>
                                    <p>Recibir informaci√≥n sobre nuevas funciones y ofertas</p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="kycSystem.previousStep()">
                            ‚Üê Anterior
                        </button>
                        <button type="submit" class="btn-primary">
                            Continuar ‚Üí
                        </button>
                    </div>
                </form>
            </div>

            <!-- Step 4: Verification -->
            <div class="form-step" id="step4">
                <div class="step-header">
                    <h2>Verificaci√≥n en Proceso</h2>
                    <p>Estamos revisando tu informaci√≥n para completar tu registro</p>
                </div>

                <div class="verification-content">
                    <div class="verification-status">
                        <div class="status-icon" id="verificationIcon">
                            <div class="loading-spinner"></div>
                        </div>
                        <div class="status-info">
                            <h3 id="verificationTitle">Procesando Verificaci√≥n...</h3>
                            <p id="verificationMessage">Nuestro sistema est√° validando tu informaci√≥n KYC</p>
                        </div>
                    </div>

                    <div class="verification-progress">
                        <div class="progress-item completed">
                            <div class="progress-icon"><i class="fas fa-check-circle"></i></div>
                            <div class="progress-text">
                                <h4>Informaci√≥n B√°sica</h4>
                                <p>Datos personales verificados</p>
                            </div>
                        </div>

                        <div class="progress-item processing" id="kycProgress">
                            <div class="progress-icon">üîÑ</div>
                            <div class="progress-text">
                                <h4>Verificaci√≥n KYC</h4>
                                <p>Validando documentos de identidad</p>
                            </div>
                        </div>

                        <div class="progress-item pending" id="profileProgress">
                            <div class="progress-icon">‚è≥</div>
                            <div class="progress-text">
                                <h4>Perfil Financiero</h4>
                                <p>Evaluando compatibilidad</p>
                            </div>
                        </div>

                        <div class="progress-item pending" id="approvalProgress">
                            <div class="progress-icon">‚è≥</div>
                            <div class="progress-text">
                                <h4>Aprobaci√≥n Final</h4>
                                <p>Revisi√≥n manual si es necesaria</p>
                            </div>
                        </div>
                    </div>

                    <div class="verification-info">
                        <h4><i class="fas fa-clipboard-list"></i> ¬øQu√© estamos verificando?</h4>
                        <ul>
                            <li><strong>Identidad:</strong> Confirmamos que eres quien dices ser</li>
                            <li><strong>Documentos:</strong> Validamos la autenticidad de tus documentos</li>
                            <li><strong>Perfil:</strong> Evaluamos tu idoneidad para el ecosistema</li>
                            <li><strong>Seguridad:</strong> Verificamos que no hay riesgos de fraude</li>
                        </ul>

                        <div class="time-estimate">
                            <p><strong>‚è±Ô∏è Tiempo estimado:</strong> 2-24 horas</p>
                            <p>Te notificaremos por email cuando est√© listo</p>
                        </div>
                    </div>

                    <div class="verification-actions">
                        <button type="button" class="btn-secondary" onclick="kycSystem.checkStatus()">
                            üîÑ Verificar Estado
                        </button>
                        <button type="button" class="btn-primary" onclick="kycSystem.continueToNext()" disabled id="continueBtn">
                            Continuar al Dashboard
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 5: Completion -->
            <div class="form-step" id="step5">
                <div class="step-header">
                    <h2>¬°Registro Completado!</h2>
                    <p>Bienvenido al ecosistema La Tanda</p>
                </div>

                <div class="completion-content">
                    <div class="success-animation">
                        <div class="success-icon"><i class="fas fa-trophy"></i></div>
                        <div class="celebration-text">
                            <h3>¬°Felicitaciones!</h3>
                            <p>Tu cuenta ha sido verificada y activada exitosamente</p>
                        </div>
                    </div>

                    <div class="welcome-benefits">
                        <h4><i class="fas fa-gift"></i> Beneficios de Bienvenida</h4>
                        <div class="benefits-grid">
                            <div class="benefit-item">
                                <div class="benefit-icon"><i class="fas fa-coins"></i></div>
                                <div class="benefit-content">
                                    <h5>50 LTD Tokens</h5>
                                    <p>Token de bienvenida gratis</p>
                                </div>
                            </div>

                            <div class="benefit-item">
                                <div class="benefit-icon"><i class="fas fa-trophy"></i></div>
                                <div class="benefit-content">
                                    <h5>NFT Genesis</h5>
                                    <p>Badge exclusivo de usuario fundador</p>
                                </div>
                            </div>

                            <div class="benefit-item">
                                <div class="benefit-icon"><i class="fas fa-gem"></i></div>
                                <div class="benefit-content">
                                    <h5>Premium 30 d√≠as</h5>
                                    <p>Acceso completo sin restricciones</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="next-steps">
                        <h4><i class="fas fa-clipboard-list"></i> Pr√≥ximos Pasos</h4>
                        <div class="steps-list">
                            <div class="next-step">
                                <div class="step-number">1</div>
                                <div class="step-content">
                                    <h5>Explora tu Dashboard</h5>
                                    <p>Familiar√≠zate con todas las funciones disponibles</p>
                                </div>
                            </div>

                            <div class="next-step">
                                <div class="step-number">2</div>
                                <div class="step-content">
                                    <h5>Configura tu Wallet</h5>
                                    <p>Activa La Tanda Wallet para empezar a participar</p>
                                </div>
                            </div>

                            <div class="next-step">
                                <div class="step-number">3</div>
                                <div class="step-content">
                                    <h5>√önete a tu Primera Tanda</h5>
                                    <p>Encuentra un grupo que se adapte a tus necesidades</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="completion-actions">
                        <button type="button" class="btn-secondary" onclick="window.location.href='index.html'">
                            Ir al Inicio
                        </button>
                        <button type="button" class="btn-primary" onclick="window.location.href='web3-dashboard.html'">
                            Ir al Dashboard ‚Üí
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Error handler para prevenir errores de extensiones
        window.addEventListener('error', function(e) {
            if (e.message.includes('MetaMask') || e.message.includes('ethereum')) {
                e.preventDefault();
                return false;
            }
        });
        
        // Promise rejection handler
        window.addEventListener('unhandledrejection', function(e) {
            if (e.reason && e.reason.message && (e.reason.message.includes('MetaMask') || e.reason.message.includes('ethereum'))) {
                e.preventDefault();
                return false;
            }
        });
    </script>

    <!-- KYC API Manager - Connects to Backend APIs -->
    <script>
        // Auth Headers Helper
        window.getAuthHeaders = function() {
            const token = localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token') || '';
            return token ? { 'Authorization': 'Bearer ' + token } : {};
        };

        // KYC API Manager Class
        class KYCAPIManager {
            constructor() {
                this.currentStep = 1;
                this.userData = {};
                this.kycData = {};
                this.documentFile = null;
                this.selfieFile = null;
                this.addressFile = null;
                this.init();
            }

            async init() {
                this.checkExistingSession();
                this.setupFormInterceptors();
                this.setupFileHandlers();
            }

            // Check if user already has a session
            checkExistingSession() {
                const user = JSON.parse(localStorage.getItem('latanda_user') || '{}');
                if (user.id || user.user_id) {
                    this.userData.userId = user.id || user.user_id;
                    this.userData.email = user.email;
                    this.userData.name = user.name;
                }
            }

            // Setup form submission interceptors
            setupFormInterceptors() {
                // Step 1: Basic Info Form
                const basicInfoForm = document.getElementById('basicInfoForm');
                if (basicInfoForm) {
                    basicInfoForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        await this.handleBasicInfoSubmit(e);
                    });
                }

                // Step 2: KYC Form
                const kycForm = document.getElementById('kycForm');
                if (kycForm) {
                    kycForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        await this.handleKYCSubmit(e);
                    });
                }

                // Step 3: Financial Form
                const financialForm = document.getElementById('financialForm');
                if (financialForm) {
                    financialForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        await this.handleFinancialSubmit(e);
                    });
                }
            }

            // Setup file input handlers
            setupFileHandlers() {
                // Document upload
                const documentUpload = document.getElementById('documentUpload');
                const documentFile = document.getElementById('documentFile');
                if (documentUpload && documentFile) {
                    documentUpload.addEventListener('click', () => documentFile.click());
                    documentUpload.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        documentUpload.classList.add('dragover');
                    });
                    documentUpload.addEventListener('dragleave', () => {
                        documentUpload.classList.remove('dragover');
                    });
                    documentUpload.addEventListener('drop', (e) => {
                        e.preventDefault();
                        documentUpload.classList.remove('dragover');
                        const file = e.dataTransfer.files[0];
                        if (file) this.handleDocumentFile(file);
                    });
                    documentFile.addEventListener('change', (e) => {
                        if (e.target.files[0]) this.handleDocumentFile(e.target.files[0]);
                    });
                }

                // Selfie upload
                const selfieFile = document.getElementById('selfieFile');
                if (selfieFile) {
                    selfieFile.addEventListener('change', (e) => {
                        if (e.target.files[0]) this.handleSelfieFile(e.target.files[0]);
                    });
                }

                // Address proof upload
                const addressUpload = document.getElementById('addressUpload');
                const addressFile = document.getElementById('addressFile');
                if (addressUpload && addressFile) {
                    addressUpload.addEventListener('click', () => addressFile.click());
                    addressUpload.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        addressUpload.classList.add('dragover');
                    });
                    addressUpload.addEventListener('dragleave', () => {
                        addressUpload.classList.remove('dragover');
                    });
                    addressUpload.addEventListener('drop', (e) => {
                        e.preventDefault();
                        addressUpload.classList.remove('dragover');
                        const file = e.dataTransfer.files[0];
                        if (file) this.handleAddressFile(file);
                    });
                    addressFile.addEventListener('change', (e) => {
                        if (e.target.files[0]) this.handleAddressFile(e.target.files[0]);
                    });
                }
            }

            // Handle document file selection
            async handleDocumentFile(file) {
                const validation = this.validateFile(file);
                if (!validation.valid) {
                    this.showNotification(validation.error, 'error');
                    return;
                }

                this.documentFile = file;
                this.showPreview('document', file);
            }

            // Handle selfie file selection
            async handleSelfieFile(file) {
                const validation = this.validateFile(file, true);
                if (!validation.valid) {
                    this.showNotification(validation.error, 'error');
                    return;
                }

                this.selfieFile = file;
                this.showPreview('selfie', file);
            }

            // Handle address proof file selection
            async handleAddressFile(file) {
                const validation = this.validateFile(file);
                if (!validation.valid) {
                    this.showNotification(validation.error, 'error');
                    return;
                }

                this.addressFile = file;
                this.showPreview('address', file);
            }

            // Show file preview
            showPreview(type, file) {
                const previewContainer = document.getElementById(`${type}Preview`);
                const previewImg = document.getElementById(`${type}PreviewImg`);
                const fileName = document.getElementById(`${type}FileName`);
                const fileSize = document.getElementById(`${type}FileSize`);

                if (previewContainer && previewImg) {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            previewImg.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    } else {
                        previewImg.src = '/assets/images/pdf-icon.png';
                    }

                    if (fileName) fileName.textContent = file.name;
                    if (fileSize) fileSize.textContent = this.formatFileSize(file.size);
                    previewContainer.style.display = 'block';
                }
            }

            // Validate file
            validateFile(file, imageOnly = false) {
                const maxSize = 10 * 1024 * 1024; // 10MB
                const validTypes = imageOnly
                    ? ['image/jpeg', 'image/png', 'image/webp']
                    : ['image/jpeg', 'image/png', 'image/webp', 'application/pdf'];

                if (file.size > maxSize) {
                    return { valid: false, error: 'Archivo muy grande (max 10MB)' };
                }
                if (!validTypes.includes(file.type)) {
                    return { valid: false, error: imageOnly ? 'Solo se aceptan imagenes (JPG, PNG)' : 'Tipo de archivo no soportado' };
                }
                return { valid: true };
            }

            // Format file size
            formatFileSize(bytes) {
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            }

            // Convert file to Base64
            async fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const base64 = reader.result.split(',')[1];
                        resolve(base64);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            // ============================================
            // STEP 1: Basic Info - Register User
            // ============================================
            async handleBasicInfoSubmit(e) {
                const form = e.target;
                const formData = new FormData(form);

                const firstName = formData.get('firstName');
                const lastName = formData.get('lastName');
                const email = formData.get('email');
                const phone = formData.get('phone');
                const countryCode = formData.get('countryCode');
                const password = formData.get('password');
                const confirmPassword = formData.get('confirmPassword');
                const country = formData.get('country');
                const birthDate = formData.get('birthDate');

                // Validation
                if (password !== confirmPassword) {
                    this.showNotification('Las contrase√±as no coinciden', 'error');
                    return;
                }

                if (password.length < 8) {
                    this.showNotification('La contrase√±a debe tener al menos 8 caracteres', 'error');
                    return;
                }

                this.showLoading(true);

                try {
                    const response = await fetch('/api/auth/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: `${firstName} ${lastName}`,
                            email: email,
                            phone: countryCode + phone,
                            password: password,
                            country: country,
                            birth_date: birthDate,
                            device_info: navigator.userAgent
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        // Store auth token
                        localStorage.setItem('auth_token', result.auth_token || result.token);
                        localStorage.setItem('latanda_user', JSON.stringify(result.user));
                        this.userData = result.user;
                        this.userData.userId = result.user.id || result.user.user_id;

                        this.showNotification('Registro exitoso', 'success');

                        // Move to next step
                        this.goToStep(2);
                    } else {
                        this.showNotification(result.message || 'Error en el registro', 'error');
                    }
                } catch (err) {
                    this.showNotification('Error de conexion. Intenta de nuevo.', 'error');
                } finally {
                    this.showLoading(false);
                }
            }

            // ============================================
            // STEP 2: KYC - Upload Documents
            // ============================================
            async handleKYCSubmit(e) {
                const form = e.target;
                const formData = new FormData(form);
                const documentType = formData.get('documentType') || 'national_id';

                // Validate required files
                if (!this.documentFile) {
                    this.showNotification('Por favor sube tu documento de identidad', 'error');
                    return;
                }

                if (!this.selfieFile) {
                    this.showNotification('Por favor toma una selfie de verificacion', 'error');
                    return;
                }

                this.showLoading(true);

                try {
                    // Step 2a: Upload document
                    const documentBase64 = await this.fileToBase64(this.documentFile);

                    const uploadResponse = await fetch('/api/kyc/upload-document', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            ...window.getAuthHeaders()
                        },
                        body: JSON.stringify({
                            document_type: documentType,
                            document_image_base64: documentBase64,
                            document_number: null
                        })
                    });

                    const uploadResult = await uploadResponse.json();

                    if (!uploadResult.success) {
                        throw new Error(uploadResult.message || 'Error al subir documento');
                    }

                    this.kycData.kycId = uploadResult.kyc_id;

                    // Step 2b: Process OCR
                    const ocrResponse = await fetch('/api/kyc/process-ocr', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            ...window.getAuthHeaders()
                        },
                        body: JSON.stringify({
                            document_image_base64: documentBase64,
                            document_type: documentType
                        })
                    });

                    const ocrResult = await ocrResponse.json();
                    if (ocrResult.success) {
                        this.kycData.ocrData = ocrResult.extracted_data;
                    }

                    // Step 2c: Upload selfie
                    const selfieBase64 = await this.fileToBase64(this.selfieFile);

                    const selfieResponse = await fetch('/api/kyc/upload-selfie', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            ...window.getAuthHeaders()
                        },
                        body: JSON.stringify({
                            selfie_image_base64: selfieBase64
                        })
                    });

                    const selfieResult = await selfieResponse.json();

                    if (selfieResult.success) {
                        this.kycData.faceMatch = selfieResult.face_match;
                        this.kycData.status = selfieResult.status;
                    }

                    // Step 2d: Upload address proof (optional)
                    if (this.addressFile) {
                        const addressBase64 = await this.fileToBase64(this.addressFile);
                        const addressType = formData.get('addressProofType') || 'utility_bill';

                        await fetch('/api/kyc/upload-document', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                ...window.getAuthHeaders()
                            },
                            body: JSON.stringify({
                                document_type: addressType,
                                document_image_base64: addressBase64,
                                document_number: null
                            })
                        });
                    }

                    this.showNotification('Documentos subidos exitosamente', 'success');
                    this.goToStep(3);

                } catch (err) {
                    this.showNotification(err.message || 'Error al procesar documentos', 'error');
                } finally {
                    this.showLoading(false);
                }
            }

            // ============================================
            // STEP 3: Financial Profile
            // ============================================
            async handleFinancialSubmit(e) {
                const form = e.target;
                const formData = new FormData(form);

                const employmentStatus = formData.get('employmentStatus');
                const monthlyIncome = formData.get('monthlyIncome');
                const occupation = formData.get('occupation');
                const userType = formData.get('userType');
                const savingGoal = formData.get('savingGoal');
                const preferredAmount = formData.get('preferredAmount');
                const experience = formData.get('experience');

                // Get notification preferences
                const notifications = [];
                form.querySelectorAll('input[name="notifications"]:checked').forEach(cb => {
                    notifications.push(cb.value);
                });

                // Get privacy settings
                const privacy = [];
                form.querySelectorAll('input[name="privacy"]:checked').forEach(cb => {
                    privacy.push(cb.value);
                });

                this.showLoading(true);

                try {
                    const response = await fetch('/api/user/profile', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            ...window.getAuthHeaders()
                        },
                        body: JSON.stringify({
                            preferences: {
                                employment_status: employmentStatus,
                                monthly_income: monthlyIncome,
                                occupation: occupation,
                                user_type: userType,
                                saving_goal: savingGoal,
                                preferred_amount: preferredAmount,
                                experience: experience,
                                notifications: notifications,
                                privacy: privacy
                            }
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.showNotification('Perfil financiero guardado', 'success');
                        this.goToStep(4);

                        // Start checking verification status
                        this.startVerificationCheck();
                    } else {
                        this.showNotification(result.message || 'Error al guardar perfil', 'error');
                    }
                } catch (err) {
                    this.showNotification('Error de conexion', 'error');
                } finally {
                    this.showLoading(false);
                }
            }

            // ============================================
            // STEP 4: Verification Status
            // ============================================
            async loadKYCStatus() {
                try {
                    const response = await fetch('/api/kyc/status', {
                        headers: window.getAuthHeaders()
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.kycData.level = result.kyc_level;
                        this.kycData.documents = result.documents;
                        this.kycData.limits = result.limits;

                        this.updateVerificationUI(result);

                        return result;
                    }
                } catch (err) {
                }
                return null;
            }

            updateVerificationUI(kycStatus) {
                const kycProgress = document.getElementById('kycProgress');
                const profileProgress = document.getElementById('profileProgress');
                const approvalProgress = document.getElementById('approvalProgress');
                const verificationIcon = document.getElementById('verificationIcon');
                const verificationTitle = document.getElementById('verificationTitle');
                const verificationMessage = document.getElementById('verificationMessage');
                const continueBtn = document.getElementById('continueBtn');

                // Update progress items based on KYC level
                if (kycStatus.kyc_level && kycStatus.kyc_level !== 'none') {
                    // KYC verified
                    if (kycProgress) {
                        kycProgress.classList.remove('processing');
                        kycProgress.classList.add('completed');
                        kycProgress.querySelector('.progress-icon').innerHTML = '<i class="fas fa-check-circle"></i>';
                    }

                    if (profileProgress) {
                        profileProgress.classList.remove('pending');
                        profileProgress.classList.add('completed');
                        profileProgress.querySelector('.progress-icon').innerHTML = '<i class="fas fa-check-circle"></i>';
                    }

                    if (approvalProgress) {
                        approvalProgress.classList.remove('pending');
                        approvalProgress.classList.add('completed');
                        approvalProgress.querySelector('.progress-icon').innerHTML = '<i class="fas fa-check-circle"></i>';
                    }

                    // Update main status
                    if (verificationIcon) {
                        verificationIcon.innerHTML = '<i class="fas fa-check-circle" style="font-size: 4rem; color: #10b981;"></i>';
                    }
                    if (verificationTitle) {
                        verificationTitle.textContent = 'Verificacion Completada';
                    }
                    if (verificationMessage) {
                        verificationMessage.textContent = `Nivel KYC: ${kycStatus.kyc_level.toUpperCase()} - Limite diario: ${kycStatus.limits?.daily_limit || 'Sin limite'}`;
                    }
                    if (continueBtn) {
                        continueBtn.disabled = false;
                    }
                } else {
                    // Still processing
                    if (verificationIcon) {
                        verificationIcon.innerHTML = '<div class="loading-spinner"></div>';
                    }
                    if (verificationTitle) {
                        verificationTitle.textContent = 'Procesando Verificacion...';
                    }
                    if (verificationMessage) {
                        verificationMessage.textContent = 'Nuestro sistema esta validando tu informacion KYC';
                    }
                }
            }

            startVerificationCheck() {
                // Check status immediately
                this.loadKYCStatus();

                // Then check every 30 seconds
                this.verificationInterval = setInterval(() => {
                    this.loadKYCStatus();
                }, 30000);
            }

            // Navigation helpers
            goToStep(step) {
                this.currentStep = step;

                // Update step UI
                document.querySelectorAll('.form-step').forEach((formStep, index) => {
                    formStep.classList.remove('active');
                    if (index + 1 === step) {
                        formStep.classList.add('active');
                    }
                });

                // Update progress indicators
                document.querySelectorAll('.step').forEach((stepEl, index) => {
                    stepEl.classList.remove('active', 'completed');
                    if (index + 1 < step) {
                        stepEl.classList.add('completed');
                    } else if (index + 1 === step) {
                        stepEl.classList.add('active');
                    }
                });

                // Update progress bar
                const progressFill = document.getElementById('progressFill');
                if (progressFill) {
                    const progress = ((step - 1) / 4) * 100;
                    progressFill.style.width = progress + '%';
                }

                // If going to step 4, load KYC status
                if (step === 4) {
                    this.loadKYCStatus();
                }

            }

            // UI Helpers
            showNotification(message, type = 'info') {
                // Try to use existing notification system
                if (window.showNotification) {
                    window.showNotification(message, type);
                    return;
                }

                // Fallback notification
                const notification = document.createElement('div');
                notification.className = `kyc-notification ${type}`;
                notification.innerHTML = `
                    <div class="notification-content">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                        <span>${message}</span>
                    </div>
                `;
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 10px;
                    background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#06b6d4'};
                    color: white;
                    z-index: 10000;
                    animation: slideIn 0.3s ease;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                `;

                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }

            showLoading(show) {
                let loader = document.getElementById('kycLoader');
                if (show) {
                    if (!loader) {
                        loader = document.createElement('div');
                        loader.id = 'kycLoader';
                        loader.innerHTML = `
                            <div class="loader-content">
                                <div class="loader-spinner"></div>
                                <p>Procesando...</p>
                            </div>
                        `;
                        loader.style.cssText = `
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(0,0,0,0.7);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            z-index: 10001;
                        `;
                        loader.querySelector('.loader-content').style.cssText = `
                            text-align: center;
                            color: white;
                        `;
                        loader.querySelector('.loader-spinner').style.cssText = `
                            width: 50px;
                            height: 50px;
                            border: 4px solid rgba(255,255,255,0.3);
                            border-top-color: #00FFFF;
                            border-radius: 50%;
                            animation: spin 1s linear infinite;
                            margin: 0 auto 15px;
                        `;
                        document.body.appendChild(loader);
                    }
                    loader.style.display = 'flex';
                } else if (loader) {
                    loader.style.display = 'none';
                }
            }

            // Public methods for external calls
            checkStatus() {
                this.loadKYCStatus();
            }

            continueToNext() {
                this.goToStep(5);
            }

            removeFile(type) {
                if (type === 'document') {
                    this.documentFile = null;
                    const preview = document.getElementById('documentPreview');
                    if (preview) preview.style.display = 'none';
                } else if (type === 'selfie') {
                    this.selfieFile = null;
                    const preview = document.getElementById('selfiePreview');
                    if (preview) preview.style.display = 'none';
                } else if (type === 'address') {
                    this.addressFile = null;
                    const preview = document.getElementById('addressPreview');
                    if (preview) preview.style.display = 'none';
                }
            }

            // Camera methods
            async openCamera() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                    this.showCameraModal(stream, 'selfie');
                } catch (err) {
                    this.showNotification('No se pudo acceder a la camara', 'error');
                }
            }

            showCameraModal(stream, type) {
                const modal = document.createElement('div');
                modal.id = 'cameraModal';
                modal.innerHTML = `
                    <div class="camera-content">
                        <video id="cameraPreview" autoplay playsinline></video>
                        <canvas id="cameraCanvas" style="display:none;"></canvas>
                        <div class="camera-controls">
                            <button class="btn-capture" onclick="window.kycAPIManager.capturePhoto('${type}')">
                                <i class="fas fa-camera"></i> Capturar
                            </button>
                            <button class="btn-cancel" onclick="window.kycAPIManager.closeCamera()">
                                Cancelar
                            </button>
                        </div>
                    </div>
                `;
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.9);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10002;
                `;
                modal.querySelector('.camera-content').style.cssText = `
                    text-align: center;
                    max-width: 500px;
                    width: 90%;
                `;
                modal.querySelector('video').style.cssText = `
                    width: 100%;
                    max-height: 400px;
                    border-radius: 10px;
                    margin-bottom: 20px;
                `;
                modal.querySelector('.camera-controls').style.cssText = `
                    display: flex;
                    gap: 15px;
                    justify-content: center;
                `;
                modal.querySelectorAll('button').forEach(btn => {
                    btn.style.cssText = `
                        padding: 12px 24px;
                        border-radius: 8px;
                        border: none;
                        cursor: pointer;
                        font-weight: 600;
                    `;
                });
                modal.querySelector('.btn-capture').style.background = 'linear-gradient(135deg, #00FFFF, #7FFFD8)';
                modal.querySelector('.btn-cancel').style.cssText += 'background: #475569; color: white;';

                document.body.appendChild(modal);

                const video = document.getElementById('cameraPreview');
                video.srcObject = stream;
                this.cameraStream = stream;
            }

            capturePhoto(type) {
                const video = document.getElementById('cameraPreview');
                const canvas = document.getElementById('cameraCanvas');

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);

                canvas.toBlob((blob) => {
                    const file = new File([blob], `${type}_capture.jpg`, { type: 'image/jpeg' });
                    if (type === 'selfie') {
                        this.handleSelfieFile(file);
                    }
                    this.closeCamera();
                }, 'image/jpeg', 0.9);
            }

            closeCamera() {
                if (this.cameraStream) {
                    this.cameraStream.getTracks().forEach(track => track.stop());
                    this.cameraStream = null;
                }
                const modal = document.getElementById('cameraModal');
                if (modal) modal.remove();
            }

            selectSelfieFile() {
                const selfieFile = document.getElementById('selfieFile');
                if (selfieFile) selfieFile.click();
            }

            async scanFace() {
                // Start biometric scan (camera + face detection)
                this.showNotification('Iniciando escaneo biometrico...', 'info');
                await this.openCamera();
            }
        }

        // Initialize KYC API Manager when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            window.kycAPIManager = new KYCAPIManager();

            // Also expose methods for existing kycSystem calls
            if (!window.kycSystem) {
                window.kycSystem = {};
            }

            // Override/add methods
            window.kycSystem.openCamera = () => window.kycAPIManager.openCamera();
            window.kycSystem.selectSelfieFile = () => window.kycAPIManager.selectSelfieFile();
            window.kycSystem.scanFace = () => window.kycAPIManager.scanFace();
            window.kycSystem.removeFile = (type) => window.kycAPIManager.removeFile(type);
            window.kycSystem.checkStatus = () => window.kycAPIManager.checkStatus();
            window.kycSystem.continueToNext = () => window.kycAPIManager.continueToNext();
        });

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
            .upload-zone.dragover {
                border-color: #00FFFF !important;
                background: rgba(0, 255, 255, 0.1) !important;
            }
        `;
        document.head.appendChild(style);
    </script>

    <!-- Enhanced API Proxy -->
    
  <script nomodule>!function(){var e=document,t=e.createElement("script");if(!("noModule"in t)&&"onbeforeload"in t){var n=!1;e.addEventListener("beforeload",(function(e){if(e.target===t)n=!0;else if(!e.target.hasAttribute("nomodule")||!n)return;e.preventDefault()}),!0),t.type="module",t.src=".",e.head.appendChild(t),t.remove()}}();</script>
  <script nomodule crossorigin id="vite-legacy-polyfill" src="/assets/js/polyfills-legacy-YD97Sv6k.js"></script>
  <script nomodule crossorigin id="vite-legacy-entry" data-src="/assets/js/kycRegistration-legacy-CdrdMPAW.js">System.import(document.getElementById('vite-legacy-entry').getAttribute('data-src'))</script>
    <script src="js/components-loader.js?v=30.2"></script>
    <script src="shared-components.js?v=7.20"></script>
    <script src="js/onboarding/onboarding-system.js?v=14.4"></script>
</body>
</html>
