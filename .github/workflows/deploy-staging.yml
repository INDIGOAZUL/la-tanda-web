name: Deploy to GitHub Pages (Staging)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        if [ -f package.json ]; then
          npm ci
        else
          echo "No package.json found, skipping npm install"
        fi
        
    - name: Create staging environment configuration
      run: |
        # Create staging API configuration
        cat > api-proxy.js << 'EOF'
        // GitHub Pages Staging Configuration
        console.log('🚀 La Tanda Web3 - GitHub Pages Staging Environment');
        
        // API Configuration for staging
        const API_CONFIG = {
            baseURL: window.location.hostname.includes('github.io') 
                ? 'https://api.latanda.online'  // Staging API
                : 'http://localhost:3001',      // Local development
            environment: 'staging',
            features: {
                realAPI: false,  // Use simulation for staging
                blockchain: true,
                payments: false, // Disable real payments in staging
                notifications: true
            }
        };
        
        // Make API_CONFIG globally available
        window.LA_TANDA_CONFIG = API_CONFIG;
        
        // Add staging banner
        document.addEventListener('DOMContentLoaded', function() {
            const banner = document.createElement('div');
            banner.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
                color: white;
                text-align: center;
                padding: 8px;
                font-size: 14px;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            `;
            banner.innerHTML = '🧪 STAGING ENVIRONMENT - GitHub Pages Deployment for Testing';
            document.body.prepend(banner);
            
            // Adjust body padding to account for banner
            document.body.style.paddingTop = '40px';
        });
        EOF
        
    - name: Update HTML files for staging
      run: |
        # Add staging configuration to all HTML files
        for file in *.html; do
          if [ -f "$file" ]; then
            # Add staging API proxy script if not present
            if ! grep -q "api-proxy.js" "$file"; then
              sed -i 's|</head>|    <script src="api-proxy.js"></script>\n</head>|' "$file"
            fi
            
            # Update any localhost references for staging
            sed -i 's|http://localhost:8080|https://indigoazul.github.io/la-tanda-web|g' "$file"
            
            echo "✅ Updated $file for staging"
          fi
        done
        
    - name: Create staging README
      run: |
        cat > STAGING-README.md << 'EOF'
        # 🧪 La Tanda Web3 - Staging Environment
        
        This is the staging deployment of the La Tanda Web3 platform for testing purposes.
        
        ## 🌐 Access URLs
        
        - **Main Landing**: https://indigoazul.github.io/la-tanda-web/
        - **Authentication**: https://indigoazul.github.io/la-tanda-web/auth-enhanced.html
        - **Dashboard**: https://indigoazul.github.io/la-tanda-web/home-dashboard.html
        - **Group Management**: https://indigoazul.github.io/la-tanda-web/groups-advanced-system.html
        - **Wallet System**: https://indigoazul.github.io/la-tanda-web/tanda-wallet.html
        - **Marketplace**: https://indigoazul.github.io/la-tanda-web/marketplace-social.html
        - **KYC Registration**: https://indigoazul.github.io/la-tanda-web/kyc-registration.html
        - **Token Economics**: https://indigoazul.github.io/la-tanda-web/ltd-token-economics.html
        - **Commission System**: https://indigoazul.github.io/la-tanda-web/commission-system.html
        
        ## ⚠️ Staging Environment Notes
        
        - Uses simulation backend (no real transactions)
        - Real payments are disabled
        - Data is not persistent between sessions
        - Perfect for testing UI/UX and functionality
        
        ## 🧪 Testing Credentials
        
        - **Demo User**: demo@latanda.online / demo123
        - **Test Admin**: admin@latanda.online / Admin123!
        
        ## 🚀 Production Deployment
        
        After testing and validation, deploy to production at https://latanda.online
        EOF
        
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: Create deployment summary
      run: |
        echo "## 🚀 Staging Deployment Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### 🌐 Access URLs:" >> $GITHUB_STEP_SUMMARY
        echo "- **Main Site**: https://indigoazul.github.io/la-tanda-web/" >> $GITHUB_STEP_SUMMARY
        echo "- **Authentication**: https://indigoazul.github.io/la-tanda-web/auth-enhanced.html" >> $GITHUB_STEP_SUMMARY
        echo "- **Dashboard**: https://indigoazul.github.io/la-tanda-web/home-dashboard.html" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ✅ All 9 sections deployed and ready for testing!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "🧪 **Testing Environment**: Simulation backend enabled" >> $GITHUB_STEP_SUMMARY
        echo "🔒 **Security**: Real payments disabled for staging" >> $GITHUB_STEP_SUMMARY
        echo "📱 **Mobile**: Responsive design ready for testing" >> $GITHUB_STEP_SUMMARY