<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Tanda - Acceso Completo</title>
    <meta name="description" content="Sistema de autenticaci√≥n completo La Tanda - Multiple opciones de acceso">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* La Tanda Web3 System Colors - Consistent with main system */
            --tanda-cyan: #00FFFF;
            --tanda-cyan-light: #7FFFD8;
            --tanda-cyan-dark: #00E5E5;
            --tanda-black: #000000;
            --tanda-dark: #0A0A0A;
            --tanda-gray: #1A1A1A;
            --text-primary: #FFFFFF;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-accent: #00FFFF;
            --bg-glass: rgba(15, 23, 42, 0.8);
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --border-primary: rgba(0, 255, 255, 0.2);
            --error-color: #f87171;
            --success-color: #22d55e;
            --warning-color: #fbbf24;
        }
        
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: 
                radial-gradient(circle at 20% 80%, rgba(0, 255, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(127, 255, 216, 0.1) 0%, transparent 50%),
                linear-gradient(135deg, var(--bg-primary) 0%, var(--tanda-dark) 30%, var(--bg-secondary) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        /* Animated background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 25% 25%, rgba(0, 255, 255, 0.1) 0%, transparent 70%),
                radial-gradient(circle at 75% 75%, rgba(127, 255, 216, 0.05) 0%, transparent 70%);
            animation: backgroundPulse 8s ease-in-out infinite alternate;
            z-index: -1;
        }
        
        @keyframes backgroundPulse {
            0% { opacity: 0.3; }
            100% { opacity: 0.7; }
        }
        
        .auth-container {
            background: var(--bg-glass);
            backdrop-filter: blur(24px);
            border-radius: 24px;
            border: 1px solid var(--border-primary);
            padding: 40px;
            width: 100%;
            max-width: 480px;
            box-shadow: 
                0 25px 50px -12px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(0, 255, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .auth-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--tanda-cyan), transparent);
            animation: shimmer 2s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }
        
        .logo-section {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .logo {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            margin-bottom: 16px;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
        }
        
        .brand-name {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--tanda-cyan), var(--text-accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }
        
        .brand-tagline {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 400;
        }
        
        .auth-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 32px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px 16px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .tab-btn.active {
            background: var(--tanda-cyan);
            color: var(--tanda-black);
            font-weight: 600;
        }
        
        .tab-btn:hover:not(.active) {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .form-section {
            display: none;
        }
        
        .form-section.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-header {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .form-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        
        .form-subtitle {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.5;
        }
        
        .social-login {
            margin-bottom: 24px;
        }
        
        .social-buttons {
            display: grid;
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .social-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--text-primary);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 14px;
        }
        
        .social-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--tanda-cyan);
            transform: translateY(-1px);
        }
        
        .social-btn.google:hover {
            border-color: #4285f4;
            box-shadow: 0 0 20px rgba(66, 133, 244, 0.2);
        }
        
        .social-btn.apple:hover {
            border-color: #000;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        }
        
        .social-btn.telegram:hover {
            border-color: #0088cc;
            box-shadow: 0 0 20px rgba(0, 136, 204, 0.2);
        }
        
        .social-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        
        .divider {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 24px 0;
        }
        
        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .divider span {
            padding: 0 16px;
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-label {
            display: block;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .input-wrapper {
            position: relative;
        }
        
        .input-field {
            width: 100%;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--tanda-cyan);
            box-shadow: 0 0 0 3px rgba(0, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.08);
        }
        
        .input-field::placeholder {
            color: var(--text-secondary);
        }
        
        .input-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }
        
        .password-toggle {
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .password-toggle:hover {
            color: var(--tanda-cyan);
        }
        
        .forgot-password {
            text-align: right;
            margin-bottom: 24px;
        }
        
        .forgot-link {
            color: var(--tanda-cyan);
            text-decoration: none;
            font-size: 14px;
            transition: color 0.3s ease;
        }
        
        .forgot-link:hover {
            color: var(--text-accent);
        }
        
        .submit-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--tanda-cyan), var(--tanda-cyan-light));
            border: none;
            border-radius: 12px;
            color: var(--tanda-black);
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 255, 255, 0.3);
        }
        
        .submit-btn:active {
            transform: translateY(0);
        }
        
        .demo-section {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 20px;
            margin-top: 20px;
        }
        
        .demo-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .demo-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .demo-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border-color: var(--tanda-cyan);
        }
        
        .demo-btn.demo {
            border-color: var(--warning-color);
            color: var(--warning-color);
        }
        
        .demo-btn.test {
            border-color: var(--tanda-cyan);
            color: var(--tanda-cyan);
        }
        
        .error-message {
            color: var(--error-color);
            font-size: 12px;
            margin-top: 6px;
            display: none;
        }
        
        .success-message {
            color: var(--success-color);
            font-size: 12px;
            margin-top: 6px;
            display: none;
        }
        
        .loading {
            position: relative;
            overflow: hidden;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* JWT Security Indicator */
        .auth-security-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .security-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, rgba(34, 213, 94, 0.15), rgba(34, 213, 94, 0.05));
            border: 1px solid rgba(34, 213, 94, 0.3);
            border-radius: 20px;
            padding: 8px 12px;
            font-size: 12px;
            color: #22d55e;
            font-weight: 500;
            backdrop-filter: blur(10px);
            animation: securityPulse 2s infinite;
        }

        .security-badge i {
            font-size: 14px;
        }

        @keyframes securityPulse {
            0%, 100% { 
                box-shadow: 0 0 10px rgba(34, 213, 94, 0.3);
                border-color: rgba(34, 213, 94, 0.3);
            }
            50% { 
                box-shadow: 0 0 20px rgba(34, 213, 94, 0.5);
                border-color: rgba(34, 213, 94, 0.5);
            }
        }

        .token-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 11px;
            color: var(--tanda-cyan);
            display: none;
            backdrop-filter: blur(10px);
        }

        /* Password Strength Validator */
        .password-strength-container {
            margin-top: 8px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        .password-strength-container.active {
            display: block;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .password-strength-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 12px;
            font-weight: 500;
        }

        .password-strength-indicator {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .password-strength-bar {
            height: 100%;
            width: 0%;
            border-radius: 2px;
            transition: all 0.3s ease;
            background: linear-gradient(90deg, #ef4444, #f97316, #eab308, #22c55e);
        }

        .password-strength-bar.weak {
            width: 25%;
            background: #ef4444;
        }

        .password-strength-bar.fair {
            width: 50%;
            background: #f97316;
        }

        .password-strength-bar.good {
            width: 75%;
            background: #eab308;
        }

        .password-strength-bar.strong {
            width: 100%;
            background: #22c55e;
        }

        .password-requirements {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .password-requirement {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            padding: 2px 0;
            transition: all 0.3s ease;
        }

        .password-requirement i {
            width: 12px;
            font-size: 10px;
            transition: all 0.3s ease;
        }

        .password-requirement.met {
            color: #22c55e;
        }

        .password-requirement.met i:before {
            content: '\f00c'; /* fa-check */
            color: #22c55e;
        }

        .password-requirement:not(.met) i:before {
            content: '\f00d'; /* fa-times */
            color: #ef4444;
        }

        .password-strength-label {
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .strength-weak { color: #ef4444; }
        .strength-fair { color: #f97316; }  
        .strength-good { color: #eab308; }
        .strength-strong { color: #22c55e; }

        /* Security Warning Animation */
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-5px); }
            20%, 80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-5px); }
        }

        /* Rate Limit Warning Animations */
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
        
        @media (max-width: 480px) {
            .auth-container {
                padding: 24px;
                margin: 10px;
                border-radius: 16px;
            }
            
            .demo-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Include API Proxy -->
    <script src="api-proxy-working.js"></script>
    <div class="auth-container">
        <!-- Logo Section -->
        <div class="logo-section">
            <img src="La Tanda logos (3).png" alt="La Tanda" class="logo">
            <h1 class="brand-name">La Tanda</h1>
            <p class="brand-tagline">Ecosistema Financiero Web3</p>
        </div>
        
        <!-- Tab Navigation -->
        <div class="auth-tabs">
            <button class="tab-btn active" onclick="switchTab('login')">Iniciar Sesi√≥n</button>
            <button class="tab-btn" onclick="switchTab('register')">Crear Cuenta</button>
        </div>
        
        <!-- Login Form -->
        <div id="loginForm" class="form-section active">
            <div class="form-header">
                <h2 class="form-title">Bienvenido de vuelta</h2>
                <p class="form-subtitle">Accede a tu cuenta La Tanda</p>
            </div>
            
            <!-- Social Login Options -->
            <div class="social-login">
                <div class="social-buttons">
                    <button class="social-btn google" onclick="loginWithProvider('google')">
                        <svg class="social-icon" viewBox="0 0 24 24">
                            <path fill="#4285f4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34a853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#fbbc05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#ea4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Continuar con Google
                    </button>
                    
                    <button class="social-btn apple" onclick="loginWithProvider('apple')">
                        <svg class="social-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
                        </svg>
                        Continuar con Apple
                    </button>
                    
                    <button class="social-btn telegram" onclick="loginWithProvider('telegram')">
                        <svg class="social-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                        </svg>
                        Continuar con Telegram
                    </button>
                </div>
                
                <div class="divider">
                    <span>o contin√∫a con email</span>
                </div>
            </div>
            
            <!-- Email Login Form -->
            <form id="loginFormElement" onsubmit="handleLogin(event)">
                <div class="input-group">
                    <label class="input-label">Email</label>
                    <div class="input-wrapper">
                        <input 
                            type="email" 
                            id="loginEmail" 
                            class="input-field" 
                            placeholder="admin@latanda.online"
                            value="admin@latanda.online"
                            autocomplete="email"
                            required
                        >
                        <div class="input-icon">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="error-message" id="loginEmailError"></div>
                </div>
                
                <div class="input-group">
                    <label class="input-label">Contrase√±a</label>
                    <div class="input-wrapper">
                        <input 
                            type="password" 
                            id="loginPassword" 
                            class="input-field" 
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            value="Admin123!"
                            autocomplete="current-password"
                            required
                        >
                        <div class="input-icon password-toggle" onclick="togglePassword('loginPassword')">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="error-message" id="loginPasswordError"></div>
                </div>
                
                <div class="forgot-password">
                    <a href="#" class="forgot-link" onclick="forgotPassword()">¬øOlvidaste tu contrase√±a?</a>
                </div>
                
                <button type="submit" class="submit-btn" id="loginSubmitBtn">
                    Iniciar Sesi√≥n
                </button>
            </form>

            <!-- DEVELOPMENT ACCESS - DISABLED FOR PRODUCTION -->
            <!-- To re-enable for testing, uncomment the section below -->
            <!--
            <div class="demo-section">
                <div class="demo-title">Acceso de desarrollo</div>
                <div class="demo-buttons">
                    <button type="button" class="demo-btn" onclick="adminAccess()">üîß Admin</button>
                    <button type="button" class="demo-btn" onclick="demoAccess()">üéÆ Demo</button>
                    <button type="button" class="demo-btn" onclick="testDirectAccess()">üîç Test</button>
                    <button type="button" class="demo-btn" onclick="directLogin()">üöÄ Direct</button>
                    <button type="button" class="demo-btn" onclick="openTestPage()">üß™ API</button>
                    <button type="button" class="demo-btn" onclick="clearAuthData()">üîÑ Reset</button>
                </div>
            </div>
            -->
        </div>
        
        <!-- Register Form -->
        <div id="registerForm" class="form-section">
            <div class="form-header">
                <h2 class="form-title">Crear Cuenta</h2>
                <p class="form-subtitle">√önete al ecosistema financiero descentralizado</p>
            </div>
            
            <!-- Social Registration -->
            <div class="social-login">
                <div class="social-buttons">
                    <button class="social-btn google" onclick="registerWithProvider('google')">
                        <svg class="social-icon" viewBox="0 0 24 24">
                            <path fill="#4285f4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34a853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#fbbc05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#ea4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Crear con Google
                    </button>
                    
                    <button class="social-btn apple" onclick="registerWithProvider('apple')">
                        <svg class="social-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
                        </svg>
                        Crear con Apple
                    </button>
                    
                    <button class="social-btn telegram" onclick="registerWithProvider('telegram')">
                        <svg class="social-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                        </svg>
                        Crear con Telegram
                    </button>
                </div>
                
                <div class="divider">
                    <span>o crea con email</span>
                </div>
            </div>
            
            <!-- Email Registration Form -->
            <form id="registerFormElement" onsubmit="handleRegister(event)">
                <div class="input-group">
                    <label class="input-label">Nombre completo</label>
                    <div class="input-wrapper">
                        <input 
                            type="text" 
                            id="registerName" 
                            class="input-field" 
                            placeholder="Tu nombre completo"
                            required
                        >
                        <div class="input-icon">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="error-message" id="registerNameError"></div>
                </div>
                
                <div class="input-group">
                    <label class="input-label">Email</label>
                    <div class="input-wrapper">
                        <input 
                            type="email" 
                            id="registerEmail" 
                            class="input-field" 
                            placeholder="tu@email.com"
                            autocomplete="username"
                            required
                        >
                        <div class="input-icon">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="error-message" id="registerEmailError"></div>
                </div>
                
                <div class="input-group">
                    <label class="input-label">Contrase√±a</label>
                    <div class="input-wrapper">
                        <input 
                            type="password" 
                            id="registerPassword" 
                            class="input-field" 
                            placeholder="M√≠nimo 8 caracteres"
                            autocomplete="new-password"
                            required
                        >
                        <div class="input-icon password-toggle" onclick="togglePassword('registerPassword')">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="error-message" id="registerPasswordError"></div>
                    
                    <!-- Password Strength Validator -->
                    <div class="password-strength-container" id="passwordStrengthContainer">
                        <div class="password-strength-header">
                            <i class="fas fa-shield-alt"></i>
                            <span>Fortaleza de Contrase√±a</span>
                            <span class="password-strength-label" id="strengthLabel">D√©bil</span>
                        </div>
                        
                        <div class="password-strength-indicator">
                            <div class="password-strength-bar" id="strengthBar"></div>
                        </div>
                        
                        <ul class="password-requirements">
                            <li class="password-requirement" id="req-length">
                                <i class="fas"></i>
                                <span>M√≠nimo 8 caracteres</span>
                            </li>
                            <li class="password-requirement" id="req-uppercase">
                                <i class="fas"></i>
                                <span>Una letra may√∫scula</span>
                            </li>
                            <li class="password-requirement" id="req-lowercase">
                                <i class="fas"></i>
                                <span>Una letra min√∫scula</span>
                            </li>
                            <li class="password-requirement" id="req-number">
                                <i class="fas"></i>
                                <span>Un n√∫mero</span>
                            </li>
                            <li class="password-requirement" id="req-special">
                                <i class="fas"></i>
                                <span>Un car√°cter especial (!@#$%^&*)</span>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <button type="submit" class="submit-btn" id="registerSubmitBtn">
                    Crear Cuenta
                </button>
            </form>
        </div>
    </div>

    <!-- JWT Security Indicator -->
    <div class="auth-security-indicator" id="securityIndicator">
        <div class="security-badge">
            <i class="fas fa-shield-alt"></i>
            <span class="security-text">JWT Validaci√≥n Activa</span>
        </div>
    </div>

    <!-- Token Information -->
    <div class="token-info" id="tokenInfo">
        <span id="tokenStatus">Token info</span>
    </div>

    <script>
        // Enhanced Authentication System
        class EnhancedAuth {
            constructor() {
                this.apiBaseURL = 'https://api.latanda.online/api';
                this.isLoading = false;
                this.rateLimitConfig = {
                    maxAttempts: 5,
                    windowMs: 15 * 60 * 1000, // 15 minutes
                    progressiveDelayMs: [1000, 2000, 5000, 10000, 30000], // Progressive delays
                    lockoutDurationMs: 30 * 60 * 1000 // 30 minutes lockout
                };
                this.loginAttempts = this.getLoginAttempts();
                this.init();
            }

            init() {
                // Check if user is already authenticated
                this.checkAuthStatus();
                
                // Setup form validators
                this.setupValidators();
                
                // Setup input sanitization
                this.setupInputSanitization();
                
                console.log('üîê Enhanced Auth System with Input Sanitization initialized');
            }

            checkAuthStatus() {
                const token = localStorage.getItem('latanda_auth_token');
                if (token) {
                    console.log('üîç Checking existing token...');
                    
                    if (this.isValidToken(token)) {
                        const tokenData = this.decodeToken(token);
                        
                        if (tokenData) {
                            console.log('‚úÖ Valid token found, auto-redirecting:', {
                                user_id: tokenData.payload.user_id,
                                role: tokenData.payload.role,
                                expires_in: `${Math.floor(tokenData.timeToExpiry / 60)} minutes`
                            });

                            // Setup token refresh scheduling
                            this.scheduleTokenRefresh(tokenData.timeToExpiry);

                            // Check if token expires soon and try to refresh
                            if (tokenData.timeToExpiry < 300) { // Less than 5 minutes
                                console.log('üîÑ Token expires soon, attempting refresh before redirect...');
                                
                                this.refreshToken()
                                    .then(() => {
                                        console.log('‚úÖ Token refreshed, redirecting...');
                                        this.redirectToSystem();
                                    })
                                    .catch((refreshError) => {
                                        console.warn('üîí Token refresh failed during auth check:', refreshError.message);
                                        // Token might still be valid for a few minutes, let user proceed
                                        if (tokenData.timeToExpiry > 0) {
                                            this.redirectToSystem();
                                        } else {
                                            this.handleTokenExpired();
                                        }
                                    });
                            } else {
                                // Token is valid and not expiring soon
                                this.redirectToSystem();
                            }
                        } else {
                            console.warn('üîí Could not decode token, clearing...');
                            this.handleTokenExpired();
                        }
                    } else {
                        console.warn('üîí Invalid token found, clearing...');
                        this.handleTokenExpired();
                    }
                } else {
                    console.log('üîç No token found, showing login form');
                }
            }

            isValidToken(token) {
                try {
                    if (!token || typeof token !== 'string') {
                        console.warn('üîí Invalid token format');
                        return false;
                    }

                    const parts = token.split('.');
                    if (parts.length !== 3) {
                        console.warn('üîí JWT token must have 3 parts');
                        return false;
                    }

                    // Decode and validate header
                    const header = JSON.parse(atob(parts[0]));
                    if (!header.alg || !header.typ || header.typ !== 'JWT') {
                        console.warn('üîí Invalid JWT header');
                        return false;
                    }

                    // Decode and validate payload
                    const payload = JSON.parse(atob(parts[1]));
                    
                    // Check required claims
                    if (!payload.exp || !payload.iat) {
                        console.warn('üîí Missing required JWT claims (exp, iat)');
                        return false;
                    }

                    // Check expiration
                    const now = Math.floor(Date.now() / 1000);
                    if (payload.exp <= now) {
                        console.warn('üîí JWT token has expired');
                        return false;
                    }

                    // Check issued at time (not in future)
                    if (payload.iat > now + 300) { // 5 minute tolerance
                        console.warn('üîí JWT token issued in future');
                        return false;
                    }

                    // Check not before time if present
                    if (payload.nbf && payload.nbf > now) {
                        console.warn('üîí JWT token not yet valid');
                        return false;
                    }

                    // Check issuer if configured
                    const expectedIssuer = 'latanda.online';
                    if (payload.iss && payload.iss !== expectedIssuer) {
                        console.warn('üîí JWT token from unexpected issuer');
                        return false;
                    }

                    // Check audience if configured
                    const expectedAudience = 'latanda-web-app';
                    if (payload.aud && payload.aud !== expectedAudience) {
                        console.warn('üîí JWT token for wrong audience');
                        return false;
                    }

                    // Additional validation for La Tanda specific claims
                    if (payload.user_id && typeof payload.user_id !== 'string') {
                        console.warn('üîí Invalid user_id in token');
                        return false;
                    }

                    if (payload.role && !['admin', 'user', 'demo', 'coordinator'].includes(payload.role)) {
                        console.warn('üîí Invalid role in token');
                        return false;
                    }

                    console.log('‚úÖ JWT token validation successful', {
                        user_id: payload.user_id,
                        role: payload.role,
                        exp: new Date(payload.exp * 1000),
                        iss: payload.iss
                    });

                    return true;
                } catch (error) {
                    console.error('üîí JWT validation error:', error.message);
                    return false;
                }
            }

            // Enhanced JWT token decoding with validation
            decodeToken(token) {
                try {
                    if (!this.isValidToken(token)) {
                        return null;
                    }

                    const payload = JSON.parse(atob(token.split('.')[1]));
                    return {
                        header: JSON.parse(atob(token.split('.')[0])),
                        payload: payload,
                        signature: token.split('.')[2],
                        isExpired: payload.exp <= Math.floor(Date.now() / 1000),
                        expiresAt: new Date(payload.exp * 1000),
                        issuedAt: new Date(payload.iat * 1000),
                        timeToExpiry: payload.exp - Math.floor(Date.now() / 1000)
                    };
                } catch (error) {
                    console.error('üîí Token decode error:', error);
                    return null;
                }
            }

            // Token refresh mechanism
            async refreshToken() {
                try {
                    const currentToken = localStorage.getItem('latanda_auth_token');
                    if (!currentToken) {
                        throw new Error('No token to refresh');
                    }

                    const tokenData = this.decodeToken(currentToken);
                    if (!tokenData) {
                        throw new Error('Invalid token for refresh');
                    }

                    // Check if token needs refresh (expires in less than 15 minutes)
                    const refreshThreshold = 15 * 60; // 15 minutes
                    if (tokenData.timeToExpiry > refreshThreshold) {
                        console.log('üîÑ Token refresh not needed yet');
                        return currentToken;
                    }

                    console.log('üîÑ Attempting token refresh...');

                    const response = await fetch(`${this.apiBaseURL}/auth/refresh`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${currentToken}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.data.auth_token) {
                            const newToken = data.data.auth_token;
                            
                            // Validate new token
                            if (this.isValidToken(newToken)) {
                                localStorage.setItem('latanda_auth_token', newToken);
                                console.log('‚úÖ Token refreshed successfully');
                                return newToken;
                            } else {
                                throw new Error('Invalid refreshed token');
                            }
                        } else {
                            throw new Error('Invalid refresh response');
                        }
                    } else if (response.status === 401) {
                        // Refresh token expired, need to login again
                        this.handleTokenExpired();
                        throw new Error('Refresh token expired');
                    } else {
                        throw new Error(`Refresh failed: ${response.status}`);
                    }

                } catch (error) {
                    console.error('üîí Token refresh failed:', error.message);
                    
                    // If refresh fails, clear invalid token
                    if (error.message.includes('expired') || error.message.includes('Invalid')) {
                        this.handleTokenExpired();
                    }
                    
                    throw error;
                }
            }

            // Handle token expiration
            handleTokenExpired() {
                console.warn('üîí Token expired, clearing session');
                
                // Clear all auth data
                localStorage.removeItem('latanda_auth_token');
                localStorage.removeItem('latanda_user');
                sessionStorage.clear();
                
                // Show user-friendly message
                this.showError(
                    document.querySelector('.auth-container'), 
                    'Tu sesi√≥n ha expirado. Por favor, inicia sesi√≥n nuevamente.'
                );
                
                // Reset form to login tab (with error handling)
                try {
                    if (typeof switchTab === 'function') {
                        switchTab('login');
                    }
                } catch (e) {
                    console.warn('Could not switch to login tab:', e.message);
                }
                
                // Clear form fields (with null checks)
                const loginEmail = document.getElementById('loginEmail');
                const loginPassword = document.getElementById('loginPassword');
                
                if (loginEmail) loginEmail.value = '';
                if (loginPassword) loginPassword.value = '';
            }

            // Validate token on each API request
            async makeAuthenticatedRequest(endpoint, options = {}) {
                try {
                    let token = localStorage.getItem('latanda_auth_token');
                    
                    if (!token) {
                        throw new Error('No authentication token available');
                    }

                    // Check if token needs refresh
                    const tokenData = this.decodeToken(token);
                    if (!tokenData) {
                        throw new Error('Invalid authentication token');
                    }

                    // Auto-refresh if token expires soon
                    if (tokenData.timeToExpiry < 300) { // 5 minutes
                        try {
                            token = await this.refreshToken();
                        } catch (refreshError) {
                            console.warn('Auto-refresh failed:', refreshError.message);
                            // Continue with current token, let API handle expiration
                        }
                    }

                    // Make request with validated token
                    const response = await fetch(`${this.apiBaseURL}${endpoint}`, {
                        ...options,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`,
                            ...options.headers
                        }
                    });

                    // Handle authentication errors
                    if (response.status === 401) {
                        console.warn('üîí API returned 401, attempting token refresh');
                        
                        try {
                            const newToken = await this.refreshToken();
                            
                            // Retry request with new token
                            const retryResponse = await fetch(`${this.apiBaseURL}${endpoint}`, {
                                ...options,
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${newToken}`,
                                    ...options.headers
                                }
                            });

                            if (!retryResponse.ok) {
                                throw new Error(`API error after refresh: ${retryResponse.status}`);
                            }

                            return await retryResponse.json();
                        } catch (refreshError) {
                            this.handleTokenExpired();
                            throw new Error('Session expired, please login again');
                        }
                    }

                    if (!response.ok) {
                        throw new Error(`API error: ${response.status} ${response.statusText}`);
                    }

                    return await response.json();

                } catch (error) {
                    console.error('üîí Authenticated request failed:', error.message);
                    throw error;
                }
            }

            setupValidators() {
                // Email validation
                const emailInputs = document.querySelectorAll('input[type="email"]');
                emailInputs.forEach(input => {
                    if (input.id === 'registerEmail') {
                        input.addEventListener('blur', () => this.validateEmailAdvanced(input));
                    } else {
                        input.addEventListener('blur', () => this.validateEmail(input));
                    }
                });

                // Name validation
                const nameInputs = document.querySelectorAll('input[type="text"]');
                nameInputs.forEach(input => {
                    if (input.id.includes('Name') || input.id.includes('name')) {
                        input.addEventListener('blur', () => this.validateName(input));
                    }
                });

                // Password validation
                const passwordInputs = document.querySelectorAll('input[type="password"]');
                passwordInputs.forEach(input => {
                    input.addEventListener('blur', () => this.validatePassword(input));
                    
                    // Add real-time password strength validation for registration
                    if (input.id === 'registerPassword') {
                        input.addEventListener('input', () => this.checkPasswordStrength(input.value));
                        input.addEventListener('focus', () => this.showPasswordStrengthValidator());
                    }
                });
            }

            validateEmail(input) {
                const email = input.value.trim();
                const errorElement = document.getElementById(input.id + 'Error');
                
                if (!email) {
                    this.showError(errorElement, 'Email es requerido');
                    return false;
                }
                
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    this.showError(errorElement, 'Email no v√°lido');
                    return false;
                }
                
                this.hideError(errorElement);
                return true;
            }

            // ===== USER PROFILE VALIDATION =====

            // Enhanced name validation
            validateName(input) {
                const name = input.value.trim();
                const errorElement = document.getElementById(input.id + 'Error');
                
                if (!name) {
                    this.showError(errorElement, 'Nombre es requerido');
                    return false;
                }
                
                // Check minimum length
                if (name.length < 2) {
                    this.showError(errorElement, 'Nombre debe tener al menos 2 caracteres');
                    return false;
                }
                
                // Check maximum length
                if (name.length > 100) {
                    this.showError(errorElement, 'Nombre muy largo (m√°ximo 100 caracteres)');
                    return false;
                }
                
                // Check for valid characters (letters, spaces, hyphens, apostrophes, accents)
                const nameRegex = /^[a-zA-Z√Ä-√øƒÅƒçƒìƒ´≈ç≈´≈°≈æ≈†≈Ω\s\-']+$/;
                if (!nameRegex.test(name)) {
                    this.showError(errorElement, 'Nombre contiene caracteres no v√°lidos');
                    return false;
                }
                
                // Check for reasonable word count (not too many consecutive spaces)
                const words = name.split(/\s+/).filter(word => word.length > 0);
                if (words.length < 1) {
                    this.showError(errorElement, 'Ingresa un nombre v√°lido');
                    return false;
                }
                
                if (words.length > 10) {
                    this.showError(errorElement, 'Nombre muy extenso (m√°ximo 10 palabras)');
                    return false;
                }
                
                // Check for suspicious patterns
                const suspiciousPatterns = [
                    /^[aeiou]+$/i,  // Only vowels
                    /^[bcdfghjklmnpqrstvwxyz]+$/i, // Only consonants
                    /(.)\1{4,}/, // 5+ repeated characters
                    /^(test|demo|admin|user|guest|null|undefined)$/i, // Common test names
                    /^\d+$/, // Only numbers
                ];
                
                const hasSuspiciousPattern = suspiciousPatterns.some(pattern => pattern.test(name));
                if (hasSuspiciousPattern) {
                    this.showError(errorElement, 'Ingresa tu nombre real');
                    return false;
                }
                
                this.hideError(errorElement);
                return true;
            }

            // Enhanced email validation  
            validateEmailAdvanced(input) {
                const email = input.value.trim().toLowerCase();
                const errorElement = document.getElementById(input.id + 'Error');
                
                // Basic validation first
                if (!this.validateEmail(input)) {
                    return false;
                }
                
                // Advanced email validation
                const emailParts = email.split('@');
                const localPart = emailParts[0];
                const domainPart = emailParts[1];
                
                // Check for consecutive dots
                if (localPart.includes('..')) {
                    this.showError(errorElement, 'Email contiene puntos consecutivos');
                    return false;
                }
                
                // Check for common typos in popular domains
                const commonDomains = {
                    'gmai.com': 'gmail.com',
                    'gmial.com': 'gmail.com',
                    'yahooo.com': 'yahoo.com',
                    'hotmai.com': 'hotmail.com',
                    'outlok.com': 'outlook.com'
                };
                
                if (commonDomains[domainPart]) {
                    this.showError(errorElement, `¬øQuisiste decir ${commonDomains[domainPart]}?`);
                    return false;
                }
                
                // Check for disposable email providers (basic list)
                const disposableProviders = [
                    '10minutemail.com',
                    'tempmail.org',
                    'guerrillamail.com',
                    'throwaway.email',
                    'mailinator.com'
                ];
                
                if (disposableProviders.includes(domainPart)) {
                    this.showError(errorElement, 'No se permiten emails temporales');
                    return false;
                }
                
                this.hideError(errorElement);
                return true;
            }

            // Comprehensive form validation
            validateRegistrationForm(formData) {
                const validationResults = {
                    isValid: true,
                    errors: [],
                    warnings: [],
                    sanitizedData: {}
                };

                // Name validation
                const nameInput = document.getElementById('registerName');
                if (nameInput) {
                    const nameValid = this.validateName(nameInput);
                    if (!nameValid) {
                        validationResults.isValid = false;
                        validationResults.errors.push('Nombre no v√°lido');
                    } else {
                        validationResults.sanitizedData.name = this.sanitizeInput(formData.name, 'name');
                        
                        // Additional name quality checks
                        const nameWords = validationResults.sanitizedData.name.split(' ').filter(w => w.length > 0);
                        if (nameWords.length === 1) {
                            validationResults.warnings.push('Considera agregar tu apellido');
                        }
                    }
                }

                // Email validation
                const emailInput = document.getElementById('registerEmail');
                if (emailInput) {
                    const emailValid = this.validateEmailAdvanced(emailInput);
                    if (!emailValid) {
                        validationResults.isValid = false;
                        validationResults.errors.push('Email no v√°lido');
                    } else {
                        validationResults.sanitizedData.email = this.sanitizeInput(formData.email, 'email');
                    }
                }

                // Password validation
                const passwordInput = document.getElementById('registerPassword');
                if (passwordInput) {
                    const passwordValid = this.validatePassword(passwordInput);
                    if (!passwordValid) {
                        validationResults.isValid = false;
                        validationResults.errors.push('Contrase√±a no v√°lida');
                    } else {
                        validationResults.sanitizedData.password = formData.password;
                        
                        // Password quality warnings
                        const strength = this.getPasswordStrength(formData.password);
                        if (strength.score < 4) {
                            validationResults.warnings.push('Considera usar una contrase√±a m√°s fuerte');
                        }
                    }
                }

                // Log validation results
                this.logSecurityEvent('registration_validation', {
                    is_valid: validationResults.isValid,
                    error_count: validationResults.errors.length,
                    warning_count: validationResults.warnings.length
                });

                return validationResults;
            }

            // Show validation warnings to user
            showValidationWarnings(warnings) {
                if (warnings.length === 0) return;

                const warningContainer = document.createElement('div');
                warningContainer.className = 'validation-warnings';
                warningContainer.style.cssText = `
                    background: rgba(251, 191, 36, 0.1);
                    border: 1px solid rgba(251, 191, 36, 0.2);
                    border-radius: 8px;
                    padding: 12px;
                    margin: 16px 0;
                    font-size: 12px;
                    color: #f59e0b;
                `;

                warningContainer.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Sugerencias</strong>
                    </div>
                    <ul style="margin: 0; padding-left: 16px;">
                        ${warnings.map(warning => `<li>${warning}</li>`).join('')}
                    </ul>
                `;

                const lastInputGroup = document.querySelector('#registerForm .input-group:last-of-type');
                if (lastInputGroup) {
                    lastInputGroup.parentNode.insertBefore(warningContainer, lastInputGroup.nextSibling);
                    setTimeout(() => warningContainer.remove(), 8000);
                }
            }

            validatePassword(input) {
                const password = input.value;
                const errorElement = document.getElementById(input.id + 'Error');
                
                if (!password) {
                    this.showError(errorElement, 'Contrase√±a es requerida');
                    return false;
                }
                
                // Enhanced password validation for registration
                if (input.id === 'registerPassword') {
                    const strength = this.getPasswordStrength(password);
                    if (strength.score < 3) {
                        this.showError(errorElement, 'Contrase√±a muy d√©bil. Debe cumplir m√°s requisitos de seguridad.');
                        return false;
                    }
                } else {
                    // Basic validation for login
                    if (password.length < 6) {
                        this.showError(errorElement, 'M√≠nimo 6 caracteres');
                        return false;
                    }
                }
                
                this.hideError(errorElement);
                return true;
            }

            // Show password strength validator UI
            showPasswordStrengthValidator() {
                const container = document.getElementById('passwordStrengthContainer');
                if (container) {
                    container.classList.add('active');
                }
            }

            // Hide password strength validator UI  
            hidePasswordStrengthValidator() {
                const container = document.getElementById('passwordStrengthContainer');
                if (container) {
                    container.classList.remove('active');
                }
            }

            // Real-time password strength checking
            checkPasswordStrength(password) {
                const strength = this.getPasswordStrength(password);
                this.updatePasswordStrengthUI(strength);
            }

            // Calculate password strength score
            getPasswordStrength(password) {
                let score = 0;
                const requirements = {
                    length: password.length >= 8,
                    uppercase: /[A-Z]/.test(password),
                    lowercase: /[a-z]/.test(password),
                    number: /\d/.test(password),
                    special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)
                };

                // Base scoring
                if (requirements.length) score += 1;
                if (requirements.uppercase) score += 1;
                if (requirements.lowercase) score += 1;
                if (requirements.number) score += 1;
                if (requirements.special) score += 1;

                // Bonus points for longer passwords
                if (password.length >= 12) score += 0.5;
                if (password.length >= 16) score += 0.5;

                // Penalty for common patterns
                if (/(.)\1{2,}/.test(password)) score -= 0.5; // Repeated characters
                if (/123456|654321|qwerty|password|admin/.test(password.toLowerCase())) score -= 1; // Common patterns

                const strengthLevels = [
                    { min: 0, max: 1, label: 'Muy D√©bil', class: 'weak' },
                    { min: 1, max: 2, label: 'D√©bil', class: 'weak' },
                    { min: 2, max: 3, label: 'Regular', class: 'fair' },
                    { min: 3, max: 4, label: 'Buena', class: 'good' },
                    { min: 4, max: 6, label: 'Muy Fuerte', class: 'strong' }
                ];

                const level = strengthLevels.find(l => score >= l.min && score < l.max) || strengthLevels[4];

                return {
                    score,
                    requirements,
                    level: level.label,
                    class: level.class,
                    isStrong: score >= 3
                };
            }

            // Update password strength UI
            updatePasswordStrengthUI(strength) {
                const strengthBar = document.getElementById('strengthBar');
                const strengthLabel = document.getElementById('strengthLabel');
                
                // Update strength bar
                if (strengthBar) {
                    strengthBar.className = `password-strength-bar ${strength.class}`;
                }

                // Update strength label
                if (strengthLabel) {
                    strengthLabel.textContent = strength.level;
                    strengthLabel.className = `password-strength-label strength-${strength.class}`;
                }

                // Update individual requirements
                const requirements = [
                    { id: 'req-length', met: strength.requirements.length },
                    { id: 'req-uppercase', met: strength.requirements.uppercase },
                    { id: 'req-lowercase', met: strength.requirements.lowercase },
                    { id: 'req-number', met: strength.requirements.number },
                    { id: 'req-special', met: strength.requirements.special }
                ];

                requirements.forEach(req => {
                    const element = document.getElementById(req.id);
                    if (element) {
                        if (req.met) {
                            element.classList.add('met');
                        } else {
                            element.classList.remove('met');
                        }
                    }
                });

                // Log password strength for security monitoring
                console.log('üîí Password strength:', {
                    score: strength.score,
                    level: strength.level,
                    isStrong: strength.isStrong,
                    requirements: strength.requirements
                });
            }

            // ===== INPUT SANITIZATION & SECURITY =====
            
            // Comprehensive input sanitization
            sanitizeInput(input, type = 'text') {
                if (!input || typeof input !== 'string') {
                    return '';
                }

                let sanitized = input;

                // Remove potential XSS vectors
                sanitized = this.removeXSSVectors(sanitized);
                
                // Apply type-specific sanitization
                switch (type) {
                    case 'email':
                        sanitized = this.sanitizeEmail(sanitized);
                        break;
                    case 'name':
                        sanitized = this.sanitizeName(sanitized);
                        break;
                    case 'password':
                        // Passwords are not sanitized, only validated
                        return input;
                    case 'text':
                    default:
                        sanitized = this.sanitizeText(sanitized);
                        break;
                }

                // Log sanitization for security monitoring
                if (input !== sanitized) {
                    console.warn('üõ°Ô∏è Input sanitized:', {
                        original_length: input.length,
                        sanitized_length: sanitized.length,
                        type: type,
                        timestamp: new Date().toISOString()
                    });
                    
                    // Store sanitization events for security analysis
                    this.logSecurityEvent('input_sanitization', {
                        input_type: type,
                        original_length: input.length,
                        sanitized_length: sanitized.length,
                        suspicious_patterns_removed: input.length - sanitized.length > 0
                    });
                }

                return sanitized;
            }

            // Remove XSS vectors
            removeXSSVectors(input) {
                // HTML entity encoding for dangerous characters
                let sanitized = input
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#x27;')
                    .replace(/\//g, '&#x2F;');

                // Remove dangerous JavaScript protocols
                sanitized = sanitized.replace(/javascript:/gi, '');
                sanitized = sanitized.replace(/vbscript:/gi, '');
                sanitized = sanitized.replace(/data:/gi, '');

                // Remove script tags and content
                sanitized = sanitized.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
                
                // Remove dangerous event handlers
                sanitized = sanitized.replace(/on\w+\s*=\s*["'][^"']*["']/gi, '');
                
                // Remove SQL injection patterns (basic)
                sanitized = sanitized.replace(/(\b(SELECT|INSERT|UPDATE|DELETE|DROP|CREATE|ALTER|EXEC|UNION)\b)/gi, '');

                return sanitized;
            }

            // Sanitize email input
            sanitizeEmail(email) {
                let sanitized = email.toLowerCase().trim();
                
                // Remove dangerous characters from email (but keep @ symbol)
                sanitized = sanitized.replace(/[<>()[\]\\,;:\s"]/g, '');
                
                // Only allow valid email characters (including @ symbol)
                sanitized = sanitized.replace(/[^a-z0-9@._+-]/g, '');
                
                // Validate email structure
                const emailRegex = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/;
                if (!emailRegex.test(sanitized)) {
                    console.warn('üõ°Ô∏è Invalid email format detected and cleaned');
                }

                return sanitized;
            }

            // Sanitize name input
            sanitizeName(name) {
                let sanitized = name.trim();
                
                // Remove HTML and script content
                sanitized = this.removeXSSVectors(sanitized);
                
                // Only allow letters, spaces, hyphens, and apostrophes for names
                sanitized = sanitized.replace(/[^a-zA-Z√Ä-√øƒÅƒçƒìƒ´≈ç≈´≈°≈æ≈†≈Ω\s\-']/g, '');
                
                // Remove excessive spaces and normalize
                sanitized = sanitized.replace(/\s+/g, ' ');
                
                // Limit name length
                if (sanitized.length > 100) {
                    sanitized = sanitized.substring(0, 100);
                    console.warn('üõ°Ô∏è Name input truncated to 100 characters');
                }

                return sanitized;
            }

            // Sanitize general text input
            sanitizeText(text) {
                let sanitized = text.trim();
                
                // Remove XSS vectors
                sanitized = this.removeXSSVectors(sanitized);
                
                // Remove control characters
                sanitized = sanitized.replace(/[\x00-\x1F\x7F-\x9F]/g, '');
                
                // Limit text length
                if (sanitized.length > 1000) {
                    sanitized = sanitized.substring(0, 1000);
                    console.warn('üõ°Ô∏è Text input truncated to 1000 characters');
                }

                return sanitized;
            }

            // Validate and sanitize form data
            sanitizeFormData(formData) {
                const sanitizedData = {};

                for (const [key, value] of Object.entries(formData)) {
                    let sanitizedValue;
                    
                    switch (key) {
                        case 'email':
                        case 'loginEmail':
                        case 'registerEmail':
                            sanitizedValue = this.sanitizeInput(value, 'email');
                            break;
                        case 'name':
                        case 'registerName':
                            sanitizedValue = this.sanitizeInput(value, 'name');
                            break;
                        case 'password':
                        case 'loginPassword':
                        case 'registerPassword':
                            // Passwords should not be sanitized, only validated
                            sanitizedValue = value;
                            break;
                        default:
                            sanitizedValue = this.sanitizeInput(value, 'text');
                            break;
                    }

                    sanitizedData[key] = sanitizedValue;
                }

                // Log sanitization summary
                console.log('üõ°Ô∏è Form data sanitized:', {
                    fields_processed: Object.keys(sanitizedData).length,
                    timestamp: new Date().toISOString()
                });

                return sanitizedData;
            }

            // Security event logging
            logSecurityEvent(eventType, details) {
                const securityLog = {
                    timestamp: new Date().toISOString(),
                    event_type: eventType,
                    details: details,
                    user_agent: navigator.userAgent,
                    page_url: window.location.href,
                    session_id: sessionStorage.getItem('session_id') || 'anonymous'
                };

                // Store security events for analysis
                const securityLogs = JSON.parse(localStorage.getItem('latanda_security_logs') || '[]');
                securityLogs.push(securityLog);

                // Keep only last 100 security events
                if (securityLogs.length > 100) {
                    securityLogs.splice(0, securityLogs.length - 100);
                }

                localStorage.setItem('latanda_security_logs', JSON.stringify(securityLogs));

                // Log high-priority security events to console
                if (['input_sanitization', 'rate_limit_hit', 'suspicious_activity'].includes(eventType)) {
                    console.warn('üö® Security Event:', securityLog);
                }
            }

            // Real-time input sanitization for form fields
            setupInputSanitization() {
                const inputs = document.querySelectorAll('input[type="text"], input[type="email"], textarea');
                
                inputs.forEach(input => {
                    input.addEventListener('paste', (event) => {
                        // Sanitize pasted content
                        setTimeout(() => {
                            const inputType = input.type === 'email' ? 'email' : 
                                           input.id.includes('name') || input.id.includes('Name') ? 'name' : 'text';
                            
                            const sanitizedValue = this.sanitizeInput(input.value, inputType);
                            
                            if (input.value !== sanitizedValue) {
                                input.value = sanitizedValue;
                                this.showWarning(input, 'Contenido peligroso removido autom√°ticamente');
                            }
                        }, 10);
                    });
                    
                    input.addEventListener('blur', (event) => {
                        // Sanitize on blur
                        const inputType = input.type === 'email' ? 'email' : 
                                       input.id.includes('name') || input.id.includes('Name') ? 'name' : 'text';
                        
                        const sanitizedValue = this.sanitizeInput(input.value, inputType);
                        
                        if (input.value !== sanitizedValue) {
                            input.value = sanitizedValue;
                            this.showWarning(input, 'Entrada corregida por seguridad');
                        }
                    });
                });
            }

            // Show security warning to user
            showWarning(inputElement, message) {
                const existingWarning = inputElement.parentNode.querySelector('.security-warning');
                if (existingWarning) {
                    existingWarning.remove();
                }

                const warningDiv = document.createElement('div');
                warningDiv.className = 'security-warning';
                warningDiv.style.cssText = `
                    color: #f97316;
                    font-size: 11px;
                    margin-top: 4px;
                    padding: 4px 8px;
                    background: rgba(249, 115, 22, 0.1);
                    border: 1px solid rgba(249, 115, 22, 0.2);
                    border-radius: 4px;
                    animation: fadeInOut 3s ease-in-out;
                `;
                warningDiv.textContent = message;

                inputElement.parentNode.appendChild(warningDiv);

                // Auto-remove warning after 3 seconds
                setTimeout(() => {
                    if (warningDiv.parentNode) {
                        warningDiv.remove();
                    }
                }, 3000);
            }

            // ===== RATE LIMITING & BRUTE FORCE PROTECTION =====
            
            // Get login attempts from storage
            getLoginAttempts() {
                const attempts = localStorage.getItem('latanda_login_attempts');
                if (!attempts) {
                    return [];
                }
                
                try {
                    const parsedAttempts = JSON.parse(attempts);
                    // Clean old attempts outside the window
                    const now = Date.now();
                    const validAttempts = parsedAttempts.filter(
                        attempt => (now - attempt.timestamp) < this.rateLimitConfig.windowMs
                    );
                    
                    // Update storage with clean data
                    if (validAttempts.length !== parsedAttempts.length) {
                        this.saveLoginAttempts(validAttempts);
                    }
                    
                    return validAttempts;
                } catch (error) {
                    console.warn('Error parsing login attempts, resetting:', error);
                    localStorage.removeItem('latanda_login_attempts');
                    return [];
                }
            }
            
            // Save login attempts to storage
            saveLoginAttempts(attempts) {
                localStorage.setItem('latanda_login_attempts', JSON.stringify(attempts));
            }
            
            // Check if rate limit is exceeded
            isRateLimited() {
                const now = Date.now();
                this.loginAttempts = this.getLoginAttempts();
                
                // Check for active lockout
                const lockoutUntil = localStorage.getItem('latanda_lockout_until');
                if (lockoutUntil && now < parseInt(lockoutUntil)) {
                    const remainingMs = parseInt(lockoutUntil) - now;
                    return {
                        limited: true,
                        type: 'lockout',
                        remainingMs: remainingMs,
                        message: `Cuenta bloqueada. Intenta en ${Math.ceil(remainingMs / 1000 / 60)} minutos.`
                    };
                }
                
                // Count recent failed attempts
                const recentAttempts = this.loginAttempts.filter(
                    attempt => attempt.success === false && (now - attempt.timestamp) < this.rateLimitConfig.windowMs
                );
                
                if (recentAttempts.length >= this.rateLimitConfig.maxAttempts) {
                    // Trigger lockout
                    const lockoutUntil = now + this.rateLimitConfig.lockoutDurationMs;
                    localStorage.setItem('latanda_lockout_until', lockoutUntil.toString());
                    
                    this.logSecurityEvent('rate_limit_lockout', {
                        failed_attempts: recentAttempts.length,
                        lockout_duration_minutes: this.rateLimitConfig.lockoutDurationMs / 1000 / 60,
                        ip_address: this.getClientIP()
                    });
                    
                    return {
                        limited: true,
                        type: 'lockout',
                        remainingMs: this.rateLimitConfig.lockoutDurationMs,
                        message: `Demasiados intentos fallidos. Cuenta bloqueada por ${this.rateLimitConfig.lockoutDurationMs / 1000 / 60} minutos.`
                    };
                }
                
                // Progressive delay based on recent failures
                if (recentAttempts.length > 0) {
                    const delayIndex = Math.min(recentAttempts.length - 1, this.rateLimitConfig.progressiveDelayMs.length - 1);
                    const delay = this.rateLimitConfig.progressiveDelayMs[delayIndex];
                    
                    const lastAttempt = recentAttempts[recentAttempts.length - 1];
                    const timeSinceLastAttempt = now - lastAttempt.timestamp;
                    
                    if (timeSinceLastAttempt < delay) {
                        const remainingMs = delay - timeSinceLastAttempt;
                        return {
                            limited: true,
                            type: 'delay',
                            remainingMs: remainingMs,
                            attemptNumber: recentAttempts.length + 1,
                            maxAttempts: this.rateLimitConfig.maxAttempts,
                            message: `Espera ${Math.ceil(remainingMs / 1000)} segundos antes de intentar de nuevo. (Intento ${recentAttempts.length + 1}/${this.rateLimitConfig.maxAttempts})`
                        };
                    }
                }
                
                return {
                    limited: false,
                    remainingAttempts: this.rateLimitConfig.maxAttempts - recentAttempts.length
                };
            }
            
            // Record login attempt
            recordLoginAttempt(success, email = null) {
                const attempt = {
                    timestamp: Date.now(),
                    success: success,
                    email: email,
                    ip_address: this.getClientIP(),
                    user_agent: navigator.userAgent
                };
                
                this.loginAttempts.push(attempt);
                this.saveLoginAttempts(this.loginAttempts);
                
                // Log security event for failed attempts
                if (!success) {
                    this.logSecurityEvent('failed_login_attempt', {
                        email: email,
                        attempt_number: this.loginAttempts.filter(a => !a.success).length,
                        ip_address: attempt.ip_address
                    });
                } else {
                    // Clear lockout on successful login
                    localStorage.removeItem('latanda_lockout_until');
                    
                    this.logSecurityEvent('successful_login', {
                        email: email,
                        previous_failed_attempts: this.loginAttempts.filter(a => !a.success).length
                    });
                }
            }
            
            // Get client IP (limited in browser, but we can try)
            getClientIP() {
                // This is a placeholder - in production, the server would track IPs
                return 'client-' + Math.random().toString(36).substr(2, 9);
            }
            
            // Show rate limit warning UI
            showRateLimitWarning(rateLimitInfo) {
                const existingWarning = document.querySelector('.rate-limit-warning');
                if (existingWarning) {
                    existingWarning.remove();
                }
                
                const warningDiv = document.createElement('div');
                warningDiv.className = 'rate-limit-warning';
                warningDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, rgba(239, 68, 68, 0.95), rgba(220, 38, 38, 0.95));
                    color: white;
                    padding: 16px 20px;
                    border-radius: 12px;
                    border: 1px solid rgba(239, 68, 68, 0.3);
                    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
                    backdrop-filter: blur(10px);
                    z-index: 10000;
                    max-width: 320px;
                    animation: slideInRight 0.3s ease-out;
                    font-size: 14px;
                `;
                
                const warningContent = rateLimitInfo.type === 'lockout' ? 
                    `<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <i class="fas fa-shield-alt"></i>
                        <strong>Cuenta Protegida</strong>
                    </div>
                    <div>${rateLimitInfo.message}</div>
                    <div style="margin-top: 8px; font-size: 12px; opacity: 0.9;">
                        Por tu seguridad, hemos bloqueado temporalmente los intentos de acceso.
                    </div>` :
                    `<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <i class="fas fa-clock"></i>
                        <strong>L√≠mite de Intentos</strong>
                    </div>
                    <div>${rateLimitInfo.message}</div>`;
                
                warningDiv.innerHTML = warningContent;
                document.body.appendChild(warningDiv);
                
                // Auto-remove warning
                const duration = rateLimitInfo.type === 'lockout' ? 10000 : 5000;
                setTimeout(() => {
                    if (warningDiv.parentNode) {
                        warningDiv.style.animation = 'slideOutRight 0.3s ease-in';
                        setTimeout(() => warningDiv.remove(), 300);
                    }
                }, duration);
                
                // Update submit button state
                this.updateSubmitButtonForRateLimit(rateLimitInfo);
            }
            
            // Update submit button during rate limiting
            updateSubmitButtonForRateLimit(rateLimitInfo) {
                const submitBtn = document.getElementById('loginSubmitBtn');
                if (!submitBtn) return;
                
                if (rateLimitInfo.limited) {
                    submitBtn.disabled = true;
                    submitBtn.style.opacity = '0.5';
                    submitBtn.style.cursor = 'not-allowed';
                    
                    if (rateLimitInfo.type === 'delay') {
                        // Countdown timer for delay
                        const countdown = Math.ceil(rateLimitInfo.remainingMs / 1000);
                        submitBtn.textContent = `Esperar ${countdown}s`;
                        
                        const countdownInterval = setInterval(() => {
                            const remaining = Math.ceil((rateLimitInfo.remainingMs - (Date.now() - (Date.now() - rateLimitInfo.remainingMs))) / 1000);
                            if (remaining <= 0) {
                                clearInterval(countdownInterval);
                                submitBtn.disabled = false;
                                submitBtn.style.opacity = '1';
                                submitBtn.style.cursor = 'pointer';
                                submitBtn.textContent = 'Iniciar Sesi√≥n';
                            } else {
                                submitBtn.textContent = `Esperar ${remaining}s`;
                            }
                        }, 1000);
                    } else {
                        submitBtn.textContent = 'Cuenta Bloqueada';
                    }
                } else {
                    submitBtn.disabled = false;
                    submitBtn.style.opacity = '1';
                    submitBtn.style.cursor = 'pointer';
                    submitBtn.textContent = 'Iniciar Sesi√≥n';
                }
            }

            showError(element, message) {
                if (element) {
                    element.textContent = message;
                    element.style.display = 'block';
                }
            }

            hideError(element) {
                if (element) {
                    element.style.display = 'none';
                }
            }

            async handleLogin(formData) {
                // Sanitize form data first (outside try block for error handler access)
                const sanitizedData = this.sanitizeFormData(formData);
                
                try {
                    this.setLoading(true);
                    
                    // Check rate limiting before attempting login
                    const rateLimitCheck = this.isRateLimited();
                    if (rateLimitCheck.limited) {
                        this.showRateLimitWarning(rateLimitCheck);
                        return;
                    }
                    
                    // Use API proxy for reliable connection, with fallback to direct API
                    let data;
                    try {
                        data = await window.apiProxy.makeRequest('/auth/login', {
                            method: 'POST',
                            body: JSON.stringify(sanitizedData)
                        });
                    } catch (proxyError) {
                        console.warn('API proxy failed, using direct API:', proxyError.message);
                        
                        // Fallback to direct API call
                        const response = await fetch(`${this.apiBaseURL}/auth/login`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(sanitizedData)
                        });
                        
                        if (response.ok) {
                            data = await response.json();
                        } else {
                            throw new Error(`API error: ${response.status} ${response.statusText}`);
                        }
                    }

                    if (data.success && data.data.auth_token) {
                        const token = data.data.auth_token;
                        
                        // Enhanced JWT validation before storing
                        if (!this.isValidToken(token)) {
                            throw new Error('Servidor retorn√≥ token inv√°lido');
                        }

                        // Decode token to get user info
                        const tokenData = this.decodeToken(token);
                        if (!tokenData) {
                            throw new Error('No se pudo procesar la respuesta de autenticaci√≥n');
                        }

                        // Validate token payload has required user data
                        if (!tokenData.payload.user_id) {
                            console.warn('Token missing user_id, using fallback user data');
                        }

                        // Store validated token and user data
                        localStorage.setItem('latanda_auth_token', token);
                        
                        // Merge API user data with token data for comprehensive user object
                        const userData = {
                            ...data.data.user,
                            id: tokenData.payload.user_id || data.data.user.id,
                            role: tokenData.payload.role || data.data.user.role,
                            email: tokenData.payload.email || data.data.user.email,
                            tokenExpiresAt: tokenData.expiresAt,
                            tokenIssuedAt: tokenData.issuedAt,
                            permissions: data.data.user.permissions || []
                        };

                        localStorage.setItem('latanda_user', JSON.stringify(userData));
                        
                        // Show success message with token info
                        this.showSuccess(
                            data.data.message || 
                            `¬°Bienvenido! Sesi√≥n v√°lida hasta ${tokenData.expiresAt.toLocaleString()}`
                        );
                        
                        // Enhanced logging with token validation info
                        console.log('üîê Login exitoso con JWT validado:', {
                            user_id: userData.id,
                            role: userData.role,
                            email: userData.email,
                            permissions: userData.permissions,
                            token_expires: tokenData.expiresAt,
                            token_valid_for: `${Math.floor(tokenData.timeToExpiry / 60)} minutos`
                        });

                        // Record successful login attempt
                        this.recordLoginAttempt(true, sanitizedData.email);
                        
                        // Setup automatic token refresh if needed
                        this.scheduleTokenRefresh(tokenData.timeToExpiry);
                        
                        setTimeout(() => this.redirectToSystem(), 1500);
                        
                    } else {
                        throw new Error(data.error?.message || 'Credenciales inv√°lidas');
                    }
                } catch (error) {
                    console.error('üîí Login error:', error);
                    
                    // Record failed login attempt
                    this.recordLoginAttempt(false, sanitizedData?.email || formData?.email);
                    
                    // Clear any potentially invalid tokens
                    if (error.message.includes('token') || error.message.includes('Token')) {
                        localStorage.removeItem('latanda_auth_token');
                        localStorage.removeItem('latanda_user');
                    }
                    
                    // Check if we need to show rate limit warning
                    const rateLimitCheck = this.isRateLimited();
                    if (rateLimitCheck.limited) {
                        this.showRateLimitWarning(rateLimitCheck);
                    } else {
                        this.showError(
                            document.getElementById('loginEmailError'), 
                            error.message || 'Error de conexi√≥n. Verifica tus credenciales.'
                        );
                    }
                } finally {
                    this.setLoading(false);
                }
            }

            // Schedule automatic token refresh
            scheduleTokenRefresh(timeToExpiry) {
                // Clear any existing refresh timer
                if (this.refreshTimer) {
                    clearTimeout(this.refreshTimer);
                }

                // Schedule refresh 5 minutes before expiration
                const refreshIn = Math.max(0, (timeToExpiry - 300) * 1000); // 5 minutes before expiry
                
                if (refreshIn > 0) {
                    console.log(`üîÑ Token refresh scheduled in ${Math.floor(refreshIn / 1000 / 60)} minutes`);
                    
                    this.refreshTimer = setTimeout(async () => {
                        try {
                            console.log('üîÑ Auto-refreshing token...');
                            await this.refreshToken();
                            
                            // Reschedule next refresh
                            const newToken = localStorage.getItem('latanda_auth_token');
                            if (newToken) {
                                const newTokenData = this.decodeToken(newToken);
                                if (newTokenData) {
                                    this.scheduleTokenRefresh(newTokenData.timeToExpiry);
                                }
                            }
                        } catch (refreshError) {
                            console.warn('üîí Scheduled token refresh failed:', refreshError.message);
                            // Don't force logout here, let user continue until token actually expires
                        }
                    }, refreshIn);
                }
            }

            async handleRegister(formData) {
                try {
                    this.setLoading(true);
                    
                    // Enhanced validation first
                    const validationResults = this.validateRegistrationForm(formData);
                    
                    if (!validationResults.isValid) {
                        console.warn('üîí Registration validation failed:', validationResults.errors);
                        return; // Errors already shown by individual validators
                    }
                    
                    // Show quality warnings if any
                    if (validationResults.warnings.length > 0) {
                        this.showValidationWarnings(validationResults.warnings);
                    }
                    
                    // Use validated and sanitized data
                    const sanitizedData = validationResults.sanitizedData;
                    
                    // Using real API
                    const response = await fetch(`${this.apiBaseURL}/auth/register`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(sanitizedData)
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.handleRegisterSuccess(data);
                    } else {
                        throw new Error('Error en el registro');
                    }
                } catch (error) {
                    console.error('Register error:', error);
                    this.showError(document.getElementById('registerError'), error.message || 'Error en el registro');
                } finally {
                    this.setLoading(false);
                }
            }

            handleLoginSuccess(data) {
                // API returns: { success: true, data: { auth_token, user, next_step } }
                const authData = data.data || data;
                localStorage.setItem('latanda_auth_token', authData.auth_token || authData.token);
                localStorage.setItem('latanda_user', JSON.stringify(authData.user));
                
                this.showSuccess('¬°Bienvenido de vuelta!');
                setTimeout(() => this.redirectToSystem(), 1500);
            }

            handleRegisterSuccess(data) {
                // API returns: { success: true, data: { auth_token, user, next_step } }
                const authData = data.data || data;
                localStorage.setItem('latanda_auth_token', authData.auth_token || authData.token);
                localStorage.setItem('latanda_user', JSON.stringify(authData.user));
                
                this.showSuccess('¬°Cuenta creada exitosamente!');
                setTimeout(() => this.redirectToSystem(), 1500);
            }

            handleDemoLogin(formData) {
                // Demo mode
                const demoToken = this.generateDemoToken(formData.email);
                const demoUser = {
                    id: 'demo-user',
                    email: formData.email,
                    name: 'Usuario Demo',
                    role: 'demo'
                };

                localStorage.setItem('latanda_auth_token', demoToken);
                localStorage.setItem('latanda_user', JSON.stringify(demoUser));
                
                this.showSuccess('¬°Acceso demo exitoso!');
                setTimeout(() => this.redirectToSystem(), 1500);
            }

            handleDemoRegister(formData) {
                // Demo mode
                const demoToken = this.generateDemoToken(formData.email);
                const demoUser = {
                    id: 'new-demo-user',
                    email: formData.email,
                    name: formData.name,
                    role: 'demo'
                };

                localStorage.setItem('latanda_auth_token', demoToken);
                localStorage.setItem('latanda_user', JSON.stringify(demoUser));
                
                this.showSuccess('¬°Registro demo exitoso!');
                setTimeout(() => this.redirectToSystem(), 1500);
            }

            generateDemoToken(email) {
                const header = btoa(JSON.stringify({ alg: 'HS256', typ: 'JWT' }));
                const payload = btoa(JSON.stringify({
                    email: email,
                    exp: Math.floor(Date.now() / 1000) + (24 * 60 * 60), // 24 hours
                    iat: Math.floor(Date.now() / 1000),
                    demo: true
                }));
                return `${header}.${payload}.demo-signature`;
            }

            async simulateAPICall() {
                return new Promise(resolve => setTimeout(resolve, 1000));
            }

            setLoading(loading) {
                this.isLoading = loading;
                const submitBtns = document.querySelectorAll('.submit-btn');
                submitBtns.forEach(btn => {
                    if (loading) {
                        btn.classList.add('loading');
                        btn.textContent = 'Procesando...';
                        btn.disabled = true;
                    } else {
                        btn.classList.remove('loading');
                        btn.textContent = btn.id.includes('login') ? 'Iniciar Sesi√≥n' : 'Crear Cuenta';
                        btn.disabled = false;
                    }
                });
            }

            showSuccess(message) {
                // Create temporary success message
                const successDiv = document.createElement('div');
                successDiv.className = 'success-message';
                successDiv.style.display = 'block';
                successDiv.style.textAlign = 'center';
                successDiv.style.marginTop = '16px';
                successDiv.style.padding = '12px';
                successDiv.style.background = 'rgba(78, 205, 196, 0.1)';
                successDiv.style.border = '1px solid var(--success-color)';
                successDiv.style.borderRadius = '8px';
                successDiv.textContent = message;
                
                const activeForm = document.querySelector('.form-section.active');
                activeForm.appendChild(successDiv);
                
                setTimeout(() => successDiv.remove(), 3000);
            }

            redirectToSystem() {
                // Always redirect to standalone home dashboard, regardless of iframe context
                window.top.location.href = '/home-dashboard.html';
            }

            // Social login handlers
            async loginWithProvider(provider) {
                console.log(`Iniciando login con ${provider}`);
                this.showSuccess(`Redirigiendo a ${provider}...`);
                
                // Simulate social login
                setTimeout(() => {
                    const socialUser = {
                        id: `${provider}-user`,
                        email: `user@${provider}.com`,
                        name: `Usuario ${provider}`,
                        provider: provider
                    };
                    
                    const token = this.generateDemoToken(socialUser.email);
                    localStorage.setItem('latanda_auth_token', token);
                    localStorage.setItem('latanda_user', JSON.stringify(socialUser));
                    
                    this.redirectToSystem();
                }, 2000);
            }

            async registerWithProvider(provider) {
                console.log(`Iniciando registro con ${provider}`);
                this.loginWithProvider(provider); // Same flow for demo
            }

            // Demo access methods
            demoAccess() {
                const demoCredentials = {
                    email: 'demo@latanda.online',
                    password: 'demo123'
                };
                
                document.getElementById('loginEmail').value = demoCredentials.email;
                document.getElementById('loginPassword').value = demoCredentials.password;
                
                this.handleDemoLogin(demoCredentials);
            }

            testDirectAccess() {
                const testUser = {
                    id: 'test-user',
                    email: 'test@latanda.online',
                    name: 'Usuario Test',
                    role: 'tester'
                };
                
                const token = this.generateDemoToken(testUser.email);
                localStorage.setItem('latanda_auth_token', token);
                localStorage.setItem('latanda_user', JSON.stringify(testUser));
                
                this.showSuccess('¬°Acceso directo de prueba!');
                setTimeout(() => this.redirectToSystem(), 1000);
            }

            // ===== PASSWORD RESET FUNCTIONALITY =====
            
            async forgotPassword() {
                // Create password reset modal
                this.showPasswordResetModal();
            }
            
            // Show password reset modal
            showPasswordResetModal() {
                // Remove existing modal if present
                const existingModal = document.getElementById('passwordResetModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // Create modal HTML
                const modalHTML = `
                    <div id="passwordResetModal" class="password-reset-modal">
                        <div class="password-reset-overlay" onclick="this.parentElement.remove()"></div>
                        <div class="password-reset-container">
                            <div class="password-reset-header">
                                <h3><i class="fas fa-key"></i> Restablecer Contrase√±a</h3>
                                <button class="close-btn" onclick="document.getElementById('passwordResetModal').remove()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <div class="password-reset-content">
                                <!-- Step 1: Email Input -->
                                <div class="reset-step active" id="resetStep1">
                                    <p class="reset-description">Ingresa tu email para recibir instrucciones de restablecimiento</p>
                                    
                                    <div class="input-group">
                                        <label class="input-label">Email</label>
                                        <div class="input-wrapper">
                                            <input 
                                                type="email" 
                                                id="resetEmail" 
                                                class="input-field" 
                                                placeholder="tu@email.com"
                                                required
                                            >
                                            <div class="input-icon">
                                                <i class="fas fa-envelope"></i>
                                            </div>
                                        </div>
                                        <div class="error-message" id="resetEmailError"></div>
                                    </div>
                                    
                                    <button class="submit-btn" onclick="authSystem.sendPasswordResetEmail()" id="sendResetBtn">
                                        <i class="fas fa-paper-plane"></i>
                                        Enviar Instrucciones
                                    </button>
                                </div>
                                
                                <!-- Step 2: Confirmation -->
                                <div class="reset-step" id="resetStep2">
                                    <div class="reset-success">
                                        <i class="fas fa-check-circle"></i>
                                        <h4>Instrucciones Enviadas</h4>
                                        <p>Hemos enviado las instrucciones de restablecimiento a <span id="resetEmailConfirm"></span></p>
                                        <p class="reset-note">Revisa tu bandeja de entrada y spam. El enlace expira en 24 horas.</p>
                                        
                                        <div class="reset-actions">
                                            <button class="btn-secondary" onclick="document.getElementById('passwordResetModal').remove()">
                                                Cerrar
                                            </button>
                                            <button class="btn-primary" onclick="authSystem.resendPasswordReset()" id="resendBtn">
                                                Reenviar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Step 3: Reset Code Input (for demo) -->
                                <div class="reset-step" id="resetStep3">
                                    <p class="reset-description">Ingresa el c√≥digo de restablecimiento que recibiste</p>
                                    
                                    <div class="input-group">
                                        <label class="input-label">C√≥digo de Verificaci√≥n</label>
                                        <div class="input-wrapper">
                                            <input 
                                                type="text" 
                                                id="resetCode" 
                                                class="input-field" 
                                                placeholder="Ej: ABC123"
                                                maxlength="6"
                                            >
                                            <div class="input-icon">
                                                <i class="fas fa-shield-alt"></i>
                                            </div>
                                        </div>
                                        <div class="error-message" id="resetCodeError"></div>
                                    </div>
                                    
                                    <div class="input-group">
                                        <label class="input-label">Nueva Contrase√±a</label>
                                        <div class="input-wrapper">
                                            <input 
                                                type="password" 
                                                id="newPassword" 
                                                class="input-field" 
                                                placeholder="Nueva contrase√±a segura"
                                            >
                                            <div class="input-icon password-toggle" onclick="togglePassword('newPassword')">
                                                <i class="fas fa-eye"></i>
                                            </div>
                                        </div>
                                        <div class="error-message" id="newPasswordError"></div>
                                        
                                        <!-- Password Strength for Reset -->
                                        <div class="password-strength-container" id="resetPasswordStrengthContainer">
                                            <div class="password-strength-header">
                                                <i class="fas fa-shield-alt"></i>
                                                <span>Fortaleza de Contrase√±a</span>
                                                <span class="password-strength-label" id="resetStrengthLabel">D√©bil</span>
                                            </div>
                                            
                                            <div class="password-strength-indicator">
                                                <div class="password-strength-bar" id="resetStrengthBar"></div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="input-group">
                                        <label class="input-label">Confirmar Nueva Contrase√±a</label>
                                        <div class="input-wrapper">
                                            <input 
                                                type="password" 
                                                id="confirmNewPassword" 
                                                class="input-field" 
                                                placeholder="Repetir nueva contrase√±a"
                                            >
                                            <div class="input-icon">
                                                <i class="fas fa-check"></i>
                                            </div>
                                        </div>
                                        <div class="error-message" id="confirmNewPasswordError"></div>
                                    </div>
                                    
                                    <button class="submit-btn" onclick="authSystem.resetPasswordWithCode()" id="resetPasswordBtn">
                                        <i class="fas fa-key"></i>
                                        Cambiar Contrase√±a
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add modal styles
                const modalStyles = `
                    <style id="passwordResetModalStyles">
                        .password-reset-modal {
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            z-index: 10000;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            animation: fadeIn 0.3s ease-out;
                        }
                        
                        .password-reset-overlay {
                            position: absolute;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(0, 0, 0, 0.7);
                            backdrop-filter: blur(5px);
                        }
                        
                        .password-reset-container {
                            background: var(--bg-glass);
                            backdrop-filter: blur(24px);
                            border-radius: 16px;
                            border: 1px solid var(--border-primary);
                            width: 90%;
                            max-width: 480px;
                            max-height: 80vh;
                            overflow-y: auto;
                            position: relative;
                            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
                            animation: slideUp 0.3s ease-out;
                        }
                        
                        .password-reset-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 20px;
                            border-bottom: 1px solid var(--border-primary);
                        }
                        
                        .password-reset-header h3 {
                            color: var(--text-primary);
                            font-size: 18px;
                            font-weight: 600;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                        }
                        
                        .close-btn {
                            background: none;
                            border: none;
                            color: var(--text-secondary);
                            cursor: pointer;
                            padding: 4px;
                            border-radius: 4px;
                            transition: all 0.3s ease;
                        }
                        
                        .close-btn:hover {
                            color: var(--text-primary);
                            background: rgba(255, 255, 255, 0.1);
                        }
                        
                        .password-reset-content {
                            padding: 20px;
                        }
                        
                        .reset-step {
                            display: none;
                        }
                        
                        .reset-step.active {
                            display: block;
                            animation: fadeIn 0.5s ease-out;
                        }
                        
                        .reset-description {
                            color: var(--text-secondary);
                            margin-bottom: 20px;
                            line-height: 1.5;
                        }
                        
                        .reset-success {
                            text-align: center;
                            padding: 20px;
                        }
                        
                        .reset-success i {
                            font-size: 48px;
                            color: var(--success-color);
                            margin-bottom: 16px;
                        }
                        
                        .reset-success h4 {
                            color: var(--text-primary);
                            font-size: 18px;
                            font-weight: 600;
                            margin-bottom: 12px;
                        }
                        
                        .reset-success p {
                            color: var(--text-secondary);
                            margin-bottom: 8px;
                            line-height: 1.5;
                        }
                        
                        .reset-note {
                            font-size: 12px;
                            opacity: 0.8;
                            margin-bottom: 20px !important;
                        }
                        
                        .reset-actions {
                            display: flex;
                            gap: 12px;
                            justify-content: center;
                        }
                        
                        .btn-secondary, .btn-primary {
                            padding: 10px 20px;
                            border-radius: 8px;
                            border: none;
                            font-weight: 500;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            font-size: 14px;
                        }
                        
                        .btn-secondary {
                            background: rgba(255, 255, 255, 0.1);
                            color: var(--text-secondary);
                            border: 1px solid rgba(255, 255, 255, 0.1);
                        }
                        
                        .btn-secondary:hover {
                            background: rgba(255, 255, 255, 0.15);
                            color: var(--text-primary);
                        }
                        
                        .btn-primary {
                            background: linear-gradient(135deg, var(--tanda-cyan), var(--tanda-cyan-light));
                            color: var(--tanda-black);
                        }
                        
                        .btn-primary:hover {
                            transform: translateY(-1px);
                            box-shadow: 0 4px 12px rgba(0, 255, 255, 0.3);
                        }
                        
                        @keyframes slideUp {
                            from {
                                opacity: 0;
                                transform: translateY(30px);
                            }
                            to {
                                opacity: 1;
                                transform: translateY(0);
                            }
                        }
                    </style>
                `;
                
                // Add styles and modal to page
                document.head.insertAdjacentHTML('beforeend', modalStyles);
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
                // Setup password strength validation for new password
                const newPasswordInput = document.getElementById('newPassword');
                if (newPasswordInput) {
                    newPasswordInput.addEventListener('input', () => {
                        const strength = this.getPasswordStrength(newPasswordInput.value);
                        this.updateResetPasswordStrengthUI(strength);
                    });
                    newPasswordInput.addEventListener('focus', () => {
                        document.getElementById('resetPasswordStrengthContainer').classList.add('active');
                    });
                }
            }
            
            // Update password strength UI for reset modal
            updateResetPasswordStrengthUI(strength) {
                const strengthBar = document.getElementById('resetStrengthBar');
                const strengthLabel = document.getElementById('resetStrengthLabel');
                
                if (strengthBar) {
                    strengthBar.className = `password-strength-bar ${strength.class}`;
                }
                
                if (strengthLabel) {
                    strengthLabel.textContent = strength.level;
                    strengthLabel.className = `password-strength-label strength-${strength.class}`;
                }
            }
            
            // Send password reset email
            async sendPasswordResetEmail() {
                const emailInput = document.getElementById('resetEmail');
                const email = emailInput.value.trim();
                
                // Validate email
                if (!this.validateEmail(emailInput)) {
                    return;
                }
                
                const sanitizedEmail = this.sanitizeInput(email, 'email');
                
                try {
                    // Show loading state
                    const sendBtn = document.getElementById('sendResetBtn');
                    sendBtn.disabled = true;
                    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
                    
                    // Simulate API call (in production, this would be a real API call)
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // For demo purposes, always succeed
                    document.getElementById('resetEmailConfirm').textContent = sanitizedEmail;
                    this.showResetStep(2);
                    
                    // Store reset data for demo
                    sessionStorage.setItem('password_reset_email', sanitizedEmail);
                    sessionStorage.setItem('password_reset_code', 'RESET123'); // Demo code
                    
                    console.log('üîë Password reset email sent (demo):', sanitizedEmail);
                    
                } catch (error) {
                    console.error('Password reset error:', error);
                    this.showError(
                        document.getElementById('resetEmailError'), 
                        'Error al enviar el email. Intenta de nuevo.'
                    );
                } finally {
                    const sendBtn = document.getElementById('sendResetBtn');
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Instrucciones';
                }
            }
            
            // Resend password reset
            async resendPasswordReset() {
                const email = sessionStorage.getItem('password_reset_email');
                if (email) {
                    document.getElementById('resetEmail').value = email;
                    this.showResetStep(1);
                    await new Promise(resolve => setTimeout(resolve, 100));
                    this.sendPasswordResetEmail();
                }
            }
            
            // Show specific reset step
            showResetStep(stepNumber) {
                // Hide all steps
                document.querySelectorAll('.reset-step').forEach(step => {
                    step.classList.remove('active');
                });
                
                // Show target step
                const targetStep = document.getElementById(`resetStep${stepNumber}`);
                if (targetStep) {
                    targetStep.classList.add('active');
                }
                
                // Special case: show demo reset code input after email sent
                if (stepNumber === 2) {
                    setTimeout(() => {
                        const demoNote = document.createElement('div');
                        demoNote.className = 'demo-reset-note';
                        demoNote.style.cssText = `
                            background: rgba(249, 115, 22, 0.1);
                            border: 1px solid rgba(249, 115, 22, 0.2);
                            border-radius: 8px;
                            padding: 12px;
                            margin-top: 16px;
                            font-size: 12px;
                            color: #f97316;
                        `;
                        demoNote.innerHTML = `
                            <i class="fas fa-info-circle"></i>
                            <strong>Modo Demo:</strong> Usa el c√≥digo <code>RESET123</code> para probar el restablecimiento.
                            <button onclick="authSystem.showResetStep(3)" style="
                                background: none; border: none; color: #f97316; text-decoration: underline; 
                                cursor: pointer; margin-left: 8px; font-size: 12px;
                            ">Probar ahora ‚Üí</button>
                        `;
                        
                        document.getElementById('resetStep2').appendChild(demoNote);
                    }, 1000);
                }
            }
            
            // Reset password with code
            async resetPasswordWithCode() {
                const code = document.getElementById('resetCode').value.trim();
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmNewPassword').value;
                
                // Validate inputs
                let isValid = true;
                
                if (!code) {
                    this.showError(document.getElementById('resetCodeError'), 'C√≥digo es requerido');
                    isValid = false;
                }
                
                if (!newPassword) {
                    this.showError(document.getElementById('newPasswordError'), 'Nueva contrase√±a es requerida');
                    isValid = false;
                } else {
                    const strength = this.getPasswordStrength(newPassword);
                    if (strength.score < 3) {
                        this.showError(document.getElementById('newPasswordError'), 'Contrase√±a muy d√©bil');
                        isValid = false;
                    }
                }
                
                if (newPassword !== confirmPassword) {
                    this.showError(document.getElementById('confirmNewPasswordError'), 'Las contrase√±as no coinciden');
                    isValid = false;
                }
                
                // Validate demo code
                const storedCode = sessionStorage.getItem('password_reset_code');
                if (code !== storedCode) {
                    this.showError(document.getElementById('resetCodeError'), 'C√≥digo incorrecto');
                    isValid = false;
                }
                
                if (!isValid) return;
                
                try {
                    // Show loading state
                    const resetBtn = document.getElementById('resetPasswordBtn');
                    resetBtn.disabled = true;
                    resetBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cambiando...';
                    
                    // Simulate API call
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    // Success - clean up and show success
                    sessionStorage.removeItem('password_reset_email');
                    sessionStorage.removeItem('password_reset_code');
                    
                    this.showSuccess('¬°Contrase√±a cambiada exitosamente!');
                    
                    // Close modal and redirect to login
                    setTimeout(() => {
                        document.getElementById('passwordResetModal').remove();
                        document.getElementById('passwordResetModalStyles').remove();
                        
                        // Auto-fill email in login form
                        const resetEmail = sessionStorage.getItem('password_reset_email');
                        if (resetEmail) {
                            document.getElementById('loginEmail').value = resetEmail;
                        }
                    }, 1500);
                    
                    console.log('üîë Password reset completed successfully');
                    
                } catch (error) {
                    console.error('Password reset error:', error);
                    this.showError(
                        document.getElementById('resetCodeError'), 
                        'Error al cambiar la contrase√±a. Intenta de nuevo.'
                    );
                } finally {
                    const resetBtn = document.getElementById('resetPasswordBtn');
                    resetBtn.disabled = false;
                    resetBtn.innerHTML = '<i class="fas fa-key"></i> Cambiar Contrase√±a';
                }
            }
        }

        // Initialize auth system
        const authSystem = new EnhancedAuth();

        // Global functions
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeTab = document.querySelector(`[onclick="switchTab('${tab}')"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            // Update form sections
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.remove('active');
            });
            const targetForm = document.getElementById(tab + 'Form');
            if (targetForm) {
                targetForm.classList.add('active');
            }
        }

        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling.querySelector('svg path');
            
            if (input.type === 'password') {
                input.type = 'text';
                // Update icon to "hide" state
            } else {
                input.type = 'password';
                // Update icon to "show" state
            }
        }

        function handleLogin(event) {
            event.preventDefault();
            
            const formData = {
                email: document.getElementById('loginEmail').value.trim(),
                password: document.getElementById('loginPassword').value
            };
            
            // Validate inputs
            const emailValid = authSystem.validateEmail(document.getElementById('loginEmail'));
            const passwordValid = authSystem.validatePassword(document.getElementById('loginPassword'));
            
            if (emailValid && passwordValid) {
                authSystem.handleLogin(formData);
            }
        }

        function handleRegister(event) {
            event.preventDefault();
            
            const formData = {
                name: document.getElementById('registerName').value.trim(),
                email: document.getElementById('registerEmail').value.trim(),
                password: document.getElementById('registerPassword').value
            };
            
            // Validate inputs with enhanced validation
            const nameValid = authSystem.validateName(document.getElementById('registerName'));
            const emailValid = authSystem.validateEmailAdvanced(document.getElementById('registerEmail'));
            const passwordValid = authSystem.validatePassword(document.getElementById('registerPassword'));
            
            if (nameValid && emailValid && passwordValid) {
                authSystem.handleRegister(formData);
            }
        }

        function loginWithProvider(provider) {
            authSystem.loginWithProvider(provider);
        }

        function registerWithProvider(provider) {
            authSystem.registerWithProvider(provider);
        }

        function adminAccess() {
            const adminCredentials = {
                email: 'admin@latanda.online',
                password: 'Admin123!'
            };
            
            document.getElementById('loginEmail').value = adminCredentials.email;
            document.getElementById('loginPassword').value = adminCredentials.password;
            
            // Auto-login with admin credentials
            authSystem.handleLogin(adminCredentials);
        }

        function demoAccess() {
            authSystem.demoAccess();
        }

        function testDirectAccess() {
            authSystem.testDirectAccess();
        }

        function openTestPage() {
            // Open the clear rate limit page which has admin test functionality
            window.open('clear-rate-limit.html', '_blank');
        }

        function forgotPassword() {
            authSystem.forgotPassword();
        }

        // Listen for messages from parent window
        window.addEventListener('message', (event) => {
            if (event.data.type === 'latanda:auth:request') {
                // Parent is requesting authentication
                console.log('Authentication requested by parent window');
            }
        });

        // JWT Token Security Monitoring
        let tokenMonitorInterval;
        
        function startTokenMonitoring() {
            // Clear any existing monitoring
            if (tokenMonitorInterval) {
                clearInterval(tokenMonitorInterval);
            }
            
            // Monitor token status every 30 seconds
            tokenMonitorInterval = setInterval(() => {
                const token = localStorage.getItem('latanda_auth_token');
                const securityIndicator = document.getElementById('securityIndicator');
                const tokenInfo = document.getElementById('tokenInfo');
                
                if (token && authSystem.isValidToken(token)) {
                    const tokenData = authSystem.decodeToken(token);
                    
                    if (tokenData) {
                        // Update security indicator
                        const badge = securityIndicator.querySelector('.security-badge');
                        const timeLeft = Math.floor(tokenData.timeToExpiry / 60);
                        
                        if (timeLeft < 5) {
                            // Token expires in less than 5 minutes - warning state
                            badge.style.background = 'linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(251, 191, 36, 0.05))';
                            badge.style.borderColor = 'rgba(251, 191, 36, 0.3)';
                            badge.style.color = '#fbbf24';
                            badge.querySelector('.security-text').textContent = `Expira en ${timeLeft}min`;
                            badge.querySelector('i').className = 'fas fa-exclamation-triangle';
                        } else if (timeLeft < 15) {
                            // Token expires in less than 15 minutes - caution state  
                            badge.style.background = 'linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05))';
                            badge.style.borderColor = 'rgba(59, 130, 246, 0.3)';
                            badge.style.color = '#3b82f6';
                            badge.querySelector('.security-text').textContent = `${timeLeft}min restantes`;
                            badge.querySelector('i').className = 'fas fa-clock';
                        } else {
                            // Token is good - normal secure state
                            badge.style.background = 'linear-gradient(135deg, rgba(34, 213, 94, 0.15), rgba(34, 213, 94, 0.05))';
                            badge.style.borderColor = 'rgba(34, 213, 94, 0.3)';
                            badge.style.color = '#22d55e';
                            badge.querySelector('.security-text').textContent = 'JWT Validaci√≥n Activa';
                            badge.querySelector('i').className = 'fas fa-shield-alt';
                        }
                        
                        // Update token info display
                        tokenInfo.textContent = `Token v√°lido ‚Ä¢ Usuario: ${tokenData.payload.user_id || 'N/A'} ‚Ä¢ Rol: ${tokenData.payload.role || 'N/A'}`;
                        tokenInfo.style.display = 'block';
                        securityIndicator.style.display = 'block';
                    }
                } else {
                    // No valid token
                    securityIndicator.style.display = 'none';
                    tokenInfo.style.display = 'none';
                }
            }, 30000); // Check every 30 seconds
            
            // Initial check
            setTimeout(() => {
                const event = new Event('interval');
                tokenMonitorInterval._fn = tokenMonitorInterval._fn || (() => {});
                
                // Run the monitoring logic immediately
                const token = localStorage.getItem('latanda_auth_token');
                const securityIndicator = document.getElementById('securityIndicator');
                
                if (token && authSystem.isValidToken(token)) {
                    securityIndicator.style.display = 'block';
                } else {
                    securityIndicator.style.display = 'none';
                }
            }, 1000);
        }
        
        // Enhanced token validation logging
        function logTokenValidation(token, isValid, details) {
            const logEntry = {
                timestamp: new Date().toISOString(),
                token_valid: isValid,
                validation_details: details,
                user_agent: navigator.userAgent,
                page_url: window.location.href
            };
            
            // Store validation log for security monitoring
            const logs = JSON.parse(localStorage.getItem('latanda_auth_logs') || '[]');
            logs.push(logEntry);
            
            // Keep only last 50 logs
            if (logs.length > 50) {
                logs.splice(0, logs.length - 50);
            }
            
            localStorage.setItem('latanda_auth_logs', JSON.stringify(logs));
            
            if (!isValid) {
                console.warn('üîí Token validation failed:', details);
            }
        }

        // Start token monitoring when auth system is ready
        startTokenMonitoring();

        // Check for auto-login credentials from index page
        if (sessionStorage.getItem('admin_auto_login')) {
            sessionStorage.removeItem('admin_auto_login');
            console.log('üîß Auto-login admin detected');
            setTimeout(() => adminAccess(), 500);
        } else if (sessionStorage.getItem('demo_auto_login')) {
            sessionStorage.removeItem('demo_auto_login');
            console.log('üéÆ Auto-login demo detected');
            setTimeout(() => demoAccess(), 500);
        }

        // Enhanced security event listeners
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                // Page became visible, check token validity
                const token = localStorage.getItem('latanda_auth_token');
                if (token && !authSystem.isValidToken(token)) {
                    console.warn('üîí Invalid token detected on page focus');
                    authSystem.handleTokenExpired();
                }
            }
        });

        // Security: Clear auth data on window beforeunload if token is invalid
        window.addEventListener('beforeunload', () => {
            const token = localStorage.getItem('latanda_auth_token');
            if (token && !authSystem.isValidToken(token)) {
                localStorage.removeItem('latanda_auth_token');
                localStorage.removeItem('latanda_user');
            }
        });

        console.log('üöÄ Enhanced Auth System with JWT Validation loaded and ready');
    </script>
</body>
</html>