<!-- üìä REAL-TIME DASHBOARD STATS COMPONENT (Plan C - Day 3, Task 4) -->
<!-- Live statistics dashboard for admin panel -->

<style>
    .realtime-stats-container {
        margin: 24px 0;
    }

    .stats-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 12px;
    }

    .stats-title {
        font-size: 24px;
        font-weight: 700;
        color: #00FFFF;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .stats-last-update {
        font-size: 13px;
        color: #94a3b8;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .stats-last-update i {
        color: #00FFFF;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }

    .stat-card {
        background: linear-gradient(135deg, rgba(0, 255, 255, 0.05) 0%, rgba(127, 0, 255, 0.05) 100%);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(0, 255, 255, 0.2);
        border-radius: 16px;
        padding: 24px;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-4px);
        border-color: rgba(0, 255, 255, 0.4);
        box-shadow: 0 8px 32px rgba(0, 255, 255, 0.2);
    }

    .stat-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .stat-card-title {
        font-size: 14px;
        color: #94a3b8;
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .stat-card-icon {
        font-size: 24px;
        color: #00FFFF;
        opacity: 0.7;
    }

    .stat-card-value {
        font-size: 36px;
        font-weight: 700;
        color: #00FFFF;
        margin-bottom: 8px;
        line-height: 1;
    }

    .stat-card-label {
        font-size: 13px;
        color: #cbd5e1;
        margin-bottom: 12px;
    }

    .stat-card-details {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding-top: 12px;
        border-top: 1px solid rgba(148, 163, 184, 0.2);
    }

    .stat-detail-row {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
    }

    .stat-detail-label {
        color: #94a3b8;
    }

    .stat-detail-value {
        color: #f8fafc;
        font-weight: 600;
    }

    .stat-growth {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 6px;
        font-weight: 600;
    }

    .stat-growth.positive {
        background: rgba(34, 197, 94, 0.2);
        color: #22c55e;
    }

    .stat-growth.negative {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
    }

    .stat-growth.neutral {
        background: rgba(148, 163, 184, 0.2);
        color: #94a3b8;
    }

    .stats-error {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 12px;
        padding: 20px;
        color: #ef4444;
        text-align: center;
    }

    .stats-loading {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 60px;
        color: #94a3b8;
        font-size: 16px;
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }

        .stat-card-value {
            font-size: 28px;
        }
    }
</style>

<div class="realtime-stats-container">
    <div class="stats-header">
        <h2 class="stats-title">
            <i class="fas fa-chart-line"></i>
            Dashboard en Tiempo Real
        </h2>
        <div class="stats-last-update">
            <i class="fas fa-sync-alt"></i>
            <span id="statsLastUpdate">Cargando...</span>
        </div>
    </div>

    <div id="statsContainer">
        <div class="stats-loading">
            <i class="fas fa-spinner fa-spin" style="margin-right: 10px;"></i>
            Cargando estad√≠sticas...
        </div>
    </div>
</div>

<!-- Include CountUp.js for animated numbers -->

<script>
/**
 * üìä REAL-TIME DASHBOARD STATS
 * Plan C - Day 3, Task 4
 */

const apiUrl = 'https://latanda.online';
let statsRefreshInterval = null;
let lastStats = null;

async function loadDashboardStats() {
    const authToken = localStorage.getItem('auth_token');

    if (!authToken) {
        document.getElementById('statsContainer').innerHTML = `
            <div class="stats-error">
                <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 8px;"></i>
                <p>Autenticaci√≥n requerida</p>
            </div>
        `;
        return;
    }

    try {
        const response = await fetch(`${apiUrl}/api/admin/dashboard/stats`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const result = await response.json();

        if (result.success) {
            renderDashboardStats(result.data);
            updateLastUpdateTime();
            lastStats = result.data;
        } else {
            throw new Error(result.error || 'Failed to load stats');
        }
    } catch (error) {
        console.error('‚ùå Error loading dashboard stats:', error);
        document.getElementById('statsContainer').innerHTML = `
            <div class="stats-error">
                <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 8px;"></i>
                <p>Error cargando estad√≠sticas: ${error.message}</p>
            </div>
        `;
    }
}

function renderDashboardStats(stats) {
    const container = document.getElementById('statsContainer');

    // Calculate growth indicators
    const userGrowth = calculateGrowth(stats.growth.users.today, stats.growth.users.yesterday);
    const txGrowth = calculateGrowth(stats.growth.transactions.today, stats.growth.transactions.yesterday);

    container.innerHTML = `
        <div class="stats-grid">
            <!-- Users Card -->
            <div class="stat-card">
                <div class="stat-card-header">
                    <span class="stat-card-title">Usuarios</span>
                    <i class="fas fa-users stat-card-icon"></i>
                </div>
                <div class="stat-card-value" id="statTotalUsers">${stats.users.total}</div>
                <div class="stat-card-label">Total de usuarios</div>
                <div class="stat-card-details">
                    <div class="stat-detail-row">
                        <span class="stat-detail-label">Activos (24h):</span>
                        <span class="stat-detail-value" id="statActiveUsers">${stats.users.active_24h}</span>
                    </div>
                    <div class="stat-detail-row">
                        <span class="stat-detail-label">Nuevos hoy:</span>
                        <span class="stat-detail-value">${stats.users.new_today} ${userGrowth}</span>
                    </div>
                    <div class="stat-detail-row">
                        <span class="stat-detail-label">Verificados:</span>
                        <span class="stat-detail-value">${stats.users.verified}</span>
                    </div>
                </div>
            </div>

            <!-- Transactions Card -->
            <div class="stat-card">
                <div class="stat-card-header">
                    <span class="stat-card-title">Transacciones</span>
                    <i class="fas fa-exchange-alt stat-card-icon"></i>
                </div>
                <div class="stat-card-value" id="statTodayTransactions">${stats.transactions.today}</div>
                <div class="stat-card-label">Transacciones hoy ${txGrowth}</div>
                <div class="stat-card-details">
                    <div class="stat-detail-row">
                        <span class="stat-detail-label">Volumen hoy:</span>
                        <span class="stat-detail-value" id="statTodayVolume">${stats.transactions.today_volume} LTD</span>
                    </div>
                    <div class="stat-detail-row">
                        <span class="stat-detail-label">Pendientes:</span>
                        <span class="stat-detail-value">${stats.transactions.pending}</span>
                    </div>
                    <div class="stat-detail-row">
                        <span class="stat-detail-label">Fallidas hoy:</span>
                        <span class="stat-detail-value">${stats.transactions.failed_today}</span>
                    </div>
                </div>
            </div>

            <!-- Wallets Card -->
            <div class="stat-card">
                <div class="stat-card-header">
                    <span class="stat-card-title">Wallets</span>
                    <i class="fas fa-wallet stat-card-icon"></i>
                </div>
                <div class="stat-card-value" id="statTotalBalance">${parseFloat(stats.wallets.total_balance).toLocaleString('es-ES', {maximumFractionDigits: 2})}</div>
                <div class="stat-card-label">Balance total (LTD)</div>
                <div class="stat-card-details">
                    <div class="stat-detail-row">
                        <span class="stat-detail-label">Total wallets:</span>
                        <span class="stat-detail-value">${stats.wallets.total}</span>
                    </div>
                    <div class="stat-detail-row">
                        <span class="stat-detail-label">Promedio:</span>
                        <span class="stat-detail-value">${stats.wallets.avg_balance} LTD</span>
                    </div>
                    <div class="stat-detail-row">
                        <span class="stat-detail-label">Congeladas:</span>
                        <span class="stat-detail-value">${stats.wallets.frozen}</span>
                    </div>
                </div>
            </div>

            <!-- Groups Card -->
            <div class="stat-card">
                <div class="stat-card-header">
                    <span class="stat-card-title">Tandas</span>
                    <i class="fas fa-layer-group stat-card-icon"></i>
                </div>
                <div class="stat-card-value" id="statActiveGroups">${stats.groups.active}</div>
                <div class="stat-card-label">Tandas activas</div>
                <div class="stat-card-details">
                    <div class="stat-detail-row">
                        <span class="stat-detail-label">Total tandas:</span>
                        <span class="stat-detail-value">${stats.groups.total}</span>
                    </div>
                    <div class="stat-detail-row">
                        <span class="stat-detail-label">Completadas:</span>
                        <span class="stat-detail-value">${stats.groups.completed}</span>
                    </div>
                    <div class="stat-detail-row">
                        <span class="stat-detail-label">Total miembros:</span>
                        <span class="stat-detail-value">${stats.groups.total_members}</span>
                    </div>
                </div>
            </div>

            <!-- System Card -->
            <div class="stat-card">
                <div class="stat-card-header">
                    <span class="stat-card-title">Sistema</span>
                    <i class="fas fa-server stat-card-icon"></i>
                </div>
                <div class="stat-card-value" id="statUptime">${parseFloat(stats.system.uptime_hours).toFixed(1)}</div>
                <div class="stat-card-label">Horas de uptime</div>
                <div class="stat-card-details">
                    <div class="stat-detail-row">
                        <span class="stat-detail-label">Base de datos:</span>
                        <span class="stat-detail-value">${stats.system.database_size_mb} MB</span>
                    </div>
                    <div class="stat-detail-row">
                        <span class="stat-detail-label">Memoria:</span>
                        <span class="stat-detail-value">${stats.system.memory_usage_mb} MB</span>
                    </div>
                </div>
            </div>

            <!-- Transactions Total Card -->
            <div class="stat-card">
                <div class="stat-card-header">
                    <span class="stat-card-title">Total Hist√≥rico</span>
                    <i class="fas fa-history stat-card-icon"></i>
                </div>
                <div class="stat-card-value" id="statTotalTransactions">${stats.transactions.total}</div>
                <div class="stat-card-label">Transacciones totales</div>
                <div class="stat-card-details">
                    <div class="stat-detail-row">
                        <span class="stat-detail-label">Hoy:</span>
                        <span class="stat-detail-value">${stats.transactions.today}</span>
                    </div>
                    <div class="stat-detail-row">
                        <span class="stat-detail-label">Ayer:</span>
                        <span class="stat-detail-value">${stats.growth.transactions.yesterday}</span>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Animate numbers with CountUp.js
    animateCountUp('statTotalUsers', stats.users.total);
    animateCountUp('statActiveUsers', stats.users.active_24h);
    animateCountUp('statTodayTransactions', stats.transactions.today);
    animateCountUp('statTodayVolume', parseFloat(stats.transactions.today_volume), 2);
    animateCountUp('statTotalBalance', parseFloat(stats.wallets.total_balance), 2);
    animateCountUp('statActiveGroups', stats.groups.active);
    animateCountUp('statUptime', parseFloat(stats.system.uptime_hours), 1);
    animateCountUp('statTotalTransactions', stats.transactions.total);
}

function animateCountUp(elementId, endValue, decimals = 0) {
    const element = document.getElementById(elementId);
    if (!element || typeof countUp === 'undefined') return;

    const startValue = lastStats ? parseFloat(element.textContent) || 0 : 0;

    const countUpInstance = new countUp.CountUp(elementId, endValue, {
        startVal: startValue,
        duration: 1.5,
        decimalPlaces: decimals,
        useEasing: true,
        useGrouping: true,
        separator: ','
    });

    if (!countUpInstance.error) {
        countUpInstance.start();
    }
}

function calculateGrowth(today, yesterday) {
    if (yesterday === 0) {
        return today > 0
            ? '<span class="stat-growth positive"><i class="fas fa-arrow-up"></i>Nuevo</span>'
            : '<span class="stat-growth neutral"><i class="fas fa-minus"></i>Sin cambio</span>';
    }

    const change = today - yesterday;
    const percentChange = ((change / yesterday) * 100).toFixed(0);

    if (change > 0) {
        return `<span class="stat-growth positive"><i class="fas fa-arrow-up"></i>+${percentChange}%</span>`;
    } else if (change < 0) {
        return `<span class="stat-growth negative"><i class="fas fa-arrow-down"></i>${percentChange}%</span>`;
    } else {
        return '<span class="stat-growth neutral"><i class="fas fa-minus"></i>Sin cambio</span>';
    }
}

function updateLastUpdateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('es-ES');
    document.getElementById('statsLastUpdate').textContent = `√öltima actualizaci√≥n: ${timeString}`;
}

// Auto-refresh every 30 seconds
function startAutoRefresh() {
    if (statsRefreshInterval) {
        clearInterval(statsRefreshInterval);
    }

    statsRefreshInterval = setInterval(() => {
        loadDashboardStats();
    }, 30000); // 30 seconds

    console.log('‚úÖ Auto-refresh enabled (30 seconds)');
}

// Stop auto-refresh
function stopAutoRefresh() {
    if (statsRefreshInterval) {
        clearInterval(statsRefreshInterval);
        statsRefreshInterval = null;
        console.log('‚è∏Ô∏è Auto-refresh stopped');
    }
}

// Manual refresh
window.refreshDashboardStats = () => {
    loadDashboardStats();
};

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    loadDashboardStats();
    startAutoRefresh();
});

// Stop refresh when page is hidden (performance optimization)
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        stopAutoRefresh();
    } else {
        startAutoRefresh();
    }
});

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    stopAutoRefresh();
});
</script>
