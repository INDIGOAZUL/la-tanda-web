<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Auth Integration</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; padding: 20px; margin: 10px 0; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { padding: 10px; margin: 5px; cursor: pointer; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
        #results { max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>üîç La Tanda Auth & Dashboard Integration Test</h1>
    
    <div class="test-section">
        <h2>1. API Proxy Test</h2>
        <button onclick="testSystemStatus()">Test System Status</button>
        <button onclick="testAuthLogin()">Test Login</button>
        <button onclick="testUserProfile()">Test User Profile</button>
        <button onclick="testLTDBalance()">Test LTD Balance</button>
        <div id="api-results"></div>
    </div>

    <div class="test-section">
        <h2>2. JWT Token Test</h2>
        <button onclick="testJWTGeneration()">Generate Test JWT</button>
        <button onclick="testJWTDecoding()">Decode JWT</button>
        <div id="jwt-results"></div>
    </div>

    <div class="test-section">
        <h2>3. Dashboard Integration Test</h2>
        <button onclick="simulateLogin()">Simulate Full Login Flow</button>
        <button onclick="testDashboardData()">Test Dashboard Data Loading</button>
        <div id="dashboard-results"></div>
    </div>

    <div class="test-section">
        <h2>4. Results Log</h2>
        <button onclick="clearResults()">Clear Log</button>
        <pre id="results"></pre>
    </div>

    <!-- Load our API infrastructure -->
    <script src="api-proxy.js"></script>
    <script src="api-adapter.js"></script>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            results.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('api-results').innerHTML = '';
            document.getElementById('jwt-results').innerHTML = '';
            document.getElementById('dashboard-results').innerHTML = '';
        }

        async function testSystemStatus() {
            log('üß™ Testing system status endpoint...', 'info');
            try {
                const response = await window.apiProxy.makeRequest('/system/status');
                log(`‚úÖ System status: ${JSON.stringify(response, null, 2)}`, 'success');
                document.getElementById('api-results').innerHTML = `<pre>${JSON.stringify(response, null, 2)}</pre>`;
            } catch (error) {
                log(`‚ùå System status error: ${error.message}`, 'error');
                document.getElementById('api-results').innerHTML = `<pre class="error">Error: ${error.message}</pre>`;
            }
        }

        async function testAuthLogin() {
            log('üß™ Testing admin login...', 'info');
            try {
                const response = await window.apiProxy.makeRequest('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({
                        email: 'admin@latanda.online',
                        password: 'Admin123!'
                    })
                });
                
                if (response.success && response.data.auth_token) {
                    log('‚úÖ Login successful! Token received.', 'success');
                    localStorage.setItem('latanda_auth_token', response.data.auth_token);
                    
                    // Test JWT decoding
                    const payload = JSON.parse(atob(response.data.auth_token.split('.')[1]));
                    log(`üîë JWT Payload: ${JSON.stringify(payload, null, 2)}`, 'info');
                } else {
                    log('‚ùå Login failed: ' + (response.error?.message || 'Unknown error'), 'error');
                }
                
                document.getElementById('api-results').innerHTML = `<pre>${JSON.stringify(response, null, 2)}</pre>`;
            } catch (error) {
                log(`‚ùå Login error: ${error.message}`, 'error');
                document.getElementById('api-results').innerHTML = `<pre class="error">Error: ${error.message}</pre>`;
            }
        }

        async function testUserProfile() {
            log('üß™ Testing user profile endpoint...', 'info');
            try {
                const response = await window.apiProxy.makeRequest('/user/profile');
                log(`‚úÖ User profile loaded: ${response.data?.name || 'Unknown'}`, 'success');
                document.getElementById('api-results').innerHTML = `<pre>${JSON.stringify(response, null, 2)}</pre>`;
            } catch (error) {
                log(`‚ùå User profile error: ${error.message}`, 'error');
                document.getElementById('api-results').innerHTML = `<pre class="error">Error: ${error.message}</pre>`;
            }
        }

        async function testLTDBalance() {
            log('üß™ Testing LTD balance endpoint...', 'info');
            try {
                const response = await window.apiProxy.makeRequest('/ltd/balance');
                log(`‚úÖ LTD balance: ${response.data?.balance || 0} LTD`, 'success');
                document.getElementById('api-results').innerHTML = `<pre>${JSON.stringify(response, null, 2)}</pre>`;
            } catch (error) {
                log(`‚ùå LTD balance error: ${error.message}`, 'error');
                document.getElementById('api-results').innerHTML = `<pre class="error">Error: ${error.message}</pre>`;
            }
        }

        async function testJWTGeneration() {
            log('üß™ Testing JWT generation...', 'info');
            try {
                const testPayload = {
                    user_id: "test_001",
                    email: "test@example.com",
                    role: "user", // Valid role from auth system
                    permissions: ["read_only"],
                    iss: "latanda.online", // Required issuer
                    aud: "latanda-web-app", // Required audience
                    iat: Math.floor(Date.now() / 1000),
                    exp: Math.floor(Date.now() / 1000) + (2 * 60 * 60)
                };
                
                const jwt = window.apiProxy.generateJWT(testPayload);
                log(`‚úÖ JWT generated: ${jwt.substring(0, 50)}...`, 'success');
                
                // Decode and verify
                const parts = jwt.split('.');
                const decodedHeader = JSON.parse(atob(parts[0]));
                const decodedPayload = JSON.parse(atob(parts[1]));
                
                document.getElementById('jwt-results').innerHTML = `
                    <h4>Generated JWT:</h4>
                    <pre>${jwt}</pre>
                    <h4>Header:</h4>
                    <pre>${JSON.stringify(decodedHeader, null, 2)}</pre>
                    <h4>Payload:</h4>
                    <pre>${JSON.stringify(decodedPayload, null, 2)}</pre>
                `;
                
                log('‚úÖ JWT generation and decoding test passed!', 'success');
            } catch (error) {
                log(`‚ùå JWT test error: ${error.message}`, 'error');
                document.getElementById('jwt-results').innerHTML = `<pre class="error">Error: ${error.message}</pre>`;
            }
        }

        async function testJWTDecoding() {
            log('üß™ Testing JWT decoding from localStorage...', 'info');
            try {
                const token = localStorage.getItem('latanda_auth_token');
                if (!token) {
                    log('‚ùå No token found in localStorage. Run login test first.', 'error');
                    return;
                }
                
                const parts = token.split('.');
                if (parts.length !== 3) {
                    log('‚ùå Invalid JWT format', 'error');
                    return;
                }
                
                const header = JSON.parse(atob(parts[0]));
                const payload = JSON.parse(atob(parts[1]));
                
                const now = Math.floor(Date.now() / 1000);
                const isExpired = payload.exp && payload.exp <= now;
                
                document.getElementById('jwt-results').innerHTML = `
                    <h4>Current Token:</h4>
                    <pre>${token}</pre>
                    <h4>Header:</h4>
                    <pre>${JSON.stringify(header, null, 2)}</pre>
                    <h4>Payload:</h4>
                    <pre>${JSON.stringify(payload, null, 2)}</pre>
                    <h4>Status:</h4>
                    <pre>Expired: ${isExpired ? '‚ùå Yes' : '‚úÖ No'}
Time to expiry: ${payload.exp ? payload.exp - now : 'N/A'} seconds</pre>
                `;
                
                log(`‚úÖ JWT decoded successfully. Expired: ${isExpired}`, 'success');
            } catch (error) {
                log(`‚ùå JWT decoding error: ${error.message}`, 'error');
                document.getElementById('jwt-results').innerHTML = `<pre class="error">Error: ${error.message}</pre>`;
            }
        }

        async function simulateLogin() {
            log('üß™ Simulating full login flow...', 'info');
            try {
                // Step 1: Login
                const loginResponse = await window.apiProxy.makeRequest('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({
                        email: 'admin@latanda.online',
                        password: 'Admin123!'
                    })
                });
                
                if (!loginResponse.success) {
                    throw new Error('Login failed: ' + (loginResponse.error?.message || 'Unknown error'));
                }
                
                log('‚úÖ Step 1: Login successful', 'success');
                
                // Step 2: Store token
                localStorage.setItem('latanda_auth_token', loginResponse.data.auth_token);
                localStorage.setItem('latanda_user', JSON.stringify(loginResponse.data.user));
                log('‚úÖ Step 2: Auth data stored', 'success');
                
                // Step 3: Load additional data
                const userProfile = await window.apiProxy.makeRequest('/user/profile');
                const userStats = await window.apiProxy.makeRequest('/user/stats');
                const ltdBalance = await window.apiProxy.makeRequest('/ltd/balance');
                
                log('‚úÖ Step 3: Additional data loaded', 'success');
                
                // Step 4: Verify JWT has 'iat' field
                const token = loginResponse.data.auth_token;
                const payload = JSON.parse(atob(token.split('.')[1]));
                if (!payload.iat) {
                    log('‚ùå Warning: JWT missing iat field!', 'error');
                } else {
                    log('‚úÖ JWT has required iat field', 'success');
                }
                
                document.getElementById('dashboard-results').innerHTML = `
                    <h4>Login Response:</h4>
                    <pre>${JSON.stringify(loginResponse.data, null, 2)}</pre>
                    <h4>User Profile:</h4>
                    <pre>${JSON.stringify(userProfile.data, null, 2)}</pre>
                    <h4>LTD Balance:</h4>
                    <pre>${JSON.stringify(ltdBalance.data, null, 2)}</pre>
                `;
                
                log('‚úÖ Full login flow simulation completed successfully!', 'success');
                log('üëç You can now navigate to home-dashboard.html and it should work properly.', 'info');
                
            } catch (error) {
                log(`‚ùå Login simulation error: ${error.message}`, 'error');
                document.getElementById('dashboard-results').innerHTML = `<pre class="error">Error: ${error.message}</pre>`;
            }
        }

        async function testDashboardData() {
            log('üß™ Testing dashboard data endpoints...', 'info');
            try {
                const endpoints = [
                    { name: 'User Profile', endpoint: '/user/profile' },
                    { name: 'User Stats', endpoint: '/user/stats' },
                    { name: 'Tandas List', endpoint: '/tandas/list' },
                    { name: 'Transactions', endpoint: '/transactions/list' },
                    { name: 'LTD Balance', endpoint: '/ltd/balance' }
                ];
                
                const results = {};
                
                for (const { name, endpoint } of endpoints) {
                    try {
                        const response = await window.apiProxy.makeRequest(endpoint);
                        results[name] = { success: true, data: response.data };
                        log(`‚úÖ ${name}: Success`, 'success');
                    } catch (error) {
                        results[name] = { success: false, error: error.message };
                        log(`‚ùå ${name}: ${error.message}`, 'error');
                    }
                }
                
                document.getElementById('dashboard-results').innerHTML = `
                    <h4>Dashboard Endpoints Test Results:</h4>
                    <pre>${JSON.stringify(results, null, 2)}</pre>
                `;
                
                log('‚úÖ Dashboard data test completed', 'success');
            } catch (error) {
                log(`‚ùå Dashboard test error: ${error.message}`, 'error');
                document.getElementById('dashboard-results').innerHTML = `<pre class="error">Error: ${error.message}</pre>`;
            }
        }

        // Auto-initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Auth Integration Test Page Ready', 'info');
            log('üìù Available API proxy methods:', 'info');
            log('   - window.apiProxy.makeRequest(endpoint, options)', 'info');
            log('   - window.apiProxy.generateJWT(payload)', 'info');
            log('   - window.laTandaAPIAdapter (fetch interceptor)', 'info');
        });
    </script>
</body>
</html>